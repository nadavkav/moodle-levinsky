From d9123980894b9167aebf8f44f44899cbd07e03e7 Mon Sep 17 00:00:00 2001
From: Nadav Kavalerchik <nadavkav@gmail.com>
Date: Sat, 23 Sep 2017 11:37:48 +0300
Subject: [PATCH 10/95] mod/lightboxgallery (new)

---
 mod/lightboxgallery/.travis.yml                    |  47 ++
 mod/lightboxgallery/LICENSE                        | 674 ++++++++++++++++++
 mod/lightboxgallery/README.md                      |  30 +
 .../assets/gallery-lightbox-core.css               |   1 +
 .../assets/skins/sam/closelabel.gif                | Bin 0 -> 979 bytes
 .../assets/skins/sam/gallery-lightbox-skin.css     |  83 +++
 .../assets/skins/sam/gallery-lightbox.css          |   1 +
 mod/lightboxgallery/assets/skins/sam/loading.gif   | Bin 0 -> 2767 bytes
 mod/lightboxgallery/assets/skins/sam/nextlabel.gif | Bin 0 -> 1252 bytes
 mod/lightboxgallery/assets/skins/sam/prevlabel.gif | Bin 0 -> 1264 bytes
 .../backup_lightboxgallery_activity_task.class.php |  72 ++
 .../moodle2/backup_lightboxgallery_stepslib.php    |  84 +++
 ...restore_lightboxgallery_activity_task.class.php | 105 +++
 .../moodle2/restore_lightboxgallery_stepslib.php   |  97 +++
 .../event/course_module_instance_list_viewed.php   |  39 ++
 .../classes/event/course_module_viewed.php         |  77 ++
 .../classes/event/gallery_comment_created.php      | 108 +++
 .../classes/event/gallery_searched.php             | 116 +++
 .../classes/event/image_updated.php                | 101 +++
 mod/lightboxgallery/classes/search/activity.php    |  37 +
 mod/lightboxgallery/comment.php                    | 100 +++
 mod/lightboxgallery/comment_form.php               |  50 ++
 mod/lightboxgallery/composer.json                  |  17 +
 mod/lightboxgallery/db/access.php                  | 120 ++++
 mod/lightboxgallery/db/install.xml                 |  64 ++
 mod/lightboxgallery/db/log.php                     |  36 +
 mod/lightboxgallery/db/upgrade.php                 | 280 ++++++++
 mod/lightboxgallery/edit/base.class.php            |  72 ++
 mod/lightboxgallery/edit/caption/caption.class.php |  41 ++
 mod/lightboxgallery/edit/crop/crop.class.php       |  85 +++
 mod/lightboxgallery/edit/delete/delete.class.php   |  42 ++
 mod/lightboxgallery/edit/flip/flip.class.php       |  51 ++
 mod/lightboxgallery/edit/resize/resize.class.php   |  80 +++
 mod/lightboxgallery/edit/rotate/rotate.class.php   |  45 ++
 mod/lightboxgallery/edit/tag/import.php            | 120 ++++
 mod/lightboxgallery/edit/tag/tag.class.php         |  97 +++
 .../edit/thumbnail/thumbnail.class.php             |  95 +++
 mod/lightboxgallery/imageadd.php                   |  73 ++
 mod/lightboxgallery/imageadd_form.php              |  99 +++
 mod/lightboxgallery/imageclass.php                 | 429 ++++++++++++
 mod/lightboxgallery/imageedit.php                  | 124 ++++
 mod/lightboxgallery/index.php                      | 107 +++
 mod/lightboxgallery/lang/de/lightboxgallery.php    | 138 ++++
 .../lang/en/help/lightboxgallery/addimage.html     |   5 +
 .../lang/en/help/lightboxgallery/index.html        |   8 +
 .../lang/en/help/lightboxgallery/mods.html         |   5 +
 mod/lightboxgallery/lang/en/lightboxgallery.php    | 147 ++++
 .../lang/fr/help/lightboxgallery/addimage.html     |   5 +
 .../lang/fr/help/lightboxgallery/index.html        |   8 +
 .../lang/fr/help/lightboxgallery/mods.html         |   5 +
 mod/lightboxgallery/lang/fr/lightboxgallery.php    | 141 ++++
 mod/lightboxgallery/lib.php                        | 483 +++++++++++++
 mod/lightboxgallery/locallib.php                   | 221 ++++++
 mod/lightboxgallery/mod_form.php                   | 145 ++++
 mod/lightboxgallery/module.js                      |   1 +
 mod/lightboxgallery/pix/download.png               | Bin 0 -> 1741 bytes
 mod/lightboxgallery/pix/icon.gif                   | Bin 0 -> 1070 bytes
 mod/lightboxgallery/pix/icon.svg                   |  46 ++
 mod/lightboxgallery/pix/index.png                  | Bin 0 -> 3110 bytes
 mod/lightboxgallery/rsslib.php                     | 264 +++++++
 mod/lightboxgallery/search.php                     | 134 ++++
 mod/lightboxgallery/settings.php                   |  51 ++
 mod/lightboxgallery/styles.css                     | 163 +++++
 .../tests/behat/behat_mod_lightboxgallery.php      |  65 ++
 .../tests/behat/public_gallery.feature             |  37 +
 mod/lightboxgallery/tests/generator/lib.php        |  41 ++
 mod/lightboxgallery/tests/lib_test.php             |  72 ++
 mod/lightboxgallery/thirdpartylibs.xml             |  17 +
 mod/lightboxgallery/version.php                    |  33 +
 mod/lightboxgallery/view.php                       | 201 ++++++
 .../yui/lightbox/assets/gallery-lightbox-core.css  |   1 +
 .../yui/lightbox/assets/skins/sam/closelabel.gif   | Bin 0 -> 979 bytes
 .../assets/skins/sam/gallery-lightbox-skin.css     |  83 +++
 .../lightbox/assets/skins/sam/gallery-lightbox.css |   1 +
 .../yui/lightbox/assets/skins/sam/loading.gif      | Bin 0 -> 2767 bytes
 .../yui/lightbox/assets/skins/sam/nextlabel.gif    | Bin 0 -> 1252 bytes
 .../yui/lightbox/assets/skins/sam/prevlabel.gif    | Bin 0 -> 1264 bytes
 mod/lightboxgallery/yui/lightbox/lightbox.js       | 778 +++++++++++++++++++++
 78 files changed, 7198 insertions(+)
 create mode 100644 mod/lightboxgallery/.travis.yml
 create mode 100644 mod/lightboxgallery/LICENSE
 create mode 100644 mod/lightboxgallery/README.md
 create mode 100644 mod/lightboxgallery/assets/gallery-lightbox-core.css
 create mode 100644 mod/lightboxgallery/assets/skins/sam/closelabel.gif
 create mode 100644 mod/lightboxgallery/assets/skins/sam/gallery-lightbox-skin.css
 create mode 100644 mod/lightboxgallery/assets/skins/sam/gallery-lightbox.css
 create mode 100644 mod/lightboxgallery/assets/skins/sam/loading.gif
 create mode 100644 mod/lightboxgallery/assets/skins/sam/nextlabel.gif
 create mode 100644 mod/lightboxgallery/assets/skins/sam/prevlabel.gif
 create mode 100644 mod/lightboxgallery/backup/moodle2/backup_lightboxgallery_activity_task.class.php
 create mode 100644 mod/lightboxgallery/backup/moodle2/backup_lightboxgallery_stepslib.php
 create mode 100644 mod/lightboxgallery/backup/moodle2/restore_lightboxgallery_activity_task.class.php
 create mode 100644 mod/lightboxgallery/backup/moodle2/restore_lightboxgallery_stepslib.php
 create mode 100644 mod/lightboxgallery/classes/event/course_module_instance_list_viewed.php
 create mode 100644 mod/lightboxgallery/classes/event/course_module_viewed.php
 create mode 100644 mod/lightboxgallery/classes/event/gallery_comment_created.php
 create mode 100644 mod/lightboxgallery/classes/event/gallery_searched.php
 create mode 100644 mod/lightboxgallery/classes/event/image_updated.php
 create mode 100644 mod/lightboxgallery/classes/search/activity.php
 create mode 100644 mod/lightboxgallery/comment.php
 create mode 100644 mod/lightboxgallery/comment_form.php
 create mode 100644 mod/lightboxgallery/composer.json
 create mode 100644 mod/lightboxgallery/db/access.php
 create mode 100644 mod/lightboxgallery/db/install.xml
 create mode 100644 mod/lightboxgallery/db/log.php
 create mode 100644 mod/lightboxgallery/db/upgrade.php
 create mode 100644 mod/lightboxgallery/edit/base.class.php
 create mode 100644 mod/lightboxgallery/edit/caption/caption.class.php
 create mode 100644 mod/lightboxgallery/edit/crop/crop.class.php
 create mode 100644 mod/lightboxgallery/edit/delete/delete.class.php
 create mode 100644 mod/lightboxgallery/edit/flip/flip.class.php
 create mode 100644 mod/lightboxgallery/edit/resize/resize.class.php
 create mode 100644 mod/lightboxgallery/edit/rotate/rotate.class.php
 create mode 100644 mod/lightboxgallery/edit/tag/import.php
 create mode 100644 mod/lightboxgallery/edit/tag/tag.class.php
 create mode 100644 mod/lightboxgallery/edit/thumbnail/thumbnail.class.php
 create mode 100644 mod/lightboxgallery/imageadd.php
 create mode 100644 mod/lightboxgallery/imageadd_form.php
 create mode 100644 mod/lightboxgallery/imageclass.php
 create mode 100644 mod/lightboxgallery/imageedit.php
 create mode 100644 mod/lightboxgallery/index.php
 create mode 100644 mod/lightboxgallery/lang/de/lightboxgallery.php
 create mode 100644 mod/lightboxgallery/lang/en/help/lightboxgallery/addimage.html
 create mode 100644 mod/lightboxgallery/lang/en/help/lightboxgallery/index.html
 create mode 100644 mod/lightboxgallery/lang/en/help/lightboxgallery/mods.html
 create mode 100644 mod/lightboxgallery/lang/en/lightboxgallery.php
 create mode 100644 mod/lightboxgallery/lang/fr/help/lightboxgallery/addimage.html
 create mode 100644 mod/lightboxgallery/lang/fr/help/lightboxgallery/index.html
 create mode 100644 mod/lightboxgallery/lang/fr/help/lightboxgallery/mods.html
 create mode 100644 mod/lightboxgallery/lang/fr/lightboxgallery.php
 create mode 100644 mod/lightboxgallery/lib.php
 create mode 100644 mod/lightboxgallery/locallib.php
 create mode 100644 mod/lightboxgallery/mod_form.php
 create mode 100644 mod/lightboxgallery/module.js
 create mode 100644 mod/lightboxgallery/pix/download.png
 create mode 100644 mod/lightboxgallery/pix/icon.gif
 create mode 100644 mod/lightboxgallery/pix/icon.svg
 create mode 100644 mod/lightboxgallery/pix/index.png
 create mode 100644 mod/lightboxgallery/rsslib.php
 create mode 100644 mod/lightboxgallery/search.php
 create mode 100644 mod/lightboxgallery/settings.php
 create mode 100644 mod/lightboxgallery/styles.css
 create mode 100644 mod/lightboxgallery/tests/behat/behat_mod_lightboxgallery.php
 create mode 100644 mod/lightboxgallery/tests/behat/public_gallery.feature
 create mode 100644 mod/lightboxgallery/tests/generator/lib.php
 create mode 100644 mod/lightboxgallery/tests/lib_test.php
 create mode 100644 mod/lightboxgallery/thirdpartylibs.xml
 create mode 100644 mod/lightboxgallery/version.php
 create mode 100644 mod/lightboxgallery/view.php
 create mode 100644 mod/lightboxgallery/yui/lightbox/assets/gallery-lightbox-core.css
 create mode 100644 mod/lightboxgallery/yui/lightbox/assets/skins/sam/closelabel.gif
 create mode 100644 mod/lightboxgallery/yui/lightbox/assets/skins/sam/gallery-lightbox-skin.css
 create mode 100644 mod/lightboxgallery/yui/lightbox/assets/skins/sam/gallery-lightbox.css
 create mode 100644 mod/lightboxgallery/yui/lightbox/assets/skins/sam/loading.gif
 create mode 100644 mod/lightboxgallery/yui/lightbox/assets/skins/sam/nextlabel.gif
 create mode 100644 mod/lightboxgallery/yui/lightbox/assets/skins/sam/prevlabel.gif
 create mode 100644 mod/lightboxgallery/yui/lightbox/lightbox.js

diff --git a/mod/lightboxgallery/.travis.yml b/mod/lightboxgallery/.travis.yml
new file mode 100644
index 0000000..6bcbe01
--- /dev/null
+++ b/mod/lightboxgallery/.travis.yml
@@ -0,0 +1,47 @@
+language: php
+
+sudo: false
+
+cache:
+  directories:
+    - $HOME/.composer/cache
+
+env:
+ global:
+  - IGNORE_PATHS=yui/lightbox
+  - MOODLE_BRANCH=master
+
+matrix:
+ allow_failures:
+ fast_finish: true
+ include:
+ - php: 5.6
+   env: DB=pgsql
+   addons:
+      postgresql: 9.3
+ - php: 7.0
+   env: DB=mysqli
+ - php: 7.0
+   env: DB=pgsql
+   addons:
+      postgresql: 9.3
+
+before_install:
+  - cd ../..
+  - composer selfupdate
+  - composer create-project -n --no-dev moodlerooms/moodle-plugin-ci ci ^1
+  - export PATH="$(cd ci/bin; pwd):$(cd ci/vendor/bin; pwd):$PATH"
+
+install:
+  - moodle-plugin-ci install
+
+script:
+  - moodle-plugin-ci phplint
+  - moodle-plugin-ci phpcpd
+  - moodle-plugin-ci phpmd
+  - moodle-plugin-ci codechecker
+  - moodle-plugin-ci csslint
+  - moodle-plugin-ci shifter
+  - moodle-plugin-ci jshint
+  - moodle-plugin-ci phpunit
+  - moodle-plugin-ci behat
diff --git a/mod/lightboxgallery/LICENSE b/mod/lightboxgallery/LICENSE
new file mode 100644
index 0000000..20d40b6
--- /dev/null
+++ b/mod/lightboxgallery/LICENSE
@@ -0,0 +1,674 @@
+                    GNU GENERAL PUBLIC LICENSE
+                       Version 3, 29 June 2007
+
+ Copyright (C) 2007 Free Software Foundation, Inc. <http://fsf.org/>
+ Everyone is permitted to copy and distribute verbatim copies
+ of this license document, but changing it is not allowed.
+
+                            Preamble
+
+  The GNU General Public License is a free, copyleft license for
+software and other kinds of works.
+
+  The licenses for most software and other practical works are designed
+to take away your freedom to share and change the works.  By contrast,
+the GNU General Public License is intended to guarantee your freedom to
+share and change all versions of a program--to make sure it remains free
+software for all its users.  We, the Free Software Foundation, use the
+GNU General Public License for most of our software; it applies also to
+any other work released this way by its authors.  You can apply it to
+your programs, too.
+
+  When we speak of free software, we are referring to freedom, not
+price.  Our General Public Licenses are designed to make sure that you
+have the freedom to distribute copies of free software (and charge for
+them if you wish), that you receive source code or can get it if you
+want it, that you can change the software or use pieces of it in new
+free programs, and that you know you can do these things.
+
+  To protect your rights, we need to prevent others from denying you
+these rights or asking you to surrender the rights.  Therefore, you have
+certain responsibilities if you distribute copies of the software, or if
+you modify it: responsibilities to respect the freedom of others.
+
+  For example, if you distribute copies of such a program, whether
+gratis or for a fee, you must pass on to the recipients the same
+freedoms that you received.  You must make sure that they, too, receive
+or can get the source code.  And you must show them these terms so they
+know their rights.
+
+  Developers that use the GNU GPL protect your rights with two steps:
+(1) assert copyright on the software, and (2) offer you this License
+giving you legal permission to copy, distribute and/or modify it.
+
+  For the developers' and authors' protection, the GPL clearly explains
+that there is no warranty for this free software.  For both users' and
+authors' sake, the GPL requires that modified versions be marked as
+changed, so that their problems will not be attributed erroneously to
+authors of previous versions.
+
+  Some devices are designed to deny users access to install or run
+modified versions of the software inside them, although the manufacturer
+can do so.  This is fundamentally incompatible with the aim of
+protecting users' freedom to change the software.  The systematic
+pattern of such abuse occurs in the area of products for individuals to
+use, which is precisely where it is most unacceptable.  Therefore, we
+have designed this version of the GPL to prohibit the practice for those
+products.  If such problems arise substantially in other domains, we
+stand ready to extend this provision to those domains in future versions
+of the GPL, as needed to protect the freedom of users.
+
+  Finally, every program is threatened constantly by software patents.
+States should not allow patents to restrict development and use of
+software on general-purpose computers, but in those that do, we wish to
+avoid the special danger that patents applied to a free program could
+make it effectively proprietary.  To prevent this, the GPL assures that
+patents cannot be used to render the program non-free.
+
+  The precise terms and conditions for copying, distribution and
+modification follow.
+
+                       TERMS AND CONDITIONS
+
+  0. Definitions.
+
+  "This License" refers to version 3 of the GNU General Public License.
+
+  "Copyright" also means copyright-like laws that apply to other kinds of
+works, such as semiconductor masks.
+
+  "The Program" refers to any copyrightable work licensed under this
+License.  Each licensee is addressed as "you".  "Licensees" and
+"recipients" may be individuals or organizations.
+
+  To "modify" a work means to copy from or adapt all or part of the work
+in a fashion requiring copyright permission, other than the making of an
+exact copy.  The resulting work is called a "modified version" of the
+earlier work or a work "based on" the earlier work.
+
+  A "covered work" means either the unmodified Program or a work based
+on the Program.
+
+  To "propagate" a work means to do anything with it that, without
+permission, would make you directly or secondarily liable for
+infringement under applicable copyright law, except executing it on a
+computer or modifying a private copy.  Propagation includes copying,
+distribution (with or without modification), making available to the
+public, and in some countries other activities as well.
+
+  To "convey" a work means any kind of propagation that enables other
+parties to make or receive copies.  Mere interaction with a user through
+a computer network, with no transfer of a copy, is not conveying.
+
+  An interactive user interface displays "Appropriate Legal Notices"
+to the extent that it includes a convenient and prominently visible
+feature that (1) displays an appropriate copyright notice, and (2)
+tells the user that there is no warranty for the work (except to the
+extent that warranties are provided), that licensees may convey the
+work under this License, and how to view a copy of this License.  If
+the interface presents a list of user commands or options, such as a
+menu, a prominent item in the list meets this criterion.
+
+  1. Source Code.
+
+  The "source code" for a work means the preferred form of the work
+for making modifications to it.  "Object code" means any non-source
+form of a work.
+
+  A "Standard Interface" means an interface that either is an official
+standard defined by a recognized standards body, or, in the case of
+interfaces specified for a particular programming language, one that
+is widely used among developers working in that language.
+
+  The "System Libraries" of an executable work include anything, other
+than the work as a whole, that (a) is included in the normal form of
+packaging a Major Component, but which is not part of that Major
+Component, and (b) serves only to enable use of the work with that
+Major Component, or to implement a Standard Interface for which an
+implementation is available to the public in source code form.  A
+"Major Component", in this context, means a major essential component
+(kernel, window system, and so on) of the specific operating system
+(if any) on which the executable work runs, or a compiler used to
+produce the work, or an object code interpreter used to run it.
+
+  The "Corresponding Source" for a work in object code form means all
+the source code needed to generate, install, and (for an executable
+work) run the object code and to modify the work, including scripts to
+control those activities.  However, it does not include the work's
+System Libraries, or general-purpose tools or generally available free
+programs which are used unmodified in performing those activities but
+which are not part of the work.  For example, Corresponding Source
+includes interface definition files associated with source files for
+the work, and the source code for shared libraries and dynamically
+linked subprograms that the work is specifically designed to require,
+such as by intimate data communication or control flow between those
+subprograms and other parts of the work.
+
+  The Corresponding Source need not include anything that users
+can regenerate automatically from other parts of the Corresponding
+Source.
+
+  The Corresponding Source for a work in source code form is that
+same work.
+
+  2. Basic Permissions.
+
+  All rights granted under this License are granted for the term of
+copyright on the Program, and are irrevocable provided the stated
+conditions are met.  This License explicitly affirms your unlimited
+permission to run the unmodified Program.  The output from running a
+covered work is covered by this License only if the output, given its
+content, constitutes a covered work.  This License acknowledges your
+rights of fair use or other equivalent, as provided by copyright law.
+
+  You may make, run and propagate covered works that you do not
+convey, without conditions so long as your license otherwise remains
+in force.  You may convey covered works to others for the sole purpose
+of having them make modifications exclusively for you, or provide you
+with facilities for running those works, provided that you comply with
+the terms of this License in conveying all material for which you do
+not control copyright.  Those thus making or running the covered works
+for you must do so exclusively on your behalf, under your direction
+and control, on terms that prohibit them from making any copies of
+your copyrighted material outside their relationship with you.
+
+  Conveying under any other circumstances is permitted solely under
+the conditions stated below.  Sublicensing is not allowed; section 10
+makes it unnecessary.
+
+  3. Protecting Users' Legal Rights From Anti-Circumvention Law.
+
+  No covered work shall be deemed part of an effective technological
+measure under any applicable law fulfilling obligations under article
+11 of the WIPO copyright treaty adopted on 20 December 1996, or
+similar laws prohibiting or restricting circumvention of such
+measures.
+
+  When you convey a covered work, you waive any legal power to forbid
+circumvention of technological measures to the extent such circumvention
+is effected by exercising rights under this License with respect to
+the covered work, and you disclaim any intention to limit operation or
+modification of the work as a means of enforcing, against the work's
+users, your or third parties' legal rights to forbid circumvention of
+technological measures.
+
+  4. Conveying Verbatim Copies.
+
+  You may convey verbatim copies of the Program's source code as you
+receive it, in any medium, provided that you conspicuously and
+appropriately publish on each copy an appropriate copyright notice;
+keep intact all notices stating that this License and any
+non-permissive terms added in accord with section 7 apply to the code;
+keep intact all notices of the absence of any warranty; and give all
+recipients a copy of this License along with the Program.
+
+  You may charge any price or no price for each copy that you convey,
+and you may offer support or warranty protection for a fee.
+
+  5. Conveying Modified Source Versions.
+
+  You may convey a work based on the Program, or the modifications to
+produce it from the Program, in the form of source code under the
+terms of section 4, provided that you also meet all of these conditions:
+
+    a) The work must carry prominent notices stating that you modified
+    it, and giving a relevant date.
+
+    b) The work must carry prominent notices stating that it is
+    released under this License and any conditions added under section
+    7.  This requirement modifies the requirement in section 4 to
+    "keep intact all notices".
+
+    c) You must license the entire work, as a whole, under this
+    License to anyone who comes into possession of a copy.  This
+    License will therefore apply, along with any applicable section 7
+    additional terms, to the whole of the work, and all its parts,
+    regardless of how they are packaged.  This License gives no
+    permission to license the work in any other way, but it does not
+    invalidate such permission if you have separately received it.
+
+    d) If the work has interactive user interfaces, each must display
+    Appropriate Legal Notices; however, if the Program has interactive
+    interfaces that do not display Appropriate Legal Notices, your
+    work need not make them do so.
+
+  A compilation of a covered work with other separate and independent
+works, which are not by their nature extensions of the covered work,
+and which are not combined with it such as to form a larger program,
+in or on a volume of a storage or distribution medium, is called an
+"aggregate" if the compilation and its resulting copyright are not
+used to limit the access or legal rights of the compilation's users
+beyond what the individual works permit.  Inclusion of a covered work
+in an aggregate does not cause this License to apply to the other
+parts of the aggregate.
+
+  6. Conveying Non-Source Forms.
+
+  You may convey a covered work in object code form under the terms
+of sections 4 and 5, provided that you also convey the
+machine-readable Corresponding Source under the terms of this License,
+in one of these ways:
+
+    a) Convey the object code in, or embodied in, a physical product
+    (including a physical distribution medium), accompanied by the
+    Corresponding Source fixed on a durable physical medium
+    customarily used for software interchange.
+
+    b) Convey the object code in, or embodied in, a physical product
+    (including a physical distribution medium), accompanied by a
+    written offer, valid for at least three years and valid for as
+    long as you offer spare parts or customer support for that product
+    model, to give anyone who possesses the object code either (1) a
+    copy of the Corresponding Source for all the software in the
+    product that is covered by this License, on a durable physical
+    medium customarily used for software interchange, for a price no
+    more than your reasonable cost of physically performing this
+    conveying of source, or (2) access to copy the
+    Corresponding Source from a network server at no charge.
+
+    c) Convey individual copies of the object code with a copy of the
+    written offer to provide the Corresponding Source.  This
+    alternative is allowed only occasionally and noncommercially, and
+    only if you received the object code with such an offer, in accord
+    with subsection 6b.
+
+    d) Convey the object code by offering access from a designated
+    place (gratis or for a charge), and offer equivalent access to the
+    Corresponding Source in the same way through the same place at no
+    further charge.  You need not require recipients to copy the
+    Corresponding Source along with the object code.  If the place to
+    copy the object code is a network server, the Corresponding Source
+    may be on a different server (operated by you or a third party)
+    that supports equivalent copying facilities, provided you maintain
+    clear directions next to the object code saying where to find the
+    Corresponding Source.  Regardless of what server hosts the
+    Corresponding Source, you remain obligated to ensure that it is
+    available for as long as needed to satisfy these requirements.
+
+    e) Convey the object code using peer-to-peer transmission, provided
+    you inform other peers where the object code and Corresponding
+    Source of the work are being offered to the general public at no
+    charge under subsection 6d.
+
+  A separable portion of the object code, whose source code is excluded
+from the Corresponding Source as a System Library, need not be
+included in conveying the object code work.
+
+  A "User Product" is either (1) a "consumer product", which means any
+tangible personal property which is normally used for personal, family,
+or household purposes, or (2) anything designed or sold for incorporation
+into a dwelling.  In determining whether a product is a consumer product,
+doubtful cases shall be resolved in favor of coverage.  For a particular
+product received by a particular user, "normally used" refers to a
+typical or common use of that class of product, regardless of the status
+of the particular user or of the way in which the particular user
+actually uses, or expects or is expected to use, the product.  A product
+is a consumer product regardless of whether the product has substantial
+commercial, industrial or non-consumer uses, unless such uses represent
+the only significant mode of use of the product.
+
+  "Installation Information" for a User Product means any methods,
+procedures, authorization keys, or other information required to install
+and execute modified versions of a covered work in that User Product from
+a modified version of its Corresponding Source.  The information must
+suffice to ensure that the continued functioning of the modified object
+code is in no case prevented or interfered with solely because
+modification has been made.
+
+  If you convey an object code work under this section in, or with, or
+specifically for use in, a User Product, and the conveying occurs as
+part of a transaction in which the right of possession and use of the
+User Product is transferred to the recipient in perpetuity or for a
+fixed term (regardless of how the transaction is characterized), the
+Corresponding Source conveyed under this section must be accompanied
+by the Installation Information.  But this requirement does not apply
+if neither you nor any third party retains the ability to install
+modified object code on the User Product (for example, the work has
+been installed in ROM).
+
+  The requirement to provide Installation Information does not include a
+requirement to continue to provide support service, warranty, or updates
+for a work that has been modified or installed by the recipient, or for
+the User Product in which it has been modified or installed.  Access to a
+network may be denied when the modification itself materially and
+adversely affects the operation of the network or violates the rules and
+protocols for communication across the network.
+
+  Corresponding Source conveyed, and Installation Information provided,
+in accord with this section must be in a format that is publicly
+documented (and with an implementation available to the public in
+source code form), and must require no special password or key for
+unpacking, reading or copying.
+
+  7. Additional Terms.
+
+  "Additional permissions" are terms that supplement the terms of this
+License by making exceptions from one or more of its conditions.
+Additional permissions that are applicable to the entire Program shall
+be treated as though they were included in this License, to the extent
+that they are valid under applicable law.  If additional permissions
+apply only to part of the Program, that part may be used separately
+under those permissions, but the entire Program remains governed by
+this License without regard to the additional permissions.
+
+  When you convey a copy of a covered work, you may at your option
+remove any additional permissions from that copy, or from any part of
+it.  (Additional permissions may be written to require their own
+removal in certain cases when you modify the work.)  You may place
+additional permissions on material, added by you to a covered work,
+for which you have or can give appropriate copyright permission.
+
+  Notwithstanding any other provision of this License, for material you
+add to a covered work, you may (if authorized by the copyright holders of
+that material) supplement the terms of this License with terms:
+
+    a) Disclaiming warranty or limiting liability differently from the
+    terms of sections 15 and 16 of this License; or
+
+    b) Requiring preservation of specified reasonable legal notices or
+    author attributions in that material or in the Appropriate Legal
+    Notices displayed by works containing it; or
+
+    c) Prohibiting misrepresentation of the origin of that material, or
+    requiring that modified versions of such material be marked in
+    reasonable ways as different from the original version; or
+
+    d) Limiting the use for publicity purposes of names of licensors or
+    authors of the material; or
+
+    e) Declining to grant rights under trademark law for use of some
+    trade names, trademarks, or service marks; or
+
+    f) Requiring indemnification of licensors and authors of that
+    material by anyone who conveys the material (or modified versions of
+    it) with contractual assumptions of liability to the recipient, for
+    any liability that these contractual assumptions directly impose on
+    those licensors and authors.
+
+  All other non-permissive additional terms are considered "further
+restrictions" within the meaning of section 10.  If the Program as you
+received it, or any part of it, contains a notice stating that it is
+governed by this License along with a term that is a further
+restriction, you may remove that term.  If a license document contains
+a further restriction but permits relicensing or conveying under this
+License, you may add to a covered work material governed by the terms
+of that license document, provided that the further restriction does
+not survive such relicensing or conveying.
+
+  If you add terms to a covered work in accord with this section, you
+must place, in the relevant source files, a statement of the
+additional terms that apply to those files, or a notice indicating
+where to find the applicable terms.
+
+  Additional terms, permissive or non-permissive, may be stated in the
+form of a separately written license, or stated as exceptions;
+the above requirements apply either way.
+
+  8. Termination.
+
+  You may not propagate or modify a covered work except as expressly
+provided under this License.  Any attempt otherwise to propagate or
+modify it is void, and will automatically terminate your rights under
+this License (including any patent licenses granted under the third
+paragraph of section 11).
+
+  However, if you cease all violation of this License, then your
+license from a particular copyright holder is reinstated (a)
+provisionally, unless and until the copyright holder explicitly and
+finally terminates your license, and (b) permanently, if the copyright
+holder fails to notify you of the violation by some reasonable means
+prior to 60 days after the cessation.
+
+  Moreover, your license from a particular copyright holder is
+reinstated permanently if the copyright holder notifies you of the
+violation by some reasonable means, this is the first time you have
+received notice of violation of this License (for any work) from that
+copyright holder, and you cure the violation prior to 30 days after
+your receipt of the notice.
+
+  Termination of your rights under this section does not terminate the
+licenses of parties who have received copies or rights from you under
+this License.  If your rights have been terminated and not permanently
+reinstated, you do not qualify to receive new licenses for the same
+material under section 10.
+
+  9. Acceptance Not Required for Having Copies.
+
+  You are not required to accept this License in order to receive or
+run a copy of the Program.  Ancillary propagation of a covered work
+occurring solely as a consequence of using peer-to-peer transmission
+to receive a copy likewise does not require acceptance.  However,
+nothing other than this License grants you permission to propagate or
+modify any covered work.  These actions infringe copyright if you do
+not accept this License.  Therefore, by modifying or propagating a
+covered work, you indicate your acceptance of this License to do so.
+
+  10. Automatic Licensing of Downstream Recipients.
+
+  Each time you convey a covered work, the recipient automatically
+receives a license from the original licensors, to run, modify and
+propagate that work, subject to this License.  You are not responsible
+for enforcing compliance by third parties with this License.
+
+  An "entity transaction" is a transaction transferring control of an
+organization, or substantially all assets of one, or subdividing an
+organization, or merging organizations.  If propagation of a covered
+work results from an entity transaction, each party to that
+transaction who receives a copy of the work also receives whatever
+licenses to the work the party's predecessor in interest had or could
+give under the previous paragraph, plus a right to possession of the
+Corresponding Source of the work from the predecessor in interest, if
+the predecessor has it or can get it with reasonable efforts.
+
+  You may not impose any further restrictions on the exercise of the
+rights granted or affirmed under this License.  For example, you may
+not impose a license fee, royalty, or other charge for exercise of
+rights granted under this License, and you may not initiate litigation
+(including a cross-claim or counterclaim in a lawsuit) alleging that
+any patent claim is infringed by making, using, selling, offering for
+sale, or importing the Program or any portion of it.
+
+  11. Patents.
+
+  A "contributor" is a copyright holder who authorizes use under this
+License of the Program or a work on which the Program is based.  The
+work thus licensed is called the contributor's "contributor version".
+
+  A contributor's "essential patent claims" are all patent claims
+owned or controlled by the contributor, whether already acquired or
+hereafter acquired, that would be infringed by some manner, permitted
+by this License, of making, using, or selling its contributor version,
+but do not include claims that would be infringed only as a
+consequence of further modification of the contributor version.  For
+purposes of this definition, "control" includes the right to grant
+patent sublicenses in a manner consistent with the requirements of
+this License.
+
+  Each contributor grants you a non-exclusive, worldwide, royalty-free
+patent license under the contributor's essential patent claims, to
+make, use, sell, offer for sale, import and otherwise run, modify and
+propagate the contents of its contributor version.
+
+  In the following three paragraphs, a "patent license" is any express
+agreement or commitment, however denominated, not to enforce a patent
+(such as an express permission to practice a patent or covenant not to
+sue for patent infringement).  To "grant" such a patent license to a
+party means to make such an agreement or commitment not to enforce a
+patent against the party.
+
+  If you convey a covered work, knowingly relying on a patent license,
+and the Corresponding Source of the work is not available for anyone
+to copy, free of charge and under the terms of this License, through a
+publicly available network server or other readily accessible means,
+then you must either (1) cause the Corresponding Source to be so
+available, or (2) arrange to deprive yourself of the benefit of the
+patent license for this particular work, or (3) arrange, in a manner
+consistent with the requirements of this License, to extend the patent
+license to downstream recipients.  "Knowingly relying" means you have
+actual knowledge that, but for the patent license, your conveying the
+covered work in a country, or your recipient's use of the covered work
+in a country, would infringe one or more identifiable patents in that
+country that you have reason to believe are valid.
+
+  If, pursuant to or in connection with a single transaction or
+arrangement, you convey, or propagate by procuring conveyance of, a
+covered work, and grant a patent license to some of the parties
+receiving the covered work authorizing them to use, propagate, modify
+or convey a specific copy of the covered work, then the patent license
+you grant is automatically extended to all recipients of the covered
+work and works based on it.
+
+  A patent license is "discriminatory" if it does not include within
+the scope of its coverage, prohibits the exercise of, or is
+conditioned on the non-exercise of one or more of the rights that are
+specifically granted under this License.  You may not convey a covered
+work if you are a party to an arrangement with a third party that is
+in the business of distributing software, under which you make payment
+to the third party based on the extent of your activity of conveying
+the work, and under which the third party grants, to any of the
+parties who would receive the covered work from you, a discriminatory
+patent license (a) in connection with copies of the covered work
+conveyed by you (or copies made from those copies), or (b) primarily
+for and in connection with specific products or compilations that
+contain the covered work, unless you entered into that arrangement,
+or that patent license was granted, prior to 28 March 2007.
+
+  Nothing in this License shall be construed as excluding or limiting
+any implied license or other defenses to infringement that may
+otherwise be available to you under applicable patent law.
+
+  12. No Surrender of Others' Freedom.
+
+  If conditions are imposed on you (whether by court order, agreement or
+otherwise) that contradict the conditions of this License, they do not
+excuse you from the conditions of this License.  If you cannot convey a
+covered work so as to satisfy simultaneously your obligations under this
+License and any other pertinent obligations, then as a consequence you may
+not convey it at all.  For example, if you agree to terms that obligate you
+to collect a royalty for further conveying from those to whom you convey
+the Program, the only way you could satisfy both those terms and this
+License would be to refrain entirely from conveying the Program.
+
+  13. Use with the GNU Affero General Public License.
+
+  Notwithstanding any other provision of this License, you have
+permission to link or combine any covered work with a work licensed
+under version 3 of the GNU Affero General Public License into a single
+combined work, and to convey the resulting work.  The terms of this
+License will continue to apply to the part which is the covered work,
+but the special requirements of the GNU Affero General Public License,
+section 13, concerning interaction through a network will apply to the
+combination as such.
+
+  14. Revised Versions of this License.
+
+  The Free Software Foundation may publish revised and/or new versions of
+the GNU General Public License from time to time.  Such new versions will
+be similar in spirit to the present version, but may differ in detail to
+address new problems or concerns.
+
+  Each version is given a distinguishing version number.  If the
+Program specifies that a certain numbered version of the GNU General
+Public License "or any later version" applies to it, you have the
+option of following the terms and conditions either of that numbered
+version or of any later version published by the Free Software
+Foundation.  If the Program does not specify a version number of the
+GNU General Public License, you may choose any version ever published
+by the Free Software Foundation.
+
+  If the Program specifies that a proxy can decide which future
+versions of the GNU General Public License can be used, that proxy's
+public statement of acceptance of a version permanently authorizes you
+to choose that version for the Program.
+
+  Later license versions may give you additional or different
+permissions.  However, no additional obligations are imposed on any
+author or copyright holder as a result of your choosing to follow a
+later version.
+
+  15. Disclaimer of Warranty.
+
+  THERE IS NO WARRANTY FOR THE PROGRAM, TO THE EXTENT PERMITTED BY
+APPLICABLE LAW.  EXCEPT WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT
+HOLDERS AND/OR OTHER PARTIES PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY
+OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING, BUT NOT LIMITED TO,
+THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
+PURPOSE.  THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE PROGRAM
+IS WITH YOU.  SHOULD THE PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF
+ALL NECESSARY SERVICING, REPAIR OR CORRECTION.
+
+  16. Limitation of Liability.
+
+  IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
+WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MODIFIES AND/OR CONVEYS
+THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES, INCLUDING ANY
+GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING OUT OF THE
+USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED TO LOSS OF
+DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY YOU OR THIRD
+PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER PROGRAMS),
+EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE POSSIBILITY OF
+SUCH DAMAGES.
+
+  17. Interpretation of Sections 15 and 16.
+
+  If the disclaimer of warranty and limitation of liability provided
+above cannot be given local legal effect according to their terms,
+reviewing courts shall apply local law that most closely approximates
+an absolute waiver of all civil liability in connection with the
+Program, unless a warranty or assumption of liability accompanies a
+copy of the Program in return for a fee.
+
+                     END OF TERMS AND CONDITIONS
+
+            How to Apply These Terms to Your New Programs
+
+  If you develop a new program, and you want it to be of the greatest
+possible use to the public, the best way to achieve this is to make it
+free software which everyone can redistribute and change under these terms.
+
+  To do so, attach the following notices to the program.  It is safest
+to attach them to the start of each source file to most effectively
+state the exclusion of warranty; and each file should have at least
+the "copyright" line and a pointer to where the full notice is found.
+
+    <one line to give the program's name and a brief idea of what it does.>
+    Copyright (C) <year>  <name of author>
+
+    This program is free software: you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation, either version 3 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program.  If not, see <http://www.gnu.org/licenses/>.
+
+Also add information on how to contact you by electronic and paper mail.
+
+  If the program does terminal interaction, make it output a short
+notice like this when it starts in an interactive mode:
+
+    <program>  Copyright (C) <year>  <name of author>
+    This program comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
+    This is free software, and you are welcome to redistribute it
+    under certain conditions; type `show c' for details.
+
+The hypothetical commands `show w' and `show c' should show the appropriate
+parts of the General Public License.  Of course, your program's commands
+might be different; for a GUI interface, you would use an "about box".
+
+  You should also get your employer (if you work as a programmer) or school,
+if any, to sign a "copyright disclaimer" for the program, if necessary.
+For more information on this, and how to apply and follow the GNU GPL, see
+<http://www.gnu.org/licenses/>.
+
+  The GNU General Public License does not permit incorporating your program
+into proprietary programs.  If your program is a subroutine library, you
+may consider it more useful to permit linking proprietary applications with
+the library.  If this is what you want to do, use the GNU Lesser General
+Public License instead of this License.  But first, please read
+<http://www.gnu.org/philosophy/why-not-lgpl.html>.
\ No newline at end of file
diff --git a/mod/lightboxgallery/README.md b/mod/lightboxgallery/README.md
new file mode 100644
index 0000000..22ed7cc
--- /dev/null
+++ b/mod/lightboxgallery/README.md
@@ -0,0 +1,30 @@
+# Lightbox gallery activity for Moodle 2.7+
+
+[![Build Status](https://travis-ci.org/netspotau/moodle-mod_lightboxgallery.svg?branch=master)](https://travis-ci.org/netspotau/moodle-mod_lightboxgallery)
+[![License](https://poser.pugx.org/netspotau/moodle-mod_lightboxgallery/license)](https://packagist.org/packages/netspotau/moodle-mod_lightboxgallery)
+
+This resource allows you to create 'Lightbox' enabled image galleries within your Moodle course. The
+Lightbox system is a set of scripts than can be used to apply nice effects to image galleries.
+
+As a course teacher, you are able to create, edit and delete galleries. Small thumbnails will then be
+generated, which are used for the thumbnail view of the gallery.
+
+Clicking on any of the thumbnails brings that image into focus, and allows you to scroll through the
+gallery at your leisure. Using the Lightbox scripts creates nice transition effects when loading and
+scrolling through the images.
+
+## Install
+### Using Moodle
+You can install the plugin from the Moodle plugin repository from within your Moodle installation.
+### Using a downloaded zip file
+You can download a zip of this module from: https://github.com/netspotau/moodle-mod_lightboxgallery/zipball/master  
+Unzip it to your mod/ folder and rename the extracted folder to 'lightboxgallery'.
+### Using Git
+To install using git, run the following command from the root of your moodle installation:  
+git clone git://github.com/netspotau/moodle-mod_lightboxgallery.git mod/lightboxgallery  
+
+Then add mod/lightboxgallery to your gitignore.
+
+## Credits
+Maintainer: Adam Olley (adam.olley@netspot.com.au)  
+Original plugin: Paul Holden (pholden[at]greenhead[dot]ac[dot]uk)  
diff --git a/mod/lightboxgallery/assets/gallery-lightbox-core.css b/mod/lightboxgallery/assets/gallery-lightbox-core.css
new file mode 100644
index 0000000..9d5b7c6
--- /dev/null
+++ b/mod/lightboxgallery/assets/gallery-lightbox-core.css
@@ -0,0 +1 @@
+/* NEED TO SEPARATE SKINS APPROPRIATELY. */
\ No newline at end of file
diff --git a/mod/lightboxgallery/assets/skins/sam/closelabel.gif b/mod/lightboxgallery/assets/skins/sam/closelabel.gif
new file mode 100644
index 0000000000000000000000000000000000000000..87b4f8bd699386e3a6fcc2e50d7c61bfc4aabb8d
GIT binary patch
literal 979
zcmZ?wbhEHbbYc)=c*ekR;J|@{2M^AjJ2x^i^3tVC&CSj0*RTKj_3M)-PXYo0cI?>E
z)6+9$%9N0hkg%|@J9q8`1qGcvc``6CFd`x%G&J<hn>WG1!QZ}p`}_Crt5>gn{ra_R
z*|PBP@I{Lj`S|$w`}?P*rG5YY{qEhnXU?2SNJyxzu3ors;h#T$K79Ca@7}$foSdy&
zxBmY9d+OAwXV0EJb?Q__MaApauf4s!A3S&vA0NMS=g#~0?{C?%rLC>4pr9Z*Ir-_+
zr;{d4>gecLxpHM*Uf%TS)ARH5uU@^{*Vp&<?c3DU)UvX&88c?&=H}Ma)VzQH{`vFg
z8#iv;ym|A-j~^>5E2E;KQc_ZUeSM3Ii__E7r%jvI-roNB@nb(fzs$_c+qZ95RaO1}
z|Nq~=e++a1ia%Mv_UM2}P@FKZ|8IzCYHn$5Ywzgn>h9_7>+gx3G<nL@Y15}qh*9sI
zF>n5iiIZY<+?`^k#V9jLtyr*r!J=422f09{b+Ju)CUT+TQ$(XUHpFrqp3WW>wX1uv
zuMxADYt*_`D!j~cc9U4RqaSdy#4<#mnaaTWAexn73fF5^{TRmAubUT3M$0pEhL|<E
zUD#m2z|AKTtCSNd;OO1L#CBrl>XZa-W~L|(gBwDDiyC{R^)5V?SdhX{^V3U3;)26b
z9`PG&9vg+2LK~Ub)t*kN@Dpm%WzyoDVKHUWf+~JK$+ZDZ@~kR1)Kp$5Zt9+<`%Y)-
z>yw)=g|fzKY2BzS@eXpHy5ookQ(^-%AM<|&o|T%JuT^(X?uuf%wX|uMuC&0ET*U<&
zn5MV|N-Q);aBAjTtM<^<-0=N0@0#5*3?I(E@i^2b=>KSu3P<uZo)TZBhOc?4o*#|{
zCd~~sIzBO-d+A(5RcTiCLf?df(g)A{k}cJv&*sdW@yyeqP+NAcQ!7hmq=Ur_hJ}X<
zJh>#TbT%XyyED9)8M<diq4JFlZ_INnBhNRSWN={#WG}R3?9tY@*f5vn(9TD`Hjk$y
z`-i<;v)Lh+x2gDs$G3{KUJeBZ23IE46a^1nCO-v7cJ+Xwp5pa$Doz?%x*j^pY_;Y|
zJkJV_O-(E^1qz3GkA9iaWgKI1kby-$=i$OY?T85u27F3CUOdq__u>!}zkkRC?kPTh
mHXNSne@Ka2Tq>lLlg+!}=2PuWCXYMo(tpiJ>u+RWum%8KFq1q0

literal 0
HcmV?d00001

diff --git a/mod/lightboxgallery/assets/skins/sam/gallery-lightbox-skin.css b/mod/lightboxgallery/assets/skins/sam/gallery-lightbox-skin.css
new file mode 100644
index 0000000..c3289c5
--- /dev/null
+++ b/mod/lightboxgallery/assets/skins/sam/gallery-lightbox-skin.css
@@ -0,0 +1,83 @@
+#lightbox {
+  position: absolute;
+  left: 0;
+  width: 100%;
+  z-index: 100;
+  text-align: center;
+  line-height: 0;
+}
+#lightbox img { width: auto; height: auto; }
+#lightbox a img { border: none; }
+
+#outerImageContainer {
+  position: relative;
+  background-color: #fff;
+  width: 250px;
+  height: 250px;
+  margin: 0 auto;
+}
+#imageContainer { padding: 10px; }
+
+#loading {
+  position: absolute;
+  top: 40%;
+  left: 0%;
+  height: 25%;
+  background: url(loading.gif) no-repeat top center;
+  width: 100%;
+  text-align: center;
+  line-height: 0;
+}
+#hoverNav {
+  position: absolute;
+  top: 0;
+  left: 0;
+  height: 100%;
+  width: 100%;
+  z-index: 10;
+}
+#imageContainer > #hoverNav { left: 0; }
+#hoverNav a { outline: none; }
+
+#prevLink, #nextLink {
+  width: 49%;
+  height: 100%;
+  background-image: url(data:image/gif;base64,AAAA);
+  /* Trick IE into showing hover */ display: block;
+}
+#prevLink { left: 0; float: left; }
+#nextLink { right: 0; float: right; }
+#prevLink:hover, #prevLink:visited:hover { background: url(prevlabel.gif) left 15% no-repeat; }
+#nextLink:hover, #nextLink:visited:hover { background: url(nextlabel.gif) right 15% no-repeat; }
+
+#imageDataContainer {
+  font: 10px Verdana, Helvetica, sans-serif;
+  background-color: #fff;
+  margin: 0 auto;
+  line-height: 1.4em;
+  overflow: auto;
+  width: 100%;
+}
+
+#imageData { padding:0 10px; color: #666; }
+#imageData #imageDetails { width: 70%; float: left; text-align: left; }
+#imageData #caption { font-weight: bold; }
+#imageData #numberDisplay { display: block; clear: left; padding-bottom: 1.0em; }
+#imageData #bottomNavClose {
+  width: 66px;
+  height:22px;
+  background: url(closelabel.gif) no-repeat;
+  float: right;
+  padding-bottom: 0.7em;
+  outline: none;
+}
+
+#overlay {
+  position: absolute;
+  top: 0;
+  left: 0;
+  z-index: 90;
+  width: 100%;
+  height: 500px;
+  background-color: #000;
+}
diff --git a/mod/lightboxgallery/assets/skins/sam/gallery-lightbox.css b/mod/lightboxgallery/assets/skins/sam/gallery-lightbox.css
new file mode 100644
index 0000000..9ba7bd8
--- /dev/null
+++ b/mod/lightboxgallery/assets/skins/sam/gallery-lightbox.css
@@ -0,0 +1 @@
+#lightbox{position:absolute;left:0;width:100%;z-index:100;text-align:center;line-height:0;}#lightbox img{width:auto;height:auto;}#lightbox a img{border:none;}#outerImageContainer{position:relative;background-color:#fff;width:250px;height:250px;margin:0 auto;}#imageContainer{padding:10px;}#loading{position:absolute;top:40%;left:0;height:25%;background:url(loading.gif) no-repeat top center;width:100%;text-align:center;line-height:0;}#hoverNav{position:absolute;top:0;left:0;height:100%;width:100%;z-index:10;}#imageContainer>#hoverNav{left:0;}#hoverNav a{outline:none;}#prevLink,#nextLink{width:49%;height:100%;background-image:url(data:image/gif;base64,AAAA);display:block;}#prevLink{left:0;float:left;}#nextLink{right:0;float:right;}#prevLink:hover,#prevLink:visited:hover{background:url(prevlabel.gif) left 15% no-repeat;}#nextLink:hover,#nextLink:visited:hover{background:url(nextlabel.gif) right 15% no-repeat;}#imageDataContainer{font:10px Verdana,Helvetica,sans-serif;background-color:#fff;margin:0 auto;line-height:1.4em;overflow:auto;width:100%;}#imageData{padding:0 10px;color:#666;}#imageData #imageDetails{width:70%;float:left;text-align:left;}#imageData #caption{font-weight:bold;}#imageData #numberDisplay{display:block;clear:left;padding-bottom:1.0em;}#imageData #bottomNavClose{width:66px;height:22px;background:url(closelabel.gif) no-repeat;float:right;padding-bottom:.7em;outline:none;}#overlay{position:absolute;top:0;left:0;z-index:90;width:100%;height:500px;background-color:#000;}
diff --git a/mod/lightboxgallery/assets/skins/sam/loading.gif b/mod/lightboxgallery/assets/skins/sam/loading.gif
new file mode 100644
index 0000000000000000000000000000000000000000..f864d5fd38b7466c76b5a36dc0e3e9455c0126e2
GIT binary patch
literal 2767
zcmeH``%_bA0*1eHPVNawNVtR;Fkp-nQj8edfS`v<5L7TgR6wi;WfgH-0}4fE+c_uU
zB6tf6auF}FAcDdgg|bMU&H)LR5jARM!8$tuwd<npD63mr>$nHqS?K-=JN<t7e*5P6
z-uHc0#>Z+yGvz=Iegxp{+qWGZ9j{-%9vvN>n3$NJp6==CAqYaF(LfM1Z{EEA{{Gt9
z+Ba|B7z_sR+xabl|E~mm-*OXmhLq??y)HONjX>1ze1D?RIn=G1`RR-%fb}zgSh6^a
z(}Zw20U1L^Cs9UcyJfc+al#}J2xVlYUoR{`gd<uT7=(OQE|2-Z(nMC#lKGlv79x5d
zU>&QDxAb1w4>I~5gc?ccq<DVV(52nh>(G+T!I;H};U_uyHR0@hr>Qk1P1=6fvUBhR
zb|&^^cEQtu&W}=-=YR7o5UI)AD*~%J7bkVd5`xrdw{bHm;|Bf^_|FG$9l}`ruhnVF
zO%=6X*I#yro*pmfB;-A0cVjz73Qy)`oa=df_3Bx6!M3TNALf9BwI*di`jhdovR(I=
zFT31zui1Xw??+Ym-lWNq=V6~8t<Qvdt_E%oNn9fTbsQ2PqT;~c#bJ}<5JMc01#sU;
zgzFY-&{}#4gzc5BdZc%n_DfuHp417Oh+^(Xq9@rvVK3z=MGBC-ZJ?A!OaJ|&WI2Q|
zgzF7yw%;WZ2o6WA!U;!h+>t012$@*hy3So0QNJ#eIJ4<WkvH0<8aun~TE#+rL1fwm
z2%3eODa;%2DX8*yP(~+U(8U26{=&>Yh{qJ+aTY>ng8W1p4BrwB_>i7AY-xmG<ik=$
zYc4)q%}EQ+AaftsVY$wuztw`rA7i;nUuhjAfkZQTXsBfyIGn%^(iXjFN<JOV<sB@v
zOeL8&u+?`Sy#$8J4L5=`Me?m{Pj3wg-q)aSi#<4(j!DsZ0auESn4x3gIAmgp186pq
zgo_299&+4)>rA}hAeq`aX(yx~=c&|=$w&*&PpKd;G@@0oXK@D0x=;tyY&Eb|HKPsM
z71v`PO)na3pfO*xUD8Z|CQju)c+RSAH=5V^4vb9Q2JwHwt|-INt|!nD?AlRxF5ZT8
zaA9~hGb$~rMhQh_0+31$tkzyLi>X3c7>F!|Jyn`+5{LG=E`sIQbHA8!=`uday6D6Y
zNtVL?j^`6A%UuwO!`}j#s~H?w=P<5}Z2)*PPx|5q$MM+1K6_d_cie9JVArbrB2sRy
zOl**1Mc+|zLM>munG#O|##RApuODr^1+pL-?SHX+D6Dz_@%-Oo(fM&hHYZ-jWU5jf
z&nBYG;>F6&Y`veoLdZ@0WyrDsuXOP)9g*C`A(+R`Ryc2+9w_DJNaf@Dzg?~N{uI_}
zjV(!yygvrGv#KF*Mt{6H<LHZ)J7!w@mm1?8xw*lGP19;?P7#QjzW&o8C;q*eam++V
z$*0f>^v1Ve=hQyF2^E~bd#&iZg;(%dS^<ElV&_w|2i{kU&Q!~nSZtX@iOYf@g|Jdi
zl<)#Mmsv^o2M!^jMQ;0YfxSYuBu7=Bv|zAm0h^S?i%$^^TF>nM;oGSF1Y^&rY}Ian
zFrp%SBGPyN{Z?t%Mo#!qgLQ2)k{>KAv<Bj4#e#weRJgP60`lkeF{`Vd8ou5x(CWt=
z?SpjY*&H5g7LY|*@m|+2{;Mkm=#SYZ&=QV!*qUy+FH|mBx<zJP(g-24Wzt{broS2@
z=pGi04SfI@N_HD>?=zez<?;BhvPHm*F!MwT(&|4zM+J3m91Kb+i{BNdx|^4kY+Cz;
zG^DOGV4w{?za>KN*qPRf>^4QjcWgyxiC}7Vb6vGrBLR(1J&B%*gb{`!Jljb^2%jB$
zFBNUHANC6Q?0~<ecM#z*vJ`l(Gp=UQMr8(O#34k(j54G>M}cVtgk_;_DAB-BE?2dP
z(C9OIXza3Ao-@UyqX%`5cjg#cHl!uHq;&?~JO{eE+A2KSSD)s8v&CiV$kV$A=DG@i
z;6JY7z*8oPdj@bb<!X4U&DmGRri=Edg<skCOO|-3Ef?;a4hg*QVu?Hxz!D~!MWPRT
zYq)G)UA<%B%3_rcR+D0Uq@FHftQ!*f-e_2{DLw0_-0e5aOPSU`bX!|)p3(0JN+|4X
z9xYja{;x4w_bn;KT;4J7RtGv>JQoTAENW#ls(ucbGA#yhN>zbWqBTbLl>rGqOAY+`
z=psSt8VQE=9+X8^$l@<H4OjVp9E6cp#p)XQ=5J}2E-vhY=g+^mr_e}1h&z)N5-0a1
zPBJ(^nC|L#t9gwtA1zW(MK|eO(i2{Fw2qz<unXUWc{HVhxhw#{)TF#AmWp?a#|Uci
zOdl;N_w6fTGPE)Yn2agm3O>oeDzRvja79ry3nvLcOR7+)bIFyJVoz4}URM-47_u>V
zY*^e(o`?|l++*Y0uQ#&dKapW1o?J{jx+*_gKV^cW+W87KI7hZ5viXv$$=1IR^Z~yA
XWBrHU7iSEP8X8hQyAJO{V6g1pwSv80

literal 0
HcmV?d00001

diff --git a/mod/lightboxgallery/assets/skins/sam/nextlabel.gif b/mod/lightboxgallery/assets/skins/sam/nextlabel.gif
new file mode 100644
index 0000000000000000000000000000000000000000..6c40e51a31bce7ddfac5f10ec11e2403019ca4b2
GIT binary patch
literal 1252
zcmZ?wbhEHbv}aIY_}<L$_wV1AFJHR5yRTfivcJFo*|TRCE?hWt=+K)tZ{ELuziQR0
zj~_pN`}XbEuV4TE{fmi-`TqU;+qZAi)6-K^Q{&^~Jv}|oo;~~S-Mi@M=-<D8@7c3w
z*|KG?UcFkre0f1Z!G{kYqN1W28X7ik+?br4oRE<4^XJbOFJAcg_=JRn`1$!QUcC6y
zrAtXkNzb1@&&bH=>+1^-4^K=?3=9lhv0}y5t5@&ezkl%H!9Rcg{P^)>;>3wtwrq)w
zjlFm8UUPGERaI4EW8<e!pVHFOnwpx<pFbZI6cia5xq9{L*4EbC+}xCult+&qojP?Y
zEG%rvk|kTWZr!wL)AsG#U0q${;^G!9TJ-tz=hLT8A3Js|J3G6ywDiP@6SHQ`3Jndd
zsHo`Z=<x9HC@(L+apOjBZ||;MyJpUu`QX8Wyu3VbZ|`f@uHCtFCpb8G>C&ZHSy^-E
z&h_{AU$<`EzJ2?8dU||)ecRgFo;-Q-@ZrPj*RQWxv*z{d*M|=uc5-rxh={1Gt1B)p
zuB@z_J$v@!$B%Pza=v`|^8f#TV`F26Q9$<)Q2fcl$iUFdpaZfQlqVQC{xh)i3b|}p
zaIl#}SS#j)z{3M=0?J-<JT@*m+AU$6b?3y!#mD;<oV#Q^H!V3iS;LWOgVAB9gVJU$
z99&Oa4mQk|opK@L(If>X){18<BodDFHt|_0RIoTKaN?0;k$zLDaDs(fMA)t8M&iPw
zqC6=qmI?)nx)>#t4FnV&ADwPmY8kM^qRBa+Ss;jowc>(u6Q{856unO7<BrorqGYCM
z9BA}y6_v4Ii10e#I>XG0CH04+qke}t=kX<#j~4ncHM_B}aGWghWz=*1$MI;5Ihzn`
zR>+M+2LUH}Nrf;O8HEK5*-SzOS8gh?H%&OlI4R-5V@A)8?M)0{K5SZi?8BqustgAU
z4W70%>8X6NvjF;niDfctr^2SjR(=JxPU-N@Kg|kk4K@aj0`s0W2=G_6C~$~~mQ0YZ
z_~ZFtzJjxXVl#JDU_&dLOqZiOr_+IkwphCb3~r9UHhw$ABFy#3ot1^n;2<Z{l^Ms`
zlxA#nbTkop$XI6VvQge6L`7hJ8pj+qhiY*XNk(SwJB3RWxLGDJI`SwKID5r}T{$4Y
w)}pzLQLN&+s*CE4f&;U1<USmeOh2aid``)=%;$5tY+KY_nBH;*IxtuR0GFbqL;wH)

literal 0
HcmV?d00001

diff --git a/mod/lightboxgallery/assets/skins/sam/prevlabel.gif b/mod/lightboxgallery/assets/skins/sam/prevlabel.gif
new file mode 100644
index 0000000000000000000000000000000000000000..51a31c2fd7829eb95c071b4ba1d82863a723f5a8
GIT binary patch
literal 1264
zcmZ?wbhEHbv}aIY_}<BI=gytKfB$~__HEa$UAJ!C`uFc&baeE=g9pEU{rcz6pSZX<
zUtiz&`1oJHem!{b;Of<@H*VZ$XlO`CNC*rJ3<(MG^76WS_wJ)dk8a+)dEmf-$B!TX
z{Q2|Hp+kocAO7&+!>3Q5cJJQ3V8Md>_wP41H#<2wd3$@u#>PfPMHLklWo2dU+qZAR
zgb7ooOgVGr%#R;GmMmEk6cm)2ntJTmu_H&0<mBWuHa2eCw(aTDr^(651qB6VWo2n;
zY0sZOfBpLPxpU{PU%!6p)TxsvPri8ZA|@s#ARu7j!iBxPy|ZV}uBfP}uCAUjW5&IE
z_by+)?BL+AW5*76clY}G`l_m`&!0bEyLN5)^5xH-J@fbXFE1}oNlEeW@Tjb;+_PuT
zmoHyRN=owc^VhCjyLj>9-@kvaTeoii{{4A*d5MXMnVFeau3YKs>)X0@>)yS47cE-!
z>eZ{cbLZ~dxid60bk?j{%a$$s`0?ZS@84IgT6N*Vg`S?C6DLlrSg~UD>eWd}No{Ry
zo}Qi&5fPg=Z+`gjp`)W?VPWC<^XE^WK3!Z~{Qmv>@bK_=@813Y|KHfym|+yqI0O`b
zvM@3*bTa6G>;dHo29Ey>f}AoQ8x|aF<`C90nW1s<P`iM#U5UoVMMt|OjI-{X*tqz3
zzk+j@jOV5$CnswJ=jA*|_F>}-j^R+5pxE3c=EPF>qF}*uMm`(1lNtsE&J(Pa1h33E
zupm>2y`$?uz=8!nJvJRW5(X&`j&QP;UhrWsn9#tfti<Z@QR#v6ETJ-?HHHic&8;%E
zbr~BrIkB|tXXVr3Fck1-mCsZb@M>6bfKxUoPGg6n0iPgWs91pJ3q@95mJWd!P8X9U
z4IGv>3L7RK^<Xey+m;Z}?A+AME#kJK;PDdXWDAi7g`^<HBOZ*(9Wx}97&+No^b?Lq
zI58gOabe(@VX&F`cn4dDfzH{0CXY@Qx#QVyUKl(+F4O4B!|*dGslkCkI3hz};}fTs
zDk&BXtlT}S*IFGF4K6q{S-tqkSjK&!Z~_na8^uNimAP$96)dd_4zPAK1UN}Y`ffPH
ztTC^!!=d#;fTIXw$_iI58NQMu(n<=4ScPg>KC-j=Pf$n^uHy(fAlT3m7{nlD5pc^P
zhe1JD$<{{U2pfaIf~C{scvRR~7OYfx=4vj$aA0P}Jjus1__rn;W+*sj$-t4g;b#CN
d<CB%k=aqeX`Fwr@o7Rf?BD}i-oEaGztO3*evk(9P

literal 0
HcmV?d00001

diff --git a/mod/lightboxgallery/backup/moodle2/backup_lightboxgallery_activity_task.class.php b/mod/lightboxgallery/backup/moodle2/backup_lightboxgallery_activity_task.class.php
new file mode 100644
index 0000000..8a1baf3
--- /dev/null
+++ b/mod/lightboxgallery/backup/moodle2/backup_lightboxgallery_activity_task.class.php
@@ -0,0 +1,72 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * This file contains the backup activity for the lightboxgallery module
+ *
+ * @package mod_lightboxgallery
+ * @copyright 2010
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+require_once($CFG->dirroot . '/mod/lightboxgallery/backup/moodle2/backup_lightboxgallery_stepslib.php');
+
+/**
+ * lightboxgallery backup task that provides all the settings and steps to perform one complete backup of the activity
+ *
+ * @package mod_lightboxgallery
+ */
+class backup_lightboxgallery_activity_task extends backup_activity_task {
+
+    /**
+     * Define (add) particular settings this activity can have
+     */
+    protected function define_my_settings() {
+        // No particular settings for this activity.
+    }
+
+    /**
+     * Define (add) particular steps this activity can have
+     */
+    protected function define_my_steps() {
+        // Choice only has one structure step.
+        $this->add_step(new backup_lightboxgallery_activity_structure_step('lightboxgallery_structure', 'lightboxgallery.xml'));
+    }
+
+    /**
+     * Code the transformations to perform in the activity in
+     * order to get transportable (encoded) links
+     * @param string $content
+     * @return string
+     */
+    static public function encode_content_links($content) {
+        global $CFG;
+
+        $base = preg_quote($CFG->wwwroot, "/");
+
+        // Link to the list of pages.
+        $search = "/(".$base."\/mod\/lightboxgallery\/index.php\?id\=)([0-9]+)/";
+        $content = preg_replace($search, '$@LIGHTBOXGALLERYINDEX*$2@$', $content);
+
+        // Link to page view by moduleid.
+        $search = "/(".$base."\/mod\/lightboxgallery\/view.php\?id\=)([0-9]+)/";
+        $content = preg_replace($search, '$@LIGHTBOXGALLERYVIEWBYID*$2@$', $content);
+
+        return $content;
+    }
+}
diff --git a/mod/lightboxgallery/backup/moodle2/backup_lightboxgallery_stepslib.php b/mod/lightboxgallery/backup/moodle2/backup_lightboxgallery_stepslib.php
new file mode 100644
index 0000000..6a326be
--- /dev/null
+++ b/mod/lightboxgallery/backup/moodle2/backup_lightboxgallery_stepslib.php
@@ -0,0 +1,84 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * @package moodlecore
+ * @subpackage backup-moodle2
+ * @copyright 2010 onwards Eloy Lafuente (stronk7) {@link http://stronk7.com}
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * Define all the backup steps that will be used by the backup_lightboxgallery_activity_task
+ */
+
+/**
+ * Define the complete lightboxgallery structure for backup, with file and id annotations
+ */
+class backup_lightboxgallery_activity_structure_step extends backup_activity_structure_step {
+
+    protected function define_structure() {
+
+        // To know if we are including userinfo.
+        $userinfo = $this->get_setting_value('userinfo');
+
+        // Define each element separated.
+        $lightboxgallery = new backup_nested_element('lightboxgallery', array('id'), array(
+            'course', 'name', 'perpage', 'comments', 'extinfo',
+            'timemodified', 'ispublic', 'rss', 'autoresize', 'resize', 'perrow',
+            'captionfull', 'captionpos', 'intro', 'introformat'
+        ));
+
+        $comments = new backup_nested_element('usercomments');
+        $comment = new backup_nested_element('comment', array('id'), array(
+            'gallery', 'userid', 'commenttext', 'timemodified'
+        ));
+
+        $imagemetas = new backup_nested_element('image_metas');
+        $imagemeta = new backup_nested_element('image_meta', array('id'), array(
+            'gallery', 'image', 'description', 'metatype'
+        ));
+
+        // Build the tree.
+
+        $lightboxgallery->add_child($comments);
+        $comments->add_child($comment);
+        $lightboxgallery->add_child($imagemetas);
+        $imagemetas->add_child($imagemeta);
+
+        // Define sources.
+        $lightboxgallery->set_source_table('lightboxgallery', array('id' => backup::VAR_ACTIVITYID));
+        $imagemeta->set_source_table('lightboxgallery_image_meta', array('gallery' => backup::VAR_PARENTID));
+
+        // All the rest of elements only happen if we are including user info.
+        if ($userinfo) {
+            $comment->set_source_table('lightboxgallery_comments', array('gallery' => backup::VAR_PARENTID));
+        }
+
+        // Define file annotations.
+        $lightboxgallery->annotate_files('mod_lightboxgallery', 'gallery_images', null);
+        $lightboxgallery->annotate_files('mod_lightboxgallery', 'gallery_thumbs', null);
+        $lightboxgallery->annotate_files('mod_lightboxgallery', 'gallery_index', null);
+        $lightboxgallery->annotate_files('mod_lightboxgallery', 'intro', null);
+
+        $comment->annotate_ids('user', 'userid');
+
+        // Return the root element (lightboxgallery), wrapped into standard activity structure.
+        return $this->prepare_activity_structure($lightboxgallery);
+    }
+}
diff --git a/mod/lightboxgallery/backup/moodle2/restore_lightboxgallery_activity_task.class.php b/mod/lightboxgallery/backup/moodle2/restore_lightboxgallery_activity_task.class.php
new file mode 100644
index 0000000..d197513
--- /dev/null
+++ b/mod/lightboxgallery/backup/moodle2/restore_lightboxgallery_activity_task.class.php
@@ -0,0 +1,105 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * @package moodlecore
+ * @subpackage backup-moodle2
+ * @copyright 2010 onwards Eloy Lafuente (stronk7) {@link http://stronk7.com}
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+require_once($CFG->dirroot . '/mod/lightboxgallery/backup/moodle2/restore_lightboxgallery_stepslib.php');
+
+/**
+ * lightboxgallery restore task that provides all the settings and steps to perform one
+ * complete restore of the activity
+ */
+class restore_lightboxgallery_activity_task extends restore_activity_task {
+
+    /**
+     * Define (add) particular settings this activity can have
+     */
+    protected function define_my_settings() {
+        // No particular settings for this activity.
+    }
+
+    /**
+     * Define (add) particular steps this activity can have
+     */
+    protected function define_my_steps() {
+        // Choice only has one structure step.
+        $this->add_step(new restore_lightboxgallery_activity_structure_step('lightboxgallery_structure', 'lightboxgallery.xml'));
+    }
+
+    /**
+     * Define the contents in the activity that must be
+     * processed by the link decoder
+     */
+    static public function define_decode_contents() {
+        $contents = array();
+        return $contents;
+    }
+
+    /**
+     * Define the decoding rules for links belonging
+     * to the activity to be executed by the link decoder
+     */
+    static public function define_decode_rules() {
+        $rules = array();
+
+        $rules[] = new restore_decode_rule('LIGHTBOXGALLERYVIEWBYID', '/mod/lightboxgallery/view.php?id=$1', 'course_module');
+        $rules[] = new restore_decode_rule('LIGHTBOXGALLERYINDEX', '/mod/lightboxgallery/index.php?id=$1', 'course');
+
+        return $rules;
+
+    }
+
+    /**
+     * Define the restore log rules that will be applied
+     * by the {@link restore_logs_processor} when restoring
+     * page logs. It must return one array
+     * of {@link restore_log_rule} objects
+     */
+    static public function define_restore_log_rules() {
+        $rules = array();
+
+        $rules[] = new restore_log_rule('lightboxgallery', 'add', 'view.php?id={course_module}', '{page}');
+        $rules[] = new restore_log_rule('lightboxgallery', 'update', 'view.php?id={course_module}', '{page}');
+        $rules[] = new restore_log_rule('lightboxgallery', 'view', 'view.php?id={course_module}', '{page}');
+
+        return $rules;
+    }
+
+    /**
+     * Define the restore log rules that will be applied
+     * by the {@link restore_logs_processor} when restoring
+     * course logs. It must return one array
+     * of {@link restore_log_rule} objects
+     *
+     * Note this rules are applied when restoring course logs
+     * by the restore final task, but are defined here at
+     * activity level. All them are rules not linked to any module instance (cmid = 0)
+     */
+    static public function define_restore_log_rules_for_course() {
+        $rules = array();
+
+        $rules[] = new restore_log_rule('lightboxgallery', 'view all', 'index.php?id={course}', null);
+
+        return $rules;
+    }
+}
diff --git a/mod/lightboxgallery/backup/moodle2/restore_lightboxgallery_stepslib.php b/mod/lightboxgallery/backup/moodle2/restore_lightboxgallery_stepslib.php
new file mode 100644
index 0000000..5a29d44
--- /dev/null
+++ b/mod/lightboxgallery/backup/moodle2/restore_lightboxgallery_stepslib.php
@@ -0,0 +1,97 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * @package moodlecore
+ * @subpackage backup-moodle2
+ * @copyright 2010 onwards Eloy Lafuente (stronk7) {@link http://stronk7.com}
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * Define all the restore steps that will be used by the restore_lightboxgallery_activity_task
+ */
+
+/**
+ * Structure step to restore one lightboxgallery activity
+ */
+class restore_lightboxgallery_activity_structure_step extends restore_activity_structure_step {
+
+    protected function define_structure() {
+
+        $paths = array();
+        $userinfo = $this->get_setting_value('userinfo');
+
+        $lightboxgallery = new restore_path_element('lightboxgallery', '/activity/lightboxgallery');
+        $paths[] = $lightboxgallery;
+
+        $meta = new restore_path_element('lightboxgallery_image_meta', '/activity/lightboxgallery/image_metas/image_meta');
+        $paths[] = $meta;
+
+        if ($userinfo) {
+            $comment = new restore_path_element('lightboxgallery_comment', '/activity/lightboxgallery/usercomments/comment');
+            $paths[] = $comment;
+        }
+
+        // Return the paths wrapped into standard activity structure.
+        return $this->prepare_activity_structure($paths);
+    }
+
+    protected function process_lightboxgallery($data) {
+        global $DB;
+
+        $data = (object)$data;
+        $data->course = $this->get_courseid();
+        $data->timemodified = $this->apply_date_offset($data->timemodified);
+        // Insert the lightboxgallery record.
+        $newitemid = $DB->insert_record('lightboxgallery', $data);
+        // Immediately after inserting "activity" record, call this.
+        $this->apply_activity_instance($newitemid);
+    }
+
+    protected function process_lightboxgallery_comment($data) {
+        global $DB;
+
+        $data = (object)$data;
+
+        $data->gallery = $this->get_new_parentid('lightboxgallery');
+        $data->userid = $this->get_mappingid('user', $data->userid);
+        $data->timemodified = $this->apply_date_offset($data->timemodified);
+        if (isset($data->comment)) {
+            $data->commenttext = $data->comment;
+        }
+        $DB->insert_record('lightboxgallery_comments', $data);
+    }
+
+    protected function process_lightboxgallery_image_meta($data) {
+        global $DB;
+
+        $data = (object)$data;
+
+        $data->gallery = $this->get_new_parentid('lightboxgallery');
+        // TODO: image var to match image.
+        $DB->insert_record('lightboxgallery_image_meta', $data);
+    }
+
+    protected function after_execute() {
+        $this->add_related_files('mod_lightboxgallery', 'gallery_images', null);
+        $this->add_related_files('mod_lightboxgallery', 'gallery_thumbs', null);
+        $this->add_related_files('mod_lightboxgallery', 'gallery_index', null);
+        $this->add_related_files('mod_lightboxgallery', 'intro', null);
+    }
+}
diff --git a/mod/lightboxgallery/classes/event/course_module_instance_list_viewed.php b/mod/lightboxgallery/classes/event/course_module_instance_list_viewed.php
new file mode 100644
index 0000000..c74bc0d
--- /dev/null
+++ b/mod/lightboxgallery/classes/event/course_module_instance_list_viewed.php
@@ -0,0 +1,39 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * The mod_lightboxgallery instance list viewed event.
+ *
+ * @package    mod_lightboxgallery
+ * @copyright  2014 NetSpot Pty Ltd
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+namespace mod_lightboxgallery\event;
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * The mod_lightboxgallery instance list viewed event class.
+ *
+ * @package    mod_lightboxgallery
+ * @since      Moodle 2.7
+ * @copyright  2014 NetSpot Pty Ltd
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+class course_module_instance_list_viewed extends \core\event\course_module_instance_list_viewed {
+    // No code required here as the parent class handles it all.
+}
+
diff --git a/mod/lightboxgallery/classes/event/course_module_viewed.php b/mod/lightboxgallery/classes/event/course_module_viewed.php
new file mode 100644
index 0000000..7cb8027
--- /dev/null
+++ b/mod/lightboxgallery/classes/event/course_module_viewed.php
@@ -0,0 +1,77 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * The mod_quiz attempt viewed event.
+ *
+ * @package    mod_lightboxgallery
+ * @copyright  2014 NetSpot Pty Ltd
+ * @author     Adam Olley <adam.olley@netspot.com.au>
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+namespace mod_lightboxgallery\event;
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * The mod_lightboxgallery viewed event class.
+ *
+ * @property-read array $other {
+ *      Extra information about event.
+ *
+ *      - int lightboxgalleryid: the id of the quiz.
+ * }
+ *
+ * @package    mod_lightboxgallery
+ * @since      Moodle 2.7
+ * @copyright  2014 NetSpot Pty Ltd
+ * @author     Adam Olley <adam.olley@netspot.com.au>
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+class course_module_viewed extends \core\event\course_module_viewed {
+
+    /**
+     * Init method.
+     *
+     * @return void
+     */
+    protected function init() {
+        $this->data['crud'] = 'r';
+        $this->data['edulevel'] = self::LEVEL_PARTICIPATING;
+        $this->data['objecttable'] = 'lightboxgallery';
+    }
+
+    /**
+     * Get URL related to the action.
+     *
+     * @return \moodle_url
+     */
+    public function get_url() {
+        return new \moodle_url('/mod/lightboxgallery/view.php', array('l' => $this->objectid));
+    }
+
+    /**
+     * Return the legacy event log data.
+     *
+     * @return array|null
+     */
+    protected function get_legacy_logdata() {
+        return array($this->courseid, 'forum', 'view', 'view.php?l=' . $this->objectid,
+            $this->objectid, $this->contextinstanceid);
+    }
+
+}
diff --git a/mod/lightboxgallery/classes/event/gallery_comment_created.php b/mod/lightboxgallery/classes/event/gallery_comment_created.php
new file mode 100644
index 0000000..2d91286
--- /dev/null
+++ b/mod/lightboxgallery/classes/event/gallery_comment_created.php
@@ -0,0 +1,108 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * The mod_lightboxgallery post updated event.
+ *
+ * @package    mod_lightboxgallery
+ * @copyright  2014 NetSpot Pty Ltd
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+namespace mod_lightboxgallery\event;
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * The mod_lightboxgallery image updated event class.
+ *
+ * @property-read array $other {
+ *      Extra information about the event.
+ *
+ *      - int lightboxgalleryid: instance id of the lightbox gallery.
+ * }
+ *
+ * @package    mod_lightboxgallery
+ * @since      Moodle 2.7
+ * @copyright  2014 NetSpot Pty Ltd
+ * @author     Adam Olley <adam.olley@netspot.com.au>
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+class gallery_comment_created extends \core\event\base {
+    /**
+     * Init method.
+     *
+     * @return void
+     */
+    protected function init() {
+        $this->data['crud'] = 'c';
+        $this->data['edulevel'] = self::LEVEL_PARTICIPATING;
+    }
+
+    /**
+     * Returns description of what happened.
+     *
+     * @return string
+     */
+    public function get_description() {
+        return "The user with id '$this->userid' has created a comment " .
+            " in the lightboxgallery with the course module id '$this->contextinstanceid'.";
+    }
+
+    /**
+     * Return localised event name.
+     *
+     * @return string
+     */
+    public static function get_name() {
+        return get_string('eventgallerycommentcreated', 'mod_lightboxgallery');
+    }
+
+    /**
+     * Get URL related to the action
+     *
+     * @return \moodle_url
+     */
+    public function get_url() {
+        $url = new \moodle_url('/mod/lightboxgallery/view.php', array('id' => $this->contextinstanceid));
+        return $url;
+    }
+
+    /**
+     * Return the legacy event log data.
+     *
+     * @return array|null
+     */
+    protected function get_legacy_logdata() {
+        // The legacy log table expects a relative path to /mod/lightboxgallery/.
+        $logurl = new \moodle_url('/mod/lightboxgallery/view.php', array('id' => $this->contextinstanceid));
+        return array($this->courseid, 'lightboxgallery', 'editimage',
+            $logurl, $this->other['lightboxgalleryid'], $this->contextinstanceid);
+    }
+
+    /**
+     * Custom validation.
+     *
+     * @throws \coding_exception
+     * @return void
+     */
+    protected function validate_data() {
+        parent::validate_data();
+        if ($this->contextlevel != CONTEXT_MODULE) {
+            throw new \coding_exception('Context level must be CONTEXT_MODULE.');
+        }
+    }
+}
diff --git a/mod/lightboxgallery/classes/event/gallery_searched.php b/mod/lightboxgallery/classes/event/gallery_searched.php
new file mode 100644
index 0000000..f237520
--- /dev/null
+++ b/mod/lightboxgallery/classes/event/gallery_searched.php
@@ -0,0 +1,116 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * The mod_lightboxgallery course searched event.
+ *
+ * @package    mod_lightboxgallery
+ * @copyright  2014 NetSpot Pty Ltd
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+namespace mod_lightboxgallery\event;
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * The mod_lightboxgallery gallery searched event class.
+ *
+ * @property-read array $other {
+ *      Extra information about the event.
+ *
+ *      - string searchterm: The searchterm used on lightboxgallery search.
+ *      - int lightboxgalleryid: The lbg instance id.
+ * }
+ *
+ * @package    mod_lightboxgallery
+ * @since      Moodle 2.7
+ * @copyright  2014 NetSpot Pty Ltd
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+class gallery_searched extends \core\event\base {
+
+    /**
+     * Init method.
+     *
+     * @return void
+     */
+    protected function init() {
+        $this->data['crud'] = 'r';
+        $this->data['edulevel'] = self::LEVEL_PARTICIPATING;
+    }
+
+    /**
+     * Returns description of what happened.
+     *
+     * @return string
+     */
+    public function get_description() {
+        $searchterm = s($this->other['searchterm']);
+        return "The user with id '$this->userid' has searched the lightboxgallery with id '{$this->other['lightboxgalleryid']}'".
+            " for lightboxgallery images containing \"{$searchterm}\".";
+    }
+
+    /**
+     * Return localised event name.
+     *
+     * @return string
+     */
+    public static function get_name() {
+        return get_string('eventgallerysearched', 'mod_lightboxgallery');
+    }
+
+    /**
+     * Get URL related to the action
+     *
+     * @return \moodle_url
+     */
+    public function get_url() {
+        return new \moodle_url('/mod/lightboxgallery/search.php',
+            array('id' => $this->courseid, 'gallery' => $this->other['lightboxgalleryid'], 'search' => $this->other['searchterm']));
+    }
+
+    /**
+     * Return the legacy event log data.
+     *
+     * @return array|null
+     */
+    protected function get_legacy_logdata() {
+        // The legacy log table expects a relative path to /mod/lightboxgallery/.
+        $logurl = substr($this->get_url()->out_as_local_url(), strlen('/mod/lightboxgallery/'));
+
+        return array($this->courseid, 'lightboxgallery', 'search', $logurl, $this->other['searchterm']);
+    }
+
+    /**
+     * Custom validation.
+     *
+     * @throws \coding_exception
+     * @return void
+     */
+    protected function validate_data() {
+        parent::validate_data();
+        if (!isset($this->other['searchterm'])) {
+            throw new \coding_exception('The \'searchterm\' value must be set in other.');
+        }
+
+        if ($this->contextlevel != CONTEXT_MODULE) {
+            throw new \coding_exception('Context level must be CONTEXT_MODULE.');
+        }
+    }
+
+}
+
diff --git a/mod/lightboxgallery/classes/event/image_updated.php b/mod/lightboxgallery/classes/event/image_updated.php
new file mode 100644
index 0000000..75fd3d2
--- /dev/null
+++ b/mod/lightboxgallery/classes/event/image_updated.php
@@ -0,0 +1,101 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * The mod_lightboxgallery post updated event.
+ *
+ * @package    mod_lightboxgallery
+ * @copyright  2014 NetSpot Pty Ltd
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+namespace mod_lightboxgallery\event;
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * The mod_lightboxgallery image updated event class.
+ *
+ * @property-read array $other {
+ *      Extra information about the event.
+ *
+ *      - string imagename: The name of the image.
+ *      - string tab: The editing mode that was used.
+ * }
+ *
+ * @package    mod_lightboxgallery
+ * @since      Moodle 2.7
+ * @copyright  2014 NetSpot Pty Ltd
+ * @author     Adam Olley <adam.olley@netspot.com.au>
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+class image_updated extends \core\event\base {
+    /**
+     * Init method.
+     *
+     * @return void
+     */
+    protected function init() {
+        $this->data['crud'] = 'u';
+        $this->data['edulevel'] = self::LEVEL_PARTICIPATING;
+    }
+
+    /**
+     * Returns description of what happened.
+     *
+     * @return string
+     */
+    public function get_description() {
+        return "The user with id '$this->userid' has updated the image with name '{$this->other['imagename']}' " .
+            " in the lightboxgallery with the course module id '$this->contextinstanceid'.";
+    }
+
+    /**
+     * Return localised event name.
+     *
+     * @return string
+     */
+    public static function get_name() {
+        return get_string('eventimageupdated', 'mod_lightboxgallery');
+    }
+
+    /**
+     * Get URL related to the action
+     *
+     * @return \moodle_url
+     */
+    public function get_url() {
+        $params = array(
+            'id' => $this->contextinstanceid,
+            'image' => $this->other['imagename'],
+            'tab' => $this->other['tab'],
+        );
+        $url = new \moodle_url('/mod/lightboxgallery/imageedit.php', $params);
+        return $url;
+    }
+
+    /**
+     * Return the legacy event log data.
+     *
+     * @return array|null
+     */
+    protected function get_legacy_logdata() {
+        // The legacy log table expects a relative path to /mod/lightboxgallery/.
+        $logurl = 'view.php?id='.$this->contextinstanceid;
+        return array($this->courseid, 'lightboxgallery', 'editimage', $logurl,
+            $this->other['tab'].' '.$this->other['imagename'], $this->contextinstanceid, $this->userid);
+    }
+}
diff --git a/mod/lightboxgallery/classes/search/activity.php b/mod/lightboxgallery/classes/search/activity.php
new file mode 100644
index 0000000..5adff14
--- /dev/null
+++ b/mod/lightboxgallery/classes/search/activity.php
@@ -0,0 +1,37 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Search area for mod_lightboxgallery activities.
+ *
+ * @package   mod_lightboxgallery
+ * @copyright Copyright (c) 2017 Blackboard Inc.
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+namespace mod_lightboxgallery\search;
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * Search area for mod_lightboxgallery activities.
+ *
+ * @package   mod_lightboxgallery
+ * @copyright Copyright (c) 2017 Blackboard Inc.
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+class activity extends \core_search\base_activity {
+}
diff --git a/mod/lightboxgallery/comment.php b/mod/lightboxgallery/comment.php
new file mode 100644
index 0000000..de5b820
--- /dev/null
+++ b/mod/lightboxgallery/comment.php
@@ -0,0 +1,100 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+require_once(dirname(dirname(dirname(__FILE__))).'/config.php');
+require_once(dirname(__FILE__).'/locallib.php');
+require_once(dirname(__FILE__).'/comment_form.php');
+
+$id      = required_param('id', PARAM_INT);
+$delete  = optional_param('delete', 0, PARAM_INT);
+$confirm = optional_param('confirm', 0, PARAM_INT);
+
+if (!$gallery = $DB->get_record('lightboxgallery', array('id' => $id))) {
+    print_error('invalidlightboxgalleryid', 'lightboxgallery');
+}
+list($course, $cm) = get_course_and_cm_from_instance($gallery, 'lightboxgallery');
+
+if ($delete && ! $comment = $DB->get_record('lightboxgallery_comments', array('gallery' => $gallery->id, 'id' => $delete))) {
+    print_error('Invalid comment ID');
+}
+
+require_login($course, true, $cm);
+
+$PAGE->set_cm($cm);
+$PAGE->set_url('/mod/lightboxgallery/view.php', array('id' => $id));
+$PAGE->set_title($gallery->name);
+$PAGE->set_heading($course->shortname);
+
+$context = context_module::instance($cm->id);
+
+$galleryurl = $CFG->wwwroot.'/mod/lightboxgallery/view.php?id='.$cm->id;
+
+if ($delete && has_capability('mod/lightboxgallery:edit', $context)) {
+    if ($confirm && confirm_sesskey()) {
+        $DB->delete_records('lightboxgallery_comments', array('id' => $comment->id));
+        redirect($galleryurl);
+    } else {
+        echo $OUTPUT->header();
+        lightboxgallery_print_comment($comment, $context);
+        echo('<br />');
+        $paramsyes = array('id' => $gallery->id, 'delete' => $comment->id, 'sesskey' => sesskey(), 'confirm' => 1);
+        $paramsno = array('id' => $cm->id);
+        echo $OUTPUT->confirm(get_string('commentdelete', 'lightboxgallery'),
+                              new moodle_url('/mod/lightboxgallery/comment.php', $paramsyes),
+                              new moodle_url('/mod/lightboxgallery/view.php', $paramsno));
+        echo $OUTPUT->footer();
+        die();
+    }
+}
+
+require_capability('mod/lightboxgallery:addcomment', $context);
+
+if (! $gallery->comments) {
+    print_error('Comments disabled', $galleryurl);
+}
+
+$mform = new mod_lightboxgallery_comment_form(null, $gallery);
+
+if ($mform->is_cancelled()) {
+    redirect($galleryurl);
+} else if ($formadata = $mform->get_data()) {
+    $newcomment = new stdClass;
+    $newcomment->gallery = $gallery->id;
+    $newcomment->userid = $USER->id;
+    $newcomment->commenttext = $formadata->comment['text'];
+    $newcomment->timemodified = time();
+    if ($DB->insert_record('lightboxgallery_comments', $newcomment)) {
+        $params = array(
+            'context' => $context,
+            'other' => array(
+                'lightboxgalleryid' => $gallery->id,
+            ),
+        );
+        $event = \mod_lightboxgallery\event\gallery_comment_created::create($params);
+        $event->trigger();
+
+        redirect($galleryurl, get_string('commentadded', 'lightboxgallery'));
+    } else {
+        print_error('Comment creation failed');
+    }
+}
+
+
+echo $OUTPUT->header();
+
+$mform->display();
+
+echo $OUTPUT->footer();
diff --git a/mod/lightboxgallery/comment_form.php b/mod/lightboxgallery/comment_form.php
new file mode 100644
index 0000000..0e46dd1
--- /dev/null
+++ b/mod/lightboxgallery/comment_form.php
@@ -0,0 +1,50 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+
+/**
+ * Form for adding comments on a gallery
+ *
+ * @package   mod_lightboxgallery
+ * @copyright 2010 John Kelsh
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+require_once($CFG->libdir.'/formslib.php');
+
+class mod_lightboxgallery_comment_form extends moodleform {
+
+    public function definition() {
+
+        $mform =& $this->_form;
+        $gallery = $this->_customdata;
+
+        $straddcomment = get_string('addcomment', 'lightboxgallery');
+
+        $mform->addElement('editor', 'comment', $straddcomment, array('cols' => 85, 'rows' => 18));
+        $mform->addRule('comment', get_string('required'), 'required', null, 'client');
+        $mform->setType('comment', PARAM_RAW);
+
+        $mform->addElement('hidden', 'id', 0);
+        $mform->setDefault('id', $gallery->id);
+        $mform->setType('id', PARAM_INT);
+
+        $this->add_action_buttons(true, $straddcomment);
+
+    }
+}
diff --git a/mod/lightboxgallery/composer.json b/mod/lightboxgallery/composer.json
new file mode 100644
index 0000000..110182d
--- /dev/null
+++ b/mod/lightboxgallery/composer.json
@@ -0,0 +1,17 @@
+{
+    "name": "netspotau/moodle-mod_lightboxgallery",
+    "type": "moodle-mod",
+    "description": "Lightbox gallery activity for Moodle",
+    "homepage": "https://github.com/netspotau/moodle-mod_lightboxgallery",
+    "license": "GPL-3.0+",
+    "require": {
+        "composer/installers": "*"
+    },
+    "extra": {
+        "installer-name": "lightboxgallery"
+    },
+    "support": {
+        "issues": "https://github.com/netspotau/moodle-mod_lightboxgallery/issues",
+        "source": "https://github.com/netspotau/moodle-mod_lightboxgallery"
+    }
+}
diff --git a/mod/lightboxgallery/db/access.php b/mod/lightboxgallery/db/access.php
new file mode 100644
index 0000000..2b8ca51
--- /dev/null
+++ b/mod/lightboxgallery/db/access.php
@@ -0,0 +1,120 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+
+/**
+ * Capability definitions for the lightboxgallery module
+ *
+ * The capabilities are loaded into the database table when the module is
+ * installed or updated. Whenever the capability definitions are updated,
+ * the module version number should be bumped up.
+ *
+ * The system has four possible values for a capability:
+ * CAP_ALLOW, CAP_PREVENT, CAP_PROHIBIT, and inherit (not set).
+ *
+ * It is important that capability names are unique. The naming convention
+ * for capabilities that are specific to modules and blocks is as follows:
+ *   [mod/block]/<plugin_name>:<capabilityname>
+ *
+ * component_name should be the same as the directory name of the mod or block.
+ *
+ * Core moodle capabilities are defined thus:
+ *    moodle/<capabilityclass>:<capabilityname>
+ *
+ * Examples: mod/forum:viewpost
+ *           block/recent_activity:view
+ *           moodle/site:deleteuser
+ *
+ * The variable name for the capability definitions array is $capabilities
+ *
+ * @package   mod_lightboxgallery
+ * @copyright 2011 John Kelsh
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+$capabilities = array(
+
+    'mod/lightboxgallery:addcomment' => array(
+        'riskbitmask' => RISK_SPAM,
+        'captype' => 'write',
+        'contextlevel' => CONTEXT_MODULE,
+        'legacy' => array(
+            'guest' => CAP_ALLOW,
+            'student' => CAP_ALLOW,
+            'teacher' => CAP_ALLOW,
+            'editingteacher' => CAP_ALLOW,
+            'manager' => CAP_ALLOW
+        )
+    ),
+
+    'mod/lightboxgallery:addinstance' => array(
+        'riskbitmask' => RISK_XSS,
+        'captype' => 'write',
+        'contextlevel' => CONTEXT_COURSE,
+        'archetypes' => array(
+            'editingteacher' => CAP_ALLOW,
+            'manager' => CAP_ALLOW
+        ),
+        'clonepermissionsfrom' => 'moodle/course:manageactivities'
+    ),
+
+    'mod/lightboxgallery:submit' => array(
+        'riskbitmask' => RISK_SPAM,
+        'captype' => 'write',
+        'contextlevel' => CONTEXT_MODULE,
+        'legacy' => array(
+            'student' => CAP_ALLOW,
+            'teacher' => CAP_ALLOW,
+            'editingteacher' => CAP_ALLOW,
+            'manager' => CAP_ALLOW
+        )
+    ),
+
+    'mod/lightboxgallery:addimage' => array(
+        'riskbitmask' => RISK_SPAM | RISK_XSS,
+        'captype' => 'write',
+        'contextlevel' => CONTEXT_MODULE,
+        'legacy' => array(
+            'editingteacher' => CAP_ALLOW,
+            'manager' => CAP_ALLOW
+        )
+    ),
+
+    'mod/lightboxgallery:edit' => array(
+        'riskbitmask' => RISK_SPAM | RISK_XSS,
+        'captype' => 'write',
+        'contextlevel' => CONTEXT_MODULE,
+        'legacy' => array(
+            'editingteacher' => CAP_ALLOW,
+            'manager' => CAP_ALLOW
+        )
+    ),
+
+    'mod/lightboxgallery:viewcomments' => array(
+        'captype' => 'read',
+        'contextlevel' => CONTEXT_MODULE,
+        'legacy' => array(
+            'guest' => CAP_ALLOW,
+            'student' => CAP_ALLOW,
+            'teacher' => CAP_ALLOW,
+            'editingteacher' => CAP_ALLOW,
+            'manager' => CAP_ALLOW
+        )
+    )
+
+);
diff --git a/mod/lightboxgallery/db/install.xml b/mod/lightboxgallery/db/install.xml
new file mode 100644
index 0000000..701c32c
--- /dev/null
+++ b/mod/lightboxgallery/db/install.xml
@@ -0,0 +1,64 @@
+<?xml version="1.0" encoding="UTF-8" ?>
+<XMLDB PATH="mod/lightboxgallery/db" VERSION="20071114" COMMENT="XMLDB file for Moodle mod/lightboxgallery"
+    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+    xsi:noNamespaceSchemaLocation="../../../lib/xmldb/xmldb.xsd"
+>
+  <TABLES>
+    <TABLE NAME="lightboxgallery" COMMENT="Defines lightboxgallery activities">
+      <FIELDS>
+        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
+        <FIELD NAME="course" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="name" TYPE="char" LENGTH="255" NOTNULL="true" SEQUENCE="false"/>
+        <FIELD NAME="perpage" TYPE="int" LENGTH="3" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="perrow" TYPE="int" LENGTH="2" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="comments" TYPE="int" LENGTH="1" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="ispublic" TYPE="int" LENGTH="1" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="rss" TYPE="int" LENGTH="1" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="autoresize" TYPE="int" LENGTH="1" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="resize" TYPE="int" LENGTH="1" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="extinfo" TYPE="int" LENGTH="1" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="captionfull" TYPE="int" LENGTH="1" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="captionpos" TYPE="int" LENGTH="1" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="intro" TYPE="text" NOTNULL="false" SEQUENCE="false"/>
+        <FIELD NAME="introformat" TYPE="int" LENGTH="4" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="timemodified" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+      </FIELDS>
+      <KEYS>
+        <KEY NAME="primary" TYPE="primary" FIELDS="id" COMMENT="Primary key for lightbox gallery"/>
+      </KEYS>
+      <INDEXES>
+        <INDEX NAME="course" UNIQUE="false" FIELDS="course"/>
+      </INDEXES>
+    </TABLE>
+    <TABLE NAME="lightboxgallery_comments" COMMENT="Contains comments attached to lightboxgallery resources">
+      <FIELDS>
+        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
+        <FIELD NAME="gallery" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="userid" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="commenttext" TYPE="text" NOTNULL="true" SEQUENCE="false"/>
+        <FIELD NAME="timemodified" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+      </FIELDS>
+      <KEYS>
+        <KEY NAME="primary" TYPE="primary" FIELDS="id" COMMENT="Primary key for lightbox gallery comments"/>
+      </KEYS>
+      <INDEXES>
+        <INDEX NAME="gallery" UNIQUE="false" FIELDS="gallery"/>
+      </INDEXES>
+    </TABLE>
+    <TABLE NAME="lightboxgallery_image_meta" COMMENT="Meta data linked to gallery images">
+      <FIELDS>
+        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
+        <FIELD NAME="gallery" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="image" TYPE="char" LENGTH="255" NOTNULL="true" SEQUENCE="false"/>
+        <FIELD NAME="metatype" TYPE="char" LENGTH="20" NOTNULL="true" DEFAULT="caption" SEQUENCE="false"/>
+        <FIELD NAME="description" TYPE="text" NOTNULL="true" SEQUENCE="false"/>
+      </FIELDS>
+      <KEYS>
+        <KEY NAME="primary" TYPE="primary" FIELDS="id" COMMENT="Primary key for lightbox gallery captions"/>
+      </KEYS>
+      <INDEXES>
+        <INDEX NAME="gallery" UNIQUE="false" FIELDS="gallery"/>
+      </INDEXES>
+    </TABLE>
+  </TABLES>
+</XMLDB>
diff --git a/mod/lightboxgallery/db/log.php b/mod/lightboxgallery/db/log.php
new file mode 100644
index 0000000..b60e1dc
--- /dev/null
+++ b/mod/lightboxgallery/db/log.php
@@ -0,0 +1,36 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Definition of log events
+ * NOTE: this is an example how to insert log event during installation/update.
+ * It is not really essential to know about it, but these logs were created as example
+ * in the previous 1.9 NEWMODULE.
+ *
+ * @package   mod_lightboxgallery
+ * @copyright 2011 John Kelsh
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+global $DB;
+
+$logs = array(
+    array('module' => 'lightboxgallery', 'action' => 'update', 'mtable' => 'lightboxgallery', 'field' => 'name'),
+    array('module' => 'lightboxgallery', 'action' => 'view', 'mtable' => 'lightboxgallery', 'field' => 'name'),
+    array('module' => 'lightboxgallery', 'action' => 'comment', 'mtable' => 'lightboxgallery', 'field' => 'name')
+);
diff --git a/mod/lightboxgallery/db/upgrade.php b/mod/lightboxgallery/db/upgrade.php
new file mode 100644
index 0000000..794adfc
--- /dev/null
+++ b/mod/lightboxgallery/db/upgrade.php
@@ -0,0 +1,280 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+
+/**
+ * This file keeps track of upgrades to the lightboxgallery module
+ *
+ * Sometimes, changes between versions involve alterations to database
+ * structures and other major things that may break installations. The upgrade
+ * function in this file will attempt to perform all the necessary actions to
+ * upgrade your older installation to the current version. If there's something
+ * it cannot do itself, it will tell you what you need to do.  The commands in
+ * here will all be database-neutral, using the functions defined in DLL libraries.
+ *
+ * @package   mod_lightboxgallery
+ * @copyright 2011 John Kelsh
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * xmldb_lightboxgallery_upgrade
+ *
+ * @param int $oldversion
+ * @return bool
+ */
+
+function xmldb_lightboxgallery_upgrade($oldversion=0) {
+
+    global $DB;
+
+    $dbman = $DB->get_manager();
+
+    if ($oldversion < 2007111400) {
+        $table = new xmdbl_table('lightboxgallery');
+
+        // Add perpage field.
+        $field = new xmldb_field('perpage', XMLDB_TYPE_INTEGER, '3', XMLDB_UNSIGNED, XMLDB_NOTNULL, null, '0', 'description');
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+
+        // Add comments field.
+        $field = new xmldb_field('comments', XMLDB_TYPE_INTEGER, '1', XMLDB_UNSIGNED, XMLDB_NOTNULL, null, '0', 'perpage');
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+
+        // Create new lightboxgallery_comments table.
+        $table = new xmldb_table('lightboxgallery_comments');
+
+        if (!$dbman->table_exists($table)) {
+            $field = new xmldb_field('id', XMLDB_TYPE_INTEGER, '10', XMLDB_UNSIGNED, XMLDB_NOTNULL, XMLDB_SEQUENCE, null);
+            $table->addField($field);
+
+            $field = new xmldb_field('gallery', XMLDB_TYPE_INTEGER, '10', XMLDB_UNSIGNED, XMLDB_NOTNULL, null, '0');
+            $table->addField($field);
+
+            $field = new xmldb_field('user', XMLDB_TYPE_INTEGER, '10', XMLDB_UNSIGNED, XMLDB_NOTNULL, null, '0');
+            $table->addField($field);
+
+            $field = new xmldb_field('comment', XMLDB_TYPE_TEXT, 'small', null, XMLDB_NOTNULL, null, null);
+            $table->addField($field);
+
+            $field = new xmldb_field('timemodified', XMLDB_TYPE_INTEGER, '10', XMLDB_UNSIGNED, XMLDB_NOTNULL, null, '0');
+            $table->addField($field);
+
+            $key = new xmldb_key('primary', XMLDB_KEY_PRIMARY, array('id'));
+            $table->addKey($key);
+
+            $table->add_index('gallery', XMLDB_INDEX_NOTUNIQUE, array('gallery'));
+
+            $dbman->create_table($table);
+        }
+        upgrade_mod_savepoint(true, 2007111400, 'lightboxgallery');
+    }
+
+    if ($oldversion < 2007121700) {
+        $table = new xmldb_table('lightboxgallery');
+
+        // Insert extinfo field into lightboxgallery.
+        $field = new xmldb_field('extinfo', XMLDB_TYPE_INTEGER, '1', XMLDB_UNSIGNED, XMLDB_NOTNULL, null, '0', 'comments');
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+
+        // Create lightboxgallery_captions table.
+        $table = new xmldb_table('lightboxgallery_captions');
+
+        if (!$dbman->table_exists($table)) {
+            $field = new xmldb_field('id', XMLDB_TYPE_INTEGER, '10', XMLDB_UNSIGNED, XMLDB_NOTNULL, XMLDB_SEQUENCE, null);
+            $table->addField($field);
+
+            $field = new xmldb_field('gallery', XMLDB_TYPE_INTEGER, '10', XMLDB_UNSIGNED, XMLDB_NOTNULL, null, '0');
+            $table->addField($field);
+
+            $field = new xmldb_field('image', XMLDB_TYPE_CHAR, '255', null, XMLDB_NOTNULL, null, null);
+            $table->addField($field);
+
+            $field = new xmldb_field('caption', XMLDB_TYPE_TEXT, 'small', null, XMLDB_NOTNULL, null, null);
+            $table->addField($field);
+
+            $key = new xmldb_key('primary', XMLDB_KEY_PRIMARY, array('id'));
+            $table->addKey($key);
+
+            $table->add_index('gallery', XMLDB_INDEX_NOTUNIQUE, array('gallery'));
+
+            $dbman->create_table($table);
+        }
+        upgrade_mod_savepoint(true, 2007121700, 'lightboxgallery');
+    }
+
+    if ($oldversion < 2008110600) {
+        $table = new xmldb_table('lightboxgallery');
+
+        // Insert public, rss, autoresize, resize fields into lightboxgallery.
+        $newfields = array('public', 'rss', 'autoresize', 'resize');
+        $previousfield = 'comments';
+        foreach ($newfields as $newfield) {
+            $field = new xmldb_field($newfield, XMLDB_TYPE_INTEGER, '1', XMLDB_UNSIGNED, XMLDB_NOTNULL, null, '0', $previousfield);
+            if (!$dbman->field_exists($table, $field)) {
+                $dbman->add_field($table, $field);
+                $previousfield = $newfield;
+            }
+        }
+
+        $table = new xmldb_table('lightboxgallery_comments');
+
+        // Rename user field to userid in lightboxgallery_comments (for postgres).
+        $field = new xmldb_field('user', XMLDB_TYPE_INTEGER, '10', XMLDB_UNSIGNED, XMLDB_NOTNULL, null, '0');
+        if ($dbman->field_exists($table, $field)) {
+            $dbman->rename_field($table, $field, 'userid');
+        }
+
+        $table = new xmldb_table('lightboxgallery_captions');
+
+        // Rename caption field to description and insert metatype field in lightboxgallery_captions.
+        $field = new xmldb_field('caption', XMLDB_TYPE_TEXT, 'small', null, XMLDB_NOTNULL, null, null, 'image');
+        if ($dbman->field_exists($table, $field)) {
+            $dbman->rename_field($table, $field, 'description');
+        }
+
+        $field = new xmldb_field('metatype',
+                                 XMLDB_TYPE_CHAR, '20', null, XMLDB_NOTNULL, array('caption', 'tag'), 'caption', 'image');
+        if ($dbman->table_exists($table) && !$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+
+        // Rename table lightboxgallery_captions to lightboxgallery_image_meta.
+        $dbman->rename_table($table, 'lightboxgallery_image_meta');
+        upgrade_mod_savepoint(true, 2008110600, 'lightboxgallery');
+    }
+
+    if ($oldversion < 2009051200) {
+        $table = new xmldb_table('lightboxgallery');
+
+        // Rename public field to ispublic in lightboxgallery (for mssql).
+        $field = new xmldb_field('public', XMLDB_TYPE_INTEGER, '1', XMLDB_UNSIGNED, XMLDB_NOTNULL, null, '0', 'comments');
+        if ($dbman->field_exists($table, $field)) {
+            $dbman->rename_field($table, $field, 'ispublic');
+        }
+        upgrade_mod_savepoint(true, 2009051200, 'lightboxgallery');
+    }
+
+    if ($oldversion < 2011040800) {
+        $table = new xmldb_table('lightboxgallery');
+
+        // Add perpage field.
+        $field = new xmldb_field('perrow', XMLDB_TYPE_INTEGER, '1', XMLDB_UNSIGNED, XMLDB_NOTNULL, null, '4', 'perpage');
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+
+        // File migration, add entries in file table that points at the legacy files.
+        // Get list of files based on path.
+        if ($galleries = $DB->get_records('lightboxgallery')) {
+            foreach ($galleries as $gallery) {
+                if (!$cm = get_coursemodule_from_instance('lightboxgallery', $gallery->id, $gallery->course, false)) {
+                    continue;
+                }
+                $context = context_module::instance($cm->id);
+                $coursecontext = context_course::instance($gallery->course);
+
+                // Add files to lightbox area, iterate over the legacy files.
+                $fs = get_file_storage();
+                if ($storedfiles = $fs->get_area_files($coursecontext->id, 'course', 'legacy')) {
+                    foreach ($storedfiles as $file) {
+                        $path = '/'.$gallery->folder;
+                        if ($gallery->folder != '') {
+                            $path .= '/';
+                        }
+                        if (substr($file->get_mimetype(), 0, 6) != 'image/' ||
+                            substr($file->get_filepath(), -8, 8) == '/_thumb/' ||
+                            $file->get_filepath() != $path) {
+                            continue;
+                        }
+                        // Insert as lightbox file.
+                        $settings = new stdClass();
+                        $settings->contextid = $context->id;
+                        $settings->component = 'mod_lightboxgallery';
+                        $settings->filearea = 'gallery_images';
+                        $settings->filepath = '/';
+                        $fs->create_file_from_storedfile($settings, $file);
+                    }
+                }
+            }
+        }
+        upgrade_mod_savepoint(true, 2011040800, 'lightboxgallery');
+    }
+
+    if ($oldversion < 2011071100) {
+        // Switch out gallery description field for standard introeditor.
+        $table = new xmldb_table('lightboxgallery');
+
+        $field = new xmldb_field('description', XMLDB_TYPE_TEXT, 'small', null, null, null, null, 'extinfo');
+        if ($dbman->field_exists($table, $field)) {
+            $dbman->rename_field($table, $field, 'intro');
+        }
+
+        $field = new xmldb_field('introformat', XMLDB_TYPE_INTEGER, '4', XMLDB_UNSIGNED, XMLDB_NOTNULL, null, '0', 'intro');
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+
+        upgrade_mod_savepoint(true, 2011071100, 'lightboxgallery');
+    }
+
+    if ($oldversion < 2011111600) {
+        $table = new xmldb_table('lightboxgallery');
+
+        $field = new xmldb_field('captionfull', XMLDB_TYPE_INTEGER, '1', XMLDB_UNSIGNED, XMLDB_NOTNULL, null, '0', 'extinfo');
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field, 'extinfo');
+        }
+
+        $field = new xmldb_field('captionpos', XMLDB_TYPE_INTEGER, '1', XMLDB_UNSIGNED, XMLDB_NOTNULL, null, '0', 'captionfull');
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field, 'captionfull');
+        }
+
+        upgrade_mod_savepoint(true, 2011111600, 'lightboxgallery');
+    }
+
+    if ($oldversion < 2013051300) {
+        $table = new xmldb_table('lightboxgallery_comments');
+
+        $field = new xmldb_field('comment', XMLDB_TYPE_TEXT, null, null, null, null, null, 'userid');
+        if ($dbman->field_exists($table, $field)) {
+            $dbman->rename_field($table, $field, 'commenttext');
+        }
+
+        upgrade_mod_savepoint(true, 2013051300, 'lightboxgallery');
+    }
+
+    if ($oldversion < 2017070700) {
+        $table = new xmldb_table('lightboxgallery');
+        $field = new xmldb_field('folder');
+        if ($dbman->field_exists($table, $field)) {
+            $dbman->drop_field($table, $field);
+        }
+
+        upgrade_mod_savepoint(true, 2017070700, 'lightboxgallery');
+    }
+
+    return true;
+}
diff --git a/mod/lightboxgallery/edit/base.class.php b/mod/lightboxgallery/edit/base.class.php
new file mode 100644
index 0000000..c4697da
--- /dev/null
+++ b/mod/lightboxgallery/edit/base.class.php
@@ -0,0 +1,72 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * Base class to be extended for edit plugins
+ *
+ * @package   mod_lighboxgallery
+ * @copyright 2010 John Kelsh
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+class edit_base {
+
+    public $imageobj;
+
+    public $gallery;
+    public $image;
+    public $tab;
+    public $showthumb;
+    public $context;
+
+    public function __construct($gallery, $cm, $image, $tab, $showthumb = true) {
+        global $CFG;
+
+        $this->gallery = $gallery;
+        $this->cm = $cm;
+        $this->image = $image;
+        $this->tab = $tab;
+        $this->showthumb = $showthumb;
+        $this->context = context_module::instance($this->cm->id);
+    }
+
+    public function processing() {
+        return optional_param('process', false, PARAM_BOOL);
+    }
+
+    public function enclose_in_form($text) {
+        global $CFG, $USER;
+
+        return '<form action="'.$CFG->wwwroot.'/mod/lightboxgallery/imageedit.php" method="post">'.
+               '<fieldset class="invisiblefieldset">'.
+               '<input type="hidden" name="sesskey" value="'.$USER->sesskey.'" />'.
+               '<input type="hidden" name="id" value="'.$this->cm->id.'" />'.
+               '<input type="hidden" name="image" value="'.$this->image.'" />'.
+               '<input type="hidden" name="tab" value="'.$this->tab.'" />'.
+               '<input type="hidden" name="process" value="1" />'.$text.'</fieldset></form>';
+    }
+
+    public function output() {
+
+    }
+
+    public function process_form() {
+
+    }
+
+}
diff --git a/mod/lightboxgallery/edit/caption/caption.class.php b/mod/lightboxgallery/edit/caption/caption.class.php
new file mode 100644
index 0000000..34ca3ff
--- /dev/null
+++ b/mod/lightboxgallery/edit/caption/caption.class.php
@@ -0,0 +1,41 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+defined('MOODLE_INTERNAL') || die();
+
+class edit_caption extends edit_base {
+
+    public function __construct($gallery, $cm, $image, $tab) {
+        parent::__construct($gallery, $cm, $image, $tab, true);
+    }
+
+    public function output($captiontext = '') {
+        $result = '<textarea name="caption" cols="24" rows="4">'.$captiontext.'</textarea><br /><br />'.
+                  '<input type="submit" value="'.get_string('update').'" />';
+        return $this->enclose_in_form($result);
+    }
+
+    public function process_form() {
+        $caption = required_param('caption', PARAM_NOTAGS);
+
+        $fs = get_file_storage();
+        $storedfile = $fs->get_file($this->context->id, 'mod_lightboxgallery', 'gallery_images', '0', '/', $this->image);
+        $image = new lightboxgallery_image($storedfile, $this->gallery, $this->cm);
+
+        $image->set_caption($caption);
+    }
+
+}
diff --git a/mod/lightboxgallery/edit/crop/crop.class.php b/mod/lightboxgallery/edit/crop/crop.class.php
new file mode 100644
index 0000000..7ad4e0a
--- /dev/null
+++ b/mod/lightboxgallery/edit/crop/crop.class.php
@@ -0,0 +1,85 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+defined('MOODLE_INTERNAL') || die();
+
+require_once($CFG->libdir.'/gdlib.php');
+
+class edit_crop extends edit_base {
+
+    public function __construct($gallery, $cm, $image, $tab) {
+        parent::__construct($gallery, $cm, $image, $tab, true, false);
+    }
+
+    public function output() {
+
+        $result = '<script type="text/javascript" charset="utf-8">
+                        function onEndCrop( coords, dimensions ) {
+                            $( \'x1\' ).value = coords.x1;
+                            $( \'y1\' ).value = coords.y1;
+                            $( \'x2\' ).value = coords.x2;
+                            $( \'y2\' ).value = coords.y2;
+                            $( \'cropInfo\' ).innerHTML = \''.get_string('from').': \' + coords.x1 + \'x\' + coords.y1 + \', '.
+                            get_string('size').': \' + dimensions.width + \'x\' + dimensions.height;
+                        }
+                        Event.observe(
+                            window,
+                            \'load\',
+                            function() {
+                                new Cropper.Img(
+                                    \'cropImage\',
+                                    {
+                                        onEndCrop: onEndCrop
+                                    }
+                                )
+                            }
+                        );
+                    </script>';
+        $result .= '<input type="hidden" name="x1" id="x1" value="0" />
+                    <input type="hidden" name="y1" id="y1" value="0" />
+                    <input type="hidden" name="x2" id="x2" value="0" />
+                    <input type="hidden" name="y2" id="y2" value="0" />
+                    <table>
+                      <tr>
+                        <td>'.'TODO:imgurl'.'</td>
+                      </tr>
+                      <tr>
+                        <td><span id="cropInfo">&nbsp;</span></td>
+                      </tr>
+                      <tr>
+                        <td><input type="submit" value="'.get_string('savechanges').'" /></td>
+                      </tr>
+                    </table>';
+        return $this->enclose_in_form($result);
+    }
+
+    public function process_form() {
+        $x1 = required_param('x1', PARAM_INT);
+        $y1 = required_param('y1', PARAM_INT);
+        $x2 = required_param('x2', PARAM_INT);
+        $y2 = required_param('y2', PARAM_INT);
+
+        $width = $x2 - $x1;
+        $height = $y2 - $y1;
+
+        if ($width > 0 && $height > 0) {
+            $cropped = $this->imageobj->create_new_image($width, $height);
+            imagecopybicubic($cropped, $this->imageobj->image, 0, 0, $x1, $y1, $width, $height, $width, $height);
+            $this->imageobj->save_image($cropped);
+        }
+    }
+
+}
diff --git a/mod/lightboxgallery/edit/delete/delete.class.php b/mod/lightboxgallery/edit/delete/delete.class.php
new file mode 100644
index 0000000..fb883e6
--- /dev/null
+++ b/mod/lightboxgallery/edit/delete/delete.class.php
@@ -0,0 +1,42 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+defined('MOODLE_INTERNAL') || die();
+
+class edit_delete extends edit_base {
+
+    public function __construct($gallery, $cm, $image, $tab) {
+        parent::__construct($gallery, $cm, $image, $tab, true);
+    }
+
+    public function output() {
+        global $page;
+        $result = get_string('deletecheck', '', $this->image).'<br /><br />';
+        $result .= '<input type="hidden" name="page" value="'.$page.'" />';
+        $result .= '<input type="submit" value="'.get_string('yes').'" />';
+        return $this->enclose_in_form($result);
+    }
+
+    public function process_form() {
+        global $CFG, $DB, $page;
+        $fs = get_file_storage();
+        $storedfile = $fs->get_file($this->context->id, 'mod_lightboxgallery', 'gallery_images', '0', '/', $this->image);
+        $image = new lightboxgallery_image($storedfile, $this->gallery, $this->cm);
+        $image->delete_file();
+        redirect($CFG->wwwroot.'/mod/lightboxgallery/view.php?id='.$this->cm->id.'&page='.$page.'&editing=1');
+    }
+
+}
diff --git a/mod/lightboxgallery/edit/flip/flip.class.php b/mod/lightboxgallery/edit/flip/flip.class.php
new file mode 100644
index 0000000..a9dfe8e3
--- /dev/null
+++ b/mod/lightboxgallery/edit/flip/flip.class.php
@@ -0,0 +1,51 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+defined('MOODLE_INTERNAL') || die();
+
+define('FLIP_VERTICAL', 1);
+define('FLIP_HORIZONTAL', 2);
+
+class edit_flip extends edit_base {
+
+    public function __construct($gallery, $cm, $image, $tab) {
+        parent::__construct($gallery, $cm, $image, $tab, true);
+    }
+
+    public function output() {
+        $result = get_string('selectflipmode', 'lightboxgallery').'<br /><br />'.
+                  '<label><input type="radio" name="mode" value="'.FLIP_VERTICAL.'" /> Vertical</label><br />'.
+                  '<label><input type="radio" name="mode" value="'.FLIP_HORIZONTAL.'" /> Horizontal</label>'.
+                  '<br /><br /><input type="submit" value="'.get_string('edit_flip', 'lightboxgallery').'" />';
+
+        return $this->enclose_in_form($result);
+    }
+
+    public function process_form() {
+        $mode = required_param('mode', PARAM_INT);
+
+        $fs = get_file_storage();
+        $storedfile = $fs->get_file($this->context->id, 'mod_lightboxgallery', 'gallery_images', '0', '/', $this->image);
+        $image = new lightboxgallery_image($storedfile, $this->gallery, $this->cm);
+
+        if ($mode & FLIP_HORIZONTAL) {
+            $image->flip_image('horizontal');
+        } else {
+            $image->flip_image('vertical');
+        }
+    }
+
+}
diff --git a/mod/lightboxgallery/edit/resize/resize.class.php b/mod/lightboxgallery/edit/resize/resize.class.php
new file mode 100644
index 0000000..49183de
--- /dev/null
+++ b/mod/lightboxgallery/edit/resize/resize.class.php
@@ -0,0 +1,80 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+defined('MOODLE_INTERNAL') || die();
+
+class edit_resize extends edit_base {
+
+    private $strresize;
+    private $strscale;
+    private $resizeoptions;
+
+    public function __construct($gallery, $cm, $image, $tab) {
+        parent::__construct($gallery, $cm, $image, $tab, true);
+        $this->strresize = get_string('edit_resize', 'lightboxgallery');
+        $this->strscale = get_string('edit_resizescale', 'lightboxgallery');
+        $this->resizeoptions = lightboxgallery_resize_options();
+    }
+
+    public function output() {
+        $fs = get_file_storage();
+        $storedfile = $fs->get_file($this->context->id, 'mod_lightboxgallery', 'gallery_images', '0', '/', $this->image);
+        $image = new lightboxgallery_image($storedfile, $this->gallery, $this->cm);
+
+        $currentsize = sprintf('%s: %dx%d', get_string('currentsize', 'lightboxgallery'), $image->width, $image->height).
+                       '<br /><br />';
+
+        $sizeselect = '<select name="size">';
+        foreach ($this->resizeoptions as $index => $option) {
+            $sizeselect .= '<option value="' . $index . '">' . $option . '</option>';
+        }
+        $sizeselect .= '</select>&nbsp;<input type="submit" name="button" value="' . $this->strresize . '" /><br /><br />';
+
+        $scaleselect = '<select name="scale">'.
+                       '  <option value="200">200&#37;</option>'.
+                       '  <option value="150">150&#37;</option>'.
+                       '  <option value="125">125&#37;</option>'.
+                       '  <option value="75">75&#37;</option>'.
+                       '  <option value="50">50&#37;</option>'.
+                       '  <option value="25">25&#37;</option>'.
+                       '</select>&nbsp;<input type="submit" name="button" value="' . $this->strscale . '" />';
+
+        return $this->enclose_in_form($currentsize . $sizeselect . $scaleselect);
+    }
+
+    public function process_form() {
+        $button = required_param('button', PARAM_TEXT);
+
+        $fs = get_file_storage();
+        $storedfile = $fs->get_file($this->context->id, 'mod_lightboxgallery', 'gallery_images', '0', '/', $this->image);
+        $image = new lightboxgallery_image($storedfile, $this->gallery, $this->cm);
+
+        switch ($button) {
+            case $this->strresize:
+                $size = required_param('size', PARAM_INT);
+                list($width, $height) = explode('x', $this->resizeoptions[$size]);
+            break;
+            case $this->strscale:
+                $scale = required_param('scale', PARAM_INT);
+                $width = $image->width * ($scale / 100);
+                $height = $image->height * ($scale / 100);
+            break;
+        }
+
+        $this->image = $image->resize_image($width, $height);
+    }
+
+}
diff --git a/mod/lightboxgallery/edit/rotate/rotate.class.php b/mod/lightboxgallery/edit/rotate/rotate.class.php
new file mode 100644
index 0000000..e4c3e28
--- /dev/null
+++ b/mod/lightboxgallery/edit/rotate/rotate.class.php
@@ -0,0 +1,45 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+defined('MOODLE_INTERNAL') || die();
+
+class edit_rotate extends edit_base {
+
+    public function __construct($gallery, $cm, $image, $tab) {
+        parent::__construct($gallery, $cm, $image, $tab, true);
+    }
+
+    public function output() {
+        $result = get_string('selectrotation', 'lightboxgallery').'<br /><br />'.
+                  '<label><input type="radio" name="angle" value="-90" />-90&#176;</label>'.
+                  '<label><input type="radio" name="angle" value="180" />180&#176;</label>'.
+                  '<label><input type="radio" name="angle" value="90" />90&#176;</label>'.
+                  '<br /><br /><input type="submit" value="'.get_string('edit_rotate', 'lightboxgallery').'" />';
+
+        return $this->enclose_in_form($result);
+    }
+
+    public function process_form() {
+        $angle = required_param('angle', PARAM_INT);
+
+        $fs = get_file_storage();
+        $storedfile = $fs->get_file($this->context->id, 'mod_lightboxgallery', 'gallery_images', '0', '/', $this->image);
+        $image = new lightboxgallery_image($storedfile, $this->gallery, $this->cm);
+
+        $this->image = $image->rotate_image($angle);
+    }
+
+}
diff --git a/mod/lightboxgallery/edit/tag/import.php b/mod/lightboxgallery/edit/tag/import.php
new file mode 100644
index 0000000..8ec5866
--- /dev/null
+++ b/mod/lightboxgallery/edit/tag/import.php
@@ -0,0 +1,120 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+require_once(dirname(__FILE__).'/../../../../config.php');
+require_once(dirname(__FILE__).'/../../lib.php');
+
+$id = required_param('id', PARAM_INT);
+$confirm = optional_param('confirm', 0, PARAM_INT);
+
+if (!$gallery = $DB->get_record('lightboxgallery', array('id' => $id))) {
+    print_error('invalidlightboxgalleryid', 'lightboxgallery');
+}
+if (!$course = $DB->get_record('course', array('id' => $gallery->course))) {
+    print_error('invalidcourseid');
+}
+if (!$cm = get_coursemodule_from_instance('lightboxgallery', $gallery->id, $course->id)) {
+    print_error('invalidcoursemodule');
+}
+
+require_login($course->id);
+
+$context = context_module::instance($cm->id);
+$galleryurl = $CFG->wwwroot . '/mod/lightboxgallery/view.php?id=' . $cm->id;
+
+require_capability('mod/lightboxgallery:edit', $context);
+
+$PAGE->set_cm($cm);
+$PAGE->set_url('/mod/lightboxgallery/edit/tag/import.php', array('id' => $id));
+$PAGE->set_title($gallery->name);
+$PAGE->set_heading($course->shortname);
+echo $OUTPUT->header();
+
+$disabledplugins = explode(',', get_config('lightboxgallery', 'disabledplugins'));
+if (in_array('tag', $disabledplugins)) {
+    print_error(get_string('tagsdisabled', 'lightboxgallery'));
+}
+
+if ($confirm && confirm_sesskey()) {
+    // For each image, get tags using iptcparse.
+
+    $fs = get_file_storage();
+    $storedfiles = $fs->get_area_files($context->id, 'mod_lightboxgallery', 'gallery_images', false, 'itemid', false);
+
+    $a = new stdClass();
+    $a->tags = 0;
+    $a->images = count($storedfiles);
+
+    if ($a->images > 0) {
+        foreach ($storedfiles as $storedfile) {
+            if (!$storedfile->is_valid_image()) {
+                continue;
+            }
+
+            $path = $storedfile->copy_content_to_temp();
+            $size = getimagesize($path, $info);
+            if (isset($info['APP13'])) {
+                $iptc = iptcparse($info['APP13']);
+                if (isset($iptc['2#025'])) {
+                    sort($iptc['2#025']);
+                    $errorlevel = error_reporting(E_PARSE);
+
+                    foreach ($iptc['2#025'] as $tag) {
+                        $tag = utf8_encode($tag);
+                        $tag = clean_param($tag, PARAM_TAG);
+                        $tag = trim(strip_tags($tag));
+                        if (empty($tag)) {
+                            continue;
+                        }
+                        $select = "gallery = :gallery AND image = :image
+                                   AND metatype = :metatype AND ".$DB->sql_compare_text('description', 100).' = :description';
+                        $params = array(
+                            'gallery' => $gallery->id,
+                            'image' => $storedfile->get_filename(),
+                            'metatype' => 'tag',
+                            'description' => $tag,
+                        );
+                        if (!$DB->record_exists_select('lightboxgallery_image_meta', $select, $params)) {
+                            $record = new stdClass();
+                            $record->gallery = $gallery->id;
+                            $record->image = $storedfile->get_filename();
+                            $record->metatype = 'tag';
+                            $record->description = $tag;
+                            if ($DB->insert_record('lightboxgallery_image_meta', $record)) {
+                                $a->tags++;
+                            }
+                        }
+                    }
+                    error_reporting($errorlevel);
+                }
+            }
+        }
+    }
+
+    foreach (array_keys((array)$a) as $b) {
+        $a->{$b} = number_format($a->{$b});
+    }
+
+    notice(get_string('tagsimportfinish', 'lightboxgallery', $a), $galleryurl);
+} else {
+    $confirmurl = new moodle_url('/mod/lightboxgallery/edit/tag/import.php',
+        array('id' => $gallery->id, 'confirm' => 1, 'sesskey' => sesskey()));
+    $cancelurl = new moodle_url('/mod/lightboxgallery/view.php',
+        array('id' => $cm->id, 'editing' => 1));
+    echo $OUTPUT->confirm(get_string('tagsimportconfirm', 'lightboxgallery'), $confirmurl, $cancelurl);
+}
+
+echo $OUTPUT->footer();
diff --git a/mod/lightboxgallery/edit/tag/tag.class.php b/mod/lightboxgallery/edit/tag/tag.class.php
new file mode 100644
index 0000000..545ecc1
--- /dev/null
+++ b/mod/lightboxgallery/edit/tag/tag.class.php
@@ -0,0 +1,97 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+defined('MOODLE_INTERNAL') || die();
+
+class edit_tag extends edit_base {
+
+    public function __construct($gallery, $cm, $image, $tab) {
+        parent::__construct($gallery, $cm, $image, $tab, true);
+    }
+
+    public function output() {
+        global $CFG, $OUTPUT;
+
+        $stradd = get_string('add');
+
+        $fs = get_file_storage();
+        $storedfile = $fs->get_file($this->context->id, 'mod_lightboxgallery', 'gallery_images', '0', '/', $this->image);
+        $image = new lightboxgallery_image($storedfile, $this->gallery, $this->cm);
+
+        $manualform = '<input type="text" name="tag" /><input type="submit" value="'.$stradd.'" />';
+        $manualform = $this->enclose_in_form($manualform);
+
+        $iptcform = '';
+        $deleteform = '';
+
+        $path = $storedfile->copy_content_to_temp();
+        $tags = $image->get_tags();
+
+        $size = getimagesize($path, $info);
+        if (isset($info['APP13'])) {
+            $iptc = iptcparse($info['APP13']);
+            if (isset($iptc['2#025'])) {
+                $iptcform = '<input type="hidden" name="iptc" value="1" />';
+                sort($iptc['2#025']);
+                foreach ($iptc['2#025'] as $tag) {
+                    $tag = core_text::strtolower($tag);
+                    $exists = ($tags && in_array($tag, array_values($tags)));
+                    $tag = htmlentities($tag);
+                    $iptcform .= '<label ' . ($exists ? 'class="tag-exists"' : '').
+                        '><input type="checkbox" name="iptctags[]" value="' . $tag . '" />' . $tag . '</label><br />';
+                }
+                $iptcform .= '<input type="submit" value="' . $stradd . '" />';
+                $iptcform = '<span class="tag-head"> ' . get_string('tagsiptc', 'lightboxgallery').
+                    '</span>' . $this->enclose_in_form($iptcform);
+            }
+        }
+
+        $iptcaddurl = new moodle_url('/mod/lightboxgallery/edit/tag/import.php', array('id' => $this->gallery->id));
+        $iptcform .= $OUTPUT->single_button($iptcaddurl, get_string('tagsimport', 'lightboxgallery'));
+
+        if ($tags = $image->get_tags()) {
+            $deleteform = '<input type="hidden" name="delete" value="1" />';
+            foreach ($tags as $tag) {
+                $deleteform .= '<label><input type="checkbox" name="deletetags[]" value="'.$tag->id.'" /> '.
+                               htmlentities(utf8_decode($tag->description)).'</label><br />';
+            }
+            $deleteform .= '<input type="submit" value="' . get_string('remove') . '" />';
+            $deleteform = '<span class="tag-head"> ' . get_string('tagscurrent', 'lightboxgallery') . '</span>'
+                          .$this->enclose_in_form($deleteform);
+        }
+
+        return $manualform . $iptcform . $deleteform;
+    }
+
+    public function process_form() {
+        $tag = optional_param('tag', '', PARAM_TAG);
+
+        $fs = get_file_storage();
+        $storedfile = $fs->get_file($this->context->id, 'mod_lightboxgallery', 'gallery_images', '0', '/', $this->image);
+        $image = new lightboxgallery_image($storedfile, $this->gallery, $this->cm);
+
+        if ($tag) {
+            $image->add_tag($tag);
+        } else if (optional_param('delete', 0, PARAM_INT)) {
+            if ($deletes = optional_param_array('deletetags', array(), PARAM_RAW)) {
+                foreach ($deletes as $delete) {
+                    $image->delete_tag(clean_param($delete, PARAM_INT));
+                }
+            }
+        }
+    }
+
+}
diff --git a/mod/lightboxgallery/edit/thumbnail/thumbnail.class.php b/mod/lightboxgallery/edit/thumbnail/thumbnail.class.php
new file mode 100644
index 0000000..59b6039
--- /dev/null
+++ b/mod/lightboxgallery/edit/thumbnail/thumbnail.class.php
@@ -0,0 +1,95 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+defined('MOODLE_INTERNAL') || die();
+
+class edit_thumbnail extends edit_base {
+
+    public function __construct($gallery, $cm, $image, $tab) {
+        parent::__construct($gallery, $cm, $image, $tab, true);
+    }
+
+    public function output() {
+
+        $fs = get_file_storage();
+        $storedfile = $fs->get_file($this->context->id, 'mod_lightboxgallery', 'gallery_images', '0', '/', $this->image);
+        $image = new lightboxgallery_image($storedfile, $this->gallery, $this->cm);
+
+        $result = '<input type="submit" name="index" value="' . get_string('setasindex', 'lightboxgallery')  . '" /><br /><br />' .
+                   get_string('selectthumbpos', 'lightboxgallery') . '<br /><br />';
+
+        if ($image->width < $image->height) {
+            $result .= '<label><input type="radio" name="move" value="1" />'.
+                       get_string('dirup', 'lightboxgallery') . '</label>&nbsp;'.
+                       '<label><input type="radio" name="move" value="2" />'.
+                       get_string('dirdown', 'lightboxgallery') . '</label>';
+        } else {
+            $result .= '<label><input type="radio" name="move" value="3" />'.
+                       get_string('dirleft', 'lightboxgallery') . '</label>&nbsp;'.
+                       '<label><input type="radio" name="move" value="4" />'.
+                       get_string('dirright', 'lightboxgallery') . '</label>';
+        }
+        $result .= '<br /><br />' . get_string('thumbnailoffset', 'lightboxgallery').
+                   ': <input type="text" name="offset" value="20" size="4" /><br /><br />'.
+                   '<input type="submit" value="' . get_string('move').
+                   '" />&nbsp;<input type="submit" name="reset" value="' . get_string('reset') . '" />';
+
+        return $this->enclose_in_form($result);
+    }
+
+    public function process_form() {
+
+        $fs = get_file_storage();
+        $storedfile = $fs->get_file($this->context->id, 'mod_lightboxgallery', 'gallery_images', '0', '/', $this->image);
+        $image = new lightboxgallery_image($storedfile, $this->gallery, $this->cm);
+        $domove = true;
+
+        if (optional_param('index', '', PARAM_TEXT)) {
+            return lightboxgallery_index_thumbnail($this->gallery->course, $this->gallery, $image);
+        } else if (optional_param('reset', '', PARAM_TEXT)) {
+            $offsetx = 0;
+            $offsety = 0;
+        } else {
+            $move = optional_param('move', -1, PARAM_INT);
+            $offset = optional_param('offset', 20, PARAM_INT);
+            switch ($move) {
+                case 1:
+                    $offsetx = 0;
+                    $offsety = -$offset;
+                    break;
+                case 2:
+                    $offsetx = 0;
+                    $offsety = $offset;
+                    break;
+                case 3:
+                    $offsetx = -$offset;
+                    $offsety = 0;
+                    break;
+                case 4:
+                    $offsetx = $offset;
+                    $offsety = 0;
+                    break;
+                default:
+                    $domove = false;
+            }
+        }
+
+        if ($domove) {
+            $image->create_thumbnail($offsetx, $offsety);
+        }
+    }
+
+}
diff --git a/mod/lightboxgallery/imageadd.php b/mod/lightboxgallery/imageadd.php
new file mode 100644
index 0000000..d8abe39
--- /dev/null
+++ b/mod/lightboxgallery/imageadd.php
@@ -0,0 +1,73 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * A page for uploading new images
+ *
+ * @package   mod_lightworkgallery
+ * @copyright 2011 John Kelsh <john.kelsh@netspot.com.au>
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+require_once(dirname(dirname(dirname(__FILE__))).'/config.php');
+require_once(dirname(__FILE__).'/imageadd_form.php');
+require_once(dirname(__FILE__).'/imageclass.php');
+
+$id = required_param('id', PARAM_INT);
+
+list($course, $cm) = get_course_and_cm_from_cmid($id, 'lightboxgallery');
+$gallery = $DB->get_record('lightboxgallery', array('id' => $cm->instance), '*', MUST_EXIST);
+
+require_login($course, true, $cm);
+
+$context = context_module::instance($cm->id);
+require_capability('mod/lightboxgallery:addimage', $context);
+
+$PAGE->set_cm($cm);
+$PAGE->set_url('/mod/lightboxgallery/view.php', array('id' => $cm->id));
+$PAGE->set_title($gallery->name);
+$PAGE->set_heading($course->shortname);
+
+$mform = new mod_lightboxgallery_imageadd_form(null, array('id' => $cm->id));
+
+if ($mform->is_cancelled()) {
+    redirect($CFG->wwwroot.'/mod/lightboxgallery/view.php?id='.$cm->id);
+
+} else if (($formdata = $mform->get_data()) && confirm_sesskey()) {
+    require_once($CFG->dirroot . '/lib/uploadlib.php');
+
+    $fs = get_file_storage();
+    $draftid = file_get_submitted_draft_itemid('image');
+    if (!$files = $fs->get_area_files(
+        context_user::instance($USER->id)->id, 'user', 'draft', $draftid, 'id DESC', false)) {
+        redirect($PAGE->url);
+    }
+
+    if ($gallery->autoresize == AUTO_RESIZE_UPLOAD || $gallery->autoresize == AUTO_RESIZE_BOTH) {
+        $resize = $gallery->resize;
+    } else if (isset($formdata->resize)) {
+        $resize = $formdata->resize;
+    } else {
+        $resize = 0; // No resize.
+    }
+
+    lightboxgallery_add_images($files, $context, $cm, $gallery, $resize);
+    redirect($CFG->wwwroot.'/mod/lightboxgallery/view.php?id='.$cm->id);
+}
+
+echo $OUTPUT->header();
+$mform->display();
+echo $OUTPUT->footer();
diff --git a/mod/lightboxgallery/imageadd_form.php b/mod/lightboxgallery/imageadd_form.php
new file mode 100644
index 0000000..cbae5d2
--- /dev/null
+++ b/mod/lightboxgallery/imageadd_form.php
@@ -0,0 +1,99 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * Prints a particular instance of lightboxgallery
+ *
+ * @package   mod_lightboxgallery
+ * @author    Adam Olley <adam.olley@netspot.com.au>
+ * @copyright 2012 NetSpot Pty Ltd
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+require_once(dirname(__FILE__).'/locallib.php');
+require_once($CFG->libdir.'/formslib.php');
+require_once(dirname(__FILE__).'/imageclass.php');
+
+class mod_lightboxgallery_imageadd_form extends moodleform {
+
+    public function definition() {
+
+        global $COURSE, $cm;
+
+        $mform =& $this->_form;
+        $gallery = $this->_customdata;
+
+        $handlecollisions = !get_config('lightboxgallery', 'overwritefiles');
+        $mform->addElement('header', 'general', get_string('addimage', 'lightboxgallery'));
+
+        $mform->addElement('filemanager', 'image', get_string('file'), '0',
+                           array('maxbytes' => $COURSE->maxbytes, 'accepted_types' => array('web_image', 'archive')));
+        $mform->addRule('image', get_string('required'), 'required', null, 'client');
+        $mform->addHelpButton('image', 'addimage', 'lightboxgallery');
+
+        if ($this->can_resize()) {
+            $resizegroup = array();
+            $resizegroup[] = &$mform->createElement('select', 'resize', get_string('edit_resize', 'lightboxgallery'),
+                                                    lightboxgallery_resize_options());
+            $resizegroup[] = &$mform->createElement('checkbox', 'resizedisabled', null, get_string('disable'));
+            $mform->setType('resize', PARAM_INT);
+            $mform->addGroup($resizegroup, 'resizegroup', get_string('edit_resize', 'lightboxgallery'), ' ', false);
+            $mform->setDefault('resizedisabled', 1);
+            $mform->disabledIf('resizegroup', 'resizedisabled', 'checked');
+            $mform->setAdvanced('resizegroup');
+        }
+
+        $mform->addElement('hidden', 'id', $cm->id);
+        $mform->setType('id', PARAM_INT);
+
+        $this->add_action_buttons(true, get_string('addimage', 'lightboxgallery'));
+
+    }
+
+    public function validation($data, $files) {
+        global $USER;
+
+        if ($errors = parent::validation($data, $files)) {
+            return $errors;
+        }
+
+        $usercontext = context_user::instance($USER->id);
+        $fs = get_file_storage();
+
+        if (!$files = $fs->get_area_files($usercontext->id, 'user', 'draft', $data['image'], 'id', false)) {
+            $errors['image'] = get_string('required');
+            return $errors;
+        } else {
+            $file = reset($files);
+            if ($file->get_mimetype() != 'application/zip' && !$file->is_valid_image()) {
+                $errors['image'] = get_string('invalidfiletype', 'error', $file->get_filename());
+                // Better delete current file, it is not usable anyway.
+                $fs->delete_area_files($usercontext->id, 'user', 'draft', $data['image']);
+            }
+        }
+
+        return $errors;
+    }
+
+
+    private function can_resize() {
+        global $gallery;
+
+        return !in_array($gallery->autoresize, array(AUTO_RESIZE_UPLOAD, AUTO_RESIZE_BOTH));
+    }
+}
diff --git a/mod/lightboxgallery/imageclass.php b/mod/lightboxgallery/imageclass.php
new file mode 100644
index 0000000..1606ac0
--- /dev/null
+++ b/mod/lightboxgallery/imageclass.php
@@ -0,0 +1,429 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * Main image class with all image manipulations as methods
+ *
+ * @package   mod_lightboxgallery
+ * @copyright 2010 John Kelsh
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+require_once($CFG->libdir.'/gdlib.php');
+
+define('THUMBNAIL_WIDTH', 162);
+define('THUMBNAIL_HEIGHT', 132);
+define('LIGHTBOXGALLERY_POS_HID', 2);
+define('LIGHTBOXGALLERY_POS_TOP', 1);
+define('LIGHTBOXGALLERY_POS_BOT', 0);
+
+class lightboxgallery_image {
+
+    private $cm;
+    private $cmid;
+    private $storedfile;
+    private $imageurl;
+    private $tags;
+    private $thumburl;
+    private $context;
+
+    public function __construct($storedfile, $gallery, $cm) {
+        global $CFG;
+
+        $this->storedfile = &$storedfile;
+        $this->gallery = &$gallery;
+        $this->cm = &$cm;
+        $this->cmid = $cm->id;
+        $this->context = context_module::instance($cm->id);
+
+        $this->imageurl = $CFG->wwwroot.'/pluginfile.php/'.$this->context->id.'/mod_lightboxgallery/gallery_images/'.
+                           $this->storedfile->get_itemid().$this->storedfile->get_filepath().$this->storedfile->get_filename();
+        $this->thumburl = $CFG->wwwroot.'/pluginfile.php/'.$this->context->id.'/mod_lightboxgallery/gallery_thumbs/0'.
+                           $this->storedfile->get_filepath().$this->storedfile->get_filename().'.png';
+
+        $imageinfo = $this->storedfile->get_imageinfo();
+
+        $this->height = $imageinfo['height'];
+        $this->width = $imageinfo['width'];
+
+        if (!$this->thumbnail = $this->get_thumbnail()) {
+            $this->thumbnail = $this->create_thumbnail();
+        }
+    }
+
+    public function add_tag($tag) {
+        global $DB;
+
+        $imagemeta = new stdClass();
+        $imagemeta->gallery = $this->cm->instance;
+        $imagemeta->image = $this->storedfile->get_filename();
+        $imagemeta->metatype = 'tag';
+        $imagemeta->description = $tag;
+
+        return $DB->insert_record('lightboxgallery_image_meta', $imagemeta);
+    }
+
+    public function create_thumbnail($offsetx = 0, $offsety = 0) {
+        global $CFG;
+
+        $fileinfo = array(
+            'contextid' => $this->context->id,
+            'component' => 'mod_lightboxgallery',
+            'filearea' => 'gallery_thumbs',
+            'itemid' => 0,
+            'filepath' => $this->storedfile->get_filepath(),
+            'filename' => $this->storedfile->get_filename().'.png');
+
+        ob_start();
+        imagepng($this->get_image_resized(THUMBNAIL_HEIGHT, THUMBNAIL_WIDTH, $offsetx, $offsety));
+        $thumbnail = ob_get_clean();
+
+        $this->delete_thumbnail();
+        $fs = get_file_storage();
+        return $fs->create_file_from_string($fileinfo, $thumbnail);
+    }
+
+    public function create_index() {
+        global $CFG;
+
+        $fileinfo = array(
+            'contextid' => $this->context->id,
+            'component' => 'mod_lightboxgallery',
+            'filearea' => 'gallery_index',
+            'itemid' => 0,
+            'filepath' => '/',
+            'filename' => 'index.png');
+
+        $base = imagecreatefrompng($CFG->dirroot.'/mod/lightboxgallery/pix/index.png');
+        $transparent = imagecolorat($base, 0, 0);
+
+        $shrunk = imagerotate($this->get_image_resized(48, 48, 0, 0), 351, $transparent, 0);
+
+        imagecolortransparent($base, $transparent);
+
+        imagecopy($base, $shrunk, 2, 3, 0, 0, imagesx($shrunk), imagesy($shrunk));
+
+        ob_start();
+        imagepng($base);
+        $index = ob_get_clean();
+
+        $fs = get_file_storage();
+        return $fs->create_file_from_string($fileinfo, $index);
+    }
+
+    public function delete_file($meta = true) {
+        global $DB;
+
+        $this->delete_thumbnail();
+
+        // Delete all image_meta records for this file.
+        if ($meta) {
+            $DB->delete_records('lightboxgallery_image_meta', array(
+                'gallery' => $this->cm->instance,
+                'image' => $this->storedfile->get_filename()));
+        }
+
+        $this->storedfile->delete();
+    }
+
+    public function delete_tag($tag) {
+        global $DB;
+
+        return $DB->delete_records('lightboxgallery_image_meta', array('id' => $tag));
+    }
+
+    private function delete_thumbnail() {
+        if (isset($this->thumbnail) && is_object($this->thumbnail)) {
+            $this->thumbnail->delete();
+            unset($this->thumbnail);
+        }
+    }
+
+    public function flip_image($direction) {
+
+        $fileinfo = array(
+            'contextid'     => $this->context->id,
+            'component'     => 'mod_lightboxgallery',
+            'filearea'      => 'gallery_images',
+            'itemid'        => 0,
+            'filepath'      => $this->storedfile->get_filepath(),
+            'filename'      => $this->storedfile->get_filename());
+
+        ob_start();
+        $fileinfo['filename'] = $this->output_by_mimetype($this->get_image_flipped($direction));
+        $flipped = ob_get_clean();
+        $this->delete_file(false);
+        $fs = get_file_storage();
+        $this->set_stored_file($fs->create_file_from_string($fileinfo, $flipped));
+
+        $this->create_thumbnail();
+    }
+
+    private function get_editing_options() {
+        global $CFG;
+
+        $html = '<form action="'.$CFG->wwwroot.'/mod/lightboxgallery/imageedit.php" method="post"/>'.
+                    '<input type="hidden" name="id" value="'.$this->cmid.'" />'.
+                    '<input type="hidden" name="image" value="'.$this->storedfile->get_filename().'" />'.
+                    '<input type="hidden" name="page" value="0" />'.
+                    '<select name="tab" class="lightbox-edit-select" onchange="submit();">'.
+                        '<option disabled selected>'.get_string('edit_choose', 'lightboxgallery').'</option>'.
+                        '<option value="caption">'.get_string('edit_caption', 'lightboxgallery').'</option>'.
+                        '<!--<option value="crop">'.get_string('edit_crop', 'lightboxgallery').'</option>-->'.
+                        '<option value="delete">'.get_string('edit_delete', 'lightboxgallery').'</option>'.
+                        '<option value="flip">'.get_string('edit_flip', 'lightboxgallery').'</option>'.
+                        '<option value="resize">'.get_string('edit_resize', 'lightboxgallery').'</option>'.
+                        '<option value="rotate">'.get_string('edit_rotate', 'lightboxgallery').'</option>'.
+                        '<option value="tag">'.get_string('edit_tag', 'lightboxgallery').'</option>'.
+                        '<option value="thumbnail">'.get_string('edit_thumbnail', 'lightboxgallery').'</option>'.
+                    '</select>'.
+                '</form>';
+
+        return $html;
+    }
+
+    public function get_image_caption() {
+        global $DB;
+        $caption = '';
+
+        if ($imagemeta = $DB->get_record('lightboxgallery_image_meta',
+                array('gallery' => $this->gallery->id, 'image' => $this->storedfile->get_filename(), 'metatype' => 'caption'))) {
+            $caption = $imagemeta->description;
+        }
+
+        return $caption;
+    }
+
+    public function get_image_display_html($editing = false) {
+        if ($this->gallery->captionfull) {
+            $caption = $this->get_image_caption();
+        } else {
+            $caption = lightboxgallery_resize_text($this->get_image_caption(), MAX_IMAGE_LABEL);
+        }
+        $timemodified = strftime(get_string('strftimedatetimeshort', 'langconfig'), $this->storedfile->get_timemodified());
+        $filesize = round($this->storedfile->get_filesize() / 100) / 10;
+
+        // Hide the caption.
+        if ($this->gallery->captionpos == LIGHTBOXGALLERY_POS_HID) {
+            $caption = ''; // Hide by cleaning the content (looks better than cleaning the whole div).
+        }
+        $posclass = ($this->gallery->captionpos == LIGHTBOXGALLERY_POS_TOP) ? 'top' : 'bottom';
+        $captiondiv = html_writer::tag('div', $caption, array('class' => "lightbox-gallery-image-caption $posclass"));
+
+        $html = '<div class="lightbox-gallery-image-container">'.
+                    '<div class="lightbox-gallery-image-wrapper">'.
+                        '<div class="lightbox-gallery-image-frame">';
+        if ($this->gallery->captionpos == LIGHTBOXGALLERY_POS_TOP) {
+            $html .= $captiondiv;
+        }
+        $html .= '<a class="lightbox-gallery-image-thumbnail" href="'.
+                 $this->imageurl.'" rel="lightbox_gallery" title="'.$caption.
+                 '" style="background-image: url(\''.$this->thumburl.
+                 '\'); width: '.THUMBNAIL_WIDTH.'px; height: '.THUMBNAIL_HEIGHT.'px;"></a>';
+        if ($this->gallery->captionpos == LIGHTBOXGALLERY_POS_BOT or $this->gallery->captionpos == LIGHTBOXGALLERY_POS_HID) {
+            $html .= $captiondiv;
+        }
+        $html .= $this->gallery->extinfo ? '<div class="lightbox-gallery-image-extinfo">'.$timemodified.
+                 '<br/>'.$filesize.'KB '.$this->width.'x'.$this->height.'px</div>' : '';
+        $html .= ($editing ? $this->get_editing_options() : '');
+        $html .= '</div>'.
+                    '</div>'.
+                '</div>';
+
+        return $html;
+
+    }
+
+    private function get_image_flipped($direction) {
+        $image = imagecreatefromstring($this->storedfile->get_content());
+        $flipped = imagecreatetruecolor($this->width, $this->height);
+        $w = $this->width;
+        $h = $this->height;
+        if ($direction == 'horizontal') {
+            for ($x = 0; $x < $w; $x++) {
+                for ($y = 0; $y < $h; $y++) {
+                    imagecopy($flipped, $image, $x, $h - $y - 1, $x, $y, 1, 1);
+                }
+            }
+        } else {
+            for ($x = 0; $x < $w; $x++) {
+                for ($y = 0; $y < $h; $y++) {
+                    imagecopy($flipped, $image, $w - $x - 1, $y, $x, $y, 1, 1);
+                }
+            }
+        }
+
+        return $flipped;
+
+    }
+
+    private function get_image_resized($height = THUMBNAIL_HEIGHT, $width = THUMBNAIL_WIDTH, $offsetx = 0, $offsety = 0) {
+        $image = imagecreatefromstring($this->storedfile->get_content());
+        $resized = imagecreatetruecolor($width, $height);
+        imagealphablending($resized, false);
+        imagesavealpha($resized, true);
+
+        $cx = $this->width / 2;
+        $cy = $this->height / 2;
+
+        $ratiow = $width / $this->width;
+        $ratioh = $height / $this->height;
+
+        if ($ratiow < $ratioh) {
+            $srcw = floor($width / $ratioh);
+            $srch = $this->height;
+            $srcx = floor($cx - ($srcw / 2)) + $offsetx;
+            $srcy = $offsety;
+        } else {
+            $srcw = $this->width;
+            $srch = floor($height / $ratiow);
+            $srcx = $offsetx;
+            $srcy = floor($cy - ($srch / 2)) + $offsety;
+        }
+
+        imagecopybicubic($resized, $image, 0, 0, $srcx, $srcy, $width, $height, $srcw, $srch);
+
+        return $resized;
+
+    }
+
+    private function get_image_rotated($angle) {
+        $image = imagecreatefromstring($this->storedfile->get_content());
+        $rotated = imagerotate($image, $angle, 0);
+
+        return $rotated;
+    }
+
+    public function get_image_url() {
+        return $this->imageurl;
+    }
+
+    public function get_tags() {
+        global $DB;
+
+        if (isset($this->tags)) {
+            return $this->tags;
+        }
+
+        $this->tags = $DB->get_records('lightboxgallery_image_meta',
+                                        array('image' => $this->storedfile->get_filename(), 'metatype' => 'tag'));
+
+        return $this->tags;
+    }
+
+    private function get_thumbnail() {
+        $fs = get_file_storage();
+
+        if ($thumbnail = $fs->get_file($this->context->id, 'mod_lightboxgallery', 'gallery_thumbs', '0', '/',
+                                       $this->storedfile->get_filename().'.png')) {
+            return $thumbnail;
+        }
+
+        return false;
+    }
+
+    public function get_thumbnail_url() {
+        return $this->thumburl;
+    }
+
+    protected function output_by_mimetype($gdcall) {
+        if ($this->storedfile->get_mimetype() == 'image/png') {
+            $imgfunc = 'imagepng';
+        } else {
+            $imgfunc = 'imagejpeg';
+        }
+        $imgfunc($gdcall);
+        if ($this->storedfile->get_mimetype() == 'image/png') {
+            return preg_replace('/\..+$/', '.png', $this->storedfile->get_filename());
+        } else {
+            return preg_replace('/\..+$/', '.jpg', $this->storedfile->get_filename());
+        }
+    }
+
+    public function resize_image($width, $height) {
+        $fileinfo = array(
+            'contextid'     => $this->context->id,
+            'component'     => 'mod_lightboxgallery',
+            'filearea'      => 'gallery_images',
+            'itemid'        => 0,
+            'filepath'      => $this->storedfile->get_filepath(),
+            'filename'      => $this->storedfile->get_filename());
+
+        ob_start();
+        $fileinfo['filename'] = $this->output_by_mimetype($this->get_image_resized($height, $width));
+        $resized = ob_get_clean();
+
+        $this->delete_file(false);
+        $fs = get_file_storage();
+        $this->storedfile = $fs->create_file_from_string($fileinfo, $resized);
+        $imageinfo = $this->storedfile->get_imageinfo();
+        $this->height = $imageinfo['height'];
+        $this->width = $imageinfo['width'];
+
+        $this->thumbnail = $this->create_thumbnail();
+
+        return $fileinfo['filename'];
+    }
+
+    public function rotate_image($angle) {
+        $fileinfo = array(
+            'contextid'     => $this->context->id,
+            'component'     => 'mod_lightboxgallery',
+            'filearea'      => 'gallery_images',
+            'itemid'        => 0,
+            'filepath'      => $this->storedfile->get_filepath(),
+            'filename'      => $this->storedfile->get_filename());
+
+        ob_start();
+        $fileinfo['filename'] = $this->output_by_mimetype($this->get_image_rotated($angle));
+        $rotated = ob_get_clean();
+
+        $this->delete_file(false);
+        $fs = get_file_storage();
+        $this->set_stored_file($fs->create_file_from_string($fileinfo, $rotated));
+
+        $this->create_thumbnail();
+        return $fileinfo['filename'];
+    }
+
+    public function set_caption($caption) {
+        global $DB;
+
+        $imagemeta = new stdClass();
+        $imagemeta->gallery = $this->cm->instance;
+        $imagemeta->image = $this->storedfile->get_filename();
+        $imagemeta->metatype = 'caption';
+        $imagemeta->description = $caption;
+
+        if ($meta = $DB->get_record('lightboxgallery_image_meta', array('gallery' => $this->cm->instance,
+                'image' => $this->storedfile->get_filename(), 'metatype' => 'caption'))) {
+            $imagemeta->id = $meta->id;
+            return $DB->update_record('lightboxgallery_image_meta', $imagemeta);
+        } else {
+            return $DB->insert_record('lightboxgallery_image_meta', $imagemeta);
+        }
+    }
+
+    public function set_stored_file($storedfile) {
+        $this->storedfile = $storedfile;
+        $imageinfo = $this->storedfile->get_imageinfo();
+
+        $this->height = $imageinfo['height'];
+        $this->width = $imageinfo['width'];
+    }
+}
diff --git a/mod/lightboxgallery/imageedit.php b/mod/lightboxgallery/imageedit.php
new file mode 100644
index 0000000..b11991c
--- /dev/null
+++ b/mod/lightboxgallery/imageedit.php
@@ -0,0 +1,124 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+
+/**
+ * Image editing page
+ *
+ * @package   mod_lightboxgallery
+ * @copyright 2011 NetSpot Pty Ltd
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+require_once(dirname(dirname(dirname(__FILE__))).'/config.php');
+require_once(dirname(__FILE__).'/locallib.php');
+require_once(dirname(__FILE__).'/edit/base.class.php');
+require_once(dirname(__FILE__).'/imageclass.php');
+
+global $DB;
+
+$id = required_param('id', PARAM_INT);
+$image = required_param('image', PARAM_PATH);
+$tab = optional_param('tab', '', PARAM_TEXT);
+$page = optional_param('page', 0, PARAM_INT);
+
+$cm      = get_coursemodule_from_id('lightboxgallery', $id, 0, false, MUST_EXIST);
+$course  = $DB->get_record('course', array('id' => $cm->course), '*', MUST_EXIST);
+$gallery = $DB->get_record('lightboxgallery', array('id' => $cm->instance), '*', MUST_EXIST);
+
+require_login($course->id);
+
+$context = context_module::instance($cm->id);
+require_capability('mod/lightboxgallery:edit', $context);
+
+$PAGE->set_cm($cm);
+$PAGE->set_pagelayout('incourse');
+$PAGE->set_url('/mod/lightboxgallery/imageedit.php', array('id' => $cm->id, 'image' => $image, 'tab' => $tab, 'page' => $page));
+$PAGE->set_title($gallery->name);
+$PAGE->set_heading($course->shortname);
+$buttonurl = new moodle_url('/mod/lightboxgallery/view.php', array('id' => $id, 'editing' => 1, 'page' => $page));
+$PAGE->set_button($OUTPUT->single_button($buttonurl, get_string('backtogallery', 'lightboxgallery')));
+
+$edittypes = lightboxgallery_edit_types();
+
+$tabs = array();
+foreach ($edittypes as $type => $name) {
+    $editurl = new moodle_url('/mod/lightboxgallery/imageedit.php',
+                                array('id' => $cm->id, 'image' => $image, 'page' => $page, 'tab' => $type));
+    $tabs[] = new tabObject($type, $editurl, $name);
+}
+
+if (!in_array($tab, array_keys($edittypes))) {
+    $types = array_keys($edittypes);
+    if (isset($types[0])) {
+        $tab = $types[0];
+    } else {
+        notice(get_string('allpluginsdisabled', 'lightboxgallery'), "view.php?id=$id&page=$page");
+    }
+}
+
+require($CFG->dirroot.'/mod/lightboxgallery/edit/'.$tab.'/'.$tab.'.class.php');
+$editclass = 'edit_'.$tab;
+$editinstance = new $editclass($gallery, $cm, $image, $tab);
+
+$fs = get_file_storage();
+if (!$storedfile = $fs->get_file($context->id, 'mod_lightboxgallery', 'gallery_images', '0', '/', $image)) {
+    print_error(get_string('errornofile', 'lightboxgallery', $image));
+}
+
+if ($editinstance->processing() && confirm_sesskey()) {
+    $params = array(
+        'context' => $context,
+        'other' => array(
+            'imagename' => $image,
+            'tab' => $tab
+        ),
+    );
+    $event = \mod_lightboxgallery\event\image_updated::create($params);
+    $event->add_record_snapshot('course_modules', $cm);
+    $event->add_record_snapshot('course', $course);
+    $event->add_record_snapshot('lightboxgallery', $gallery);
+    $event->trigger();
+
+    $editinstance->process_form();
+    redirect($CFG->wwwroot.'/mod/lightboxgallery/imageedit.php?id='.$cm->id.'&image='.$editinstance->image.'&tab='.$tab);
+}
+
+$image = new lightboxgallery_image($storedfile, $gallery, $cm);
+
+$table = new html_table();
+$table->width = '*';
+
+if ($editinstance->showthumb) {
+    $table->attributes = array('style' => 'margin-left:auto;margin-right:auto;');
+    $table->align = array('center', 'center');
+    $table->size = array('*', '*');
+    $table->data[] = array('<img src="'.$image->get_thumbnail_url().
+                            '" alt="" /><br /><span title="'.$image->get_image_caption().'">'.
+                            $image->get_image_caption().'</span>', $editinstance->output($image->get_image_caption()));
+} else {
+    $table->align = array('center');
+    $table->size = array('*');
+    $table->data[] = array($editinstance->output($image->get_image_caption()));
+}
+
+echo $OUTPUT->header();
+
+print_tabs(array($tabs), $tab);
+
+echo html_writer::table($table);
+
+echo $OUTPUT->footer();
diff --git a/mod/lightboxgallery/index.php b/mod/lightboxgallery/index.php
new file mode 100644
index 0000000..34cc253
--- /dev/null
+++ b/mod/lightboxgallery/index.php
@@ -0,0 +1,107 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+
+/**
+ * Shows a list of available galleries
+ *
+ * @package   mod_lightworkgallery
+ * @copyright 2011 John Kelsh
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+require_once(dirname(dirname(dirname(__FILE__))).'/config.php');
+require_once(dirname(__FILE__).'/locallib.php');
+require_once($CFG->libdir.'/rsslib.php');
+
+$id = required_param('id', PARAM_INT);
+
+$course = $DB->get_record('course', array('id' => $id), '*', MUST_EXIST);
+$context = context_course::instance($course->id);
+require_course_login($course);
+
+$event = \mod_lightboxgallery\event\course_module_instance_list_viewed::create(array(
+    'context' => $context
+));
+$event->add_record_snapshot('course', $course);
+$event->trigger();
+
+$PAGE->set_url('/mod/lightboxgallery/view.php', array('id' => $id));
+$PAGE->set_title($course->fullname);
+$PAGE->set_heading($course->shortname);
+
+echo $OUTPUT->header();
+
+if (! $galleries = get_all_instances_in_course('lightboxgallery', $course)) {
+    echo $OUTPUT->heading(get_string('thereareno', 'moodle', $strgalleries), 2);
+    echo $OUTPUT->continue_button('view.php?id='.$course->id);
+    echo $OUTPUT->footer();
+    die();
+}
+
+$table = new html_table();
+$table->head = array(get_string($course->format == 'weeks' ? 'week' : 'topic'),
+                        '&nbsp;',
+                        get_string('modulenameshort', 'lightboxgallery'),
+                        get_string('description'),
+                        'RSS');
+$table->align = array('center', 'center', 'left', 'left', 'center');
+$table->width = '*';
+
+$fobj = new stdClass;
+$fobj->para = false;
+
+$prevsection = '';
+
+// TODO: Put this in a renderer.
+foreach ($galleries as $gallery) {
+    $cm = context_module::instance($gallery->coursemodule);
+
+    $printsection = ($gallery->section !== $prevsection ? true : false);
+    if ($printsection) {
+        $table->data[] = 'hr';
+    }
+
+    if (lightboxgallery_rss_enabled() && $gallery->rss) {
+        $rss = rss_get_link($course->id, $USER->id, 'lightboxgallery', $gallery->id, get_string('rsssubscribe', 'lightboxgallery'));
+    }
+
+    $fs = get_file_storage();
+    $files = $fs->get_area_files($cm->id, 'mod_lightboxgallery', 'gallery_images');
+    $imagecount = 0;
+    foreach ($files as $file) {
+        if ($file->get_filename() != '.') {
+            $imagecount++;
+        }
+    }
+    $commentcount = $DB->count_records('lightboxgallery_comments', array('gallery' => $gallery->id));
+
+    $viewurl = new moodle_url('/mod/lightboxgallery/view.php', array('id' => $gallery->coursemodule));
+    $table->data[] = array(($printsection ? $gallery->section : ''),
+                           lightboxgallery_index_thumbnail($course->id, $gallery),
+                           html_writer::link($viewurl, $gallery->name).
+                           '<br />'.get_string('imagecounta', 'lightboxgallery', $imagecount).' '.
+                           get_string('commentcount', 'lightboxgallery', $commentcount),
+                           format_text($gallery->intro, FORMAT_MOODLE, $fobj),
+                           (isset($rss) ? $rss : get_string('norssfeedavailable', 'lightboxgallery')));
+
+    $prevsection = $gallery->section;
+}
+
+echo $OUTPUT->heading(get_string('modulenameplural', 'lightboxgallery'), 2);
+echo html_writer::table($table);
+echo $OUTPUT->footer();
+
diff --git a/mod/lightboxgallery/lang/de/lightboxgallery.php b/mod/lightboxgallery/lang/de/lightboxgallery.php
new file mode 100644
index 0000000..bcce29d
--- /dev/null
+++ b/mod/lightboxgallery/lang/de/lightboxgallery.php
@@ -0,0 +1,138 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+
+/**
+ * German strings for the lightboxgallery module
+ * German strings translated by Ralf Krause, moodleSCHULE e.V.
+ *
+ * @package   mod_lightboxgallery
+ * @copyright 2012 NetSpot Pty Ltd
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+$string['acceptablefiletypebriefing'] = 'Sie können mehrere Bilder gemeinsam in ein ZIP-Archiv packen und dann hochladen. Die Bilder werden automatisch in das Galerieverzeichnis ausgepackt.';
+$string['addcomment'] = 'Kommentar hinzufügen';
+$string['addimage'] = 'Bilder hinzufügen';
+$string['addimage_help'] = 'Wählen Sie ein Bild auf Ihrem Computer aus, das Sie zur aktuellen Galerie hinzufügen möchten.
+
+Sie können mehrere Bilder gemeinsam in ein ZIP-Archiv packen und dann hochladen. Die Bilder werden automatisch im Galerieverzeichnis ausgepackt.';
+$string['autoresize'] = 'Größe automatisch';
+$string['autoresize_help'] = 'Sie können bestimmen, ob und wie Bilder in ihrer Größe verändert werden. Folgende Optionen sind möglich:
+
+* Vollbild: Bilder, die größer als der Anzeigebildschirm sind, werden bei der Darstellung entsprechend verkleinert.
+* Hochladen: Bilder werden beim Hochladen über die Option \'Bilder hinzufügen\' auf die angegebene Größe angepasst und dann gespeichert.
+
+Zusätzlich ist eine Option zur manuellen Größenänderung in der Bildbearbeitung vorhanden.';
+$string['allowcomments'] = 'Kommentare';
+$string['allowrss'] = 'RSS Feeds';
+$string['allpluginsdisabled'] = 'Alle Bearbeitungswerkzeuge sind deaktiviert.';
+$string['backtogallery'] = 'Zurück zur Galerie';
+$string['captionfull'] = 'Titeltext zeigen';
+$string['captionpos'] = 'Titelposition';
+$string['commentadded'] = 'Der Kommentar wurde gespeichert';
+$string['commentcount'] = '{$a} Kommentare';
+$string['commentdelete'] = 'Möchten Sie den Kommentar löschen?';
+$string['configdisabledplugins'] = 'Deaktivierte Werkzeuge';
+$string['configdisabledpluginsdesc'] = 'Wählen Sie die Bearbeitungswerkzeuge aus, die Sie deaktivieren möchten.';
+$string['configenablerssfeeds'] = 'RSS Feeds aktivieren';
+$string['configenablerssfeedsdesc'] = 'RSS Feeds dürfen von Lightbox Galerien erzeugt werden.';
+$string['configimagelifetime'] = 'Bildercache';
+$string['configimagelifetimedesc'] = 'Zeitdauer (in Sekunden), über die die Bilder im Browsercache gespeichert bleiben.';
+$string['configoverwritefiles'] = 'Dateien überschreiben';
+$string['configoverwritefilesdesc'] = 'Dateien überschreiben, wenn neue Bilder mit gleichem Namen hochgeladen werden.';
+$string['configstrictfilenames'] = 'Strenge Dateinamen verwenden';
+$string['configstrictfilenamesdesc'] = 'Force image editor to clean file names according to Moodle naming rules.';
+$string['currentsize'] = 'Aktuelle Größe';
+$string['dimensions'] = 'Größe';
+$string['dirup'] = 'Hoch';
+$string['dirdown'] = 'Runter';
+$string['dirleft'] = 'Links';
+$string['dirright'] = 'Rechts';
+$string['displayinggallery'] = 'Bilder der Galerie: {$a}';
+$string['editimage'] = 'Bild bearbeiten';
+$string['edit_choose'] = 'Auswahl...';
+$string['edit_caption'] = 'Titel';
+$string['edit_crop'] = 'Beschneiden';
+$string['edit_delete'] = 'Löschen';
+$string['edit_flip'] = 'Spiegeln';
+$string['edit_resize'] = 'Größe anpassen';
+$string['edit_resizescale'] = 'Darstellung';
+$string['edit_rotate'] = 'Drehen';
+$string['edit_tag'] = 'Schlagworte';
+$string['edit_thumbnail'] = 'Vorschau';
+$string['errornofile'] = 'Das angeforderte Bild wurde nicht gefunden: {$a}';
+$string['errornoimages'] = 'Keine Bilder in der Galerie gefunden';
+$string['errornosearchresults'] = 'Bei der Suche wurden keine Bilder gefunden';
+$string['erroruploadimage'] = 'Die hochzuladende Datei muss ein Bild sein';
+$string['extendedinfo'] = 'Erweiterte Bildinformationen';
+$string['imageadd'] = 'Bilder hinzufügen';
+$string['imagecount'] = 'Anzahl';
+$string['imagecounta'] = '{$a} Bilder';
+$string['imagedirectory'] = 'Bilderverzeichnis';
+$string['imagedirectory_help'] = 'Wählen Sie das Verzeichnis mit den anzuzeigenden Bildern. Wenn Sie \'Bilder hinzufügen\', werden die neuen Bilder in dieses Verzeichnis hochgeladen.';
+$string['imagedownload'] = 'Bild herunterladen';
+$string['imageresized'] = 'Bildgröße geändert: {$a}';
+$string['images'] = 'Bilder';
+$string['imagesperpage'] = 'Bilder pro Seite';
+$string['imagesperrow'] = 'Bilder pro Zeile';
+$string['imageuploaded'] = 'Hochgeladenes Bild: {$a}';
+$string['lightboxgallery'] = 'Lightbox Galerie';
+$string['lightboxgallery:addcomment'] = 'Kommentar zur Lightbox Galerie hinzufügen';
+$string['lightboxgallery:addimage'] = 'Bild zur Lightbox Galerie hinzufügen';
+$string['lightboxgallery:addinstance'] = 'Lightbox Galerie hinzufügen';
+$string['lightboxgallery:edit'] = 'Lightbox Galerie bearbeiten';
+$string['lightboxgallery:submit'] = 'Lightbox Galerie einreichen';
+$string['lightboxgallery:viewcomments'] = 'Kommentare in Lightbox Galerie sehen';
+$string['makepublic'] = 'Öffentlich machen';
+$string['metadata'] = 'Metadaten';
+$string['modulename'] = 'Lightbox Galerie';
+$string['modulename_help'] = 'Das Modul \'Lightbox Galerie\' erlaubt die Präsentation von Bildern in einer Galerie.
+
+Trainer/innen können eine Lightbox Galerie innerhalb ihres Kurses angelegen, bearbeiten und löschen. Bilder können einzeln und als ZIP-Datei hochgeladen werden. Beim Hinzufügen werden automatisch Miniaturbilder erzeugt und in einer Vorschau verwendet. Mit einem Klick auf ein Minaturbild in der Vorschau erscheint dieses Bild in vergrößerter Darstellung. Von hieraus ist es möglich, innerhalb der Galerie bildweise vorwärts und rückwärts zu blättern. Die Lightbox Skripte zeigen schöne Überblendeffekte beim Öffnen und Blättern.
+
+Nutzer/innen können Kommentare in der Galerie schreiben, wenn die entsprechende Option aktiviert ist.';
+$string['modulenameplural'] = 'Lightbox Galerien';
+$string['modulenameshort'] = 'Galerie';
+$string['modulenameadd'] = 'Lightbox Galerie';
+$string['newgallerycomments'] = 'Neue Kommentare';
+$string['norssfeedavailable'] = 'Kein RSS Feed verfügbar';
+$string['position_bottom'] = 'Unten';
+$string['position_top'] = 'Oben';
+$string['pluginadministration'] = 'Lightbox Administration';
+$string['pluginname'] = 'Lightbox Galerie';
+$string['resizeto'] = 'Größe ändern auf';
+$string['rsssubscribe'] = 'Galerie RSS Feed';
+$string['saveimage'] = '{$a} sichern';
+$string['screen'] = 'Vollbild';
+$string['selectflipmode'] = 'Spiegelmodus wählen';
+$string['selectrotation'] = 'Drehwinkel wählen';
+$string['selectthumbpos'] = 'Offset für Vorschau (von der Mitte aus)';
+$string['setasindex'] = 'Als Indexbild verwenden';
+$string['showall'] = 'Alle anzeigen';
+$string['tagscurrent'] = 'Aktuelle Schlagworte';
+$string['tagsdisabled'] = 'Schlagworte deaktiviert';
+$string['tagsimport'] = 'Schlagworte importieren';
+$string['tagsimportconfirm'] = 'Möchten Sie Schlagworte für jedes Bild in dieser Galerie importieren?';
+$string['tagsimportfinish'] = 'Import von {$a->tags} Schlagworten für {$a->images} Bilder beendet';
+$string['tagsiptc'] = 'IPTC Schlagworte';
+$string['tagspopular'] = 'Beliebte Schlagworte';
+$string['tagsrelated'] = 'Ähnliche Schlagworte';
+$string['thumbnailoffset'] = 'Offset';
+$string['zipextracted'] = 'ZIP-Datei entpackt: {$a}';
+$string['zipnonewfiles'] = 'Keine neuen Bilder gefunden! Bilder dürfen nicht in Unterverzeichnissen des Archivs liegen.';
diff --git a/mod/lightboxgallery/lang/en/help/lightboxgallery/addimage.html b/mod/lightboxgallery/lang/en/help/lightboxgallery/addimage.html
new file mode 100644
index 0000000..ca35723
--- /dev/null
+++ b/mod/lightboxgallery/lang/en/help/lightboxgallery/addimage.html
@@ -0,0 +1,5 @@
+<h1>Adding Images</h1>
+
+<p>Browse for an image on your local machine to add to the current gallery.</p>
+
+<p>You can also select a zip archive containing multiple images, which will be extracted into the image directory after being uploaded.</p>
diff --git a/mod/lightboxgallery/lang/en/help/lightboxgallery/index.html b/mod/lightboxgallery/lang/en/help/lightboxgallery/index.html
new file mode 100644
index 0000000..392c613
--- /dev/null
+++ b/mod/lightboxgallery/lang/en/help/lightboxgallery/index.html
@@ -0,0 +1,8 @@
+<h2>Lightbox Gallery</h2>
+
+<ul>
+  <li><a href="help.php?module=lightboxgallery&file=folder.html">Image Directory</a>
+  <li><a href="help.php?module=lightboxgallery&file=autoresize.html">Resizing Images</a>
+  <li><a href="help.php?module=lightboxgallery&file=addimage.html">Adding Images</a>
+</ul>
+
diff --git a/mod/lightboxgallery/lang/en/help/lightboxgallery/mods.html b/mod/lightboxgallery/lang/en/help/lightboxgallery/mods.html
new file mode 100644
index 0000000..63a5c7c
--- /dev/null
+++ b/mod/lightboxgallery/lang/en/help/lightboxgallery/mods.html
@@ -0,0 +1,5 @@
+<p><img alt="" src="<?php echo($CFG->wwwroot); ?>/mod/lightboxgallery/icon.gif" />&nbsp;<b>Lightbox Gallery</b></p>
+
+<div class="indent">
+A lightbox gallery resource allows you to display multiple images from a directory using the Lightbox2 Javascript libraries. Image editing plugins allow you to resize, crop and rotate images, while the tagging and captioning options allow for searchable images.
+</div>
diff --git a/mod/lightboxgallery/lang/en/lightboxgallery.php b/mod/lightboxgallery/lang/en/lightboxgallery.php
new file mode 100644
index 0000000..c8b0581
--- /dev/null
+++ b/mod/lightboxgallery/lang/en/lightboxgallery.php
@@ -0,0 +1,147 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+
+/**
+ * English strings for the lightboxgallery module
+ *
+ * @package   mod_lightboxgallery
+ * @copyright 2011 John Kelsh
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+$string['acceptablefiletypebriefing'] = 'If you wish to upload multiple files at a time, you can submit a zip file with images inside it and all valid images inside the zip archive will be added to the gallery.';
+$string['addcomment'] = 'Add comment';
+$string['addimage'] = 'Add images';
+$string['addimage_help'] = 'Browse for an image on your local machine to add to the current gallery.
+
+You can also select a zip archive containing multiple images, which will be extracted into the image directory after being uploaded.';
+$string['autoresize'] = 'Automatically resize';
+$string['autoresize_help'] = 'You can control if and how gallery images are resized. The following methods are available when configuring a gallery:
+
+* Screen: images that are bigger than the users screen will be scaled down to fit inside the screen.
+* Upload: images will be resized to specified dimensions when they are uploaded through the \'Add image\' option.
+
+There is also an image resizing plugin included in the image editor, where you can manually resize images.';
+$string['allowcomments'] = 'Allow comments';
+$string['allowrss'] = 'Allow RSS feeds';
+$string['allpluginsdisabled'] = 'Sorry, all the editing plugins are currently disabled.';
+$string['backtogallery'] = 'Back to Gallery';
+$string['captionfull'] = 'Display full caption text?';
+$string['captionpos'] = 'Caption Position';
+$string['commentadded'] = 'Your comment has been posted to the gallery';
+$string['commentcount'] = '{$a} comments';
+$string['commentdelete'] = 'Confirm comment deletion?';
+$string['configdisabledplugins'] = 'Disabled plugins';
+$string['configdisabledpluginsdesc'] = 'Select the image editing plugins you want to disable.';
+$string['configenablerssfeeds'] = 'Enable RSS feeds';
+$string['configenablerssfeedsdesc'] = 'Allow RSS feeds to be generated from galleries.';
+$string['configimagelifetime'] = 'Image lifetime';
+$string['configimagelifetimedesc'] = 'Length of time (in seconds) for images to remain in the browser cache.';
+$string['configoverwritefiles'] = 'Overwrite files';
+$string['configoverwritefilesdesc'] = 'Overwrite images when new images are uploaded with the same filename.';
+$string['configstrictfilenames'] = 'Use strict filenames';
+$string['configstrictfilenamesdesc'] = 'Force image editor to clean file names according to Moodle naming rules.';
+$string['currentsize'] = 'Current size';
+$string['dimensions'] = 'Dimensions';
+$string['dirup'] = 'Up';
+$string['dirdown'] = 'Down';
+$string['dirleft'] = 'Left';
+$string['dirright'] = 'Right';
+$string['displayinggallery'] = 'Showing gallery: {$a}';
+$string['editimage'] = 'Edit image';
+$string['edit_choose'] = 'Choose...';
+$string['edit_caption'] = 'Caption';
+$string['edit_crop'] = 'Crop';
+$string['edit_delete'] = 'Delete';
+$string['edit_flip'] = 'Flip';
+$string['edit_resize'] = 'Resize';
+$string['edit_resizescale'] = 'Scale';
+$string['edit_rotate'] = 'Rotate';
+$string['edit_tag'] = 'Tag';
+$string['edit_thumbnail'] = 'Thumbnail';
+$string['errornofile'] = 'The requested file was not found: {$a}';
+$string['errornoimages'] = 'No images were found in this gallery';
+$string['errornosearchresults'] = 'Your search query returned no images';
+$string['erroruploadimage'] = 'The file you upload must be an image file';
+$string['eventgallerycommentcreated'] = 'Comment created';
+$string['eventgallerysearched'] = 'Gallery searched';
+$string['eventimageupdated'] = 'Image updated';
+$string['eventviewed'] = 'Lightbox gallery viewed';
+$string['extendedinfo'] = 'Show extended image info';
+$string['imageadd'] = 'Add images';
+$string['imagecount'] = 'Image count';
+$string['imagecounta'] = '{$a} images';
+$string['imagedirectory'] = 'Image directory';
+$string['imagedirectory_help'] = 'Select the directory that contains the images you want to display in the gallery. When using the \'Add image\' gallery option, uploaded images will be places in this directory.';
+$string['imagedownload'] = 'Download image';
+$string['imageresized'] = 'Image resized: {$a}';
+$string['images'] = 'Images';
+$string['imagesperpage'] = 'Images per page';
+$string['imagesperrow'] = 'Images per row';
+$string['imageuploaded'] = 'Uploaded image: {$a}';
+$string['invalidlightboxgalleryid'] = 'Invalid lightboxgallery ID';
+$string['lightboxgallery'] = 'Lightbox Gallery';
+$string['lightboxgallery:addcomment'] = 'Add comment to lightbox gallery';
+$string['lightboxgallery:addinstance'] = 'Add a new lightbox gallery';
+$string['lightboxgallery:addimage'] = 'Add image to lightbox gallery';
+$string['lightboxgallery:edit'] = 'Edit a lightbox gallery';
+$string['lightboxgallery:submit'] = 'Submit a lightbox gallery';
+$string['lightboxgallery:viewcomments'] = 'View lightbox gallery comments';
+$string['makepublic'] = 'Make public';
+$string['metadata'] = 'Meta data';
+$string['modulename'] = 'Lightbox Gallery';
+$string['modulename_help'] = 'The Lightbox Gallery resource module enables participants to view a gallery of images.
+
+This resource allows you to create \'Lightbox\' enabled image galleries within your Moodle course.
+
+As a course teacher, you are able to create, edit and delete galleries. Small thumbnails will then be generated, which are used for the thumbnail view of the gallery.
+Clicking on any of the thumbnails brings that image into focus, and allows you to scroll through the gallery at your leisure. Using the Lightbox scripts creates nice transition effects when loading and scrolling through the images.
+
+If enabled, users are able to leave comments on your gallery.';
+$string['modulenameplural'] = 'Lightbox Galleries';
+$string['modulenameshort'] = 'Gallery';
+$string['modulenameadd'] = 'Lightbox gallery';
+$string['newgallerycomments'] = 'New gallery comments';
+$string['nocomments'] = 'No comments';
+$string['norssfeedavailable'] = 'Feed not available';
+$string['position_bottom'] = 'Bottom';
+$string['position_top'] = 'Top';
+$string['pluginadministration'] = 'Lightbox Gallery administration';
+$string['pluginname'] = 'Lightbox Gallery';
+$string['resizeto'] = 'Resize to';
+$string['rsssubscribe'] = 'Gallery RSS feed';
+$string['saveimage'] = 'Save {$a}';
+$string['screen'] = 'Screen';
+$string['search:activity'] = 'Lightboxgallery - activity information';
+$string['selectflipmode'] = 'Select flip mode';
+$string['selectrotation'] = 'Select rotation angle';
+$string['selectthumbpos'] = 'Thumbnail offset (from centre)';
+$string['setasindex'] = 'Set as index image';
+$string['showall'] = 'Show all';
+$string['tagscurrent'] = 'Current tags';
+$string['tagsdisabled'] = 'Tagging editor is disabled';
+$string['tagsimport'] = 'Import tags';
+$string['tagsimportconfirm'] = 'Are you sure you want to import tags from every image in this gallery?';
+$string['tagsimportfinish'] = 'Finished importing {$a->tags} tags from {$a->images} images';
+$string['tagsiptc'] = 'IPTC tags';
+$string['tagspopular'] = 'Popular tags';
+$string['tagsrelated'] = 'Related tags';
+$string['thumbnailoffset'] = 'Offset';
+$string['zipextracted'] = 'Zip file extracted: {$a}';
+$string['zipnonewfiles'] = 'No new images were found - make sure images are in the root directory of the archive';
diff --git a/mod/lightboxgallery/lang/fr/help/lightboxgallery/addimage.html b/mod/lightboxgallery/lang/fr/help/lightboxgallery/addimage.html
new file mode 100644
index 0000000..0049af5
--- /dev/null
+++ b/mod/lightboxgallery/lang/fr/help/lightboxgallery/addimage.html
@@ -0,0 +1,5 @@
+<h1>Ajouter des images</h1>
+
+<p>Naviguez vers une image sur votre machine locale pour l'ajouter à la gallerie en cours</p>
+
+<p>Vous pouvez également sélectionner une archive zip contenant de multiples images. Celles-ci seront extraites dans le dossier image une fois le chargement terminé.</p>
diff --git a/mod/lightboxgallery/lang/fr/help/lightboxgallery/index.html b/mod/lightboxgallery/lang/fr/help/lightboxgallery/index.html
new file mode 100644
index 0000000..519464d
--- /dev/null
+++ b/mod/lightboxgallery/lang/fr/help/lightboxgallery/index.html
@@ -0,0 +1,8 @@
+<h2>Gallerie Lightbox</h2>
+
+<ul>
+  <li><a href="help.php?module=lightboxgallery&file=folder.html">Dossier images</a>
+  <li><a href="help.php?module=lightboxgallery&file=autoresize.html">Redimensionner les images</a>
+  <li><a href="help.php?module=lightboxgallery&file=addimage.html">Ajouter des images</a>
+</ul>
+
diff --git a/mod/lightboxgallery/lang/fr/help/lightboxgallery/mods.html b/mod/lightboxgallery/lang/fr/help/lightboxgallery/mods.html
new file mode 100644
index 0000000..843fb5a
--- /dev/null
+++ b/mod/lightboxgallery/lang/fr/help/lightboxgallery/mods.html
@@ -0,0 +1,5 @@
+<p><img alt="" src="<?php echo($CFG->wwwroot); ?>/mod/lightboxgallery/icon.gif" />&nbsp;<b>Gallerie Lightbox</b></p>
+
+<div class="indent">
+Une gallerie de ressources lightbox vous permet d'afficher plusieurs images d'un dossier en utilisant les librairies Lightbox2 Javascript. Les plugins d'édition d'images vous permettent de redimensionner, tronquer et faire pivoter les images, alors que les options d'annotation et de sous-titre vous permettent une recherche d'images.
+</div>
diff --git a/mod/lightboxgallery/lang/fr/lightboxgallery.php b/mod/lightboxgallery/lang/fr/lightboxgallery.php
new file mode 100644
index 0000000..9dfa064
--- /dev/null
+++ b/mod/lightboxgallery/lang/fr/lightboxgallery.php
@@ -0,0 +1,141 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+
+/**
+ * English strings for the lightboxgallery module
+ *
+ * @package   mod_lightboxgallery
+ * @copyright 2011 John Kelsh
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+$string['acceptablefiletypebriefing'] = 'Si vous désirez charger plusieurs fichiers en une seule fois, vous pouvez utiliser un fichier zip contenant des images. Celles-ci seront automatiquement ajoutées à la gallerie.';
+$string['addcomment'] = 'Ajouter un commentaire';
+$string['addimage'] = 'Ajouter des images';
+$string['addimage_help'] = 'Naviguez vers une image sur votre machine locale pour l\'ajouter à la gallerie en cours.
+
+Vous pouvez également sélectionner une archive zip contenant de multiples images. Celles-ci seront extraites dans le dossier image une fois le chargement terminé.';
+$string['autoresize'] = 'Redimensionnement automatique';
+$string['autoresize_help'] = 'Vous pouvez contrôler si et quand les galleries d\'images sont redimensionnées. Les méthodes suivantes sont disponibles lors de la configuration d\'une gallerie.
+
+* Ecran: les images qui sont plus grandes que l\'écran des utilisateurs seront réduites pour correspondre à la taille de l\'écran.
+* Upload: les images seront redimensionnées aux dimensions spécifiées lors de leur chargement à travers l\'option \'Ajouter des images\'.
+
+Il existe également un plugin de redimensionnement inclus dans l\'éditeur d\'images que vous pouvez utiliser pour redimensionner les images manuellement.';
+$string['allowcomments'] = 'Autoriser les commentaires';
+$string['allowrss'] = 'Autoriser les flux RSS';
+$string['allpluginsdisabled'] = 'Désolé, tous les plugins d\'édition sont actuellement désactivés.';
+$string['backtogallery'] = 'Retour à la gallerie';
+$string['captionfull'] = 'Afficher l\'intégralité du sous-titre?';
+$string['captionpos'] = 'Position du sous-titre';
+$string['commentadded'] = 'Votre commentaire a été posté dans la gallerie';
+$string['commentcount'] = '{$a} commentaires';
+$string['commentdelete'] = 'Confirmer la suppression du commentaire?';
+$string['configdisabledplugins'] = 'Plugins désactivés';
+$string['configdisabledpluginsdesc'] = 'Sélectionnez les plugins d\'édition d\'image que vous souhaitez désactiver.';
+$string['configenablerssfeeds'] = 'Activer les flux RSS';
+$string['configenablerssfeedsdesc'] = 'Autoriser les galleries à générer des flux RSS.';
+$string['configimagelifetime'] = 'Durée de vie de l\'image';
+$string['configimagelifetimedesc'] = 'Durée (en secondes) durant laquelle l\'image restera stockée dans le cache du navigateur.';
+$string['configoverwritefiles'] = 'Remplacer les fichiers';
+$string['configoverwritefilesdesc'] = 'Remplacer les images quand de nouvelles images sont uploadées avec le même nom';
+$string['configstrictfilenames'] = 'Utiliser des noms de fichier stricts';
+$string['configstrictfilenamesdesc'] = 'Forcer l\'éditeur d\'images à nettoyer les noms de fichiers suivant les règles de nomenclature Moodle.';
+$string['currentsize'] = 'Taille actuelle';
+$string['dimensions'] = 'Dimensions';
+$string['dirup'] = 'Haut';
+$string['dirdown'] = 'Bas';
+$string['dirleft'] = 'Gauche';
+$string['dirright'] = 'Droite';
+$string['displayinggallery'] = 'Gallerie d\'affichage: {$a}';
+$string['editimage'] = 'Editer l\'image';
+$string['edit_choose'] = 'Choix...';
+$string['edit_caption'] = 'Sous-titre';
+$string['edit_crop'] = 'Tronquer';
+$string['edit_delete'] = 'Effacer';
+$string['edit_flip'] = 'Mirroir';
+$string['edit_resize'] = 'Redimensionner';
+$string['edit_resizescale'] = 'Taille';
+$string['edit_rotate'] = 'Rotation';
+$string['edit_tag'] = 'Etiquette';
+$string['edit_thumbnail'] = 'Miniature';
+$string['errornofile'] = 'Le fichier requis n\'a pu être trouvé: {$a}';
+$string['errornoimages'] = 'Aucune image n\'a été trouvée dans cette gallerie';
+$string['errornosearchresults'] = 'Votre requête n\'a retourné aucune image';
+$string['erroruploadimage'] = 'Le fichier que vous uploadez doit être un fichier image';
+$string['extendedinfo'] = 'Afficher toutes les informations sur l\'image';
+$string['imageadd'] = 'Ajouter des images';
+$string['imagecount'] = 'Compter les images';
+$string['imagecounta'] = '{$a} images';
+$string['imagedirectory'] = 'Dossier images';
+$string['imagedirectory_help'] = 'Sélectionner le répertoire qui contient les images que vous voulez afficher dans la gallerie. Lorsque vous utilisez l\'option \'Ajouter des images\', les images chargées seront placées dans ce répértoire.';
+$string['imagedownload'] = 'Télécharger l\'image';
+$string['imageresized'] = 'Image redimensionnée: {$a}';
+$string['images'] = 'Images';
+$string['imagesperpage'] = 'Images par page';
+$string['imagesperrow'] = 'Images par ligne';
+$string['imageuploaded'] = 'Image uploadée: {$a}';
+$string['invalidquizid'] = 'Lightboxgallery ID invalide';
+$string['lightboxgallery'] = 'Gallerie Lightbox';
+$string['lightboxgallery:addcomment'] = 'Ajouter un commentaire à la gallerie lightbox';
+$string['lightboxgallery:addinstance'] = 'Ajouter une nouvelle gallerie lightbox';
+$string['lightboxgallery:addimage'] = 'Ajouter une image à la gallerie lightbox';
+$string['lightboxgallery:edit'] = 'Editer une gallerie lightbox';
+$string['lightboxgallery:submit'] = 'Publier une gallerie lightbox';
+$string['lightboxgallery:viewcomments'] = 'Voir les commentaires de la gallerie lightbox';
+$string['makepublic'] = 'Rendre publique';
+$string['metadata'] = 'Données meta';
+$string['modulename'] = 'Gallerie Lightbox';
+$string['modulename_help'] = 'Le module lightboxgallery permet aux partipants de voir une gallerie d\'images.
+
+Cette ressource vous permet de créer des galleries d\'images \'Lightbox\' dans votre cours Moodle.
+
+En tant qu\'enseignant, vous avez la possibilité de créer, éditer et effacer des galleries. Des miniatures seront générées et seront utilisées pour l\'affichage de la gallerie.
+Un clic sur l\'une de ces miniatures donnera le focus à l\'image sélectionnée et permettra de faire défiler la gallerie à votre guise. Utiliser les scripts Lightbox permet d\'obtenir de jolis effets de transition au chargement et au défilement des images.
+
+Si activé, les utilisateurs seront capable de laisser des commentaires sur votre gallerie.';
+$string['modulenameplural'] = 'Galleries Lightbox';
+$string['modulenameshort'] = 'Gallerie';
+$string['modulenameadd'] = 'Gallerie Lightbox';
+$string['newgallerycomments'] = 'Nouveau commentaire de gallerie';
+$string['norssfeedavailable'] = 'Flux inaccessible';
+$string['position_bottom'] = 'Bas';
+$string['position_top'] = 'Haut';
+$string['pluginadministration'] = 'Administration de la gallerie Lightbox';
+$string['pluginname'] = 'Lightbox Gallery';
+$string['resizeto'] = 'Redimmensionner à';
+$string['rsssubscribe'] = 'Flux RSS de la gallerie';
+$string['saveimage'] = 'Enregistrer {$a}';
+$string['screen'] = 'Ecran';
+$string['selectflipmode'] = 'Sélectionner un mode mirroir';
+$string['selectrotation'] = 'Sélectionner un angle de rotation';
+$string['selectthumbpos'] = 'Décalage des miniatures (depuis le centre)';
+$string['setasindex'] = 'Définir comme image d\'index';
+$string['showall'] = 'Tout montrer';
+$string['tagscurrent'] = 'Etiquettes actuelles';
+$string['tagsdisabled'] = 'L\'éditeur d\'étiquettes est désactivé';
+$string['tagsimport'] = 'Importer des étiquettes';
+$string['tagsimportconfirm'] = 'Etes vous certain de vouloir importer les étiquettes de toutes les images de cette gallerie?';
+$string['tagsimportfinish'] = 'Importation de {$a->tags} étiquettes provenant de {$a->images} terminées';
+$string['tagsiptc'] = 'Etiquettes IPTC';
+$string['tagspopular'] = 'Etiquettes populaires';
+$string['tagsrelated'] = 'Etiquettes liées';
+$string['thumbnailoffset'] = 'Décalage';
+$string['zipextracted'] = 'Fichier zip extrait: {$a}';
+$string['zipnonewfiles'] = 'Aucune nouvelle image trouvée - vérifiez que les images sont bien dans le dossier racine ou dans l\'archive';
diff --git a/mod/lightboxgallery/lib.php b/mod/lightboxgallery/lib.php
new file mode 100644
index 0000000..a05dbbd
--- /dev/null
+++ b/mod/lightboxgallery/lib.php
@@ -0,0 +1,483 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+
+/**
+ * Library of interface functions and constants for module newmodule
+ *
+ * All the core Moodle functions, neeeded to allow the module to work
+ * integrated in Moodle should be placed here.
+ * All the newmodule specific functions, needed to implement all the module
+ * logic, should go to locallib.php. This will help to save some memory when
+ * Moodle is performing actions across all modules.
+ *
+ * @package   mod_lightboxgallery
+ * @copyright 2011 John Kelsh
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+require_once($CFG->libdir.'/filelib.php');
+require_once(dirname(__FILE__).'/locallib.php');
+
+function lightboxgallery_supports($feature) {
+    switch($feature) {
+        case FEATURE_MOD_ARCHETYPE:
+            return MOD_ARCHETYPE_RESOURCE;
+        case FEATURE_GROUPS:
+            return false;
+        case FEATURE_GROUPINGS:
+            return false;
+        case FEATURE_MOD_INTRO:
+            return true;
+        case FEATURE_COMPLETION_TRACKS_VIEWS:
+            return true;
+        case FEATURE_GRADE_HAS_GRADE:
+            return false;
+        case FEATURE_GRADE_OUTCOMES:
+            return false;
+        case FEATURE_BACKUP_MOODLE2:
+            return true;
+
+        default:
+            return null;
+    }
+}
+
+/**
+ * Given an object containing all the necessary data,
+ * (defined by the form in mod_form.php) this function
+ * will create a new instance and return the id number
+ * of the new instance.
+ *
+ * @param object $gallery An object from the form in mod_form.php
+ * @return int The id of the newly inserted newmodule record
+ */
+function lightboxgallery_add_instance($gallery) {
+    global $DB;
+
+    $gallery->timemodified = time();
+
+    if (!lightboxgallery_rss_enabled()) {
+        $gallery->rss = 0;
+    }
+
+    lightboxgallery_set_sizing($gallery);
+
+    return $DB->insert_record('lightboxgallery', $gallery);
+}
+
+/**
+ * Given an object containing all the necessary data,
+ * (defined by the form in mod_form.php) this function
+ * will update an existing instance with new data.
+ *
+ * @param object $gallery An object from the form in mod_form.php
+ * @return boolean Success/Fail
+ */
+function lightboxgallery_update_instance($gallery) {
+    global $DB;
+
+    $gallery->timemodified = time();
+    $gallery->id = $gallery->instance;
+
+    if (!lightboxgallery_rss_enabled()) {
+        $gallery->rss = 0;
+    }
+
+    lightboxgallery_set_sizing($gallery);
+
+    return $DB->update_record('lightboxgallery', $gallery);
+}
+
+/**
+ * Given a gallery object from mod_form, determine the autoresize and resize params.
+ *
+ * @param object $gallery
+ * @return void
+ */
+function lightboxgallery_set_sizing($gallery) {
+    if (isset($gallery->autoresizedisabled)) {
+        $gallery->autoresize = 0;
+        $gallery->resize = 0;
+    }
+}
+
+/**
+ * Given an ID of an instance of this module,
+ * this function will permanently delete the instance
+ * and any data that depends on it.
+ *
+ * @param int $id Id of the module instance
+ * @return boolean Success/Failure
+ */
+function lightboxgallery_delete_instance($id) {
+    global $DB;
+
+    if (!$gallery = $DB->get_record('lightboxgallery', array('id' => $id))) {
+        return false;
+    }
+
+    $cm = get_coursemodule_from_instance('lightboxgallery', $gallery->id);
+    $context = context_module::instance($cm->id);
+    // Files.
+    $fs = get_file_storage();
+    $fs->delete_area_files($context->id, 'mod_lightboxgallery');
+
+    // Delete all the records and fields.
+    $DB->delete_records('lightboxgallery_comments', array('gallery' => $gallery->id) );
+    $DB->delete_records('lightboxgallery_image_meta', array('gallery' => $gallery->id));
+
+    // Delete the instance itself.
+    $DB->delete_records('lightboxgallery', array('id' => $id));
+
+    return true;
+}
+
+/**
+ * Print a detailed representation of what a user has done with
+ * a given particular instance of this module, for user activity reports.
+ *
+ * @return boolean
+ * @todo Finish documenting this function
+ */
+function lightboxgallery_user_complete($course, $user, $mod, $resource) {
+    global $DB, $CFG;
+
+    $sql = "SELECT c.*
+              FROM {lightboxgallery_comments} c
+                   JOIN {lightboxgallery} l ON l.id = c.gallery
+                   JOIN {user}            u ON u.id = c.userid
+             WHERE l.id = :mod AND u.id = :userid
+          ORDER BY c.timemodified ASC";
+    $params = array('mod' => $mod->instance, 'userid' => $user->id);
+    if ($comments = $DB->get_records_sql($sql, $params)) {
+        $cm = get_coursemodule_from_id('lightboxgallery', $mod->id);
+        $context = context_module::instance($cm->id);
+        foreach ($comments as $comment) {
+            lightboxgallery_print_comment($comment, $context);
+        }
+    } else {
+        print_string('nocomments', 'lightboxgallery');
+    }
+}
+
+/**
+ * Returns all other caps used in module
+ *
+ * @return array
+ */
+function lightboxgallery_get_extra_capabilities() {
+    return array('moodle/course:viewhiddenactivities');
+}
+
+function lightboxgallery_get_recent_mod_activity(&$activities, &$index, $timestart, $courseid, $cmid, $userid=0, $groupid=0) {
+    global $DB, $CFG, $COURSE;
+
+    if ($COURSE->id == $courseid) {
+        $course = $COURSE;
+    } else {
+        $course = $DB->get_record('course', array('id' => $courseid));
+    }
+
+    $modinfo = get_fast_modinfo($course);
+
+    $cm = $modinfo->cms[$cmid];
+
+    $userfields = user_picture::fields('u', null, 'userid');
+    $userfieldsnoalias = user_picture::fields();
+    $sql = "SELECT c.*, l.name, $userfields
+              FROM {lightboxgallery_comments} c
+                   JOIN {lightboxgallery} l ON l.id = c.gallery
+                   JOIN {user}            u ON u.id = c.userid
+             WHERE c.timemodified > ? AND l.id = ?
+                   " . ($userid ? "AND u.id = ?" : '') . "
+          ORDER BY c.timemodified ASC";
+    $params = [$timestart, $cm->instance];
+    if ($userid) {
+        $params[] = $userid;
+    }
+    if ($comments = $DB->get_records_sql($sql, $params)) {
+        foreach ($comments as $comment) {
+            $display = lightboxgallery_resize_text(trim(strip_tags($comment->commenttext)), MAX_COMMENT_PREVIEW);
+
+            $activity = new stdClass();
+
+            $activity->type         = 'lightboxgallery';
+            $activity->cmid         = $cm->id;
+            $activity->name         = format_string($cm->name, true);
+            $activity->sectionnum   = $cm->sectionnum;
+            $activity->timestamp    = $comment->timemodified;
+
+            $activity->content = new stdClass();
+            $activity->content->id      = $comment->id;
+            $activity->content->comment = $display;
+
+            $activity->user = new stdClass();
+            $activity->user->id = $comment->userid;
+
+            $fields = explode(',', $userfieldsnoalias);
+            foreach ($fields as $field) {
+                if ($field == 'id') {
+                    continue;
+                }
+                $activity->user->$field = $comment->$field;
+            }
+
+            $activities[$index++] = $activity;
+
+        }
+    }
+    return true;
+}
+
+function lightboxgallery_print_recent_mod_activity($activity, $courseid, $detail, $modnames, $viewfullnames) {
+    global $CFG, $OUTPUT;
+
+    $userviewurl = new moodle_url('/user/view.php', array('id' => $activity->user->id, 'course' => $courseid));
+    echo '<table border="0" cellpadding="3" cellspacing="0">'.
+         '<tr><td class="userpicture" valign="top">'.$OUTPUT->user_picture($activity->user, array('courseid' => $courseid)).
+         '</td><td>'.
+         '<div class="title">'.
+         ($detail ? '<img src="'.$CFG->modpixpath.'/'.$activity->type.'/icon.gif" class="icon" alt="'.s($activity->name).'" />' : ''
+         ).
+         '<a href="'.$CFG->wwwroot.'/mod/lightboxgallery/view.php?id='.$activity->cmid.'#c'.$activity->content->id.'">'.
+         $activity->content->comment.'</a>'.
+         '</div>'.
+         '<div class="user"> '.
+         html_writer::link($userviewurl, fullname($activity->user, $viewfullnames)).
+         ' - '.userdate($activity->timestamp).
+         '</div>'.
+         '</td></tr></table>';
+
+    return true;
+}
+
+/**
+ * Given a course and a time, this module should find recent activity
+ * that has occurred in newmodule activities and print it out.
+ * Return true if there was output, or false is there was none.
+ *
+ * @return boolean
+ * @todo Finish documenting this function
+ */
+function lightboxgallery_print_recent_activity($course, $viewfullnames, $timestart) {
+    global $DB, $CFG, $OUTPUT;
+
+    $userfields = get_all_user_name_fields(true, 'u');
+    $sql = "SELECT c.*, l.name, $userfields
+              FROM {lightboxgallery_comments} c
+                   JOIN {lightboxgallery} l ON l.id = c.gallery
+                   JOIN {user}            u ON u.id = c.userid
+             WHERE c.timemodified > ? AND l.course = ?
+          ORDER BY c.timemodified ASC";
+    $params = [$timestart, $course->id];
+
+    if ($comments = $DB->get_records_sql($sql, $params)) {
+        echo $OUTPUT->heading(get_string('newgallerycomments', 'lightboxgallery').':', 3);
+
+        echo '<ul class="unlist">';
+
+        foreach ($comments as $comment) {
+            $display = lightboxgallery_resize_text(trim(strip_tags($comment->commenttext)), MAX_COMMENT_PREVIEW);
+
+            $output = '<li>'.
+                 ' <div class="head">'.
+                 '  <div class="date">'.userdate($comment->timemodified, get_string('strftimerecent')).'</div>'.
+                 '  <div class="name">'.fullname($comment, $viewfullnames).' - '.format_string($comment->name).'</div>'.
+                 ' </div>'.
+                 ' <div class="info">'.
+                 '  "<a href="'.$CFG->wwwroot.'/mod/lightboxgallery/view.php?l='.$comment->gallery.'#c'.$comment->id.'">'.
+                 $display.'</a>"'.
+                 ' </div>'.
+                 '</li>';
+            echo $output;
+        }
+
+        echo '</ul>';
+
+    }
+
+    return true;
+}
+
+/**
+ * Must return an array of users who are participants for a given instance
+ * of newmodule. Must include every user involved in the instance,
+ * independient of his role (student, teacher, admin...). The returned
+ * objects must contain at least id property.
+ * See other modules as example.
+ *
+ * @param int $newmoduleid ID of an instance of this module
+ * @return boolean|array false if no participants, array of objects otherwise
+ */
+function lightboxgallery_get_participants($galleryid) {
+    global $DB, $CFG;
+
+    return $DB->get_records_sql("SELECT DISTINCT u.id, u.id
+                                   FROM {user} u,
+                                        {lightboxgallery_comments} c
+                                  WHERE c.gallery = ? AND u.id = c.userid", [$galleryid]);
+}
+
+function lightboxgallery_get_view_actions() {
+    return array('view', 'view all', 'search');
+}
+
+function lightboxgallery_get_post_actions() {
+    return array('comment', 'addimage', 'editimage');
+}
+
+/**
+ * Serves gallery images and other files.
+ *
+ * @param object $course
+ * @param object $cm
+ * @param object $context
+ * @param string $filearea
+ * @param array $args
+ * @param bool $forcedownload
+ * @return bool false if file not found, does not return if found - just send the file
+ */
+function lightboxgallery_pluginfile($course, $cm, $context, $filearea, $args, $forcedownload) {
+    global $CFG, $DB, $USER;
+
+    require_once($CFG->libdir.'/filelib.php');
+
+    $gallery = $DB->get_record('lightboxgallery', array('id' => $cm->instance));
+    if (!$gallery->ispublic) {
+        require_login($course, false, $cm);
+    }
+
+    $relativepath = implode('/', $args);
+    $fullpath = '/'.$context->id.'/mod_lightboxgallery/'.$filearea.'/'.$relativepath;
+
+    $fs = get_file_storage();
+    if (!$file = $fs->get_file_by_hash(sha1($fullpath)) or $file->is_directory()) {
+        return false;
+    }
+
+    send_stored_file($file, 0, 0, true); // Download MUST be forced - security!
+
+    return;
+
+}
+
+
+/**
+ * Lists all browsable file areas
+ * @param object $course
+ * @param object $cm
+ * @param object $context
+ * @return array
+ */
+function lightboxgallery_get_file_areas($course, $cm, $context) {
+    $areas = array();
+    $areas['gallery_images'] = get_string('images', 'lightboxgallery');
+
+    return $areas;
+}
+
+/**
+ * File browsing support for lightboxgallery module content area.
+ * @param object $browser
+ * @param object $areas
+ * @param object $course
+ * @param object $cm
+ * @param object $context
+ * @param string $filearea
+ * @param int $itemid
+ * @param string $filepath
+ * @param string $filename
+ * @return object file_info instance or null if not found
+ */
+function lightboxgallery_get_file_info($browser, $areas, $course, $cm, $context, $filearea, $itemid, $filepath, $filename) {
+    global $CFG;
+
+    if ($filearea === 'gallery_images') {
+        $fs = get_file_storage();
+
+        $filepath = is_null($filepath) ? '/' : $filepath;
+        $filename = is_null($filename) ? '.' : $filename;
+        if (!$storedfile = $fs->get_file($context->id, 'mod_lightboxgallery', 'gallery_images', 0, $filepath, $filename)) {
+            if ($filepath === '/' and $filename === '.') {
+                $storedfile = new virtual_root_file($context->id, 'mod_lightboxgallery', 'gallery_images', 0);
+            } else {
+                // Not found.
+                return null;
+            }
+        }
+
+        require_once("$CFG->dirroot/mod/lightboxgallery/locallib.php");
+        $urlbase = $CFG->wwwroot.'/pluginfile.php';
+
+        return new lightboxgallery_content_file_info($browser, $context, $storedfile, $urlbase, $areas[$filearea],
+                                                        true, true, false, false);
+    }
+
+    return null;
+}
+
+/**
+ * Trim inputted text to the given maximum length.
+ * @param string $text
+ * @param int $length
+ * @return string The trimmed string with a '...' appended for display.
+ */
+function lightboxgallery_resize_text($text, $length) {
+    return core_text::strlen($text) > $length ? core_text::substr($text, 0, $length) . '...' : $text;
+}
+
+/**
+ * Output the HTML for a comment in the given context.
+ * @param object $comment The comment record to output
+ * @param object $context The context from which this is being displayed
+ */
+function lightboxgallery_print_comment($comment, $context) {
+    global $DB, $CFG, $COURSE, $OUTPUT;
+
+    // TODO: Move to renderer!
+
+    $user = $DB->get_record('user', array('id' => $comment->userid));
+
+    $deleteurl = new moodle_url('/mod/lightboxgallery/comment.php', array('id' => $comment->gallery, 'delete' => $comment->id));
+
+    echo '<table cellspacing="0" width="50%" class="boxaligncenter datacomment forumpost">'.
+         '<tr class="header"><td class="picture left">'.$OUTPUT->user_picture($user, array('courseid' => $COURSE->id)).'</td>'.
+         '<td class="topic starter" align="left"><a name="c'.$comment->id.'"></a><div class="author">'.
+         '<a href="'.$CFG->wwwroot.'/user/view.php?id='.$user->id.'&amp;course='.$COURSE->id.'">'.
+         fullname($user, has_capability('moodle/site:viewfullnames', $context)).'</a> - '.userdate($comment->timemodified).
+         '</div></td></tr>'.
+         '<tr><td class="left side">'.
+    // TODO: user_group picture?
+         '</td><td class="content" align="left">'.
+         format_text($comment->commenttext, FORMAT_MOODLE).
+         '<div class="commands">'.
+         (has_capability('mod/lightboxgallery:edit', $context) ? html_writer::link($deleteurl, get_string('delete')) : '').
+         '</div>'.
+         '</td></tr></table>';
+}
+
+/**
+ * Determine if RSS feeds are enabled for this lightboxgallery
+ * @return bool True if enabled, false otherwise
+ */
+function lightboxgallery_rss_enabled() {
+    global $CFG;
+
+    return ($CFG->enablerssfeeds && get_config('lightboxgallery', 'enablerssfeeds'));
+}
diff --git a/mod/lightboxgallery/locallib.php b/mod/lightboxgallery/locallib.php
new file mode 100644
index 0000000..2094f96
--- /dev/null
+++ b/mod/lightboxgallery/locallib.php
@@ -0,0 +1,221 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+
+/**
+ * Internal library of functions for module lightboxgallery
+ *
+ * All the newmodule specific functions, needed to implement the module
+ * logic, should go here. Never include this file from your lib.php!
+ *
+ * @package   mod_lightboxgallery
+ * @copyright 2011 NetSpot Pty Ltd
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+require_once(dirname(__FILE__).'/lib.php');
+require_once("$CFG->libdir/filelib.php");
+
+define('THUMB_WIDTH', 150);
+define('THUMB_HEIGHT', 150);
+define('MAX_IMAGE_LABEL', 13);
+define('MAX_COMMENT_PREVIEW', 20);
+
+define('AUTO_RESIZE_SCREEN', 1);
+define('AUTO_RESIZE_UPLOAD', 2);
+define('AUTO_RESIZE_BOTH', 3);
+
+/**
+ * Add a set of uploaded files to the gallery.
+ *
+ * @param array $files A list of stored_file objects.
+ * @param context $context
+ * @param cm_info $cm
+ * @param $gallery
+ * @param int $resize
+ * @access public
+ * @return void
+ */
+function lightboxgallery_add_images($files, $context, $cm, $gallery, $resize = 0) {
+    require_once(dirname(__FILE__).'/imageclass.php');
+
+    $fs = get_file_storage();
+
+    $images = array();
+    foreach ($files as $storedfile) {
+        if ($storedfile->get_mimetype() == 'application/zip') {
+            // Unpack.
+            $packer = get_file_packer('application/zip');
+            $fs->delete_area_files($context->id, 'mod_lightboxgallery', 'unpacktemp', 0);
+            $storedfile->extract_to_storage($packer, $context->id, 'mod_lightboxgallery', 'unpacktemp', 0, '/');
+            $images = $fs->get_area_files($context->id, 'mod_lightboxgallery', 'unpacktemp', 0);
+            $storedfile->delete();
+        } else {
+            $images[] = $storedfile;
+        }
+    }
+
+    foreach ($images as $storedfile) {
+        if ($storedfile->is_valid_image()) {
+            $filename = $storedfile->get_filename();
+            $fileinfo = array(
+                'contextid'     => $context->id,
+                'component'     => 'mod_lightboxgallery',
+                'filearea'      => 'gallery_images',
+                'itemid'        => 0,
+                'filepath'      => '/',
+                'filename'      => $filename
+            );
+            if (!$fs->get_file($context->id, 'mod_lightboxgallery', 'gallery_images', 0, '/', $filename)) {
+                $storedfile = $fs->create_file_from_storedfile($fileinfo, $storedfile);
+                $image = new lightboxgallery_image($storedfile, $gallery, $cm);
+
+                if ($resize > 0) {
+                    $resizeoptions = lightboxgallery_resize_options();
+                    list($width, $height) = explode('x', $resizeoptions[$resize]);
+                    $image->resize_image($width, $height);
+                }
+
+                $image->set_caption($filename);
+            }
+        }
+    }
+    $fs->delete_area_files($context->id, 'mod_lightboxgallery', 'unpacktemp', 0);
+}
+
+function lightboxgallery_config_defaults() {
+    $defaults = array(
+        'disabledplugins' => '',
+        'enablerssfeeds' => 0,
+    );
+
+    $localcfg = get_config('lightboxgallery');
+
+    foreach ($defaults as $name => $value) {
+        if (! isset($localcfg->$name)) {
+            set_config($name, $value, 'lightboxgallery');
+        }
+    }
+}
+
+function lightboxgallery_edit_types($showall = false) {
+    $result = array();
+
+    $disabledplugins = explode(',', get_config('lightboxgallery', 'disabledplugins'));
+
+    // TODO: Remove this once crop functionality is working.
+    $disabledplugins[] = 'crop';
+
+    $edittypes = get_list_of_plugins('mod/lightboxgallery/edit');
+
+    foreach ($edittypes as $edittype) {
+        if ($showall || !in_array($edittype, $disabledplugins)) {
+            $result[$edittype] = get_string('edit_' . $edittype, 'lightboxgallery');
+        }
+    }
+
+    return $result;
+}
+
+function lightboxgallery_print_tags($heading, $tags, $courseid, $galleryid) {
+    global $OUTPUT;
+
+    echo $OUTPUT->box_start();
+
+    echo '<form action="search.php" style="float: right; margin-left: 4px;">'.
+         ' <fieldset class="invisiblefieldset">'.
+         '  <input type="hidden" name="id" value="'.$courseid.'" />'.
+         '  <input type="hidden" name="gallery" value="'.$galleryid.'" />'.
+         '  <input type="text" name="search" size="8" />'.
+         '  <input type="submit" value="'.get_string('search').'" />'.
+         ' </fieldset>'.
+         '</form>'.
+         $heading.': ';
+
+    $tagarray = array();
+    foreach ($tags as $tag) {
+        $tagparams = array('id' => $courseid, 'gallery' => $galleryid, 'search' => stripslashes($tag->description));
+        $tagurl = new moodle_url('/mod/lightboxgallery/search.php', $tagparams);
+        $tagarray[] = html_writer::link($tagurl, s($tag->description), array('class' => 'taglink'));
+    }
+
+    echo implode(', ', $tagarray);
+
+    echo $OUTPUT->box_end();
+}
+
+function lightboxgallery_resize_options() {
+    return array(1 => '1280x1024', 2 => '1024x768', 3 => '800x600', 4 => '640x480');
+}
+
+function lightboxgallery_index_thumbnail($courseid, $gallery, $newimage = null) {
+    global $CFG;
+
+    require_once(dirname(__FILE__).'/imageclass.php');
+    $cm = get_coursemodule_from_instance("lightboxgallery", $gallery->id, $courseid);
+    $context = context_module::instance($cm->id);
+
+    $imageid = 'Gallery Index Image';
+
+    $fs = get_file_storage();
+    $storedfile = $fs->get_file($context->id, 'mod_lightboxgallery', 'gallery_index', '0', '/', 'index.png');
+
+    if (!is_null($newimage) && is_object($storedfile)) { // Delete any existing index.
+        $storedfile->delete();
+    }
+    if (is_object($storedfile) && is_null($newimage)) {
+        // Grab the index.
+        $index = $storedfile;
+    } else {
+        // Get first image and create an index for that.
+        if (is_null($newimage)) {
+            $files = $fs->get_area_files($context->id, 'mod_lightboxgallery', 'gallery_images');
+            $file = array_shift($files);
+            while (substr($file->get_mimetype(), 0, 6) != 'image/') {
+                $file = array_shift($files);
+            }
+            $image = new lightboxgallery_image($file, $gallery, $cm);
+        } else {
+            $image = $newimage;
+        }
+        $index = $image->create_index();
+    }
+    $path = $CFG->wwwroot.'/pluginfile.php/'.$context->id.'/mod_lightboxgallery/gallery_index/'.
+                $index->get_itemid().$index->get_filepath().$index->get_filename();
+
+    return '<img src="' . $path . '" alt="" ' . (! empty($imageid) ? 'id="' . $imageid . '"' : '' )  . ' />';
+}
+
+
+/**
+ * File browsing support class
+ */
+class lightboxgallery_content_file_info extends file_info_stored {
+    public function get_parent() {
+        if ($this->lf->get_filepath() === '/' and $this->lf->get_filename() === '.') {
+            return $this->browser->get_file_info($this->context);
+        }
+        return parent::get_parent();
+    }
+    public function get_visible_name() {
+        if ($this->lf->get_filepath() === '/' and $this->lf->get_filename() === '.') {
+            return $this->topvisiblename;
+        }
+        return parent::get_visible_name();
+    }
+}
diff --git a/mod/lightboxgallery/mod_form.php b/mod/lightboxgallery/mod_form.php
new file mode 100644
index 0000000..79c04fa
--- /dev/null
+++ b/mod/lightboxgallery/mod_form.php
@@ -0,0 +1,145 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+
+/**
+ * The main newmodule configuration form
+ *
+ * It uses the standard core Moodle formslib. For more info about them, please
+ * visit: http://docs.moodle.org/en/Development:lib/formslib.php
+ *
+ * @package   mod_lightboxgallery
+ * @copyright 2011 John Kelsh <john.kelsh@netspot.com.au>
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+require_once(dirname(__FILE__).'/locallib.php');
+require_once($CFG->dirroot.'/course/moodleform_mod.php');
+
+class mod_lightboxgallery_mod_form extends moodleform_mod {
+
+    public function definition() {
+
+        global $CFG;
+
+        $mform =& $this->_form;
+
+        // General options.
+
+        $mform->addElement('header', 'general', get_string('general', 'form'));
+
+        $mform->addElement('text', 'name', get_string('name'), array('size' => '48', 'maxlength' => '255'));
+        $mform->setType('name', PARAM_TEXT);
+        $mform->addRule('name', null, 'required', null, 'client');
+        $mform->addRule('name', get_string('maximumchars', '', 255), 'maxlength', 255, 'client');
+
+        if ($CFG->branch < 29) {
+            $this->add_intro_editor(true, get_string('description'));
+        } else {
+            $this->standard_intro_elements();
+        }
+
+        // Advanced options.
+
+        $mform->addElement('header', 'galleryoptions', get_string('advanced'));
+
+        $mform->addElement('select', 'perpage', get_string('imagesperpage', 'lightboxgallery'), $this->get_perpage_options());
+        $mform->setType('perpage', PARAM_INT);
+
+        $yesno = array(0 => get_string('no'), 1 => get_string('yes'));
+
+        $mform->addElement('select', 'captionfull', get_string('captionfull', 'lightboxgallery'), $yesno);
+
+        $captionposopts = array(
+            '0' => get_string('position_bottom', 'lightboxgallery'),
+            '1' => get_string('position_top', 'lightboxgallery'),
+            '2' => get_string('hide'),
+        );
+        $mform->addElement('select', 'captionpos', get_string('captionpos', 'lightboxgallery'), $captionposopts);
+
+        $autoresize = $mform->createElement('select', 'autoresize', get_string('autoresize', 'lightboxgallery'),
+                                $this->get_autoresize_options());
+        $autoresizegroup = array();
+        $autoresizegroup[] = $mform->createElement('select', 'autoresize', get_string('autoresize', 'lightboxgallery'),
+                                $this->get_autoresize_options());
+        $autoresizegroup[] = $mform->createElement('checkbox', 'autoresizedisabled', null, get_string('disable'));
+        $mform->addGroup($autoresizegroup, 'autoresizegroup', get_string('autoresize', 'lightboxgallery'), ' ', false);
+        $mform->setType('autoresize', PARAM_INT);
+        $mform->disabledIf('autoresizegroup', 'autoresizedisabled', 'checked');
+        $mform->addHelpButton('autoresizegroup', 'autoresize', 'lightboxgallery');
+
+        $mform->addElement('select', 'resize', sprintf('%s (%s)', get_string('edit_resize', 'lightboxgallery'),
+                            core_text::strtolower(get_string('upload'))), lightboxgallery_resize_options());
+        $mform->setType('resize', PARAM_INT);
+        $mform->disabledIf('resize', 'autoresize', 'eq', 1);
+        $mform->disabledIf('resize', 'autoresizedisabled', 'checked');
+
+        $mform->addElement('select', 'comments', get_string('allowcomments', 'lightboxgallery'), $yesno);
+        $mform->setType('comments', PARAM_INT);
+
+        $mform->addElement('select', 'ispublic', get_string('makepublic', 'lightboxgallery'), $yesno);
+        $mform->setType('ispublic', PARAM_INT);
+
+        if (lightboxgallery_rss_enabled()) {
+            $mform->addElement('select', 'rss', get_string('allowrss', 'lightboxgallery'), $yesno);
+            $mform->setType('rss', PARAM_INT);
+        } else {
+            $mform->addElement('static', 'rssdisabled', get_string('allowrss', 'lightboxgallery'),
+                                get_string('rssglobaldisabled', 'admin'));
+        }
+
+        $mform->addElement('select', 'extinfo', get_string('extendedinfo', 'lightboxgallery'), $yesno);
+        $mform->setType('extinfo', PARAM_INT);
+
+        // Module options.
+
+        $features = array('groups' => false, 'groupings' => false, 'groupmembersonly' => false,
+                          'outcomes' => false, 'gradecat' => false, 'idnumber' => false);
+
+        $this->standard_coursemodule_elements($features);
+
+        $this->add_action_buttons();
+
+    }
+
+    public function data_preprocessing(&$defaults) {
+        if (!isset($this->current->add)) {
+            $defaults['autoresizedisabled'] = isset($defaults['autoresize']) && $defaults['autoresize'] ? 0 : 1;
+        }
+    }
+
+    // Custom functions.
+
+    private function get_perpage_options() {
+        $perpages = array(10, 25, 50, 100, 200);
+        $result = array(0 => get_string('showall', 'lightboxgallery'));
+        foreach ($perpages as $perpage) {
+            $result[$perpage] = $perpage;
+        }
+        return $result;
+    }
+
+    private function get_autoresize_options() {
+        $screen = get_string('screen', 'lightboxgallery');
+        $upload = get_string('upload');
+        return array(AUTO_RESIZE_SCREEN => $screen,
+                     AUTO_RESIZE_UPLOAD => $upload,
+                     AUTO_RESIZE_BOTH   => $screen . ' &amp; ' . $upload);
+    }
+}
+
diff --git a/mod/lightboxgallery/module.js b/mod/lightboxgallery/module.js
new file mode 100644
index 0000000..fa8a188
--- /dev/null
+++ b/mod/lightboxgallery/module.js
@@ -0,0 +1 @@
+YUI().use("gallery-lightbox", function (Y) { Y.Lightbox.init(); });
diff --git a/mod/lightboxgallery/pix/download.png b/mod/lightboxgallery/pix/download.png
new file mode 100644
index 0000000000000000000000000000000000000000..10dd815ef94c29f5c81ce588c0a3586ae54e328a
GIT binary patch
literal 1741
zcmV;;1~U1HP)<h;3K|Lk000e1NJLTq003(M000&U1^@s6#{*&$00006VoOIv0D1s=
z0D7aBHnji%010qNS#tmY3ljhU3ljkVnw%H_000McNliru-w6@{86<vv-oXF>23ko(
zK~!ko?U`LjlWiEse^1M%n>y#zT7IQ_Y)T-QWQ{s1MEt5C66zp4iLiqabyf#O5P6Ui
zokT~mlMWIhn1P<uiPRMPFo@7SGuWn-Hp{l0`*3>?UiPp#ZPT~j-gx(ihmHHb?)&~f
z*Z;n*`{NO!(P)$m{s?TzxF91|2EPDXGcNe|VYONr92^9oqoae)&dy9^{Z}zHHMQpd
zl#%7}c=-PP``^lK*@8-?LaWsx2*SFJg25mThXb$IOI}_c)z#G~l}fq(>({R=EiJKg
z=gx$7Gcz+}Wo1!PQX-c{A`#qfH#(gTwOUP#PjPWEIXOA9T_6zP)2C0AmX@MWDDZeZ
zgu`LBZ{PmI7fi)99x*Ptxw#Y;7ADni##cWz4Gs+rF+M&{c6K(=Xq4sUWt2)K4Gj&n
zx3`m*mzU7s)vH$w3=FV!>sE@2iunBbGvRQUlP6EIckf;R>~=d39z3A8w^w$|^71mb
zZrwto(QxhBwFCkC`uezd@gi!qnxUZ~#>U1taNq!^PMwnN+-^5_?%d(}_3LOf8it03
z@OV6!&E|DqE*-9`XZ+o}cPS|;;mVaON%b4`)h}7Is;a8wmkxzONRq_k$B*gn@8{B`
zOXTL}0x&r_iN#`}rKN?ImKGEW1(8UE;o)H{77J>%8l%yOD2hZP5vHf7sjI64V0wBQ
ztyYWI>t$hKL7uq|hXbWjNm*H$OiHCvF*Y{F;lqbhM$URjmuoymM@JDw5r@OUhYug9
zs;WxrH(g(?#?sOfeSLlS{r;qAy?psH06jfDl$V#Mzh-4+Wl>jG$NBT;@%el_d-hDO
z8yp;@tgMW-wl)+Bg`5srTU)8Dti)=y0-)7u(dl$Zk|ej4B#GU-ce88PF6?%@TyD49
zsjjY;`va(`sK8(_@Z`ypP0zw~xyC#5?c28;IdTM}(TL4vOF71me6<=Div_pajmP7`
z<MAYj6?+~&e7Ly{hDM`d&z?QJfBzl;pU;QW>7=QtX-)h6`}gB=x$t_u0MyjfB#0tO
z5~3(lU0p4U7>Pu1I2_c})Fk!S+1bg&!~{;KbHhSylq<l?moHJNR2Yp$nwpw;{rWY*
zU@)!mR{Lr#=ybZ2{ro7ZQtk$IIvroWd;ySu*Bdle9<vig5tqwFAP^uB2;g$LFc=IN
z3<g=O+1XkAem|lpCiPcYSxJ3;eNqIZgN<^HrNG9<MidGK_4V}#g20<MZ_*w!-dAg(
ztE&r>$+T|0$z-Cdt84S;tVkr1kU{{$;qaQavGSN*{JI5DP*8wYt3|C=v$(j(!omWQ
zBqgm^@n~;vr?<D4si~=iG@0@|vO%u1v$MEdE>535EvL7Jh6Zdl+q%*DBVWaE;lc&{
zem^-mIo!T|o9^yz0A9R!kt9^CZgrcq#hRU+m1kj5Q4xY5FgG{1rtRF^9D*Ro_OW%#
z;cyU*M&;<)wrv~b<>g3{gu~&$U@)vJ#Eu<1*tc&VR;!ic$B(Bi)<(J7Y&HZzNLVv`
zJ|FY*^UTlBQ(Rn}a?E&N#Sq&}#BVBA3l=ZbdTmmsL8sHn<m4m`4GjP&l}c)BYkB_s
zdD4tsSy^FZWCWwpm~b|Vty{76Dh5#$kt8Xpd@Z!LwlXs_!^Ffy+G1^lYd9Qce0-dy
zrY1}#ll(L{H&a+x$k^Ce%JEkFDiylByXolYprfNBL8!F0?x9eKxw$!_(I`Hj54+vY
z)2B}{7z`Xdcu+PzcI+7a{ry-h7EYWvK|w(Qi;Igqdh`gd*UQ<nXA?RXMNxj)GiT1o
z<pzU+`}gk?3<lTST*RZWu#iKC4lyz^l2jK8h4}dKW0Fu>tu}40@7}#*X=#bJwl)e1
z3X-<fqobp=wzkSCGhJV$Lb_K>Nn$yjPHx<|fglK|R4Vj(Jx7lo#bh!iq$s^!kJ)Ty
zU|@i&SFfT}DhUJvR8&-8Hk;Aw^+{qyA`vtiO+t#Os;VLs3Xz?iO=)RqN|MdZ&Dd-<
zR#sM$X7tUQHxtTgYisH0=}DVw>}<7KD1gSsMuvxnnVg)I&x`5$>Q_M6?Dwp1-@f7X
zddbbrMWfODr|;r^7uR#=&i$kI_wL>MIk)cl`T6AM=l>BGr+*UH%&q%xLi}dyXS5YE
jpY=15l|e?V|2O^uK9@nS=p4*-00000NkvXXu0mjf0}5BG

literal 0
HcmV?d00001

diff --git a/mod/lightboxgallery/pix/icon.gif b/mod/lightboxgallery/pix/icon.gif
new file mode 100644
index 0000000000000000000000000000000000000000..f0d2956cec09773b8ef6faa55e57e64f09353bc2
GIT binary patch
literal 1070
zcmciCk5iHd7zgloE)|)2)NX3#l~%Wzxh+#Kyt)fLml$c7r?+{WOV>QFyWMo>Zf)mo
zo0UJSi7iq=1ZgRb;%A73Cn3VCXh!}(g;!qXmqS3?!9)<;%RjNt^E}^s{(<Mo%fEol
zs=xpkz^Vg6!@|PDBf?M-k*Ls6Gzx<bK}W_!W8RO6jX8MeNaCUR=))Puj>aXYq{N@D
zNKZeLnVylBb>>qnIURRC0%s%;3bG4JkCcEhC2#R1<=D?_Qp!5Z%E}IxZ(J@X6<rg2
zSmVh5mP4wm{qp<!q#rx;>ZO%8{`{%F9^2&k<|Z}2W$J1(_4@68JlTH!ftN^mbNBAO
z8-F}$Y!{Hp9r#|)9SWU7dHA5K^In&rlC?zXW_5RWQ>oNj3=xe+t9lGkduTmDbkd-e
zPVb@jGRe$m%-%i*gVDj_Gnsv)r*0ODRmt@|M)VKR21RUkKbt+kX0rzeIUEl6Nf58<
zg^$A>;BvWqo{-Py|0Uw^1VVv8AQTEkB7sOG5(f>5#lu5GLXjAhNQT8Pq|M_SzbJQ~
zNyjA8(I(~QbE#A;RW~aA(h=G4=wy#d+o<--WU^-Uj!ZTtm&?ZxiV=lEp+u<UO4Wo)
zh0Nsm#5f45KoC@eiV1Lfa&mG)Jw>1M%}jyd^uqM?{42zaM)Mk}X^lqne9=5RJ3l+8
zpAXV5&&}~5zji^V)h;e-p%J}rX%W&bt}HEUwYp_!S--3^=yWE%UjN2`gav}2703ud
zmX#G`GZ_pv7={h7#Q<CNtCm&R1jAMswymz(*48%Gj3%QInRS!#Z==y^Hk(amhuLhm
zm^Umz4y)B>u_EbMx7yc(-r8(icDvo__{ZsVZaHn6o0~3|%k6S`T>rY=?(OYukH_Qn
zBJK70e7gw0*YEcS0=t1gVDJBxw6pIWG_VJx0*K&E0H^@47jZ80Yjj-NR}ySR2p%52
zSg6>lzQvhOI+<Nxvs6n+WD?uzNbxV_U;<H`;h6aDQNg3U<5x~y;a>yW4kTTIe-(1x
zW9OuG@OFx<ui{fPaKv^v|26kq<_fO%W=nA&wt#rm!x)$y&A=tN8Sid%9nZ`n)wNe#
zU_4Cj#a@yWwT_{qKK_KZbd-nw0FOrJVqVH}8ls|;Z}0b*E+(Q-A(%KoCTj?%?4m@!
zee^|Y?&ZRo>KYu-ls&jl-kCcUd#YS{y~SIc8y(-2)39It86oy$DYta^fO4GKak`Nh
ub#{SJno`WFBG*>uwf%k&FS(<+e<Jp2!Osbitv^WGW@1m|wjw_PIQt(q<f9+}

literal 0
HcmV?d00001

diff --git a/mod/lightboxgallery/pix/icon.svg b/mod/lightboxgallery/pix/icon.svg
new file mode 100644
index 0000000..0df83ef
--- /dev/null
+++ b/mod/lightboxgallery/pix/icon.svg
@@ -0,0 +1,46 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Generator: Adobe Illustrator 16.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
+<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
+<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
+	 width="24px" height="24px" viewBox="0 0 24 24" style="enable-background:new 0 0 24 24;" xml:space="preserve">
+<style type="text/css">
+<![CDATA[
+	.st0{stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:55;}
+	.st1{fill:url(#SVGID_3_);}
+	.st2{fill:#FFFFFF;}
+	.st3{fill:url(#SVGID_1_);stroke:#F57900;}
+	.st4{opacity:0.75;fill:url(#SVGID_2_);enable-background:new    ;}
+	.st5{stroke:#1F1F1F;stroke-miterlimit:20;}
+	.st6{fill:#454545;}
+]]>
+</style>
+<g>
+	<rect x="2.5" y="0.5" class="st2" width="19" height="23"/>
+	<path class="st6" d="M21,1v22H3V1H21 M22,0H2v24h20V0L22,0z"/>
+</g>
+<linearGradient id="SVGID_1_" gradientUnits="userSpaceOnUse" x1="764.1211" y1="-1091.2002" x2="764.1211" y2="-1102.0837" gradientTransform="matrix(0.9946 -0.1039 -0.1039 -0.9946 -862.2496 -1003.5676)">
+	<stop  offset="0" style="stop-color:#F57900"/>
+	<stop  offset="1" style="stop-color:#FCE94F"/>
+</linearGradient>
+<rect x="4.41" y="2.635" class="st3" width="15.183" height="16.299"/>
+<radialGradient id="SVGID_2_" cx="294.6084" cy="-1134.2236" r="6.9666" gradientTransform="matrix(3.2114 -0.3603 -0.1226 -1.2595 -1081.9224 -1315.3284)" gradientUnits="userSpaceOnUse">
+	<stop  offset="0" style="stop-color:#FFFFFF"/>
+	<stop  offset="1" style="stop-color:#FFFFFF;stop-opacity:0"/>
+</radialGradient>
+<path class="st4" d="M4.898,3.272h14.118l0.055,4.31C6.148,6.914,7.07,6.961,4.898,19.573V3.272z"/>
+<radialGradient id="SVGID_3_" cx="754.3838" cy="-1039.3896" r="2.028" gradientTransform="matrix(1.2433 -0.1395 -0.1299 -1.3349 -1063.7867 -1274.7223)" gradientUnits="userSpaceOnUse">
+	<stop  offset="0" style="stop-color:#FFFFFF"/>
+	<stop  offset="0.81" style="stop-color:#FFFFFF"/>
+	<stop  offset="0.84" style="stop-color:#FDF4A7"/>
+	<stop  offset="1" style="stop-color:#FCE94F;stop-opacity:0"/>
+</radialGradient>
+<polygon class="st1" points="6.337,5.062 11.373,4.498 11.9,9.905 6.865,10.472 "/>
+<path class="st5" d="M16.366,14.555c0.216,0.363,0.508,0.752,0.928,1.146v0.83h-4.771c0.248-0.186,0.49-0.412,0.733-0.684
+	l0.022-0.023l0.021-0.027c0.583-0.719,0.76-0.72,1.154-0.72C15.066,15.077,15.682,15.02,16.366,14.555 M8.445,15.398
+	c0.271,0.502,0.568,0.869,0.866,1.131H7.145c0.321-0.434,0.606-0.637,1.232-1.081C8.399,15.434,8.422,15.416,8.445,15.398
+	 M16.785,12.152c-2.062,2.954-2.459,0.226-4.5,2.747c-0.53,0.593-1.001,0.852-1.415,0.852c-0.825,0-1.427-1.031-1.828-2.498
+	c-2.272,1.77-2.48,1.498-3.621,3.482v1.188h13.203v-2.883C17.202,13.964,17.261,13.098,16.785,12.152L16.785,12.152z"/>
+<path class="st0" d="M5.853,17.861v-0.385c0.723-1.535,0.995-1.771,1.995-2.658c0.213-0.188,0.455-0.4,0.733-0.657
+	c0.555,1.784,1.314,2.687,2.261,2.687c0.65,0,1.317-0.464,1.98-1.383c0.839-1.281,1.224-1.281,1.756-1.281
+	c0.71,0,1.384-0.108,2.229-1.182c0.233,0.752,0.573,1.579,1.428,2.473v2.385H5.853V17.861z"/>
+</svg>
diff --git a/mod/lightboxgallery/pix/index.png b/mod/lightboxgallery/pix/index.png
new file mode 100644
index 0000000000000000000000000000000000000000..c747193aee138c679c941ce11d3a14b7c77f0877
GIT binary patch
literal 3110
zcmV+>4B7LEP)<h;3K|Lk000e1NJLTq0027x0027(1^@s6#U=8y00001b5ch_0Itp)
z=>Px#24YJ`L;(K){{a7>y{D4^000SaNLh0L01FcU01FcV0GgZ_00007bV*G`2iXG?
z4=Mt7(2w5$01Ku`L_t(&-rd`2jAYkU2k`&7%Uf#c?yBi^dYNfEGd37|BJc-GL?lLH
z6Oj?YU?f1o79l~g2ogksFOduqLJCAed_a6>N%(>U0u+&;fG~>{tg*pz>}iiZy|}u1
zdb+B*miOLW&f!B(#yB$#BqDOU?zfUk_4KQA?|tW-cOMB(AA5Vd&&61N+H;94%)!_U
z+Uh7;o>*9F{|(;banS9)kD0&Vy}u8D7-L?JG5*Nf`g-SH-#7o$kC9U8()=p4k?4z3
z2M-BBqKodY_ujq%5)D9s2>Z<ZN#|T&DMi*=h{*2h+S)7MEM#wY_xnVo7D8YmQc03L
zK}5gA%m4tT6chlhwNKNOt+nL6zfzXvuLAhBZwTA(cP}c(KQ|Z_VSGF?t=236kQfxT
ztez-pMDK%6to6p4JjVF>7$af~@IF99y8E5Z^D#!p%p@XVa6I^xhaZ0A@awO&yR-8N
zt@VdQBq*gwYt5NbPibuw5umk(wHC%0(OL@t0)P+#CX<N~5i}YNjK^aPhr{t{rc<%K
z;Xy6S=gx~HxD7q|M}gTG7!l9_!TDg1js~+zD+n|4TE5e2x4Mexk_djBnJEM>&N<A?
z%zWhL!9gg?63#gUA0QCuVv;3EX0j}mG)*W=6If#)fP~26D@UEfLv%VF+1=fxo$Vdm
z*uH@qH@4|ue_t+aZs57!{4LtNxCtV{H;j$Ps&9=KvVs1W*^WlD{@*{Y50A&|U%w&%
z!rbiaKS3l7E}RPp50Z)CkZ6cT2osr%C#ruuk^Z>H`$t2y*V(84c<Civ{kMO>?)6u2
zaI;4Yrt$HJZ%3B_&>P!beE2Ib$@?x{B5m~Ismt<S8`R<9@TW$D;>p<=d~bwm8)LI?
z<wjE$<$p$Y-_>X|Z`ITMoYERWAZ1x$(7T0x???v6L+ba3^z<_yf9jd1pZ@$?+gowF
z^M>l~_lcnKiy!+1{^&=4UX2GsNR+va%?pEjVh_6AN#%V{$RkE4gnYIre52je1C|_l
zEt`F>c3h5nuU0dwq==OwXN>B57te(lOb7v^Nr~N^T_K3fFP?M0awbWVewJk%LU^Vq
zimgkRFTV}|bn9U792x#Jl)&Z&X_AAYmTs>jxn`wk2H&p3RUS!dx6|BOtIY~CpcMJC
zbXFwz7^7ttgb={YKT8Mu9Z745d2>PCy6N$i7p`Gz>$(*203Un$Nu@~RERLcmV68=-
zXGM}2-R}<$jHJpJo^@IYKJy1(#Gn6dS4N$e=<!EG{NyK|8o2^9XAzs{IRN0OHyAH1
zo`Z<2Dr3@S45W-!n3R<`$tj;*!ULD@(}}5%aK;C-w0z`wS5-f)+ReF&nW2qfd1;Pn
z4TB_Aw0>a?O5)*J#~P!x2qVNu3IH_WMM$Lct20ollE!RZE<bQTLiEL%kE{q{h)_gI
z0f1Da-;TlI{PF@Ij?&!n+Qn7zKFHaRtQ`Ujn<h{I5MoS1h*(%^k~JFbb4_)wHB<RO
zkDYaFW2QE8&UYd5k~&FvwF*&TX|X1GYEi3cN;7ljr!W9yiCqXGytd!z-cSHwlbqN`
z%(pTuv@%**Y)V3|Jq=g|(i|gYd3LfvDbicPxw5W+mBoZFuC)L~(_lrA2o^DUo@)gF
zMbE#+&R-RYvb@x!_Dl+h#Hr9S$Xc^|adUH^0H8ef6*HGWRIBqD)|VUb-d~%F$a?R_
z<ME%}uEhbV2UU^P!U--emYA&*MYa!41=e{#8Vq;uVC%CDqqMTjEUPO^SXgLH#SE_J
z*_W8v<as`O2fMMc))$Jedgr-)t|hb0+EidGA3i7|&|32yEC4v?{=Rfo)S4-=YAUc<
zn!M(N=X$Mf--V6A?S>G9NW8JMI}KRp+(SiC{^RoM%HO>UtF_V2mC#D`WISk216Gqp
ztkiW7y?Yv4YlS(&TB{RVo1KctvcM#iy^~Gd9%-7U&UvkrnTqu~5PjW64>BxwVXd{j
zq9|@DrKTctN=&-$iV2LdxC=YiYW?f+@$r|9F+2^}W=5(w9w18^cVj2x@#VR>x$iW_
ze03VIsW1gk&<b~Bi=w#HXf(bfN$jm@z><Jq5|mYOkH}6Yh1NPMrK)MbiUi5h1Z7p;
zGqRMXDGdgrA3E#MVHIQW)x=sIePnkRb~GMUHc6(UVz1XSmgtCxpp9xn4)wdRjWkcq
z?M&m$uUD4Bg_z};A#3dq-Wr+@+`;xcH<Q+E`$=u|RAdy1)}cSF$Qls^suw;@?qG+-
zFb%?2l(M5~z#4;mYwHaPq*ZDym!si3xp8lB$V|+l_108$C!$YYc=1K4T!1zT<+%UO
z235sEwADNq4Cl`}bTSUZ5WKpvvxBm7Ac~=w43F<%R~J_sNvi9vEH0e+`>QrPzHoT`
z+LkKI6543nZq2OT!KS+QNJjkKdJ1ZQB-I;(igEqgHF0GrAZ=^4+ArTaJZhXwW5*<t
z1ZEnZb!@Gcq&vIYD2hV*{XVQsK%$aKQJg#xAZs>R>@DXdocRJkD|_SmmNXkR+&t)#
z(J2XpN5g>_0MLo~4e#AjYwqlKW0az5ckf10jE8vZtv8_*ftiJwMF9YZ@H?1}h9W}r
z;riA!I=p#^H?F-2A`-1kqO>w6ME0LiEK`AXl~a4W9YkjAzP)pjWF-1~W@lzUc=8m_
zs-_?ervbaa-_5(-F1Ool9NfH#7^4_%EP$p00LKAj^QmZ`9vvO=WHN!Z7H?j^j!vgT
z)>?S)gX-)Zyg(+Iih`YmukY{g(|A0l<KttQo0|hOLn#F!iY7oFu_{mI=9<H!-sEjX
z@qx37t*YWUNs^;ypMAEqyu3_Tu3W*|+8Ug5l4aTFXs>(tajVrIHft#)0wyycA{eDP
zMmHJ`M|C2z6S=%7oIsmz-zu;yCxzBJUszbUa{#+6Pueo$@pz8}!0z_;X9d{RTK~GS
z>dTSkC&g*jmMLn2M~znI3@0`hVb&}nAesnEJ;s2dC|`G#KMx=!MQ>Yc-;*4h*`wF%
zOS9P|r4*PMA_4$Ct@TrPoi{!@dOMkn<EC@rFKvz1zV!Un{Et8P&$#l~_sfO$IV?5`
zYGgfHoNvp@+J-cnGh~c`F$P*|Xsv}ghN^OjG5R=!Xr1%958<faKURwi^K;)SY?dY1
z-`^iH^Us73Ue#I~Yb`b|T=*(*k0avk_IcL^UVG)$s~>L7pMQOMVHsEd{bhbDdz3CT
zC+NKL7dW`~1xczB^|^W6cmMskbonwKdgvkA+}xD)^>u2sS~klv5lLpW)>3cOSSj6_
zUpRLX0A_gaRaN;>IVnw+rT;I7w?!CA>EFA!x%pT3Eb341<G>RmzW;&C`X_$)ae50q
zdT{-mJW#txi$CzRY^>amm6f$(d1X1v^IX+xHOaCJ#uyM0dGFzz!^uk$Q5d3#2t-6_
znj%dzXr&r6Gj$|M!XhWxoB(W$d0qkRW03Kv_|X5k_e2VSoSF-sip^}EMj!RkLJPnD
zyPp!r9y5&uf{zHmfG81>8UVx?5kep$lG`{ZBJ7+aX4WyrPOsnp;^24?s;bf~0!2iP
zTCHle+U-2gAFtJFGf9#_DP^?LA0Va3YKwZKCi>*o@wH7S29A5j{UK?sHvnKX9LLqQ
z#iG|6G_*ebeDtZ<wBE2$6e<@*CyXRSOePcJ$Oth)n8^nZ5gCcd3(RbonTRMj=l*0g
z8oiojS)S*)X*3$$&HL`VdfK%PZ{B=tG#WK}y`E||n@<qY`yq%RoaDAzZyIAZhzMG1
zV~n{_ujgNzMQAqbkr@pD+eK0Q(W#L?Eh9eYc55-lKP93ci!q8)s$yo2F@BbaURFvO
zrIaS3y-ug|FSE0=Mk$3fO=ac$`SCZq?#82$8I4AHQ4~^D70R-dcDuc%lzKRXkjTmQ
z>XRgSR4Mf-W+tT+wAK)jt5sF~==#RSJ>S^+FQUpm{5Rkf*#H0l07*qoM6N<$f>#0L
ARsaA1

literal 0
HcmV?d00001

diff --git a/mod/lightboxgallery/rsslib.php b/mod/lightboxgallery/rsslib.php
new file mode 100644
index 0000000..0bf7a6b
--- /dev/null
+++ b/mod/lightboxgallery/rsslib.php
@@ -0,0 +1,264 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * Handles all the RSS related tasks for the module
+ *
+ * @package   mod_lightboxgallery
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+require_once('lib.php');
+require_once('imageclass.php');
+
+/**
+ * Returns the path to the cached rss feed contents. Creates/updates the cache if necessary.
+ * @global object $CFG
+ * @global object $DB
+ * @param object $context the context
+ * @param array $args the arguments received in the url
+ * @return string the full path to the cached RSS feed directory. Null if there is a problem.
+ */
+function lightboxgallery_rss_get_feed($context, $args) {
+    global $CFG, $DB;
+
+    $config = get_config('lightboxgallery');
+
+    $status = true;
+
+    // Are RSS feeds enabled?
+    if (empty($config->enablerssfeeds)) {
+        debugging('DISABLED (module configuration)');
+        return null;
+    }
+
+    $galleryid = clean_param($args[3], PARAM_INT);
+    $cm = get_coursemodule_from_instance('lightboxgallery', $galleryid, 0, false, MUST_EXIST);
+    if ($cm) {
+        $modcontext = context_module::instance($cm->id);
+
+        // Context id from db should match the submitted one.
+        if ($context->id != $modcontext->id) {
+            return null;
+        }
+    }
+
+    $gallery = $DB->get_record('lightboxgallery', array('id' => $galleryid), '*', MUST_EXIST);
+
+    $captions = array();
+    if ($cobjs = $DB->get_records('lightboxgallery_image_meta',  array('metatype' => 'caption', 'gallery' => $gallery->id))) {
+        foreach ($cobjs as $cobj) {
+            $captions[$cobj->image] = $cobj->description;
+        }
+    }
+
+    $fs = get_file_storage();
+    $storedfiles = $fs->get_area_files($context->id, 'mod_lightboxgallery', 'gallery_images');
+
+    $items = array();
+    $counter = 1;
+    $articles = '';
+    foreach ($storedfiles as $file) {
+        $filename = $file->get_filename();
+        if ($filename == '.') {
+            continue;
+        }
+        $description = isset($captions[$filename]) ? $captions[$filename] : $filename;
+        $image = new lightboxgallery_image($file, $gallery, $cm);
+        $item = new stdClass();
+        $item->{"media:description"} = $description;
+
+        $articles .= rss_start_tag('item', 2, true);
+        $articles .= rss_full_tag('title', 3, false, $filename);
+        $articles .= rss_full_tag('link', 3, false, $image->get_image_url());
+        $articles .= rss_full_tag('guid', 3, false, 'img' . $counter);
+
+        $articles .= rss_full_tag('media:description', 3, false, $description);
+        $articles .= rss_full_tag('media:thumbnail', 3, false, '', array('url' => $image->get_thumbnail_url()));
+        $articles .= rss_full_tag('media:content', 3, false, '',
+                        array('url' => $image->get_image_url(), 'type' => $file->get_mimetype()));
+
+        $articles .= rss_end_tag('item', 2, true);
+
+    }
+
+    // Get the cache file info.
+    $filename = rss_get_file_name($gallery, $sql);
+    $cachedfilepath = rss_get_file_full_name('mod_lightboxgallery', $filename);
+
+    // Is the cache out of date?
+    $cachedfilelastmodified = 0;
+    if (file_exists($cachedfilepath)) {
+        $cachedfilelastmodified = filemtime($cachedfilepath);
+    }
+
+    // First all rss feeds common headers.
+    $header = lightboxgallery_rss_header(format_string($gallery->name, true),
+                                  $CFG->wwwroot."/mod/lightboxgallery/view.php?id=".$cm->id,
+                                  format_string($gallery->intro, true));
+
+    // Now all rss feeds common footers.
+    if (!empty($header) && !empty($articles)) {
+        $footer = rss_standard_footer();
+    }
+    // Now, if everything is ok, concatenate it.
+    if (!empty($header) && !empty($articles) && !empty($footer)) {
+        $rss = $header.$articles.$footer;
+
+        // Save the XML contents to file.
+        $status = rss_save_file('mod_lightboxgallery', $filename, $rss);
+    }
+
+    if (!$status) {
+        $cachedfilepath = null;
+    }
+
+    return $cachedfilepath;
+}
+
+function lightboxgallery_rss_feeds() {
+    global $CFG;
+
+    $status = true;
+
+    if (! $CFG->enablerssfeeds) {
+        debugging('DISABLED (admin variables)');
+    } else if (! get_config('lightboxgallery', 'enablerssfeeds')) {
+        debugging('DISABLED (module configuration)');
+    } else {
+        if ($galleries = $DB->get_records('lightboxgallery')) {
+            foreach ($galleries as $gallery) {
+                if ($gallery->rss && $status) {
+
+                    $filename = rss_file_name('lightboxgallery', $gallery);
+
+                    if (file_exists($filename)) {
+                        if ($lastmodified = filemtime($filename)) {
+                            if ($lastmodified > time() - HOURSECS) {
+                                continue;
+                            }
+                        }
+                    }
+
+                    if (!instance_is_visible('lightboxgallery', $gallery)) {
+                        if (file_exists($filename)) {
+                            @unlink($filename);
+                        }
+                        continue;
+                    }
+
+                    mtrace('Updating RSS feed for ' . format_string($gallery->name, true) . ', ID: ' . $gallery->id);
+
+                    $result = lightboxgallery_rss_feed($gallery);
+
+                    if (! empty($result)) {
+                        $status = rss_save_file('lightboxgallery', $gallery, $result);
+                    }
+
+                    if (debugging()) {
+                        if (empty($result)) {
+                            echo('ID: ' . $gallery->id . '-> (empty) ');
+                        } else {
+                            if (! empty($status)) {
+                                echo('ID: ' . $gallery->id . '-> OK ');
+                            } else {
+                                echo('ID: ' . $gallery->id . '-> FAIL ');
+                            }
+                        }
+                    }
+
+                }
+            }
+        }
+    }
+
+    return $status;
+}
+
+function lightboxgallery_rss_get_sql($glossary, $time=0) {
+    // Do we only want new items?
+    if ($time) {
+        $time = "AND e.timecreated > $time";
+    } else {
+        $time = "";
+    }
+
+    $sql = '';
+
+    return $sql;
+}
+
+function lightboxgallery_rss_header($title = null, $link = null, $description = null) {
+    global $CFG, $USER, $OUTPUT;
+
+    $status = true;
+    $result = "";
+
+    $site = get_site();
+
+    if ($status) {
+
+        // Calculate title, link and description.
+        if (empty($title)) {
+            $title = format_string($site->fullname);
+        }
+        if (empty($link)) {
+            $link = $CFG->wwwroot;
+        }
+        if (empty($description)) {
+            $description = $site->summary;
+        }
+
+        // XML headers.
+        $result .= "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n";
+        $result .= "<rss version=\"2.0\" xmlns:media=\"http://search.yahoo.com/mrss\"".
+                    "xmlns:atom=\"http://www.w3.org/2005/Atom\">\n";
+
+        // Open the channel.
+        $result .= rss_start_tag('channel', 1, true);
+
+        // Write channel info.
+        $result .= rss_full_tag('title', 2, false, strip_tags($title));
+        $result .= rss_full_tag('link', 2, false, $link);
+        $result .= rss_full_tag('description', 2, false, $description);
+        $result .= rss_full_tag('generator', 2, false, 'Moodle');
+        if (!empty($USER->lang)) {
+            $result .= rss_full_tag('language', 2, false, substr($USER->lang, 0, 2));
+        }
+        $today = getdate();
+        $result .= rss_full_tag('copyright', 2, false, '&#169; '. $today['year'] .' '. format_string($site->fullname));
+
+        // Write image info.
+        $rsspix = $OUTPUT->image_url('i/rsssitelogo');
+
+        // Write the info.
+        $result .= rss_start_tag('image', 2, true);
+        $result .= rss_full_tag('url', 3, false, $rsspix);
+        $result .= rss_full_tag('title', 3, false, 'moodle');
+        $result .= rss_full_tag('link', 3, false, $CFG->wwwroot);
+        $result .= rss_full_tag('width', 3, false, '140');
+        $result .= rss_full_tag('height', 3, false, '35');
+        $result .= rss_end_tag('image', 2, true);
+    }
+
+    if (!$status) {
+        return false;
+    } else {
+        return $result;
+    }
+}
diff --git a/mod/lightboxgallery/search.php b/mod/lightboxgallery/search.php
new file mode 100644
index 0000000..dabd2b2
--- /dev/null
+++ b/mod/lightboxgallery/search.php
@@ -0,0 +1,134 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+
+/**
+ * Search page for searching for images
+ *
+ * @package   mod_lightboxgallery
+ * @copyright 2010 John Kelsh
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+require_once(dirname(dirname(dirname(__FILE__))).'/config.php');
+require_once(dirname(__FILE__).'/imageclass.php');
+
+require_once($CFG->libdir.'/filelib.php');
+
+$cid = required_param('id', PARAM_INT);
+$g = optional_param('gallery', '0', PARAM_INT);
+$search = optional_param('search', '', PARAM_CLEAN);
+
+if ($g) {
+    $gallery = $DB->get_record('lightboxgallery', array('id' => $g), '*', MUST_EXIST);
+    $course = $DB->get_record('course', array('id' => $gallery->course), '*', MUST_EXIST);
+    $cm = get_coursemodule_from_instance("lightboxgallery", $gallery->id, $course->id, false, MUST_EXIST);
+    $context = context_module::instance($cm->id);
+    require_login($course, true, $cm);
+} else {
+    $course = $DB->get_record('course', array('id' => $cid), '*', MUST_EXIST);
+    $context = context_course::instance($cid);
+    require_login($course, true);
+}
+
+
+if (isset($gallery) && $gallery->ispublic) {
+    $userid = (isloggedin() ? $USER->id : 0);
+} else {
+    $userid = $USER->id;
+}
+
+$context = context_module::instance($cm->id);
+
+$params = array(
+    'context' => $context,
+    'other' => array(
+        'searchterm' => $search,
+        'lightboxgalleryid' => $gallery->id,
+    ),
+);
+$event = \mod_lightboxgallery\event\gallery_searched::create($params);
+$event->trigger();
+
+$PAGE->set_url('/mod/lightboxgallery/search.php', array('id' => $cm->id, 'search' => $search));
+$PAGE->set_title($gallery->name);
+$PAGE->set_heading($course->shortname);
+$PAGE->requires->css('/mod/lightboxgallery/assets/skins/sam/gallery-lightbox-skin.css');
+$PAGE->requires->yui_module('moodle-mod_lightboxgallery-lightbox', 'M.mod_lightboxgallery.init');
+
+echo $OUTPUT->header();
+
+$options = array();
+if ($instances = get_all_instances_in_course('lightboxgallery', $course)) {
+    foreach ($instances as $instance) {
+        $options[$instance->id] = $instance->name;
+    }
+
+    echo('<form action="search.php">');
+
+    $table = new html_table;
+    $table->width = '*';
+    $table->align = array('left', 'left', 'left', 'left');
+    $table->data[] = array(get_string('modulenameshort', 'lightboxgallery'), html_writer::select($options, 'gallery', $g),
+                           '<input type="text" name="search" size="10" value="'.s($search, true).'" />' .
+                           '<input type="hidden" name="id" value="'.$cid.'" />',
+                           '<input type="submit" value="'.get_string('search').'" />');
+    echo html_writer::table($table);
+    echo html_writer::end_tag('form');
+}
+
+$fs = get_file_storage();
+
+if ($g) {
+    $options = array($g => $g);
+}
+list($insql, $inparams) = $DB->get_in_or_equal(array_keys($options));
+$params = array_merge(array("%$search%"), $inparams);
+$sql = "SELECT *
+        FROM {lightboxgallery_image_meta}
+        WHERE ".$DB->sql_like('description', '?', false)." AND gallery $insql";
+if ($results = $DB->get_records_sql($sql, $params)) {
+    echo $OUTPUT->box_start('generalbox lightbox-gallery clearfix autoresize');
+
+    $hashes = array();
+    $galleryrecords = array();
+
+    foreach ($results as $result) {
+        if (!isset($hashes[$result->image])) {
+            $imgcm = get_coursemodule_from_instance("lightboxgallery", $result->gallery, $course->id, false, MUST_EXIST);
+
+            if (!isset($galleryrecords[$result->gallery])) {
+                $imggallery = $DB->get_record('lightboxgallery', array('id' => $result->gallery), '*', MUST_EXIST);
+                $galleryrecords[$result->gallery] = $imggallery;
+            } else {
+                $imggallery = $galleryrecords[$result->gallery];
+            }
+            $imgcontext = context_module::instance($imgcm->id);
+
+            if ($storedfile = $fs->get_file($imgcontext->id, 'mod_lightboxgallery', 'gallery_images', 0, '/', $result->image)) {
+                $image = new lightboxgallery_image($storedfile, $imggallery, $imgcm);
+                echo $image->get_image_display_html();
+                $hashes[$result->image] = 1;
+            }
+        }
+    }
+
+    echo $OUTPUT->box_end();
+} else {
+    echo $OUTPUT->box(get_string('errornosearchresults', 'lightboxgallery'));
+}
+
+echo $OUTPUT->footer();
diff --git a/mod/lightboxgallery/settings.php b/mod/lightboxgallery/settings.php
new file mode 100644
index 0000000..c2423ff
--- /dev/null
+++ b/mod/lightboxgallery/settings.php
@@ -0,0 +1,51 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * Global settings page for lightboxgallery
+ *
+ * @package   mod_lightboxgallery
+ * @copyright 2010 John Kelsh <john.kelsh@netspot.com.au>
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+require_once(dirname(__FILE__).'/locallib.php');
+
+/* Disabled Plugins */
+
+$options = lightboxgallery_edit_types(true);
+
+$disableplugins = new admin_setting_configmulticheckbox('disabledplugins', get_string('configdisabledplugins', 'lightboxgallery'),
+                    get_string('configdisabledpluginsdesc', 'lightboxgallery'), array(), $options);
+$disableplugins->plugin = 'lightboxgallery';
+
+$settings->add($disableplugins);
+
+/* Enable RSS Feeds */
+
+$description = get_string('configenablerssfeedsdesc', 'lightboxgallery');
+
+if (empty($CFG->enablerssfeeds)) {
+    $description .= ' (' . get_string('configenablerssfeedsdisabled2', 'admin') . ')';
+}
+
+$enablerss = new admin_setting_configcheckbox('enablerssfeeds', get_string('configenablerssfeeds', 'lightboxgallery'),
+                $description, 0);
+$enablerss->plugin = 'lightboxgallery';
+
+$settings->add($enablerss);
diff --git a/mod/lightboxgallery/styles.css b/mod/lightboxgallery/styles.css
new file mode 100644
index 0000000..75d0d94
--- /dev/null
+++ b/mod/lightboxgallery/styles.css
@@ -0,0 +1,163 @@
+.lightbox-gallery .lightbox-gallery-image-container {
+    display: inline-block;
+    margin: 10px;
+
+}
+.dir-rtl .lightbox-gallery .lightbox-gallery-image-container {
+    display: inline-block;
+    margin: 10px;
+}
+
+.lightbox-gallery .lightbox-gallery-image-frame {
+    background-color: #fff;
+    display: inline-block;
+    margin: 10px auto;
+    text-align: center;
+    width: 174px;
+    border: 1px solid #ccc;
+    border-radius: 5px;
+    transition: box-shadow 150ms, border-color 150ms, background-color 150ms, color 150ms;
+    -webkit-transition: box-shadow 150ms, border-color 150ms, background-color 150ms, color 150ms;
+    color: #696969;
+}
+
+.lightbox-gallery .lightbox-gallery-image-container .lightbox-gallery-image-frame:hover {
+    transition: box-shadow 150ms, border-color 150ms;
+    text-decoration: none;
+    box-shadow: 0 0 15px #ccc;
+    -webkit-box-shadow: 0 0 15px #ccc;
+    border-color: #999;
+    background-color: #f6f6f6;
+    color: #333;
+}
+
+.lightbox-gallery .lightbox-gallery-image-container .lightbox-gallery-image-frame:active {
+    box-shadow: 0 0 15px #666;
+    -webkit-box-shadow: 0 0 15px #666;
+}
+
+.lightbox-gallery .lightbox-gallery-image-thumbnail {
+    display: block;
+    margin: 5px 5px 2px;
+    vertical-align: middle;
+    width: 95%;
+    border: 1px solid #ccc;
+    border-radius: 5px;
+}
+
+.lightbox-gallery .lightbox-gallery-image-caption,
+.lightbox-gallery .lightbox-gallery-image-extinfo {
+    font-family: 'Verdana', 'Lucida Grande', sans-serif;
+    font-size: 11px;
+    margin-bottom: 3px;
+    text-decoration: none;
+}
+
+.lightbox-gallery .lightbox-gallery-image-caption {
+    font-weight: bold;
+    word-wrap: break-word;
+}
+
+.lightbox-gallery .lightbox-gallery-image-caption.top {
+    margin-bottom: -3px;
+}
+
+#mod-lightboxgallery-view .generalbox,
+#mod-lightboxgallery-search .generalbox {
+    overflow: auto;
+}
+
+#mod-lightboxgallery-view .thumb,
+#mod-lightboxgallery-search .thumb {
+    position: relative;
+    z-index: 5;
+    border: 1px solid #ccc;
+    background-color: #fff;
+    text-align: center;
+    margin: 2px;
+    padding: 3px;
+}
+
+#mod-lightboxgallery-view .thumb .image,
+#mod-lightboxgallery-search .thumb .image {
+    position: relative;
+    z-index: 10;
+    border: 1px solid #ccc;
+    background-color: #000;
+    height: 105px;
+    width: 120px;
+    margin-bottom: 2px;
+}
+
+#mod-lightboxgallery-view .thumb .overlay img,
+#mod-lightboxgallery-search .thumb .overlay img {
+    border: 0;
+}
+
+#mod-lightboxgallery-view .lightbox-edit-select {
+    margin: 12px;
+}
+
+#mod-lightboxgallery-imageedit .generaltable img,
+#mod-lightboxgallery-imageadd .generaltable img {
+    border: 1px solid #ddd;
+}
+
+#mod-lightboxgallery-imageedit .menubar {
+    margin-top: 14px;
+    text-align: center;
+}
+
+#mod-lightboxgallery-imageedit .tag-head {
+    border-bottom: 1px solid #ddd;
+    background-color: #f9fafa;
+    display: block;
+    padding: 2px 0;
+    margin: 3px 1px;
+}
+
+#mod-lightboxgallery-imageedit .tag-exists {
+    color: #aaa;
+    text-decoration: line-through;
+}
+
+#mod-lightboxgallery-imageedit .tag-exists input {
+    display: none;
+}
+
+#mod-lightboxgallery-imageadd #messages {
+    margin: 0 6px 0 12px;
+    padding: 0;
+}
+
+#mod-lightboxgallery-search .generalbox {
+    margin-bottom: 10px;
+}
+
+#page-mod-lightboxgallery-view #overlay {
+    z-index: 4032;
+}
+
+#page-mod-lightboxgallery-view #lightbox {
+    z-index: 4033;
+}
+
+#page-mod-lightboxgallery-view #imageData #bottomNavDownload {
+    float: right;
+    width: 104px;
+    height: 22px;
+    background: url([[pix:lightboxgallery|download]]) no-repeat;
+    padding-bottom: 0.7em;
+    padding-right: 0.5em;
+    margin-right: .5em;
+    outline: none;
+}
+
+#page-mod-lightboxgallery-view #imageData #imageDetails {
+    width: 65%;
+}
+
+#page-mod-lightboxgallery-view #outerImageContainer,
+#page-mod-lightboxgallery-view #imageDataContainer {
+    min-width: 200px;
+}
diff --git a/mod/lightboxgallery/tests/behat/behat_mod_lightboxgallery.php b/mod/lightboxgallery/tests/behat/behat_mod_lightboxgallery.php
new file mode 100644
index 0000000..d6a625c
--- /dev/null
+++ b/mod/lightboxgallery/tests/behat/behat_mod_lightboxgallery.php
@@ -0,0 +1,65 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Steps definitions related with the forum activity.
+ *
+ * @package    mod_lightboxgallery
+ * @category   test
+ * @copyright  2016 Blackboard
+ * @author     Adam Olley <adam.olley@netspot.com.au>
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+// NOTE: no MOODLE_INTERNAL test here, this file may be required by behat before including /config.php.
+
+require_once(__DIR__ . '/../../../../lib/behat/behat_base.php');
+
+use Behat\Behat\Context\Step\Given as Given,
+    Behat\Gherkin\Node\TableNode as TableNode;
+/**
+ * Lightboxgallery-related steps definitions.
+ *
+ * @package    mod_lightboxgallery
+ * @category   test
+ * @copyright  2016 NetSpot Pty Ltd
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+class behat_mod_lightboxgallery extends behat_base {
+
+    /**
+     * Allow a gallery to be viewed just by knowing its idnumber.
+     * This is a helper function to jump to a gallery without going throught
+     * the course page, simulating the case where the user knows the URL but
+     * can't go through the course (ispublic flag is set).
+     *
+     * @Given /^I view the lightboxgallery with idnumber "(?P<lightboxgallery_idnumber>(?:[^"]|\\")*)"$/
+     * @param string $idnumber
+     */
+    public function i_view_the_lightboxgallery_with_idnumber($idnumber) {
+        global $DB;
+
+        $sql = "SELECT cm.id
+                FROM {course_modules} cm
+                JOIN {modules} m ON m.id = cm.module
+                WHERE m.name = 'lightboxgallery' AND cm.idnumber = ?";
+        $cm = $DB->get_record_sql($sql, [$idnumber]);
+
+        $href = new moodle_url('/mod/lightboxgallery/view.php', ['id' => $cm->id]);
+        $this->getSession()->visit($href->out());
+    }
+
+}
diff --git a/mod/lightboxgallery/tests/behat/public_gallery.feature b/mod/lightboxgallery/tests/behat/public_gallery.feature
new file mode 100644
index 0000000..f37665c
--- /dev/null
+++ b/mod/lightboxgallery/tests/behat/public_gallery.feature
@@ -0,0 +1,37 @@
+@mod @mod_lightboxgallery
+Feature: Set a lightboxgallery as public
+  In order to let non-loggedin users view a gallery
+  As a teacher
+  I need to add a lightboxgallery with the ispublic flag enabled
+
+  Scenario: Add a lightboxgallery and a standard gallery
+    Given the following "users" exist:
+      | username | firstname | lastname | email |
+      | teacher1 | Teacher | 1 | teacher1@example.com |
+    And the following "courses" exist:
+      | fullname | shortname | category |
+      | Course 1 | C1 | 0 |
+    And the following "course enrolments" exist:
+      | user | course | role |
+      | teacher1 | C1 | editingteacher |
+    And I log in as "teacher1"
+    And I follow "Course 1"
+    And I turn editing mode on
+    And I add a "Lightbox Gallery" to section "1" and I fill the form with:
+      | Name        | LBG          |
+      | Description | Test gallery |
+      | ID number   | lbg1         |
+      | Make public | No           |
+    And I follow "LBG"
+    Then I should see "Test gallery"
+    When I log out
+    And I view the lightboxgallery with idnumber "lbg1"
+    Then I should not see "Test gallery"
+    When I log in as "teacher1"
+    And I view the lightboxgallery with idnumber "lbg1"
+    And I follow "Edit settings"
+    And I set the field "Make public" to "Yes"
+    And I press "Save and display"
+    And I log out
+    And I view the lightboxgallery with idnumber "lbg1"
+    Then I should see "Test gallery"
diff --git a/mod/lightboxgallery/tests/generator/lib.php b/mod/lightboxgallery/tests/generator/lib.php
new file mode 100644
index 0000000..68805fd
--- /dev/null
+++ b/mod/lightboxgallery/tests/generator/lib.php
@@ -0,0 +1,41 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * mod_lightboxgallery data generator.
+ *
+ * @package    mod_lightboxgallery
+ * @category   test
+ * @copyright  2017 Blackboard Inc.
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * mod_lightboxgallery data generator class.
+ *
+ * @package    mod_lightboxgallery
+ * @category   test
+ * @copyright  2017 Blackboard Inc.
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+class mod_lightboxgallery_generator extends testing_module_generator {
+
+    public function create_instance($record = null, array $options = null) {
+        return parent::create_instance($record, (array)$options);
+    }
+}
diff --git a/mod/lightboxgallery/tests/lib_test.php b/mod/lightboxgallery/tests/lib_test.php
new file mode 100644
index 0000000..1acae96
--- /dev/null
+++ b/mod/lightboxgallery/tests/lib_test.php
@@ -0,0 +1,72 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Unit tests for (some of) mod/lightboxgallery/lib.php.
+ *
+ * @package    mod_lightboxgallery
+ * @author     Adam Olley <adam.olley@netspot.com.au>
+ * @copyright  2012 NetSpot Pty Ltd
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU Public License
+ */
+
+
+defined('MOODLE_INTERNAL') || die();
+
+global $CFG;
+require_once($CFG->dirroot . '/mod/lightboxgallery/lib.php');
+require_once($CFG->dirroot . '/mod/lightboxgallery/locallib.php');
+
+/**
+ * Unit tests for (some of) mod/lightboxgallery/lib.php.
+ *
+ * @copyright  2012 NetSpot Pty Ltd
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU Public License
+ */
+class mod_lightboxgallery_lib_testcase extends advanced_testcase {
+    public function test_lightboxgallery_resize_text() {
+        $this->assertEquals('test123', lightboxgallery_resize_text('test123', 10));
+        $this->assertEquals('test123456...', lightboxgallery_resize_text('test1234567', 10));
+    }
+
+    public function test_lightboxgallery_edit_types() {
+        $this->resetAfterTest();
+
+        $disabledplugins = explode(',', get_config('lightboxgallery', 'disabledplugins'));
+
+        $types = ['caption', 'crop', 'delete', 'flip', 'resize', 'rotate', 'tag', 'thumbnail'];
+
+        // Test showall returns all types..
+        $actual = array_keys(lightboxgallery_edit_types(true));
+        $this->assertEquals($types, $actual);
+
+        // Check crop is currently forcefully disabled.
+        $types = ['caption', 'delete', 'flip', 'resize', 'rotate', 'tag', 'thumbnail'];
+        $actual = array_keys(lightboxgallery_edit_types());
+        $this->assertEquals($types, $actual);
+
+        // Check disabling via config works.
+        $types = ['caption', 'delete', 'resize', 'rotate', 'tag', 'thumbnail'];
+        set_config('disabledplugins', 'flip', 'lightboxgallery');
+        $actual = array_keys(lightboxgallery_edit_types());
+        $this->assertEquals($types, $actual);
+
+        $types = ['caption', 'resize', 'rotate', 'tag', 'thumbnail'];
+        set_config('disabledplugins', 'delete,flip', 'lightboxgallery');
+        $actual = array_keys(lightboxgallery_edit_types());
+        $this->assertEquals($types, $actual);
+    }
+}
diff --git a/mod/lightboxgallery/thirdpartylibs.xml b/mod/lightboxgallery/thirdpartylibs.xml
new file mode 100644
index 0000000..3566aba
--- /dev/null
+++ b/mod/lightboxgallery/thirdpartylibs.xml
@@ -0,0 +1,17 @@
+<?xml version="1.0"?>
+<libraries>
+  <library>
+    <location>yui/lightbox</location>
+    <name>YUI 3 Gallery</name>
+    <license>BSD</license>
+    <version>2011.01.12</version>
+    <licenseversion></licenseversion>
+  </library>
+  <library>
+    <location>assets</location>
+    <name>YUI 3 Gallery skins</name>
+    <license>BSD</license>
+    <version>2011.01.12</version>
+    <licenseversion></licenseversion>
+  </library>
+</libraries>
diff --git a/mod/lightboxgallery/version.php b/mod/lightboxgallery/version.php
new file mode 100644
index 0000000..9726ea6
--- /dev/null
+++ b/mod/lightboxgallery/version.php
@@ -0,0 +1,33 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Lightbox gallery version info.
+ *
+ * @package   mod_lightboxgallery
+ * @copyright 2014 NetSpot Pty Ltd
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+$plugin->version  = 2017070701;  // The current plugin version (Date: YYYYMMDDXX).
+$plugin->requires = 2016120500;  // Requires this Moodle version.
+$plugin->cron     = 0;           // Period for cron to check this plugin (secs).
+
+$plugin->component = 'mod_lightboxgallery';
+$plugin->maturity = MATURITY_STABLE;
+$plugin->release = '3.2.0.1';
diff --git a/mod/lightboxgallery/view.php b/mod/lightboxgallery/view.php
new file mode 100644
index 0000000..bfd6446
--- /dev/null
+++ b/mod/lightboxgallery/view.php
@@ -0,0 +1,201 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+
+/**
+ * Prints a particular instance of lightboxgallery
+ *
+ * @package   mod_lightboxgallery
+ * @copyright 2011 John Kelsh <john.kelsh@netspot.com.au>
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+require_once(dirname(dirname(dirname(__FILE__))).'/config.php');
+require_once(dirname(__FILE__).'/locallib.php');
+
+require_once($CFG->libdir.'/completionlib.php');
+require_once($CFG->libdir.'/filelib.php');
+require_once($CFG->libdir.'/rsslib.php');
+require_once(dirname(__FILE__).'/imageclass.php');
+
+global $DB;
+
+$id = optional_param('id', 0, PARAM_INT);
+$l = optional_param('l', 0, PARAM_INT);
+$page = optional_param('page', 0, PARAM_INT);
+$search  = optional_param('search', '', PARAM_TEXT);
+$editing = optional_param('editing', 0, PARAM_BOOL);
+
+if ($id) {
+    list($course, $cm) = get_course_and_cm_from_cmid($id, 'lightboxgallery');
+    if (!$gallery = $DB->get_record('lightboxgallery', array('id' => $cm->instance))) {
+        print_error('invalidcoursemodule');
+    }
+} else {
+    if (!$gallery = $DB->get_record('lightboxgallery', array('id' => $l))) {
+        print_error('invalidlightboxgalleryid', 'lightboxgallery');
+    }
+    list($course, $cm) = get_course_and_cm_from_instance($gallery, 'lightboxgallery');
+}
+
+
+if ($gallery->ispublic) {
+    $userid = (isloggedin() ? $USER->id : 0);
+    $PAGE->set_cm($cm, $course);
+    $PAGE->set_pagelayout('incourse');
+} else {
+    require_login($course, true, $cm);
+    $userid = $USER->id;
+}
+
+$context = context_module::instance($cm->id);
+
+if ($editing) {
+    require_capability('mod/lightboxgallery:edit', $context);
+}
+
+if (empty($cm->visible) and !has_capability('moodle/course:viewhiddenactivities', $context)) {
+    notice(get_string("activityiscurrentlyhidden"));
+}
+
+lightboxgallery_config_defaults();
+
+$params = array(
+    'context' => $context,
+    'objectid' => $gallery->id
+);
+$event = \mod_lightboxgallery\event\course_module_viewed::create($params);
+$event->add_record_snapshot('course_modules', $cm);
+$event->add_record_snapshot('course', $course);
+$event->add_record_snapshot('lightboxgallery', $gallery);
+$event->trigger();
+
+// Mark viewed.
+$completion = new completion_info($course);
+$completion->set_module_viewed($cm);
+
+$PAGE->set_cm($cm);
+$PAGE->set_url('/mod/lightboxgallery/view.php', array('id' => $cm->id));
+$PAGE->set_title($gallery->name);
+$PAGE->set_heading($course->shortname);
+$button = '';
+if (has_capability('mod/lightboxgallery:edit', $context)) {
+    $urlparams = array('id' => $id, 'page' => $page, 'editing' => $editing ? '0' : '1');
+    $url = new moodle_url('/mod/lightboxgallery/view.php', $urlparams);
+    $strediting = get_string('turnediting'.($editing ? 'off' : 'on'));
+    $button = $OUTPUT->single_button($url, $strediting, 'get').' ';
+}
+$PAGE->set_button($button);
+$PAGE->requires->css('/mod/lightboxgallery/assets/skins/sam/gallery-lightbox-skin.css');
+$PAGE->requires->yui_module('moodle-mod_lightboxgallery-lightbox', 'M.mod_lightboxgallery.init');
+
+$allowrssfeed = (lightboxgallery_rss_enabled() && $gallery->rss);
+$heading = get_string('displayinggallery', 'lightboxgallery', $gallery->name);
+
+if ($allowrssfeed) {
+    rss_add_http_header($context, 'mod_lightboxgallery', $gallery->id, $gallery->name);
+    $strrsssub = get_string('rsssubscribe', 'lightboxgallery');
+    $heading .= ' '.rss_get_link($context->id, $userid, 'mod_lightboxgallery', $gallery->id, $strrsssub);
+}
+
+echo $OUTPUT->header();
+
+echo $OUTPUT->heading($heading);
+
+if ($gallery->intro && !$editing) {
+    echo $OUTPUT->box(format_module_intro('lightboxgallery', $gallery, $cm->id), 'generalbox', 'intro');
+}
+if ($gallery->autoresize == AUTO_RESIZE_SCREEN || $gallery->autoresize == AUTO_RESIZE_BOTH) {
+    $resizecss = ' autoresize';
+} else {
+    $resizecss = '';
+}
+echo $OUTPUT->box_start('generalbox lightbox-gallery clearfix'.$resizecss);
+
+$fs = get_file_storage();
+$storedfiles = $fs->get_area_files($context->id, 'mod_lightboxgallery', 'gallery_images');
+
+$imagecount = 1;
+
+foreach ($storedfiles as $storedfile) {
+    if (!$storedfile->is_valid_image()) {
+        continue;
+    }
+
+    if ($gallery->perpage > 0 &&
+        (($imagecount > (($gallery->perpage * $page) + $gallery->perpage) || ($imagecount < ($gallery->perpage * $page) + 1)))) {
+        $imagecount++;
+        continue;
+    }
+
+    $image = new lightboxgallery_image($storedfile, $gallery, $cm);
+
+    echo $image->get_image_display_html($editing);
+
+    $imagecount++;
+}
+
+echo ($imagecount < 1 ? print_string('errornoimages', 'lightboxgallery') : '');
+echo $OUTPUT->box_end();
+
+if ($gallery->perpage) {
+    $barurl = $CFG->wwwroot.'/mod/lightboxgallery/view.php?id='.$cm->id.'&amp;' . ($editing ? 'editing=1&amp;' : '');
+    $pagingbar = new paging_bar($imagecount - 1, $page, $gallery->perpage, $barurl);
+    echo $OUTPUT->render($pagingbar);
+}
+
+$showtags = !in_array('tag', explode(',', get_config('lightboxgallery', 'disabledplugins')));
+
+if (!$editing && $showtags) {
+    $desccompare = $DB->sql_compare_text('description');
+    $sql = "SELECT $desccompare AS description
+              FROM {lightboxgallery_image_meta}
+             WHERE gallery = {$gallery->id}
+               AND metatype = 'tag'
+          GROUP BY $desccompare
+          ORDER BY COUNT($desccompare) DESC,
+                   $desccompare ASC";
+    if ($tags = $DB->get_records_sql($sql, array(), 0, 10)) {
+        lightboxgallery_print_tags(get_string('tagspopular', 'lightboxgallery'), $tags, $course->id, $gallery->id);
+    }
+}
+
+$options = array();
+
+if (has_capability('mod/lightboxgallery:addimage', $context)) {
+    $opturl = new moodle_url('/mod/lightboxgallery/imageadd.php', array('id' => $cm->id));
+    $options[] = html_writer::link($opturl, get_string('addimage', 'lightboxgallery'));
+}
+
+if ($gallery->comments && has_capability('mod/lightboxgallery:addcomment', $context)) {
+    $opturl = new moodle_url('/mod/lightboxgallery/comment.php', array('id' => $gallery->id));
+    $options[] = html_writer::link($opturl, get_string('addcomment', 'lightboxgallery'));
+}
+
+if (count($options) > 0) {
+    echo $OUTPUT->box(implode(' | ', $options), 'center');
+}
+
+if (!$editing && $gallery->comments && has_capability('mod/lightboxgallery:viewcomments', $context)) {
+    if ($comments = $DB->get_records('lightboxgallery_comments', array('gallery' => $gallery->id), 'timemodified ASC')) {
+        foreach ($comments as $comment) {
+            lightboxgallery_print_comment($comment, $context);
+        }
+    }
+}
+
+echo $OUTPUT->footer();
+
diff --git a/mod/lightboxgallery/yui/lightbox/assets/gallery-lightbox-core.css b/mod/lightboxgallery/yui/lightbox/assets/gallery-lightbox-core.css
new file mode 100644
index 0000000..9d5b7c6
--- /dev/null
+++ b/mod/lightboxgallery/yui/lightbox/assets/gallery-lightbox-core.css
@@ -0,0 +1 @@
+/* NEED TO SEPARATE SKINS APPROPRIATELY. */
\ No newline at end of file
diff --git a/mod/lightboxgallery/yui/lightbox/assets/skins/sam/closelabel.gif b/mod/lightboxgallery/yui/lightbox/assets/skins/sam/closelabel.gif
new file mode 100644
index 0000000000000000000000000000000000000000..87b4f8bd699386e3a6fcc2e50d7c61bfc4aabb8d
GIT binary patch
literal 979
zcmZ?wbhEHbbYc)=c*ekR;J|@{2M^AjJ2x^i^3tVC&CSj0*RTKj_3M)-PXYo0cI?>E
z)6+9$%9N0hkg%|@J9q8`1qGcvc``6CFd`x%G&J<hn>WG1!QZ}p`}_Crt5>gn{ra_R
z*|PBP@I{Lj`S|$w`}?P*rG5YY{qEhnXU?2SNJyxzu3ors;h#T$K79Ca@7}$foSdy&
zxBmY9d+OAwXV0EJb?Q__MaApauf4s!A3S&vA0NMS=g#~0?{C?%rLC>4pr9Z*Ir-_+
zr;{d4>gecLxpHM*Uf%TS)ARH5uU@^{*Vp&<?c3DU)UvX&88c?&=H}Ma)VzQH{`vFg
z8#iv;ym|A-j~^>5E2E;KQc_ZUeSM3Ii__E7r%jvI-roNB@nb(fzs$_c+qZ95RaO1}
z|Nq~=e++a1ia%Mv_UM2}P@FKZ|8IzCYHn$5Ywzgn>h9_7>+gx3G<nL@Y15}qh*9sI
zF>n5iiIZY<+?`^k#V9jLtyr*r!J=422f09{b+Ju)CUT+TQ$(XUHpFrqp3WW>wX1uv
zuMxADYt*_`D!j~cc9U4RqaSdy#4<#mnaaTWAexn73fF5^{TRmAubUT3M$0pEhL|<E
zUD#m2z|AKTtCSNd;OO1L#CBrl>XZa-W~L|(gBwDDiyC{R^)5V?SdhX{^V3U3;)26b
z9`PG&9vg+2LK~Ub)t*kN@Dpm%WzyoDVKHUWf+~JK$+ZDZ@~kR1)Kp$5Zt9+<`%Y)-
z>yw)=g|fzKY2BzS@eXpHy5ookQ(^-%AM<|&o|T%JuT^(X?uuf%wX|uMuC&0ET*U<&
zn5MV|N-Q);aBAjTtM<^<-0=N0@0#5*3?I(E@i^2b=>KSu3P<uZo)TZBhOc?4o*#|{
zCd~~sIzBO-d+A(5RcTiCLf?df(g)A{k}cJv&*sdW@yyeqP+NAcQ!7hmq=Ur_hJ}X<
zJh>#TbT%XyyED9)8M<diq4JFlZ_INnBhNRSWN={#WG}R3?9tY@*f5vn(9TD`Hjk$y
z`-i<;v)Lh+x2gDs$G3{KUJeBZ23IE46a^1nCO-v7cJ+Xwp5pa$Doz?%x*j^pY_;Y|
zJkJV_O-(E^1qz3GkA9iaWgKI1kby-$=i$OY?T85u27F3CUOdq__u>!}zkkRC?kPTh
mHXNSne@Ka2Tq>lLlg+!}=2PuWCXYMo(tpiJ>u+RWum%8KFq1q0

literal 0
HcmV?d00001

diff --git a/mod/lightboxgallery/yui/lightbox/assets/skins/sam/gallery-lightbox-skin.css b/mod/lightboxgallery/yui/lightbox/assets/skins/sam/gallery-lightbox-skin.css
new file mode 100644
index 0000000..eb0a807
--- /dev/null
+++ b/mod/lightboxgallery/yui/lightbox/assets/skins/sam/gallery-lightbox-skin.css
@@ -0,0 +1,83 @@
+#lightbox {
+	position: absolute;
+	left: 0;
+	width: 100%;
+	z-index: 100;
+	text-align: center;
+	line-height: 0;
+}
+#lightbox img { width: auto; height: auto; }
+#lightbox a img { border: none; }
+
+#outerImageContainer {
+	position: relative;
+	background-color: #fff;
+	width: 250px;
+	height: 250px;
+	margin: 0 auto;
+}
+#imageContainer { padding: 10px; }
+
+#loading {
+	position: absolute;
+	top: 40%;
+	left: 0%;
+	height: 25%;
+	background: url(loading.gif) no-repeat top center;
+	width: 100%;
+	text-align: center;
+	line-height: 0;
+}
+#hoverNav {
+	position: absolute;
+	top: 0;
+	left: 0;
+	height: 100%;
+	width: 100%;
+	z-index: 10;
+}
+#imageContainer > #hoverNav { left: 0; }
+#hoverNav a { outline: none; }
+
+#prevLink, #nextLink {
+	width: 49%;
+	height: 100%;
+	background-image: url(data:image/gif;base64,AAAA);
+	/* Trick IE into showing hover */ display: block;
+}
+#prevLink { left: 0; float: left; }
+#nextLink { right: 0; float: right; }
+#prevLink:hover, #prevLink:visited:hover { background: url(prevlabel.gif) left 15% no-repeat; }
+#nextLink:hover, #nextLink:visited:hover { background: url(nextlabel.gif) right 15% no-repeat; }
+
+#imageDataContainer {
+	font: 10px Verdana, Helvetica, sans-serif;
+	background-color: #fff;
+	margin: 0 auto;
+	line-height: 1.4em;
+	overflow: auto;
+	width: 100%;
+}
+
+#imageData { padding:0 10px; color: #666; }
+#imageData #imageDetails { width: 70%; float: left; text-align: left; }	
+#imageData #caption { font-weight: bold; }
+#imageData #numberDisplay { display: block; clear: left; padding-bottom: 1.0em; }			
+#imageData #bottomNavClose {
+	width: 66px;
+	height:22px;
+	background: url(closelabel.gif) no-repeat;
+	float: right;
+	padding-bottom: 0.7em;
+	outline: none;
+}
+
+#overlay {
+	position: absolute;
+	top: 0;
+	left: 0;
+	z-index: 90;
+	width: 100%;
+	height: 500px;
+	background-color: #000;
+}
\ No newline at end of file
diff --git a/mod/lightboxgallery/yui/lightbox/assets/skins/sam/gallery-lightbox.css b/mod/lightboxgallery/yui/lightbox/assets/skins/sam/gallery-lightbox.css
new file mode 100644
index 0000000..9ba7bd8
--- /dev/null
+++ b/mod/lightboxgallery/yui/lightbox/assets/skins/sam/gallery-lightbox.css
@@ -0,0 +1 @@
+#lightbox{position:absolute;left:0;width:100%;z-index:100;text-align:center;line-height:0;}#lightbox img{width:auto;height:auto;}#lightbox a img{border:none;}#outerImageContainer{position:relative;background-color:#fff;width:250px;height:250px;margin:0 auto;}#imageContainer{padding:10px;}#loading{position:absolute;top:40%;left:0;height:25%;background:url(loading.gif) no-repeat top center;width:100%;text-align:center;line-height:0;}#hoverNav{position:absolute;top:0;left:0;height:100%;width:100%;z-index:10;}#imageContainer>#hoverNav{left:0;}#hoverNav a{outline:none;}#prevLink,#nextLink{width:49%;height:100%;background-image:url(data:image/gif;base64,AAAA);display:block;}#prevLink{left:0;float:left;}#nextLink{right:0;float:right;}#prevLink:hover,#prevLink:visited:hover{background:url(prevlabel.gif) left 15% no-repeat;}#nextLink:hover,#nextLink:visited:hover{background:url(nextlabel.gif) right 15% no-repeat;}#imageDataContainer{font:10px Verdana,Helvetica,sans-serif;background-color:#fff;margin:0 auto;line-height:1.4em;overflow:auto;width:100%;}#imageData{padding:0 10px;color:#666;}#imageData #imageDetails{width:70%;float:left;text-align:left;}#imageData #caption{font-weight:bold;}#imageData #numberDisplay{display:block;clear:left;padding-bottom:1.0em;}#imageData #bottomNavClose{width:66px;height:22px;background:url(closelabel.gif) no-repeat;float:right;padding-bottom:.7em;outline:none;}#overlay{position:absolute;top:0;left:0;z-index:90;width:100%;height:500px;background-color:#000;}
diff --git a/mod/lightboxgallery/yui/lightbox/assets/skins/sam/loading.gif b/mod/lightboxgallery/yui/lightbox/assets/skins/sam/loading.gif
new file mode 100644
index 0000000000000000000000000000000000000000..f864d5fd38b7466c76b5a36dc0e3e9455c0126e2
GIT binary patch
literal 2767
zcmeH``%_bA0*1eHPVNawNVtR;Fkp-nQj8edfS`v<5L7TgR6wi;WfgH-0}4fE+c_uU
zB6tf6auF}FAcDdgg|bMU&H)LR5jARM!8$tuwd<npD63mr>$nHqS?K-=JN<t7e*5P6
z-uHc0#>Z+yGvz=Iegxp{+qWGZ9j{-%9vvN>n3$NJp6==CAqYaF(LfM1Z{EEA{{Gt9
z+Ba|B7z_sR+xabl|E~mm-*OXmhLq??y)HONjX>1ze1D?RIn=G1`RR-%fb}zgSh6^a
z(}Zw20U1L^Cs9UcyJfc+al#}J2xVlYUoR{`gd<uT7=(OQE|2-Z(nMC#lKGlv79x5d
zU>&QDxAb1w4>I~5gc?ccq<DVV(52nh>(G+T!I;H};U_uyHR0@hr>Qk1P1=6fvUBhR
zb|&^^cEQtu&W}=-=YR7o5UI)AD*~%J7bkVd5`xrdw{bHm;|Bf^_|FG$9l}`ruhnVF
zO%=6X*I#yro*pmfB;-A0cVjz73Qy)`oa=df_3Bx6!M3TNALf9BwI*di`jhdovR(I=
zFT31zui1Xw??+Ym-lWNq=V6~8t<Qvdt_E%oNn9fTbsQ2PqT;~c#bJ}<5JMc01#sU;
zgzFY-&{}#4gzc5BdZc%n_DfuHp417Oh+^(Xq9@rvVK3z=MGBC-ZJ?A!OaJ|&WI2Q|
zgzF7yw%;WZ2o6WA!U;!h+>t012$@*hy3So0QNJ#eIJ4<WkvH0<8aun~TE#+rL1fwm
z2%3eODa;%2DX8*yP(~+U(8U26{=&>Yh{qJ+aTY>ng8W1p4BrwB_>i7AY-xmG<ik=$
zYc4)q%}EQ+AaftsVY$wuztw`rA7i;nUuhjAfkZQTXsBfyIGn%^(iXjFN<JOV<sB@v
zOeL8&u+?`Sy#$8J4L5=`Me?m{Pj3wg-q)aSi#<4(j!DsZ0auESn4x3gIAmgp186pq
zgo_299&+4)>rA}hAeq`aX(yx~=c&|=$w&*&PpKd;G@@0oXK@D0x=;tyY&Eb|HKPsM
z71v`PO)na3pfO*xUD8Z|CQju)c+RSAH=5V^4vb9Q2JwHwt|-INt|!nD?AlRxF5ZT8
zaA9~hGb$~rMhQh_0+31$tkzyLi>X3c7>F!|Jyn`+5{LG=E`sIQbHA8!=`uday6D6Y
zNtVL?j^`6A%UuwO!`}j#s~H?w=P<5}Z2)*PPx|5q$MM+1K6_d_cie9JVArbrB2sRy
zOl**1Mc+|zLM>munG#O|##RApuODr^1+pL-?SHX+D6Dz_@%-Oo(fM&hHYZ-jWU5jf
z&nBYG;>F6&Y`veoLdZ@0WyrDsuXOP)9g*C`A(+R`Ryc2+9w_DJNaf@Dzg?~N{uI_}
zjV(!yygvrGv#KF*Mt{6H<LHZ)J7!w@mm1?8xw*lGP19;?P7#QjzW&o8C;q*eam++V
z$*0f>^v1Ve=hQyF2^E~bd#&iZg;(%dS^<ElV&_w|2i{kU&Q!~nSZtX@iOYf@g|Jdi
zl<)#Mmsv^o2M!^jMQ;0YfxSYuBu7=Bv|zAm0h^S?i%$^^TF>nM;oGSF1Y^&rY}Ian
zFrp%SBGPyN{Z?t%Mo#!qgLQ2)k{>KAv<Bj4#e#weRJgP60`lkeF{`Vd8ou5x(CWt=
z?SpjY*&H5g7LY|*@m|+2{;Mkm=#SYZ&=QV!*qUy+FH|mBx<zJP(g-24Wzt{broS2@
z=pGi04SfI@N_HD>?=zez<?;BhvPHm*F!MwT(&|4zM+J3m91Kb+i{BNdx|^4kY+Cz;
zG^DOGV4w{?za>KN*qPRf>^4QjcWgyxiC}7Vb6vGrBLR(1J&B%*gb{`!Jljb^2%jB$
zFBNUHANC6Q?0~<ecM#z*vJ`l(Gp=UQMr8(O#34k(j54G>M}cVtgk_;_DAB-BE?2dP
z(C9OIXza3Ao-@UyqX%`5cjg#cHl!uHq;&?~JO{eE+A2KSSD)s8v&CiV$kV$A=DG@i
z;6JY7z*8oPdj@bb<!X4U&DmGRri=Edg<skCOO|-3Ef?;a4hg*QVu?Hxz!D~!MWPRT
zYq)G)UA<%B%3_rcR+D0Uq@FHftQ!*f-e_2{DLw0_-0e5aOPSU`bX!|)p3(0JN+|4X
z9xYja{;x4w_bn;KT;4J7RtGv>JQoTAENW#ls(ucbGA#yhN>zbWqBTbLl>rGqOAY+`
z=psSt8VQE=9+X8^$l@<H4OjVp9E6cp#p)XQ=5J}2E-vhY=g+^mr_e}1h&z)N5-0a1
zPBJ(^nC|L#t9gwtA1zW(MK|eO(i2{Fw2qz<unXUWc{HVhxhw#{)TF#AmWp?a#|Uci
zOdl;N_w6fTGPE)Yn2agm3O>oeDzRvja79ry3nvLcOR7+)bIFyJVoz4}URM-47_u>V
zY*^e(o`?|l++*Y0uQ#&dKapW1o?J{jx+*_gKV^cW+W87KI7hZ5viXv$$=1IR^Z~yA
XWBrHU7iSEP8X8hQyAJO{V6g1pwSv80

literal 0
HcmV?d00001

diff --git a/mod/lightboxgallery/yui/lightbox/assets/skins/sam/nextlabel.gif b/mod/lightboxgallery/yui/lightbox/assets/skins/sam/nextlabel.gif
new file mode 100644
index 0000000000000000000000000000000000000000..6c40e51a31bce7ddfac5f10ec11e2403019ca4b2
GIT binary patch
literal 1252
zcmZ?wbhEHbv}aIY_}<L$_wV1AFJHR5yRTfivcJFo*|TRCE?hWt=+K)tZ{ELuziQR0
zj~_pN`}XbEuV4TE{fmi-`TqU;+qZAi)6-K^Q{&^~Jv}|oo;~~S-Mi@M=-<D8@7c3w
z*|KG?UcFkre0f1Z!G{kYqN1W28X7ik+?br4oRE<4^XJbOFJAcg_=JRn`1$!QUcC6y
zrAtXkNzb1@&&bH=>+1^-4^K=?3=9lhv0}y5t5@&ezkl%H!9Rcg{P^)>;>3wtwrq)w
zjlFm8UUPGERaI4EW8<e!pVHFOnwpx<pFbZI6cia5xq9{L*4EbC+}xCult+&qojP?Y
zEG%rvk|kTWZr!wL)AsG#U0q${;^G!9TJ-tz=hLT8A3Js|J3G6ywDiP@6SHQ`3Jndd
zsHo`Z=<x9HC@(L+apOjBZ||;MyJpUu`QX8Wyu3VbZ|`f@uHCtFCpb8G>C&ZHSy^-E
z&h_{AU$<`EzJ2?8dU||)ecRgFo;-Q-@ZrPj*RQWxv*z{d*M|=uc5-rxh={1Gt1B)p
zuB@z_J$v@!$B%Pza=v`|^8f#TV`F26Q9$<)Q2fcl$iUFdpaZfQlqVQC{xh)i3b|}p
zaIl#}SS#j)z{3M=0?J-<JT@*m+AU$6b?3y!#mD;<oV#Q^H!V3iS;LWOgVAB9gVJU$
z99&Oa4mQk|opK@L(If>X){18<BodDFHt|_0RIoTKaN?0;k$zLDaDs(fMA)t8M&iPw
zqC6=qmI?)nx)>#t4FnV&ADwPmY8kM^qRBa+Ss;jowc>(u6Q{856unO7<BrorqGYCM
z9BA}y6_v4Ii10e#I>XG0CH04+qke}t=kX<#j~4ncHM_B}aGWghWz=*1$MI;5Ihzn`
zR>+M+2LUH}Nrf;O8HEK5*-SzOS8gh?H%&OlI4R-5V@A)8?M)0{K5SZi?8BqustgAU
z4W70%>8X6NvjF;niDfctr^2SjR(=JxPU-N@Kg|kk4K@aj0`s0W2=G_6C~$~~mQ0YZ
z_~ZFtzJjxXVl#JDU_&dLOqZiOr_+IkwphCb3~r9UHhw$ABFy#3ot1^n;2<Z{l^Ms`
zlxA#nbTkop$XI6VvQge6L`7hJ8pj+qhiY*XNk(SwJB3RWxLGDJI`SwKID5r}T{$4Y
w)}pzLQLN&+s*CE4f&;U1<USmeOh2aid``)=%;$5tY+KY_nBH;*IxtuR0GFbqL;wH)

literal 0
HcmV?d00001

diff --git a/mod/lightboxgallery/yui/lightbox/assets/skins/sam/prevlabel.gif b/mod/lightboxgallery/yui/lightbox/assets/skins/sam/prevlabel.gif
new file mode 100644
index 0000000000000000000000000000000000000000..51a31c2fd7829eb95c071b4ba1d82863a723f5a8
GIT binary patch
literal 1264
zcmZ?wbhEHbv}aIY_}<BI=gytKfB$~__HEa$UAJ!C`uFc&baeE=g9pEU{rcz6pSZX<
zUtiz&`1oJHem!{b;Of<@H*VZ$XlO`CNC*rJ3<(MG^76WS_wJ)dk8a+)dEmf-$B!TX
z{Q2|Hp+kocAO7&+!>3Q5cJJQ3V8Md>_wP41H#<2wd3$@u#>PfPMHLklWo2dU+qZAR
zgb7ooOgVGr%#R;GmMmEk6cm)2ntJTmu_H&0<mBWuHa2eCw(aTDr^(651qB6VWo2n;
zY0sZOfBpLPxpU{PU%!6p)TxsvPri8ZA|@s#ARu7j!iBxPy|ZV}uBfP}uCAUjW5&IE
z_by+)?BL+AW5*76clY}G`l_m`&!0bEyLN5)^5xH-J@fbXFE1}oNlEeW@Tjb;+_PuT
zmoHyRN=owc^VhCjyLj>9-@kvaTeoii{{4A*d5MXMnVFeau3YKs>)X0@>)yS47cE-!
z>eZ{cbLZ~dxid60bk?j{%a$$s`0?ZS@84IgT6N*Vg`S?C6DLlrSg~UD>eWd}No{Ry
zo}Qi&5fPg=Z+`gjp`)W?VPWC<^XE^WK3!Z~{Qmv>@bK_=@813Y|KHfym|+yqI0O`b
zvM@3*bTa6G>;dHo29Ey>f}AoQ8x|aF<`C90nW1s<P`iM#U5UoVMMt|OjI-{X*tqz3
zzk+j@jOV5$CnswJ=jA*|_F>}-j^R+5pxE3c=EPF>qF}*uMm`(1lNtsE&J(Pa1h33E
zupm>2y`$?uz=8!nJvJRW5(X&`j&QP;UhrWsn9#tfti<Z@QR#v6ETJ-?HHHic&8;%E
zbr~BrIkB|tXXVr3Fck1-mCsZb@M>6bfKxUoPGg6n0iPgWs91pJ3q@95mJWd!P8X9U
z4IGv>3L7RK^<Xey+m;Z}?A+AME#kJK;PDdXWDAi7g`^<HBOZ*(9Wx}97&+No^b?Lq
zI58gOabe(@VX&F`cn4dDfzH{0CXY@Qx#QVyUKl(+F4O4B!|*dGslkCkI3hz};}fTs
zDk&BXtlT}S*IFGF4K6q{S-tqkSjK&!Z~_na8^uNimAP$96)dd_4zPAK1UN}Y`ffPH
ztTC^!!=d#;fTIXw$_iI58NQMu(n<=4ScPg>KC-j=Pf$n^uHy(fAlT3m7{nlD5pc^P
zhe1JD$<{{U2pfaIf~C{scvRR~7OYfx=4vj$aA0P}Jjus1__rn;W+*sj$-t4g;b#CN
d<CB%k=aqeX`Fwr@o7Rf?BD}i-oEaGztO3*evk(9P

literal 0
HcmV?d00001

diff --git a/mod/lightboxgallery/yui/lightbox/lightbox.js b/mod/lightboxgallery/yui/lightbox/lightbox.js
new file mode 100644
index 0000000..e9210b8
--- /dev/null
+++ b/mod/lightboxgallery/yui/lightbox/lightbox.js
@@ -0,0 +1,778 @@
+YUI.add('moodle-mod_lightboxgallery-lightbox', function(Y) {
+
+	/**
+	 * Inspired by the original Lightbox, this is a port to YUI.
+	 * See Lokesh Dhakar's original at http://www.huddletogether.com/projects/lightbox2/.
+	 * Currently supports everything that module supports with plans to integrate
+	 * additional functionality (i.e. non-images, slideshow mode, etc.) coming soon.
+	 *
+	 * @module gallery-lightbox
+	 */
+
+	var L = Y.Lang,
+		Node = Y.Node,
+		PX = "px",
+		CLICK = "click",
+		ANIM = "anim",
+		ACTIVE_IMAGE = "activeImage",
+		IMAGE_ARRAY = "imageArray",
+		OVERLAY_OPACITY = "overlayOpacity",
+		OVERLAY_DURATION = "overlayDuration",
+		LIGHTBOX = "lightbox",
+		OVERLAY = "overlay",
+		PREV_LINK = "prevLink",
+		NEXT_LINK = "nextLink",
+		HOVER_NAV = "hoverNav",
+
+		// global lightbox instance
+		lightboxInstance = null;
+
+	/**** BEGIN EXTENDING THE NODE CLASS ****/
+
+	// Add a few helper methods to the Node class that hopefully will be added
+	// in a future release of the Node class.  They simplify showing/hiding a given node
+	// by manipulating its "display" style.
+
+	Y.mix(
+		Node.prototype, {
+			/**
+		     * Display a node.
+		     *
+		     * @method show
+		     * @chainable
+		     */
+			show: function () {
+				this.setStyle("display", "");
+				return this;
+			},
+
+			/**
+		     * Hide a node.
+		     *
+		     * @method hide
+		     * @chainable
+		     */
+			hide: function () {
+				this.setStyle("display", "none");
+				return this;
+			},
+
+			/**
+		     * Check is a node is being shown. Specifically not called "visible"
+		     * so as not to confuse it with the visibility property.
+		     *
+		     * @method displayed
+		     * @return boolean
+		     */
+			displayed: function() {
+				return this.getStyle("display") != "none";
+			},
+
+			/**
+		     * Toggle the display of an element.
+		     *
+		     * @method toggle
+		     * @chainable
+		     */
+			toggle: function() {
+				this[this.displayed() ? "hide" : "show"]();
+				return this;
+			}
+		}
+	);
+
+	/**** END EXTENDING THE NODE CLASS ****/
+
+	/**
+	 * The Lightbox class provides the functionality for displaying
+	 * images in a panel above an overlay.  It automatically binds to
+	 * all anchor tags determined by the "selector" attribute.  It supports
+	 * grouping images together to produce a slideshow like effect.
+	 *
+	 * @class Lightbox
+	 * @constructor
+	 * @extends Base
+	 * @uses Node
+	 * @uses Anim
+	 *
+	 * @param config {Object} object with configuration property name/value pairs
+	 */
+	var LB = function (config) {
+		LB.superclass.constructor.apply(this, arguments);
+	};
+
+	/**
+     * The identity of the widget.
+     *
+     * @property Lightbox.NAME
+     * @type String
+     * @static
+     */
+	LB.NAME = LIGHTBOX;
+
+	/**
+     * Static property used to define the default attribute configuration of
+     * the Widget.
+     *
+     * @property Lightbox.ATTRS
+     * @type Object
+     * @protected
+     * @static
+     */
+	LB.ATTRS = {
+		/**
+         * The selector to determine which anchors should be bound to the Lightbox
+         * instance.  If an anchor element is bound to Lightbox, it's content will
+         * be displayed in a modal panel rather than on a separate page.
+         *
+         * @attribute selector
+         * @type String
+         * @default &quot;a[rel^=lightbox]&quot;
+         */
+		selector: {
+			value: "a[rel^=lightbox]",
+			validator: L.isString
+		},
+
+		/**
+         * The width of the border surrounding the displayed content.  This is used during
+         * resize operations.
+         *
+         * @attribute borderWidth
+         * @type Number
+         * @default 10
+         */
+		borderWidth: {
+			value: 10,
+			validator: L.isNumber
+		},
+
+		/**
+         * The amount of time (in seconds) for the overlay to take to appear when the
+         * Lightbox is displayed.
+         *
+         * @attribute overlayDuration
+         * @type Number
+         * @default 0.2
+         */
+		overlayDuration: {
+			value: 0.2,
+			validator: L.isNumber
+		},
+
+		/**
+         * The opacity of the overlay element once it is displayed.  This value is used
+         * during animation so that the overlay appears to be eased in.
+         *
+         * @attribute overlayOpacity
+         * @type Number
+         * @default 0.8
+         */
+		overlayOpacity: {
+			value: 0.8,
+			validator: L.isNumber
+		},
+
+		/**
+         * The amount of time (in seconds) each reisze animation should take.  This is used
+         * specifically during Lightbox height and width resize transformations.
+         *
+         * @attribute resizeDuration
+         * @type Number
+         * @default 0.5
+         */
+		resizeDuration: {
+			value: 0.5,
+			validator: L.isNumber
+		},
+
+		/**
+         * Whether or the Lighbox module should use animation when displaying, changing images,
+         * and hiding.  If set to false, the values of attributes that control animation settings
+         * are ignored.
+         *
+         * @attribute anim
+         * @type boolean
+         * @default !L.isUndefined(Y.Anim)
+         */
+		anim: {
+			value: !L.isUndefined(Y.Anim),
+			validator: L.isBoolean
+		},
+
+		/**
+         * A managed array of images that Lightbox can currently cycle through. The size of this array
+         * is defined by the number of images in a particular image group.  This array determines
+         * whether or not there are next and previous options. It's initialized when an image
+         * is clicked on.
+         *
+         * @attribute imageArray
+         * @type Array
+         */
+		imageArray: {
+			validator: L.isArray
+		},
+
+		/**
+         * The index of the currently displayed image in the "imageArray."
+         *
+         * @attribute activeImage
+         * @type Number
+         */
+		activeImage: {
+			validator: L.isNumber
+		},
+
+		/**
+         * Set of strings to be used when displaying content.  These can be customized
+         * (i.e. for internationalization) if necessary.
+         *
+         * @attribute strings
+         * @type Object
+         */
+		strings: {
+			value : {
+				labelImage: "Image",
+				labelOf: "of"
+			}
+		}
+	};
+
+	Y.extend(LB, Y.Base, {
+		/**
+	     * Construction logic executed during Lightbox instantiation. This
+	     * builds and inserts the markup necessary for the Lightbox to function
+	     * as well as binds all of the elements to the necessary events to make
+	     * the Lightbox functional.
+	     *
+	     * @method initializer
+	     * @param config (Object) set of configuration name/value pairs
+	     * @protected
+	     */
+		initializer: function (config) {
+			// Code inserts html at the bottom of the page that looks similar to this:
+	        //
+	        //  <div id="overlay"></div>
+	        //  <div id="lightbox">
+	        //      <div id="outerImageContainer">
+	        //          <div id="imageContainer">
+	        //              <img id="lightboxImage">
+	        //              <div style="" id="hoverNav">
+	        //                  <a href="#" id="prevLink"></a>
+	        //                  <a href="#" id="nextLink"></a>
+	        //              </div>
+	        //              <div id="loading"></div>
+	        //          </div>
+	        //      </div>
+	        //      <div id="imageDataContainer">
+	        //          <div id="imageData">
+	        //              <div id="imageDetails">
+	        //                  <span id="caption"></span>
+	        //                  <span id="numberDisplay"></span>
+	        //              </div>
+	        //              <div id="bottomNav">
+	        //                  <a href="#" id="bottomNavClose"></a>
+	        //              </div>
+	        //          </div>
+	        //      </div>
+	        //  </div>
+
+	        var objBody = Y.one(document.body),
+				create = Node.create;
+
+			objBody.append(create('<div id="overlay"></div>'));
+
+	        objBody.append(create('<div id="lightbox"></div>')
+				.append(create('<div id="outerImageContainer"></div>')
+					.append(create('<div id="imageContainer"></div>')
+						.append(create('<img id="lightboxImage" />'))
+						.append(create('<div id="hoverNav"></div>')
+							.append(create('<a id="prevLink" href="#"></a>'))
+							.append(create('<a id="nextLink" href="#"></a>'))
+						)
+						.append(create('<div id="loading"></div>'))
+					)
+				)
+				.append(create('<div id="imageDataContainer"></div>')
+					.append(create('<div id="imageData"></div>')
+						.append(create('<div id="imageDetails"></div>')
+							.append(create('<span id="caption"></span>'))
+							.append(create('<span id="numberDisplay"></span>'))
+						)
+						.append(create('<div id="bottomNav"></div>')
+							.append(create('<a id="bottomNavClose" href="#"></a>'))
+                            .append(create('<a id="bottomNavDownload" href="#"></a>'))
+						)
+					)
+				)
+			);
+
+			this._bindStartListener();
+
+			Y.one("#overlay").hide().on(CLICK, function () { this.end(); }, this);
+			Y.one("#lightbox").hide().on(CLICK, function (evt) {
+				if (evt.currentTarget.get("id") === LIGHTBOX) {
+					this.end();
+				}
+			}, this);
+
+			var size = (this.get(ANIM) ? 250 : 1) + PX;
+
+			Y.one("#outerImageContainer").setStyles({ width: size, height: size });
+			Y.one("#prevLink").on(CLICK, function (evt) { evt.halt(); this._changeImage(this.get(ACTIVE_IMAGE) - 1); }, this);
+			Y.one("#nextLink").on(CLICK, function (evt) { evt.halt(); this._changeImage(this.get(ACTIVE_IMAGE) + 1); }, this);
+			Y.one("#bottomNavClose").on(CLICK, function (evt) { evt.halt(); this.end(); }, this);
+            Y.one('#bottomNavDownload').on(CLICK, function (evt) {
+                evt.halt();
+                var active = this.get(ACTIVE_IMAGE);
+                window.open(this.get(IMAGE_ARRAY)[active][0] + '?forcedownload=1', '_blank');
+
+            }, this);
+
+			L.later(0, this, function () {
+				var ids = "overlay lightbox outerImageContainer imageContainer lightboxImage hoverNav prevLink nextLink loading " +
+                	"imageDataContainer imageData imageDetails caption numberDisplay bottomNav bottomNavClose";
+
+				Y.Array.each(ids.split(" "), function (element, index, array) {
+					this.addAttr(element, { value: Y.one("#" + element) });
+				}, this);
+			});
+		},
+
+		/**
+	     * Display overlay and Lightbox.  If image is part of a set, it
+	     * adds those images to an array so that a user can navigate between them.
+	     *
+	     * @method start
+	     * @param selectedLink { Y.Node } the node whose content should be displayed
+	     * @protected
+	     */
+		start: function (selectedLink) {
+			Y.all("select, object, embed").each(function() {
+				this.setStyle("visibility", "hidden");
+			});
+
+			// Stretch overlap to fill page and fade in
+			var overlay = this.get(OVERLAY).setStyles({ height: Y.DOM.docHeight() + PX, width: Y.DOM.docWidth() + PX }).show();
+			this.get(LIGHTBOX).show();
+			if (this.get(ANIM)) {
+				var anim = new Y.Anim({
+					node: overlay,
+					from: { opacity: 0 },
+					to: { opacity: this.get(OVERLAY_OPACITY) },
+					duration: this.get(OVERLAY_DURATION)
+				});
+				anim.run();
+			} else {
+				overlay.setStyle("opacity", this.get(OVERLAY_OPACITY));
+			}
+
+			var imageArray = [],
+				imageNum = 0;
+
+			if (selectedLink.get("rel") === LIGHTBOX) {
+				// If image is NOT part of a set, add single image to imageArray
+				imageArray.push([selectedLink.get("href"), selectedLink.get("title")]);
+			} else {
+				// If image is part of a set...
+                targetstring = '.lightbox-gallery a[href][rel="lightbox_gallery"]';
+				Y.all(targetstring).each(function () {
+					imageArray.push([this.get("href"), this.get("title")]);
+				});
+
+				while (imageArray[imageNum][0] !== selectedLink.get("href")) { imageNum++; }
+			}
+
+			this.set(IMAGE_ARRAY, imageArray);
+			border = this.get("borderWidth");
+			var lightboxTop = Y.DOM.docScrollY() + border*2,
+				lightboxLeft = Y.DOM.docScrollX();
+			this.get(LIGHTBOX).setStyles({ display: "", top: lightboxTop + PX, left: lightboxLeft + PX });
+
+			this._changeImage(imageNum);
+		},
+
+		/**
+	     * Hide the overlay and Lightbox and unbind any event listeners.
+	     *
+	     * @method end
+	     * @protected
+	     */
+		end: function () {
+			this._disableKeyboardNav();
+			this.get(LIGHTBOX).hide();
+
+			var overlay = this.get(OVERLAY);
+
+			if (this.get(ANIM)) {
+				var anim = new Y.Anim({
+					node: overlay,
+					from: { opacity: this.get(OVERLAY_OPACITY) },
+					to: { opacity: 0 },
+					duration: this.get(OVERLAY_DURATION)
+				});
+				anim.on("end", function () { overlay.hide(); });
+				anim.run();
+			} else {
+				overlay.setStyles({ opacity: 0 }).hide();
+			}
+
+			Y.all("select, object, embed").each(function() {
+				this.setStyle("visibility", "visible");
+			});
+		},
+
+		/**
+	     * Helper method responsible for binding listener to the page to process
+	     * lightbox anchors and images.
+	     *
+	     * @method _bindStartListener
+	     * @private
+	     */
+		_bindStartListener: function () {
+			Y.delegate(CLICK, Y.bind(function (evt) {
+				evt.halt();
+				this.start(evt.currentTarget);
+			}, this), Y.one(".lightbox-gallery"), this.get("selector"));
+		},
+
+		/**
+	     * Display the selected index by first showing a loading screen, preloading it
+	     * and displaying it once it has been loaded.
+	     *
+	     * @method _changeImage
+	     * @param imageNum { Number } the index of the image to be displayed
+	     * @private
+	     */
+		_changeImage: function (imageNum) {
+			this.set(ACTIVE_IMAGE, imageNum);
+
+			// Hide elements during transition
+			if (this.get(ANIM)) {
+				this.get("loading").show();
+			}
+			this.get("lightboxImage").hide();
+			this.get(HOVER_NAV).hide();
+			this.get(PREV_LINK).hide();
+			this.get(NEXT_LINK).hide();
+
+			// Hack: Opera9 doesn't support something in scriptaculous opacity and appear fx
+			// TODO: Do I need this since we are using YUI? Is this a scriptaculous/Opera
+			// bug, or just Opera bug?
+			this.get("imageDataContainer").setStyle("opacity", 0.0001);
+			this.get("numberDisplay").hide();
+
+			var imagePreloader = new Image();
+
+			// Once image is preloaded, resize image container
+			imagePreloader.onload = Y.bind(function () {
+				this.get("lightboxImage").set("src", this.get(IMAGE_ARRAY)[imageNum][0]);
+
+                // Get current viewport width and height
+                viewportWidth = Y.DOM.winWidth();
+                viewportHeight = Y.DOM.winHeight();
+                imageresize = Y.one('#region-main .autoresize');
+                if (imageresize){
+                    border = this.get("borderWidth");
+                    widthRatio = (viewportWidth-border*6)/imagePreloader.width;
+                    heightRatio = (viewportHeight-border*9)/imagePreloader.height;
+
+                    if (widthRatio > 1 && heightRatio > 1){
+                        bestRatio = 1;
+                    } else if (widthRatio < heightRatio){
+                        var bestRatio = widthRatio;
+                    } else {
+                        var bestRatio = heightRatio;
+                    }
+
+                    imgWidth = imagePreloader.width*bestRatio;
+                    imgHeight = imagePreloader.height*bestRatio;
+                } else {
+                    imgWidth = imagePreloader.width;
+                    imgHeight = imagePreloader.height;
+                }
+
+
+				this._resizeImageContainer(imgWidth, imgHeight);
+			}, this);
+			imagePreloader.src = this.get(IMAGE_ARRAY)[imageNum][0];
+		},
+
+		/**
+	     * Resize the image container so it is large enough to display the entire image.
+	     * Once this is complete it will delegate to another method to actually display the image.
+	     *
+	     * @method _resizeImageContainer
+	     * @param imgWidth { Number } image width
+	     * @param imgWidth { Number } image height
+	     * @private
+	     */
+		_resizeImageContainer: function (imgWidth, imgHeight) {
+
+            // Get current width and height
+            	var outerImageContainer = this.get("outerImageContainer"),
+				widthCurrent = outerImageContainer.get("offsetWidth"),
+				heightCurrent = outerImageContainer.get("offsetHeight"),
+
+       		// Get new width and height
+				widthNew = imgWidth + this.get("borderWidth") * 2,
+				heightNew = imgHeight + this.get("borderWidth") * 2,
+
+			// calculate size difference between new and old image
+				wDiff = widthCurrent - widthNew,
+				hDiff = heightCurrent - heightNew,
+
+				afterResize = Y.bind(function () {
+					this.get(PREV_LINK).setStyles({ height: imgHeight + PX });
+					this.get(NEXT_LINK).setStyles({ height: imgHeight + PX });
+					this.get("imageDataContainer").setStyles({ width: widthNew + PX });
+
+					this._showImage(imgWidth, imgHeight);
+				}, this);
+
+			if (wDiff !== 0 || hDiff !== 0) {
+				if (this.get(ANIM)) {
+					var resizeDuration = this.get("resizeDuration"),
+
+					anim = new Y.Anim({
+						node: outerImageContainer,
+						from: { width: widthCurrent + PX },
+						to: { width: widthNew + PX },
+						duration: resizeDuration
+					}),
+
+					onEnd = function () {
+						anim.getEvent("end").detach(onEnd);
+						this.setAttrs({
+							from: { height: heightCurrent + PX },
+							to: { height: heightNew + PX },
+							duration: resizeDuration
+						});
+						this.on("end", afterResize);
+						this.run();
+					};
+
+					anim.on("end", onEnd);
+
+					anim.run();
+				} else {
+					outerImageContainer.setStyles({ width: widthNew + PX, height: heightNew + PX});
+					L.later(0, this, afterResize);
+				}
+			} else {
+				// If new and old image are the same size, and no scaling is necessary,
+				// do a quick pause to prevent image flicker.
+				L.later(100, this, afterResize);
+			}
+		},
+
+		/**
+	     * Display the currently loaded image and then try to preload any neighboring images.
+	     *
+	     * @method _showImage
+	     * @private
+	     */
+		_showImage: function (imgWidth, imgHeight) {
+			this.get("loading").hide();
+
+			var lightBoxImage = this.get("lightboxImage");
+
+			if (this.get(ANIM)) {
+
+				var startOpacity = lightBoxImage.getStyle("display") === "none" ? 0 : lightBoxImage.getStyle("opacity") || 0,
+					anim = new Y.Anim({
+						node: lightBoxImage,
+						from: { opacity: startOpacity },
+						to: { opacity: 1 }
+					});
+
+				anim.on("end", this._updateDetails, this);
+                lightBoxImage.setStyle("width", imgWidth+'px');
+                lightBoxImage.setStyle("height", imgHeight+'px');
+				lightBoxImage.setStyle("opacity", startOpacity).show();
+				anim.run();
+			} else {
+				lightBoxImage.setStyle("opacity", 1).show();
+				this._updateDetails();
+			}
+
+			this._preloadNeighborImages();
+		},
+
+		/**
+	     * Use the title of the image as a caption and display information
+	     * about the current image and it's location in an image set (if applicable).
+	     *
+	     * @method _updateDetails
+	     * @private
+	     */
+		_updateDetails: function () {
+
+			var imageArray = this.get(IMAGE_ARRAY),
+				activeImage = this.get(ACTIVE_IMAGE),
+				caption = imageArray[activeImage][1];
+
+			// If caption is not null
+			if (caption !== "") {
+				this.get("caption").setContent(caption).show();
+			}
+
+			// If image is part of a set display "Image x of x"
+			if (imageArray.length > 1) {
+				this.get("numberDisplay").setContent(this.get("strings.labelImage") + " " + (activeImage + 1) + " " + this.get("strings.labelOf") + "  " + imageArray.length).show();
+			}
+
+			var imageDataContainer = this.get("imageDataContainer");
+
+			if (this.get(ANIM)) {
+
+				var startOpacity = imageDataContainer.getStyle("display") === "none" ? 0 : imageDataContainer.getStyle("opacity") || 0,
+					anim = new Y.Anim({
+						node: imageDataContainer,
+						from: { opacity: startOpacity },
+						to: { opacity: 1 },
+						duration: this.get("resizeDuration")
+					});
+
+				anim.on("end", function () {
+					// Update overlay size and update nav
+					this.get(OVERLAY).setStyle("height", Y.DOM.docHeight() + PX);
+					this._updateNav();
+				}, this);
+
+				imageDataContainer.setStyle("opacity", startOpacity).show();
+				anim.run();
+			} else {
+
+				imageDataContainer.setStyle("opacity", 1).show();
+				this.get(OVERLAY).setStyle("height", Y.DOM.docHeight() + PX);
+				this._updateNav();
+			}
+		},
+
+		/**
+	     * Update the navigation elements to display forward and/or backward
+	     * links if they're appropriate.
+	     *
+	     * @method _updateNav
+	     * @private
+	     */
+		_updateNav: function () {
+			var activeImage = this.get(ACTIVE_IMAGE);
+
+			this.get(HOVER_NAV).show();
+
+			// If not first image in set, display previous image button
+			if (activeImage > 0) {
+				this.get(PREV_LINK).show();
+			}
+
+			// If not first image in set, display previous image button
+			if (activeImage < (this.get(IMAGE_ARRAY).length - 1)) {
+				this.get(NEXT_LINK).show();
+			}
+
+			this._enableKeyboardNav();
+		},
+
+		/**
+	     * Enable keyboard shortcuts for closing Lightbox or switching images.
+	     *
+	     * @method _enableKeyboardNav
+	     * @private
+	     */
+		_enableKeyboardNav: function () {
+			Y.one(document.body).on("keydown", this._keyboardAction, this);
+		},
+
+		/**
+	     * Disable keyboard shortcuts for closing Lightbox or switching images.
+	     *
+	     * @method _disableKeyboardNav
+	     * @private
+	     */
+		_disableKeyboardNav: function () {
+			Y.one(document.body).unsubscribe("keydown", this._keyboardAction);
+		},
+
+		/**
+	     * Handle key strokes to allow for users to close Lightbox or switch images.
+	     *
+	     * @method _keyboardAction
+	     * @private
+	     */
+		_keyboardAction: function (evt) {
+			var keyCode = evt.keyCode,
+				escapeKey = 27,
+				key = String.fromCharCode(keyCode).toLowerCase();
+
+			if (key.match(/x|o|c/) || (keyCode === escapeKey)) { // close lightbox
+				this.end();
+			} else if ((key === 'p') || (keyCode === 37)) { // Display the previous image
+				if (this.get(ACTIVE_IMAGE) !== 0) {
+					this._disableKeyboardNav();
+					this._changeImage(this.get(ACTIVE_IMAGE) - 1);
+				}
+			} else if ((key === 'n') || (keyCode === 39)) { // Display the next image
+				if (this.get(ACTIVE_IMAGE) !== (this.get(IMAGE_ARRAY).length - 1)) {
+					this._disableKeyboardNav();
+					this._changeImage(this.get(ACTIVE_IMAGE) + 1);
+				}
+			}
+		},
+
+		/**
+	     * Preload images that are adjacent to the current image, if they exist,
+	     * to reduce waiting time.
+	     *
+	     * @method _preloadNeighborImages
+	     * @private
+	     */
+		_preloadNeighborImages: function () {
+			var activeImage = this.get(ACTIVE_IMAGE),
+				imageArray = this.get(IMAGE_ARRAY),
+				preloadNextImage, preloadPrevImage;
+
+			if (imageArray.length > activeImage + 1) {
+				preloadNextImage = new Image();
+				preloadNextImage.src = imageArray[activeImage + 1][0];
+			}
+
+			if (activeImage > 0) {
+				preloadPrevImage = new Image();
+				preloadPrevImage.src = imageArray[activeImage - 1][0];
+			}
+		}
+	});
+
+	Y.Lightbox = {
+		/**
+		 * This method returns the single, global LightBox instance.  Upon creation,
+		 * the Lightbox instance attaches itself to the page and is ready to be used.
+		 *
+		 * @method init
+		 * @return { Lightbox } global instance
+		 * @static
+		 */
+		init: function(config) {
+			if (lightboxInstance === null) {
+				lightboxInstance = new LB(config);
+			}
+			return lightboxInstance;
+		}
+	};
+
+    M.mod_lightboxgallery = M.mod_lightboxgallery || {
+        init:function() {
+            /*YUI().use("gallery-lightbox", function (Y) {   */
+
+                var already = Y.one('#lightbox');
+                if (already == null){
+					Y.Lightbox.init();
+                }
+
+            /*} */
+        }
+    };
+
+}, '@VERSION@' ,{requires:['base', 'node','anim']});
-- 
1.8.3.1

