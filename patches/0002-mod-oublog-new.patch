From faff2a2dd106f80aeb5c487b2addc9514f4112a9 Mon Sep 17 00:00:00 2001
From: root <root@moodle.levinsky.ac.il>
Date: Sun, 16 Jul 2017 23:47:56 +0300
Subject: [PATCH 02/95] mod/oublog (new)

---
 mod/oublog/.sams                                   |   24 +
 mod/oublog/README                                  |   76 +
 mod/oublog/allposts.php                            |  204 +
 mod/oublog/approve.php                             |  115 +
 mod/oublog/atomlib.php                             |  194 +
 .../moodle2/backup_oublog_activity_task.class.php  |   72 +
 .../backup/moodle2/backup_oublog_settingslib.php   |   26 +
 .../backup/moodle2/backup_oublog_stepslib.php      |  145 +
 .../moodle2/restore_oublog_activity_task.class.php |  122 +
 .../backup/moodle2/restore_oublog_stepslib.php     |  211 +
 mod/oublog/bloglogin.php                           |   41 +
 mod/oublog/classes/event/comment_approved.php      |  129 +
 mod/oublog/classes/event/comment_created.php       |  123 +
 mod/oublog/classes/event/comment_deleted.php       |  125 +
 .../event/course_module_instance_list_viewed.php   |   39 +
 mod/oublog/classes/event/course_module_viewed.php  |   49 +
 mod/oublog/classes/event/participation_viewed.php  |  114 +
 mod/oublog/classes/event/post_created.php          |  116 +
 mod/oublog/classes/event/post_deleted.php          |  119 +
 mod/oublog/classes/event/post_imported.php         |  112 +
 mod/oublog/classes/event/post_updated.php          |  119 +
 mod/oublog/classes/event/post_viewed.php           |  112 +
 mod/oublog/classes/event/save_failed.php           |  105 +
 mod/oublog/classes/event/site_entries_viewed.php   |  119 +
 mod/oublog/classes/task/cron_task.php              |   50 +
 mod/oublog/comment_form.php                        |  110 +
 mod/oublog/confirmloggedin.php                     |   60 +
 mod/oublog/db/access.php                           |  265 +
 mod/oublog/db/install.php                          |   65 +
 mod/oublog/db/install.xml                          |  195 +
 mod/oublog/db/log.php                              |   44 +
 mod/oublog/db/services.php                         |   69 +
 mod/oublog/db/tasks.php                            |   38 +
 mod/oublog/db/upgrade.php                          |  409 ++
 mod/oublog/deletecomment.php                       |  121 +
 mod/oublog/deletelink.php                          |   84 +
 mod/oublog/deletepost.php                          |  288 ++
 mod/oublog/deletepost_form.php                     |   94 +
 mod/oublog/editcomment.php                         |  190 +
 mod/oublog/editinstance.php                        |  116 +
 mod/oublog/editlink.php                            |  136 +
 mod/oublog/editpost.php                            |  261 +
 mod/oublog/externallib.php                         |  309 ++
 mod/oublog/feed.php                                |  211 +
 mod/oublog/import.php                              |  550 ++
 mod/oublog/index.php                               |  131 +
 mod/oublog/internaldoc/participation.txt           |   96 +
 mod/oublog/internaldoc/testcase.access.txt         |  177 +
 mod/oublog/internaldoc/testcase.basic.txt          |  469 ++
 mod/oublog/internaldoc/testcase.delete.txt         |  321 ++
 mod/oublog/internaldoc/testcase.importpages.txt    |  297 ++
 mod/oublog/internaldoc/testcase.oualertreport.txt  |  215 +
 mod/oublog/internaldoc/testcase.participation.txt  |  442 ++
 mod/oublog/internaldoc/testcase.rating.txt         |  199 +
 mod/oublog/internaldoc/testcase.readonlytime.txt   |  132 +
 mod/oublog/internaldoc/testcase.socialmedia.txt    |  201 +
 mod/oublog/internaldoc/testcase.usagestats.txt     |  338 ++
 mod/oublog/lang/README.txt                         |    8 +
 mod/oublog/lang/ca/help/oublog/allowcomments.html  |   28 +
 mod/oublog/lang/ca/help/oublog/completion.html     |   33 +
 mod/oublog/lang/ca/help/oublog/feed.html           |   32 +
 mod/oublog/lang/ca/help/oublog/tags.html           |   39 +
 mod/oublog/lang/ca/help/oublog/visibility.html     |   41 +
 mod/oublog/lang/ca/oublog.php                      |  127 +
 mod/oublog/lang/de/help/oublog/allowcomments.html  |   20 +
 mod/oublog/lang/de/help/oublog/completion.html     |   22 +
 mod/oublog/lang/de/help/oublog/feeds.html          |   21 +
 mod/oublog/lang/de/help/oublog/tags.html           |   22 +
 mod/oublog/lang/de/help/oublog/visibility.html     |   24 +
 mod/oublog/lang/de/oublog.php                      |  139 +
 mod/oublog/lang/en/oublog.php                      |  651 +++
 mod/oublog/lang/es/help/oublog/allowcomments.html  |   26 +
 mod/oublog/lang/es/help/oublog/completion.html     |   31 +
 mod/oublog/lang/es/help/oublog/feed.html           |   32 +
 mod/oublog/lang/es/help/oublog/tags.html           |   38 +
 mod/oublog/lang/es/help/oublog/visibility.html     |   38 +
 mod/oublog/lang/es/oublog.php                      |  115 +
 mod/oublog/lang/ja/help/oublog/allowcomments.html  |    9 +
 mod/oublog/lang/ja/help/oublog/completion.html     |   17 +
 mod/oublog/lang/ja/help/oublog/feed.html           |   19 +
 mod/oublog/lang/ja/help/oublog/tags.html           |   23 +
 mod/oublog/lang/ja/help/oublog/visibility.html     |   18 +
 mod/oublog/lang/ja/oublog.php                      |   94 +
 mod/oublog/lang/pt_br/oublog.php                   |  186 +
 mod/oublog/lib.php                                 | 1514 ++++++
 mod/oublog/link_form.php                           |   57 +
 mod/oublog/locallib.php                            | 5272 ++++++++++++++++++++
 mod/oublog/migratepersonal.php                     | 1028 ++++
 mod/oublog/mod_form.php                            |  334 ++
 mod/oublog/module.js                               |  223 +
 mod/oublog/movelink.php                            |   85 +
 mod/oublog/participation.php                       |  185 +
 mod/oublog/participation_table.php                 |  306 ++
 mod/oublog/participationlist.php                   |  202 +
 mod/oublog/pix/icon.gif                            |  Bin 0 -> 592 bytes
 mod/oublog/pix/icon.png                            |  Bin 0 -> 1147 bytes
 mod/oublog/pluginfile.php                          |   57 +
 mod/oublog/post_form.php                           |  166 +
 mod/oublog/renderer.php                            | 1649 ++++++
 mod/oublog/restrictcomments.php                    |  148 +
 mod/oublog/savegrades.php                          |   76 +
 mod/oublog/search.php                              |  212 +
 mod/oublog/settings.php                            |   56 +
 mod/oublog/stats_update.php                        |   68 +
 mod/oublog/styles.css                              |  732 +++
 mod/oublog/tests/behat/basic.feature               |  666 +++
 mod/oublog/tests/behat/behat_mod_oublog.php        |   50 +
 mod/oublog/tests/behat/importblog.feature          |  115 +
 mod/oublog/tests/behat/lastupdated.feature         |  200 +
 mod/oublog/tests/behat/personalblog.feature        |  396 ++
 mod/oublog/tests/behat/rate_individuals.feature    |   91 +
 .../tests/behat/separate_individuals.feature       |  123 +
 mod/oublog/tests/behat/time.period.feature         |   99 +
 mod/oublog/tests/externallib_test.php              |  673 +++
 mod/oublog/tests/generator/lib.php                 |  149 +
 mod/oublog/tests/generator_test.php                |  124 +
 mod/oublog/tests/locallib_test.php                 | 1572 ++++++
 .../tests/oublog_import_getallposts_test.php       |  190 +
 .../tests/oublog_import_getbloginfo_test.php       |  169 +
 mod/oublog/tests/oublog_import_getblogs_test.php   |  289 ++
 mod/oublog/tests/oublog_import_getposts_test.php   |  273 +
 mod/oublog/tests/oublog_test_lib.php               |  162 +
 mod/oublog/tests/participation_test.php            |  383 ++
 mod/oublog/userparticipation.php                   |  241 +
 mod/oublog/version.php                             |   30 +
 mod/oublog/view.php                                |  581 +++
 mod/oublog/viewedit.php                            |  145 +
 mod/oublog/viewpost.php                            |  301 ++
 mod/oublog/yui/accordion/accordion.js              |   90 +
 .../moodle-mod_oublog-savecheck-debug.js           |  Bin 0 -> 3102 bytes
 .../moodle-mod_oublog-savecheck-min.js             |  Bin 0 -> 891 bytes
 .../moodle-mod_oublog-savecheck.js                 |  Bin 0 -> 3102 bytes
 .../moodle-mod_oublog-tagselector-debug.js         |  Bin 0 -> 4962 bytes
 .../moodle-mod_oublog-tagselector-min.js           |  Bin 0 -> 1481 bytes
 .../moodle-mod_oublog-tagselector.js               |  Bin 0 -> 4962 bytes
 mod/oublog/yui/src/savecheck/build.json            |   10 +
 mod/oublog/yui/src/savecheck/js/savecheck.js       |   75 +
 mod/oublog/yui/src/savecheck/meta/savecheck.json   |   11 +
 mod/oublog/yui/src/tagselector/build.json          |   10 +
 mod/oublog/yui/src/tagselector/js/tagselector.js   |  108 +
 .../yui/src/tagselector/meta/tagselector.json      |   11 +
 mod/oublog/yui/statsbar/statsbar.js                |   29 +
 mod/oublog/yui/statsupdate/statsupdate.js          |   94 +
 143 files changed, 30977 insertions(+)
 create mode 100644 mod/oublog/.sams
 create mode 100644 mod/oublog/README
 create mode 100644 mod/oublog/allposts.php
 create mode 100644 mod/oublog/approve.php
 create mode 100644 mod/oublog/atomlib.php
 create mode 100644 mod/oublog/backup/moodle2/backup_oublog_activity_task.class.php
 create mode 100644 mod/oublog/backup/moodle2/backup_oublog_settingslib.php
 create mode 100644 mod/oublog/backup/moodle2/backup_oublog_stepslib.php
 create mode 100644 mod/oublog/backup/moodle2/restore_oublog_activity_task.class.php
 create mode 100644 mod/oublog/backup/moodle2/restore_oublog_stepslib.php
 create mode 100644 mod/oublog/bloglogin.php
 create mode 100644 mod/oublog/classes/event/comment_approved.php
 create mode 100644 mod/oublog/classes/event/comment_created.php
 create mode 100644 mod/oublog/classes/event/comment_deleted.php
 create mode 100644 mod/oublog/classes/event/course_module_instance_list_viewed.php
 create mode 100644 mod/oublog/classes/event/course_module_viewed.php
 create mode 100644 mod/oublog/classes/event/participation_viewed.php
 create mode 100644 mod/oublog/classes/event/post_created.php
 create mode 100644 mod/oublog/classes/event/post_deleted.php
 create mode 100644 mod/oublog/classes/event/post_imported.php
 create mode 100644 mod/oublog/classes/event/post_updated.php
 create mode 100644 mod/oublog/classes/event/post_viewed.php
 create mode 100644 mod/oublog/classes/event/save_failed.php
 create mode 100644 mod/oublog/classes/event/site_entries_viewed.php
 create mode 100644 mod/oublog/classes/task/cron_task.php
 create mode 100644 mod/oublog/comment_form.php
 create mode 100644 mod/oublog/confirmloggedin.php
 create mode 100644 mod/oublog/db/access.php
 create mode 100644 mod/oublog/db/install.php
 create mode 100644 mod/oublog/db/install.xml
 create mode 100644 mod/oublog/db/log.php
 create mode 100644 mod/oublog/db/services.php
 create mode 100644 mod/oublog/db/tasks.php
 create mode 100644 mod/oublog/db/upgrade.php
 create mode 100644 mod/oublog/deletecomment.php
 create mode 100644 mod/oublog/deletelink.php
 create mode 100644 mod/oublog/deletepost.php
 create mode 100644 mod/oublog/deletepost_form.php
 create mode 100644 mod/oublog/editcomment.php
 create mode 100644 mod/oublog/editinstance.php
 create mode 100644 mod/oublog/editlink.php
 create mode 100644 mod/oublog/editpost.php
 create mode 100644 mod/oublog/externallib.php
 create mode 100644 mod/oublog/feed.php
 create mode 100644 mod/oublog/import.php
 create mode 100644 mod/oublog/index.php
 create mode 100644 mod/oublog/internaldoc/participation.txt
 create mode 100644 mod/oublog/internaldoc/testcase.access.txt
 create mode 100644 mod/oublog/internaldoc/testcase.basic.txt
 create mode 100644 mod/oublog/internaldoc/testcase.delete.txt
 create mode 100644 mod/oublog/internaldoc/testcase.importpages.txt
 create mode 100644 mod/oublog/internaldoc/testcase.oualertreport.txt
 create mode 100644 mod/oublog/internaldoc/testcase.participation.txt
 create mode 100644 mod/oublog/internaldoc/testcase.rating.txt
 create mode 100644 mod/oublog/internaldoc/testcase.readonlytime.txt
 create mode 100644 mod/oublog/internaldoc/testcase.socialmedia.txt
 create mode 100644 mod/oublog/internaldoc/testcase.usagestats.txt
 create mode 100644 mod/oublog/lang/README.txt
 create mode 100644 mod/oublog/lang/ca/help/oublog/allowcomments.html
 create mode 100644 mod/oublog/lang/ca/help/oublog/completion.html
 create mode 100644 mod/oublog/lang/ca/help/oublog/feed.html
 create mode 100644 mod/oublog/lang/ca/help/oublog/tags.html
 create mode 100644 mod/oublog/lang/ca/help/oublog/visibility.html
 create mode 100644 mod/oublog/lang/ca/oublog.php
 create mode 100644 mod/oublog/lang/de/help/oublog/allowcomments.html
 create mode 100644 mod/oublog/lang/de/help/oublog/completion.html
 create mode 100644 mod/oublog/lang/de/help/oublog/feeds.html
 create mode 100644 mod/oublog/lang/de/help/oublog/tags.html
 create mode 100644 mod/oublog/lang/de/help/oublog/visibility.html
 create mode 100644 mod/oublog/lang/de/oublog.php
 create mode 100644 mod/oublog/lang/en/oublog.php
 create mode 100644 mod/oublog/lang/es/help/oublog/allowcomments.html
 create mode 100644 mod/oublog/lang/es/help/oublog/completion.html
 create mode 100644 mod/oublog/lang/es/help/oublog/feed.html
 create mode 100644 mod/oublog/lang/es/help/oublog/tags.html
 create mode 100644 mod/oublog/lang/es/help/oublog/visibility.html
 create mode 100644 mod/oublog/lang/es/oublog.php
 create mode 100644 mod/oublog/lang/ja/help/oublog/allowcomments.html
 create mode 100644 mod/oublog/lang/ja/help/oublog/completion.html
 create mode 100644 mod/oublog/lang/ja/help/oublog/feed.html
 create mode 100644 mod/oublog/lang/ja/help/oublog/tags.html
 create mode 100644 mod/oublog/lang/ja/help/oublog/visibility.html
 create mode 100644 mod/oublog/lang/ja/oublog.php
 create mode 100644 mod/oublog/lang/pt_br/oublog.php
 create mode 100644 mod/oublog/lib.php
 create mode 100644 mod/oublog/link_form.php
 create mode 100644 mod/oublog/locallib.php
 create mode 100644 mod/oublog/migratepersonal.php
 create mode 100644 mod/oublog/mod_form.php
 create mode 100644 mod/oublog/module.js
 create mode 100644 mod/oublog/movelink.php
 create mode 100644 mod/oublog/participation.php
 create mode 100644 mod/oublog/participation_table.php
 create mode 100644 mod/oublog/participationlist.php
 create mode 100644 mod/oublog/pix/icon.gif
 create mode 100644 mod/oublog/pix/icon.png
 create mode 100644 mod/oublog/pluginfile.php
 create mode 100644 mod/oublog/post_form.php
 create mode 100644 mod/oublog/renderer.php
 create mode 100644 mod/oublog/restrictcomments.php
 create mode 100644 mod/oublog/savegrades.php
 create mode 100644 mod/oublog/search.php
 create mode 100644 mod/oublog/settings.php
 create mode 100644 mod/oublog/stats_update.php
 create mode 100644 mod/oublog/styles.css
 create mode 100644 mod/oublog/tests/behat/basic.feature
 create mode 100644 mod/oublog/tests/behat/behat_mod_oublog.php
 create mode 100644 mod/oublog/tests/behat/importblog.feature
 create mode 100644 mod/oublog/tests/behat/lastupdated.feature
 create mode 100644 mod/oublog/tests/behat/personalblog.feature
 create mode 100644 mod/oublog/tests/behat/rate_individuals.feature
 create mode 100644 mod/oublog/tests/behat/separate_individuals.feature
 create mode 100644 mod/oublog/tests/behat/time.period.feature
 create mode 100644 mod/oublog/tests/externallib_test.php
 create mode 100644 mod/oublog/tests/generator/lib.php
 create mode 100644 mod/oublog/tests/generator_test.php
 create mode 100644 mod/oublog/tests/locallib_test.php
 create mode 100644 mod/oublog/tests/oublog_import_getallposts_test.php
 create mode 100644 mod/oublog/tests/oublog_import_getbloginfo_test.php
 create mode 100644 mod/oublog/tests/oublog_import_getblogs_test.php
 create mode 100644 mod/oublog/tests/oublog_import_getposts_test.php
 create mode 100644 mod/oublog/tests/oublog_test_lib.php
 create mode 100644 mod/oublog/tests/participation_test.php
 create mode 100644 mod/oublog/userparticipation.php
 create mode 100644 mod/oublog/version.php
 create mode 100644 mod/oublog/view.php
 create mode 100644 mod/oublog/viewedit.php
 create mode 100644 mod/oublog/viewpost.php
 create mode 100644 mod/oublog/yui/accordion/accordion.js
 create mode 100644 mod/oublog/yui/build/moodle-mod_oublog-savecheck/moodle-mod_oublog-savecheck-debug.js
 create mode 100644 mod/oublog/yui/build/moodle-mod_oublog-savecheck/moodle-mod_oublog-savecheck-min.js
 create mode 100644 mod/oublog/yui/build/moodle-mod_oublog-savecheck/moodle-mod_oublog-savecheck.js
 create mode 100644 mod/oublog/yui/build/moodle-mod_oublog-tagselector/moodle-mod_oublog-tagselector-debug.js
 create mode 100644 mod/oublog/yui/build/moodle-mod_oublog-tagselector/moodle-mod_oublog-tagselector-min.js
 create mode 100644 mod/oublog/yui/build/moodle-mod_oublog-tagselector/moodle-mod_oublog-tagselector.js
 create mode 100644 mod/oublog/yui/src/savecheck/build.json
 create mode 100644 mod/oublog/yui/src/savecheck/js/savecheck.js
 create mode 100644 mod/oublog/yui/src/savecheck/meta/savecheck.json
 create mode 100644 mod/oublog/yui/src/tagselector/build.json
 create mode 100644 mod/oublog/yui/src/tagselector/js/tagselector.js
 create mode 100644 mod/oublog/yui/src/tagselector/meta/tagselector.json
 create mode 100644 mod/oublog/yui/statsbar/statsbar.js
 create mode 100644 mod/oublog/yui/statsupdate/statsupdate.js

diff --git a/mod/oublog/.sams b/mod/oublog/.sams
new file mode 100644
index 0000000..edaba91
--- /dev/null
+++ b/mod/oublog/.sams
@@ -0,0 +1,24 @@
+<Files view.php>
+OPTIONAL_SAMS
+</Files>
+<Files viewpost.php>
+OPTIONAL_SAMS
+</Files>
+<Files editcomment.php>
+OPTIONAL_SAMS
+</Files>
+<Files search.php>
+OPTIONAL_SAMS
+</Files>
+<Files feed.php>
+OPTIONAL_SAMS
+</Files>
+<Files stats_update.php>
+OPTIONAL_SAMS
+</Files>
+<Files pluginfile.php>
+DISABLE_SAMS
+</Files>
+<Files *.js>
+DISABLE_SAMS
+</Files>
diff --git a/mod/oublog/README b/mod/oublog/README
new file mode 100644
index 0000000..b4a9834
--- /dev/null
+++ b/mod/oublog/README
@@ -0,0 +1,76 @@
+OU blog
+=======
+
+Copyright 2012 The Open University
+
+
+This is an alternative blog that you can install into standard Moodle.
+
+It does not replace the standard blog, and operates alongside it. There
+are two modes of use:
+
+1) As a course activity. In this case you can use it the same way as any
+   other module. You can have course-wide blogs (everyone in the course posts
+   to the same blog), group blogs, or individual blogs; the latter are
+   useful for assessed activities (where the student is supposed to keep
+   a journal which only they and their tutor can read).
+   
+2) As a replacement for standard Moodle personal blogs. In this case it would
+   be a good idea to turn off the standard Moodle blog system, or it'll be
+   very confusing. You then need to MANUALLY provide students with a link
+   to mod/oublog/view.php which will automatically take them to their
+   personal blog.
+
+When using for personal blogs, one feature of interest may be moderated public
+comments; when you allow comments from people who are not logged in, all such
+comments are moderated. 
+
+
+Branch:
+
+This is the development branch including latest, untested code. If you would
+like a tested version equivalent to an OU live release, please switch to a
+branch that matches your Moodle version (e.g. MOODLE_22_STABLE) using the
+above dropdown.
+
+Support:
+
+We cannot offer direct support. Please do not contact me directly. If you
+need assistance, try the blog forum on moodle.org. (Remember to make clear
+that you are using OU blog and not the standard blog.)
+
+Documentation:
+
+None. Please feel free to contribute documentation in the relevant area of
+the MoodleDocs wiki.
+
+Bug reports:
+
+Please report bugs using the GitHub 'Issues' tab (experimental). Before
+reporting a bug, please try the latest version to verify that the problem
+hasn't already been fixed. In each bug, please remember to give:
+
+1. Exact steps to reproduce your problem, starting from creating a new wiki
+   with default or specified settings.
+2. The ouwiki version you are using (from version.php or Modules admin screen).
+
+Reliability:
+
+Please note that this code is tested on OU systems but we rely on the
+community for testing on other systems.
+
+Requires:
+
+Moodle 2.2+
+Postgres / MySQL
+
+Install:
+
+Place the contents of this source tree into your Moodle installation so that
+within your Moodle root, this file is mod/oublog/README. Then visit the
+Moodle notifications page to install.
+
+If you want the blogs to be searchable, you also need to install the
+local_ousearch plugin. (It is best to do this before using OU blog much,
+otherwise it takes ages to install as it builds indexes for everything.)
+When you install the ousearch plugin, a search box will automatically appear.
diff --git a/mod/oublog/allposts.php b/mod/oublog/allposts.php
new file mode 100644
index 0000000..af4c96a
--- /dev/null
+++ b/mod/oublog/allposts.php
@@ -0,0 +1,204 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * This page prints all non-private personal oublog posts
+ *
+ * @author Jenny Gray <j.m.gray@open.ac.uk>
+ * @package oublog
+ */
+
+require_once('../../config.php');
+require_once('locallib.php');
+
+$tag    = optional_param('tag', null, PARAM_TAG);   // Tag to display.
+$page = optional_param('page', 0, PARAM_INT);
+
+if (!$oublog = $DB->get_record("oublog", array("global"=>1))) { // The personal blogs module.
+    print_error('personalblognotsetup', 'oublog');
+}
+
+if (!$cm = get_coursemodule_from_instance('oublog', $oublog->id)) {
+    print_error('invalidcoursemodule');
+}
+
+if (!$course = $DB->get_record("course", array("id" => $cm->course))) {
+    print_error('coursemisconf');
+}
+
+$offset = $page * OUBLOG_POSTS_PER_PAGE;
+$url = new moodle_url('/mod/oublog/allposts.php', array(
+        'page' => $page,
+        'tag' => $tag));
+$PAGE->set_url($url);
+
+$context = context_module::instance($cm->id);
+if (!empty($CFG->oublogallpostslogin) && $oublog->maxvisibility == OUBLOG_VISIBILITY_PUBLIC) {
+    // Set blog visibility temporarily to loggedin user to force login to this page.
+    $oublog->maxvisibility = OUBLOG_VISIBILITY_LOGGEDINUSER;
+    oublog_check_view_permissions($oublog, $context, $cm);
+    $oublog->maxvisibility = OUBLOG_VISIBILITY_PUBLIC;
+} else {
+    oublog_check_view_permissions($oublog, $context, $cm);
+}
+
+$oublogoutput = $PAGE->get_renderer('mod_oublog');
+
+// Check security.
+$blogtype = 'personal';
+$returnurl = 'allposts.php?';
+
+if ($tag) {
+    $returnurl .= '&amp;tag='.urlencode($tag);
+}
+
+$canmanageposts = has_capability('mod/oublog:manageposts', $context);
+$canaudit       = has_capability('mod/oublog:audit', $context);
+
+// Log view all site entries event.
+$params = array(
+        'context' => $context,
+        'objectid' => $oublog->id,
+        'other' => array(
+            'pageid' => $page
+    )
+);
+$event = \mod_oublog\event\site_entries_viewed::create($params);
+$event->add_record_snapshot('course_modules', $cm);
+$event->add_record_snapshot('course', $course);
+$event->trigger();
+
+// Get strings.
+$stroublog      = get_string('modulename', 'oublog');
+$strnewposts    = get_string('newerposts', 'oublog');
+$strolderposts  = get_string('olderposts', 'oublog');
+$strfeeds       = get_string('feeds', 'oublog');
+
+$strblogsearch  = get_string('searchblogs', 'oublog');
+
+// Get Posts.
+list($posts, $recordcount) = oublog_get_posts($oublog, $context, $offset, $cm, null, -1, null,
+        $tag, $canaudit, true);
+
+$PAGE->set_title(format_string($oublog->name));
+$PAGE->set_heading(format_string($course->fullname));
+$PAGE->navbar->add(format_string($oublog->name), new moodle_url('/mod/oublog/allposts.php'));
+$CFG->additionalhtmlhead .= oublog_get_meta_tags($oublog, 'all', '', $cm);
+
+// Generate extra navigation.
+if ($offset) {
+    $a = new stdClass();
+    $a->from = ($offset+1);
+    $a->to   = (($recordcount - $offset) > OUBLOG_POSTS_PER_PAGE) ? $offset +
+            OUBLOG_POSTS_PER_PAGE : $recordcount;
+    $PAGE->navbar->add(get_string('extranavolderposts', 'oublog', $a));
+} else if (!empty($tag)) {
+    $PAGE->navbar->add(get_string('extranavtag', 'oublog', $tag));
+}
+
+if (oublog_search_installed()) {
+    $buttontext=<<<EOF
+<form action="search.php" method="get"><div>
+  <input type="text" name="query" value=""/>
+  <input type="hidden" name="id" value="{$cm->id}"/>
+  <input type="submit" value="{$strblogsearch}"/>
+</div></form>
+EOF;
+} else {
+    $buttontext='';
+}
+$url = new moodle_url("$CFG->wwwroot/course/mod.php",
+        array('update' => $cm->id, 'return' => true, 'sesskey' => sesskey()));
+$PAGE->set_button($buttontext);
+
+// The right column, BEFORE the middle-column.
+if (isloggedin() and !isguestuser()) {
+    list($oublog, $oubloginstance) = oublog_get_personal_blog($USER->id);
+    $blogeditlink = "<br /><a href=\"view.php\" class=\"oublog-links\">$oubloginstance->name</a>";
+    $bc = new block_contents();
+    $bc->attributes['id'] = 'oublog-links';
+    $bc->attributes['class'] = 'oublog-sideblock block';
+    $bc->title = format_string($oublog->name);
+    $bc->content = $blogeditlink;
+    $PAGE->blocks->add_fake_block($bc, BLOCK_POS_RIGHT);
+}
+
+if ($oublog->statblockon) {
+    // 'Discovery' block.
+    $stats = array();
+    $stats[] = oublog_stats_output_participation($oublog, $cm, $oublogoutput, $course, true);
+    $stats[] = oublog_stats_output_commentpoststats($oublog, $cm, $oublogoutput, false, true);
+    $stats[] = oublog_stats_output_visitstats($oublog, $cm, $oublogoutput);
+    $stats[] = oublog_stats_output_poststats($oublog, $cm, $oublogoutput);
+    $stats[] = oublog_stats_output_commentstats($oublog, $cm, $oublogoutput);
+    $stats = $oublogoutput->render_stats_container('allposts', $stats);
+    $bc = new block_contents();
+    $bc->attributes['id'] = 'oublog-discover';
+    $bc->attributes['class'] = 'oublog-sideblock block';
+    $bc->title = get_string('discovery', 'oublog', oublog_get_displayname($oublog, true));
+    $bc->content = $stats;
+    if (!empty($stats)) {
+        $PAGE->blocks->add_fake_block($bc, BLOCK_POS_RIGHT);
+    }
+}
+
+if ($feeds = oublog_get_feedblock($oublog, 'all', '', false, $cm)) {
+    $bc = new block_contents();
+    $bc->attributes['id'] = 'oublog-feeds';
+    $bc->attributes['class'] = 'oublog-sideblock block';
+    $bc->title = $strfeeds;
+    $bc->content = $feeds;
+    $PAGE->blocks->add_fake_block($bc, BLOCK_POS_RIGHT);
+}
+// Must be called after add_fake_blocks.
+echo $OUTPUT->header();
+// Start main column.
+print '<div id="middle-column" class="has-right-column">';
+
+print $OUTPUT->skip_link_target();
+
+// Renderer hook so extra info can be added to global blog pages in theme.
+echo $oublogoutput->render_viewpage_prepost();
+
+// Print blog posts.
+if ($posts) {
+    echo "<div class='oublog-paging'>";
+    echo $OUTPUT->paging_bar($recordcount, $page, OUBLOG_POSTS_PER_PAGE, $returnurl);
+    echo '</div>';
+    echo '<div id="oublog-posts">';
+    $rowcounter = 1;
+    foreach ($posts as $post) {
+        $post->row = $rowcounter;
+        echo $oublogoutput->render_post($cm, $oublog, $post, $returnurl, $blogtype,
+                $canmanageposts, $canaudit, true, false);
+        $rowcounter++;
+    }
+    echo "<div class='oublog-paging'>";
+    echo $OUTPUT->paging_bar($recordcount, $page, OUBLOG_POSTS_PER_PAGE, $returnurl);
+    echo '</div>';
+}
+
+// Print information allowing the user to log in if necessary, or letting
+// them know if there are no posts in the blog.
+if (!isloggedin() || isguestuser()) {
+    print '<p class="oublog_loginnote">' . get_string('maybehiddenposts', 'oublog',
+            (object) array('link' => 'bloglogin.php', 'name' => oublog_get_displayname($oublog))) . '</p>';
+} else if (!$posts) {
+    print '<p class="oublog_noposts">' . get_string('noposts', 'oublog', oublog_get_displayname($oublog)) . '</p>';
+}
+print '</div>';
+// Finish the page.
+echo $OUTPUT->footer();
diff --git a/mod/oublog/approve.php b/mod/oublog/approve.php
new file mode 100644
index 0000000..fe9d68f
--- /dev/null
+++ b/mod/oublog/approve.php
@@ -0,0 +1,115 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+// Script used to approve moderated comments. This can be called in two ways;
+// from email (which is a GET request) and from the web (which is POST).
+require_once('../../config.php');
+require_once('locallib.php');
+
+// Shared parameter
+$mcommentid = required_param('mcomment', PARAM_INT);
+
+// Parameters for each type
+if ($_SERVER['REQUEST_METHOD'] == 'GET') {
+    $email = true;
+    // Check request parameters from email
+    $key = required_param('key', PARAM_ALPHANUM);
+    $approve = required_param('approve', PARAM_INT) ? true : false;
+} else {
+    $email = false;
+    // Check request parameters from web
+    require_sesskey();
+    if (optional_param('bapprove', false, PARAM_TEXT)) {
+        $approve = true;
+    } else {
+        required_param('breject', PARAM_TEXT); // Sanity check
+        $approve = false;
+    }
+    $redirectlower = optional_param('last', 0, PARAM_INT) ? false : true;
+}
+
+// Load comment and check it
+if (!($mcomment = $DB->get_record('oublog_comments_moderated', array('id'=> $mcommentid)))) {
+    print_error('invalidrequest', 'error');
+}
+
+// Use post page for continue on error messages
+$backlink = $CFG->wwwroot . '/mod/oublog/viewpost.php?post=' .
+        $mcomment->postid;
+
+// Load post, blog, etc
+if (!$post = oublog_get_post($mcomment->postid, false)) {
+    print_error('error_unspecified', 'oublog', $backlink, 'A1');
+}
+if (!($oublog = oublog_get_blog_from_postid($post->id))) {
+    print_error('error_unspecified', 'oublog', $backlink, 'A2');
+}
+if (!$cm = get_coursemodule_from_instance('oublog', $oublog->id)) {
+    print_error('invalidcoursemodule', 'error', $backlink);
+}
+if (!$course = $DB->get_record("course", array("id"=>$cm->course))) {
+    print_error('coursemisconf', 'error', $backlink);
+}
+
+// Check state
+if ($mcomment->approval) {
+    print_error('error_alreadyapproved', 'oublog', $backlink);
+}
+if ($email && $key !== $mcomment->secretkey) {
+    print_error('error_wrongkey', 'oublog', $backlink);
+}
+
+// Require login, it to be your own post, and commenting permission
+require_login($course, $cm);
+$context = context_module::instance($cm->id);
+oublog_check_view_permissions($oublog, $context, $cm);
+if ($USER->id !== $post->userid ||
+        !oublog_can_view_post($post, $USER, $context, $oublog->global) ||
+        !oublog_can_comment($cm, $oublog, $post)) {
+    print_error('accessdenied', 'oublog', $backlink);
+}
+
+// The post must (still) allow public comments
+if ($post->allowcomments < OUBLOG_COMMENTS_ALLOWPUBLIC ||
+    $oublog->allowcomments < OUBLOG_COMMENTS_ALLOWPUBLIC) {
+    print_error('error_moderatednotallowed', 'oublog', $backlink);
+}
+
+// OK they are actually allowed to approve / reject this
+if (!$approvedcomment = oublog_approve_comment($mcomment, $approve)) {
+    print_error('error_unspecified', 'oublog', 'A5', $backlink);
+}
+
+// Redirect back to view post
+$target = 'viewpost.php?post=' . $post->id;
+if (!$email && $redirectlower) {
+    $target .= '#awaiting';
+}
+
+if ($approvedcomment > 0 ) {
+    // Log approved comment event.
+    $params = array(
+            'context' => $context,
+            'objectid' => $approvedcomment,
+            'other' => array(
+                'postid' => $mcomment->postid,
+                'mcommentid' => $mcommentid,
+                'oublogid' => $oublog->id
+            )
+    );
+    $event = \mod_oublog\event\comment_approved::create($params);
+    $event->trigger();
+}
+redirect($target);
diff --git a/mod/oublog/atomlib.php b/mod/oublog/atomlib.php
new file mode 100644
index 0000000..78c53ca
--- /dev/null
+++ b/mod/oublog/atomlib.php
@@ -0,0 +1,194 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+/**
+ * This library provides functions to generate Atom feeds and tries to follow the same API as lib/rsslib.php
+ *
+ * @author Matt Clarkson <mattc@catalyst.net.nz>
+ * @package oublog
+ */
+
+
+// This function return all the common atom headers.
+
+function atom_standard_header($uniqueid, $link, $updated, $title = null, $description = null) {
+
+    global $CFG, $USER, $OUTPUT;
+
+    static $pixpath = '';
+
+    $status = true;
+    $result = "";
+
+    if (!$site = get_site()) {
+        $status = false;
+    }
+
+    if ($status) {
+
+        // Calculate title, link and description.
+        if (empty($title)) {
+            $title = format_string($site->fullname);
+        }
+
+        // Xml headers.
+        $result .= "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n";
+        $result .= "<feed xmlns=\"http://www.w3.org/2005/Atom\">\n";
+
+        // Open the channel
+        // write channel info.
+        $result .= atom_full_tag('id', 1, false, htmlspecialchars($uniqueid));
+        $result .= atom_full_tag('updated', 1, false, date_format_rfc3339($updated));
+        $result .= atom_full_tag('title', 1, false, htmlspecialchars(html_to_text($title)));
+        $result .= atom_full_tag('link', 1, false, null, array('href' => $link, 'rel' => 'self'));
+        if (!empty($description)) {
+            $result .= atom_full_tag('subtitle', 1, false, $description);
+        }
+        $result .= atom_full_tag('generator', 1, false, 'Moodle');
+        $today = getdate();
+        $result .= atom_full_tag('rights', 1, false, '&#169; '. $today['year'] .' '.
+                format_string($site->fullname));
+
+        // Write image info.
+        $atompix = $OUTPUT->pix_url('i/rsssitelogo');
+
+        // Write the info.
+        $result .= atom_full_tag('logo', 1, false, $atompix);
+
+    }
+
+    if (!$status) {
+        return false;
+    } else {
+        return $result;
+    }
+}
+
+
+function atom_add_items($items) {
+
+    global $CFG;
+
+    $result = '';
+    $xhtmlattr = array('type'       => 'xhtml');
+
+    if (!empty($items)) {
+        foreach ($items as $item) {
+            $result .= atom_start_tag('entry', 1, true);
+            $result .= atom_full_tag('title', 2, false, htmlspecialchars(html_to_text($item->title)));
+            $result .= atom_full_tag('link', 2, false, null, array('href' => $item->link, 'rel'=>'alternate'));
+            $result .= atom_full_tag('updated', 2, false, date_format_rfc3339($item->pubdate));
+            // Include the author if exists.
+            if (isset($item->author)) {
+                $result .= atom_start_tag('author', 2, true);
+                $result .= atom_full_tag('name', 3, false, $item->author);
+                $result .= atom_end_tag('author', 2, true);
+            }
+            $result .= atom_full_tag('content', 2, false, '<div xmlns="http://www.w3.org/1999/xhtml">'.
+                    clean_text($item->description, FORMAT_HTML).'</div>', $xhtmlattr);
+            $result .= atom_full_tag('id', 2, false, $item->link);
+            if (isset($item->tags)) {
+                $tagdata = array();
+                if (isset($item->tagscheme)) {
+                    $tagdata['scheme'] = $item->tagscheme;
+                }
+                foreach ($item->tags as $tag) {
+                    $tagdata['term'] = $tag;
+                    $result .= atom_full_tag('category', 2, true, false, $tagdata);
+                }
+            }
+            $result .= atom_end_tag('entry', 1, true);
+
+        }
+    } else {
+        $result = false;
+    }
+    return $result;
+}
+
+
+// This function return all the common footers for every rss feed in the site.
+function atom_standard_footer($title = null, $link = null, $description = null) {
+
+    global $CFG, $USER;
+
+    $status = true;
+    $result = '';
+
+    // Close the rss tag.
+    $result .= '</feed>';
+
+    return $result;
+}
+
+
+
+// Return the xml start tag.
+function atom_start_tag($tag, $level=0, $endline = false, $attributes = null) {
+    if ($endline) {
+        $endchar = "\n";
+    } else {
+        $endchar = "";
+    }
+    $attrstring = '';
+    if (!empty($attributes) && is_array($attributes)) {
+        foreach ($attributes as $key => $value) {
+            $attrstring .= " ".$key."=\"".htmlspecialchars($value)."\"";
+        }
+    }
+    return str_repeat(" ", $level*2) . "<" . $tag . $attrstring . ">" . $endchar;
+}
+
+// Return the xml end tag.
+function atom_end_tag($tag, $level = 0, $endline = true) {
+    if ($endline) {
+        $endchar = "\n";
+    } else {
+        $endchar = "";
+    }
+    return str_repeat(" ", $level*2) . "</" . $tag . ">" . $endchar;
+}
+
+
+// Return the start tag, the contents and the end tag.
+function atom_full_tag($tag, $level = 0, $endline = true, $content, $attributes = null) {
+    global $CFG;
+    $st = atom_start_tag($tag, $level, $endline, $attributes);
+    if ($content === false) {
+        $st = preg_replace('~>$~', ' />', $st);
+        return $st;
+    }
+    $co="";
+    $co = preg_replace("/\r\n|\r/", "\n", $content);
+    $et = atom_end_tag($tag, 0, true);
+
+    return $st.$co.$et;
+}
+
+
+function date_format_rfc3339($timestamp=0) {
+
+    $date = date('Y-m-d\TH:i:s', $timestamp);
+
+    $matches = array();
+
+    if (preg_match('/^([\-+])(\d{2})(\d{2})$/', date('O', $timestamp), $matches)) {
+        $date .= $matches[1].$matches[2].':'.$matches[3];
+    } else {
+        $date .= 'Z';
+    }
+    return $date;
+}
+
diff --git a/mod/oublog/backup/moodle2/backup_oublog_activity_task.class.php b/mod/oublog/backup/moodle2/backup_oublog_activity_task.class.php
new file mode 100644
index 0000000..35c2cbf
--- /dev/null
+++ b/mod/oublog/backup/moodle2/backup_oublog_activity_task.class.php
@@ -0,0 +1,72 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * @package moodlecore
+ * @subpackage backup-moodle2
+ * @copyright 2010 onwards Eloy Lafuente (stronk7) {@link http://stronk7.com}
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+require_once($CFG->dirroot . '/mod/oublog/backup/moodle2/backup_oublog_stepslib.php'); // Because it exists (must)
+require_once($CFG->dirroot . '/mod/oublog/backup/moodle2/backup_oublog_settingslib.php'); // Because it exists (optional)
+
+/**
+ * oublog backup task that provides all the settings and steps to perform one
+ * complete backup of the activity
+ */
+class backup_oublog_activity_task extends backup_activity_task {
+
+    /**
+     * Define (add) particular settings this activity can have
+     */
+    protected function define_my_settings() {
+        // No particular settings for this activity
+    }
+
+    /**
+     * Define (add) particular steps this activity can have
+     */
+    protected function define_my_steps() {
+        $this->add_step(new backup_oublog_activity_structure_step('oublog structure', 'oublog.xml'));
+    }
+
+    /**
+     * Code the transformations to perform in the activity in
+     * order to get transportable (encoded) links
+     */
+    static public function encode_content_links($content) {
+        global $CFG;
+
+        $base = preg_quote($CFG->wwwroot, "/");
+
+        // Link to the list of oublog
+        $search="/(".$base."\/mod\/oublog\/index.php\?id\=)([0-9]+)/";
+        $content= preg_replace($search, '$@OUBLOGINDEX*$2@$', $content);
+
+        // Link to oublog view by moduleid
+        $search="/(".$base."\/mod\/oublog\/view.php\?id\=)([0-9]+)/";
+        $content= preg_replace($search, '$@OUBLOGVIEW*$2@$', $content);
+
+        $search = "/(".$base."\/mod\/oublog\/view.php\?user\=)([0-9]+)/";
+        $content = preg_replace($search, '$@OUBLOGVIEWUSER*$2@$', $content);
+
+        $search = "/(".$base."\/mod\/oublog\/viewpost.php\?post\=)([0-9]+)/";
+        $content = preg_replace($search, '$@OUBLOGVIEWPOST*$2@$', $content);
+
+        return $content;
+    }
+}
diff --git a/mod/oublog/backup/moodle2/backup_oublog_settingslib.php b/mod/oublog/backup/moodle2/backup_oublog_settingslib.php
new file mode 100644
index 0000000..c683516
--- /dev/null
+++ b/mod/oublog/backup/moodle2/backup_oublog_settingslib.php
@@ -0,0 +1,26 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * @package moodlecore
+ * @subpackage backup-moodle2
+ * @copyright 2010 onwards Eloy Lafuente (stronk7) {@link http://stronk7.com}
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+ // This activity has not particular settings but the inherited from the generic
+ // backup_activity_task so here there isn't any class definition, like the ones
+ // existing in /backup/moodle2/backup_settingslib.php (activities section)
diff --git a/mod/oublog/backup/moodle2/backup_oublog_stepslib.php b/mod/oublog/backup/moodle2/backup_oublog_stepslib.php
new file mode 100644
index 0000000..785bc14
--- /dev/null
+++ b/mod/oublog/backup/moodle2/backup_oublog_stepslib.php
@@ -0,0 +1,145 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * @package moodlecore
+ * @subpackage backup-moodle2
+ * @copyright 2010 onwards Eloy Lafuente (stronk7) {@link http://stronk7.com}
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+/**
+ * Define all the backup steps that will be used by the backup_oublog_activity_task
+ */
+
+/**
+ * Define the complete oublog structure for backup, with file and id annotations
+ */
+class backup_oublog_activity_structure_step extends backup_activity_structure_step {
+
+    protected function define_structure() {
+
+        // To know if we are including userinfo
+        $userinfo = $this->get_setting_value('userinfo');
+
+        // Define each element separated
+        $oublog = new backup_nested_element('oublog', array('id'), array('name', 'course',
+                'accesstoken', 'intro', 'introformat', 'allowcomments', 'individual',
+                'maxbytes', 'maxattachments', 'maxvisibility', 'global', 'views',
+                'completionposts', 'completioncomments', 'reportingemail', 'displayname',
+                'statblockon', 'allowimport', 'introonpost', 'tags', 'assessed',
+                'assesstimestart', 'assesstimefinish', 'scale', 'grading', 'restricttags',
+                'postfrom', 'postuntil', 'commentfrom', 'commentuntil'
+        ));
+        $instances = new backup_nested_element('instances');
+
+        $instance = new backup_nested_element('instance', array('id'), array(
+            'userid', 'name', 'summary', 'accesstoken', 'views'));
+
+        $links = new backup_nested_element('links');
+        $link = new backup_nested_element('link', array('id'), array('title', 'url', 'sortorder'));
+
+        $posts = new backup_nested_element('posts');
+        $post  = new backup_nested_element('post', array('id'), array('groupid', 'title',
+                                                                             'message', 'timeposted', 'allowcomments',
+                                                                             'timeupdated', 'lasteditedby', 'deletedby',
+                                                                             'timedeleted', 'visibility'));
+
+        $ratings = new backup_nested_element('ratings');
+
+        $rating = new backup_nested_element('rating', array('id'), array(
+            'component', 'ratingarea', 'scaleid', 'value', 'userid', 'timecreated', 'timemodified'));
+
+        $comments = new backup_nested_element('comments');
+        $comment  = new backup_nested_element('comment', array('id'), array('userid', 'title', 'message',
+                                                                                   'timeposted', 'deletedby', 'timedeleted',
+                                                                                    'authorname', 'authorip', 'timeapproved'));
+
+        $edits = new backup_nested_element('edits');
+        $edit  = new backup_nested_element('edit', array('id'), array('userid', 'oldtitle',
+                                                                             'oldmessage', 'timeupdated'));
+
+        $taginstances = new backup_nested_element('tags');
+        $taginstance  = new backup_nested_element('tag', array('id'), array('tag'));
+
+        // Build the tree
+        $oublog->add_child($instances);
+        $instances->add_child($instance);
+
+        $oublog->add_child($links);
+        $links->add_child($link);
+
+        $instance->add_child($posts);
+        $posts->add_child($post);
+
+        $post->add_child($ratings);
+        $ratings->add_child($rating);
+
+        $post->add_child($comments);
+        $comments->add_child($comment);
+
+        $post->add_child($edits);
+        $edits->add_child($edit);
+
+        $post->add_child($taginstances);
+        $taginstances->add_child($taginstance);
+
+        // Define sources
+        $oublog->set_source_table('oublog', array('id' => backup::VAR_ACTIVITYID));
+
+        // All the rest of elements only happen if we are including user info
+        if ($userinfo) {
+            $instance->set_source_table('oublog_instances', array('oublogid'=> backup::VAR_PARENTID));
+            $link->set_source_table('oublog_links', array('oubloginstancesid'=> backup::VAR_PARENTID));
+            $post->set_source_table('oublog_posts', array('oubloginstancesid'=> backup::VAR_PARENTID));
+            $comment->set_source_table('oublog_comments', array('postid'=> backup::VAR_PARENTID));
+            $edit->set_source_table('oublog_edits', array('postid'=> backup::VAR_PARENTID));
+            $taginstance->set_source_sql("SELECT t.id, t.tag
+                                          FROM {oublog_tags} t
+                                          JOIN {oublog_taginstances} ti
+                                           ON t.id=ti.tagid
+                                          WHERE ti.postid=?", array(backup::VAR_PARENTID));
+
+            $rating->set_source_table('rating', array('contextid' => backup::VAR_CONTEXTID,
+                            'component' => backup_helper::is_sqlparam('mod_oublog'),
+                            'ratingarea' => backup_helper::is_sqlparam('post')));
+            $rating->set_source_alias('rating', 'value');
+        }
+
+        // Define id annotations
+        $instance->annotate_ids('user', 'userid');
+        $post->annotate_ids('group', 'groupid');
+        $post->annotate_ids('user', 'lasteditedby');
+        $post->annotate_ids('user', 'deletedby');
+        $comment->annotate_ids('user', 'userid');
+        $edit->annotate_ids('user', 'userid');
+        $link->annotate_ids('oublog_instances', 'id');
+        $oublog->annotate_ids('scale', 'scale');
+        $rating->annotate_ids('scale', 'scaleid');
+        $rating->annotate_ids('user', 'userid');
+
+        // Define file annotations
+        $oublog->annotate_files('mod_oublog', 'intro', null); // This file area hasn't itemid
+        $instance->annotate_files('mod_oublog', 'summary', 'id');
+        $post->annotate_files('mod_oublog', 'attachment', 'id');
+        $post->annotate_files('mod_oublog', 'message', 'id');
+        $edit->annotate_files('mod_oublog', 'edit', 'id');
+        $comment->annotate_files('mod_oublog', 'messagecomment', 'id');
+
+        // Return the root element (oublog), wrapped into standard activity structure
+        return $this->prepare_activity_structure($oublog);
+    }
+}
diff --git a/mod/oublog/backup/moodle2/restore_oublog_activity_task.class.php b/mod/oublog/backup/moodle2/restore_oublog_activity_task.class.php
new file mode 100644
index 0000000..949df1d
--- /dev/null
+++ b/mod/oublog/backup/moodle2/restore_oublog_activity_task.class.php
@@ -0,0 +1,122 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * @package moodlecore
+ * @subpackage backup-moodle2
+ * @copyright 2010 onwards Eloy Lafuente (stronk7) {@link http://stronk7.com}
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+require_once($CFG->dirroot . '/mod/oublog/backup/moodle2/restore_oublog_stepslib.php'); // Because it exists (must)
+
+/**
+ * oublog restore task that provides all the settings and steps to perform one
+ * complete restore of the activity
+ */
+class restore_oublog_activity_task extends restore_activity_task {
+
+    /**
+     * Define (add) particular settings this activity can have
+     */
+    protected function define_my_settings() {
+        // No particular settings for this activity
+    }
+
+    /**
+     * Define (add) particular steps this activity can have
+     */
+    protected function define_my_steps() {
+        // oublog only has one structure step
+        $this->add_step(new restore_oublog_activity_structure_step('oublog_structure', 'oublog.xml'));
+    }
+
+    /**
+     * Define the contents in the activity that must be
+     * processed by the link decoder
+     */
+    static public function define_decode_contents() {
+        $contents = array();
+
+        $contents[] = new restore_decode_content('oublog', array('intro'), 'oublog');
+        $contents[] = new restore_decode_content('oublog_instances', array('summary'), 'oublog_instances');
+        $contents[] = new restore_decode_content('oublog_posts', array('message'), 'oublog_posts');
+        $contents[] = new restore_decode_content('oublog_comments', array('message'), 'oublog_comments');
+        $contents[] = new restore_decode_content('oublog_edits', array('oldmessage'), 'oublog_edits');
+
+        return $contents;
+    }
+
+    /**
+     * Define the decoding rules for links belonging
+     * to the activity to be executed by the link decoder
+     */
+    static public function define_decode_rules() {
+        $rules = array();
+
+        $rules[] = new restore_decode_rule('OUBLOGINDEX', '/mod/oublog/index.php?id=$1', 'course');
+        $rules[] = new restore_decode_rule('OUBLOGVIEW', '/mod/oublog/view.php?id=$1', 'course_module');
+        $rules[] = new restore_decode_rule('OUBLOGVIEWUSER', '/mod/oublog/view.php?user=$1', 'user');
+        $rules[] = new restore_decode_rule('OUBLOGVIEWPOST', '/mod/oublog/viewpost.php?post=$1', 'oublog_post');
+
+        return $rules;
+
+    }
+
+    /**
+     * Define the restore log rules that will be applied
+     * by the {@link restore_logs_processor} when restoring
+     * oublog logs. It must return one array
+     * of {@link restore_log_rule} objects
+     */
+    static public function define_restore_log_rules() {
+        $rules = array();
+
+        $rules[] = new restore_log_rule('oublog', 'add', 'view.php?id={course_module}', '{oublog}');
+        $rules[] = new restore_log_rule('oublog', 'update', 'view.php?id={course_module}', '{oublog}');
+        $rules[] = new restore_log_rule('oublog', 'view', 'view.php?id={course_module}', '{oublog}');
+        $rules[] = new restore_log_rule('oublog', 'add entry', 'view.php?id={course_module}', '{oublog}');
+        $rules[] = new restore_log_rule('oublog', 'update entry', 'view.php?id={course_module}', '{oublog}');
+        $rules[] = new restore_log_rule('oublog', 'view responses', 'report.php?id={course_module}', '{oublog}');
+        $rules[] = new restore_log_rule('oublog', 'update feedback', 'report.php?id={course_module}', '{oublog}');
+        $rules[] = new restore_log_rule('oublog', 'view all', 'index.php?id={course}', '{oublog}');
+
+        return $rules;
+    }
+
+    /**
+     * Define the restore log rules that will be applied
+     * by the {@link restore_logs_processor} when restoring
+     * course logs. It must return one array
+     * of {@link restore_log_rule} objects
+     *
+     * Note this rules are applied when restoring course logs
+     * by the restore final task, but are defined here at
+     * activity level. All them are rules not linked to any module instance (cmid = 0)
+     */
+    static public function define_restore_log_rules_for_course() {
+        $rules = array();
+
+        // Fix old wrong uses (missing extension)
+        $rules[] = new restore_log_rule('oublog', 'view all', 'index?id={course}', null,
+                                        null, null, 'index.php?id={course}');
+        $rules[] = new restore_log_rule('oublog', 'view all', 'index.php?id={course}', null);
+
+        return $rules;
+    }
+}
diff --git a/mod/oublog/backup/moodle2/restore_oublog_stepslib.php b/mod/oublog/backup/moodle2/restore_oublog_stepslib.php
new file mode 100644
index 0000000..656bf6e
--- /dev/null
+++ b/mod/oublog/backup/moodle2/restore_oublog_stepslib.php
@@ -0,0 +1,211 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * @package moodlecore
+ * @subpackage backup-moodle2
+ * @copyright 2010 onwards Eloy Lafuente (stronk7) {@link http://stronk7.com}
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+/**
+ * Define all the restore steps that will be used by the restore_oublog_activity_task
+ */
+
+/**
+ * Structure step to restore one oublog activity
+ */
+class restore_oublog_activity_structure_step extends restore_activity_structure_step {
+
+    protected function define_structure() {
+
+        $paths = array();
+        $userinfo = $this->get_setting_value('userinfo');
+
+        $paths[] = new restore_path_element('oublog', '/activity/oublog');
+
+        if ($userinfo) {
+            $paths[] = new restore_path_element('oublog_instance', '/activity/oublog/instances/instance');
+            $paths[] = new restore_path_element('oublog_link', '/activity/oublog/links/link');
+            $paths[] = new restore_path_element('oublog_post', '/activity/oublog/instances/instance/posts/post');
+            $paths[] = new restore_path_element('oublog_rating', '/activity/oublog/instances/instance/posts/post/ratings/rating');
+            $paths[] = new restore_path_element('oublog_comment', '/activity/oublog/instances/instance/posts/post/comments/comment');
+            $paths[] = new restore_path_element('oublog_edit', '/activity/oublog/instances/instance/posts/post/edits/edit');
+            $paths[] = new restore_path_element('oublog_tag', '/activity/oublog/instances/instance/posts/post/tags/tag');
+        }
+
+        // Return the paths wrapped into standard activity structure
+        return $this->prepare_activity_structure($paths);
+    }
+
+    protected function process_oublog($data) {
+        global $DB;
+
+        $data = (object)$data;
+        $oldid = $data->id;
+        $data->course = $this->get_courseid();
+
+        if (!isset($data->intro) && isset($data->summary)) {
+            $data->intro = $data->summary;
+            $data->introformat = FORMAT_HTML;
+        }
+
+        // if it's the global blog and we already have one then assume we can't restore this module since it already exits
+        if (!empty($data->global) && $DB->record_exists('oublog', array('global'=> 1))) {
+            $this->set_mapping('oublog', $oldid, $oldid, true);
+            return(true);
+        }
+
+        // insert the oublog record
+        $newitemid = $DB->insert_record('oublog', $data);
+        // immediately after inserting "activity" record, call this
+        $this->apply_activity_instance($newitemid);
+    }
+
+    protected function process_oublog_instance($data) {
+        global $DB;
+
+        $data = (object)$data;
+        $oldid = $data->id;
+
+        $data->oublogid = $this->get_new_parentid('oublog');
+        $data->userid = $this->get_mappingid('user', $data->userid);
+
+        $newitemid = $DB->insert_record('oublog_instances', $data);
+        $this->set_mapping('oublog_instance', $oldid, $newitemid, true);
+    }
+
+    protected function process_oublog_link($data) {
+        global $DB;
+
+        $data = (object)$data;
+        $oldid = $data->id;
+
+        $data->oublogid = $this->get_new_parentid('oublog');
+        $data->oubloginstancesid =  $this->get_mappingid('oublog_instance', $data->oubloginstancesid);
+
+        $newitemid = $DB->insert_record('oublog_links', $data);
+        $this->set_mapping('oublog_link', $oldid, $newitemid);
+    }
+
+    protected function process_oublog_post($data) {
+        global $DB;
+
+        $data = (object)$data;
+        $oldid = $data->id;
+
+        $data->oubloginstancesid = $this->get_new_parentid('oublog_instance');
+        $data->groupid = $this->get_mappingid('group', $data->groupid);
+
+        // Following comment copied from old 1.9 restore code.
+        // Currently OUBlog has no "start time" or "deadline" fields
+        // that make sense to offset at restore time. Edit and delete times
+        // must remain stable even through restores with startdateoffsets.
+
+        $newitemid = $DB->insert_record('oublog_posts', $data);
+        $this->set_mapping('oublog_post', $oldid, $newitemid, true);
+    }
+
+    protected function process_oublog_comment($data) {
+        global $DB;
+
+        $data = (object)$data;
+        $oldid = $data->id;
+
+        $data->postid = $this->get_new_parentid('oublog_post');
+        $data->userid = $this->get_mappingid('user', $data->userid);
+
+        $newitemid = $DB->insert_record('oublog_comments', $data);
+        $this->set_mapping('oublog_comment', $oldid, $newitemid, true);
+    }
+
+    protected function process_oublog_edit($data) {
+        global $DB;
+
+        $data = (object)$data;
+        $oldid = $data->id;
+
+        $data->postid = $this->get_new_parentid('oublog_post');
+        $data->userid = $this->get_mappingid('user', $data->userid);
+
+        $newitemid = $DB->insert_record('oublog_edits', $data);
+        $this->set_mapping('oublog_edit', $oldid, $newitemid, true);
+    }
+
+    protected function process_oublog_tag($data) {
+        global $DB;
+
+        $data = (object)$data;
+        $oldid = $data->id;
+
+        // First check to see if tag exists:
+        $existingtag = $DB->get_record('oublog_tags', array('tag'=>$data->tag));
+        if (empty($existingtag->id)) {
+            $tag = new stdclass();
+            $tag->tag = $data->tag;
+            $tagid = $DB->insert_record('oublog_tags', $tag);
+        } else {
+            $tagid = $existingtag->id;
+        }
+        // Now insert taginstance record.
+        $taginstance = new stdclass();
+        $taginstance->oubloginstancesid = $this->get_new_parentid('oublog_instance');
+        $taginstance->postid = $this->get_new_parentid('oublog_post');
+        $taginstance->tagid = $tagid;
+        $newitemid = $DB->insert_record('oublog_taginstances', $taginstance);
+
+        $this->set_mapping('oublog_tag', $oldid, $newitemid);
+    }
+
+    protected function process_oublog_rating($data) {
+        global $DB;
+
+        $data = (object)$data;
+
+        // Cannot use ratings API, cause, it's missing the ability to specify times (modified/created).
+        $data->contextid = $this->task->get_contextid();
+        $data->itemid = $this->get_new_parentid('oublog_post');
+        if ($data->scaleid < 0) { // Scale found, get mapping.
+            $data->scaleid = -($this->get_mappingid('scale', abs($data->scaleid)));
+        }
+        $data->rating = $data->value;
+        $data->userid = $this->get_mappingid('user', $data->userid);
+        $data->timecreated = $this->apply_date_offset($data->timecreated);
+        $data->timemodified = $this->apply_date_offset($data->timemodified);
+
+        // Make sure that we have both component and ratingarea set.
+        if (empty($data->component)) {
+            $data->component = 'mod_oublog';
+        }
+        if (empty($data->ratingarea)) {
+            $data->ratingarea = 'post';
+        }
+
+        $newitemid = $DB->insert_record('rating', $data);
+    }
+
+    protected function after_execute() {
+
+        // Add oublog related files, no need to match by itemname (just internally handled context)
+        $this->add_related_files('mod_oublog', 'intro', null);
+        $this->add_related_files('mod_oublog', 'summary', 'oublog_instance');
+        // Add post related files
+        $this->add_related_files('mod_oublog', 'attachment', 'oublog_post');
+        $this->add_related_files('mod_oublog', 'message', 'oublog_post');
+        $this->add_related_files('mod_oublog', 'messagecomment', 'oublog_comment');
+        $this->add_related_files('mod_oublog', 'edit', 'oublog_edit');
+    }
+}
diff --git a/mod/oublog/bloglogin.php b/mod/oublog/bloglogin.php
new file mode 100644
index 0000000..f4166e9
--- /dev/null
+++ b/mod/oublog/bloglogin.php
@@ -0,0 +1,41 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+require_once('../../config.php');
+global $CFG;
+// This script requires login so users have a chance to log into (a) blogs
+// that don't let you see anything without a login, (b) blogs that might let
+// you see more with a login
+
+$returnurl=optional_param('returnurl', '', PARAM_RAW);
+// Security check on URL, allow redirect to only php scripts in blog folder
+if (!strpos($returnurl, $CFG->wwwroot . '/mod/oublog/') === 0) {
+    $returnurl='';
+}
+
+if ($CFG->autologinguests) {
+    $_SESSION['wantsurl']=$returnurl;
+    redirect($CFG->wwwroot.'/login/');
+} else {
+    require_login();
+
+    // Default returns to blog default view (which will automatically jump to user
+    // now they are logged in)
+    if ($returnurl) {
+        redirect($returnurl);
+    } else {
+        redirect('view.php');
+    }
+}
diff --git a/mod/oublog/classes/event/comment_approved.php b/mod/oublog/classes/event/comment_approved.php
new file mode 100644
index 0000000..615725d
--- /dev/null
+++ b/mod/oublog/classes/event/comment_approved.php
@@ -0,0 +1,129 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * The mod_oublog comment approved event.
+ *
+ * @package    mod_oublog
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+namespace mod_oublog\event;
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * The mod_oublog comment approved event class.
+ *
+ * @property-read array $other {
+ *      Extra information about the event.
+ *
+ *      - int blogid: The oublog the post is part of.
+ *
+ * }
+ *
+ * @package    mod_oublog
+ * @since      Moodle 2.7
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+class comment_approved extends \core\event\base {
+
+    /**
+     * Init method.
+     *
+     * @return void
+     */
+    protected function init() {
+        $this->data['crud'] = 'u';
+        $this->data['edulevel'] = self::LEVEL_PARTICIPATING;
+        $this->data['objecttable'] = 'oublog_comments';
+    }
+
+    /**
+     * Returns description of what happened.
+     *
+     * @return string
+     */
+    public function get_description() {
+        return "The user with id '$this->userid' has approved the moderated comment
+            '{$this->other['mcommentid']}' upon post with id '{$this->other['postid']}'
+            to be added with id '$this->objectid' to the oublog with the course module id
+            '$this->contextinstanceid'.";
+    }
+
+    /**
+     * Return localised event name.
+     *
+     * @return string
+     */
+    public static function get_name() {
+        return get_string('event:commentapproved', 'mod_oublog');
+    }
+
+    /**
+     * Get URL related to the action
+     *
+     * @return \moodle_url
+     */
+    public function get_url() {
+        $url = new \moodle_url('/mod/oublog/viewpost.php', array('post' => $this->other['postid']));
+        $url->set_anchor('cid' . $this->objectid);
+        return $url;
+    }
+
+    /**
+     * Return the legacy event log data.
+     *
+     * @return array|null
+     */
+    protected function get_legacy_logdata() {
+        // The legacy log table expects a relative path to /mod/oublog/.
+        $logurl = substr($this->get_url()->out_as_local_url(), strlen('/mod/oublog/'));
+        return array($this->courseid, 'oublog', 'approve comment', $logurl, $this->other['oublogid'], $this->contextinstanceid);
+    }
+
+    /**
+     * Custom validation.
+     *
+     * @throws \coding_exception
+     * @return void
+     */
+    protected function validate_data() {
+        parent::validate_data();
+
+        if (!isset($this->objectid)) {
+            throw new \coding_exception('The \'commentid\' value must be set in the object.');
+        }
+
+        if (!isset($this->other['postid'])) {
+            throw new \coding_exception('The \'postid\' value must be set in other.');
+        }
+
+        if (!isset($this->other['mcommentid'])) {
+            throw new \coding_exception('The \'mcommentid\' value must be set in other.');
+        }
+
+        if (!isset($this->other['oublogid'])) {
+            throw new \coding_exception('The \'oublogid\' value must be set in other.');
+        }
+
+        if ($this->contextlevel != CONTEXT_MODULE) {
+            throw new \coding_exception('Context level must be CONTEXT_MODULE.');
+        }
+    }
+}
diff --git a/mod/oublog/classes/event/comment_created.php b/mod/oublog/classes/event/comment_created.php
new file mode 100644
index 0000000..bffab04
--- /dev/null
+++ b/mod/oublog/classes/event/comment_created.php
@@ -0,0 +1,123 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * The mod_oublog comment created event.
+ *
+ * @package    mod_oublog
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+namespace mod_oublog\event;
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * The mod_oublog comment created event class.
+ *
+ * @property-read array $other {
+ *      Extra information about the event.
+ *
+ *      - int oublogid: The oublog which the post is part of.
+ *      - int postid: The post which this comment is part of.
+ * }
+ *
+ * @package    mod_oublog
+ * @since      Moodle 2.7
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+class comment_created extends \core\event\base {
+    /**
+     * Init method.
+     *
+     * @return void
+     */
+    protected function init() {
+        $this->data['crud'] = 'c';
+        $this->data['edulevel'] = self::LEVEL_PARTICIPATING;
+        $this->data['objecttable'] = 'oublog_comments';
+    }
+
+    /**
+     * Returns description of what happened.
+     *
+     * @return string
+     */
+    public function get_description() {
+        return "The user with id '$this->userid' has created the comment with id
+            '$this->objectid' on the post with id '{$this->other['postid']}'
+            in the oublog with the course module id '$this->contextinstanceid'.";
+    }
+
+    /**
+     * Return localised event name.
+     *
+     * @return string
+     */
+    public static function get_name() {
+        return get_string('event:commentcreated', 'mod_oublog');
+    }
+
+    /**
+     * Get URL related to the action
+     *
+     * @return \moodle_url
+     */
+    public function get_url() {
+        $url = new \moodle_url('/mod/oublog/viewpost.php', array('post' => $this->other['postid']));
+        $url->set_anchor('cid' . $this->objectid);
+        return $url;
+    }
+
+    /**
+     * Return the legacy event log data.
+     *
+     * @return array|null
+     */
+    protected function get_legacy_logdata() {
+        // The legacy log table expects a relative path to /mod/oublog/.
+        $logurl = substr($this->get_url()->out_as_local_url(), strlen('/mod/oublog/'));
+        return array($this->courseid, 'oublog', 'add comment', $logurl, $this->other['oublogid'], $this->contextinstanceid);
+    }
+
+    /**
+     * Custom validation.
+     *
+     * @throws \coding_exception
+     * @return void
+     */
+    protected function validate_data() {
+        parent::validate_data();
+
+        if (!isset($this->other['oublogid'])) {
+            throw new \coding_exception('The \'oublogid\' value must be set in other.');
+        }
+
+        if (!isset($this->other['postid'])) {
+            throw new \coding_exception('The \'postid\' value must be set in other.');
+        }
+
+        if (!isset($this->objectid)) {
+            throw new \coding_exception('The \'commentid\' value must be set.');
+        }
+
+        if ($this->contextlevel != CONTEXT_MODULE) {
+            throw new \coding_exception('Context level must be CONTEXT_MODULE.');
+        }
+    }
+}
diff --git a/mod/oublog/classes/event/comment_deleted.php b/mod/oublog/classes/event/comment_deleted.php
new file mode 100644
index 0000000..831edce
--- /dev/null
+++ b/mod/oublog/classes/event/comment_deleted.php
@@ -0,0 +1,125 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * The mod_oublog comment deleted event.
+ *
+ * @package    mod_oublog
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+namespace mod_oublog\event;
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * The mod_oublog comment deleted event class.
+ *
+ * @property-read array $other {
+ *      Extra information about the event.
+ *
+ *      - int oublogid: The oublog which the post is part of.
+ *      - int postid: The post which this comment is part of.
+ * }
+ *
+ * @package    mod_oublog
+ * @since      Moodle 2.7
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+class comment_deleted extends \core\event\base {
+
+    /**
+     * Init method.
+     *
+     * @return void
+     */
+    protected function init() {
+        $this->data['crud'] = 'd';
+        $this->data['edulevel'] = self::LEVEL_OTHER;
+        $this->data['objecttable'] = 'oublog_comments';
+    }
+
+    /**
+     * Returns description of what happened.
+     *
+     * @return string
+     */
+    public function get_description() {
+        return "The user with id '$this->userid' has deleted the comment with id
+            '$this->objectid' on the post with id '{$this->other['postid']}'
+            in the oublog with the course module id '$this->contextinstanceid'.";
+    }
+
+    /**
+     * Return localised event name.
+     *
+     * @return string
+     */
+    public static function get_name() {
+        return get_string('event:commentdeleted', 'mod_oublog');
+    }
+
+    /**
+     * Get URL related to the action
+     *
+     * @return \moodle_url
+     */
+    public function get_url() {
+        $url = new \moodle_url('/mod/oublog/viewpost.php', array('post' => $this->other['postid']));
+        $url->set_anchor('cid' . $this->objectid);
+        return $url;
+    }
+
+    /**
+     * Return the legacy event log data.
+     *
+     * @return array|null
+     */
+    protected function get_legacy_logdata() {
+        // The legacy log table expects a relative path to /mod/oublog/.
+        $logurl = substr($this->get_url()->out_as_local_url(), strlen('/mod/oublog/'));
+        return array($this->courseid, 'oublog', 'delete comment', $logurl,
+                $this->other['oublogid'], $this->contextinstanceid);
+    }
+
+    /**
+     * Custom validation.
+     *
+     * @throws \coding_exception
+     * @return void
+     */
+    protected function validate_data() {
+        parent::validate_data();
+
+        if (!isset($this->other['oublogid'])) {
+            throw new \coding_exception('The \'oublogid\' value must be set in other.');
+        }
+
+        if (!isset($this->other['postid'])) {
+            throw new \coding_exception('The \'postid\' value must be set in other.');
+        }
+
+        if (!isset($this->objectid)) {
+            throw new \coding_exception('The \'commentid\' value must be set.');
+        }
+
+        if ($this->contextlevel != CONTEXT_MODULE) {
+            throw new \coding_exception('Context level must be CONTEXT_MODULE.');
+        }
+    }
+}
diff --git a/mod/oublog/classes/event/course_module_instance_list_viewed.php b/mod/oublog/classes/event/course_module_instance_list_viewed.php
new file mode 100644
index 0000000..322639e
--- /dev/null
+++ b/mod/oublog/classes/event/course_module_instance_list_viewed.php
@@ -0,0 +1,39 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * The mod_oublog instance list viewed event.
+ *
+ * @package    mod_oublog
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+namespace mod_oublog\event;
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * The mod_oublog instance list viewed event class.
+ *
+ * @package    mod_oublog
+ * @since      Moodle 2.7
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+class course_module_instance_list_viewed extends \core\event\course_module_instance_list_viewed {
+    // No need for any code here as everything is handled by the parent class.
+}
diff --git a/mod/oublog/classes/event/course_module_viewed.php b/mod/oublog/classes/event/course_module_viewed.php
new file mode 100644
index 0000000..30864d7
--- /dev/null
+++ b/mod/oublog/classes/event/course_module_viewed.php
@@ -0,0 +1,49 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * The mod_oublog course module viewed event.
+ *
+ * @package    mod_oublog
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+namespace mod_oublog\event;
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * The mod_oublog course module viewed event class.
+ *
+ * @package    mod_oublog
+ * @since      Moodle 2.7
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+class course_module_viewed extends \core\event\course_module_viewed {
+
+    /**
+     * Init method.
+     *
+     * @return void
+     */
+    protected function init() {
+        $this->data['crud'] = 'r';
+        $this->data['edulevel'] = self::LEVEL_PARTICIPATING;
+        $this->data['objecttable'] = 'oublog';
+    }
+}
diff --git a/mod/oublog/classes/event/participation_viewed.php b/mod/oublog/classes/event/participation_viewed.php
new file mode 100644
index 0000000..16cd00d
--- /dev/null
+++ b/mod/oublog/classes/event/participation_viewed.php
@@ -0,0 +1,114 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * The mod_oublog course module viewed event.
+ *
+ * @package    mod_oublog
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+namespace mod_oublog\event;
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * The mod_oublog course module viewed event class.
+ *
+ * @package    mod_oublog
+ * @since      Moodle 2.7
+ * @copyright  2014 OU
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+class participation_viewed extends \core\event\course_module_viewed {
+
+    /**
+     * Init method.
+     *
+     * @return void
+     */
+    protected function init() {
+        $this->data['crud'] = 'r';
+        $this->data['edulevel'] = self::LEVEL_PARTICIPATING;
+        $this->data['objecttable'] = 'oublog';
+    }
+
+    /**
+     * Returns description of what happened.
+     *
+     * @return string
+     */
+    public function get_description() {
+        return "The user with id '$this->userid' viewed  '{$this->other['info']}' " .
+              "on the blog with the course module id '$this->contextinstanceid'.";
+    }
+
+    /**
+     * Return localised event name.
+     *
+     * @return string
+     */
+    public static function get_name() {
+        return get_string('event:participationviewed', 'mod_oublog');
+    }
+
+    /**
+     * Get URL related to the action
+     *
+     * @return \moodle_url
+     */
+    public function get_url() {
+        return new \moodle_url('\\mod\\oublog\\' . $this->other['logurl']);
+    }
+
+    /**
+     * Return the legacy event log data.
+     *
+     * @return array|null
+     */
+    protected function get_legacy_logdata() {
+        // The legacy log table expects a relative path to /mod/oublog/.
+        return array($this->courseid, 'oublog', 'view', $this->other['logurl'],
+                $this->objectid, $this->contextinstanceid);
+    }
+
+    /**
+     * Custom validation.
+     *
+     * @throws \coding_exception
+     * @return void
+     */
+    protected function validate_data() {
+        parent::validate_data();
+
+        if (!isset($this->objectid)) {
+            throw new \coding_exception('The \'cmid\' value must be set.');
+        }
+
+        if (!isset($this->other['info'])) {
+            throw new \coding_exception('The \'info\' value must be set in other.');
+        }
+
+        if (!isset($this->other['logurl'])) {
+            throw new \coding_exception('The \'logurl\' value must be set in other.');
+        }
+
+        if ($this->contextlevel != CONTEXT_MODULE) {
+            throw new \coding_exception('Context level must be CONTEXT_MODULE.');
+        }
+    }
+}
diff --git a/mod/oublog/classes/event/post_created.php b/mod/oublog/classes/event/post_created.php
new file mode 100644
index 0000000..8b64410
--- /dev/null
+++ b/mod/oublog/classes/event/post_created.php
@@ -0,0 +1,116 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * The mod_oublog post created event.
+ *
+ * @package    mod_oublog
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+namespace mod_oublog\event;
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * The mod_oublog post created event class.
+ *
+ * @property-read array $other {
+ *      Extra information about the event.
+ *
+ *      - int oublogid: The oublog which the post is part of.
+ * }
+ *
+ * @package    mod_oublog
+ * @since      Moodle 2.7
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+class post_created extends \core\event\base {
+    /**
+     * Init method.
+     *
+     * @return void
+     */
+    protected function init() {
+        $this->data['crud'] = 'c';
+        $this->data['edulevel'] = self::LEVEL_PARTICIPATING;
+        $this->data['objecttable'] = 'oublog_posts';
+    }
+
+    /**
+     * Returns description of what happened.
+     *
+     * @return string
+     */
+    public function get_description() {
+        return "The user with id '$this->userid' added a new post '$this->objectid' " .
+            "on the oublog with the course module id '$this->contextinstanceid'.";
+    }
+
+    /**
+     * Return localised event name.
+     *
+     * @return string
+     */
+    public static function get_name() {
+        return get_string('event:postcreated', 'mod_oublog');
+    }
+
+    /**
+     * Get URL related to the action
+     *
+     * @return \moodle_url
+     */
+    public function get_url() {
+        $url = new \moodle_url('/mod/oublog/viewpost.php', array('post' => $this->objectid));
+        return $url;
+    }
+
+    /**
+     * Return the legacy event log data.
+     *
+     * @return array|null
+     */
+    protected function get_legacy_logdata() {
+        // The legacy log table expects a relative path to /mod/oublog/.
+        $logurl = substr($this->get_url()->out_as_local_url(), strlen('/mod/oublog/'));
+        return array($this->courseid, 'oublog', 'add post', $logurl, $this->other['oublogid'], $this->contextinstanceid);
+    }
+
+    /**
+     * Custom validation.
+     *
+     * @throws \coding_exception
+     * @return void
+     */
+    protected function validate_data() {
+        parent::validate_data();
+
+        if (!isset($this->other['oublogid'])) {
+            throw new \coding_exception('The \'oublogid\' value must be set in other.');
+        }
+
+        if (!isset($this->objectid)) {
+            throw new \coding_exception('The \'postid\' value must be set.');
+        }
+
+        if ($this->contextlevel != CONTEXT_MODULE) {
+            throw new \coding_exception('Context level must be CONTEXT_MODULE.');
+        }
+    }
+}
diff --git a/mod/oublog/classes/event/post_deleted.php b/mod/oublog/classes/event/post_deleted.php
new file mode 100644
index 0000000..133e3bc
--- /dev/null
+++ b/mod/oublog/classes/event/post_deleted.php
@@ -0,0 +1,119 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * The mod_oublog post deleted event.
+ *
+ * @package    mod_oublog
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+namespace mod_oublog\event;
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * The mod_oublog post deleted event class.
+ *
+ * @property-read array $other {
+ *      Extra information about the event.
+ *
+ *      - int oublogid: The oublog id the post is part of.
+ *
+ * }
+ *
+ * @package    mod_oublog
+ * @since      Moodle 2.7
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+class post_deleted extends \core\event\base {
+
+    /**
+     * Init method.
+     *
+     * @return void
+     */
+    protected function init() {
+        $this->data['crud'] = 'd';
+        $this->data['edulevel'] = self::LEVEL_OTHER;
+        $this->data['objecttable'] = 'oublog_posts';
+    }
+
+    /**
+     * Returns description of what happened.
+     *
+     * @return string
+     */
+    public function get_description() {
+        return "The user with id '$this->userid' has deleted the post with id
+            '$this->objectid' on the oublog with the course module id '$this->contextinstanceid'.";
+    }
+
+    /**
+     * Return localised event name.
+     *
+     * @return string
+     */
+    public static function get_name() {
+        return get_string('event:postdeleted', 'mod_oublog');
+    }
+
+    /**
+     * Get URL related to the action
+     *
+     * @return \moodle_url
+     */
+    public function get_url() {
+        $url = new \moodle_url('/mod/oublog/viewpost.php', array('post' => $this->objectid));
+        return $url;
+    }
+
+    /**
+     * Return the legacy event log data.
+     *
+     * @return array|null
+     */
+    protected function get_legacy_logdata() {
+        // The legacy log table expects a relative path to /mod/oublog/.
+        $logurl = substr($this->get_url()->out_as_local_url(), strlen('/mod/oublog/'));
+        return array($this->courseid, 'oublog', 'delete post', $logurl,
+                $this->other['oublogid'], $this->contextinstanceid);
+    }
+
+    /**
+     * Custom validation.
+     *
+     * @throws \coding_exception
+     * @return void
+     */
+    protected function validate_data() {
+        parent::validate_data();
+
+        if (!isset($this->other['oublogid'])) {
+            throw new \coding_exception('The \'oublogid\' value must be set in other.');
+        }
+
+        if (!isset($this->objectid)) {
+            throw new \coding_exception('The \'postid\' value must be set.');
+        }
+
+        if ($this->contextlevel != CONTEXT_MODULE) {
+            throw new \coding_exception('Context level must be CONTEXT_MODULE.');
+        }
+    }
+}
diff --git a/mod/oublog/classes/event/post_imported.php b/mod/oublog/classes/event/post_imported.php
new file mode 100644
index 0000000..bd1fb37
--- /dev/null
+++ b/mod/oublog/classes/event/post_imported.php
@@ -0,0 +1,112 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * The mod_oublog import post event.
+ *
+ * @package    mod_oublog
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+namespace mod_oublog\event;
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * The mod_oublog import post event class.
+ *
+ * @package    mod_oublog
+ * @since      Moodle 2.7
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+class post_imported extends \core\event\base {
+
+    /**
+     * Init method.
+     *
+     * @return void
+     */
+    protected function init() {
+        $this->data['crud'] = 'c';
+        $this->data['edulevel'] = self::LEVEL_PARTICIPATING;
+        $this->data['objecttable'] = 'oublog';
+    }
+
+    /**
+     * Returns description of what happened.
+     *
+     * @return string
+     */
+    public function get_description() {
+        return "The user with id '$this->userid' imported '{$this->other['info']}' posts
+                to the oublog with the course module id '$this->contextinstanceid'";
+    }
+
+    /**
+     * Return localised event name.
+     *
+     * @return string
+     */
+    public static function get_name() {
+        return get_string('event:postimported', 'mod_oublog');
+    }
+
+    /**
+     * Get URL related to the action
+     *
+     * @return \moodle_url
+     */
+    public function get_url() {
+        $url = new \moodle_url('/mod/oublog/view.php', array('id' => $this->contextinstanceid));
+        return $url;
+    }
+
+    /**
+     * Return the legacy event log data.
+     *
+     * @return array|null
+     */
+    protected function get_legacy_logdata() {
+        $logurl = substr($this->get_url()->out_as_local_url(), strlen('/mod/oublog/'));
+        return array($this->courseid, 'oublog', 'import post', $logurl,
+                $this->objectid, $this->contextinstanceid);
+    }
+
+    /**
+     * Custom validation.
+     *
+     * @throws \coding_exception
+     * @return void
+     */
+    protected function validate_data() {
+        parent::validate_data();
+
+        if (!isset($this->objectid)) {
+            throw new \coding_exception('The \'objectid\' value must be set in the object.');
+        }
+
+        if (!isset($this->other['info'])) {
+            throw new \coding_exception('The \'info\' value must be set in other.');
+        }
+
+        if ($this->contextlevel != CONTEXT_MODULE) {
+            throw new \coding_exception('Context level must be CONTEXT_MODULE.');
+        }
+    }
+
+}
diff --git a/mod/oublog/classes/event/post_updated.php b/mod/oublog/classes/event/post_updated.php
new file mode 100644
index 0000000..fd4f220
--- /dev/null
+++ b/mod/oublog/classes/event/post_updated.php
@@ -0,0 +1,119 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * The mod_oublog post updated event.
+ *
+ * @package    mod_oublog
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+namespace mod_oublog\event;
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * The mod_oublog post updated event class.
+ *
+ * @property-read array $other {
+ *      Extra information about the event.
+ *
+ *      - int oublogid: The oublog the post is part of.
+ *
+ * }
+ *
+ * @package    mod_oublog
+ * @since      Moodle 2.7
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+class post_updated extends \core\event\base {
+
+    /**
+     * Init method.
+     *
+     * @return void
+     */
+    protected function init() {
+        $this->data['crud'] = 'u';
+        $this->data['edulevel'] = self::LEVEL_PARTICIPATING;
+        $this->data['objecttable'] = 'oublog_posts';
+    }
+
+    /**
+     * Returns description of what happened.
+     *
+     * @return string
+     */
+    public function get_description() {
+        return "The user with id '$this->userid' has updated the post with id
+            '$this->objectid' on the oublog with the course module id '$this->contextinstanceid'.";
+    }
+
+    /**
+     * Return localised event name.
+     *
+     * @return string
+     */
+    public static function get_name() {
+        return get_string('event:postupdated', 'mod_oublog');
+    }
+
+    /**
+     * Get URL related to the action
+     *
+     * @return \moodle_url
+     */
+    public function get_url() {
+        $url = new \moodle_url('/mod/oublog/viewpost.php', array('post' => $this->objectid));
+        return $url;
+    }
+
+    /**
+     * Return the legacy event log data.
+     *
+     * @return array|null
+     */
+    protected function get_legacy_logdata() {
+        // The legacy log table expects a relative path to /mod/oublog/.
+        $logurl = substr($this->get_url()->out_as_local_url(), strlen('/mod/oublog/'));
+        return array($this->courseid, 'oublog', 'edit post', $logurl,
+                $this->other['oublogid'], $this->contextinstanceid);
+    }
+
+    /**
+     * Custom validation.
+     *
+     * @throws \coding_exception
+     * @return void
+     */
+    protected function validate_data() {
+        parent::validate_data();
+
+        if (!isset($this->objectid)) {
+            throw new \coding_exception('The \'postid\' value must be set in the object.');
+        }
+
+        if (!isset($this->other['oublogid'])) {
+            throw new \coding_exception('The \'oublogid\' value must be set in other.');
+        }
+
+        if ($this->contextlevel != CONTEXT_MODULE) {
+            throw new \coding_exception('Context level must be CONTEXT_MODULE.');
+        }
+    }
+}
diff --git a/mod/oublog/classes/event/post_viewed.php b/mod/oublog/classes/event/post_viewed.php
new file mode 100644
index 0000000..ecb82f3
--- /dev/null
+++ b/mod/oublog/classes/event/post_viewed.php
@@ -0,0 +1,112 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * The mod_oublog view post event.
+ *
+ * @package    mod_oublog
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+namespace mod_oublog\event;
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * The mod_oublog view post event class.
+ *
+ * @package    mod_oublog
+ * @since      Moodle 2.7
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+class post_viewed extends \core\event\base {
+
+    /**
+     * Init method.
+     *
+     * @return void
+     */
+    protected function init() {
+        $this->data['crud'] = 'r';
+        $this->data['edulevel'] = self::LEVEL_PARTICIPATING;
+        $this->data['objecttable'] = 'oublog_posts';
+    }
+
+    /**
+     * Returns description of what happened.
+     *
+     * @return string
+     */
+    public function get_description() {
+        return "The user with id '$this->userid' viewed post $this->objectid
+                on the oublog with the course module id '$this->contextinstanceid'";
+    }
+
+    /**
+     * Return localised event name.
+     *
+     * @return string
+     */
+    public static function get_name() {
+        return get_string('event:postviewed', 'mod_oublog');
+    }
+
+    /**
+     * Get URL related to the action
+     *
+     * @return \moodle_url
+     */
+    public function get_url() {
+        $url = new \moodle_url('/mod/oublog/viewpost.php', array('post' => $this->objectid));
+        return $url;
+    }
+
+    /**
+     * Return the legacy event log data.
+     *
+     * @return array|null
+     */
+    protected function get_legacy_logdata() {
+        $logurl = substr($this->get_url()->out_as_local_url(), strlen('/mod/oublog/'));
+        return array($this->courseid, 'oublog', 'view post', $logurl,
+                $this->other['oublogid'], $this->contextinstanceid);
+    }
+
+    /**
+     * Custom validation.
+     *
+     * @throws \coding_exception
+     * @return void
+     */
+    protected function validate_data() {
+        parent::validate_data();
+
+        if (!isset($this->objectid)) {
+            throw new \coding_exception('The \'postid\' value must be set in the object.');
+        }
+
+        if (!isset($this->other['oublogid'])) {
+            throw new \coding_exception('The \'oublogid\' value must be set in other.');
+        }
+
+        if ($this->contextlevel != CONTEXT_MODULE) {
+            throw new \coding_exception('Context level must be CONTEXT_MODULE.');
+        }
+    }
+
+}
diff --git a/mod/oublog/classes/event/save_failed.php b/mod/oublog/classes/event/save_failed.php
new file mode 100644
index 0000000..e288899
--- /dev/null
+++ b/mod/oublog/classes/event/save_failed.php
@@ -0,0 +1,105 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ *
+ * @package    mod_oublog
+ * @copyright  2015 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+namespace mod_oublog\event;
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * The mod_oublog post saving failed event class.
+ *
+ * @package    mod_oublog
+ * @since      Moodle 2.7
+ * @copyright  2015 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+class save_failed extends \core\event\base {
+
+    /**
+     * Init method.
+     *
+     * @return void
+     */
+    protected function init() {
+        $this->data['crud'] = 'u';
+        $this->data['edulevel'] = self::LEVEL_OTHER;
+    }
+
+    /**
+     * Returns description of what happened.
+     *
+     * @return string
+     */
+    public function get_description() {
+        $string = 'OUBlog post create/update failed due to session error.';
+        if (!empty($this->other['pid'])) {
+            $string .= " Post id '{$this->other['pid']}'.";
+        }
+        return $string;
+    }
+
+    /**
+     * Return localised event name.
+     *
+     * @return string
+     */
+    public static function get_name() {
+        return get_string('event:savefailed', 'mod_oublog');
+    }
+
+    /**
+     * Get URL related to the action
+     *
+     * @return \moodle_url
+     */
+    public function get_url() {
+        return new \moodle_url($this->other['page']);
+    }
+
+    /**
+     * Return the legacy event log data.
+     *
+     * @return array|null
+     */
+    protected function get_legacy_logdata() {
+        global $SITE;
+        $url = str_replace('/mod/oublog/', '', $this->other['page']);
+        return array($SITE->id, 'oublog', 'error editpost', $this->other['page'], 'session error',
+                $this->contextinstanceid);
+    }
+
+    /**
+     * Custom validation.
+     *
+     * @throws \coding_exception
+     * @return void
+     */
+    protected function validate_data() {
+        parent::validate_data();
+
+        if (!isset($this->other['page'])) {
+            throw new \coding_exception('The \'page\' value must be set in other.');
+        }
+    }
+
+}
diff --git a/mod/oublog/classes/event/site_entries_viewed.php b/mod/oublog/classes/event/site_entries_viewed.php
new file mode 100644
index 0000000..10933ac
--- /dev/null
+++ b/mod/oublog/classes/event/site_entries_viewed.php
@@ -0,0 +1,119 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * The mod_oublog personal blog site entries vewed event.
+ *
+ * @package    mod_oublog
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+namespace mod_oublog\event;
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * The mod_oublog site_entries_viewed event class.
+ *
+ * @property-read array $other {
+ *      Extra information about the event.
+ *
+ *      - int pageid: The page id the oublog posts viewed.
+ *
+ * }
+ *
+ * @package    mod_oublog
+ * @since      Moodle 2.7
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+class site_entries_viewed extends \core\event\base {
+    /**
+     * Init method.
+     *
+     * @return void
+     */
+    protected function init() {
+        $this->data['crud'] = 'c';
+        $this->data['edulevel'] = self::LEVEL_PARTICIPATING;
+        $this->data['objecttable'] = 'oublog';
+    }
+
+    /**
+     * Returns description of what happened.
+     *
+     * @return string
+     */
+    public function get_description() {
+        return "The user with id '$this->userid' viewed site entries page
+                '{$this->other['pageid']}' of the personal oublogs with
+                course module id '$this->contextinstanceid'.";
+    }
+
+    /**
+     * Return localised event name.
+     *
+     * @return string
+     */
+    public static function get_name() {
+        return get_string('event:siteentriesviewed', 'mod_oublog');
+    }
+
+    /**
+     * Get URL related to the action
+     *
+     * @return \moodle_url
+     */
+    public function get_url() {
+        $url = new \moodle_url('/mod/oublog/allposts.php', array('page' => $this->other['pageid']));
+        return $url;
+    }
+
+    /**
+     * Return the legacy event log data.
+     *
+     * @return array|null
+     */
+    protected function get_legacy_logdata() {
+        // The legacy log table expects a relative path to /mod/oublog/.
+        $logurl = substr($this->get_url()->out_as_local_url(), strlen('/mod/oublog/'));
+        return array($this->courseid, 'oublog', 'allposts', $logurl,
+                $this->objectid, $this->contextinstanceid);
+    }
+
+    /**
+     * Custom validation.
+     *
+     * @throws \coding_exception
+     * @return void
+     */
+    protected function validate_data() {
+        parent::validate_data();
+
+        if (!isset($this->objectid)) {
+            throw new \coding_exception('The \'objectid\' value must be set.');
+        }
+
+        if (!isset($this->other['pageid'])) {
+            throw new \coding_exception('The \'pageid\' value must be set in other.');
+        }
+
+        if ($this->contextlevel != CONTEXT_MODULE) {
+            throw new \coding_exception('Context level must be CONTEXT_MODULE.');
+        }
+    }
+}
diff --git a/mod/oublog/classes/task/cron_task.php b/mod/oublog/classes/task/cron_task.php
new file mode 100644
index 0000000..f3ae2c2
--- /dev/null
+++ b/mod/oublog/classes/task/cron_task.php
@@ -0,0 +1,50 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * A scheduled task for oublog cron.
+ *
+ * @package    mod_oublog
+ * @copyright  2014
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+namespace mod_oublog\task;
+
+class cron_task extends \core\task\scheduled_task {
+
+    /**
+     * Get a descriptive name for this task (shown to admins).
+     *
+     * @return string
+     */
+    public function get_name() {
+        return get_string('oublogcrontask', 'mod_oublog');
+    }
+
+    /**
+     * Run oublog cron.
+     * Function to be run periodically according to the moodle cron.
+     * This function runs every 4 hours.
+     */
+    public function execute() {
+        global $DB;
+
+        // Delete outdated (> 30 days) moderated comments.
+        $outofdate = time() - 30 * 24 * 3600;
+        $DB->delete_records_select('oublog_comments_moderated', "timeposted < ?", array($outofdate));
+    }
+
+}
diff --git a/mod/oublog/comment_form.php b/mod/oublog/comment_form.php
new file mode 100644
index 0000000..d496878
--- /dev/null
+++ b/mod/oublog/comment_form.php
@@ -0,0 +1,110 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+require_once($CFG->libdir.'/formslib.php');
+
+class mod_oublog_comment_form extends moodleform {
+
+    public function definition() {
+
+        global $CFG;
+
+        $maxvisibility = $this->_customdata['maxvisibility'];
+        $edit = $this->_customdata['edit'];
+        $moderated = $this->_customdata['moderated'];
+        $confirmed = $this->_customdata['confirmed'];
+        $blogid = $this->_customdata['blogid'];
+        $postid = $this->_customdata['postid'];
+        $maxbytes = $this->_customdata['maxbytes'];
+        $postrender = $this->_customdata['postrender'];
+
+        $mform    =& $this->_form;
+
+        if (!$edit) {
+            $mform->addElement('header', 'posttext', get_string('postmessage', 'oublog'));
+            $mform->setExpanded('posttext', false);
+            $mform->addElement('html', $postrender);
+        }
+
+        $mform->addElement('header', 'general', '');
+        $mform->setExpanded('general', true);
+
+        if ($moderated) {
+            $mform->addElement('static', '', '',
+                    get_string('moderated_info', 'oublog', $CFG->wwwroot .
+                        '/mod/oublog/bloglogin.php?returnurl=editcomment.php?blog=' .
+                        $blogid . '%26post=' . $postid));
+
+            $mform->addElement('text', 'authorname',
+                    get_string('moderated_authorname', 'oublog'), 'size="48"');
+            $mform->setType('authorname', PARAM_TEXT);
+            $mform->addRule('authorname', get_string('required'), 'required', null, 'client');
+        }
+
+        $mform->addElement('text', 'title', get_string('title', 'oublog'), 'size="48"');
+        $mform->setType('title', PARAM_TEXT);
+
+        $messagetype = 'editor';
+        if ($moderated) {
+            $messagetype = 'textarea';
+        }
+
+        $mform->addElement($messagetype, 'messagecomment', get_string('comment', 'oublog'),
+                array('cols' => 50, 'rows' => 30),
+                array('maxfiles' => EDITOR_UNLIMITED_FILES, 'maxbytes' => $maxbytes));
+        $mform->setType('messagecomment', PARAM_CLEANHTML);
+        $mform->addRule('messagecomment', get_string('required'), 'required', null, 'server');
+
+        // When using moderation, we include the world's dumbest capcha (the
+        // user is told to type 'yes' into the box). Because there is moderation
+        // we do not really need a capcha; this is only meant to exclude the
+        // stupidest spam robots and reduce the quantity of email sent to
+        // moderators. A cookie can skip this step.
+        if ($moderated && !$confirmed) {
+            $mform->addElement('static', '', '',
+                    get_string('moderated_confirminfo', 'oublog'));
+            $mform->addElement('text', 'confirm', get_string('moderated_confirm', 'oublog'));
+            $mform->setType('confirm', PARAM_TEXT);
+        }
+
+        if ($edit) {
+            $submitstring = get_string('savechanges');
+        } else {
+            $submitstring = get_string('addcomment', 'oublog');
+        }
+
+        $this->add_action_buttons(true, $submitstring);
+
+        // Hidden form vars.
+        $mform->addElement('hidden', 'blog');
+        $mform->setType('blog', PARAM_INT);
+
+        $mform->addElement('hidden', 'post');
+        $mform->setType('post', PARAM_INT);
+    }
+
+    public function validation($data, $files) {
+        $moderated = $this->_customdata['moderated'];
+        $confirmed = $this->_customdata['confirmed'];
+
+        $errors = array();
+        if ($moderated && !$confirmed && (empty($data['confirm']) ||
+                $data['confirm'] !== get_string('moderated_confirmvalue', 'oublog'))) {
+            $errors['confirm'] = get_string('error_noconfirm', 'oublog');
+        }
+        return $errors;
+    }
+}
diff --git a/mod/oublog/confirmloggedin.php b/mod/oublog/confirmloggedin.php
new file mode 100644
index 0000000..3b34507
--- /dev/null
+++ b/mod/oublog/confirmloggedin.php
@@ -0,0 +1,60 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * This script is called through AJAX. It confirms that a user is still
+ * logged in and has a valid session before saving edits to a blog page
+ *
+ * @package    mod
+ * @subpackage oublog
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+define('AJAX_SCRIPT', true);
+require_once(dirname(__FILE__) . '/../../config.php');
+
+header('Content-Type: text/plain');
+
+try {
+    // Test session - These functions throw exceptions so trap and exit if they fail.
+    // This saves 404 errors and sends a smaller page.
+    $contextid = required_param('contextid', PARAM_INT);
+    list($context, $course, $cm) = get_context_info_array($contextid);
+    $PAGE->set_url('/mod/oublog/confirmloggedin.php');
+    $PAGE->set_context($context);
+    require_login($course, false, $cm);
+    require_sesskey();
+} catch (moodle_exception $e) {
+    $pid = 0;
+    $url = '/mod/oublog/editpost.php';
+    if (!empty($_SERVER['HTTP_REFERER'])) {
+        $url = new moodle_url($_SERVER['HTTP_REFERER']);
+        $rpid = $url->get_param('post');
+        if (!empty($rpid)) {
+            $pid = $rpid;
+        }
+        $url = $url->out_as_local_url();
+    }
+    $params = array(
+            'context' => context_system::instance(),
+            'other' => array('page' => $url, 'pid' => $pid)
+    );
+    $event = \mod_oublog\event\save_failed::create($params);
+    $event->trigger();
+    exit;
+}
+
+echo 'ok';
diff --git a/mod/oublog/db/access.php b/mod/oublog/db/access.php
new file mode 100644
index 0000000..58e9f9a
--- /dev/null
+++ b/mod/oublog/db/access.php
@@ -0,0 +1,265 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+/**
+ * Capability definitions for the oublog module.
+ *
+ * For naming conventions, see lib/db/access.php.
+ */
+$capabilities = array(
+
+    'mod/oublog:view' => array(
+
+        'captype' => 'read',
+        'contextlevel' => CONTEXT_MODULE,
+        'legacy' => array(
+            'teacher' => CAP_ALLOW,
+            'editingteacher' => CAP_ALLOW,
+            'student' => CAP_ALLOW,
+        )
+    ),
+
+    // Ability to add new OU blog instances to a course
+    'mod/oublog:addinstance' => array(
+        'riskbitmask' => RISK_XSS,
+
+        'captype' => 'write',
+        'contextlevel' => CONTEXT_COURSE,
+        'archetypes' => array(
+            'editingteacher' => CAP_ALLOW,
+            'manager' => CAP_ALLOW
+        ),
+        'clonepermissionsfrom' => 'moodle/course:manageactivities'
+    ),
+
+    'mod/oublog:viewpersonal' => array(
+
+        'captype' => 'read',
+        'contextlevel' => CONTEXT_SYSTEM,
+        'legacy' => array(
+            'user' => CAP_ALLOW
+        )
+    ),
+
+    'mod/oublog:contributepersonal' => array(
+
+        'captype' => 'read',
+        'contextlevel' => CONTEXT_SYSTEM,
+        'legacy' => array(
+            'user' => CAP_ALLOW
+        )
+    ),
+    'mod/oublog:viewprivate' => array(
+            'riskbitmask' => RISK_PERSONAL,
+            'captype' => 'read',
+            'contextlevel' => CONTEXT_SYSTEM,
+            'legacy' => array()
+    ),
+
+    'mod/oublog:post' => array(
+
+        'captype' => 'write',
+        'contextlevel' => CONTEXT_MODULE,
+        'legacy' => array(
+            'teacher' => CAP_ALLOW,
+            'editingteacher' => CAP_ALLOW,
+            'student' => CAP_ALLOW
+        )
+    ),
+
+
+    'mod/oublog:comment' => array(
+
+        'captype' => 'write',
+        'contextlevel' => CONTEXT_MODULE,
+        'legacy' => array(
+            'teacher' => CAP_ALLOW,
+            'editingteacher' => CAP_ALLOW,
+            'student' => CAP_ALLOW
+        )
+    ),
+
+    'mod/oublog:managecomments' => array(
+
+        'captype' => 'write',
+        'contextlevel' => CONTEXT_MODULE,
+        'legacy' => array(
+            'teacher' => CAP_ALLOW,
+            'editingteacher' => CAP_ALLOW
+        )
+    ),
+
+
+    'mod/oublog:manageposts' => array(
+
+        'captype' => 'write',
+        'contextlevel' => CONTEXT_MODULE,
+        'legacy' => array(
+            'teacher' => CAP_ALLOW,
+            'editingteacher' => CAP_ALLOW
+        )
+    ),
+
+
+    'mod/oublog:managelinks' => array(
+
+        'captype' => 'write',
+        'contextlevel' => CONTEXT_MODULE,
+        'legacy' => array(
+            'teacher' => CAP_ALLOW,
+            'editingteacher' => CAP_ALLOW
+        )
+    ),
+
+
+    'mod/oublog:viewindividual' => array(
+
+        'captype' => 'read',
+        'contextlevel' => CONTEXT_MODULE,
+        'legacy' => array(
+            'teacher' => CAP_ALLOW,
+            'editingteacher' => CAP_ALLOW
+        )
+    ),
+
+
+    'mod/oublog:audit' => array(
+
+        'captype' => 'write',
+        'contextlevel' => CONTEXT_MODULE,
+        'legacy' => array(
+            'editingteacher' => CAP_ALLOW
+        )
+    ),
+    'mod/oublog:exportpost' => array(
+
+        'riskbitmask' => RISK_PERSONAL,
+
+        'captype' => 'read',
+        'contextlevel' => CONTEXT_MODULE,
+        'archetypes' => array(
+            'teacher' => CAP_ALLOW,
+            'editingteacher' => CAP_ALLOW,
+            'manager' => CAP_ALLOW,
+            'student' => CAP_ALLOW,
+        )
+    ),
+    'mod/oublog:exportownpost' => array(
+
+        'riskbitmask' => RISK_PERSONAL,
+
+        'captype' => 'read',
+        'contextlevel' => CONTEXT_MODULE,
+        'archetypes' => array(
+            'teacher' => CAP_ALLOW,
+            'editingteacher' => CAP_ALLOW,
+            'manager' => CAP_ALLOW,
+            'student' => CAP_ALLOW,
+        )
+    ),
+    'mod/oublog:viewparticipation' => array(
+
+        'riskbitmask' => 0,
+
+        'captype' => 'read',
+        'contextlevel' => CONTEXT_MODULE,
+        'archetypes' => array(
+            'teacher' => CAP_ALLOW,
+            'editingteacher' => CAP_ALLOW,
+            'manager' => CAP_ALLOW,
+        )
+    ),
+    'mod/oublog:grade' => array(
+
+        'riskbitmask' => 0,
+
+        'captype' => 'write',
+        'contextlevel' => CONTEXT_MODULE,
+        'archetypes' => array(
+            'teacher' => CAP_ALLOW,
+            'editingteacher' => CAP_ALLOW,
+            'manager' => CAP_ALLOW,
+        )
+    ),
+    'mod/oublog:viewrating' => array(
+
+        'captype' => 'read',
+        'contextlevel' => CONTEXT_MODULE,
+        'archetypes' => array(
+            'student' => CAP_ALLOW,
+            'teacher' => CAP_ALLOW,
+            'editingteacher' => CAP_ALLOW,
+            'manager' => CAP_ALLOW
+        )
+    ),
+
+    'mod/oublog:viewanyrating' => array(
+
+        'riskbitmask' => RISK_PERSONAL,
+        'captype' => 'read',
+        'contextlevel' => CONTEXT_MODULE,
+        'archetypes' => array(
+            'teacher' => CAP_ALLOW,
+            'editingteacher' => CAP_ALLOW,
+            'manager' => CAP_ALLOW
+         )
+    ),
+
+    'mod/oublog:viewallratings' => array(
+
+        'riskbitmask' => RISK_PERSONAL,
+        'captype' => 'read',
+        'contextlevel' => CONTEXT_MODULE,
+        'archetypes' => array(
+            'teacher' => CAP_ALLOW,
+            'editingteacher' => CAP_ALLOW,
+            'manager' => CAP_ALLOW
+        ),
+        'clonepermissionsfrom' => 'mod/oublog:viewanyrating'
+    ),
+
+    'mod/oublog:rate' => array(
+
+         'captype' => 'write',
+         'contextlevel' => CONTEXT_MODULE,
+         'archetypes' => array(
+             'teacher' => CAP_ALLOW,
+             'editingteacher' => CAP_ALLOW,
+             'manager' => CAP_ALLOW
+         )
+    ),
+
+    'mod/oublog:ignorepostperiod' => array(
+
+        'captype' => 'write',
+        'contextlevel' => CONTEXT_MODULE,
+        'legacy' => array(
+            'teacher' => CAP_ALLOW,
+            'editingteacher' => CAP_ALLOW,
+            'manager' => CAP_ALLOW,
+        )
+    ),
+
+    'mod/oublog:ignorecommentperiod' => array(
+
+        'captype' => 'write',
+        'contextlevel' => CONTEXT_MODULE,
+        'legacy' => array(
+            'teacher' => CAP_ALLOW,
+            'editingteacher' => CAP_ALLOW,
+            'manager' => CAP_ALLOW,
+        )
+    ),
+);
diff --git a/mod/oublog/db/install.php b/mod/oublog/db/install.php
new file mode 100644
index 0000000..c12ce29
--- /dev/null
+++ b/mod/oublog/db/install.php
@@ -0,0 +1,65 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Creates personal blog instance (on site front page) after install
+ *
+ * @package    mod
+ * @subpackage oublog
+ * @copyright  2013 The open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+function xmldb_oublog_install() {
+    global $DB, $CFG;
+
+    require_once($CFG->dirroot . '/course/lib.php');
+
+    // Setup the global blog.
+    $oublog = new stdClass;
+    $oublog->course = SITEID;
+    $oublog->name = 'Personal Blogs';
+    $oublog->intro = '';
+    $oublog->introformat = FORMAT_HTML;
+    $oublog->accesstoken = md5(uniqid(rand(), true));
+    $oublog->maxvisibility = 300;// OUBLOG_VISIBILITY_PUBLIC.
+    $oublog->global = 1;
+    $oublog->allowcomments = 2;// OUBLOG_COMMENTS_ALLOWPUBLIC.
+
+    if (!$oublog->id = $DB->insert_record('oublog', $oublog)) {
+        return false;
+    }
+
+    $mod = new stdClass;
+    $mod->course = SITEID;
+    $mod->module = $DB->get_field('modules', 'id', array('name'=>'oublog'));
+    $mod->instance = $oublog->id;
+    $mod->visible = 1;
+    $mod->visibleold = 0;
+    $mod->section = 1;
+
+    if (!$cm = add_course_module($mod)) {
+        return true;
+    }
+    set_config('oublogsetup', null);
+
+    // For unit tests to work, it's necessary to create context now.
+    context_module::instance($cm);
+
+    return true;
+}
diff --git a/mod/oublog/db/install.xml b/mod/oublog/db/install.xml
new file mode 100644
index 0000000..97b5ed7
--- /dev/null
+++ b/mod/oublog/db/install.xml
@@ -0,0 +1,195 @@
+<?xml version="1.0" encoding="UTF-8" ?>
+<XMLDB PATH="mod/oublog/db" VERSION="20160816" COMMENT="XMLDB file for Moodle mod/oublog"
+    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+    xsi:noNamespaceSchemaLocation="../../../lib/xmldb/xmldb.xsd"
+>
+  <TABLES>
+    <TABLE NAME="oublog" COMMENT="Blog activity instance">
+      <FIELDS>
+        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
+        <FIELD NAME="course" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="accesstoken" TYPE="char" LENGTH="255" NOTNULL="false" SEQUENCE="false"/>
+        <FIELD NAME="name" TYPE="char" LENGTH="255" NOTNULL="true" SEQUENCE="false"/>
+        <FIELD NAME="intro" TYPE="text" NOTNULL="false" SEQUENCE="false"/>
+        <FIELD NAME="introformat" TYPE="int" LENGTH="4" NOTNULL="true" DEFAULT="0" SEQUENCE="false" COMMENT="text format of intro field"/>
+        <FIELD NAME="allowcomments" TYPE="int" LENGTH="1" NOTNULL="true" DEFAULT="0" SEQUENCE="false" COMMENT="0 = do not allow comments 1 = allow comments from signed-in users 2 = allow comments from signed-in users, and moderated comments from external users"/>
+        <FIELD NAME="maxbytes" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="512000" SEQUENCE="false"/>
+        <FIELD NAME="maxattachments" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="9" SEQUENCE="false" COMMENT="Number of attachments allowed per post"/>
+        <FIELD NAME="maxvisibility" TYPE="int" LENGTH="4" NOTNULL="true" DEFAULT="100" SEQUENCE="false"/>
+        <FIELD NAME="global" TYPE="int" LENGTH="1" NOTNULL="true" DEFAULT="0" SEQUENCE="false" COMMENT="Is this the global blog?"/>
+        <FIELD NAME="views" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="completionposts" TYPE="int" LENGTH="9" NOTNULL="true" DEFAULT="0" SEQUENCE="false" COMMENT="If set, specifies a number of blog posts that a student must make for this activity to be marked completed."/>
+        <FIELD NAME="completioncomments" TYPE="int" LENGTH="9" NOTNULL="true" DEFAULT="0" SEQUENCE="false" COMMENT="If set, specifies a number of blog comments that a student must make for this activity to be marked completed."/>
+        <FIELD NAME="individual" TYPE="int" LENGTH="1" NOTNULL="true" DEFAULT="0" SEQUENCE="false" COMMENT="Is this the individual blog?"/>
+        <FIELD NAME="grade" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="reportingemail" TYPE="char" LENGTH="255" NOTNULL="false" SEQUENCE="false" COMMENT="Email addresses for reporting posts or comments"/>
+        <FIELD NAME="displayname" TYPE="char" LENGTH="255" NOTNULL="false" SEQUENCE="false" COMMENT="Alternative name used in some areas of the interface"/>
+        <FIELD NAME="statblockon" TYPE="int" LENGTH="1" NOTNULL="true" DEFAULT="0" SEQUENCE="false" COMMENT="Show the stat block"/>
+        <FIELD NAME="allowimport" TYPE="int" LENGTH="1" NOTNULL="true" DEFAULT="0" SEQUENCE="false" COMMENT="0 or 1 to enable importing of posts"/>
+        <FIELD NAME="introonpost" TYPE="int" LENGTH="1" NOTNULL="true" DEFAULT="0" SEQUENCE="false" COMMENT="Show blog intro on post form page"/>
+        <FIELD NAME="tagslist" TYPE="char" LENGTH="255" NOTNULL="false" SEQUENCE="false" COMMENT="Predefine tags to choose from when entering a tag on a post"/>
+        <FIELD NAME="assessed" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="assesstimestart" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="assesstimefinish" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="scale" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="grading" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="restricttags" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="postfrom" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0" SEQUENCE="false" COMMENT="Posting allowed from"/>
+        <FIELD NAME="postuntil" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0" SEQUENCE="false" COMMENT="Posting allowed until"/>
+        <FIELD NAME="commentfrom" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0" SEQUENCE="false" COMMENT="Comments allowed from"/>
+        <FIELD NAME="commentuntil" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0" SEQUENCE="false" COMMENT="Commenting allowed until"/>
+      </FIELDS>
+      <KEYS>
+        <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
+      </KEYS>
+      <INDEXES>
+        <INDEX NAME="course" UNIQUE="false" FIELDS="course"/>
+        <INDEX NAME="global" UNIQUE="false" FIELDS="global"/>
+      </INDEXES>
+    </TABLE>
+    <TABLE NAME="oublog_instances" COMMENT="Blog instance">
+      <FIELDS>
+        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
+        <FIELD NAME="oublogid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false"/>
+        <FIELD NAME="userid" TYPE="int" LENGTH="10" NOTNULL="false" SEQUENCE="false"/>
+        <FIELD NAME="name" TYPE="char" LENGTH="255" NOTNULL="true" SEQUENCE="false"/>
+        <FIELD NAME="summary" TYPE="text" NOTNULL="false" SEQUENCE="false"/>
+        <FIELD NAME="accesstoken" TYPE="char" LENGTH="255" NOTNULL="true" SEQUENCE="false"/>
+        <FIELD NAME="views" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+      </FIELDS>
+      <KEYS>
+        <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
+        <KEY NAME="oublog_instances_oublog_fk" TYPE="foreign" FIELDS="oublogid" REFTABLE="oublog" REFFIELDS="id"/>
+      </KEYS>
+      <INDEXES>
+        <INDEX NAME="userid" UNIQUE="false" FIELDS="userid"/>
+      </INDEXES>
+    </TABLE>
+    <TABLE NAME="oublog_posts" COMMENT="Blog posts">
+      <FIELDS>
+        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
+        <FIELD NAME="oubloginstancesid" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="groupid" TYPE="int" LENGTH="10" NOTNULL="false" SEQUENCE="false"/>
+        <FIELD NAME="title" TYPE="char" LENGTH="255" NOTNULL="false" SEQUENCE="false"/>
+        <FIELD NAME="message" TYPE="text" NOTNULL="true" SEQUENCE="false"/>
+        <FIELD NAME="timeposted" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false"/>
+        <FIELD NAME="allowcomments" TYPE="int" LENGTH="1" NOTNULL="false" SEQUENCE="false" COMMENT="0 = do not allow comments 1 = allow comments from signed-in users 2 = allow comments from signed-in users, and moderated comments from external users"/>
+        <FIELD NAME="timeupdated" TYPE="int" LENGTH="10" NOTNULL="false" SEQUENCE="false"/>
+        <FIELD NAME="deletedby" TYPE="int" LENGTH="10" NOTNULL="false" SEQUENCE="false"/>
+        <FIELD NAME="timedeleted" TYPE="int" LENGTH="10" NOTNULL="false" SEQUENCE="false"/>
+        <FIELD NAME="visibility" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="100" SEQUENCE="false"/>
+        <FIELD NAME="lasteditedby" TYPE="int" LENGTH="10" NOTNULL="false" SEQUENCE="false" COMMENT="User ID of user to last edit post, or null if not edited"/>
+      </FIELDS>
+      <KEYS>
+        <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
+        <KEY NAME="oublog_posts_oublog_instances_fk" TYPE="foreign" FIELDS="oubloginstancesid" REFTABLE="oublog_instances" REFFIELDS="id"/>
+        <KEY NAME="oublog_posts_deletedby_users_fk" TYPE="foreign" FIELDS="deletedby" REFTABLE="user" REFFIELDS="id"/>
+        <KEY NAME="oublog_posts_groupid_groups_fk" TYPE="foreign" FIELDS="groupid" REFTABLE="groups" REFFIELDS="id"/>
+      </KEYS>
+      <INDEXES>
+        <INDEX NAME="timeposted" UNIQUE="false" FIELDS="timeposted"/>
+        <INDEX NAME="timeupdated" UNIQUE="false" FIELDS="timeupdated"/>
+        <INDEX NAME="allowcomments" UNIQUE="false" FIELDS="allowcomments"/>
+        <INDEX NAME="visibility" UNIQUE="false" FIELDS="visibility"/>
+      </INDEXES>
+    </TABLE>
+    <TABLE NAME="oublog_comments" COMMENT="Blog Comments">
+      <FIELDS>
+        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
+        <FIELD NAME="postid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false"/>
+        <FIELD NAME="userid" TYPE="int" LENGTH="10" NOTNULL="false" SEQUENCE="false"/>
+        <FIELD NAME="title" TYPE="char" LENGTH="255" NOTNULL="true" SEQUENCE="false"/>
+        <FIELD NAME="message" TYPE="text" NOTNULL="true" SEQUENCE="false"/>
+        <FIELD NAME="timeposted" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false"/>
+        <FIELD NAME="deletedby" TYPE="int" LENGTH="10" NOTNULL="false" SEQUENCE="false"/>
+        <FIELD NAME="timedeleted" TYPE="int" LENGTH="10" NOTNULL="false" SEQUENCE="false"/>
+        <FIELD NAME="authorname" TYPE="char" LENGTH="255" NOTNULL="false" SEQUENCE="false" COMMENT="For moderated comments: author name (required). For non-moderated comments, must be null."/>
+        <FIELD NAME="authorip" TYPE="char" LENGTH="255" NOTNULL="false" SEQUENCE="false" COMMENT="For moderated comments: author IP address (required). For non-moderated comments, must be null."/>
+        <FIELD NAME="timeapproved" TYPE="int" LENGTH="10" NOTNULL="false" SEQUENCE="false" COMMENT="For moderated comments: time at which comment was approved. For non-moderated comments, must be null."/>
+      </FIELDS>
+      <KEYS>
+        <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
+        <KEY NAME="oublog_comments_oublog_post_fk" TYPE="foreign" FIELDS="postid" REFTABLE="oublog_posts" REFFIELDS="id"/>
+        <KEY NAME="oublog_comments_userid_users_fk" TYPE="foreign" FIELDS="userid" REFTABLE="user" REFFIELDS="id"/>
+        <KEY NAME="oublog_comments_deletedby_users_fk" TYPE="foreign" FIELDS="deletedby" REFTABLE="user" REFFIELDS="id"/>
+      </KEYS>
+      <INDEXES>
+        <INDEX NAME="timeposted" UNIQUE="false" FIELDS="timeposted"/>
+      </INDEXES>
+    </TABLE>
+    <TABLE NAME="oublog_edits" COMMENT="Blog post edits">
+      <FIELDS>
+        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
+        <FIELD NAME="postid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false"/>
+        <FIELD NAME="userid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false"/>
+        <FIELD NAME="timeupdated" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false"/>
+        <FIELD NAME="oldtitle" TYPE="char" LENGTH="255" NOTNULL="false" SEQUENCE="false"/>
+        <FIELD NAME="oldmessage" TYPE="text" NOTNULL="false" SEQUENCE="false"/>
+      </FIELDS>
+      <KEYS>
+        <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
+        <KEY NAME="oublog_edits_oublog_posts_fk" TYPE="foreign" FIELDS="postid" REFTABLE="oublog_instances" REFFIELDS="id"/>
+        <KEY NAME="oublog_edits_users_fk" TYPE="foreign" FIELDS="userid" REFTABLE="user" REFFIELDS="id"/>
+      </KEYS>
+    </TABLE>
+    <TABLE NAME="oublog_tags" COMMENT="Blog tags">
+      <FIELDS>
+        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
+        <FIELD NAME="tag" TYPE="char" LENGTH="255" NOTNULL="true" SEQUENCE="false"/>
+      </FIELDS>
+      <KEYS>
+        <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
+      </KEYS>
+    </TABLE>
+    <TABLE NAME="oublog_taginstances" COMMENT="Blog tag instances">
+      <FIELDS>
+        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
+        <FIELD NAME="oubloginstancesid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false"/>
+        <FIELD NAME="postid" TYPE="int" LENGTH="10" NOTNULL="false" SEQUENCE="false"/>
+        <FIELD NAME="tagid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false"/>
+      </FIELDS>
+      <KEYS>
+        <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
+        <KEY NAME="oublog_taginstances_oublogs_blogs_fk" TYPE="foreign" FIELDS="oubloginstancesid" REFTABLE="oublog_instances" REFFIELDS="id"/>
+        <KEY NAME="oublog_taginstances_oublog_posts_fk" TYPE="foreign" FIELDS="postid" REFTABLE="oublog_posts" REFFIELDS="id"/>
+        <KEY NAME="oublog_taginstances_oublog_tags_fk" TYPE="foreign" FIELDS="tagid" REFTABLE="oublog_tags" REFFIELDS="id"/>
+      </KEYS>
+    </TABLE>
+    <TABLE NAME="oublog_links" COMMENT="Blog links">
+      <FIELDS>
+        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
+        <FIELD NAME="oublogid" TYPE="int" LENGTH="10" NOTNULL="false" SEQUENCE="false"/>
+        <FIELD NAME="oubloginstancesid" TYPE="int" LENGTH="10" NOTNULL="false" SEQUENCE="false"/>
+        <FIELD NAME="title" TYPE="char" LENGTH="255" NOTNULL="true" SEQUENCE="false"/>
+        <FIELD NAME="url" TYPE="text" NOTNULL="true" SEQUENCE="false"/>
+        <FIELD NAME="sortorder" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false"/>
+      </FIELDS>
+      <KEYS>
+        <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
+        <KEY NAME="oublog_links_oublog_fk" TYPE="foreign" FIELDS="oublogid" REFTABLE="oublog" REFFIELDS="id"/>
+        <KEY NAME="oublog_links_oublog_instances_fk" TYPE="foreign" FIELDS="oubloginstancesid" REFTABLE="oublog_instances" REFFIELDS="id"/>
+      </KEYS>
+    </TABLE>
+    <TABLE NAME="oublog_comments_moderated" COMMENT="Stores comments which are awaiting moderation or were recently moderated. (Comments are held in this table for 30 days even if they are approved or rejected, to make some calculation easier.)">
+      <FIELDS>
+        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
+        <FIELD NAME="postid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="ID of blog post which this is going to be a comment for (if approved)."/>
+        <FIELD NAME="title" TYPE="char" LENGTH="255" NOTNULL="true" SEQUENCE="false" COMMENT="Optional title of blog comment. (Blank if no title required.)"/>
+        <FIELD NAME="message" TYPE="text" NOTNULL="true" SEQUENCE="false" COMMENT="Text of blog comment"/>
+        <FIELD NAME="timeposted" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="Time at which comment was posted."/>
+        <FIELD NAME="authorname" TYPE="char" LENGTH="255" NOTNULL="true" SEQUENCE="false" COMMENT="Name of author (required)."/>
+        <FIELD NAME="authorip" TYPE="char" LENGTH="255" NOTNULL="true" SEQUENCE="false" COMMENT="IP address in string form."/>
+        <FIELD NAME="approval" TYPE="int" LENGTH="1" NOTNULL="true" DEFAULT="0" SEQUENCE="false" COMMENT="Approval status: 0 = not confirmed, 1 = approved, 2 = rejected."/>
+        <FIELD NAME="timeset" TYPE="int" LENGTH="10" NOTNULL="false" SEQUENCE="false" COMMENT="The time (seconds since epoch) at which this comment was either approved or rejected. Initially null until rejection."/>
+        <FIELD NAME="secretkey" TYPE="char" LENGTH="255" NOTNULL="true" SEQUENCE="false" COMMENT="Field containing randomly-generated secret key which is used when approving posts via GET request (when session key is unavailable)."/>
+      </FIELDS>
+      <KEYS>
+        <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
+        <KEY NAME="postid" TYPE="foreign" FIELDS="postid" REFTABLE="oublog_posts" REFFIELDS="id"/>
+      </KEYS>
+      <INDEXES>
+        <INDEX NAME="authorip" UNIQUE="false" FIELDS="authorip"/>
+      </INDEXES>
+    </TABLE>
+  </TABLES>
+</XMLDB>
\ No newline at end of file
diff --git a/mod/oublog/db/log.php b/mod/oublog/db/log.php
new file mode 100644
index 0000000..348b144
--- /dev/null
+++ b/mod/oublog/db/log.php
@@ -0,0 +1,44 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Definition of log events
+ *
+ * @package    mod
+ * @subpackage lesson
+ * @copyright  2010 Petr Skoda (http://skodak.org)
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+$logs = array(
+    array('module'=>'oublog', 'action'=> 'add', 'mtable'=>'oublog', 'field'=>'name'),
+    array('module'=>'oublog', 'action'=> 'update', 'mtable'=>'oublog', 'field'=>'name'),
+    array('module'=>'oublog', 'action'=>'view', 'mtable'=>'oublog', 'field'=>'name'),
+    array('module'=>'oublog', 'action'=> 'view all', 'mtable'=>'oublog', 'field'=>'name'),
+    array('module'=>'oublog', 'action'=>'add post', 'mtable'=>'oublog', 'field'=>'name'),
+    array('module'=>'oublog', 'action'=>'edit post', 'mtable'=>'oublog', 'field'=>'name'),
+    array('module'=>'oublog', 'action'=>'add comment', 'mtable'=>'oublog', 'field'=>'name'),
+    array('module'=>'oublog', 'action'=> 'extdashadd', 'mtable'=>'oublog', 'field'=>'name'),
+    array('module'=>'oublog', 'action'=> 'extdashremove', 'mtable'=>'oublog', 'field'=>'name'),
+    array('module'=>'oublog', 'action'=> 'allposts', 'mtable'=>'oublog', 'field'=>'name'),
+    array('module'=>'oublog', 'action'=> 'approve comment', 'mtable'=>'oublog', 'field'=>'name'),
+    array('module'=>'oublog', 'action'=> 'delete comment', 'mtable'=>'oublog', 'field'=>'name'),
+    array('module'=>'oublog', 'action'=> 'delete post', 'mtable'=>'oublog', 'field'=>'name'),
+    array('module'=>'oublog', 'action'=> 'view post', 'mtable'=>'oublog', 'field'=>'name'),
+    array('module'=>'oublog', 'action'=> 'import post', 'mtable'=>'oublog', 'field'=>'name'),
+);
\ No newline at end of file
diff --git a/mod/oublog/db/services.php b/mod/oublog/db/services.php
new file mode 100644
index 0000000..21db646
--- /dev/null
+++ b/mod/oublog/db/services.php
@@ -0,0 +1,69 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Web service definition.
+ *
+ * @package mod_oublog
+ * @copyright 2013 The Open University
+ * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+$functions = array(
+        'mod_oublog_get_user_blogs' => array(
+                'classname' => 'mod_oublog_external',
+                'methodname' => 'get_user_blogs',
+                'classpath' => 'mod/oublog/externallib.php',
+                'description' => 'Get all user\'s blogs on system',
+                'type' => 'read',
+        ),
+        'mod_oublog_get_blog_info' => array(
+                'classname' => 'mod_oublog_external',
+                'methodname' => 'get_blog_info',
+                'classpath' => 'mod/oublog/externallib.php',
+                'description' => 'Get info on blog, inc access check',
+                'type' => 'read',
+        ),
+        'mod_oublog_get_blog_allposts' => array(
+                'classname' => 'mod_oublog_external',
+                'methodname' => 'get_blog_allposts',
+                'classpath' => 'mod/oublog/externallib.php',
+                'description' => 'Get importable user posts from blog',
+                'type' => 'read',
+        ),
+        'mod_oublog_get_blog_posts' => array(
+                'classname' => 'mod_oublog_external',
+                'methodname' => 'get_blog_posts',
+                'classpath' => 'mod/oublog/externallib.php',
+                'description' => 'Get selected user posts from blog',
+                'type' => 'read',
+        ),
+
+);
+
+$services = array(
+        'OUBlog import' => array(
+                'shortname' => 'oublogimport',
+                'functions' => array ('mod_oublog_get_user_blogs', 'mod_oublog_get_blog_info',
+                        'mod_oublog_get_blog_allposts', 'mod_oublog_get_blog_posts'),
+                'requiredcapability' => '',
+                'restrictedusers' => 1,
+                'enabled' => 1,
+                'downloadfiles' => 1
+        )
+);
diff --git a/mod/oublog/db/tasks.php b/mod/oublog/db/tasks.php
new file mode 100644
index 0000000..639cf9d
--- /dev/null
+++ b/mod/oublog/db/tasks.php
@@ -0,0 +1,38 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Definition of OUblog scheduled tasks.
+ *
+ * @package mod_oublog
+ * @category task
+ * @copyright 2014 The Open University
+ * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+$tasks = array(
+    array(
+        'classname' => 'mod_oublog\task\cron_task',
+        'blocking' => 0,
+        'minute' => '0',
+        'hour' => '*/4',
+        'day' => '*',
+        'month' => '*',
+        'dayofweek' => '*'
+    )
+);
diff --git a/mod/oublog/db/upgrade.php b/mod/oublog/db/upgrade.php
new file mode 100644
index 0000000..cf9e31b
--- /dev/null
+++ b/mod/oublog/db/upgrade.php
@@ -0,0 +1,409 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+// This file keeps track of upgrades to
+// the oublog module
+//
+// Sometimes, changes between versions involve
+// alterations to database structures and other
+// major things that may break installations.
+//
+// The upgrade function in this file will attempt
+// to perform all the necessary actions to upgrade
+// your older installtion to the current version.
+//
+// If there's something it cannot do itself, it
+// will tell you what you need to do.
+//
+// The commands in here will all be database-neutral,
+// using the functions defined in lib/ddllib.php
+
+function xmldb_oublog_upgrade($oldversion=0) {
+
+    global $CFG, $THEME, $DB;
+
+    $dbman = $DB->get_manager(); // Loads ddl manager and xmldb classes.
+
+    if ($oldversion < 2012031500) {
+
+        // Define field grade to be added to oublog
+        $table = new xmldb_table('oublog');
+        $field = new xmldb_field('grade', XMLDB_TYPE_INTEGER, '10',
+            XMLDB_UNSIGNED, XMLDB_NOTNULL, null, '0', 'individual');
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+        upgrade_mod_savepoint(true, 2012031500, 'oublog');
+    }
+
+    if ($oldversion < 2012052100) {
+        // Correct log table entries for oublog.
+        $rs = $DB->get_recordset_select('log',
+                "module='participation' OR module='userparticipation'
+                AND action='view' AND url LIKE '%participation.php%'");
+        if ($rs->valid()) {
+            foreach ($rs as $entry) {
+                $entry->module = 'oublog';
+                $DB->update_record('log', $entry);
+            }
+        }
+        upgrade_mod_savepoint(true, 2012052100, 'oublog');
+    }
+
+    if ($oldversion < 2012061800) {
+        // Define field maxbytes to be added to oublog.
+        $table = new xmldb_table('oublog');
+        $field = new xmldb_field('maxbytes', XMLDB_TYPE_INTEGER, '10',
+                XMLDB_UNSIGNED, XMLDB_NOTNULL, null, '512000', 'maxvisibility');
+
+        // Conditionally launch add field maxbytes.
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+
+        // Define field maxattachments to be added to oublog.
+        $table = new xmldb_table('oublog');
+        $field = new xmldb_field('maxattachments', XMLDB_TYPE_INTEGER, '10',
+                XMLDB_UNSIGNED, XMLDB_NOTNULL, null, '9', 'maxbytes');
+
+        // Conditionally launch add field maxattachments.
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+
+        // OUblog savepoint reached.
+        upgrade_mod_savepoint(true, 2012061800, 'oublog');
+    }
+
+    if ($oldversion < 2012102301) {
+        $table = new xmldb_table('oublog');
+        $field = new xmldb_field('grade', XMLDB_TYPE_INTEGER, '10', null,
+                XMLDB_NOTNULL, null, '0', 'individual');
+        // Redefining grade field (signed automatically in 2.3).
+        $dbman->change_field_unsigned($table, $field);
+        // OUblog savepoint reached.
+        upgrade_mod_savepoint(true, 2012102301, 'oublog');
+    }
+
+    if ($oldversion < 2013010800) {
+        // Rename field summary on table oublog to intro
+        $table = new xmldb_table('oublog');
+        $field = new xmldb_field('summary', XMLDB_TYPE_TEXT, 'small', null, null, null, null, 'name');
+
+        // Launch rename field summary
+        if ($dbman->field_exists($table, $field)) {
+            $dbman->rename_field($table, $field, 'intro');
+        }
+
+        // oublog savepoint reached
+        upgrade_mod_savepoint(true, 2013010800, 'oublog');
+    }
+
+    if ($oldversion < 2013010801) {
+        // Define field introformat to be added to oublog
+        $table = new xmldb_table('oublog');
+        $field = new xmldb_field('introformat', XMLDB_TYPE_INTEGER, '4', null, XMLDB_NOTNULL, null, '0', 'intro');
+
+        // Launch add field introformat
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+
+        // conditionally migrate to html format in intro
+        if ($CFG->texteditors !== 'textarea') {
+            $rs = $DB->get_recordset('oublog', array('introformat' => FORMAT_MOODLE), '', 'id, intro, introformat');
+            foreach ($rs as $b) {
+                $b->intro = text_to_html($b->intro, false, false, true);
+                $b->introformat = FORMAT_HTML;
+                $DB->update_record('oublog', $b);
+                upgrade_set_timeout();
+            }
+            unset($b);
+            $rs->close();
+        }
+
+        // oublog savepoint reached
+        upgrade_mod_savepoint(true, 2013010801, 'oublog');
+    }
+
+    // Add reporting email(s) for OU Alert plugin use.
+    if ($oldversion < 2013101000) {
+        // Define field maxbytes to be added to oublog.
+        $table = new xmldb_table('oublog');
+        $field = new xmldb_field('reportingemail', XMLDB_TYPE_CHAR, '255',
+                null, null, null, null, 'grade');
+
+        // Conditionally launch add field maxbytes.
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+
+        // OUblog savepoint reached.
+        upgrade_mod_savepoint(true, 2013101000, 'oublog');
+    }
+
+    if ($oldversion < 2013102800) {
+
+        // Define field displayname to be added to oublog.
+        $table = new xmldb_table('oublog');
+        $field = new xmldb_field('displayname', XMLDB_TYPE_CHAR, '255', null, null, null, null,
+                'reportingemail');
+
+        // Conditionally launch add field displayname.
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+
+        // Oublog savepoint reached.
+        upgrade_mod_savepoint(true, 2013102800, 'oublog');
+    }
+
+    if ($oldversion < 2013102801) {
+
+        // Define field statblockon to be added to oublog.
+        $table = new xmldb_table('oublog');
+        $field = new xmldb_field('statblockon', XMLDB_TYPE_INTEGER, '1', null, XMLDB_NOTNULL, null, '0', 'displayname');
+
+        // Conditionally launch add field statblockon.
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+        upgrade_mod_savepoint(true, 2013102801, 'oublog');
+    }
+
+    if ($oldversion < 2013121100) {
+        // Numerous keys and indexes added.
+        // Define key oublog_posts_groupid_groups_fk (foreign) to be added to oublog_posts.
+        $table = new xmldb_table('oublog_posts');
+        $key = new xmldb_key('oublog_posts_groupid_groups_fk', XMLDB_KEY_FOREIGN, array('groupid'), 'groups', array('id'));
+
+        // Launch add key oublog_posts_groupid_groups_fk.
+        $dbman->add_key($table, $key);
+
+        // Define index allowcomments (not unique) to be added to oublog_posts.
+        $table = new xmldb_table('oublog_posts');
+        $index = new xmldb_index('allowcomments', XMLDB_INDEX_NOTUNIQUE, array('allowcomments'));
+
+        // Conditionally launch add index allowcomments.
+        if (!$dbman->index_exists($table, $index)) {
+            $dbman->add_index($table, $index);
+        }
+
+        // Define index visibility (not unique) to be added to oublog_posts.
+        $table = new xmldb_table('oublog_posts');
+        $index = new xmldb_index('visibility', XMLDB_INDEX_NOTUNIQUE, array('visibility'));
+
+        // Conditionally launch add index visibility.
+        if (!$dbman->index_exists($table, $index)) {
+            $dbman->add_index($table, $index);
+        }
+
+        // Define index timeposted (not unique) to be added to oublog_comments.
+        $table = new xmldb_table('oublog_comments');
+        $index = new xmldb_index('timeposted', XMLDB_INDEX_NOTUNIQUE, array('timeposted'));
+
+        // Conditionally launch add index timeposted.
+        if (!$dbman->index_exists($table, $index)) {
+            $dbman->add_index($table, $index);
+        }
+
+        // Oublog savepoint reached.
+        upgrade_mod_savepoint(true, 2013121100, 'oublog');
+    }
+
+    if ($oldversion < 2014012702) {
+
+        // Define field allowimport to be added to oublog.
+        $table = new xmldb_table('oublog');
+        $field = new xmldb_field('allowimport', XMLDB_TYPE_INTEGER, '1', null, XMLDB_NOTNULL, null, '0', 'statblockon');
+
+        // Conditionally launch add field allowimport.
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+
+        // Oublog savepoint reached.
+        upgrade_mod_savepoint(true, 2014012702, 'oublog');
+    }
+
+    if ($oldversion < 2014042400) {
+
+        // Define field introonpost to be added to oublog.
+        $table = new xmldb_table('oublog');
+        $field = new xmldb_field('introonpost', XMLDB_TYPE_INTEGER, '1', null, XMLDB_NOTNULL, null, '0', 'allowimport');
+
+        // Conditionally launch add field introonpost.
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+
+        // Oublog savepoint reached.
+        upgrade_mod_savepoint(true, 2014042400, 'oublog');
+    }
+
+    // Update oublog table, adding tags text field (can be null).
+    if ($oldversion < 2014072501) {
+
+        // Define field tags to be added to oublog.
+        $table = new xmldb_table('oublog');
+        $field = new xmldb_field('tags', XMLDB_TYPE_CHAR, '255', null, null, null, null, 'introonpost');
+        // Conditionally launch add field introonpost.
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+
+        // Oublog savepoint reached.
+        upgrade_mod_savepoint(true, 2014072501, 'oublog');
+    }
+
+    if ($oldversion < 2014102300) {
+        // Define field assessed to be added to oublog.
+        $table = new xmldb_table('oublog');
+        $field = new xmldb_field('assessed', XMLDB_TYPE_INTEGER, '10',
+                        XMLDB_UNSIGNED, XMLDB_NOTNULL, null, '0', 'tags');
+
+        // Conditionally launch add field assessed.
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+
+        // Define field assesstimestart to be added to oublog.
+        $table = new xmldb_table('oublog');
+        $field = new xmldb_field('assesstimestart', XMLDB_TYPE_INTEGER, '10',
+                        XMLDB_UNSIGNED, XMLDB_NOTNULL, null, '0', 'assessed');
+
+        // Conditionally launch add field assesstimestart.
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+
+        // Define field assesstimefinish to be added to oublog.
+        $table = new xmldb_table('oublog');
+        $field = new xmldb_field('assesstimefinish', XMLDB_TYPE_INTEGER, '10',
+                        XMLDB_UNSIGNED, XMLDB_NOTNULL, null, '0', 'assesstimestart');
+
+        // Conditionally launch add field assesstimefinish.
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+
+        // Define field scale to be added to oublog.
+        $table = new xmldb_table('oublog');
+        $field = new xmldb_field('scale', XMLDB_TYPE_INTEGER, '10',
+                        XMLDB_UNSIGNED, XMLDB_NOTNULL, null, '0', 'assesstimefinish');
+
+        // Conditionally launch add field scale.
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+
+        // Define field grading to be added to oublog.
+        $table = new xmldb_table('oublog');
+        $field = new xmldb_field('grading', XMLDB_TYPE_INTEGER, '10',
+                        XMLDB_UNSIGNED, XMLDB_NOTNULL, null, '0', 'scale');
+
+        // Conditionally launch add field grading.
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+        // Set the new grading field to 1 for everything that isn't a default grade.
+        $DB->set_field_select('oublog', 'grading', 1, 'grade != 0');
+
+        // OUblog savepoint reached.
+        upgrade_mod_savepoint(true, 2014102300, 'oublog');
+    }
+
+    if ($oldversion < 2014122400) {
+        // Define field restricttags to be added to oublog.
+        $table = new xmldb_table('oublog');
+        $field = new xmldb_field('restricttags', XMLDB_TYPE_INTEGER, '10',
+                        XMLDB_UNSIGNED, XMLDB_NOTNULL, null, '0', 'grading');
+
+        // Conditionally launch add field restricttags.
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+
+        // OUblog savepoint reached.
+        upgrade_mod_savepoint(true, 2014122400, 'oublog');
+    }
+
+    if ($oldversion < 2015090800) {
+
+        // Define field postfrom to be added to oublog.
+        $table = new xmldb_table('oublog');
+        $field = new xmldb_field('postfrom', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, '0', 'restricttags');
+
+        // Conditionally launch add field postfrom.
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+
+        // Define field postuntil to be added to oublog.
+        $table = new xmldb_table('oublog');
+        $field = new xmldb_field('postuntil', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, '0', 'postfrom');
+
+        // Conditionally launch add field postuntil.
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+
+        // Define field commentfrom to be added to oublog.
+        $table = new xmldb_table('oublog');
+        $field = new xmldb_field('commentfrom', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, '0', 'postuntil');
+
+        // Conditionally launch add field commentfrom.
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+
+        // Define field commentuntil to be added to oublog.
+        $table = new xmldb_table('oublog');
+        $field = new xmldb_field('commentuntil', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, '0', 'commentfrom');
+
+        // Conditionally launch add field commentuntil.
+        if (!$dbman->field_exists($table, $field)) {
+            $dbman->add_field($table, $field);
+        }
+
+        // Oublog savepoint reached.
+        upgrade_mod_savepoint(true, 2015090800, 'oublog');
+    }
+
+    if ($oldversion < 2015101501) {
+        global $DB;
+
+        // Fix grade set when grading off.
+        $DB->set_field_select('oublog', 'grade', 0, 'grading = 0 and grade != 0');
+
+        // Oublog savepoint reached.
+        upgrade_mod_savepoint(true, 2015101501, 'oublog');
+    }
+
+    if ($oldversion < 2016081600) {
+
+        // Rename field tags on table oublog to tagslist.
+        $table = new xmldb_table('oublog');
+        $field = new xmldb_field('tags', XMLDB_TYPE_CHAR, '255', null, null, null, null, 'introonpost');
+
+        // Launch rename field tags.
+        $dbman->rename_field($table, $field, 'tagslist');
+
+        // Oublog savepoint reached.
+        upgrade_mod_savepoint(true, 2016081600, 'oublog');
+    }
+
+    return true;
+}
diff --git a/mod/oublog/deletecomment.php b/mod/oublog/deletecomment.php
new file mode 100644
index 0000000..d701df9
--- /dev/null
+++ b/mod/oublog/deletecomment.php
@@ -0,0 +1,121 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+/**
+ * This page allows a user to delete a blog comments
+ *
+ * @author Matt Clarkson <mattc@catalyst.net.nz>
+ * @package oublog
+ */
+require_once("../../config.php");
+require_once("locallib.php");
+require_once($CFG->libdir . '/completionlib.php');
+
+$commentid  = required_param('comment', PARAM_INT);    // Comment ID to delete
+$confirm = optional_param('confirm', 0, PARAM_INT);    // Confirm that it is ok to delete comment
+
+if (!$comment = $DB->get_record('oublog_comments', array('id'=>$commentid))) {
+    print_error('invalidcomment',  'oublog');
+}
+
+if (!$post = oublog_get_post($comment->postid)) {
+    print_error("invalidpost", 'oublog');
+}
+
+if (!$cm = get_coursemodule_from_instance('oublog', $post->oublogid)) {
+    print_error('invalidcoursemodule');
+}
+
+if (!$course = $DB->get_record("course", array("id"=>$cm->course))) {
+    print_error('coursemisconf');
+}
+
+if (!$oublog = $DB->get_record("oublog", array("id"=>$cm->instance))) {
+    print_error('invalidcoursemodule');
+}
+$url = new moodle_url('/mod/oublog/deletepost.php', array('comment'=>$commentid, 'confirm'=>$confirm));
+$PAGE->set_url($url);
+
+// Check security.
+$context = context_module::instance($cm->id);
+oublog_check_view_permissions($oublog, $context, $cm);
+
+// You can always delete your own comments, or any comment on your own
+// personal blog
+if (!($comment->userid==$USER->id ||
+    ($oublog->global && $post->userid == $USER->id))) {
+    require_capability('mod/oublog:managecomments', $context);
+}
+
+if ($oublog->global) {
+    $blogtype = 'personal';
+    // Get blog user from the oublog_get_post result (to save making an
+    // extra query); this is only used to display their name anyhow
+    $oubloguser = new stdClass();
+    $oubloguser->id = $post->userid;
+    foreach (get_all_user_name_fields() as $field) {
+        $oubloguser->$field = $post->$field;
+    }
+} else {
+    $blogtype = 'course';
+}
+$viewurl = new moodle_url('/mod/oublog/viewpost.php', array('post'=>$post->id));
+
+if (!empty($commentid) && !empty($confirm)) {
+    $timedeleted = time();
+    $updatecomment = (object)array(
+        'id' => $commentid,
+        'deletedby' => $USER->id,
+        'timedeleted' => $timedeleted);
+    $DB->update_record('oublog_comments', $updatecomment);
+
+    // Inform completion system, if available
+    $completion = new completion_info($course);
+    if ($completion->is_enabled($cm) && ($oublog->completioncomments)) {
+        $completion->update_state($cm, COMPLETION_INCOMPLETE, $comment->userid);
+    }
+
+    // Log delete comment event.
+    $params = array(
+        'context' => $context,
+        'objectid' => $comment->id,
+        'other' => array(
+            'oublogid' => $oublog->id,
+            'postid' => $comment->postid,
+        )
+    );
+    $event = \mod_oublog\event\comment_deleted::create($params);
+    $event->trigger();
+
+    redirect($viewurl);
+    exit;
+}
+
+// Get Strings.
+$stroublogs  = get_string('modulenameplural', 'oublog');
+$stroublog   = get_string('modulename', 'oublog');
+
+// Print the header.
+$PAGE->set_title(format_string($oublog->name));
+$PAGE->set_heading(format_string($course->fullname));
+if ($blogtype == 'personal') {
+    $PAGE->navbar->add(fullname($oubloguser), new moodle_url('/user/view.php', array('id'=>$oubloguser->id)));
+    $PAGE->navbar->add(format_string($oublog->name));
+}
+echo $OUTPUT->header();
+echo $OUTPUT->confirm(get_string('confirmdeletecomment', 'oublog'),
+                 new moodle_url('/mod/oublog/deletecomment.php', array('comment'=>$commentid, 'confirm'=>'1')),
+                 $viewurl);
+echo $OUTPUT->footer();
\ No newline at end of file
diff --git a/mod/oublog/deletelink.php b/mod/oublog/deletelink.php
new file mode 100644
index 0000000..0f89bf1
--- /dev/null
+++ b/mod/oublog/deletelink.php
@@ -0,0 +1,84 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+/**
+ * This page allows a user to delete a blog comments
+ *
+ * @author Matt Clarkson <mattc@catalyst.net.nz>
+ * @package oublog
+ */
+require_once("../../config.php");
+require_once("locallib.php");
+
+$linkid  = required_param('link', PARAM_INT);          // Link ID to delete
+$confirm = optional_param('confirm', 0, PARAM_INT);    // Confirm that it is ok to delete link
+
+if (!$link = $DB->get_record('oublog_links', array('id'=> $linkid))) {
+    print_error('invalidlink', 'oublog');
+}
+
+if (!$cm = get_coursemodule_from_instance('oublog', $link->oublogid)) {
+    print_error('invalidcoursemodule');
+}
+
+if (!$course = $DB->get_record("course", array("id"=> $cm->course))) {
+    print_error('coursemisconf');
+}
+
+if (!$oublog = $DB->get_record("oublog", array("id"=> $cm->instance))) {
+    print_error('invalidcoursemodule');
+}
+
+$url = new moodle_url('/mod/oublog/deletelink.php', array('link'=>$linkid, 'confirm'=>$confirm));
+$PAGE->set_url($url);
+
+// Check security.
+$context = context_module::instance($cm->id);
+oublog_check_view_permissions($oublog, $context, $cm);
+
+$oubloginstance = $link->oubloginstancesid ? $DB->get_record('oublog_instances', array('id'=>$link->oubloginstancesid)) : null;
+oublog_require_userblog_permission('mod/oublog:managelinks', $oublog, $oubloginstance, $context);
+
+if ($oublog->global) {
+    $blogtype = 'personal';
+    $oubloguser = $USER;
+} else {
+    $blogtype = 'course';
+}
+
+$viewurl = new moodle_url('/mod/oublog/view.php', array('id'=>$cm->id));
+
+if (!empty($linkid) && !empty($confirm)) {
+    oublog_delete_link($oublog, $link);
+    redirect($viewurl);
+    exit;
+}
+
+// Get Strings.
+$stroublogs  = get_string('modulenameplural', 'oublog');
+$stroublog   = get_string('modulename', 'oublog');
+
+// Print the header.
+if ($blogtype == 'personal') {
+        $PAGE->navbar->add(fullname($oubloguser), new moodle_url('/user/view.php', array('id'=>$oubloguser->id)));
+        $PAGE->navbar->add(format_string($oublog->name));
+}
+$PAGE->set_title(format_string($oublog->name));
+$PAGE->set_heading(format_string($course->fullname));
+echo $OUTPUT->header();
+echo $OUTPUT->confirm(get_string('confirmdeletelink', 'oublog'),
+                 new moodle_url('/mod/oublog/deletelink.php', array('link'=>$linkid, 'confirm'=>'1')),
+                 $viewurl);
+echo $OUTPUT->footer();
diff --git a/mod/oublog/deletepost.php b/mod/oublog/deletepost.php
new file mode 100644
index 0000000..5a5939b
--- /dev/null
+++ b/mod/oublog/deletepost.php
@@ -0,0 +1,288 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+/**
+ * This page allows a user to delete a blog posts
+ *
+ * @author Matt Clarkson <mattc@catalyst.net.nz>
+ * @package oublog
+ */
+require_once("../../config.php");
+require_once($CFG->dirroot . '/mod/oublog/locallib.php');
+require_once($CFG->libdir . '/completionlib.php');
+
+$blog = required_param('blog', PARAM_INT);         // Blog ID.
+$postid = required_param('post', PARAM_INT);       // Post ID for editing.
+$confirm = optional_param('confirm', 0, PARAM_INT);// Confirm that it is ok to delete post.
+$delete = optional_param('delete', 0, PARAM_INT);
+$email = optional_param('email', 0, PARAM_INT);    // Email author.
+$referurl = optional_param('referurl', 0, PARAM_LOCALURL);
+
+if (!$oublog = $DB->get_record("oublog", array("id"=>$blog))) {
+    print_error('invalidblog', 'oublog');
+}
+if (!$post = oublog_get_post($postid, false)) {
+    print_error('invalidpost', 'oublog');
+}
+if (!$cm = get_coursemodule_from_instance('oublog', $blog)) {
+    print_error('invalidcoursemodule');
+}
+if (!$course = $DB->get_record("course", array("id"=>$oublog->course))) {
+    print_error('coursemisconf');
+}
+$url = new moodle_url('/mod/oublog/deletepost.php',
+        array('blog' => $blog, 'post' => $postid, 'confirm' => $confirm));
+$PAGE->set_url($url);
+
+// Check security.
+$context = context_module::instance($cm->id);
+oublog_check_view_permissions($oublog, $context, $cm);
+
+$postauthor=$DB->get_field_sql("
+SELECT
+    i.userid
+FROM
+    {oublog_posts} p
+    INNER JOIN {oublog_instances} i on p.oubloginstancesid=i.id
+WHERE p.id = ?", array($postid));
+if ($postauthor!=$USER->id) {
+    require_capability('mod/oublog:manageposts', $context);
+}
+
+$oublogoutput = $PAGE->get_renderer('mod_oublog');
+
+if ($oublog->global) {
+    $blogtype = 'personal';
+    $oubloguser = $USER;
+    $viewurl = new moodle_url('/mod/oublog/view.php', array('user' => $postauthor));
+    if (isset($referurl)) {
+        $viewurl = new moodle_url($referurl);
+    }
+    // Print the header.
+    $PAGE->navbar->add(fullname($oubloguser), new moodle_url('/user/view.php',
+            array('id' => $oubloguser->id)));
+    $PAGE->navbar->add(format_string($oublog->name));
+} else {
+    $blogtype = 'course';
+    $viewurl = new moodle_url('/mod/oublog/view.php', array('id' => $cm->id));
+    if (isset($referurl)) {
+        $viewurl = new moodle_url($referurl);
+    }
+}
+
+if ($email) {
+    // Then open and process the form.
+    require_once($CFG->dirroot . '/mod/oublog/deletepost_form.php');
+    $customdata = (object)array('blog' => $blog, 'post' => $postid,
+            'delete' => $delete, 'email' => $email, 'referurl' => $viewurl);
+    $mform = new mod_oublog_deletepost_form('deletepost.php', $customdata);
+    if ($mform->is_cancelled()) {
+        // Form is cancelled, redirect back to the blog.
+        redirect($viewurl);
+    } else if ($submitted = $mform->get_data()) {
+        // Mark the post as deleted.
+        oublog_do_delete($course, $cm, $oublog, $post);
+        // We need these for the call to render post.
+        $canaudit = $canmanageposts = false;
+
+        // Store copy of the post for the author.
+        // If subject is set in this post, use it.
+        if (!isset($post->title) || empty($post->title)) {
+            $post->title = get_string('deletedblogpost', 'oublog');
+        }
+        $messagepost = $oublogoutput->render_post($cm, $oublog, $post, $viewurl, $blogtype,
+                $canmanageposts, $canaudit, false, false, false, true);
+
+        // Set up the email message detail.
+        $messagetext = $submitted->message['text'];
+        $copyself = (isset($submitted->copyself)) ? true : false;
+        $includepost = (isset($submitted->includepost)) ? true : false;
+        $from = $SITE->fullname;
+
+        // Use prefered format for author of the post.
+        $user = (object)array(
+                'email' => $post->email,
+                'mailformat' => $post->mailformat,
+                'id' => $post->userid
+        );
+
+        $messagehtml = text_to_html($messagetext);
+
+        // Include the copy of the post in the email.
+        if ($includepost) {
+            $messagehtml .= $messagepost;
+        }
+        // Send an email to the author of the post.
+        if (!email_to_user($user, $from, $post->title, html_to_text($messagehtml), $messagehtml)) {
+            print_error(get_string('emailerror', 'oublog'));
+        }
+
+        // Prepare for copies.
+        $emails = array();
+        if ($copyself) {
+            // Send an email copy to the current user, with prefered format.
+            $subject = strtoupper(get_string('copy')) . ' - '. $post->title;
+            if (!email_to_user($USER, $from, $subject, html_to_text($messagehtml), $messagehtml)) {
+                print_error(get_string('emailerror', 'oublog'));
+            }
+        }
+
+        // Addition of 'Email address of other recipients'.
+        if (!empty($submitted->emailadd)) {
+            $emails = preg_split('~[; ]+~', $submitted->emailadd);
+        }
+
+        // If there are any recipients listed send them a HTML copy.
+        if (!empty($emails[0])) {
+            $subject = strtoupper(get_string('copy')) . ' - '. $post->title;
+            foreach ($emails as $email) {
+                $fakeuser = (object)array(
+                        'email' => $email,
+                        'mailformat' => 1,
+                        'id' => -1
+                );
+                if (!email_to_user($fakeuser, $from, $subject, '', $messagehtml)) {
+                    print_error(get_string('emailerror', 'oublog'));
+                }
+            }
+        }
+        redirect($viewurl);
+    } else if (($delete && $email) ) {
+        // If subject is set in this post, use it.
+        if (!isset($post->title) || empty($post->title)) {
+            $post->title = get_string('deletedblogpost', 'oublog');
+        }
+        $displayname = oublog_get_displayname($oublog, true);
+        // Prepare the object for the emailcontenthtml get_string.
+        $emailmessage = new stdClass;
+        $emailmessage->subject = $post->title;
+        $emailmessage->blog = $oublog->name;
+        $emailmessage->activityname = $displayname;
+        $emailmessage->firstname = $USER->firstname;
+        $emailmessage->lastname = $USER->lastname;
+        $emailmessage->course = $COURSE->fullname;
+        $emailmessage->deleteurl = $CFG->wwwroot . '/mod/oublog/viewpost.php?&post=' . $post->id;
+        $formdata = new stdClass;
+        $messagetext = get_string('emailcontenthtml', 'oublog', $emailmessage);
+        $formdata->message['text'] = $messagetext;
+        // Display the form.
+        echo $OUTPUT->header();
+        $mform->set_data($formdata);
+        $mform->display();
+    }
+} else {
+    if (!$confirm) {
+        $PAGE->set_title(format_string($oublog->name));
+        $PAGE->set_heading(format_string($course->fullname));
+        echo $OUTPUT->header();
+        $confirmdeletestring = get_string('confirmdeletepost', 'oublog');
+        $confirmstring = get_string('deleteemailpostdescription', 'oublog');
+
+        $deletebutton = new single_button(new moodle_url('/mod/oublog/deletepost.php',
+                array('blog' => $blog, 'post' => $postid, 'delete' => '1',
+                        'confirm' => '1', 'referurl' => $viewurl)), get_string('delete'), 'post');
+        $cancelbutton = new single_button($viewurl, get_string('cancel'), 'get');
+
+        if ($USER->id == $post->userid) {
+            print $OUTPUT->confirm($confirmdeletestring, $deletebutton, $cancelbutton);
+        } else {
+            // Delete - Delete and email || Cancel.
+            $deleteemailbutton = new single_button(new moodle_url('/mod/oublog/deletepost.php',
+                    array('blog' => $blog, 'post' => $postid, 'email' => '1', 'delete' => '1')),
+                    get_string('deleteemailpostbutton', 'oublog'), 'post');
+            print oublog_three_button($confirmstring,
+                    $deletebutton,
+                    $deleteemailbutton,
+                    $cancelbutton);
+        }
+    } else {
+        // Mark the post as deleted.
+        oublog_do_delete($course, $cm, $oublog, $post);
+        redirect($viewurl);
+    }
+}
+
+echo $OUTPUT->footer();
+
+function oublog_do_delete($course, $cm, $oublog, $post) {
+    global $DB, $USER;
+    $updatepost = (object)array(
+            'id' => $post->id,
+            'deletedby' => $USER->id,
+            'timedeleted' => time()
+    );
+
+    $transaction = $DB->start_delegated_transaction();
+    $DB->update_record('oublog_posts', $updatepost);
+    if (!oublog_update_item_tags($post->oubloginstancesid, $post->id,
+            array(), $post->visibility)) {
+        print_error('tagupdatefailed', 'oublog');
+    }
+    if (oublog_search_installed()) {
+        $doc = oublog_get_search_document($updatepost, $cm);
+        $doc->delete();
+    }
+    // Inform completion system, if available.
+    $completion = new completion_info($course);
+    if ($completion->is_enabled($cm) && ($oublog->completionposts)) {
+        $completion->update_state($cm, COMPLETION_INCOMPLETE, $post->userid);
+    }
+    $transaction->allow_commit();
+
+    // Log post deleted event.
+    $context = context_module::instance($cm->id);
+    $params = array(
+        'context' => $context,
+        'objectid' => $post->id,
+        'other' => array(
+            'oublogid' => $oublog->id
+        )
+    );
+    $event = \mod_oublog\event\post_deleted::create($params);
+    $event->trigger();
+}
+
+/**
+ * Print a message along with three buttons buttoneone/buttontwo/Cancel
+ *
+ * If a string or moodle_url is given instead of a single_button, method defaults to post.
+ *
+ * @param string $message The question to ask the user.
+ * @param single_button $buttonone The single_button component representing the buttontwo response.
+ * @param single_button $buttontwo The single_button component representing the buttontwo response.
+ * @param single_button $cancel The single_button component representing the Cancel response.
+ * @return string HTML fragment
+ */
+function oublog_three_button($message, $buttonone, $buttontwo, $cancel) {
+    global $OUTPUT;
+    if (!($buttonone instanceof single_button)) {
+        throw new coding_exception('The buttonone param must be an instance of a single_button.');
+    }
+
+    if (!($buttontwo instanceof single_button)) {
+        throw new coding_exception('The buttontwo param must be an instance of a single_button.');
+    }
+
+    if (!($cancel instanceof single_button)) {
+        throw new coding_exception('The cancel param must be an instance of a single_button.');
+    }
+
+    $output = $OUTPUT->box_start('generalbox', 'notice');
+    $output .= html_writer::tag('p', $message);
+    $buttons = $OUTPUT->render($buttonone) . $OUTPUT->render($buttontwo) . $OUTPUT->render($cancel);
+    $output .= html_writer::tag('div', $buttons, array('class' => 'buttons'));
+    $output .= $OUTPUT->box_end();
+    return $output;
+}
diff --git a/mod/oublog/deletepost_form.php b/mod/oublog/deletepost_form.php
new file mode 100644
index 0000000..d0baaac
--- /dev/null
+++ b/mod/oublog/deletepost_form.php
@@ -0,0 +1,94 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+require_once($CFG->libdir.'/formslib.php');
+
+/**
+ * Form for sending an email to the author of a post when deleting
+ * @package mod
+ * @subpackage oublog
+ * @copyright 2013 The Open University
+ * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+class mod_oublog_deletepost_form extends moodleform {
+
+    public function definition() {
+        $mform =& $this->_form;
+
+        // Header.
+        $mform->addElement('header', 'general', get_string('deleteandemail', 'oublog'));
+
+        // Message box.
+        $mform->addElement('editor', 'message',
+                get_string('emailmessage', 'oublog'), array('size'=>'64', 'id' => 'id_oublog_delete_msg'));
+        $mform->setType('message', PARAM_RAW);
+        $mform->addRule('message', null, 'required', null, 'client');
+
+        // Send a copy to self.
+        $mform->addElement('checkbox', 'copyself', get_string('copytoself', 'oublog'));
+
+        // Adding optional text field 'Email address of other recipients'.
+        $mform->addElement('text', 'emailadd', get_string('extra_emails', 'oublog'),
+                array('size' => '48'));
+        $mform->addHelpButton('emailadd', 'extra_emails', 'oublog');
+        $mform->setType('emailadd', PARAM_RAW);
+
+        // Include a copy of the post.
+        $mform->addElement('checkbox', 'includepost', get_string('includepost', 'oublog'));
+
+        // Hidden fields for return url.
+        $mform->addElement('hidden', 'blog', $this->_customdata->blog);
+        $mform->setType('blog', PARAM_INT);
+
+        $mform->addElement('hidden', 'post', $this->_customdata->post);
+        $mform->setType('post', PARAM_INT);
+
+        $mform->addElement('hidden', 'email', $this->_customdata->email);
+        $mform->setType('email', PARAM_INT);
+
+        $mform->addElement('hidden', 'delete', $this->_customdata->delete);
+        $mform->setType('delete', PARAM_INT);
+
+        $mform->addElement('hidden', 'referurl', $this->_customdata->referurl);
+        $mform->setType('referurl', PARAM_LOCALURL);
+
+        $mform->addElement('hidden', 'confirm', 1);
+        $mform->setType('confirm', PARAM_INT);
+
+        // Add some buttons.
+        $this->add_action_buttons(true, get_string('sendanddelete', 'oublog'));
+
+    }
+
+    public function validation($data, $files) {
+        $errors = parent::validation($data, $files);
+        if (!empty($data['emailadd'])) {
+            $emails = preg_split('~[; ]+~', $data['emailadd']);
+            if (count($emails) < 1) {
+                $errors['emailadd'] = get_string('invalidemails', 'oublog');
+            } else {
+                foreach ($emails as $email) {
+                    if (!validate_email($email)) {
+                        $errors['emailadd'] = get_string('invalidemails', 'oublog');
+                        break;
+                    }
+                }
+            }
+        }
+        return $errors;
+    }
+
+}
diff --git a/mod/oublog/editcomment.php b/mod/oublog/editcomment.php
new file mode 100644
index 0000000..237916f
--- /dev/null
+++ b/mod/oublog/editcomment.php
@@ -0,0 +1,190 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+/**
+ * This page allows a user to add and edit blog comments
+ *
+ * @author Matt Clarkson <mattc@catalyst.net.nz>
+ * @author Sam Marshall <s.marshall@open.ac.uk>
+ * @package oublog
+ */
+require_once("../../config.php");
+require_once("locallib.php");
+require_once('comment_form.php');
+
+define('OUBLOG_CONFIRMED_COOKIE', 'OUBLOG_REALPERSON');
+
+$blog = required_param('blog', PARAM_INT);              // Blog ID
+$postid = required_param('post', PARAM_INT);            // Post ID for editing
+$commentid = optional_param('comment', 0, PARAM_INT);   // Comment ID for editing
+
+if (!$oublog = $DB->get_record("oublog", array("id"=>$blog))) {
+    print_error('invalidblog', 'oublog');
+}
+if (!$cm = get_coursemodule_from_instance('oublog', $blog)) {
+    print_error('invalidcoursemodule');
+}
+if (!$course = $DB->get_record("course", array("id"=>$oublog->course))) {
+    print_error('coursemisconf');
+}
+if (!$post = oublog_get_post($postid)) {
+    print_error('invalidpost', 'oublog');
+}
+if (!$oubloginstance = $DB->get_record('oublog_instances', array('id'=>$post->oubloginstancesid))) {
+    print_error('invalidblog', 'oublog');
+}
+$url = new moodle_url('/mod/oublog/editcomment.php', array('blog'=>$blog, 'post'=>$postid, 'comment'=>$commentid));
+$PAGE->set_url($url);
+
+// Check security.
+$context = context_module::instance($cm->id);
+
+oublog_check_view_permissions($oublog, $context, $cm);
+$post->userid=$oubloginstance->userid; // oublog_can_view_post needs this
+if (!oublog_can_view_post($post, $USER, $context, $oublog->global)) {
+    print_error('accessdenied', 'oublog');
+}
+
+oublog_get_activity_groupmode($cm, $course);
+if (!oublog_can_comment($cm, $oublog, $post)) {
+    print_error('accessdenied', 'oublog');
+}
+
+if ($oublog->allowcomments == OUBLOG_COMMENTS_PREVENT || $post->allowcomments == OUBLOG_COMMENTS_PREVENT) {
+    print_error('commentsnotallowed', 'oublog');
+}
+
+$viewurl = 'viewpost.php?post='.$post->id;
+if ($oublog->global) {
+    $blogtype = 'personal';
+    if (!$oubloguser = $DB->get_record('user', array('id'=>$oubloginstance->userid))) {
+        print_error('invaliduserid');
+    }
+} else {
+    $blogtype = 'course';
+}
+
+$renderer = $PAGE->get_renderer('mod_oublog');
+
+// Get strings.
+$stroublogs  = get_string('modulenameplural', 'oublog');
+$stroublog   = get_string('modulename', 'oublog');
+$straddcomment  = get_string('newcomment', 'oublog');
+
+$moderated = !(isloggedin() && !isguestuser());
+$confirmed = isset($_COOKIE[OUBLOG_CONFIRMED_COOKIE]) &&
+        $_COOKIE[OUBLOG_CONFIRMED_COOKIE] == get_string(
+            'moderated_confirmvalue', 'oublog');
+$mform = new mod_oublog_comment_form('editcomment.php', array(
+        'maxvisibility' => $oublog->maxvisibility,
+        'edit' => !empty($commentid),
+        'blogid' => $blog,
+        'postid' => $postid,
+        'moderated' => $moderated,
+        'confirmed' => $confirmed,
+        'maxbytes' => $oublog->maxbytes,
+        'postrender' => $renderer->render_post($cm, $oublog, $post, $url, $blogtype, false, false, false, false, false, true),
+        ));
+
+if ($mform->is_cancelled()) {
+    redirect($viewurl);
+    exit;
+}
+$PAGE->set_title(format_string($oublog->name));
+$PAGE->set_heading(format_string($course->fullname));
+
+if (!$comment = $mform->get_data()) {
+
+    $comment = new stdClass;
+    $comment->general = $straddcomment;
+    $comment->blog = $blog;
+    $comment->post = $postid;
+    $mform->set_data($comment);
+
+    // Print the header
+
+    if ($blogtype == 'personal') {
+        oublog_build_navigation($oublog, $oubloginstance, $oubloguser);
+    } else {
+        oublog_build_navigation($oublog, $oubloginstance, null);
+        $url = new moodle_url("$CFG->wwwroot/course/mod.php", array('update' => $cm->id, 'return' => true, 'sesskey' => sesskey()));
+    }
+
+    oublog_get_post_extranav($post);
+    $PAGE->navbar->add($comment->general);
+    echo $OUTPUT->header();
+
+
+    echo '<br />';
+    $mform->display();
+
+    echo $OUTPUT->footer();
+
+} else {
+    // Prepare comment for database
+    unset($comment->id);
+    $comment->userid = $USER->id;
+    $comment->postid = $postid;
+
+    // Special behaviour for moderated users
+    if ($moderated) {
+        // Check IP address
+        if (oublog_too_many_comments_from_ip()) {
+            print_error('error_toomanycomments', 'oublog');
+        }
+
+        // Set the confirmed cookie if they haven't got it yet
+        if (!$confirmed) {
+            setcookie(OUBLOG_CONFIRMED_COOKIE, $comment->confirm,
+                    time() + 365 * 24 * 3600); // Expire in 1 year
+        }
+
+        if (!oublog_add_comment_moderated($oublog, $oubloginstance, $post, $comment)) {
+            print_error('couldnotaddcomment', 'oublog');
+        }
+        $approvaltime = oublog_get_typical_approval_time($post->userid);
+
+        oublog_build_navigation($oublog, $oubloginstance, isset($oubloguser) ? $oubloguser : null);
+        oublog_get_post_extranav($post);
+        $PAGE->navbar->add(get_string('moderated_submitted', 'oublog'));
+        echo $OUTPUT->header();
+        notice(get_string('moderated_addedcomment', 'oublog') .
+                ($approvaltime ? ' ' .
+                    get_string('moderated_typicaltime', 'oublog', $approvaltime)
+                : ''), 'viewpost.php?post=' . $postid, $course);
+        // Does not continue.
+    }
+
+    $comment->userid = $USER->id;
+
+    if (!oublog_add_comment($course, $cm, $oublog, $comment)) {
+        print_error('couldnotaddcomment', 'oublog');
+    }
+
+    // Log add comment event.
+    $params = array(
+            'context' => $context,
+            'objectid' => $comment->id,
+            'other' => array(
+                'oublogid' => $oublog->id,
+                'postid' => $comment->postid,
+        )
+    );
+
+    $event = \mod_oublog\event\comment_created::create($params);
+    $event->trigger();
+
+    redirect($viewurl);
+}
diff --git a/mod/oublog/editinstance.php b/mod/oublog/editinstance.php
new file mode 100644
index 0000000..1e269ef
--- /dev/null
+++ b/mod/oublog/editinstance.php
@@ -0,0 +1,116 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+/**
+ * This page allows a user to edit their personal blog
+ *
+ * @author Matt Clarkson <mattc@catalyst.net.nz>
+ * @author Sam Marshall <s.marshall@open.ac.uk>
+ * @package oublog
+ */
+define('OUBLOG_EDIT_INSTANCE', true);
+
+require_once('../../config.php');
+require_once('locallib.php');
+require_once('lib.php');
+require_once('mod_form.php');
+
+$bloginstancesid = required_param('instance', PARAM_INT);        // Bloginstance
+$postid = optional_param('post', 0, PARAM_INT);   // Post ID for editing
+
+if (!$oubloginstance = $DB->get_record('oublog_instances', array('id'=>$bloginstancesid))) {
+    print_error('invalidblog', 'oublog');
+}
+if (!$oublog = $DB->get_record("oublog", array("id"=>$oubloginstance->oublogid))) {
+    print_error('invalidblog', 'oublog');
+}
+if (!$oublog->global) {
+    print_error('invalidblog', 'oublog');
+}
+if (!$cm = get_coursemodule_from_instance('oublog', $oublog->id)) {
+    print_error('invalidcoursemodule');
+}
+if (!$course = $DB->get_record("course", array("id"=>$oublog->course))) {
+    print_error('invalidcoursemodule');
+}
+
+// Check security.
+if (!$oublog->global) {
+    print_error('onlyworkspersonal', 'oublog');
+}
+$url = new moodle_url('/mod/oublog/editinstance.php', array('instance'=>$bloginstancesid, 'post'=>$postid));
+$PAGE->set_url($url);
+
+$context = context_module::instance($cm->id);
+oublog_check_view_permissions($oublog, $context, $cm);
+$oubloguser = $DB->get_record('user', array('id'=>$oubloginstance->userid));
+$viewurl = 'view.php?user='.$oubloginstance->userid;
+
+if ($USER->id != $oubloginstance->userid && !has_capability('mod/oublog:manageposts', $context)) {
+    print_error('accessdenied', 'oublog');
+}
+
+// Get strings.
+$stroublogs     = get_string('modulenameplural', 'oublog');
+$stroublog      = get_string('modulename', 'oublog');
+$streditpost    = get_string('editpost', 'oublog');
+$strblogoptions = get_string('blogoptions', 'oublog');
+
+// Set-up groups.
+$currentgroup = oublog_get_activity_group($cm, true);
+$groupmode = oublog_get_activity_groupmode($cm, $course);
+
+$mform = new mod_oublog_mod_form('editinstance.php', array('maxvisibility' => $oublog->maxvisibility, 'edit' => !empty($postid)));
+
+if ($mform->is_cancelled()) {
+    redirect($viewurl);
+    exit;
+}
+
+$textfieldoptions = array(
+        'maxfiles' => EDITOR_UNLIMITED_FILES,
+        'maxbytes' => $CFG->maxbytes,
+        'context' => $context,
+        );
+
+if (!$frmoubloginstance = $mform->get_data()) {
+
+    $oubloginstance->instance = $oubloginstance->id;
+    $oubloginstance->summaryformat = FORMAT_HTML;
+    $oubloginstance = file_prepare_standard_editor($oubloginstance, 'summary', $textfieldoptions, $context,
+            'mod_oublog', 'summary', $oubloginstance->id);
+    $mform->set_data($oubloginstance);
+
+    // Print the header.
+    oublog_build_navigation($oublog, $oubloginstance, $oubloguser);
+    $PAGE->navbar->add($strblogoptions);
+    $PAGE->set_title(format_string($oublog->name));
+    echo $OUTPUT->header();
+
+    echo '<br />';
+    $mform->display();
+
+    echo $OUTPUT->footer();
+
+} else {
+    // Handle form submission.
+    $frmoubloginstance->id = $frmoubloginstance->instance;
+    $frmoubloginstance->summaryformat = FORMAT_HTML;
+    $frmoubloginstance = file_postupdate_standard_editor($frmoubloginstance, 'summary', $textfieldoptions, $context,
+            'mod_oublog', 'summary', $frmoubloginstance->id);
+    $DB->update_record('oublog_instances', $frmoubloginstance);
+
+    redirect($viewurl);
+}
\ No newline at end of file
diff --git a/mod/oublog/editlink.php b/mod/oublog/editlink.php
new file mode 100644
index 0000000..0e36d73
--- /dev/null
+++ b/mod/oublog/editlink.php
@@ -0,0 +1,136 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+/**
+ * This page allows a user to add and edit related blog links
+ *
+ * @author Matt Clarkson <mattc@catalyst.net.nz>
+ * @package oublog
+ */
+
+require_once("../../config.php");
+require_once("locallib.php");
+require_once('link_form.php');
+
+$blog = required_param('blog', PARAM_INT);                          // Blog ID
+$bloginstancesid = optional_param('bloginstance', 0, PARAM_INT);     // Blog instances ID
+$linkid = optional_param('link', 0, PARAM_INT);                     // Comment ID for editing
+
+if ($blog) {
+    if (!$oublog = $DB->get_record("oublog", array("id"=>$blog))) {
+        print_error('invalidblog', 'oublog');
+    }
+    if (!$cm = get_coursemodule_from_instance('oublog', $blog)) {
+        print_error('invalidcoursemodule');
+    }
+    if (!$course = $DB->get_record("course", array("id"=>$oublog->course))) {
+        print_error('coursemisconf');
+    }
+}
+// TODO: If statement didn't look right! CC-Inline control structures not allowed.
+if ($linkid) {
+    if (!$link = $DB->get_record('oublog_links', array('id'=>$linkid))) {
+        $link = false;
+    }
+}
+
+$url = new moodle_url('/mod/oublog/editlink.php', array('blog'=>$blog, 'bloginstance'=>$bloginstancesid, 'link'=>$linkid));
+$PAGE->set_url($url);
+
+// Check security.
+$context = context_module::instance($cm->id);
+oublog_check_view_permissions($oublog, $context, $cm);
+
+if ($linkid) {
+    $bloginstancesid=$link->oubloginstancesid;
+}
+$oubloginstance = $bloginstancesid ? $DB->get_record('oublog_instances', array('id'=>$bloginstancesid)) : null;
+    oublog_require_userblog_permission('mod/oublog:managelinks', $oublog, $oubloginstance, $context);
+
+if ($oublog->global) {
+    $blogtype = 'personal';
+    $oubloguser = $USER;
+    $viewurl = 'view.php?user='.$oubloginstance->userid;
+} else {
+    $blogtype = 'course';
+    $viewurl = 'view.php?id='.$cm->id;
+}
+
+// Get strings.
+$stroublogs  = get_string('modulenameplural', 'oublog');
+$stroublog   = get_string('modulename', 'oublog');
+$straddlink  = get_string('addlink', 'oublog');
+$streditlink = get_string('editlink', 'oublog');
+
+$mform = new mod_oublog_link_form('editlink.php', array('edit' => !empty($linkid)));
+
+if ($mform->is_cancelled()) {
+    redirect($viewurl);
+    exit;
+}
+
+if (!$frmlink = $mform->get_data()) {
+
+    if (!isset($link)) {
+        $link = new stdClass;
+        $link->general = $straddlink;
+    } else {
+        $link->link = $link->id;
+    }
+
+    $link->blog = $blog;
+    $link->bloginstance = $bloginstancesid;
+
+    $mform->set_data($link);
+
+
+    // Print the header
+
+    if ($blogtype == 'personal') {
+        $PAGE->navbar->add(fullname($oubloguser), new moodle_url('/user/view.php', array('id'=>$oubloguser->id)));
+        $PAGE->navbar->add(format_string($oublog->name), new moodle_url('/mod/oublog/view.php', array('blog'=>$blog)));
+    } else {
+        $PAGE->navbar->add(($linkid ? $streditlink : $straddlink));
+    }
+    $PAGE->set_title(format_string($oublog->name));
+    $PAGE->set_heading(format_string($course->fullname));
+    echo $OUTPUT->header();
+
+    echo '<br />';
+    $mform->display();
+
+    echo $OUTPUT->footer();
+
+} else {
+    if ($frmlink->link) {
+        $frmlink->id = $frmlink->link;
+        $frmlink->oublogid = $oublog->id;
+
+        if (!oublog_edit_link($frmlink)) {
+            print_error('couldnotaddlink', 'oublog');
+        }
+
+    } else {
+        unset($frmlink->id);
+        $frmlink->oublogid = $oublog->id;
+        $frmlink->oubloginstancesid = $bloginstancesid;
+
+        if (!oublog_add_link($frmlink)) {
+            print_error('couldnotaddlink', 'oublog');
+        }
+    }
+
+    redirect($viewurl);
+}
diff --git a/mod/oublog/editpost.php b/mod/oublog/editpost.php
new file mode 100644
index 0000000..5c5a24a
--- /dev/null
+++ b/mod/oublog/editpost.php
@@ -0,0 +1,261 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+/**
+ * This page allows a user to add and edit blog posts
+ *
+ * @author Matt Clarkson <mattc@catalyst.net.nz>
+ * @author Sam Marshall <s.marshall@open.ac.uk>
+ * @package oublog
+ */
+
+require_once("../../config.php");
+require_once("locallib.php");
+require_once('post_form.php');
+
+$blog = required_param('blog', PARAM_INT);        // Blog ID.
+$postid = optional_param('post', 0, PARAM_INT);   // Post ID for editing.
+$referurl = optional_param('referurl', 0, PARAM_LOCALURL);
+
+if ($blog) {
+    if (!$oublog = $DB->get_record("oublog", array('id' => $blog))) {
+        print_error('invalidblog', 'oublog');
+    }
+    if (!$cm = get_coursemodule_from_instance('oublog', $blog)) {
+        print_error('invalidcoursemodule');
+    }
+    if (!$course = $DB->get_record("course", array('id' => $oublog->course))) {
+        print_error('coursemisconf');
+    }
+}
+if ($postid) {
+    if (!$post = $DB->get_record('oublog_posts', array('id' => $postid))) {
+        print_error('invalidpost', 'oublog');
+    }
+    if (!$oubloginstance = $DB->get_record('oublog_instances', array('id' => $post->oubloginstancesid))) {
+        print_error('invalidblog', 'oublog');
+    }
+}
+
+$url = new moodle_url('/mod/oublog/editpost.php', array('blog' => $blog, 'post' => $postid));
+$PAGE->set_url($url);
+
+// Check security.
+require_course_login($cm->course, true, $cm);
+$context = context_module::instance($cm->id);
+oublog_check_view_permissions($oublog, $context, $cm);
+
+$PAGE->requires->js_init_call('M.mod_oublog.init', null, true);
+
+if ($oublog->global) {
+    $blogtype = 'personal';
+
+    // New posts point to current user.
+    if (!isset($oubloginstance)) {
+        $oubloguser = $USER;
+        if (!$oubloginstance = $DB->get_record('oublog_instances', array('oublogid' => $oublog->id, 'userid' => $USER->id))) {
+            print_error('invalidblog', 'oublog');
+        }
+    } else {
+        $oubloguser = $DB->get_record('user', array('id' => $oubloginstance->userid));
+    }
+    $viewurl = new moodle_url('/mod/oublog/view.php', array('user' => $oubloguser->id));
+    if (isset($referurl) && $referurl != "" ) {
+        $viewurl = $referurl;
+    }
+} else {
+    $blogtype = 'course';
+    $viewurl = new moodle_url('/mod/oublog/view.php', array('id' => $cm->id));
+    if (isset($referurl) && $referurl != "" ) {
+        $viewurl = $referurl;
+    }
+}
+// If editing a post, must be your post or you have manageposts.
+$canmanage = has_capability('mod/oublog:manageposts', $context);
+if (isset($post) && $USER->id != $oubloginstance->userid && !$canmanage) {
+    print_error('accessdenied', 'oublog');
+}
+
+// Must be able to post in order to post OR edit a post. This is so that if
+// somebody is blocked from posting, they can't just edit an existing post.
+// Exception is that admin is allowed to edit posts even though they aren't
+// allowed to post to the blog.
+if (!(
+    oublog_can_post($oublog, isset($oubloginstance) ? $oubloginstance->userid : 0, $cm) ||
+    (isset($post) && $canmanage))) {
+    print_error('accessdenied', 'oublog');
+}
+
+// Get strings.
+$stroublogs  = get_string('modulenameplural', 'oublog');
+$stroublog   = get_string('modulename', 'oublog');
+$straddpost  = get_string('newpost', 'oublog', oublog_get_displayname($oublog));
+$streditpost = get_string('editpost', 'oublog');
+
+
+// Set-up groups.
+$currentgroup = oublog_get_activity_group($cm, true);
+$groupmode = oublog_get_activity_groupmode($cm, $course);
+if ($groupmode == VISIBLEGROUPS && !groups_is_member($currentgroup) && !$oublog->individual) {
+    require_capability('moodle/site:accessallgroups', $context);
+}
+// Setup tag list call.
+$curindividual = -1;
+$curgroup = false;
+if ($oublog->individual) {
+    $curindividual = isset($oubloginstance->userid) ? $oubloginstance->userid : $USER->id;
+} else {
+    $curgroup = isset($post->groupid) ? $post->groupid : $currentgroup;
+}
+// Moved call to oublog_get_tag_list() here.
+$tags = oublog_get_tag_list($oublog, $curgroup, $cm,
+        $oublog->global ? $oubloginstance->id : null, $curindividual);
+$mform = new mod_oublog_post_form('editpost.php', array(
+    'individual' => $oublog->individual,
+    'maxvisibility' => $oublog->maxvisibility,
+    'allowcomments' => $oublog->allowcomments,
+    'edit' => !empty($postid),
+    'personal' => $oublog->global,
+    'maxbytes' => $oublog->maxbytes,
+    'maxattachments' => $oublog->maxattachments,
+    'restricttags' => $oublog->restricttags,
+    'availtags' => $tags,
+    'referurl' => $referurl));
+if ($mform->is_cancelled()) {
+    redirect($viewurl);
+    exit;
+}
+
+
+if (!$frmpost = $mform->get_data()) {
+
+    if ($postid) {
+        $post->post  = $post->id;
+        $post->general = $streditpost;
+        $post->tags = oublog_get_tags_csv($post->id);
+        // Add a trailing comma for autocompletion support.
+        if (!empty($post->tags)) {
+            $post->tags .= ', ';
+        }
+    } else {
+        $post = new stdClass;
+        $post->general = $straddpost;
+    }
+
+    $post->blog = $oublog->id;
+
+    $draftitemid = file_get_submitted_draft_itemid('attachments');
+    file_prepare_draft_area($draftitemid, $context->id, 'mod_oublog', 'attachment',
+            empty($post->id) ? null : $post->id);
+
+    $draftideditor = file_get_submitted_draft_itemid('message');
+    $currenttext = file_prepare_draft_area($draftideditor, $context->id, 'mod_oublog',
+            'message', empty($post->id) ? null : $post->id,
+            array('subdirs' => 0), empty($post->message) ? '' : $post->message);
+
+    $post->attachments = $draftitemid;
+    $post->message = array('text' => $currenttext,
+            'format' => empty($post->messageformat) ? editors_get_preferred_format() : $post->messageformat,
+            'itemid' => $draftideditor);
+
+    $mform->set_data($post);
+
+    // Print the header.
+
+    if ($blogtype == 'personal') {
+        $PAGE->navbar->add(fullname($oubloguser), new moodle_url('/user/view.php', array('id' => $oubloguser->id)));
+        $PAGE->navbar->add(format_string($oubloginstance->name), $viewurl);
+    }
+    $PAGE->navbar->add($post->general);
+    $PAGE->set_title(format_string($oublog->name));
+    $PAGE->set_heading(format_string($course->fullname));
+    $renderer = $PAGE->get_renderer('mod_oublog');
+    $renderer->pre_display($cm, $oublog, 'editpost');
+    echo $OUTPUT->header();
+    echo $renderer->render_header($cm, $oublog, 'editpost');
+    echo $renderer->render_pre_postform($oublog, $cm);
+    $mform->display();
+    // Add tagselector yui mod - autocomplete of tags.
+    $PAGE->requires->yui_module('moodle-mod_oublog-tagselector', 'M.mod_oublog.tagselector.init',
+            array('id_tags', $tags));
+    $PAGE->requires->string_for_js('numposts', 'oublog');
+
+    // Check the network connection on exiting the update page.
+    $PAGE->requires->strings_for_js(array('savefailtitle', 'savefailnetwork'), 'oublog');
+    $PAGE->requires->yui_module('moodle-mod_oublog-savecheck', 'M.mod_oublog.savecheck.init', array($context->id));
+
+    echo $OUTPUT->footer();
+
+} else {
+
+    $post = $frmpost;
+    // Handle form submission.
+    if (!empty($post->post)) {
+        // Update the post.
+        $post->id = $post->post;
+        $post->oublogid = $oublog->id;
+        $post->userid = $oubloginstance->userid;
+
+        oublog_edit_post($post, $cm);
+
+        // Log post edited event.
+        $params = array(
+                'context' => $context,
+                'objectid' => $post->id,
+                'other' => array(
+                    'oublogid' => $oublog->id
+            )
+        );
+
+        $event = \mod_oublog\event\post_updated::create($params);
+        $event->trigger();
+
+        redirect($viewurl);
+
+    } else {
+        // Insert the post.
+        unset($post->id);
+        $post->oublogid = $oublog->id;
+        $post->userid = $USER->id;
+
+        // Consider groups only when it is not an individual blog.
+        if ($oublog->individual) {
+            $post->groupid = 0;
+        } else {
+            if (!$currentgroup && $groupmode) {
+                print_error('notaddpostnogroup', 'oublog');
+            }
+            $post->groupid = $currentgroup;
+        }
+
+        if (!oublog_add_post($post, $cm, $oublog, $course)) {
+            print_error('notaddpost', 'oublog');
+        }
+
+        // Log add post event.
+        $params = array(
+                'context' => $context,
+                'objectid' => $post->id,
+                'other' => array(
+                    'oublogid' => $oublog->id
+            )
+        );
+        $event = \mod_oublog\event\post_created::create($params);
+        $event->trigger();
+
+        redirect($viewurl);
+    }
+
+}
diff --git a/mod/oublog/externallib.php b/mod/oublog/externallib.php
new file mode 100644
index 0000000..71f6199
--- /dev/null
+++ b/mod/oublog/externallib.php
@@ -0,0 +1,309 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * External oublog API.
+ * Used for importing posts from another server.
+ *
+ * @package mod
+ * @subpackage oublog
+ * @copyright 2013 The Open University
+ * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+require_once("$CFG->libdir/externallib.php");
+require_once("$CFG->dirroot/mod/oublog/locallib.php");
+
+class mod_oublog_external extends external_api {
+
+    public static function get_user_blogs_parameters() {
+        return new external_function_parameters(array(
+                'username' => new external_value(PARAM_USERNAME, 'User username')
+                ));
+    }
+
+    /**
+     * Return all blogs on the system for the user
+     * @param string $username
+     */
+    public static function get_user_blogs($username) {
+        global $DB, $remoteuserid;
+        $username = self::validate_parameters(self::get_user_blogs_parameters(),
+                array('username' => $username));
+        $user = $DB->get_field('user', 'id', array('username' => $username['username']), IGNORE_MISSING);
+        if (!$user) {
+            return array();
+        }
+        $remoteuserid = $user;
+        $result = oublog_import_getblogs($user);
+        // Add remote property to each blog to identify that it came from web service.
+        foreach ($result as &$blog) {
+            $blog->remote = true;
+        }
+        return $result;
+    }
+
+    public static function get_user_blogs_returns() {
+        return new external_multiple_structure(
+                new external_single_structure(
+                        array(
+                                'cmid' => new external_value(PARAM_INT, 'blog course module id'),
+                                'coursename' => new external_value(PARAM_TEXT, 'course name text'),
+                                'numposts' => new external_value(PARAM_INT, 'number of posts in blog'),
+                                'name' => new external_value(PARAM_TEXT, 'activity name text'),
+                                'remote' => new external_value(PARAM_BOOL, 'identifies activity is remote'),
+                        )
+                    )
+                );
+    }
+
+    public static function get_blog_info_parameters() {
+        return new external_function_parameters(
+                array(
+                        'cmid' => new external_value(PARAM_INT, 'Blog cm id'),
+                        'username' => new external_value(PARAM_USERNAME, 'User username'),
+                )
+        );
+    }
+
+    public static function get_blog_info($cmid, $username) {
+        global $DB, $remoteuserid;
+        $params = self::validate_parameters(self::get_blog_info_parameters(),
+                array('cmid' => $cmid, 'username' => $username));
+        $user = $DB->get_field('user', 'id', array('username' => $params['username']), IGNORE_MISSING);
+        if (!$user) {
+            return array();
+        }
+        $remoteuserid = $user;
+        $result = oublog_import_getbloginfo($params['cmid'], $user);
+        return array(
+                'bcmid' => $result[0],
+                'boublogid' => $result[1],
+                'bcontextid' => $result[2],
+                'boublogname' => $result[3],
+                'bcoursename' => $result[4],
+                );
+    }
+
+    public static function get_blog_info_returns() {
+        return new external_single_structure(
+                array(
+                        'bcmid' => new external_value(PARAM_INT, 'Blog cm id'),
+                        'boublogid' => new external_value(PARAM_INT, 'Blog id'),
+                        'bcontextid' => new external_value(PARAM_INT, 'Blog context id'),
+                        'boublogname' => new external_value(PARAM_TEXT, 'Blog name'),
+                        'bcoursename' => new external_value(PARAM_TEXT, 'Course short name'),
+                        ));
+    }
+
+    public static function get_blog_allposts_parameters() {
+        return new external_function_parameters(
+                array(
+                        'blogid' => new external_value(PARAM_INT, 'Blog id'),
+                        'sort' => new external_value(PARAM_TEXT, 'sort sql'),
+                        'username' => new external_value(PARAM_USERNAME, 'User username'),
+                        'page' => new external_value(PARAM_INT, 'results page', VALUE_DEFAULT, 0),
+                        'tags' => new external_value(PARAM_SEQUENCE, 'tags to filter by', VALUE_DEFAULT, null),
+                )
+        );
+    }
+
+    /**
+     * Gets all user posts from blog, filtered by page and tags
+     * @param int $blogid
+     * @param string $sort
+     * @param string $username
+     * @param int $page
+     * @param string $tags comma separated sequence of selected tag ids to filter by
+     * @return array
+     */
+    public static function get_blog_allposts($blogid, $sort, $username, $page = 0, $tags = null) {
+        global $DB;
+        $params = self::validate_parameters(self::get_blog_allposts_parameters(),
+                array('blogid' => $blogid, 'sort' => $sort, 'username' => $username,
+                        'page' => $page, 'tags' => $tags));
+        $user = $DB->get_field('user', 'id', array('username' => $params['username']), IGNORE_MISSING);
+        if (!$user) {
+            return array();
+        }
+        $result = oublog_import_getallposts($params['blogid'], $params['sort'], $user,
+                $params['page'], $params['tags']);
+        if (!is_array($result[2])) {
+            $result[2] = array();
+        }
+        foreach ($result[0] as &$post) {
+            if (isset($post->tags)) {
+                $tagupdate = array();
+                // Update post tags into a format that Moodle WS can work with.
+                foreach ($post->tags as $id => $tag) {
+                    $tagupdate[] = (object) array('id' => $id, 'tag' => $tag);
+                }
+                $post->tags = $tagupdate;
+            }
+        }
+        return array('posts' => $result[0], 'total' => $result[1], 'tagnames' => $result[2]);
+    }
+
+    public static function get_blog_allposts_returns() {
+        return new external_single_structure(array(
+                'posts' => new external_multiple_structure(new external_single_structure(array(
+                        'id' => new external_value(PARAM_INT, 'post id'),
+                        'title' => new external_value(PARAM_TEXT, 'title'),
+                        'timeposted' => new external_value(PARAM_INT, 'created'),
+                        'tags' => new external_multiple_structure(new external_single_structure(array(
+                                'id' => new external_value(PARAM_INT, 'tag id'),
+                                'tag' => new external_value(PARAM_TEXT, 'tag value'))
+                                ), 'tags', VALUE_OPTIONAL),
+                        ))),
+                'total' => new external_value(PARAM_INT, 'total user posts in blog'),
+                'tagnames' => new external_multiple_structure(
+                        new external_single_structure(array(
+                                'id' => new external_value(PARAM_INT, 'tag id'),
+                                'tag' => new external_value(PARAM_TEXT, 'tag value'),
+                                )), 'tags', VALUE_OPTIONAL)
+                ));
+    }
+
+    public static function get_blog_posts_parameters() {
+        return new external_function_parameters(
+                array(
+                        'blogid' => new external_value(PARAM_INT, 'Blog id'),
+                        'bcontextid' => new external_value(PARAM_INT, 'Blog module context id'),
+                        'selected' => new external_value(PARAM_SEQUENCE, 'post ids'),
+                        'inccomments' => new external_value(PARAM_BOOL, 'include comments',
+                                VALUE_DEFAULT, false),
+                        'username' => new external_value(PARAM_USERNAME, 'User username'),
+                )
+        );
+    }
+
+    /**
+     * Get selected blog posts from blog
+     * @param int $blogid
+     * @param string $selected comma separated sequence of selected post ids to filter by
+     * @param bool $inccomments - blog uses comments or not
+     * @param string $username - used to ensure user posts only
+     * @return array of posts
+     */
+    public static function get_blog_posts($blogid, $bcontextid, $selected, $inccomments = false, $username) {
+        global $DB;
+        $params = self::validate_parameters(self::get_blog_posts_parameters(),
+                array('blogid' => $blogid, 'bcontextid' => $bcontextid, 'selected' => $selected,
+                        'inccomments' => $inccomments, 'username' => $username));
+        $user = $DB->get_field('user', 'id', array('username' => $username), IGNORE_MISSING);
+        if (!$user) {
+            return array();
+        }
+        $selected = explode(',', $params['selected']);
+        if ($selected[0] == 0) {
+            $return = oublog_import_getposts($params['blogid'], $params['bcontextid'],
+                $selected, $params['inccomments'], $user, true);
+        } else {
+            $return = oublog_import_getposts($params['blogid'], $params['bcontextid'],
+                $selected, $params['inccomments'], $user);
+        }
+        // Convert file objects into a custom known object to send.
+        foreach ($return as &$post) {
+            foreach ($post->images as &$file) {
+                $file = (object) array(
+                        'contextid' => $file->get_contextid(),
+                        'filearea' => $file->get_filearea(),
+                        'filepath' => $file->get_filepath(),
+                        'filename' => $file->get_filename(),
+                        'itemid' => $file->get_itemid()
+                        );
+            }
+            foreach ($post->attachments as &$file) {
+                $file = (object) array(
+                        'contextid' => $file->get_contextid(),
+                        'filearea' => $file->get_filearea(),
+                        'filepath' => $file->get_filepath(),
+                        'filename' => $file->get_filename(),
+                        'itemid' => $file->get_itemid()
+                );
+            }
+            foreach ($post->comments as &$comment) {
+                foreach ($comment->images as &$file) {
+                    $file = (object) array(
+                            'contextid' => $file->get_contextid(),
+                            'filearea' => $file->get_filearea(),
+                            'filepath' => $file->get_filepath(),
+                            'filename' => $file->get_filename(),
+                            'itemid' => $file->get_itemid()
+                    );
+                }
+            }
+        }
+        return $return;
+    }
+
+    public static function get_blog_posts_returns() {
+        return new external_multiple_structure(new external_single_structure(array(
+                'id' => new external_value(PARAM_INT, 'post id'),
+                'oubloginstancesid' => new external_value(PARAM_INT, 'instance id'),
+                'groupid' => new external_value(PARAM_INT, 'group id'),
+                'title' => new external_value(PARAM_TEXT, 'title'),
+                'message' => new external_value(PARAM_RAW, 'message'),
+                'timeposted' => new external_value(PARAM_INT, 'created'),
+                'allowcomments' => new external_value(PARAM_INT, 'comments allowed'),
+                'timeupdated' => new external_value(PARAM_INT, 'updated'),
+                'deletedby' => new external_value(PARAM_INT, 'deleted by'),
+                'timedeleted' => new external_value(PARAM_INT, 'deleted'),
+                'visibility' => new external_value(PARAM_INT, 'visibility'),
+                'lasteditedby' => new external_value(PARAM_INT, 'edited by'),
+                'tags' => new external_multiple_structure(new external_single_structure(array(
+                        'id' => new external_value(PARAM_INT, 'tag id'),
+                        'tag' => new external_value(PARAM_TEXT, 'tag value'),
+                        'postid' => new external_value(PARAM_INT, 'tag post id'),
+                        )), 'tags', VALUE_OPTIONAL),
+                'images' => new external_multiple_structure(new external_single_structure(array(
+                        'contextid' => new external_value(PARAM_INT, 'context id'),
+                        'filearea' => new external_value(PARAM_AREA, 'filearea'),
+                        'filepath' => new external_value(PARAM_PATH, 'path'),
+                        'filename' => new external_value(PARAM_FILE, 'filename'),
+                        'itemid' => new external_value(PARAM_INT, 'item id'),
+                        )), 'images', VALUE_OPTIONAL),
+                'attachments' => new external_multiple_structure(new external_single_structure(array(
+                        'contextid' => new external_value(PARAM_INT, 'context id'),
+                        'filearea' => new external_value(PARAM_AREA, 'filearea'),
+                        'filepath' => new external_value(PARAM_PATH, 'filepath'),
+                        'filename' => new external_value(PARAM_FILE, 'filename'),
+                        'itemid' => new external_value(PARAM_INT, 'item id'),
+                )), 'attachments', VALUE_OPTIONAL),
+                'comments' => new external_multiple_structure(
+                        new external_single_structure(array(
+                                'id' => new external_value(PARAM_INT, 'id'),
+                                'postid' => new external_value(PARAM_INT, 'post id'),
+                                'userid' => new external_value(PARAM_INT, 'user id'),
+                                'title' => new external_value(PARAM_TEXT, 'title'),
+                                'message' => new external_value(PARAM_RAW, 'message'),
+                                'timeposted' => new external_value(PARAM_INT, 'posted'),
+                                'deletedby' => new external_value(PARAM_INT, 'deleted by'),
+                                'timedeleted' => new external_value(PARAM_INT, 'deleted'),
+                                'authorname' => new external_value(PARAM_INT, 'ex author'),
+                                'authorip' => new external_value(PARAM_INT, 'ex author ip'),
+                                'timeapproved' => new external_value(PARAM_INT, 'approved'),
+                                'images' => new external_multiple_structure(new external_single_structure(array(
+                                        'contextid' => new external_value(PARAM_INT, 'context id'),
+                                        'filearea' => new external_value(PARAM_AREA, 'filearea'),
+                                        'filepath' => new external_value(PARAM_PATH, 'path'),
+                                        'filename' => new external_value(PARAM_FILE, 'filename'),
+                                        'itemid' => new external_value(PARAM_INT, 'item id'),
+                                )), 'images', VALUE_OPTIONAL),
+                                )), 'comments', VALUE_OPTIONAL)
+                )));
+    }
+}
diff --git a/mod/oublog/feed.php b/mod/oublog/feed.php
new file mode 100644
index 0000000..e94c915
--- /dev/null
+++ b/mod/oublog/feed.php
@@ -0,0 +1,211 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+/**
+ * This page generates blog RSS and ATOM feeds
+ *
+ * @author Matt Clarkson <mattc@catalyst.net.nz>
+ * @package oublog
+ */
+require_once("../../config.php");
+require_once("locallib.php");
+require_once($CFG->libdir.'/rsslib.php');
+require_once('atomlib.php');
+
+$format             = required_param('format', PARAM_TEXT);
+$blogid             = optional_param('blog', 0, PARAM_INT);
+$bloginstancesid    = optional_param('bloginstance', 0, PARAM_INT);
+$comments           = optional_param('comments', 0, PARAM_INT);
+$postid             = optional_param('post', 0, PARAM_INT);
+$loggedin           = optional_param('loggedin', '', PARAM_TEXT);
+$full               = optional_param('full', '', PARAM_TEXT);
+$viewer             = optional_param('viewer', 0, PARAM_INT);
+$groupid            = optional_param('group', 0, PARAM_INT);
+$individualid       = optional_param('individual', 0, PARAM_INT);
+
+$url = new moodle_url('/mod/oublog/feed.php', array('format'=>$format, 'blog'=>$blogid,
+        'bloginstance'=>$bloginstancesid, 'post'=>$postid));
+$PAGE->set_url($url);
+$PAGE->set_context(context_system::instance());
+// Validate Parameters.
+$format = strtolower($format);
+
+if (empty($CFG->enablerssfeeds)) {
+    print_error('feedsnotenabled', 'oublog');
+}
+if ($format != 'atom' && $format != 'rss') {
+    print_error('invalidformat', 'oublog');
+}
+if (!$blogid && !$bloginstancesid && !$postid) {
+    print_error('missingrequiredfield');
+}
+if (($loggedin || $full) && !$viewer) {
+    print_error('missingrequiredfield');
+}
+if ($groupid && !$viewer) {
+    print_error('missingrequiredfield');
+}
+
+if (isset($bloginstancesid) && $bloginstancesid!='all') {
+    $bloginstance = $DB->get_record('oublog_instances', array('id'=>$bloginstancesid));
+    $blog         = $DB->get_record('oublog', array('id'=>$bloginstance->oublogid));
+} else if ($blogid) {
+    $blog = $DB->get_record('oublog', array('id'=>$blogid));
+
+} else if ($postid) {
+    $post         = $DB->get_record('oublog_posts', array('id'=>$postid));
+    $bloginstance = $DB->get_record('oublog_instances', array('id'=>$post->oubloginstancesid));
+    $blog         = $DB->get_record('oublog', array('id'=>$bloginstance->oublogid));
+}
+if (!isset($blog->id) || !$cm = get_coursemodule_from_instance('oublog', $blog->id)) {
+    print_error('invalidcoursemodule');
+}
+
+// Work out link for ordinary web page equivalent to requested feed
+if ($blog->global) {
+    if ($bloginstancesid == 'all') {
+        $url = $CFG->wwwroot . '/mod/oublog/allposts.php';
+    } else {
+        $url = $CFG->wwwroot . '/mod/oublog/view.php?user=' .
+            $bloginstance->userid;
+    }
+    $groupmode = 0;
+} else {
+    $url = $CFG->wwwroot . '/mod/oublog/view.php?id=' . $cm->id .
+        ($groupid ? '&group=' . $groupid : '') .
+        ($individualid ? '&individual=' . $individualid : '');
+    if (!($course = $DB->get_record('course', array('id'=>$cm->course)))) {
+        print_error('coursemisconf');
+    }
+    $groupmode = oublog_get_activity_groupmode($cm, $course);
+}
+
+// Check browser compatibility.
+if (core_useragent::check_browser_version('MSIE', 0) || core_useragent::check_browser_version('Firefox', 0)) {
+    if (!core_useragent::check_browser_version('MSIE', '7') && !core_useragent::check_browser_version('Firefox', '2')) {
+        if ($blog->global) {
+            $url='view.php?user='.$bloginstance->userid;
+        } else {
+            $url='view.php?id='.$cm->id.($groupid ? '&group='.$groupid : '');
+        }
+        print_error('unsupportedbrowser', 'oublog', $url);
+    }
+}
+// Determine if feed has changed since the if-modified-since HTTP header and exit if it hasn't.
+// Override default Moodle behaviour which prevents all caching (ouch).
+header('Cache-Control:');
+header('Pragma: ');
+header('Expires: ');
+if ($mtime = oublog_feed_last_changed($blogid, $bloginstancesid, $postid, $comments)) {
+    $mtimegm = gmdate('D, d M Y H:i:s', $mtime) . ' GMT';
+    header("Last-Modified: $mtimegm");
+}
+if ($mtime && isset($_SERVER['HTTP_IF_MODIFIED_SINCE'])) {
+    $iftime = strtotime(preg_replace('/;.*$/', '',
+        $_SERVER['HTTP_IF_MODIFIED_SINCE']));
+    if ($mtime <= $iftime) {
+        header("HTTP/1.0 304 Not Modified");
+        exit;
+    }
+}
+
+if ($blog->global && $bloginstancesid != 'all') {
+    $accesstoken = $bloginstance->accesstoken;
+} else {
+    $accesstoken = $blog->accesstoken;
+}
+
+if ($full) {
+    // We had an issue where the system leaked 'full' view tokens to users
+    // who should not get them. To resolve this, I changed the view tokens
+    // to use 'v2' in the hash
+    if ($full == md5($accesstoken.$viewer.OUBLOG_VISIBILITY_COURSEUSER.'v2') && $user =
+            $DB->get_record('user', array('id'=>$viewer))) {
+        $allowedvisibility = OUBLOG_VISIBILITY_COURSEUSER;
+    } else if ($full == md5($accesstoken.$viewer.OUBLOG_VISIBILITY_COURSEUSER) && $user =
+            $DB->get_record('user', array('id'=>$viewer))) {
+        // This is the old token. Ooops. We know that at least users were
+        // logged in, so they get that version...
+        $allowedvisibility = OUBLOG_VISIBILITY_LOGGEDINUSER;
+        if (!$blog->global) {
+            // For course blogs, security was actually correct, so let's
+            // keep allowing them to read the whole blog
+            $allowedvisibility = OUBLOG_VISIBILITY_COURSEUSER;
+        }
+    } else {
+        print_error('nopermissiontoshow');
+    }
+} else if ($loggedin) {
+    if ($loggedin == md5($accesstoken.$viewer.OUBLOG_VISIBILITY_LOGGEDINUSER) && $user =
+            $DB->get_record('user', array('id'=>$viewer))) {
+        $allowedvisibility = OUBLOG_VISIBILITY_LOGGEDINUSER;
+    } else {
+        print_error('nopermissiontoshow');
+    }
+} else {
+    $allowedvisibility = OUBLOG_VISIBILITY_PUBLIC;
+    $user = $USER;
+}
+
+// Check individual
+if ($blog->individual) {
+    if (!oublog_individual_has_permissions($cm, $blog, $groupid, $individualid, $user->id)) {
+         print_error('nopermissiontoshow');
+    }
+}
+// Check separate groups
+if ($groupmode == SEPARATEGROUPS) {
+    // If you are a member of the group and viewing a specified group then
+    // you are OK
+    if ($groupid && groups_is_member($groupid, $user->id)) {
+        // Group members are OK
+    } else {
+        // Must have access all groups
+        require_capability('moodle/site:accessallgroups',
+                context_module::instance($cm->id), $user->id);
+    }
+}
+
+// Get data for feed in a standard form.
+if ($comments) {
+    $feeddata = oublog_get_feed_comments($blogid, $bloginstancesid, $postid, $user,
+            $allowedvisibility, $groupid, $cm, $blog, $individualid);
+    $feedname = strip_tags($blog->name) . ': ' . get_string('commentsfeed', 'oublog');
+    $feedsummary='';
+} else {
+    $feeddata = oublog_get_feed_posts($blogid,
+        isset($bloginstance) ? $bloginstance : null, $user,
+        $allowedvisibility, $groupid, $cm, $blog, $individualid);
+    $feedname=strip_tags($blog->name);
+    if ($bloginstancesid=='all') {
+        $feedsummary=strip_tags($blog->intro);
+    } else {
+        $feedsummary=strip_tags($bloginstance->summary);
+    }
+}
+
+// Generate feed in RSS or ATOM format.
+if ($format == 'rss') {
+    header('Content-type: application/rss+xml');
+    echo rss_standard_header($feedname, $url, $feedsummary);
+    echo rss_add_items($feeddata);
+    echo rss_standard_footer();
+} else {
+    header('Content-type: application/atom+xml');
+    $updated=count($feeddata)==0 ? time() : reset($feeddata)->pubdate;
+    echo atom_standard_header($FULLME, $FULLME, $updated, $feedname, $feedsummary);
+    echo atom_add_items($feeddata);
+    echo atom_standard_footer();
+}
diff --git a/mod/oublog/import.php b/mod/oublog/import.php
new file mode 100644
index 0000000..c8d1f61
--- /dev/null
+++ b/mod/oublog/import.php
@@ -0,0 +1,550 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Import pages into the current blog
+ * Supports imports from Individual blog to Individual blog (same user)
+ *
+ * @package    mod
+ * @subpackage oublog
+ * @copyright  2013 The open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+require_once(dirname(__FILE__) . '/../../config.php');
+require_once($CFG->dirroot . '/mod/oublog/locallib.php');
+
+$id = required_param('id', PARAM_INT);// Blog cm ID.
+
+// Load efficiently (and with full $cm data) using get_fast_modinfo.
+$course = $DB->get_record_select('course',
+            'id = (SELECT course FROM {course_modules} WHERE id = ?)', array($id),
+            '*', MUST_EXIST);
+$modinfo = get_fast_modinfo($course);
+$cm = $modinfo->get_cm($id);
+if ($cm->modname !== 'oublog') {
+    print_error('invalidcoursemodule');
+}
+
+if (!$oublog = $DB->get_record('oublog', array('id' => $cm->instance))) {
+    print_error('invalidcoursemodule');
+}
+
+$context = context_module::instance($cm->id);
+$tempoublog = clone $oublog;
+if ($tempoublog->global) {
+    $tempoublog->maxvisibility = OUBLOG_VISIBILITY_LOGGEDINUSER;// Force login regardless of setting.
+} else {
+    $tempoublog->maxvisibility = OUBLOG_VISIBILITY_COURSEUSER;// Force login regardless of setting.
+}
+oublog_check_view_permissions($tempoublog, $context, $cm);
+$blogname = oublog_get_displayname($oublog);
+
+// Is able to import check for current blog.
+if (!$oublog->allowimport ||
+        (!$oublog->global && $oublog->individual == OUBLOG_NO_INDIVIDUAL_BLOGS)) {
+    // Must have import enabled. Individual blog mode only.
+    print_error('import_notallowed', 'oublog', null, $blogname);
+}
+// Check if group mode set - need to check user is in selected group etc.
+$groupmode = oublog_get_activity_groupmode($cm, $course);
+$currentgroup = 0;
+if ($groupmode != NOGROUPS) {
+    $currentgroup = oublog_get_activity_group($cm);
+    $ingroup = groups_is_member($currentgroup);
+    if ($oublog->individual != OUBLOG_NO_INDIVIDUAL_BLOGS && ($currentgroup && !$ingroup)) {
+        // Must be group memeber for individual blog with group mode on.
+        print_error('import_notallowed', 'oublog', null, $blogname);
+    }
+}
+
+$step = optional_param('step', 0, PARAM_INT);
+if (optional_param('cancel', '', PARAM_ALPHA) == get_string('cancel')) {
+    $step -= 2;// Go back 2 steps if cancel.
+}
+$oublogoutput = $PAGE->get_renderer('mod_oublog');
+
+// Page header.
+$params = array('id' => $id);
+$PAGE->set_url('/mod/oublog/import.php', $params);
+$errlink = new moodle_url('/mod/oublog/import.php', $params);
+$PAGE->set_title(get_string('import', 'oublog'));
+$PAGE->navbar->add(get_string('import', 'oublog'));
+echo $OUTPUT->header();
+echo $OUTPUT->heading(get_string('import', 'oublog'));
+
+echo html_writer::start_div('oublog_import_step oublog_import_step' . $step);
+
+if ($step == 0) {
+    // Show list of oublog activities user has access to import from.
+    echo html_writer::tag('p', get_string('import_step0_inst', 'oublog'));
+    $curcourse = -1;
+    $blogs = oublog_import_getblogs($USER->id, $cm->id);
+    try {
+        if ($remoteblogs = oublog_import_remote_call('mod_oublog_get_user_blogs',
+                array('username' => $USER->username))) {
+            $blogs = array_merge($remoteblogs, $blogs);
+        }
+    } catch (moodle_exception $e) {
+        // Ignore fail when contacting external server, keep message for debugging.
+        debugging($e->getMessage());
+    }
+    // Sort coursename in alphabetical order.
+    usort($blogs, function($a, $b)
+    {
+        return strcasecmp($a->coursename, $b->coursename);
+    });
+    $personalblogout = '';
+    $blogout = '';
+    foreach ($blogs as $bloginfo) {
+        if ($bloginfo->coursename != '' && $curcourse != $bloginfo->coursename) {
+            if ($curcourse != -1) {
+                $blogout .= html_writer::end_tag('ul');
+            }
+            $blogout .= $OUTPUT->heading($bloginfo->coursename, 3);
+            $blogout .= html_writer::start_tag('ul');
+            $curcourse = $bloginfo->coursename;
+        }
+        // Use this activity icon for all blogs (in case from another server).
+        $img = html_writer::empty_tag('img', array('src' => $cm->get_icon_url($oublogoutput),
+                'alt' => ''));
+        $bloglink = '';
+        if ($bloginfo->numposts) {
+            $url = new moodle_url('/mod/oublog/import.php', $params + array('step' => 1, 'bid' => $bloginfo->cmid));
+            $urlimportblog = new moodle_url('/mod/oublog/import.php',
+                $params + array('step' => 2, 'bid' => $bloginfo->cmid, 'importall' => 'true', 'sesskey' => sesskey()));
+            if (isset($bloginfo->remote)) {
+                $url->param('remote', true);
+                $urlimportblog->param('remote', true);
+            }
+            $linkimportselectedposts = html_writer::link($url, get_string('import_step0_selected_posts', 'oublog'),
+                    array('class' => 'oublog_link_import_selectedposts'));
+            $linkimportblog = html_writer::link($urlimportblog, get_string('import_step0_blog', 'oublog'),
+                    array('class' => 'oublog_link_import_blog'));
+            $bloglink = html_writer::tag('li', $img . ' ' . $bloginfo->name . ' ' .
+                    get_string('import_step0_numposts', 'oublog', $bloginfo->numposts) . ' ' .
+                $linkimportselectedposts . ' ' . $linkimportblog);
+        } else {
+            $bloglink = html_writer::tag('li', $img . ' ' . $bloginfo->name . ' ' .
+                    get_string('import_step0_numposts', 'oublog', 0));
+        }
+        if ($bloginfo->coursename != '') {
+            $blogout .= $bloglink;
+        } else {
+            $personalblogout .= $bloglink;
+        }
+    }
+    if ($personalblogout != '') {
+        echo html_writer::tag('ul', $personalblogout);
+    }
+    echo $blogout;
+    if ($curcourse != -1) {
+        echo html_writer::end_tag('ul');
+    }
+    if (empty($blogs)) {
+        echo $OUTPUT->error_text(get_string('import_step0_nonefound', 'oublog'));
+    }
+} else if ($step == 1) {
+    // Get available posts, first get selected blog info + check access.
+    $bid = required_param('bid', PARAM_INT);
+    $stepinfo = array('step' => 1, 'bid' => $bid);
+    if ($remote = optional_param('remote', false, PARAM_BOOL)) {
+        $stepinfo['remote'] = true;
+        // Blog on remote server, use WS to get info.
+        if (!$result = oublog_import_remote_call('mod_oublog_get_blog_info',
+                array('username' => $USER->username, 'cmid' => $bid))) {
+            throw new moodle_exception('invalidcoursemodule', 'error');
+        }
+        $boublogid = $result->boublogid;
+        $bcontextid = $result->bcontextid;
+        $boublogname = $result->boublogname;
+        $bcoursename = $result->bcoursename;
+    } else {
+        list($bid, $boublogid, $bcontextid, $boublogname, $bcoursename) = oublog_import_getbloginfo($bid);
+    }
+    echo html_writer::start_tag('p', array('class' => 'oublog_import_step1_from'));
+    echo get_string('import_step1_from', 'oublog') . '<br />' . html_writer::tag('span', $boublogname);
+    echo html_writer::end_tag('p');
+    // Setup table early so sort can be determined (needs setup to be called first).
+    $table = new flexible_table($cm->id * $bid);
+    $url = new moodle_url('/mod/oublog/import.php', $params + $stepinfo);
+    $table->define_baseurl($url);
+    $table->define_columns(array('title', 'timeposted', 'tags', 'include'));
+    $table->column_style('include', 'text-align', 'center');
+    $table->sortable(true, 'timeposted', SORT_DESC);
+    $table->maxsortkeys = 1;
+    $table->no_sorting('tags');
+    $table->no_sorting('include');
+    $table->setup();
+    $sort = flexible_table::get_sort_for_table($cm->id * $bid);
+    if (empty($sort)) {
+        $sort = 'timeposted DESC';
+    }
+    if ($tags = optional_param('tags', null, PARAM_SEQUENCE)) {
+        // Filter by joining tag instances.
+        $stepinfo['tags'] = $tags;
+    }
+    $perpage = 100;// Must match value in oublog_import_getallposts.
+    $page = optional_param('page', 0, PARAM_INT);
+    $stepinfo['page'] = $page;
+    $preselected = optional_param('preselected', '', PARAM_SEQUENCE);
+    $stepinfo['preselected'] = $preselected;
+    $preselected = array_filter(array_unique(explode(',', $preselected)));
+    if ($remote) {
+        $result = oublog_import_remote_call('mod_oublog_get_blog_allposts', array(
+                'blogid' => $boublogid, 'username' => $USER->username, 'sort' => $sort,
+                'page' => $page, 'tags' => $tags));
+        $posts = $result->posts;
+        $total = $result->total;
+        $tagnames = $result->tagnames;
+        // Fix up post tags to required format as passed differently from WS.
+        foreach ($posts as &$post) {
+            if (isset($post->tags)) {
+                $newtagarr = array();
+                foreach ($post->tags as $tag) {
+                    $newtagarr[$tag->id] = $tag->tag;
+                }
+                $post->tags = $newtagarr;
+            }
+        }
+    } else {
+        list($posts, $total, $tagnames) = oublog_import_getallposts($boublogid, $sort, $USER->id,
+                $page, $tags);
+    }
+    if ($posts) {
+        // Finish seting up table vars.
+        $url = new moodle_url('/mod/oublog/import.php', $params + $stepinfo);
+        $table->define_baseurl($url);
+        $perpage = $total < $perpage ? $total : $perpage;
+        $table->pagesize($perpage, $total);
+        $taghead = get_string('import_step1_table_tags', 'oublog');
+        if (!empty($tagnames)) {
+            // Add tag filter removal links.
+            $taghead .= '<br />';
+            foreach ($tagnames as $tagid => $tag) {
+                $tagaarcopy = explode(',', $tags);
+                unset($tagaarcopy[array_search($tagid, $tagaarcopy)]);
+                $turl = new moodle_url('/mod/oublog/import.php',
+                        array_merge($params, $stepinfo, array('tags' => implode(',', $tagaarcopy))));
+                $taghead .= ' ' . html_writer::link($turl, $OUTPUT->pix_icon('t/delete',
+                        get_string('import_step1_removetag', 'oublog', $tag->tag))) .
+                        ' ' . format_text($tag->tag, FORMAT_HTML);
+            }
+        }
+        $table->define_headers(array(get_string('import_step1_table_title', 'oublog'),
+                get_string('import_step1_table_posted', 'oublog'),
+                $taghead,
+                get_string('import_step1_table_include', 'oublog')));
+        echo html_writer::start_tag('form', array('method' => 'post', 'action' => qualified_me()));
+        $untitledcount = 1;
+        foreach ($posts as &$post) {
+            $tagcol = '';
+            if (isset($post->tags)) {
+                // Create tag column for post.
+                foreach ($post->tags as $tagid => $tag) {
+                    $newtagval = empty($tags) ? $tagid : $tags . ",$tagid";
+                    $turl = new moodle_url('/mod/oublog/import.php',
+                            array_merge($params, $stepinfo, array('tags' => $newtagval)));
+                    $tagcol .= html_writer::link($turl, format_text($tag, FORMAT_HTML),
+                            array('class' => 'oublog_import_tag'));
+                }
+            }
+            if (empty($post->title)) {
+                $post->title = get_string('untitledpost', 'oublog') . ' ' . $untitledcount;
+                $untitledcount++;
+            }
+            $importcol = html_writer::checkbox('post_' . $post->id, $post->id, in_array($post->id, $preselected),
+                    get_string('import_step1_include_label', 'oublog', format_string($post->title)));
+            $table->add_data(array(
+                    format_string($post->title),
+                    oublog_date($post->timeposted),
+                    $tagcol, $importcol));
+        }
+        $module = array ('name' => 'mod_oublog');
+        $module['fullpath'] = '/mod/oublog/module.js';
+        $module['requires'] = array('node', 'node-event-delegate', 'querystring');
+        $PAGE->requires->strings_for_js(array('import_step1_all', 'import_step1_none'), 'oublog');
+        $PAGE->requires->js_init_call('M.mod_oublog.init_posttable', null, false, $module);
+        $table->finish_output();
+        echo html_writer::start_div();
+        foreach (array_merge($params, $stepinfo, array('step' => 2, 'sesskey' => sesskey())) as $param => $value) {
+            echo html_writer::empty_tag('input', array('type' => 'hidden', 'name' => $param, 'value' => $value));
+        }
+        echo html_writer::empty_tag('input', array('type' => 'submit', 'name' => 'submit',
+                'value' => get_string('import_step1_submit', 'oublog')));
+        echo html_writer::empty_tag('input', array('type' => 'submit', 'name' => 'cancel',
+                'value' => get_string('cancel')));
+        echo html_writer::end_div();
+        echo html_writer::end_tag('form');
+    }
+} else if ($step == 2) {
+    // Div used to hide the 'progress' once the page gets onto 'finished'.
+    echo html_writer::start_div('', array('id' => 'oublog_import_progress_container'));
+
+    // Do the import, show feedback. First check access.
+    echo html_writer::tag('p', get_string('import_step2_inst', 'oublog'));
+    flush();
+    $bid = required_param('bid', PARAM_INT);
+    $importall = optional_param('importall', false, PARAM_BOOL);
+    if ($remote = optional_param('remote', false, PARAM_BOOL)) {
+        // Blog on remote server, use WS to get info.
+        if (!$result = oublog_import_remote_call('mod_oublog_get_blog_info',
+                array('username' => $USER->username, 'cmid' => $bid))) {
+            throw new moodle_exception('invalidcoursemodule', 'error');
+        }
+        $boublogid = $result->boublogid;
+        $bcontextid = $result->bcontextid;
+        $boublogname = $result->boublogname;
+        $bcoursename = $result->bcoursename;
+    } else {
+        list($bid, $boublogid, $bcontextid, $boublogname, $bcoursename) = oublog_import_getbloginfo($bid);
+    }
+    require_sesskey();
+    // Get selected and pre-selected posts.
+    $selected = array();
+    $preselected = explode(',', optional_param('preselected', '', PARAM_SEQUENCE));
+    if ($_POST) {
+        foreach ($_POST as $name => $val) {
+            if (strpos($name, 'post_') === 0) {
+                $selected[] = $val;
+            }
+        }
+    }
+    $selected = array_filter(array_unique(array_merge($selected, $preselected), SORT_NUMERIC));
+    $stepinfo = array('step' => 2, 'bid' => $bid, 'preselected' => implode(',', $selected), 'remote' => $remote);
+    if ($_POST) {
+        if (empty($selected)) {
+            echo html_writer::tag('p', get_string('import_step2_none', 'oublog'));
+            echo $OUTPUT->continue_button(new moodle_url('/mod/oublog/import.php',
+                array_merge($params, $stepinfo, array('step' => 1))));
+            echo $OUTPUT->footer();
+            exit;
+        }
+    }
+    if ($remote) {
+        if ($importall) {
+            $posts = oublog_import_remote_call('mod_oublog_get_blog_posts',
+                array('username' => $USER->username, 'blogid' => $boublogid, 'selected' => '0',
+                    'inccomments' => $oublog->allowcomments != OUBLOG_COMMENTS_PREVENT, 'bcontextid' => $bcontextid));
+        } else {
+            $posts = oublog_import_remote_call('mod_oublog_get_blog_posts',
+                array('username' => $USER->username, 'blogid' => $boublogid, 'selected' => implode(',', $selected),
+                    'inccomments' => $oublog->allowcomments != OUBLOG_COMMENTS_PREVENT, 'bcontextid' => $bcontextid));
+        }
+
+    } else {
+        if ($importall) {
+            $posts = oublog_import_getposts($boublogid, $bcontextid, $selected,
+                $oublog->allowcomments != OUBLOG_COMMENTS_PREVENT, $USER->id, $importall);
+        } else {
+            $posts = oublog_import_getposts($boublogid, $bcontextid, $selected,
+                $oublog->allowcomments != OUBLOG_COMMENTS_PREVENT, $USER->id);
+        }
+    }
+
+    if (empty($posts)) {
+        print_error('import_step2_none', 'oublog');
+    }
+
+    // Get/create user blog instance for this activity.
+    if ($oublog->global) {
+        list($notused, $oubloginstance) = oublog_get_personal_blog($USER->id);
+    } else {
+        if (!$oubloginstance = $DB->get_record('oublog_instances', array('oublogid' => $oublog->id, 'userid' => $USER->id))) {
+            if (!$oubloginstance = oublog_add_bloginstance($oublog->id, $USER->id)) {
+                print_error('Failed to create blog instance');
+            }
+            $oubloginstance = (object) array('id' => $oubloginstance);
+        }
+    }
+    // Copy all posts (updating group), checking for conflicts first.
+    $bar = new progress_bar('oublog_import_step2_prog', 500, true);
+    $conflicts = array();
+    $ignoreconflicts = optional_param('ignoreconflicts', false, PARAM_BOOL);
+    $cur = 0;
+    $files = get_file_storage();
+    foreach ($posts as $post) {
+        $cur++;
+        // Is there a conflict, if so add to our list so we can re-do these later.
+        if (!$ignoreconflicts && $DB->get_records('oublog_posts', array('title' => $post->title,
+                'timeposted' => $post->timeposted, 'oubloginstancesid' => $oubloginstance->id))) {
+                $conflicts[] = $post->id;
+                $bar->update($cur, count($posts), get_string('import_step2_prog', 'oublog'));
+                continue;
+        }
+        $trans = $DB->start_delegated_transaction();
+        $newpost = new stdClass();
+        $newpost->oubloginstancesid = $oubloginstance->id;
+        $newpost->groupid = 0;// Force 0 as individual mode.
+        $newpost->title = $post->title;
+        $newpost->message = $post->message;
+        $newpost->timeposted = $post->timeposted;
+        $newpost->allowcomments = $post->allowcomments;
+        $newpost->timeupdated = time();
+        $newpost->visibility = $post->visibility;
+        if ($oublog->maxvisibility < $newpost->visibility) {
+            $newpost->visibility = $oublog->maxvisibility;
+        }
+        if ($oublog->allowcomments == OUBLOG_COMMENTS_PREVENT) {
+            $newpost->allowcomments = OUBLOG_COMMENTS_PREVENT;
+        }
+        $newid = $DB->insert_record('oublog_posts', $newpost);
+        // Add tags copied from original + new short code tag.
+        if ($bcoursename) {
+            $tagname = core_text::strtolower($bcoursename);
+            if (!$bctag = $DB->get_field('oublog_tags', 'id',
+                    array('tag' => $tagname))) {
+                $bctag = $DB->insert_record('oublog_tags',
+                        (object) array('tag' => $tagname));
+            }
+            if (!isset($post->tags)) {
+                $post->tags = array((object) array('id' => $bctag, 'tag' => $tagname));
+            } else {
+                $post->tags[] = (object) array('id' => $bctag, 'tag' => $tagname);
+            }
+        }
+        if (isset($post->tags)) {
+            foreach ($post->tags as $tagval) {
+                if (!$remote || ($bcoursename && $tagval == $tagname)) {
+                    $DB->insert_record('oublog_taginstances', (object) array(
+                            'oubloginstancesid' => $oubloginstance->id, 'postid' => $newid, 'tagid' => $tagval->id));
+                } else {
+                    // Find/create tag.
+                    if (!$tagid = $DB->get_field('oublog_tags', 'id', array('tag' => $tagval->tag))) {
+                        $tagid = $DB->insert_record('oublog_tags', (object) array('tag' => $tagval->tag));
+                    }
+                    $DB->insert_record('oublog_taginstances', (object) array(
+                            'oubloginstancesid' => $oubloginstance->id, 'postid' => $newid, 'tagid' => $tagid));
+                }
+            }
+        }
+        // Copy across images/attachments (no maximum check).
+        if ($remote) {
+            // Download remote files and add to new post.
+            oublog_import_remotefiles($post->images, $context->id, $newid);
+            oublog_import_remotefiles($post->attachments, $context->id, $newid);
+        } else {
+            foreach ($post->images as $image) {
+                $files->create_file_from_storedfile(array('itemid' => $newid, 'contextid' => $context->id), $image);
+            }
+            foreach ($post->attachments as $attach) {
+                $files->create_file_from_storedfile(array('itemid' => $newid, 'contextid' => $context->id), $attach);
+            }
+        }
+        // Copy own comments (if enabled on this blog).
+        if (!empty($post->comments)) {
+            foreach ($post->comments as $comment) {
+                $oldcid = $comment->id;
+                unset($comment->id);
+                $comment->postid = $newid;
+                $comment->userid = $USER->id;
+                $newcid = $DB->insert_record('oublog_comments', $comment);
+                // Copy comment images.
+                if (!$remote) {
+                    foreach ($comment->images as $image) {
+                        $files->create_file_from_storedfile(array('itemid' => $newcid,
+                                'contextid' => $context->id), $image);
+                    }
+                } else {
+                    oublog_import_remotefiles($comment->images, $context->id, $newcid);
+                }
+            }
+            // Inform completion system, if available.
+            $completion = new completion_info($course);
+            if ($completion->is_enabled($cm) && ($oublog->completioncomments)) {
+                $completion->update_state($cm, COMPLETION_COMPLETE);
+            }
+        }
+        // Update search (add required properties to newpost).
+        $newpost->id = $newid;
+        $newpost->userid = $USER->id;
+        $newpost->tags = array();
+        if (isset($post->tags)) {
+            foreach ($post->tags as $tag) {
+                $newpost->tags[$tag->id] = $tag->tag;
+            }
+        }
+        oublog_search_update($newpost, $cm);
+        $trans->allow_commit();
+        $bar->update($cur, count($posts), get_string('import_step2_prog', 'oublog'));
+    }
+
+    // End of div 'oublog_import_progress_container'.
+    echo html_writer::end_div();
+
+    if (count($conflicts) != count($posts)) {
+        // Inform completion system, if available.
+        $completion = new completion_info($course);
+        if ($completion->is_enabled($cm) && ($oublog->completionposts)) {
+            $completion->update_state($cm, COMPLETION_COMPLETE);
+        }
+    }
+
+    // Log post imported event.
+    $eventparams = array(
+        'context' => $context,
+        'objectid' => $oublog->id,
+        'other' => array(
+            'info' => count($posts),
+        )
+    );
+    $event = \mod_oublog\event\post_imported::create($eventparams);
+    $event->trigger();
+
+    // Div used to show the 'result' once the page gets onto 'finished'.
+    echo html_writer::start_div('', array('id' => 'oublog_import_result_container'));
+
+    // When 'importing posts' in progress, hide 'result_container'.
+    // When it've finished, hide 'progress_container', and show 'result_container'.
+    $jsstep2 = 'var resultContainer = document.getElementById("oublog_import_result_container");
+        var progressContainer = document.getElementById("oublog_import_progress_container");
+        var progressBar = document.getElementsByClassName("bar")[0];
+        var checkProgress = setInterval(function(){ toggleProgressResult() }, 1000);
+        function toggleProgressResult() {
+            if (progressBar.getAttribute("aria-valuenow") == progressBar.getAttribute("aria-valuemax")) {
+                clearInterval(checkProgress);
+                progressContainer.style.display = "none";
+                resultContainer.style.display = "block";
+            }
+        }
+    ';
+    $PAGE->requires->js_init_code($jsstep2, true);
+
+    echo html_writer::tag('h3', get_string('import_step2_total', 'oublog',
+        (count($posts) - count($conflicts))));
+    $continueurl = '/mod/oublog/view.php?id=' . $cm->id;
+    if ($oublog->global) {
+        $continueurl = '/mod/oublog/view.php?user=' . $USER->id;
+    }
+    if (count($conflicts)) {
+        // Enable conflicts to be ignored by resending only these.
+        $stepinfo['ignoreconflicts'] = true;
+        $stepinfo['preselected'] = implode(',', $conflicts);
+        $stepinfo['importall'] = false;
+        $url = new moodle_url('/mod/oublog/import.php', array_merge($params, $stepinfo));
+        $conflictimport = new single_button($url, get_string('import_step2_conflicts_submit', 'oublog'));
+        echo $OUTPUT->confirm(get_string('import_step2_conflicts', 'oublog', count($conflicts)),
+                $conflictimport, $continueurl);
+    } else {
+        echo $OUTPUT->continue_button($continueurl);
+    }
+
+    // End of div 'oublog_import_result_container'.
+    echo html_writer::end_div();
+}
+
+echo html_writer::end_div();
+echo $OUTPUT->footer();
diff --git a/mod/oublog/index.php b/mod/oublog/index.php
new file mode 100644
index 0000000..0af3819
--- /dev/null
+++ b/mod/oublog/index.php
@@ -0,0 +1,131 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+/**
+ * This page prints the blog index page
+ *
+ * @author Matt Clarkson <mattc@catalyst.net.nz>
+ * @package oublog
+ */
+
+require_once("../../config.php");
+require_once("locallib.php");
+
+$id = required_param('id', PARAM_INT);   // course
+
+if (! $course = $DB->get_record('course', array('id'=>$id))) {
+    print_error('coursemisconf');
+}
+
+// Support for OU shared activities system, if installed
+$grabindex=$CFG->dirroot.'/course/format/sharedactv/grabindex.php';
+if (file_exists($grabindex)) {
+    require_once($grabindex);
+}
+
+require_course_login($course);
+
+// Trigger instances list viewed event.
+$params = array(
+    'context' => context_course::instance($course->id)
+);
+$event = \mod_oublog\event\course_module_instance_list_viewed::create($params);
+$event->add_record_snapshot('course', $course);
+$event->trigger();
+
+$strweek = get_string('week');
+$strtopic = get_string('topic');
+$strname = get_string('name');
+$strdata = get_string('modulename', 'oublog');
+$strdataplural  = get_string('modulenameplural', 'oublog');
+$url = new moodle_url('/mod/oublog/index.php', array('id' => $course->id));
+$PAGE->navbar->add($strdata, $url);
+$PAGE->set_title($strdata);
+$PAGE->set_heading(format_string($course->fullname));
+$PAGE->set_url($url);
+echo $OUTPUT->header();
+
+// Print the list of blogs.
+if (!$blogs = get_all_instances_in_course('oublog', $course)) {
+    notice(get_string('thereareno', 'moodle', $strdataplural) , "$CFG->wwwroot/course/view.php?id=$course->id");
+}
+
+// Get the post count
+$sql = "SELECT o.id, COUNT(p.id) as postcount
+        FROM {oublog} o
+        INNER JOIN {oublog_instances} i ON i.oublogid = o.id
+        INNER JOIN {oublog_posts} p ON p.oubloginstancesid = i.id
+        WHERE o.course = ? AND p.deletedby IS NULL
+        GROUP BY o.id ";
+$counts = $DB->get_records_sql($sql, array($course->id));
+
+$timenow  = time();
+$strname  = get_string('name');
+$strweek  = get_string('week');
+$strtopic = get_string('topic');
+$strdescription = get_string('blogsummary', 'oublog');
+$strentries = get_string('posts', 'oublog');
+$table = new html_table();
+
+if ($course->format == 'weeks') {
+    $table->head  = array ($strweek, $strname, $strdescription, $strentries);
+    $table->align = array ('center', 'center', 'center', 'center');
+} else if ($course->format == 'topics') {
+    $table->head  = array ($strtopic, $strname, $strdescription, $strentries);
+    $table->align = array ('center', 'center', 'center', 'center');
+} else {
+    $table->head  = array ($strname, $strdescription, $strentries);
+    $table->align = array ('center', 'center', 'center');
+}
+
+$currentsection = '';
+
+foreach ($blogs as $blog) {
+
+    $printsection = '';
+
+    // Calculate the href.
+    if (!$blog->visible) {
+        // Show dimmed if the mod is hidden.
+        $link = "<a class=\"dimmed\" href=\"view.php?id=$blog->coursemodule\">".format_string($blog->name, true)."</a>";
+    } else {
+        // Show normal if the mod is visible.
+        $link = "<a href=\"view.php?id=$blog->coursemodule\">".format_string($blog->name, true)."</a>";
+    }
+
+    $numposts = isset($counts[$blog->id]) ? $counts[$blog->id]->postcount : 0;
+
+    if ($course->format == 'weeks' || $course->format == 'topics') {
+        if ($blog->section !== $currentsection) {
+            if ($blog->section) {
+                $printsection = $blog->section;
+            }
+            if ($currentsection !== '') {
+                $table->data[] = 'hr';
+            }
+            $currentsection = $blog->section;
+        }
+        $row = array ($printsection, $link, format_string($blog->intro, true), $numposts);
+
+    } else {
+        $row = array ($link, format_string($blog->intro, true), $numposts);
+    }
+
+    $table->data[] = $row;
+}
+
+echo "<br />";
+echo html_writer::table($table);
+echo $OUTPUT->footer();
\ No newline at end of file
diff --git a/mod/oublog/internaldoc/participation.txt b/mod/oublog/internaldoc/participation.txt
new file mode 100644
index 0000000..75bb193
--- /dev/null
+++ b/mod/oublog/internaldoc/participation.txt
@@ -0,0 +1,96 @@
+== OU Blog Participation Feature ==
+
+=== Description ===
+
+Display user participation within blogs.
+
+Participation is defined as:
+
+* Posts created
+* Comments created
+
+=== Capability Requirements ===
+
+A user will be considered to be participating in the blog if the blog is a course blog (not a global blog),
+the blog is not a group blog or the user belongs to the current group and the user has access to post
+or comment on the blog.
+
+A user who has the capability '''mod/oublog:viewparticipation''' and has access to the current blog
+can view all user participation, subject to the groupmode settings and their membership of those groups.
+(A user who has the capability '''moodle/site:accessallgroups''' will be able to see all groups regardless of
+personal membership).
+
+=== Participation Page Display ===
+
+The button displayed to the user to access the participation screens will display accordingly.
+A user with access to all users participation will see a button labelled '''Participation by user'''
+This appears above the topmost blog post visible (below the group selector if applicable).
+A user with access to only their participation, will see in the Blog usage panel
+'''My participation summary'''.
+
+
+These will allow the user two different views respectively - one showing all participants
+and an overview of their participation and one only showing a single users participation but with more detail
+for their actual participation.
+
+If a user has access to all users they can also view detailed information per user via a '''Detail'''
+link which appears next to the users full name in the user participation table.
+
+The participants to display is as follows:
+
+!Groups
+!Is current group member
+!mod/oublog:viewparticipation
+!moodle/site:accessallgroups
+!Visible Participants:
+|-
+| None
+| -
+| Allow
+| -
+| ''All enrolled''
+|-
+| None
+| -
+| -
+| -
+| ''Own participation only''
+|-
+| Visible/Separate
+| No
+| Allow
+| Allow
+| ''All enrolled''
+|-
+| Visible/Separate
+| No
+| Allow
+| -
+| ''No participants''
+|-
+| Visible/Separate
+| Yes
+| Allow
+| -
+| ''Current group members''
+|-
+| Visible/Separate
+| Yes
+| -
+| -
+| ''Own participation only''
+|}
+
+=== Back to blog link ===
+A button (link) reading as "< [blog-name]", where [blog-name] is the name of
+the oublog will redirect the user from participation-page or viewpost-page to
+the main-blog-page
+
+=== Grading ===
+
+A user with the capability ''mod/oublog:grade'' in relation to the current blog has the ability to add grade values.
+This can either be done as a bulk action on the '''Participation by user''' page or as a single update on the more detailed
+single user page.
+
+Grading will only be available if it has been set for the particular blog instance in the
+'''OU blog administration''' '''edit''' screen.
diff --git a/mod/oublog/internaldoc/testcase.access.txt b/mod/oublog/internaldoc/testcase.access.txt
new file mode 100644
index 0000000..a151c76
--- /dev/null
+++ b/mod/oublog/internaldoc/testcase.access.txt
@@ -0,0 +1,177 @@
+This script describes steps to test the OU Blog facility for Public access from a user
+perspective. It is intended to cover most of the UI and features.
+
+NOTE: In this test case, the word 'blog' always refers to the OU blog.
+
+The test steps in this script follow on from each other and aren't independent.
+
+
+Initial setup
+=============
+
+This test case requires:
+
+- six different numbered images and six diferent numbered texts for upload.
+- a course which has at least one blog.
+- two test student users (US1, and US2).
+- at least two web browsers, to enable distinctly different sessions.
+
+The test server must have debugging set to DEVELOPER level and to display
+errors; during all parts of the test script, there should be no debugging
+warnings.
+
+
+CRE Creating blog and data
+===========================
+
+
+CRE01 / Logged in as admin.
+   Create a blog called CRE01 which is a whole-course blog (no groups) and
+   visible to anyone in the world.
+
+CRE01-A /  Log out user Admin.
+CRE01-B /  Log in as US1.
+
+CRE02-P1 / Logged in as US1.
+   Go to blog CRE01.
+   Add a new post with title "CRE01-P1" and text "Post one visible to participants on this course".
+   Below the text upload the first numbered image, provide an image description.
+   Below the image enter a similar description, plus image one.
+   Attach the first text file to the post.
+   Leave 'Who can read this?' at the 'Visible to participants on this course' default setting.
+   To save the post.
+--  Click 'Add blog post'.
+
+CRE02-P2 / Logged in as US1.
+   Add a new post with title "CRE01-P2" and text "Post two visible to everyone who is logged in to the system".
+   Below the text upload the second numbered image, provide an image description.
+   Below the image enter a similar description, plus image two.
+   Attach the second text file.
+   Change 'Who can read this?' to the 'Visible to everyone who is logged in to the system' setting.
+   To save the post.
+-- Click 'Add blog post'.
+
+CRE02-P3 / Logged in as US1.
+   Add a new post with title "CRE01-P3" and text "Post three visible to anyone in the world".
+   Below the text upload the third numbered image, provide an image description.
+   Below the image enter a similar description, plus image three.
+   Attach the third text file.
+   Attach the third numbered image file.
+   Change 'Who can read this?' to the 'Visible to anyone in the world' setting.
+   To save the post.
+-- Click 'Add blog post'.
+
+CRE03-A /  Log out user US1.
+CRE03-B /  Log in as US2.
+
+CRE05-P1 / Logged in as US2.
+   Go to blog CRE01.
+   Add a new post with title "CRE01-P4" and text "Post four visible to participants on this course".
+   Below the text upload the fourth numbered image, provide an image description.
+   Below the image enter a similar description, plus image four.
+   Attach the fourth text file.
+   Leave 'Who can read this?' at the default setting 'Visible to participants on this course'.
+   To save the post.
+-- Click 'Add blog post'.
+
+CRE05-P2 / Logged in as US2.
+   Add a new post with title "CRE01-P5" and text "Post five visible to everyone who is logged in to the system".
+   Below the text upload the fifth image, provide an image description.
+   Below the image enter a similar description, plus image five.
+   Attach the fifth text file.
+   Change 'Who can read this?' to the 'Visible to everyone who is logged in to the system' setting.
+   To save the post.
+-- Click 'Add blog post'.
+
+CRE05-P3 / Logged in as US2.
+   Add a new post with title "CRE01-P6" and text "Post six visible to anyone in the world".
+   Below the text upload the sixth image, provide an image description.
+   Below the image enter a similar description, plus image six.
+   Attach the sixth text file.
+   Attach the sixth numbered image file.
+   Change 'Who can read this?' to the 'Visible to anyone in the world' setting.
+   To save the post.
+-- Click 'Add blog post'.
+
+
+CRE06-C1 / Logged in as US2.
+   Add a comment to post "CRE01-P1", with title "CRE01-P1-C1".
+   Add text "CRE01-P1-C1 user two comment, adding an existing image here which is not the same as that in this post."
+   Below this text upload an image different from that in the post, provide an image description.
+   Below the image enter a similar description, plus image seven.
+
+CRE06-CS
+   Do this for each post changing the comment title and texts to reflect the post number and image number.
+
+CRE07-A /  Log out user US2.
+CRE07-B /  Log in as US1.
+
+CRE08-C2 / Logged in as US1.
+  Add a comment to post "CRE01-P1", with title "CRE01-P1-C2"
+  Add text "CRE01-P1-C2 user one comment, adding an existing image here which is not the same as that in this post."
+  Below this text upload an image different from that in the post, provide an image description.
+  Below the image enter a similar description, plus image thirteen.
+
+CRE08-CS / Logged in as US1.
+  Do this for each post changing the comment title and texts to reflect the post number and image number.
+
+
+BSC Basic usage
+===============
+   Copy the url of the blog CRE01 from the address bar.
+
+   Either close the current browser so there are no currently open browser sessions,
+   or open a different browser.
+
+BSC01-A / Main page not logged in.
+   In the new browser window.
+   Enter the url of the in use blog from the address bar.
+-- Verify that there only two posts visible, and that this message appears at the bottom of the blog.
+   'This blog might contain posts that are only visible to logged-in users, or where only logged-in
+   users can comment. If you have an account on the system, please log in for full blog access.'
+
+BSC01-B
+-- Verify that the page looks as expected and contains two visible posts in the center,
+   a CRE01 block description and a Feeds block on the right.
+-- Verify that the Feeds block contains four links; Atom, RSS, Comments Atom, and Comments RSS.
+
+BSC01-C
+-- Verify that the visible posts are CRE01-P6 and CRE01-P3, one by each test user, and that
+   the detail on the left of the posts contains the phrase 'Visible to anyone in the world',
+   above the post content.
+   No other posts should be visible.
+
+BSC01-D
+-- Verify that each post contains: two attachments, a text block containing an image, and two links.
+
+BSC02
+   Open the Permalink and Comments links in post CRE01-P3
+-- Verify that the post view contains the same text, image and attachments as the main page.
+-- Verify that the Comments CRE01-P3-C1 and C2 are visible and that each contains an image
+   as described in the text.
+
+BSC02-A
+   Click on the link for the attachments in both the view post page and the main page.
+-- Verify that a download requester opens in each case, giving the options to open or save the file.
+-- Verify that the download requester opens the file and that the contents are visible,
+   and that it is not necessary to log in the open and view the files.
+
+BSC02-B
+   Open the Permalink and Comments links in post CRE01-P6,
+-- Verify that the images are visible in the post and comments,
+   and that the attached files open correctly as BSC02-A.
+
+BSC02-C
+   Return to the main blog page.
+
+BSC03 / Main page Feeds block not logged in.
+   Right click the Atom and RSS blog links in turn and open each in a new tab.
+-- Verify that each page opened shows only the posts CRE01-P6 and CRE01-P3,
+   and that the post content contains the images present in the main page.
+-- Verify that the Atom feed does not contain the user information, but that the RSS Feed does.
+
+BSC04
+   Right click the Comments Atom and Comments RSS blog links in turn and open each in a new tab.
+-- Verify that each page opened shows only the comments for CRE01-P6 and CRE01-P3,
+   and that the content contains the images present in the permalink post view page, for the post.
+-- Verify that the Atom feed does not contain the user information, but that the RSS Feed does.
diff --git a/mod/oublog/internaldoc/testcase.basic.txt b/mod/oublog/internaldoc/testcase.basic.txt
new file mode 100644
index 0000000..18eb3d9
--- /dev/null
+++ b/mod/oublog/internaldoc/testcase.basic.txt
@@ -0,0 +1,469 @@
+This script describes steps to test OU Blog standard functionality. It is intended to cover most of the UI and features.
+
+NOTE: In this test case, the word 'blog' always refers to the OU blog.
+
+Some test steps in this script follow on from each other and aren't independent. In these cases the prerequisite steps are listed.
+
+Initial setup
+=============
+
+This test case requires:
+
+- a user with administration rights
+- a user with student rights
+- a test course.
+
+The test server must have debugging set to DEVELOPER level and to display
+errors; during all parts of the test script, there should be no debugging
+warnings.
+
+CRE Creating blog and data
+==========================
+
+CRE01 / admin.
+   Enter test course and turn editing on.
+   Create a blog called CRE01 which is a whole-course blog (no groups) and
+   visible to anyone in the world.
+   Set 'Allow comments' to Comments not allowed.
+
+CRE02 / admin.
+   Enter test course and turn editing on.
+   Create a blog called CRE02 which should have individual mode set to 'Separate individual blogs'.
+
+INT Testing Intro display
+(Requires CRE)
+=========================
+
+INT01 / admin
+   Enter blog "CRE01".
+   Select 'Edit settings' link in the Administration block.
+   Add any text and any uploaded image into the Intro field.
+   Select 'Show intro when posting' checkbox.
+   Select 'Save and display' to save changes.
+-- Verify intro text and image added are now displayed in the top block to the side of the blog posts area.
+
+INT02 / admin
+   Select the 'New blog post' button.
+-- Verify intro text and image added are displayed at the top of the new post page.
+   Enter some text into the 'Message' field.
+   Select 'Add post' button to save the new post and return to main blog view.
+-- Verify post created is displayed at the top of the posts area.
+-- Verify post created is top of the list in the 'My participation summary' panel in the 'Blog usage' block.
+   Select 'Edit' link within post just created.
+-- Verify intro text and image added are displayed at the top of the new post page.
+   Select 'Cancel' to return to main blog view.
+
+INT03 / admin
+   Select 'Edit settings' link in the Administration block.
+   Select 'Show intro when posting' checkbox (making it not checked).
+   Select 'Save and display' to save changes.
+   Select the 'New blog post' button.
+-- Verify intro text and image added are NOT displayed at the top of the new post page.
+   Return to test course home page.
+
+COM Testing adding comments
+(Requires CRE)
+===========================
+
+COM1 / admin
+   Enter blog "CRE01".
+   Select the 'New blog post' button.
+   Enter 'COM1' into the title field.
+   Enter some text and an uploaded image into the 'Message' field.
+   Select 'Add post' button to save the new post and return to main blog view.
+-- Verify 'Add your comment' link is not shown against post COM1.
+
+COM02 / admin
+   Select 'Edit settings' link in the Administration block.
+   Set 'Allow comments' drop down to 'Yes, from everybody (even if not logged in)'.
+   Select 'Save and display' to save changes.
+   Select 'Edit' against post 'COM1'.
+   Set 'Allow comments' to 'Yes, from logged-in users'.
+   Select 'Save changes'.
+-- Verify 'Add your comment' link is shown against post COM1.
+
+COM03 / admin
+   Select 'Add your comment' link against post COM1.
+-- Verify 'New comment' screen is shown with 'Post' (collapsed) and 'New comment' (expanded) sections.
+   Select 'Post' section to expand.
+-- Verify COM1 post is shown correctly, checking display of image and user information.
+   Enter some text into the 'Add your comment' field.
+   Select 'Add comment' button.
+-- Verify returned to blog main view and post COM1 has a '1 comment' link.
+
+
+SSP Session save post test.
+(Requires CRE)
+===========================
+
+Note; Tests pre-save check on saving a blog post. Checking that the user has a valid session
+and if not will stop the save from occurring and 'Alert' the user that it would fail.
+
+SSP01 / admin
+   Enter test course and open blog "CRE01" in a new tab.
+
+SSP02 / admin
+   Select 'Edit' and make some changes on the first blog post.
+
+SSP03 / admin
+   Open the course home page in a new browser tab
+
+SSP04 / admin
+   Select to 'Sign out' of SAMS from the OU top bar,
+   (For non-SAMS sites such as ttdev, access /login/logout.php and log out instead)
+   Close the new tab
+
+SSP05 / admin
+   Return to the tab with the blog 'Update post' page open.
+   Click 'Save changes' to save the blog post.
+-- Confirm that you are presented with a 'popup alert box' labled 'Post cannot be saved.',
+   containing the following warning;
+   'Unfortunately, your changes cannot be saved at this time.
+   This is due to a network error; the website is temporarily unavailable or you have been signed out. </p>
+   Saving has been disabled on this blog.
+   In order to retain any changes you must copy the edited blog content,
+   access the Edit page again and then paste in your changes.'
+   Click the 'Ok' button.
+-- Confirm that the 'Save changes' button is disabled.
+-- Confirm that the 'Cancel' button is not disabled.
+
+SSP06 / admin
+   Copy the blog post contents with changes.
+
+SSP07 / admin
+   Click the 'Cancel' button.
+-- Confirm that you are presented with the login page.
+
+SSP08 / admin
+   Login as admin user.
+-- Verify that you are returned to the 'Update post' page for the first blog post.
+   Paste in your changes.
+   Click 'Save changes' to save the blog post.
+-- Confirm that the page refreshes and the changes are apparent in the edited first post
+   on the main blog page.
+
+
+TAG Testing post tags
+(Requires CRE)
+=====================
+
+TAG01 / admin
+   Enter blog 'CRE01'.
+   Select the 'New blog post' button.
+   Enter 'TAG1' into the title field.
+   Enter some text into message field and "tag1, tag2, btag2" into the tags field.
+   Select 'Add post' button to save the new post and return to main blog view.
+-- Verify 'btag2 (1)', 'tag1 (1)' and 'tag2 (1)' are now shown in the 'tags' tag cloud.
+
+TAG02 / admin
+   Select 'edit' link for post TAG1 to edit the post just created.
+   Select the tags field.
+-- Verify no tag choices are shown on field focus.
+   Delete all text in the tags field.
+-- Verify tag choice 'btag2 [1 posts]', 'tag1 [1 posts]' and 'tag2 [1 posts]' is shown.
+   Select 'tag1 [1posts]'
+-- Verify tags field now contains 'tag1,' and tag choice is now showing as
+   'btag2 [1 posts]', 'tag2 [1 posts]'.
+
+TAG03 / admin
+   Enter blog 'CRE02'.
+   Select the 'New blog post' button.
+   Enter 'ADMIN_TAG1' into the title field.
+   Enter some text into message field and "tag3, tag4" into the tags field.
+   Select 'Add post' button to save the new post and return to main blog view.
+-- Verify 'tag3 (1)' and 'tag4 (1)' are now shown in the 'tags' tag cloud.
+   Select the 'New blog post' button.
+   Select the tags field.
+-- Verify tag choice 'tag3 [1 posts]' and 'tag4 [1 posts]' is shown.
+   Type 'ta' into tags field.
+-- Verify tag choice 'tag3 [1 posts]' and 'tag4 [1 posts]' is shown.
+   Type 'tag3' into tags field.
+-- Verify tag choice 'tag3 [1 posts]' is shown.
+   Select tag 'tag3'.
+-- Verify tags field contains 'tag3, ' and tag choice 'tag4 [1 posts]' is shown.
+   Select tag 'tag4'.
+-- Verify tags field contains 'tag3, tag4, ' and no tag choice is shown.
+
+TAG04 / student [change]
+   Enter blog 'CRE02'.
+   Select the 'New blog post' button.
+   Select the tags field.
+-- Verify no tag choices are shown on field focus.
+
+TAG Testing post tag order
+==========================
+
+TAG05 / admin
+   Enter blog 'CRE01'.
+-- Cofirm that the 'tags' tag cloud contains the label 'Order:' followed by a help icon and
+   that beneath this is a label 'Alphabetical', the default order, followed by a
+   verticle divider and link 'Use' above the existing tags 'btag2 (1)', 'tag1 (1)' and 'tag2 (1)'.
+
+TAG06 / admin
+   Click the help icon to display the tag cloud, order help text.
+-- Confirm it matches the following,
+   "You can choose to display the list of tags used ordered either in alphabetical order
+   or by number of posts used in. Select the two links to switch between ordering methods,
+   this choice is remembered and will be used on subsequent views."
+
+TAG07 / admin
+   Edit the first 'untitled post' and add the tags 'atag1, btag2'.
+   Select 'Save changes'.
+-- Verify 'atag1(1) btag2(2) tag1 (1) tag2 (1)' are now shown
+   in the 'tags' tag cloud, possibly with btags in larger emboldend text.
+
+TAG08 / admin
+   Edit the COM1 post and add the tags 'atag1, btag2'.
+   Select 'Save changes'.
+-- Verify 'atag1 (2) btag2 (3) tag1 (1) tag2 (1) ' are now shown in the 'tags' tag cloud,
+   with btag2 and atag1 in larger emboldend text.
+
+TAG09 / admin
+   Edit the TAG1 post and add the tags 'atag1, ctag3'.
+   Select 'Save changes'.
+-- Verify 'atag1 (3) btag2 (3) ctag3 (1) tag1 (1) tag2 (1)' are now shown in the 'tags' tag cloud,
+   with btag2 and atag1 in larger emboldend text.
+
+TAG10 / admin
+   Select the 'New blog post' button.
+   Enter 'TAG2' into the title field.
+   Enter some text into message field and "tag1, btag2" into the tags field.
+   Select 'Add post' button to save the new post and return to main blog view.
+-- Verify that the tag order is alphabetical 'atag1 (3) btag2 (4) ctag3 (1) tag1 (2)
+   tag2 (1)' shown in the 'tags' tag cloud.
+
+TAG11 / admin
+   Click the link 'Use' to change the order to popular use order.
+-- Confirm that the 'Use' link becomes a label.
+-- Confirm that the 'Alphabetical' label becomes a link.
+-- Verify that 'btag2 (4) atag1 (3) tag1 (2) tag2 (1) ctag3 (1)' are now shown
+   in the 'tags' tag cloud, possibly with some tags in larger emboldend text.
+   Retrun to the course main page.
+   Re enter blog CRE01
+-- Confirm that the link is currently 'Alphabetical'.
+-- Confirm that the tag order is still popular use order 'btag2 (4) atag1 (3) tag1 (1)
+   tag2 (1) ctag3 (1)' as before.
+
+TAG12 / admin
+   Click the link 'Alphabetical' to change the current order to alphabetical order.
+-- Confirm that 'Use' becomes the link.
+-- Verify that tag cloud now shows 'atag1 (3) btag2 (4) ctag3 (1) tag1 (2) tag2 (1)'
+   possibly with some tags in larger emboldend text.
+   Return to the course main page.
+   Re enter blog CRE01
+-- Confirm that the link is currently 'USE'.
+-- Confirm that the tag order is alphabetical 'atag1 (3) btag2 (4) ctag3 (1) tag1 (2)
+   tag2 (1)' as before.
+
+BTAG Testing Blog level tags
+(Requires CRE + TAG)
+===========================
+
+BTAG01 / admin
+   Enter blog 'CRE01'.
+   Select 'Edit settings' link in the Administration block.
+   Scroll down to find the 'General' field entry, 'Tags' with help icon.
+   Enter the tags 'cre01tag01, cre01tag02'.
+-- Click 'Save and display'.
+
+BTAG02 / admin
+-- Click the 'Edit' button on post 'TAG1'.
+   Scroll to the Tags (separated by commas) entry field.
+   Click to, or otherwise, enter the Tags field.
+-- Confirm that the field dropdown is displayed, and contains the pre existing tag
+   'btag2' the two new blog tag entries 'cre01tag01 Set 0 posts' and
+   'cre01tag02 Set 0 posts'.
+
+BTAG03 / admin
+   Delete tag 'tag1,' from the Tags field.
+-- Verify that the drop down now contains the extra entry 'tag1 1 posts'.
+   Click the dropdown entry 'cre01tag02 Set 0 posts'.
+-- Verify that the Tags field now contains 'tag2, atag1, ctag3, cre01tag02, '
+   and that the dropdown now only displays the three entries
+   'btag2 2 posts', 'cre01tag01 Set 0 posts' and 'tag1 2 posts'.
+   Click 'Save changes'.
+
+Return to the course main page.
+
+BTAG04 / admin
+   Create a new blog, enter the blog name as 'CRE03'.
+   Enter any text as the Intro.
+   Leaving all other settings at their defaults, scroll down find to the
+   'Tags' entry field.
+   Click the help icon to display the tag cloud, order help text.
+-- Confirm help text is displayed in a popup.
+   Close the popup.
+   Enter the tags 'CRE03TAG01, CRE03TAG02'.
+   Click 'Save and display'.
+
+BTAG05 / admin
+   Create a new post, enter the blog name as 'BTAG07'.
+   Enter the message 'Testing the predefined Set Blog tags'.
+   Scroll to and enter the Tags (separated by commas) field.
+-- Confirm that 'cre03tag01 Set 0 posts' and 'cre03tag02 Set 0 posts'
+   are the only entries in the tag choice drop down, the two tags created on the blog.
+   Select the tag 'cre03tag01 Set 0 posts'.
+-- Confirm that the page refreshes and that the tag appears in the field but
+   not in the choice drop down.
+   Along side 'cre03tag01,' enter the tag 'btag07' in the Tags field.
+   Click 'Add post'.
+-- Confirm that the 'Tags' tag cloud contains the two tags 'cre03tag01,' and 'btag07'.
+   in the default 'Alphabetical' order.
+
+BTAG06 / admin
+   Create a new post, enter the blog name as 'TAG08'
+   Enter the message 'Testing the predefined Set Blog tags appear
+   along side user entered tags'.
+   Scroll to and enter the Tags (separated by commas) field.
+-- Confirm that 'btag07 1 posts', 'cre03tag01 Set 1 posts' and 'cre03tag02 Set 0 posts'
+   are the only entries in the drop down.
+   Slowly, enter the tag 'btag08,' into the Tags field.
+   Select the tag 'cre03tag02 Set 0 posts'.
+-- Confirm that 'btag07 1 posts' and 'cre03tag01 Set 1 posts' are the only
+   entries displayed in the choice drop down.
+   Click 'Add post'.
+
+BTAG07 / admin
+-- Confirm that the display of the Tag cloud matches those tags entered,
+   'btag07(1) btag08(1) cre03tag01(1) cre03tag02(1)'.
+
+BTAG08 / admin
+   Select 'Edit settings' link in the Administration block.
+   Scroll down to find the 'Tags' heading field entry, 'Tags' with help icon.
+   Click the help icon beside 'Tag options'.
+-- Confirm it shows a help popup.
+   Overwrite the tags in the tag field with 'cre03settag01, cre03settag02'.
+   Change the 'Tag options' dropdown to 'Allow pre-defined tags only'.
+   Click 'Save and display'.
+
+BTAG09 / admin
+   Create a new post, enter the title as 'TAG09'
+   Enter the message 'Testing the predefined Set Blog tags appear
+   rather than user entered tags'.
+-- Confirm that beneath the 'Message' box there is a label
+   'You may only enter the 'Set' tags: cre03settag01,cre03settag02'.
+   Enter the Tags (separated by commas) field.
+-- Confirm that 'cre03settag01 Set 0 posts', 'cre03settag02 Set 0 posts'
+   are the only entries in the drop down.
+   Select the tag 'cre03settag02 Set 0 posts'.
+-- Confirm that 'cre03settag01 Set 0 posts' is now the only entry displayed
+   in the choice drop down selector.
+
+BTAG10 / admin
+   In the tag field enter the tag 'tag01' after the set tag 'cre03settag02'
+   Click 'Add post'.
+-- Confirm that the page refreshes with a warning above the tag entry field,
+   'Only 'Set' tags are allowed to be entered'.
+   In the tag field, delete the tag 'tag01' and select 'cre03settag01 Set 0 posts'
+   from the choice drop down selector.
+   Click 'Add post' (after filling in any other required fields).
+
+BTAG11/ admin
+-- Confirm that the display of the Tag cloud matches those tags entered,
+   'btag07(1) btag08(1) cre03settag01(1) cre03settag02(1) cre03tag01(1) cre03tag02(1)'.
+
+BTAG12/ admin
+   Edit the TAG08 post.
+-- Confirm that beneath the 'Message' box there is a label
+   'You may only enter the 'Set' tags: cre03settag01,cre03settag02'.
+-- Confirm the existing tags are 'btag08', 'cre03tag02',
+   Enter the Tags (separated by commas) field.
+-- Confirm that 'cre03settag01 Set 1 posts', 'cre03settag02 Set 1 posts'
+   are the only entries in the drop down.
+   Click the 'Save changes' button.
+-- Confirm that the page refreshes with a warning above the tag entry field,
+   'Only 'Set' tags are allowed to be entered'.
+   In the tag field, delete the tags 'btag08' and 'cre03tag02' then select
+   'cre03settag02 Set 1 post' from the choice drop down selector.
+   Click the 'Save changes' button.
+
+BTAG13/ admin
+-- Confirm that the display of the Tag cloud matches those tags entered,
+   'btag07(1) cre03settag01(1) cre03settag02(2) cre03tag01(1)'.
+
+BTAG14 / admin
+   Select 'Edit settings' link in the Administration block.
+   Scroll down to find the 'Tags' heading.
+   Change the 'Tag options' dropdown to 'Must enter tags'.
+   Click 'Save and display'.
+   Create a new post.
+   In the post leave 'Tags' field empty.
+   Click 'Add post'.
+-- Confirm 'Required' message is shown against 'Tags' field.
+
+BTAG15 / admin
+   Select 'Edit settings' link in the Administration block.
+   Scroll down to find the 'Tags' heading.
+   Change the 'Tag options' dropdown to 'Must enter pre-defined tags only'.
+   Click 'Save and display'.
+   Create a new post 'TAG10'.
+   In the post leave 'Tags' field empty.
+   Click 'Add post'.
+-- Confirm 'Required' message is shown against 'Tags' field.
+-- Confirm 'Only 'Set' tags are allowed to be entered' message is shown against 'Tags' field.
+   Enter 'cre03settag01' into Tags field.
+   Click 'Add post'.
+-- Confirm no warnings shown against 'Tags' field.
+
+
+PAG Testing blog display pagination.
+===================================
+
+Note Requires a blog, which contains multiples of the number of posts per page
+     ie 20. Please use the Admininistrator's Personal blog and/or Course Blogtest Blog B.WC.
+
+PAG01 / admin
+   Enter either blog "B.WC" or Admin personal blog (/mod/oublog/view.php).
+   For the course blog.
+-- Confirm that the 'New blog post' and 'Participation by user' buttons are displayed
+   at the top of the blog posts area.
+   For the Admin user's blog.
+-- Confirm that the 'New blog post' and 'Import post' (if feature enabled) buttons are displayed
+   at the top of the blog posts area.
+-- Verify that beneath these buttons, when more than 20 posts are available,
+   above the first post and below the last post is a moodle standard pagination bar
+   which resembles the following.
+
+           Page: 1|2|3   Next ->
+                   - -   ----
+
+-- Confirm that there are a maximum of 20 posts visible.
+
+PAG02 / admin
+-- Verify that clicking any 'number' link or the 'Next->' link causes the page to be
+   refreshed and should now show a range of different posts, and that the standard
+   pagination bar now resembles the following, depending upon link clicked.
+
+           <- Previous   1|2|3    Next ->
+              --------   -   -   ----
+
+PAG Testing Personal blog display pagination.
+=============================================
+
+Note Tests the 'Personal blog' all posts page, which contains multiples of the number
+     of posts per page ie 20.
+     Please use the Admininistrator's Personal blog to access the allposts.php.
+
+PAG01 / admin
+   Enter Admin personal blog via /mod/oublog/view.php.
+   Click the 'View site entries' link.
+-- Confirm that the 'New blog post' and 'Import post' buttons are not displayed
+   at the top of the blog posts area.
+
+-- Verify that above the first post and below the last post is a moodle standard
+   pagination bar which resembles the following, depending upon the number of posts.
+
+           Page: 1|2|3|    Next ->
+                   - -     ----
+
+-- Confirm that there are 20 posts visible by various users.
+
+PAG02 / admin
+-- Verify that clicking any 'number' link or the 'Next->' link causes the page to be
+   refreshed and should now show a range of different posts, and that the standard
+   pagination bar now resembles the following, depending upon link clicked.
+
+           <- Previous   1|2|3|   Next ->
+              --------   -   -    ----
+
+Test ends.
diff --git a/mod/oublog/internaldoc/testcase.delete.txt b/mod/oublog/internaldoc/testcase.delete.txt
new file mode 100644
index 0000000..9255a12
--- /dev/null
+++ b/mod/oublog/internaldoc/testcase.delete.txt
@@ -0,0 +1,321 @@
+This script describes steps to test the OU Blog facility for deleting and emailing a user
+notification. It is intended to cover most of the UI and features.
+
+NOTE: In this test case, the word 'blog' always refers to the OU blog.
+
+The test steps in this script follow on from each other and aren't independent.
+
+Initial setup
+=============
+
+This test case requires:
+
+- a course which has at least one blog.
+- two test student users (US1, and US2).
+- make use of the admin and (UET) a user with the teacher role.
+- a reporting email is provided in oublog administration settings, to enable the 'Report post' link.
+- access to each test users email account to read delete notification emails.
+- at least two web browsers, to enable distinctly different sessions,
+  with and without javascript enabled.
+
+The test server must have debugging set to DEVELOPER level and to display
+errors; during all parts of the test script, there should be no debugging
+warnings.
+
+
+CRE Creating blog and data
+===========================
+
+CRE01 / Logged in as admin.
+   Create a blog called CRE01 which is a whole-course blog (no groups) and
+   visible to anyone in the world.
+
+CRE01-A /  Log out user Admin.
+CRE01-B /  Log in as US1.
+
+CRE01-UP1 / Logged in as US1.
+   Go to blog "CRE01".
+   Click to add a new post with title "CRE01-P1" and text "User one post one visible to participants
+   on this course. To be deleted without the possibility of email notification.".
+   Insert any image to the text area, give the image a description.
+   Insert the tag 'us1t1'.
+   Leave 'Allow comments' at default setting.
+   Add the same image as an attachment to the post.
+--  Click 'Add post'.
+
+CRE01-UP2 / Logged in as US1.
+   Add a new post with title "CRE01-P2" and text "User one post two visible to participants on this course.
+   To be deleted with the possibility of email notification.".
+   Insert a new image to the text area, give the image a description.
+   Insert the tags 'us1t2, us1t1'.
+   Leave 'Allow comments' at default setting.
+   Add the same image as an attachment to the post.
+-- Click the 'Add post' button.
+
+CRE01-UP3 / Logged in as US1.
+   Add a new post with title "CRE01-P3" and text "User one post three visible to participants on this course.
+   To be deleted with email notification.".
+   Insert a third image to the text area, give the image a description.
+   Insert the tags 'us1t3,us1t2, us1t1'.
+   Leave 'Allow comments' at default setting.
+   Add the same image as an attachment to the post.
+-- Click the 'Add post' button to save the post.
+
+CRE01-UP4 / Logged in as US1.
+   Add a new post with title "CRE01-P4" and text "User one post four to remain visible to participants on this course.".
+   Insert an image to the text area, give the image a description.
+   Insert the tags 'us1t4,us1t3,us1t2,us1t1'.
+   Leave 'Allow comments' at default setting.
+   Add the same image as an attachment to the post.
+-- Click the 'Add post' button to save the post.
+
+CRE01-C /  Log out user US1.
+CRE01-D /  Log in as US2.
+
+CRE02-UP1 / Logged in as US2.
+   Go to blog "CRE01".
+   Add a new post with title "CRE01-P5" and text "User two post one visible to participants on this course.
+   To be deleted without the possibility of email notification.".
+   Insert an image to the text area, give the image a description.
+   Insert the tag 'us2t4,us2t3,us2t2,us2t1'.
+   Leave 'Allow comments' at default setting.
+   Add the same image as an attachment to the post.
+-- Click 'Add post' and save this post.
+
+CRE02-UP2 / Logged in as US2.
+   Add a new post with title "CRE01-P6" and text "User two post two visible to participants on this course.
+   To be deleted with email notification.".
+   Insert an image to the text area, give the image a description.
+   Insert the tag 'us2t3,us2t2,us2t1'.
+   Leave 'Allow comments' at default setting.
+   Add the same image as an attachment to the post.
+-- Click 'Add post'.
+
+CRE02-UP3 / Logged in as US2.
+   Add a new post with title "CRE01-P7" and text "User two post three remaining visible to participants on this course.".
+   Insert an to the text area, give the image a description.
+   Insert the tag 'us2t1'.
+   Leave 'Allow comments' at default setting.
+   Add the same image as an attachment to the post.
+-- Click 'Add post' again.
+
+CRE03-A /  Log out user US2.
+CRE03-B /  Log in as UET.
+
+CRE03-P1 / Logged in as UET.
+   Go to blog "CRE01".
+   Add a new post with title "CRE01-P8" and text "Teacher post one visible to participants on this course,
+   to be deleted.".
+   Insert an image to the text area, give the image a description.
+   Insert the tag 'uett1'.
+   Leave 'Allow comments' at default setting.
+   Add the same image as an attachment to the post.
+-- Click 'Add post' again.
+
+CRE03-P2 / Logged in as UET.
+   Add a new post with title "CRE01-P9" and text "Teacher post two stays visible to participants on this course.".
+   Insert an image to the text area, give the image a description.
+   Insert the tag 'uett1, uett2'.
+   Leave 'Allow comments' at default setting.
+   Add the same image as an attachment to the post.
+-- Click 'Add post'.
+
+
+BSC Basic Delete usage  (JS not enabled in the browser)
+======================
+
+BSC01-NJ1 / Log in as UET
+   Go to blog "CRE01".
+   Tab to the 'Delete' link beneath "CRE01-P1".
+   Click this 'Delete' link..
+-- Confirm that the page refreshes and shows a boxed form, with the description
+   'Select to delete the post or delete and send a customisable email notification.'
+   and three buttons; 'Delete', 'Delete and email' and 'Cancel'.
+
+BSC01-NJ2 / as UET.
+   Tab to the 'Cancel' button and activate it.
+-- Verify that the page refreshes, when 'Cancel' is clicked, returning to the blog view page,
+   without making any changes.
+
+BSC01-NJ3 / as UET.
+   Click 'Delete' beneath "CRE01-P1" again.
+-- Confirming that the dialog page appears.
+
+BSC01-NJ4 / as UET.
+   Tab to the 'Delete' button.
+   Activate this 'Delete' button.
+-- Confirm that the page refreshes. (The page should automatically redirect. If nothing happens please use the continue link.)
+-- Verify that the page refreshes and that all "CRE01-P1" post content is now dimmed,
+   and that there is now an additional entry beneath the post title and attachments block;
+   'Deleted by' {uet username} 'the date', which has highlighting in red.
+
+BSC01-NJ5 / as UET.
+   Tab to the 'Delete' link beneath post "CRE01-P2".
+   Click this 'Delete' link.
+-- Confirm that a dialog page opens as before.
+   This time tab to the 'Delete and email' button and click it.
+-- Confirm that a new page 'Delete and email' opens, with a form showing a message box with a default message
+   notification showing that the post was deleted by {uet username} and a block of post detail showing
+   Subject, Blog and Module, followed by an html link 'View the deleted post'.
+-- Confirm that below this message box are;
+   'Send a copy to yourself' check box ,
+   'Email address of other recipients', text input box for list entry and
+   'Include post' check box.
+-- Confirm that the form ends with 'Send and delete' and 'Cancel' buttons.
+
+BSC01-NJ5a / as UET.
+   Tab to the 'Cancel' button and activate it.
+-- Verify that the page refreshes, when 'Cancel' is clicked, returning to the blog view page
+   and that the post has not been deleted.
+
+BSC01-NJ6 / as UET.
+   Again tab to the 'Delete' link beneath post "CRE01-P2".
+   Click this 'Delete' link.
+   Tab to the 'Delete and email' button and click it.
+   Leave all 'Delete and email' form settings at their defaults and click
+   'Send and delete'.
+-- Verify that the page refreshes and that all "CRE01-P2" content is now dimmed,
+   and that there is now an additional entry beneath the post title - 'Deleted by' {uet username} 'the date'
+   with highlighting in red.
+
+BSC01-NJ7a / as UET.
+-- Verify that an email notification has been received:
+   This is a notification to advise you that your Blog post with the
+   following details has been deleted by {uet username}:
+   Subject: CRE01-P2
+   Blog: CRE-01
+   Module: OUBlog delete and email functionality
+   View the deleted post (an html link)
+
+BSC01-NJ7b / as UET.
+   Click to open the 'View the deleted post' link in the email.
+   In the browser which opens from this link, login as student user US.1.
+   (It may be necessary to click the link in the email again)
+-- Confirm that the post "CRE01-P2" is opened in the 'Viewpost' page and that the post appears
+   the same as in the main page, ie dimmed and with the deleted notification.
+   Log out and close the browser.
+
+BSC01-NJ7c / as UET.
+   Click to open the 'View the deleted post' link in the email.
+   In the browser which opens from this link, login as student user US.2.
+   (It may be necessary to click the link in the email again)
+-- Confirm that the post "CRE01-P2" can not be seen by as student user US.2.
+   Log out and close the browser.
+
+Return to the blog main page, in the original browser session.
+
+BSC01-NJ8 / as UET.
+   Tab to the 'Delete' link beneath post "CRE01-P3".
+   Click this 'Delete' button.
+-- Confirm that a dialog page opens as before.
+   Tab to the 'Delete and email' button and click it.
+-- Confirm that a new page 'Delete and email' opens, with a form showing a message box with a default message
+   notification showing that the post was deleted by {uet username} and a block of post detail showing
+   Subject, Blog and Module, followed by a link 'View the deleted post'.
+-- Confirm that below this message box are;
+   'Send a copy to yourself' check box,
+   'Email address of other recipients', text input box for list entry and
+   'Include post' check box.
+
+BSC01-NJ9 / as UET.
+   Click both checkboxes, and enter the known checkable email address into the text input box.
+   Click the 'Send and delete' button.
+-- Verify that the page refreshes and that all "CRE01-P3" content is now dimmed,
+   and that there is now an additional entry beneath the post title -
+   'Deleted by' {uet username} 'the date'  with highlighting in red.
+
+BSC01-NJ10 / as UET.
+-- Confirm that email notifications have been recieved by each test user.
+-- Confirm that the notification is as above, and that the email also contains the content of the blog post
+   in plain html format, with no delete highlighting.
+
+Return to the blog main page.
+
+BSC Basic delete usage (JS enabled)
+======================
+   Return to the main blog page.
+
+BSC02-JE1 / Log in as UET.
+   Go to blog "CRE01".
+   Tab to the 'Delete' link beneath "CRE01-P5".
+   Click this 'Delete' link.
+-- Confirm that the current page is slightly dimmed and grey all over, highlighting the central popup box
+   with a close widget [X] and the description
+   'Select to delete the post or delete and send a customisable email notification.'
+   and three buttons; 'Delete', 'Delete and email' and 'Cancel'.
+
+BSC02-JE2 / as UET.
+   Tab to the close widget, and click it.
+-- Verify that the dialog disappears, when the close widget is clicked.
+   On post "CRE01-P5" click 'Delete' again, and tab to the 'Cancel' button.
+-- Verify that the dialog disappears, when the 'Cancel' button is clicked,
+   and that focus remains upon the "CRE01-P5" 'Delete' link.
+
+BSC02-JE3 / as UET.
+   Click this 'Delete' link again beneath "CRE01-P5" post content.
+-- Confirm that a dialog pops up as before.
+   Tab to the 'Delete' button and click it.
+-- Verify that the page refreshes.
+-- Confirm that all "CRE01-P5" post content is now dimmed,
+   and that there is an additional entry beneath the post title -
+   'Deleted by' {uet username} 'the date' with highlighting in red.
+
+BSC02-JE4 / as UET.
+   Tab to the 'Delete' link beneath "CRE01-P6".
+   Click this 'Delete' link.
+-- Confirm that the dialog pops up as before.
+   Tab to the 'Delete and email' button and click it.
+-- Confirm that a new page opens containing a 'Delete and email' form page.
+
+BSC02-JE5 / as UET.
+   Leave all form settings at their defaults and click 'Send and delete'.
+   (This page should automatically redirect. If nothing happens please use the continue link.)
+-- Verify that the page refreshes and that all "CRE01-P6" post content is now dimmed,
+   and that there is now an additional entry beneath the post title -
+   'Deleted by' {uet username} 'the date' with highlighting in red.
+
+BSC02-JE6 / as UET.
+-- Confirm that an email notification has been recieved :
+   This is a notification to advise you that your blog post with the
+   following details has been deleted by 'uetuser teacher':
+   Subject: CRE01-P6
+   Blog: CRE01
+   Course: OUBlog delete and email functionality
+   View the deleted post (an html link)
+
+Return to the blog main page.
+
+BSC02-JE7 / as UET.
+   Tab to the 'Delete' link beneath post "CRE01-P8" by user UET.
+   Click this 'Delete' link.
+-- Confirm that the page refreshes and shows a boxed form, with the description
+   'Are you sure you want to delete this post?'
+   and two buttons 'Delete' and 'Cancel'.
+
+BSC02-JE8 / as UET.
+   Click the 'Delete' button.
+   (This page should automatically redirect. If nothing happen please use the continue link.)
+-- Verify that the page refreshes and that all "CRE01-P8" content is now dimmed,
+   and that there is also an additional entry beneath the post title -
+   'Deleted by' {uet username} 'the date' with highlighting in red.
+-- Confirm that no email was sent following this deletion.
+
+
+Student user post visibility test.
+----------------------------------
+
+BSC03-U01 / Log in as US.1.
+   Go to blog main page for "CRE01".
+-- Confirm that only five posts are visible as US.1.
+   Posts CRE01-P9 by {uet username}.
+   Posts CRE01-P7 and CRE01-P4 by students two and one.
+   And deleted posts CRE01-P3, CRE01-P2 and CRE01-P1 by student user one
+
+BSC03-U02 / Log in as US.2.
+   Go to blog main page for "CRE01".
+-- Confirm that only five posts are visible as US.2.
+   Posts CRE01-P9 by {uet username}.
+   Post CRE01-P7 and CRE01-P4 by students two and one.
+   And deleted posts, CRE01-P6 and CRE01-P5 by student user two
+
+Test ends.
diff --git a/mod/oublog/internaldoc/testcase.importpages.txt b/mod/oublog/internaldoc/testcase.importpages.txt
new file mode 100644
index 0000000..2a7c130
--- /dev/null
+++ b/mod/oublog/internaldoc/testcase.importpages.txt
@@ -0,0 +1,297 @@
+This script describes steps to test the OU Blog facility for importing posts from a user
+perspective. It is intended to cover most of the UI and features.
+
+NOTE: In this test case, the word 'blog' always refers to the OU blog.
+
+The test steps in this script follow on from each other and aren't independent.
+
+
+Initial setup
+=============
+
+This test case requires:
+
+- 2 users. S1 - a student user and an admin user (both system-wide, not 'view as' or course roles).
+- Two test courses, referred to as TC1 and TC2, that are visible to students.
+- User S1 should be enrolled on TC1 and TC2.
+
+The test server must have debugging set to DEVELOPER level and to display
+errors; during all parts of the test script, there should be no debugging
+warnings.
+
+
+CRE Creating blog and data
+===========================
+
+CRE01 / admin.
+   Enter TC1.
+   Create a blog called WCB01 - a whole-course blog (blog together, no group mode).
+   Create a blog called IB01 - set to Separate individual blogs, enable comments from logged-in users.
+   Create a blog called IB02 - set to Separate individual blogs.
+   Create a blog called IB03 - set to Separate individual blogs - make this hidden from students.
+
+CRE02 / admin
+   Enter TC2.
+   Create a blog called IB04 - set to Separate individual blogs, enable comments from logged-in users.
+
+CRE03 / admin
+   Enter TC1 and enter blog IB01.
+   Create a new post, titled "CRE03 - admin", any message text, other options at default.
+
+CRE04 / S1 (change)
+   Enter TC1 and enter blog IB01.
+   Create a new post:
+   Leave title as blank
+   Add any text to message, upload any image into the text
+   Ensure comments are allowed
+   Add the same image as an attachment
+   Add tags "a,b,c"
+   Save
+ -- Verify new post is displayed in blog view page.
+
+CRE05 / S1
+   Repeat CRE04, using tags value "a,b".
+
+CRE06 / S1
+   Repeat CRE04, making title "CRE06" and tags value "a".
+
+CRE07 / S1
+   Against CRE06 post, add a new comment by selecting 'Add your comment'
+   Add any text to the comment message, include an uploaded image
+   Save comment
+ -- Verify comment text with image shows.
+
+CRE08 / admin (change)
+   Enter TC1 and enter blog IB01.
+   Against CRE06 post, add a new comment by selecting 'Add your comment'
+   Add any text to the comment message
+   Save comment
+ -- Verify comment text with image shows.
+
+AVL Import pages availability
+=============================
+
+AVL01 / admin
+   Enter TC2 and select blog IB04
+ -- Verify 'Import posts' button is not shown next to New blog post button.
+
+AVL02 / admin
+   Select Edit settings under OU blog administration (Administration block)
+   Check 'Enable post import' checkbox
+   Select Save and display
+ -- Verify 'Import posts' button is now shown next to 'New blog post' button.
+
+AVL03 / admin
+   Enter TC1 and select blog WCB01
+ -- Verify 'Import posts' button is not shown next to New blog post button.
+
+AVL04 / admin
+   Select Edit settings under OU blog administration (Administration block)
+   Check 'Enable post import' checkbox
+   Select Save and display
+ -- Verify warning is shown advising post import cannot be enabled and form is not saved.
+   Exit edit settings page.
+
+SEL Import page selection
+=========================
+
+SEL01 / S1 (change)
+   Enter TC2 and select blog IB04
+   Select the 'Import posts' button
+ -- Verify that the 'Import pages' screen is shown. This should only list the following:
+ -- TC1
+ -- IB01 (3 posts) [Where IB01 is a link]
+ -- IB02 (0 posts) [Where IB02 is not a link]
+ -- [Note that other courses/blogs not setup in this test may appear depending on system content]
+
+SEL02 / S1
+   Select the IB01 link
+ -- Verify page changes, and shows:
+ -- Import from: [TC1 shortname and full name] : IB01
+ -- A table with 'Title', 'Date posted', 'Tags' and 'Include in import' columns
+ -- Table should contain 3 rows:
+ -- CRE06, [Date post was created], a
+ -- Untitled post 1, [Date post was created], a,b
+ -- Untitled post 2, [Date post was created], a,b,c.
+
+SEL03 / S1
+   Select Date posted column heading link
+ -- Verify that posts re-order into reverse order, Date posted should now have an 'up' symbol
+   Select Title column heading link
+ -- Verify that post re-order alphabetically, Title should now have an 'up' symbol
+
+SEL04 / S1
+   Select link on any tag 'a' in the Tag column of the table
+ -- Verify page reloads - information should remain the same. A "[cross] a" link should appear in Tags column header
+   Select link on any tag 'b' in the Tag column of the table
+ -- Verify page reloads - only the two posts with tag b should now show in the table,
+ -- "[cross] a" and "[cross] b" links should appear in Tags column header
+   Select link on tag 'c' in the tag column of the table
+ -- Verify page reloads - only the post with tag c should now show in the table,
+ -- "[cross] a", "[cross] b" and "[cross] c" links should appear in Tags column header
+   Select the icon next to 'c' in Tags column header
+ -- Verify page reloads - the two posts with tag b should now show in the table,
+ -- "[cross] a" and "[cross] b" links should appear in Tags column header.
+
+SEL05 / S1 (JavaScript enabled only)
+   Select 'Select all' link in 'Include in import' column header
+ -- Verify all posts shown have 'Include in import' checked
+   Select 'Select none' link in 'Include in import' column header
+ -- Verify all posts shown have 'Include in import' not checked.
+
+SEL06 / S1
+   Ensure no posts have 'Include in import' checkbox checked
+   Select 'Import posts' button
+ -- Verify page changes and 'No posts selected for import' message displayed
+   Select 'Continue' button
+ -- Verify returned to post selection table.
+
+SEL07 / S1
+   Select 'Cancel' button
+ -- Verify return to blog selection screen.
+
+IMP Import blog pages
+=====================
+
+IMP01/ S1
+   Enter TC2 and select blog IB04, then select 'Import pages' button
+   Select link to IB01 (3 posts)
+   Select 'Include in import' checkbox for all three posts shown
+   Select 'Import posts'
+ -- Verify page changes and 'Importing posts:' is displayed along with a progress bar
+ -- Verify progress bar reaches 100% and message 'Imported 3 posts' is displayed.
+
+IMP02 / S1
+   Select the 'Continue' button
+ -- Verify IB04 main blog view page displayed
+ -- Verify 3 posts now display, check content, tags and attachments against original
+   Select 'Permalink' for post CRE06
+ -- Verify 1 comment is displayed (by user s1), check content.
+
+IMP03 / S1
+   Repeat IMP01
+ -- Verify 'Imported 0 posts' displayed
+ -- Verify message '3 posts to import were identified as conflicts with existing posts.' displayed
+   Select 'Cancel'
+ -- Verify IB04 main blog view page displayed, with 3 posts listed.
+
+IMP04 / S1
+   Repeat IMP01
+   Select 'Import conflicting posts' button
+ -- Verify page changes and 'Importing posts:' is displayed along with a progress bar
+ -- Verify progress bar reaches 100% and message 'Imported 3 posts' is displayed.
+   Repeat IMP02
+ -- Verify as per IMP02, but there are now exact duplicates of all three posts
+
+LPB Import using local Personal blog
+====================================
+
+LPB01 / S1
+   Enter TC2 and select blog IB04, then select 'Import pages' button
+ -- Verify user's personal blog is displayed in blog list according to following rules:
+ -- User has not visited their personal blog - Not displayed
+ -- User has no posts in their personal blog - Displayed, but with no link
+ -- User has posts in their personal blog - Displayed, with link
+   If no personal blog posts available visit the personal blog (/mod/oublog/view.php)
+   Add 1 new post (any content, private visibility) to the personal blog
+   Repeat this test step.
+
+LPB02 / S1
+   Select user S1's personal blog from the Import pages blog list
+   Select any post available to import and start the importing process
+ -- Verify the post imported process completed correctly
+   Select Continue button
+ -- Verify you are returned to user S1's personal blog.
+
+LPB03 / S1
+   Enter the personal blog for user S1 (/mod/oublog/view.php)
+ -- Verify 'Import posts' button is not available.
+
+LPB04 / admin (change)
+   Enter the personal blog for user admin (/mod/oublog/view.php)
+   Select Edit settings under OU blog administration (Administration block)
+   Check 'Enable post import' checkbox
+   Select Save and display
+ -- Verify 'Import posts' button is now shown next to 'New blog post' button.
+
+LPB05/ S1 (change)
+   Enter the personal blog for user S1 (/mod/oublog/view.php), then select 'Import pages' button
+   Select link to IB01
+   Select 'Include in import' checkbox for one post - CRE06
+   Select 'Import posts'
+ -- Verify page changes and 'Importing posts:' is displayed along with a progress bar
+ -- Verify progress bar reaches 100% and message 'Imported 1 posts' is displayed.
+
+LPB06 / S1
+   Select the 'Continue' button
+ -- Verify personal blog view page displayed for user S1
+ -- Verify CRE06 post now displays as a private post, check content, tags and attachments against original
+   Select 'Permalink' for post CRE06
+ -- Verify 1 comment is displayed (by user s1), check content.
+
+RPB Import using remote personal blog
+=====================================
+
+Note that this test requires a separate test server with personal blog enabled(referred to as remote in this test).
+Both servers will need to be configured to enable page importing between them prior to testing.
+The S1 test user must have identical usernames on both servers.
+
+RPB01 / admin
+   Access the remote server
+   Enter the personal blog for user admin (/mod/oublog/view.php)
+   Select Edit settings under OU blog administration (Administration block)
+   Check 'Enable post import' checkbox
+   Select Save and display
+ -- Verify 'Import posts' button is now shown next to 'New blog post' button.
+
+RPB02 / S1 (change)
+   Access the remote server
+   Enter the personal blog for user S1 (/mod/oublog/view.php)
+   Select the 'Blog options' link
+   Alter the blog name to identify that the blog is on the remote server, Save changes
+   Select 'Import posts' button
+ -- Verify a list of courses and blogs is displayed that correspond to the original test server
+ -- Verify course TC1, blog IB01 is displayed.
+
+RPB03 / S1
+   Select blog IB01 from the import posts page
+    -- Verify page changes, and shows:
+ -- Import from: [TC1 shortname and full name] : IB01
+ -- A table with 'Title', 'Date posted', 'Tags' and 'Include in import' columns
+ -- Table should contain 3 rows:
+ -- CRE06, [Date post was created], a
+ -- Untitled post 1, [Date post was created], a,b
+ -- Untitled post 2, [Date post was created], a,b,c.
+
+RPB04 / S1
+   Select 'Include in import' checkbox for all three posts shown
+   Select 'Import posts'
+ -- Verify page changes and 'Importing posts:' is displayed along with a progress bar
+ -- Verify progress bar reaches 100% and message 'Imported 3 posts' is displayed
+   Select the 'Continue' button
+ -- Verify S1 user personal blog view page displayed
+ -- Verify 3 posts now display, check content, tags and attachments against original
+   Select 'Permalink' for post CRE06
+ -- Verify 1 comment is displayed (by user s1), check content.
+
+RPB04 / S1
+   Access original server used in earlier tests
+   Enter TC2 and select blog IB04, then select 'Import pages' button
+ -- Very user S1's personal blog is displayed twice, one name should match name set in RPB02
+
+RPB05 / S1
+   Select link for personal blog on remote server from the import posts page
+ -- Verify a table of posts is displayed; this should include the 3 posts imported in RPB04
+   Select 'Include in import' checkbox for all three posts imported from IB01 in RPB04
+   Select 'Import posts'
+ -- Verify 'Imported 0 posts' displayed
+ -- Verify message '3 posts to import were identified as conflicts with existing posts.' displayed
+   Select 'Import conflicting posts' button
+ -- Verify page changes and 'Importing posts:' is displayed along with a progress bar
+ -- Verify progress bar reaches 100% and message 'Imported 3 posts' is displayed
+   Select the 'Continue' button
+ -- Verify IB04 blog view page displayed
+ -- Verify the 3 posts now display (these have highest post number when looking at permalink url),
+    check content, tags and attachments against original
+   Select 'Permalink' for post CRE06
+ -- Verify 1 comment is displayed (by user s1), check content.
diff --git a/mod/oublog/internaldoc/testcase.oualertreport.txt b/mod/oublog/internaldoc/testcase.oualertreport.txt
new file mode 100644
index 0000000..c802a50
--- /dev/null
+++ b/mod/oublog/internaldoc/testcase.oualertreport.txt
@@ -0,0 +1,215 @@
+This script describes steps to test the OU blog interface with the OU alert facility
+perspective. It is intended to cover most of the UI and features.
+
+NOTE:
+In this test case, the word 'blog' always refers to the OU blog.
+This does not cover the specifics of the OU alerts functionality itself -
+only the interface with oublog.
+
+The test steps in this script follow on from each other and aren't independent.
+
+
+Initial setup
+=============
+
+This test case requires:
+
+-  access to multiple valid email account(s) for testing reporting email addresses use.
+
+-  a course blog which is visible to the world, with posts which are visible to the world.
+-  a student user U S1
+   Ensure that the admin role has the report/oualerts:managealerts capability.
+
+The test server must have debugging set to DEVELOPER level and to display errors
+during all parts of the test script, there should be no debugging warnings.
+
+
+CRE Creating blogs and data
+===========================
+
+CRE01 / admin
+   In your test course, create a blog called 'CRE01' with the following settings.
+   Set 'Allow comments' to Yes, from everybody (even if not logged in).
+   Leave 'Individual blogs' at the default setting.
+   Set 'Maximum visibility' to visible to anyone in the world.
+   In 'Reporting email addresses' enter one or more address(s), these need to be separated by commas.
+   Leave all other settings at their defaults.
+   Click 'Save and return to website'.
+
+CRE02 / admin
+   Enter the blog 'CRE01'.
+   Click 'New blog post' to add a new post, with title 'CRE02-1' and text 'Admin Post No one'.
+   Change the setting of 'Allow comments' to Yes, from everybody(even if not loggd in).
+   Change the setting of 'Who can read this' to Visible to anyone in the world
+   Click 'Add blog post' to save the post and return to the blog'
+
+CRE03 / admin
+   Click 'New blog post' to add a new post, with title 'CRE03-1' and text 'Admin Post No two for deletion.'.
+   Change the setting of 'Allow comments' to Yes, from everybody(even if not loggd in).
+   Change the setting of 'Who can read this' to Visible to anyone in the world
+   Click 'Add blog post' to save the post and return to the blog'
+
+CRE04 / admin
+   Click 'Add your comment' to add a new comment, to the first post 'CRE02-1' give it the title
+   'CRE02-1-C1' and text 'Admin Post No one comment No one'.
+   Click 'Add your comment' to add a second comment, with no title, but the text
+   'Admin Post No one comment No two for deletion'.
+
+CRE05 / U.S1 [change]
+   Go to blog CRE01.
+   Click 'New blog post' to add a post, with title 'CRE04-1' and text 'US1 Post No one'.
+   Change the setting of 'Allow comments' to Yes, from everybody(even if not loggd in).
+   Change the setting of 'Who can read this' to Visible to anyone in the world
+   Click 'Add blog post' to save the post and return to the blog'
+
+CRE06 / U.S1
+-  Confirm that Admin posts show a set of links including 'Report post'.
+-  Confirm that the US1 post shows the set of links excluding 'Report post'.
+
+CRE07 / U.S1
+   Click 'Permalink' beneath the Admin post 'CRE02-1' to view the post and comments.
+-  Verify that each Admin comment has a 'Report comment' link visible.
+   Click 'Add your comment' to add a comment, with title 'CRE02-1-C2' and text
+   'US1 Post CRE02-1-C2 comment No three.'.
+   Click 'Add your comment' to add another new comment, with no title, but the text
+   'US1 Post CRE02-1-C3 comment No four for deletion.'.
+
+CRE08 / U.S1
+-  Verify that neither US1 comment has a 'Report comment' link visible.
+   Click to delete the untitled US1 comment.
+-  Confirm that the comment is no longer visible by the student user.
+
+CRE10 / admin [change]
+   Enter blog 'CRE01'.
+   Click 'Permalink' beneath the post 'CRE02-1' to view the post and its comments.
+-  Confirm that post 'CRE02-1' has 4 comments two by each user.
+   Admin comments; 'CRE02-1-C1' and an untitled comment, both with 'Delete' links.
+   User one comments; 'CRE02-1-C2' with 'Delete' and 'Report comment' links, and an untitled comment,
+   deleted by Student user one showing no links beneath.
+
+CRE11 / admin
+   Delete the untitled Admin comment 'Admin Post No one comment No two for deletion'.
+-  Confirm that the comment is now marked as Deleted by Admin user,
+   and that it now has no links beneath it.
+
+
+BSC Basic usage
+===============
+
+BSC01 / admin
+   Go to blog 'CRE01'.
+-  Verify that the 'Report post' link is only visible in the Student user post.
+   Click to delete 'CRE03-1' Admin post for deletion.
+-  Confirm that the post is now marked as deleted by the Admin, and that the only link available
+   for it is the 'Permalink' link.
+
+BSC02 / admin
+   Open the Administration menu to the left of the posts.
+   Open the OU Blog administration menu
+-  Verify that the last option on the menu is 'Manage reported post/comment alerts'.
+
+BSC03 / admin
+   Click 'Permalink' beneath the top post 'CRE04-1' to view the post.
+   Note the id of the post on the URL in the Browser Address bar.
+   Click the 'Report post' link for this post.
+-  Confirm that the 'Report abuse' page loads.
+
+BSC04 / admin
+-  Verify that the navigation crumb trail contains a link back to the post, and when hovered over,
+   that the URL and post id are the same as recorded above.
+-  Verify that there is also a link back to the post above the text, 'The Alert feature will send
+  the alerted content to a staff member who will investigate.', and that this link has the same URL.
+-  Verify that the page shows 'Reasons for Alert' as a required field, with
+   6 checkboxes for selecting abuse statements, and a large text entry box for 'Other information'.
+-  Verify that 'Reporter details' appear beneath the box, followed by the
+   'Send alert' and 'Cancel' buttons.
+
+BSC05 / admin
+   Click the checkbox beside 'It is against the rules for some other reason.'
+   Enter 'BSC05 Admin testing the OU Blog Alert interface.'
+   Click 'Send alert'.
+
+BSC06 / admin
+   Confirm that you are returned to the 'CRE01' blog view page,
+   and that an email has been recieved by the testaccount(s).
+
+BSC07 / U.S1 [change]
+   Enter 'CRE01'.
+-  Confirm that only the remaining visible Admin user post shows the 'Report post' link.
+
+BSC08 / U.S1
+   Click the '2 comments' link beneath 'CRE02-1'.
+-  Confirm that the viewpost page opens at the first comment, and that the page displays
+   the post 'CRE02-1' and two comments.
+-  Verify that only the Admin comment has a 'Report comment' link.
+Note: The previously deleted comments are not visible to the student user.
+
+BSC09 / U.S1
+   Note the id of the post on the URL in the Browser Address bar.
+Note: You may need to highlight the URL to read this, in IE for example.
+   Click the 'Report comment' link below the comment by user Admin.
+-  Confirm that the 'Report abuse' page loads.
+   Take note of the itemid from the URL in the address bar.
+-  Verify that the navigation crumb trail contains a link back to the post, and when hovered over,
+   that the URL contains the post and #cid which matches the itemid recorded above.
+-  Verify that there is also a link back to the post above the text 'The Alert feature will send
+   the alerted content to a staff member who will investigate.' and that this link has the same URL.
+-  Verify that the page shows 'Reasons for Alert' as a required field, with
+   6 checkboxes for selecting abuse statements, and a large text entry box for 'Other information'.
+-  Verify that 'Reporter details' appear beneath the box, followed by the
+   'Send alert' and 'Cancel' buttons.
+
+BSC10 / U.S1
+   Click the checkbox beside 'It is against the rules for some other reason.'
+   Enter 'BSC10 US1 testing the OU Blog Alert interface as a user.'
+   Click 'Send alert'.
+
+BSC11 / U.S1
+-  Confirm that you are returned to the viewpost page with the selected comment placed at the top
+   of the screen showing the post 'CRE02-1'
+-  Verify that an email has been received by the testaccount(s).
+-  Confirm the address in the URL contains the post and #cid previously noted.
+
+BSC12 / U.S1
+   Click the 'Report comment' link again.
+   Confirm that the 'Report abuse' page loads.
+-  Verify that 'Reporter details' appear beneath the box, followed by the
+   'Send alert' and 'Cancel' buttons.
+
+BSC13 / U.S1
+   Click 'Cancel'.
+-  Confirm that you are returned to the viewpost page with the selected comment placed at the top
+   of the screen for the post 'CRE02-1' and its comments
+-  Verify that no new email has been received by the testaccount(s).
+
+BSC14 / U.S1
+   Select and copy the URL in the address bar.
+   Open a different Web Browser and paste the URL into the address bar.
+-  Confirm that you are presented with the viewpost page with the selected comment placed at the top
+   of the screen for the post 'CRE02-1' and its 2 student visible comments.
+-  Verify that the post does not display a 'Report post' link along side the 'Permalink' and
+   'Add you comment' links, beneath the post.
+-  Verify that the comments do not display 'Report comment' links.
+
+BSC15 / admin [Change]
+   Enter 'CRE01'.
+   Click the Administration link 'Manage reported post/comments'.
+-  Confirm that the OU Alerts management page opens, showing a record of the alerts generated
+   during the testcase.
+
+BSC16 / admin
+   Return to the course and enter the blog 'CRE01'
+   Click the OU Blog administration link, 'Edit settings'.
+   Remove the 'Reporting email addresses' setting for the blog 'CRE01' so there are no email addresses.
+   Save and display.
+
+BSC17 / admin
+   Confirm that the 'Report post' link is no longer available in posts.
+   Confirm that the 'Report comment' link is no longer available in comments.
+
+BSC18 / tester
+   Confirm that emails notifying the testaccounts have been received and contain
+   information regarding the individual posts or comments including links to those items.
+
+End test.
+=========
diff --git a/mod/oublog/internaldoc/testcase.participation.txt b/mod/oublog/internaldoc/testcase.participation.txt
new file mode 100644
index 0000000..1a748eb
--- /dev/null
+++ b/mod/oublog/internaldoc/testcase.participation.txt
@@ -0,0 +1,442 @@
+This script describes steps to test the participation facility from a user
+perspective. It is intended to cover most of the UI and features.
+
+NOTE: In this test case, the word 'blog' always refers to the OU blog.
+
+The test steps in this script follow on from each other and aren't independent.
+They may also be used in conjunction with testcase.usagestats, which should be ran second.
+
+
+Initial setup
+=============
+
+This test case requires:
+
+- a course which has at least two groups defined (G1 and G2).
+- two test users with Student role (U S1, who is in group G1, and U S2, in group G2).
+- one test user (U T1) who has the Teacher role is in group G1.
+- (admin must have permissions to create/configure activities)
+- All users should have an avatar (user picture) set for their profile
+
+The test server must have debugging set to DEVELOPER level and to display
+errors; during all parts of the test script, there should be no debugging
+warnings.
+
+The completion system must be enabled for (a) the site, and (b) the test
+course.
+
+Show blog usage extra statistics must also be enabled in each blog.
+
+CRE Creating blogs and data
+===========================
+
+CRE01-SG / admin
+   In your test course, create a blog called TP.CRE01-SG which is set to separate groups.
+   Go to the Permissions page for this blog and set it (if necessary) so
+   that the Teacher role DOES have the accessallgroups capability in this
+   blog.
+
+CRE02-SG / U S1 [change]
+   Go to blog TP.CRE01-SG (you should be in group G1).
+   Add a new post with title "CRE02-1" and text "One".
+
+CRE03-SG / U S2 [change]
+   Go to blog TP.CRE01-SG (you should be in group G2).
+   Add a new post with title "CRE03-1" and text "Two".
+
+CRE04-SG / U T [change]
+   Go to blog TP.CRE01-SG and choose group G1. Go into the first post "CRE02-1" and
+   add a comment with title "CRE04-1" and text "Three".
+   Add a new post with title "CRE04-2" and text "Four".
+
+   Return to the course main page
+
+CRE05-WC / admin [change]
+   Create a blog called TP.CRE02-WC which is a whole-course blog (no groups).
+
+CRE06-WC / U S1 [change]
+   Go to blog TP.CRE02-WC.
+   Add a new post with title "CRE06-1" and text "Five".
+
+CRE07-WC / U S2 [change]
+   Go to blog TP.CRE02-WC.
+   Click into the existing post "CRE06-1".
+   Add a comment to the post with title "CRE07-1" and text "Six".
+   Add another comment to the same post with no title and text "Seven".
+   Add a new post with title "CRE07-2" and text "Eight".
+   Add another new post with no title and text "Nine".
+
+
+CRE08-VI / admin [change]
+   Create a blog called TP.CRE03-VI which is set to visible individual blogs and no groups.
+
+CRE09-VI / U S1 [change]
+   Go to blog TP.CRE03-VI (you should be in the visible individual blog for U S1).
+   Add a new post with title "CRE09-1" and text "Ten".
+
+CRE010-VI / U S2 [change]
+   Go to blog TP.CRE03-VI (you should be in the visible individual blog for U S2).
+   Change to the individual blog for U S1. View the post CRE09-1.
+   Add a comment with title "CRE010-1" and text "Eleven".
+   Add a new post with title "CRE010-2" and text "Twelve".
+
+
+BSC Basic usage
+===============
+
+BSC01-SG / U T [change]
+   Go to blog TP.CRE01-SG.
+-  Verify that when either 'Separate groups' G1 or G2 are selected, there is a button
+  'New blog post' alongside the 'Participation by user' button.
+   Delete the post "CRE04-2" by UET Teacher user.
+-  Verify that the "Blog usage" 'block' on the right, contains three 'blocks';
+  'My participation summary', 'Participation' and 'Most commented posts'.
+
+BSC02a-SG / U T
+  - Verify that the 'My participation summary' block resembles the following;
+
+    My participation summary
+    ------------------------
+    No posts made.
+    1 comments
+    _U T_    _CRE04-1_
+    _avatar_
+             Tuesday, 6 May 2014, 14:47
+    _View my participation_
+
+ - Verify that the deleted post 'CRE04-2' is not shown.
+ - Verify that clicking the 'CRE04-1' link opens the 'viewpost' page for the post 'CRE02-1'
+   which contains comment 'CRE04-1'.
+
+    Return to the blog view.
+
+BSC02b-SG / U T
+   From the Separate groups selector choose 'G1'.
+ - Verify that clicking the 'View my participation' link opens the 'User participation'
+   page for the current user, the teacher user.
+ - Confirm that the page contains:
+      A 'Separate groups' selector, set at the second option 'G1'.
+      A time filter selection form 'Participation - All time',
+      which defaults to todays date, and is disabled.
+      Two tabs '0 Posts' and ' 1 Comments'.
+ - Verify that the 'Posts' tab contains
+      A message box stating; 'No posts made during this period.'
+ - Verify that the 'Comments' tab contains
+      A download button, with 'Comments' area beneath and that the comment
+      'CRE04-1' with the text 'Three' on the post 'CRE02-1' is displayed.
+
+   Return to the blog view.
+
+BSC03-SG / U T
+   From the Separate groups selector choose 'All participants'.
+ - Verify that the 'Participation' block resembles the following;
+
+    Participation
+    -------------
+    Recent posts
+    _Us2_    _CRE03-1_
+    _avatar_
+             Tuesday, 6 May 2014, 14:44
+             _G2's blog_
+    _Us1_   _CRE02-1_
+    _avatar_
+             Tuesday, 6 May 2014, 14:43
+             _G1s blog_
+    Recent comments
+    _U T_    _CRE04-1_
+    _avatar_
+             Tuesday, 6 May 2014, 14:47
+             _G1s blog_
+    View all participation
+    ----------------------
+
+ - Verify that clicking the 'CRE03-1' link opens the 'viewpost' page for the post.
+   Return to the blog view.
+ - Verify that clicking the link 'G2s blog', refreshes the page and resets the
+   groups selector to G2 and that only the post 'CRE03-1' is visible.
+   Return to the blog 'All participants' view.
+ - Verify that clicking the 'CRE02-1' link opens the 'viewpost' page for the post,
+   with the comment 'CRE04-1' visible.
+   Return to the blog 'All participants' view.
+ - Verify that clicking the 'CRE04-1' link opens the 'viewpost page for the post 'CRE02-1'
+   which contains the comment CRE04-1 visible at the top of the screen.
+   Return to the blog 'All participants' view.
+
+ BSC04-SG / U T
+
+ - Verify that clicking the 'View all participation' link opens the 'View all participation'
+   page for the current blog.
+ - Confirm that the page contains: a 'Separate groups' selector set to 'All participants',
+   a time filter selection form, which defaults to todays date, and is disabled.
+ - Confirm that beneath are two tabs, containing tables, resembling the following;
+
+    2 Posts
+    -------
+    User                           Title        Date                          Blog
+    _Us2_     Second Usertwo       _CRE03-1_    Tuesday, 6 May 2014, 14:44    _G2's blog_
+    _avatar_  Username
+
+    _Us1_     Userone Usernameone  _CRE02-1_    Tuesday, 6 May 2014, 14:43    _G1's blog_
+    _avatar_
+
+
+    1 Comments
+    ----------
+    User                           Title        Date                            Post
+   _U T_      UETuser Teacher      _CRE04-1     Tuesday, 6 May 2014, 14:47      _Us1_     _CRE02-1_
+   _avatar_                                                                     _avatar_  Wednesday, 6 May 2014,
+                                                                                          14:43
+                                                                                         _G1's blog_
+
+   Return to the blog page
+
+BSC05-SG / U T
+   Select 'G1' from the 'Separate groups' selector.
+ - Verify that the post 'CRE03-1' by US2, is no longer visible.
+ - Confirm that the 'CRE02-1' recent posts link opens the viewpost page for the post with comment 'CRE04-1'.
+ - Confirm that the 'CRE04-1' recent comments link opens the viewpost page for the post'CRE02-1',
+   with the comment at the top of the screen.
+ - Verify that clicking the 'View all participation' link opens the 'View all participation'
+   page for the current blog with the 'Separate groups' selector set at G1.
+
+    Return to the blog page
+
+BSC06-SG / U T
+   Click the 'Participation by user' button. The 'User participation' list page should load.
+ - Verify that there is a 'Separate groups' selector.
+   Choose group 'G1' if necessary.
+ - Verify that there is a time filter form, defaulted to "Participation - All time".
+   Confirm that there is a 'Download table data as' selector, and that the only option is
+   'Comma separated values text file' followed by a 'Download' button.
+ - Verify that the list of users shows U S1 and U T (everyone who is in group G1).
+ - The counts should be:
+     User       Posts   Comments
+     U T        0       1
+     _avatar_
+     Us1        1       0
+     _avatar_
+
+BSC07-SG / U T
+   Click the details link beside the teacher user.
+ - Verify that the time filter form  defaults to "Participation - All time".
+ - Verify the there are tabs 'Posts' and 'Comments'.
+ - Confirm that the comment box beneath the 'Posts' tab states
+  'No posts made during this period'.
+  Click the 'Comments' tab
+ - Confirm that on the tab there is a 'Download data as' button.
+ - Verify that there is an area headed 'Comments by Teacher user' containing
+   the single comment 'CRE04-1' on post 'CRE02-1' with the text 'Three'.
+
+BSC08 / U T
+   Click to enable the 'To date' in the time filter form, select the date previous
+   to the posted comment, and click update.
+ - Verify that there are now neither posts nor comments displayed by the page.
+
+   Return to the course main page
+
+BSC09 / U T
+   Go to blog TP.CRE02-WC.
+   Click the 'Participation by user' button.
+ - U T should be included on the list even though they did not do anything in
+   this blog.
+ - The counts should be:
+     USER  Posts | Comments
+     U S1    1   |    0
+     U S2    2   |    2
+     U T     0   |    0
+
+BSC10 / U T
+   Click on the 'Details' link next to U S2.
+-  Verify that you are taken to a 'User participation' page for student user U S2.
+-  Verify that the page has a default title 'Participation - All time' with a date
+   selector form showing date selectors, enabling check boxes and an update button.
+   Beneath this form should be two tabs, 'Posts' and 'Comments'.
+-  The 'User participation' page should appear similar to the following:
+
+   Participation - All time
+   -----------------------
+        From [?] day month year [] Enable
+             To  day month year [] Enable
+             [Update]
+
+   /_2 Posts_\ _2 Comments_ {Posts tab active}
+                     Download data as [Comma separated values text file]
+                     ----------------
+
+    Posts by U S2
+    -------------
+
+    _Tuesday 6 May 2014, 15:13_
+    Nine
+
+    _CRE07-2_
+    Tuesday 6 May 2014, 15:12
+    Eight
+
+BSC11 / U T
+   Click to open the Comments tab
+ - The 'Comments' tab should appear similar to the following;
+
+    _2 Posts_/_2 Comments_\  {Comments tab active}
+
+    Comments by U S2
+    ----------------
+
+      Comment on _CRE06-1_ by _U S1_
+      Tuesday 6 May 2014, 15:11
+      Seven
+
+
+      Comment on _CRE06-1_ by _U S1_
+      CRE07-1
+      ___________________________________________________________________
+      Tuesday 6 May 2014, 15:11
+      Six
+
+BSC12 / U T
+   Click to enable the 'To' date in the time filter form, select a previous days date,
+   and click update.
+-  Verify that there are now neither posts nor comments displayed by the page.
+
+   Return to the course main page
+
+BSC13 / U T
+   Go to blog TP.CRE03-VI.
+   Click the 'Participation by user' button.
+ - The counts should be:
+           Posts | Comments
+      U S1   1   |    0
+      U S2   1   |    1
+      U T    0   |    0
+
+   Return to the blog view page
+
+BSC14 / U T
+   From the 'Visible individuals' selector choose 'View all users'.
+ - Verify that the 'Participation' block resembles the following;
+
+    Participation
+    -------------
+    Recent posts
+    _Us2_    _CRE010-2_
+    _avatar_ Tuesday, 6 May 2014, 15:26
+             _US2 username's blog_
+    _Us1_   _CRE09-1_
+    _avatar_Tuesday, 6 May 2014, 15:21
+             _US1 username's blog_
+    Recent comments
+    _Us2_    _CRE010-1_
+    _avatar_ Tuesday, 6 May 2014, 15:23
+             _US1's blog_
+    View all participation
+    ----------------------
+
+ - Verify that clicking the recent posts 'CRE010-2' link opens the 'viewpost' page
+   for the post.
+   Return to the blog view.
+ - Verify that clicking the recent posts link 'US2's blog', refreshes the page
+   resetting the 'Individuals' selector to US2 and that only the post 'CRE010-2' is visible,
+   both in the main body of the page and within the 'Participation' block.
+   Return to the blog 'View all users' view.
+ - Verify that clicking the recent comments link 'CRE010-1' link opens the 'viewpost'
+   page for the post 'CRE09-1', with the comment 'CRE010-1' visible at the top of the page.
+   Return to the blog 'View all users' view.
+ - Verify that clicking the recent comments link 'US1's blog link refreshes the page
+   resetting the 'Individuals' selector to US1 and that only the post 'CRE09-1' is visible,
+   in the main body of the page
+ - Confirm that the recent posts area has only the post 'CRE09-1' made by US1, with the date
+   underneath but no user link provided.
+ - Confirm that the recent comments area has only the comment 'CRE010-1' made by US2, with the date
+   underneath but no user link provided..
+   Return to the blog 'View all users' view.
+
+
+FIL File download
+=================
+
+FIL01-SG / admin [change]
+   Go to the blog TP.CRE01-SG.
+   Select group 'G1'. Click the 'Participation by user' button, to enter the
+   'User participation' page.
+ - Verify that there is a download table data option and that CSV is one of the available
+   formats (or possibly the only available format).
+   Do a CSV download of the data.
+ - Verify that the download is as follows (with possible differences regarding
+   quoting, course name, user names, etc.):
+
+     MY-COURSE-SHORTNAME, TP.CRE01-SG, G1
+     User,Posts,Comments
+     U S1, 1, 0
+     U T,  0, 1
+
+
+GRD Grading
+===========
+
+GRD01-SG / admin
+   Edit the blog TP.CRE01-SG settings and set grading option to the
+   'Separate and Connected ways of knowing' scale.
+   Click Save and display.
+   Go to the  'Participation by user' page.
+ - Verify that a Grade column now shows in the table.
+ - Verify that it shows existing grade as unset for everyone, ie 'No grade'.
+ - Verify that the dropdowns have options as per the scale
+   ('Mostly Connected', Separate and connected', or 'Mostly separate' knowing).
+   Edit blog settings again and set grading option to the 0..10 numeric scale.
+   Click Save and display.
+   Go back to the 'User participation' list page.
+ - Verify that grade dropdowns now have options 0/10..10/10 as well as 'No grade'.
+
+GRD02-SG / admin
+   Edit the blog TP.CRE01-SG settings and set the completion option to automatic completion ie.
+   'Show activity as complete when conditions are met'
+   In the form, temporarily turn off the grading option.
+ - Verify that the 'Require grade' checkbox is greyed out.
+   Turn the grading option back on (to 0..10 numeric scale again).
+ - Verify that the 'Require grade' checkbox is now available.
+   Tick the 'Require grade' checkbox and save changes.
+
+GRD03-SG / U T [change]
+   Go to the blog TP.CRE01-SG, select group G1, click 'Participation by user'
+   to open the 'User participation' list page.
+ - Verify that Grade column displays and shows existing grade as unset, (ie No grade.)
+   Change grade for U S1 to 5/10 and U T to 10/10.
+   Click 'Save grades' button.
+ - Verify that the page reloads and now displays the new grades 5/10, 10/10.
+   Change grade for U T back to 'No grade', (ie 'not set').
+   Click 'Save grades' button.
+ - Verify that page reloads and shows U T as 'No grade'.
+
+GRD04-SG / U T
+   Go to the course Grader report.
+ - Verify that there is a column relating to the blog TP.CRE01-SG.
+ - Verify that the grades in this column are 50% for U S1 and not set for
+   other users.
+
+GRD05-SG / U T
+   Go to course page.
+ - Verify that automatic tickbox icon next to the blog is not ticked (this
+   may mean it's invisible, depending on the icon in use).
+   Go to TP.CRE01-SG, group G1, participation list.
+   Click into the details page for U T.
+ - Verify that the Grade dropdown is shown at the bottom of the 'User grade' tab page
+   and is currently showing unset.
+   Change the grade for U T to 7/10 and save changes.
+ - The 'User participation' list page should now reload, showing the new 7/10 grade.
+   Click in Details page for U T.
+ - Verify that the 'User grade' tab now shows as 7/10 here too.
+   Return to course page.
+ - Verify that the automatic tickbox beside TP.CRE01-SG is now ticked.
+
+
+PER Permalink
+=============
+
+(Not really related to participation but tested here.)
+
+PER01
+   Go to a blog which contains some posts, such as TP.CRE01-SG.
+ - Verify that all posts have a 'Permalink' link below them (those with
+   comments and those without)
+   Click one of the Permalink links.
+ - Verify that it takes you to the viewpost.php view page for that post.
diff --git a/mod/oublog/internaldoc/testcase.rating.txt b/mod/oublog/internaldoc/testcase.rating.txt
new file mode 100644
index 0000000..8eab10f
--- /dev/null
+++ b/mod/oublog/internaldoc/testcase.rating.txt
@@ -0,0 +1,199 @@
+This script describes steps to test the participation facility from a user
+perspective. It is intended to cover most of the UI and features.
+
+NOTE: In this test case, the word 'blog' always refers to the OU blog.
+
+The test steps in this script follow on from each other and aren't independent.
+They may also be used in conjunction with testcase.usagestats, which should be ran second.
+
+
+Initial setup
+=============
+
+This test case requires:
+
+- one test user (US1) with the Student role.
+- one test user (U T) with the Teacher role.
+- (admin must have permissions to create/configure activities)
+- All users should have an avatar (user picture) set for their profile
+
+The test server must have debugging set to DEVELOPER level and to display
+errors; during all parts of the test script, there should be no debugging
+warnings.
+
+
+CRE Creating blogs and data
+===========================
+
+
+CRE01-RP / admin
+   In your test course, create a blog called CRE01-RP.
+   Edit the blog settings and expand 'Grade' and 'Ratings'.
+   Set 'Grading' to 'Use ratings'.
+-- Confirm that for 'Grade', 'Type', 'Scale' and 'Maximum points' settings are disabled.
+-- Confirm that the 'Rating', 'Roles with permission to rate' states that;
+   'Capability check not available until activity is saved'.
+   Set 'Aggregate type' to 'Average of ratings'.
+   Set 'Scale' 'Type' to Point, and 'Maximum points' to 100.
+   Leave 'Restrict ratings to items with dates in this range' at the default, not ticked.
+   Click Save and display.
+
+CRE02-RP / admin
+   In blog CRE01-RP.
+   Add a new post with title "Admin test post ratings 001" and text
+   "A post for test rating purposes.".
+
+CRE03-RP / U T [change]
+   Go to blog CRE01-RP.
+-- Confirm that on the Admin post there is an 'Average of ratings' dropdown selector above the
+   Permalink, Edit, ect links.
+-- Confirm the default option is Rate, and that the point scale available is '0 - 100'.
+-- Verify that there is a link before the dropdown selector, to a new window 'All submitted ratings'
+
+CRE04-RP / U T
+   Add a new post with title "Teacher testing post ratings 002" and text
+   "Second post for test rating purposes.".
+-- Confirm that for UT post there is an 'Average of ratings' label above the
+   Permalink, Edit, ect links.
+-- Verify that there is only a link following the label.
+Note: The current user can not rate their own posts, but can see 'All ratings submitted' link.
+
+CRE05-RP / US1 [change]
+   Go to blog CRE01-RP.
+-- Confirm that as a student no post has an 'Average of ratings' label, link or dropdown shown.
+   Add a new post with title "Student testing post ratings 003" and text
+   "Third post for test rating purposes.".
+-- Confirm that an 'Average of ratings' label exists on this post, but no link.
+
+CRE06-RP / admin [change]
+   Go to blog CRE01-RP.
+-- Verify that the student and teacher posts each have an 'Average of ratings' label,
+   link and dropdown shown.
+-- Verify that the 'Rate' dropdowns provide a point scale from 0 - 100.
+-- Confirm that the Admins post does have the 'Average of ratings' label and link,
+   but that there is no dropdown available
+Note: The current user can not rate their own posts, but can see 'All ratings submitted' link.
+
+CRE07-RP / admin
+   On the student post, select 10 on the 'Rate' dropdown.
+-- Confirm that the link and dropdown refreshes, and that the link and dropdown now show
+   '10 (1) [10  ]'.
+
+CRE08-RP / admin
+   On the teacher post, select 10 on the 'Rate' dropdown.
+-- Confirm that the link and dropdown refresh, and that the link and dropdown also show
+   '10 (1) [10  ]'.
+
+CRE09-RP / U T [change]
+-- Confirm that on the student post the label link and dropdown show as
+   'Average of ratings: 10 (1) [Rate  ]'.
+-- Confirm that on the teacher post the label 'Average of ratings:' and link '10 (1)' show.
+-- Confirm that on the admin post the link and dropdown show as 'Average of ratings: _ [Rate  ]'.
+
+CRE010-RP / U T
+   On the admin post, select 30 on the 'Rate' dropdown.
+-- Confirm that the link and dropdown refresh, and that the link and dropdown now show
+   '30 (1) [30 ]'.
+
+CRE011-RP / U T
+-- Confirm that on the student post, there is a link '10 (1)' to 'All submitted ratings '.
+-- Confirm that on the admin post, there is a link '30 (1)' to 'All submitted ratings '.
+
+CRE012-RP / US1 [change]
+   Go to blog CRE01-RP.
+-- Confirm that the student post has an 'Average of ratings' label showing '10 (1)',
+   but that this is not a link.
+-- Verify that the neither the teacher nor admin posts show an 'Average of ratings' label.
+
+   Return to the course main page
+
+CRE013-RP / U T [change]
+   Select 'Grades' from the 'Administration' menu to open the 'Grader report'
+-- Confirm that the report resembles the following:
+Note: It may be necessary to click the 'Full view' button, to see Course total.
+
+[Grader report       ] (Selector)
+
+Grader report
+-------------
+
+All participants: 1/1
+                        First name :AllABCDEFGHIJKLMNOPQRSTUVWXYZ
+                        Surname :AllABCDEFGHIJKLMNOPQRSTUVWXYZ
+
+                                                Test course name
+Surname  First name                     Email address    Blog CRE01-RP  Agg Course Total
+avatar   Userone  Usernameone   Grades  us1@open.ac.uk           10.00             10.00
+
+                                        Overall average          10.00             10.00
+
+
+Time restricted rating tests [wait at least 5 minutes for these steps]
+----------------------------
+
+CRE014-RP / admin [change]
+   In blog CRE01-RP.
+   Add a new post with title "Admin restricted ratings post 001" and text
+   "A post for test rating restrictions.".
+
+CRE015-RP / admin
+   In blog CRE01-RP.
+   Enter 'Edit settings'.
+   Tick the checkbox against 'Restrict ratings to items with dates in this range:'.
+   Select 'From' and 'To' time to bracket the just created post.
+
+CRE016-RP / U T [change]
+-- Verify that the admins restricted ratings post has an 'Average of ratings'
+   label and link, and that the dropdown is shown.
+-- Verify that the 'Rate' dropdown provides a point scale from 0 - 100.
+
+CRE017-RP / U T
+-- Confirm that the other posts outside the restricted time period have the 'Average of ratings'
+   label and link, but that there is no dropdown available to rate them now.
+
+CRE018-RP / U T
+   Edit the blog settings and expand 'Grade' and 'Ratings'.
+   Set 'Grading' to 'Teacher grades students'.
+   Set 'Grade' 'Type' to 'Point'.
+   Set 'Maximum points' to 100.
+-- Confirm that the 'Rating', 'Roles with permission to rate' states that;
+   'Manager, Teacher, Non-editing teacher'.
+-- Confirm that the 'Aggregate type' is set to 'Average of ratings'.
+-- Confirm that the 'Scale' 'Type' is set to Point, and that 'Maximum points' is set to 100.
+   Leave 'Restrict ratings to items with dates in this range' at the default, not ticked.
+   Click Save and display.
+
+CRE019-RP / admin [change]
+-- Confirm that the restricted admin post has an 'Average of ratings'
+   label and link, and that the dropdown is is not shown.
+   Click the 'Participation by user' button.
+-- Confirm that the 'User participation' page shows a 'Grades' dropdown against each user.
+   Select 10 for the student user and 30 for the teacher user.
+   Click 'Save grades' button
+-- Confirm that the page refreshes, and that the text 'Grades updated' appears beneath the
+   page title 'User participation'.
+-- Confirm that the grades entered for student user [and two are] is correct.
+
+   Return to the course main page
+
+CRE020-RP / U T [change]
+   Select 'Grades' from the 'Administration' menu to open the 'Grader report'
+-- Confirm that the report resembles the following:
+Note: It may be necessary to click the 'Full view' button, to see Course total.
+
+[Grader report       ] (Selector)
+
+Grader report
+-------------
+
+All participants: 1/1
+                        First name :AllABCDEFGHIJKLMNOPQRSTUVWXYZ
+                        Surname :AllABCDEFGHIJKLMNOPQRSTUVWXYZ
+
+                                                Test course name
+Surname  First name                     Email address    Blog CRE01-RP  Agg Course Total
+avatar   Userone  Usernameone   Grades  us1@open.ac.uk           10.00             10.00
+
+                                        Overall average          10.00             10.00
+
+End test.
diff --git a/mod/oublog/internaldoc/testcase.readonlytime.txt b/mod/oublog/internaldoc/testcase.readonlytime.txt
new file mode 100644
index 0000000..6547d93
--- /dev/null
+++ b/mod/oublog/internaldoc/testcase.readonlytime.txt
@@ -0,0 +1,132 @@
+This script describes steps to test the read-only facility from a user
+perspective. It is intended to cover most of the UI and features.
+
+NOTE: In this test case, the word 'blog' always refers to the OU blog.
+
+The test steps in this script follow on from each other and aren't independent.
+
+
+Initial setup
+=============
+
+This test case requires:
+
+- one test user (US1) with the Student role.
+- one test user (admin) with the admin or manager role.
+
+Test course (admin must have permissions to create/configure activities)
+
+The test server must have debugging set to DEVELOPER level and to display
+errors; during all parts of the test script, there should be no debugging
+warnings.
+
+
+POS Posting time limiting
+=========================
+
+POS01 / admin
+  In your test course, create a blog called POS01-RO,
+  this should have the 'Posting only allowed from' option under 'Contribution time period'
+  set to a date in the past and enabled.
+  Select 'Save and display'.
+- Verify no messages displayed above 'New post' button.
+
+POS02 / admin
+  Select 'Edit settings' from 'OU Blog administration' 'Administration' block.
+  Change 'Posting only allowed from' to a date in the future.
+  Select 'Save and display'.
+- Verify message informing that students will not be able to post until the date,
+  (but you can) is shown above 'New post' button.
+- Verify date matches that entered in settings form (dd/mm/yy, hh:mm format).
+
+POS03 / student (change)
+  Enter the test course and select link to POS01-RO blog.
+- Verify message informing that creating post is not available until date entered previously is shown.
+- Verify 'New post button' is not shown.
+
+POS04 / admin (change)
+  Enter the test course and select link to POS01-RO blog.
+  Select 'Edit settings' from 'OU Blog administration' 'Administration' block.
+  Change 'Posting only allowed until' to enabled and make a date in future (after posting from date).
+  Select 'Save and display'.
+- Verify message informing that students will not be able to post until the date,
+  (but you can) is shown above 'New post' button.
+- Verify message informing that students will not be able to post after the second date,
+  (but you can) is shown above 'New post' button.
+- Verify dates match those entered in settings form (dd/mm/yy, hh:mm format).
+
+POS05 / student (change)
+  Enter the test course and select link to POS01-RO blog.
+- Verify message informing that creating post is not available until date entered previously is shown.
+- Verify message informing that creating post will only be available until date entered previously is shown.
+- Verify 'New post button' is not shown.
+
+POS06 / admin (change)
+  Enter the test course and select link to POS01-RO blog.
+  Select 'Edit settings' from 'OU Blog administration' 'Administration' block.
+  Disable 'Posting only allowed from'.
+  Change 'Posting only allowed until' to a date in the past.
+  Select 'Save and display'.
+- Verify message informing that students are no longer be able to post after date,
+  (but you can) is shown above 'New post' button.
+- Verify date matches that entered in settings form (dd/mm/yy, hh:mm format).
+
+POS07 / student (change)
+  Enter the test course and select link to POS01-RO blog.
+- Verify message informing that creating post is not available as after date entered previously is shown.
+- Verify 'New post button' is not shown.
+
+COM Comment time limiting
+=========================
+
+COM01 / admin
+  Enter the test course and select link to POS01-RO blog.
+  Select the 'New post' button and add a new post to the blog.
+  Select 'Edit settings' from 'OU Blog administration' 'Administration' block.
+  Disable 'Posting only allowed until'.
+  Enable 'Commenting only allowed from' and set to a date in the future.
+  Select 'Save and display'.
+- Verify message informing that students will not be able to comment on posts until the date,
+  (but you can) is shown above 'New post' button.
+- Verify 'Add your comment' link is shown against the new post.
+
+COM02 / student (change)
+  Enter the test course and select link to POS01-RO blog.
+- Verify message informing that you are not able to comment on posts until the date,
+  is shown above 'New post' button.
+- Verify 'Add your comment' link is not shown against the new post.
+
+COM03 / admin (change)
+  Enter the test course and select link to POS01-RO blog.
+  Select 'Edit settings' from 'OU Blog administration' 'Administration' block.
+  Disable 'Commenting only allowed from'.
+  Change 'Commenting only allowed until' to a date in the past.
+  Select 'Save and display'.
+- Verify message informing that students are no longer be able to comment on posts as past date,
+  (but you can) is shown above 'New post' button.
+- Verify date matches that entered in settings form (dd/mm/yy, hh:mm format).
+- Verify 'Add your comment' link is shown against the new post.
+
+COM04 / student (change)
+  Enter the test course and select link to POS01-RO blog.
+- Verify message informing that you are not able to comment on posts as past date,
+  is shown above 'New post' button.
+- Verify 'Add your comment' link is not shown against the new post.
+
+COM05 / admin (change)
+  Enter the test course and select link to POS01-RO blog.
+  Select 'Edit settings' from 'OU Blog administration' 'Administration' block.
+  Change 'Commenting only allowed until' to a date in the future.
+  Select 'Save and display'.
+- Verify message informing that students will not be able to comment on posts after date,
+  (but you can) is shown above 'New post' button.
+- Verify date matches that entered in settings form (dd/mm/yy, hh:mm format).
+- Verify 'Add your comment' link is shown against the new post.
+
+COM06 / student (change)
+  Enter the test course and select link to POS01-RO blog.
+- Verify message informing that you will not able to comment on posts after date,
+  is shown above 'New post' button.
+- Verify 'Add your comment' link is shown against the new post.
+
+End test.
diff --git a/mod/oublog/internaldoc/testcase.socialmedia.txt b/mod/oublog/internaldoc/testcase.socialmedia.txt
new file mode 100644
index 0000000..d25ba2e
--- /dev/null
+++ b/mod/oublog/internaldoc/testcase.socialmedia.txt
@@ -0,0 +1,201 @@
+This script describes steps to test OU Blog socialmedia functionality.
+It is intended to cover just the UI features.
+
+NOTE: In this test case, the word 'blog' always refers to the OU blog.
+
+Some test steps in this script follow on from each other and aren't independent.
+In these cases the prerequisite steps are listed.
+
+Initial setup
+=============
+
+This test case requires:
+
+- a text file 'post1.txt' for attachment-upload.
+- a user with administration rights
+- access to the personal blog.
+- access to accounts on each of the social media systems.
+
+The test server must have debugging set to DEVELOPER level and to display
+errors; during all parts of the test script, there should be no debugging
+warnings.
+
+Note: With Javascript enabled a Twitter "Tweet" widget button will be provided,
+without Javascript a "Tweet" link will be provided.
+
+Note: With Javascript enabled a Facebook "Share" widget button will be provided,
+without Javascript no "Share" link will be provided.
+
+Note: With Javascript enabled a Google+ "Share" widget button will be provided,
+without Javascript no "Share" link will be provided.
+
+TCR Creating blog data
+======================
+
+TCR01 / admin.
+   Log in and access the 'Personal Blog'.
+   Select the 'New blog post' button.
+   Enter 'TCR01 tweet a titled post' into the 'Title' field.
+   Enter some text into the 'Message' field.
+   Change 'Who can read this?' to the 'Visible to anyone in the world' setting.
+   Select 'Add post' button to save the new post and return to main blog view.
+-- Verify post created is displayed at the top of the posts area.
+-- Confirm that the post has a dark grey box in its top right corner,
+   with the label 'Share this post' with a 'Tweet', an 'f Share' and a 'g+ Share'
+   button/link beneath.
+
+TCR02 / admin.
+   Select the 'New blog post' button.
+   Leave the 'Title' field empty.
+   Enter 'TCR02 tweet an untitled post' into the 'Message' field.
+-- Attach the text file to the post.
+   Change 'Who can read this?' to the 'Visible to anyone in the world' setting.
+   Select 'Add post' button to save the new post and return to main blog view.
+-- Verify this new post created is displayed at the top of the posts area.
+-- Confirm that the post has a light grey box in its top right corner, with the label
+   'Attachments' with an icon and 'post1.txt' download link beneath.
+-- Confirm that beneath the 'Attachments' box is the dark grey box, with the label
+   'Share this post' with a 'Tweet', an 'f Share' and a 'g+ Share' button/link beneath.
+
+TCR03 / admin.
+   Select the 'New blog post' button.
+   Enter 'TCR03 can only tweet a public post' into the 'Title' field.
+   Enter some text into the 'Message' field.
+   Change 'Who can read this?' to 'Visible to everyone who is logged in to the system'.
+-- Verify that the post does not have the dark grey box, with the label
+   'Share this post' with a 'Tweet', an 'f Share' and a 'g+ Share' button/link beneath.
+
+TWT Testing Tweet button
+========================
+
+TWT01 / admin
+   On the post titled "TCR01 tweet a titled post".
+   Click 'Permalink' link, to open the post in another tab.
+Note the post=id in the viewpost.php page URL.
+
+   Return to the post "TCR01" on the blog main page.
+
+TWT02a / admin
+   Click the 'Tweet' button/link for post "TCR01 tweet a titled post".
+-- Confirm that a new 'Share a link on Twitter' window pops up.
+-- Verify that the text box 'Share a link with your followers' contains
+   'TCR01 tweet a titled post {Admin user's blog}'
+-- Confirm that this is followed by the URL of the viewpost.php page for the post "TCR01".
+-- Confirm that beneath this is are text boxes for user name and password and the
+   'Sign in and Tweet' button.
+   Close the popup window.
+
+TWT02b / admin
+   Click the 'f Share' link for post "TCR01 tweet a titled post".
+-- Confirm that a new 'Facebook' window pops up.
+   After successful login the window will change to 'Share on Facebook'.
+-- Confirm that there is a dropdown selector with options for sharing to timelines.
+-- Verify that there is a text box which contains 'Say something about this..'
+   beneath which is a box containing 'TCR01 tweet a titled post' with the domain url beneath.
+-- Confirm that this is followed by 'Public' a dropdown selector with options for
+   privacy, a 'Cancel' and 'Share link' buttons.
+   Close the popup window.
+
+TWT02c / admin
+   Click the 'g+ Share' link for post "TCR01 tweet a titled post".
+-- Confirm that a new 'login to Google' window pops up.
+   After successful login the window will disappear.
+   Click the "TCR01 tweet a titled post" 'g+ Share' button/link again.
+-- Confirm that a 'Share this on Google+ as {G+ User}' popup appears.
+-- Verify that there is a text box which contains 'Add a comment..'
+   Beneath which is a box containing the URL of the viewpost.php page for the post "TCR01".
+-- Confirm that this is followed by a dropdown selector with options for privacy,
+   and a 'Share' button.
+   Close the popup window.
+
+TWT03 / admin
+   On the Untitled post "TCR02".
+   Click 'Permalink' link, to open this post in another tab.
+Note the post=id in the viewpost.php page URL.
+
+   Return to the post "TCR02" on the blog main page.
+
+TWT04a / admin
+   Click the 'Tweet' button/link for the Untitled post "TCR02".
+-- Confirm that a new 'Share a link on Twitter' window pops up.
+-- Verify that the text box 'Share a link with your followers' contains
+   'Untitled post {Admin user's blog}'
+-- Confirm that this is followed by the URL of the viewpost.php page for the post "TCR02".
+-- Confirm that beneath this is are text boxes for user name and password and the
+   'Sign in and Tweet' button.
+   Close the popup window.
+
+TWT04b / admin
+   Click the 'f Share' link for the Untitled post "TCR02".
+-- Confirm that a new 'Facebook' window pops up.
+   After successful login the window will change to 'Share on Facebook'.
+-- Confirm that there is a dropdown selector with options for sharing to timelines.
+-- Verify that there is a text box which contains 'Say something about this..'
+   beneath which is a box containing 'Untitled post TCR02' with the domain url beneath.
+-- Confirm that this is followed by 'Public' a dropdown selector with options for
+   privacy, a 'Cancel' and 'Share link' buttons.
+   Close the popup window.
+
+TWT04c / admin
+   Click the 'g+ Share' link for Untitled post "TCR02".
+-- Confirm that a 'Share this on Google+ as {G+ User}' popup appears.
+-- Verify that there is a text box which contains 'Add a comment..'
+   Beneath which is a box containing the URL of the viewpost.php page for the post "TCR02".
+-- Confirm that this is followed by a dropdown selector with options for privacy,
+   and a 'Share' button.
+   Close the popup window.
+
+TWT05a / admin
+   On the post titled "TCR01 tweet a titled post".
+   Click 'Permalink' link, to open the post in the viewpost.php page.
+   Click the 'Tweet' button/link for the post.
+-- Confirm that a new 'Share a link on Twitter' window pops up.
+-- Verify that the text box 'Share a link with your followers' contains
+   'TCR01 tweet a titled post {Admin user's blog}'
+-- Confirm that this is followed by the URL of this viewpost.php page for the post "TCR01".
+   Close the popup window.
+
+TWT05b / admin
+   Click the 'Share' link for post "TCR01 tweet a titled post".
+-- Confirm that a new 'Share on Facebook' window pops up.
+-- Confirm that there is a dropdown selector with options for sharing to timelines.
+-- Verify that there is a text box which contains 'Say something about this..'
+   Beneath which is a box containing
+   'TCR01 tweet a titled post' with the domain url beneath.
+-- Confirm that this is followed by 'Public' a dropdown selector with options for
+   privacy, a 'Cancel' and 'Share link' buttons.
+   Close the popup window.
+
+TWT05c / admin
+   Click the 'g+ Share' link for post "TCR01 tweet a titled post".
+-- Confirm that a 'Share this on Google+ as {G+ User}' popup appears.
+-- Verify that there is a text box which contains 'Add a comment..'
+   Beneath which is a box containing the URL of the viewpost.php page for the post "TCR02".
+-- Confirm that this is followed by a dropdown selector with options for privacy,
+   and a 'Share' button.
+   Close the popup window.
+   Return to the blog main page.
+
+TWT06 / admin
+   In the Blog summary block.
+   Click the 'View site entries' link.
+-- Verify the the allposts.php page opens showing 'Personal blogs'
+-- Confirm that only posts 'Visible to anyone in the world' have the dark grey box,
+   with the label 'Share this post' with a 'Tweet', an 'f Share' and a 'g+ Share'
+   button/link beneath.
+
+TWT07 / admin
+   Repeat steps TWT01-TWT05c to confirm functionality for allposts.php, the 'Personal blogs' page.
+   Return to the blog main page.
+
+TWT08 / Not logged in user
+   Log out or open a different browser.
+   Go to the {Admin user's blog} in 'Personal Blogs'.
+-- Confirm that only posts 'Visible to anyone in the world' are available.
+-- Confirm that they have the dark grey box, with the label 'Share this post'
+   with a 'Tweet', an 'f Share' and a 'g+ Share' button/link beneath.
+
+TWT09 / Not logged in user
+   Repeat steps TWT01-TWT05c to confirm functionality for 'Non logged in user'.
+
+Test ends.
diff --git a/mod/oublog/internaldoc/testcase.usagestats.txt b/mod/oublog/internaldoc/testcase.usagestats.txt
new file mode 100644
index 0000000..a761a77
--- /dev/null
+++ b/mod/oublog/internaldoc/testcase.usagestats.txt
@@ -0,0 +1,338 @@
+This script describes steps to test the OU Blog facility that displays blog usage statistics
+from a user perspective. It is intended to cover most of the UI and features.
+
+Note that this feature is intended to display statistics based on blog usage and content,
+and as it is only practical to create a small data set in these tests it is recommended
+to further test the functionality on a system with real data independently.
+
+NOTE: In this test case, the word 'blog' always refers to the OU blog.
+
+The test steps in this script follow on from each other and aren't independent.
+
+
+Initial setup
+=============
+
+This test case requires:
+
+- Two user accounts (admin & student - admin must have permissions to create/configure activities)
+- Both users should have an avatar (user picture) set for their profile
+- A test course in which activities can be added, both test users should be enrolled on this course
+- Two groups [G1 and G2], both test users should be members of G1. admin should be member of G2 also
+- Personal blogs setup on the test system
+- Numerous blog activities with various configurations for testing (see CRE)
+- Numerous blog, posts and comments for testing (see CRE)
+
+The test server must have debugging set to DEVELOPER level and to display
+errors; during all parts of the test script, there should be no debugging
+warnings.
+
+CRE Creating blog and data
+===========================
+
+CRE01 / admin.
+
+    Create a new blog activity 'TU.CRE01-CW' with Intro text "Course-wide blog"
+    Ensure 'Allow comments' set to 'Yes, from logged in users'
+    Ensure Individual blogs set to 'No (blog together on in groups)'
+    Enable 'Show blog usage extra statistics' checkbox
+    Ensure group mode is 'No groups'
+    Save and return to website.
+
+CRE02 / admin.
+
+    Create a new blog activity 'TU.CRE02-GB' with Intro text "Group blog"
+    Ensure 'Allow comments' set to 'Yes, from logged in users'
+    Ensure 'Individual blogs' set to 'No (blog together on in groups)'
+    Tick 'Show blog usage extra statistics' checkbox
+    Set group mode to 'Visible groups'
+    Save and return to website.
+
+CRE03 / admin.
+
+    Create a new blog activity 'TU.CRE03-VIB' with Intro text "Individual blog"
+    Ensure 'Allow comments' set to 'Yes, from logged in users'
+    Ensure 'Individual blogs' set to 'Visible individual blogs'
+    Tick Show blog usage extra statistics checkbox
+    Ensure group mode is 'No groups'
+    Save and return to website.
+
+CRE04 / admin.
+
+    Enter blog TU.CRE01-CW
+    Select 'New blog post' and add a new blog post, setting title to 'Admin-Post01'
+    Add any message text you like and set Allow comments to 'Yes, from logged in users'
+    Repeat adding another post, this time leaving Title field empty
+    Select 'Add your comment' against Admin-Post01 and add a new comment (no title, any text).
+
+CRE05 / student [change]
+
+    Enter blog TU.CRE01-CW
+    Add a comment against Admin-Post01 (no title, any text)
+    Repeat (so you have added two comments to Admin-Post01, there are now three in total)
+    Select 'Add your comment' against the untitled post and add a new comment (no title, any text).
+
+CRE06 / admin [change]
+
+    Repeat steps in CRE04 using blog TU.CRE02-GB, ensuring G1 group is selected as the current blog.
+
+CRE07 / admin
+
+    In blog TU.CRE02-GB switch to the G2 group blog
+    Select 'New blog post' and add a new blog post, setting title to 'Admin-Post02'
+    Add any message text you like and set Allow comments to 'No'.
+
+CRE08 / student [change]
+
+    Repeat steps in CRE05 using blog TU.CRE02-GB, ensuring G1 group is selected as the current blog.
+
+CRE09 / admin [change]
+
+    From course home page select TU.CRE03-VIB blog
+    Ensure current user is displayed as the Visible individual
+    Repeat steps in CRE04 using this blog.
+
+CRE10 / student [change]
+
+    From course home page select TU.CRE03-VIB blog
+    Select the Admin user from the Visible individual drop-down
+    Repeat steps in CRE05 using this blog.
+
+CRE11 / student
+
+    In TU.CRE03-VIB blog select current user from the Visible individual drop-down
+    Select 'New blog post' and add a new blog post, setting title to 'Student-Post01'
+    Add any message text you like and set Allow comments to 'No comments'.
+
+
+CRS Checking usage 'block' on course-wide blog
+==============================================
+
+CRS01a / admin [change]
+
+    From the course home page access the TU.CRE01-CW blog.
+ -- A 'Blog usage' 'panel' should show to the right.
+ -- The 'panel' should contain only the 'My participation summary' expanded block,
+    with 'Participation' and 'Most commented posts' blocks, as collapsed button tabs.
+ -- There should be three entries in the 'My participation summary' block tab:
+    2 Posts and 1 Comment.
+ -- (These should display latest first)
+ -- The Untitled post should be at the top.
+ -- Admin-Post01 should be after this.
+ -- The Admin user avatar should be to the left of the three entries.
+ -- The post time when created should be displayed below the post titles.
+ -- The titles should link to the post or comment.
+
+CRS01b  / admin
+    Click the block title 'Participation'.
+    The 'My participation summary' block should collapse whilst this block expands.
+    The block contains a title and two areas, one showing recent posts the other recent comments.
+ -- Beneath this there should be a number of post entries: (Posts/Comments should display latest first)
+ -- The Untitled (Admin) post should be at the top.
+ -- Admin-Post01 should be after this.
+ -- The Untitled students comments should follow these.
+ -- Admin's Untitled comment should be last.
+ -- The user's avatars should be to the left of the entries.
+ -- The post time when created should be displayed below the post title.
+ -- Beneath the post time should be a link to the blog.
+ Note:(This link is context sensitive, and depends upon blog settings)
+ -- The titles should link to the post or comment.
+
+
+CRS01c  / admin
+    Click the block title 'Most commented posts'.
+    The 'Participation' block should collapse whilst this block expands.
+    The block contains a collapseable time filter, with designated 'Time period' [+]
+    When expanded this gives the option to select three time periods.
+    Beneath this there should be two entries in this block tab:
+ -- Admin-Post01 should be visible, showing 2 comments (post creator comments are not counted).
+ -- The Admin user's avatar should be to the left of the entries.
+ -- The post time when created should be displayed below the post title.
+ -- The title should link to the post.
+ -- The 'bar' for Admin-Post01 comments should take the full width available in the block.
+
+CRS02 / admin
+
+    Still in TU.CRE01-CW 'Blog usage' 'block':
+    Select [+] || [-] link by the current time period heading.
+ -- This should expand/collapse the time filter form.
+    Select Time period 'All time' from drop-down and select Update button
+    (assuming the current filter is not 'All time', select a different time period in this case)
+    Click the 'Update button'.
+ -- A 'spinner' should be shown beside the 'Update' button.
+ -- The time period title should be updated (e.g. to 'All time').
+ -- The description should be updated (e.g. to 'Posts with the most number of comments').
+    (The list of posts with comments should remain the same, with the small amount of data created.)
+    Revisit (refresh) the blog page.
+ -- The previously selected Time period and expand/collapse states should be remembered.
+
+GRP Checking usage 'block' on group blog
+========================================
+
+GRP01 / admin
+
+    From the course home page access the TU.CRE02-GB blog,
+    Select the Visible group G1.
+ -- The 'Blog usage' 'block' should show to the right.
+ -- The 'block' should contain 'My participation summary', 'Participation', 'Most commented posts',
+    'Most posts', and 'Most comments' tabs.
+ -- You should be able to expand/collapse each tab by selecting its heading (1 open at a time).
+ -- There should be three entries in the 'My participation summary' tab,
+ --   2 posts and 1 comment.
+ --   The Untitled (Admin) post should be at the top followed by Admin-Post01.
+ --   There should be 1 untitled comment beneath these posts.
+ --   The user avatar should be to the left of the entries post title and date time,
+      each title being a link to the post or comment.
+ --   Beneath the comments should be a link 'View my participation' to the user participation page.
+ -- There should be six entries in the 'Participation' tab,
+ --   2 posts and 4 comments, each displayed latest first.
+ --   The Untitled (Admin) post should be at the top followed by Admin-Post01.
+ --   There should be 4 untitled comments beneath these posts. Three by the student user and one by the admin.
+ --   The user avatar should be to the left of the entries post title and date time,
+      each title being a link to the post or comment.
+ --   Beneath the comments should be a link 'View my participation' to the user participation page.
+ -- There should be two entries in the 'Most commented posts' tab -
+      2 comments with the post title link Admin-Post01.
+      1 comment the the post title Untitled post.
+ -- The user avatar should be to the left of the entries post title and date time,
+      each title being a link to the post.
+ -- There should be two entries in the 'Most posts' tab,
+ --   One for each group, with 2 posts for G1's blog above 1 for G2's blog.
+ --   The default avatar should be to the left of the entries (unless a group picture is set).
+ --   The blog 'name' should be a link to the group's blog within the activity.
+ -- There should be one entry in the 'Most comments' tab - for G1's blog (3 comments).
+ -- The default avatar should be to the left of the title link to the blog (unless a group picture is set).
+
+
+GRP02 / admin
+
+    From the course home page access the TU.CRE02-GB blog,
+    Select the Visible group 'All participants'.
+    'Participation' should now show a link to the group's blog below the date time.
+    'Most commented posts' should now list posts with most comments across all group blogs.
+ -- Admin-Post01 and Untitled post should be listed as per GRP01, but with addition of link to G1's blog below.
+    'Most posts' and 'Most comments' tabs should be as per GRP01.
+
+
+IND Checking usage 'block' on individual blog
+=============================================
+
+IND01 / admin
+
+    From the course home page access the TU.CRE03-VIB blog,
+    Select the Visible individual Admin user.
+ -- The 'Blog usage' 'block' should be shown on the right.
+ -- The 'block' should contain 'My participation summary', 'Participation', 'Most commented posts',
+    'Most posts', and 'Most comments' tabs.
+ -- You should be able to expand/collapse each tab by selecting it's heading (1 open at a time).
+ -- There should be three entries in the 'My participation summary' tab,
+ --   2 posts and 1 comment.
+ --   An Untitled post should be at the top followed by Admin-Post01.
+ --   There should be 1 untitled comment beneath these posts.
+ --   The user avatar should be to the left of the entries post title and date time,
+      each title being a link to the post or comment on the post.
+ --   Beneath the comments should be a link to the user participation page, 'View my participation'.
+ -- In the 'Participation' panel there should be 4 untitled comments made on the Admins blog,
+ --   3 by Student user one,  and 1 by the Admin user
+ --   These should appear in reverse order, newest at the top, the first 3 being the Students, last the Admins.
+ -- There should be two entries in the 'Most commented posts' tab -
+      2 comments with the post title link Admin-Post01.
+      1 comment with the post title Untitled post.
+ -- The user avatar should be to the left of the entries post title and date time,
+      each title being a link to the post.
+ -- The 'bar' for Admin-Post01 comments should take the full width available in the block.
+ -- The 'bar' for the Untitled post should be half the available width between label and edge of block.
+ -- There should be two entries in the 'Most posts' tab,
+ --   One for each user, with 2 posts for Admin's blog above 1 for the Student's.
+ --   The user's avatar should be to the left of the entries.
+ --   The blog 'name' should be a link to the user's blog within the activity.
+ -- There should be one entry in the 'Most comments' tab - for Admin's blog (3 comments).
+ --   The admin avatar should show against the user name link to the blog.
+
+IND02 / admin
+
+    From the course home page access the TU.CRE03-VIB blog,
+    Select the Visible individual 'View all users'.
+    'Most posts' and 'Most comments' tabs should be as per IND01.
+    In 'Participation', comments should be listed with addition of link to the user's blog below.
+    'Most commented posts' should now list posts with most comments across all user blogs.
+ -- Admin-Post01 and Untitled post should be listed as per IND01, but with addition of link to admin's blog below.
+
+OFF Checking usage 'block' displays appropriately
+=================================================
+
+OFF01 / admin
+
+    From the course home page access blog TU.CRE02-GB,
+    Select Edit settings from the Administration block.
+    Un-tick 'Show blog usage statistics' checkbox - Save and display the activity.
+ -- Only 'My participation summary', 'Participation' and 'Most commented posts' should now be
+    showing in the Blog usage block.
+    Select Edit settings from the Administration block again.
+    Tick 'Show blog usage extra statistics' (turn back on).
+    Update group mode from 'Visible groups' to 'Separate groups',
+    Save and display.
+ -- Only 'My participation summary', 'Participation' and 'Most commented posts' should now be
+    showing in the Blog usage block.
+
+OFF02 / admin
+
+    From the course home page access blog TU.CRE03-VIB,
+    Select Edit settings from the Administration block.
+    Update Allow comments to 'Comments not allowed',
+    Save and display.
+ -- Only 'Participation' and 'Most posts' should now be showing in the Blog usage block,
+    'Participation' displays only 'View all participation' link.
+    Select Edit settings from the Administration block.
+    Update 'Individual blogs' to 'Separate individual blogs',
+    Save and display.
+ -- Blog usage block should be showing only 'Participation'.
+    'Participation' displays recent posts and 'View all participation' link.
+
+PER Checking personal blog usage
+=================================
+
+PER01 / admin
+
+    Access the Admin user's personal blog via /mod/oublog/view.php
+    Select Edit settings from the Administration block
+    Ensure 'Show blog usage extra statistics' is ticked.
+    Select 'New blog post' and add a new blog post, setting title to 'Admin-Post01'
+    Set visibility to 'Visible to anyone in the world'
+    Add any message text you like and set Allow comments to 'Yes, from logged in users'
+    Repeat, adding an untitled post, set visibility to 'Visible to everyone logged in to the system'
+    Select 'Add your comment' against Admin-Post01 and add a new comment (no title, any text)
+    Copy the URL to the admin's blog page for use in next step.
+
+PER02 / student
+
+    Access admin's personal blog via /mod/oublog/view.php?user=XXX.
+    Select 'Add your comment' against Admin-Post01 and add a new comment (no title, any text).
+    Select 'Add your comment' against the untitled post and add a new comment (no title, any text).
+    Return to admin users personal blog main page.
+    Within the Blog usage 'block' select 'Most commented posts'.
+ -- 'Untitled post' should be displayed in the list with 1 comment.
+ -- Admin-Post01 should be displayed in the list with 1 comment.
+
+Note: Depending upon recent use of this blog there may be many comments which would stop these test
+comments appearing, they should show up if the time period is reset to 'Past month'.
+
+PER03 / guest
+
+    In a different browser access admin's personal blog via /mod/oublog/view.php?user=XXX.
+    Within the Blog usage 'block' select 'Most commented posts'.
+ -- Admin-Post01 should be displayed in the list with 1 comment.
+ -- Admin user's avatar should not be displayed (default should be shown).
+Note: This is controlled through server settings and works correctly on live systems.
+As above, it may be necessary to reset the time period to 'Past month'.
+
+ PER04 / student
+
+    Access admin's personal blog via /mod/oublog/view.php?user=XXX.
+    Select the 'View site entries' link (right block).
+ -- On the Personal blogs page the Blog usage block should be displayed.
+ -- The 'block' should contain 'Participation', 'Most commented posts', 'Most visited', 'Most posts',
+    and 'Most comments' tabs.
+ -- Ensure each tab expands correctly.
+ -- Items in the 'Participation' and 'Most commented posts' tabs should have links to the user's
+    blog pages below.
diff --git a/mod/oublog/lang/README.txt b/mod/oublog/lang/README.txt
new file mode 100644
index 0000000..a31fd54
--- /dev/null
+++ b/mod/oublog/lang/README.txt
@@ -0,0 +1,8 @@
+At time of writing only the following lang folders have been updated since
+Moodle 2 conversion:
+
+en
+pt_br
+
+Other folders are the versions from Moodle 1.9, so may partially work but
+the help will be missing.
diff --git a/mod/oublog/lang/ca/help/oublog/allowcomments.html b/mod/oublog/lang/ca/help/oublog/allowcomments.html
new file mode 100644
index 0000000..5e163a9
--- /dev/null
+++ b/mod/oublog/lang/ca/help/oublog/allowcomments.html
@@ -0,0 +1,28 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
+<html><head>
+<meta http-equiv="CONTENT-TYPE" content="text/html;"><title></title>
+
+<meta name="CHANGEDBY" content="Antonio Piedras Morente">
+<meta name="CHANGED" content="20091215;12123300">
+</head>
+<body style="direction: ltr;" lang="ca-CA">
+<h1>OU blog</h1>
+<h2>Comentaris</h2>
+<p>Quan escriu&nbsp;una not&iacute;cia (o l'edita) pot
+decidir qui
+est&agrave; autoritzat per a poder afegir comentaris a la seva
+not&iacute;cia.</p>
+<p>Si escull l'opci&oacute; <span style="font-weight: bold;">No</span>, ning&uacute;
+podr&agrave; afegir
+comentaris. Aix&ograve; es pot fer en casos especials.&nbsp;<span id="result_box" class="medium_text"><span style="background-color: rgb(255, 255, 255);" title="such as if a controversial post might cause trouble to erupt in any comments section.">com
+en el cas d'un lloc pol&egrave;mic on es podrien crear problemes a
+l'entrar en confrontaci&oacute; amb qualsevol altra
+secci&oacute; de
+comentaris.</span></span></p>
+<p>Si escull l'opci&oacute; <span style="font-weight: bold;">S&iacute;</span>, els
+usuaris podran
+comentar les not&iacute;cies si tenen acc&eacute;s al blog i
+poden accedir al
+sistema. Si el blog el pot veure qualsevol usuari malgrat no estigui
+registrat, aquest no podr&agrave; afegir comentaris.</p>
+</body></html>
diff --git a/mod/oublog/lang/ca/help/oublog/completion.html b/mod/oublog/lang/ca/help/oublog/completion.html
new file mode 100644
index 0000000..62aea00
--- /dev/null
+++ b/mod/oublog/lang/ca/help/oublog/completion.html
@@ -0,0 +1,33 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
+<html><head>
+<meta http-equiv="CONTENT-TYPE" content="text/html;"><title></title>
+
+<meta name="CHANGEDBY" content="Antonio Piedras Morente">
+<meta name="CHANGED" content="20091215;12240400">
+</head>
+
+<body style="direction: ltr;" lang="ca-CA">
+<h1>OU blog</h1>
+<h2>Opcions de finalitzaci&oacute;</h2>
+<ul>
+<li>
+<p style="margin-bottom: 0cm;">Si escull
+&ldquo;Missatge requerit&rdquo;, aleshores el blog&nbsp;es
+marcar&agrave; com a que s'ha completat per a un usuari que ha
+realizat el nombre especificat de trameses. </p>
+</li>
+<li>
+<p>Si escull &ldquo;Comentari requerit&rdquo;, el
+blog quedar&agrave; marcat com a completat per&nbsp;l'usuari
+una vegada&nbsp;hagi cumplimentat els seus comentaris.&nbsp;<span id="result_box" class="short_text"><span style="background-color: rgb(255, 255, 255);" title="The comments can be on anyone's post as long as it is within this blog.">Els
+comentaris poden estar en el post d'alg&uacute; mentre
+est&agrave; dins d'aquest bloc.</span></span> </p>
+</li>
+</ul>
+<p>
+Tingueu
+en compte que els cursos i els blocs personals s&oacute;n
+independents. Correus
+i comentaris als blocs personals no compten per als requisits de
+finalitzaci&oacute; d'un bloc del curs.</p>
+</body></html>
diff --git a/mod/oublog/lang/ca/help/oublog/feed.html b/mod/oublog/lang/ca/help/oublog/feed.html
new file mode 100644
index 0000000..b9d61a6
--- /dev/null
+++ b/mod/oublog/lang/ca/help/oublog/feed.html
@@ -0,0 +1,32 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
+<html><head>
+<meta http-equiv="CONTENT-TYPE" content="text/html;"><title></title>
+
+<meta name="CHANGEDBY" content="Antonio Piedras Morente">
+<meta name="CHANGED" content="20091215;12581500">
+</head>
+
+<body style="direction: ltr;" lang="ca-CA">
+<h1>OU blog</h1>
+<h2>Not&iacute;cies</h2>
+<h3>Notificacions autom&agrave;tiques</h3>
+<p>Si vost&egrave; utilitza un programa lector de
+not&iacute;cies o un lloc web, es
+pot afegir l'URL Atom o RSS per rebre les
+actualitzacions dels missatges del blog. </p>
+<p>Una segona opci&oacute; de not&iacute;cies poden ser
+activades pels
+propietaris del blog mitjan&ccedil;ant les que es poden llegir els
+comentaris
+realitzats. </p>
+<p>El
+seu curs no requereix l'&uacute;s d'aquesta funci&oacute;.
+</p>
+<h3>Atom i RSS</h3>
+<p>Atom i RSS s&oacute;n dos formats que tenen la mateixa
+finalitat.
+La
+majoria dels lectors de not&iacute;cies suporten qualsevol dels
+dos. Si un d'ells no funciona correctament, haur&agrave; de provar
+amb l'altre.</p>
+</body></html>
diff --git a/mod/oublog/lang/ca/help/oublog/tags.html b/mod/oublog/lang/ca/help/oublog/tags.html
new file mode 100644
index 0000000..8babacb
--- /dev/null
+++ b/mod/oublog/lang/ca/help/oublog/tags.html
@@ -0,0 +1,39 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
+<html><head>
+<meta http-equiv="CONTENT-TYPE" content="text/html;"><title></title>
+
+<meta name="CHANGEDBY" content="Antonio Piedras Morente">
+<meta name="CHANGED" content="20091215;13091800">
+</head>
+
+<body style="direction: ltr;" lang="ca-CA">
+<h1>OU blog</h1>
+<h2>Etiquetes</h2>
+<h3>Que s&oacute;n las etiquetes?</h3>
+<p>Les etiquetes s&oacute;n paraules
+&ldquo;clau&rdquo; que poden
+utilitzar-se per crear categories en els missatges del blog.
+S&oacute;n
+frases senzilles, normalment d'una &uacute;nica paraula malgrat es
+poden utilitzar m&uacute;ltiples paraules.</p>
+<p>Vost&egrave; introdueix les etiquetes mentre
+est&agrave; editant una
+not&iacute;cia o pot deixar aquest camp en blanc, ja&nbsp;que
+no es
+obligatori.</p>
+<p>Per exemple: Si&nbsp;est&agrave; escrivint una
+not&iacute;cia sobre l'escalfament global, es poden utilitzar
+etiquetes com: ecologia,
+ecosistema, escalfament global, efecte hivernacle.</p>
+<h3>Etiquetes m&uacute;ltiples</h3>
+<p>Es poden afegir varies etiquetes separades por comes.</p>
+<p>Exemple: <strong> ecologia, ecosistema, escalfament
+global, efecte hivernacle</strong></p>
+<h3>Buscant per etiquetes</h3>
+<p>Quan s'utilitzen les etiquetes en els missatges, apareix un
+bloc que mostra les etiquetes com hipervincles. Cada
+etiqueta ve acompanyada d'un n&uacute;mero que indica el
+nombre de missatges en el blog que contenen aquesta etiqueta. Si
+seleccionem l'hipervincle corresponent,&nbsp;es mostraran els
+missatges continguts en aquesta etiqueta.</p>
+</body></html>
diff --git a/mod/oublog/lang/ca/help/oublog/visibility.html b/mod/oublog/lang/ca/help/oublog/visibility.html
new file mode 100644
index 0000000..6e011c0
--- /dev/null
+++ b/mod/oublog/lang/ca/help/oublog/visibility.html
@@ -0,0 +1,41 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
+<html><head>
+<meta http-equiv="CONTENT-TYPE" content="text/html;"><title></title>
+
+<meta name="CHANGEDBY" content="Antonio Piedras Morente">
+<meta name="CHANGED" content="20091215;12453200"></head>
+<body style="direction: ltr;" lang="ca-CA">
+<h1>OU blog</h1>
+<h2>Visibilitat</h2>
+<p>Els missatges del blog tenen l'opci&oacute; de mostrar qui
+est&agrave; autoritzat a llegir-los. Hi ha tres opcions en ordre
+creixent d'usuaris autoritzats.</p>
+<ol>
+<li>
+<p><em>En un blog personal:</em> <strong>Visible
+&uacute;nicament pel propietari (privat)</strong> &ndash;
+ning&uacute;* podr&agrave; veure les not&iacute;cies.</p>
+<p><em>En un blog d'un curs:</em> <strong>Els
+participants del curs</strong> &ndash; Les
+not&iacute;cies seran visibles pels usuaris del curs, en el que
+est&agrave; incl&ograve;s el blog, que disposin d'un rol.</p>
+</li>
+<li>
+<p style="margin-bottom: 0cm;"><strong>Qualsevol
+usuari registrat en&nbsp;el sistema</strong>
+&ndash;
+Qualsevol que tingui&nbsp;un compte d'usuari podr&agrave;
+veure&nbsp;les not&iacute;cies sense necessitat de disposar d'un rol
+espec&iacute;fic en el
+curs. </p>
+</li>
+<li>
+<p><strong>Qualsevol en el m&oacute;n</strong>
+&ndash; Qualsevol usuari d'Internet podr&agrave; veure les
+not&iacute;cies si coneix l'adre&ccedil;a web del blog. </p>
+</li>
+</ol>
+<p>* Els administradors del sistema tenen acc&eacute;s total
+al missatges incl&uacute;s els que estan marcats com a
+&ldquo;privats&rdquo;.</p>
+</body></html>
diff --git a/mod/oublog/lang/ca/oublog.php b/mod/oublog/lang/ca/oublog.php
new file mode 100644
index 0000000..6edd799
--- /dev/null
+++ b/mod/oublog/lang/ca/oublog.php
@@ -0,0 +1,127 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+$string['oublog'] = 'OU blog';
+$string['modulename'] = 'OU blog';
+$string['modulenameplural'] = 'OU blogs';
+
+$string['oublog:view'] = 'Veu missatges';
+$string['oublog:post'] = 'Crea un nou missatge';
+$string['oublog:comment'] = 'Comenta un missatge';
+$string['oublog:managecomments'] = 'Gestiona comentaris';
+$string['oublog:manageposts'] = 'Gestiona missatges';
+$string['oublog:managelinks'] = 'Gestiona vincles';
+$string['oublog:audit'] = 'Veu missatges eliminats i versions anteriors';
+
+
+$string['newpost'] = 'Nou missatge';
+$string['title'] = 'Ttol';
+$string['message'] = 'Text del missatge';
+$string['tags'] = 'Etiquetes';
+$string['allowcomments'] = 'Permet comentaris';
+$string['nocomments'] = 'No es permeten comentaris';
+$string['visibility'] = 'Aquest missatge s visible per:';
+$string['maxvisibility'] = 'El blog s visible per';
+$string['yes'] = 'S';
+$string['no'] = 'No';
+$string['blogname'] = 'Nom del Blog';
+$string['summary'] = 'Resum';
+
+$string['visibleyou'] = 'Visible nicament pel propietari (privat)';
+$string['visiblecourseusers'] = 'Els participants d\'aquest curs';
+$string['visibleloggedinusers'] = 'Qualsevol usuari registrat en el sistema';
+$string['visiblepublic'] = 'Qualsevol usuari en el mn';
+
+
+$string['addpost'] = 'Desa missatge de blog';
+$string['editpost'] = 'Actualitza missatge de blog';
+$string['editsummary'] = 'Editat prr {$a->editby}, {$a->editdate}';
+$string['editonsummary'] = 'Editat {$a->editdate}';
+
+$string['edit'] = 'Edita';
+$string['delete'] = 'Esborra';
+
+$string['olderposts'] = '&lt; Missatges antics';
+$string['newerposts'] = 'Missatges recents &gt;';
+$string['extranavolderposts'] = 'Missatges antics: {$a->from}-{$a->to}';
+$string['extranavtag'] = 'Etiqueta: {$a}';
+
+$string['comments'] = 'Comentaris';
+$string['ncomments'] = '{$a} comentaris';
+$string['1comment'] = '1 comentari';
+$string['comment'] = 'Comenta aquesta notcia';
+$string['lastcomment'] = '(ltim comentari per {$a->fullname}, {$a->timeposted})';
+$string['addcomment'] = 'Publica comentari';
+
+$string['confirmdeletepost'] = 'Segur que voleu eliminar aquest missatge?';
+$string['confirmdeletecomment'] = 'Segur que voleu eliminar aquest comentari?';
+$string['confirmdeletelink'] = 'Segur que voleu eliminar aquest enlla?';
+
+$string['viewedit'] = 'Veu edici';
+$string['views'] = 'Visites a aquest blog:';
+
+$string['addlink'] = 'Nou enlla';
+$string['links'] = 'Enllaos relacionats';
+
+$string['subscribefeed'] = 'Suscriu-me a les notcies (es necessita el programari apropiat) per a rebre notificacions quan aquest blog s\'actualitzi.';
+$string['feeds'] = 'Notcies';
+$string['blogfeed'] = 'Notcies de blog';
+$string['commentsfeed'] = 'Noms comentaris';
+$string['atom'] = 'Atom';
+$string['rss'] = 'RSS';
+$string['atomfeed'] = 'Atom feed';
+$string['rssfeed'] = 'RSS feed';
+
+$string['newblogposts'] = 'Nous missatges de blog';
+
+$string['blogsummary'] = 'Resum de blog';
+$string['posts'] = 'Missatges';
+
+$string['defaultpersonalblogname'] = '{$a}\'s blog';
+
+$string['numposts'] = '{$a} posts';
+
+$string['noblogposts'] = 'No hi ha missatges de blog';
+
+$string['blogoptions'] = 'Opcions de blog';
+
+$string['postedby'] = 'per {$a}';
+
+$string['deletedby'] = 'Eliminat per {$a->fullname}, {$a->timedeleted}';
+
+$string['newcomment'] = 'Nou comentari';
+
+$string['searchthisblog'] = 'Cerca en el blog';
+
+$string['url']='Adrea web completa';
+
+$string['bloginfo']='Informaci del blog';
+
+$string['feedhelp']='Notcies';
+
+$string['unsupportedbrowser']='<p>El teu navegador no pot mostrar notcias Atom o RSS directament.</p>
+<p>Feeds are most useful in separate computer programs or websites. If you want
+to use this feed in such a program, copy and paste the address from your browser\'s
+address bar.</p>';
+
+$string['completionpostsgroup']='Es requereix un missatge';
+$string['completionposts']='>L\'usuari pot crear notcies:';
+$string['completionpostshelp']='Es requereix notcia per a completar';
+$string['completioncommentsgroup']='Es requereix comentari';
+$string['completioncomments']='L\'usuari pot fer comentaris a les notcies:';
+$string['completioncommentshelp']='Es requereix comentari per a completar';
+
+$string['maybehiddenposts']='Aquest blog cont missatges que nicament sn visibles pels usuaris registrats. Si vost t un compte d\'usuari, sisplau <a href=\'{$a}\'>entri per poder veure\'ls</a>.';
+$string['noposts']='No hi ha missatges visibles en aquest blog.';
\ No newline at end of file
diff --git a/mod/oublog/lang/de/help/oublog/allowcomments.html b/mod/oublog/lang/de/help/oublog/allowcomments.html
new file mode 100644
index 0000000..b9b55b5
--- /dev/null
+++ b/mod/oublog/lang/de/help/oublog/allowcomments.html
@@ -0,0 +1,20 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!DOCTYPE html
+  PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0//EN" "http://www.w3.org/TR/MathML2/dtd/xhtml-math11-f.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml"><!--This file was converted to xhtml by OpenOffice.org - see http://xml.openoffice.org/odf2xhtml for more info.--><head profile="http://dublincore.org/documents/dcmi-terms/"><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title xml:lang="en-US">- no title specified</title><meta name="DCTERMS.title" content="" xml:lang="en-US"/><meta name="DCTERMS.language" content="en-US" scheme="DCTERMS.RFC4646"/><meta name="DCTERMS.source" content="http://xml.openoffice.org/odf2xhtml"/><meta name="DCTERMS.creator" content="Joachim Vogelgesang"/><meta name="DCTERMS.issued" content="2009-12-16T09:58:31" scheme="DCTERMS.W3CDTF"/><meta name="DCTERMS.contributor" content="Joachim Vogelgesang"/><meta name="DCTERMS.modified" content="2009-12-16T09:59:15" scheme="DCTERMS.W3CDTF"/><meta name="DCTERMS.provenance" content="" xml:lang="en-US"/><meta name="DCTERMS.subject" content="," xml:lang="en-US"/><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/" hreflang="en"/><link rel="schema.DCTERMS" href="http://purl.org/dc/terms/" hreflang="en"/><link rel="schema.DCTYPE" href="http://purl.org/dc/dcmitype/" hreflang="en"/><link rel="schema.DCAM" href="http://purl.org/dc/dcam/" hreflang="en"/><base href="."/><style type="text/css">
+    @page { size: 20.999cm 29.699cm; margin-top: 2cm; margin-bottom: 2cm; margin-left: 2cm; margin-right: 2cm }
+    table { border-collapse:collapse; border-spacing:0; empty-cells:show }
+    td, th { vertical-align:top; font-size:12pt;}
+    h1, h2, h3, h4, h5, h6 { clear:both }
+    ol, ul { margin:0; padding:0;}
+    li { list-style: none; margin:0; padding:0;}
+    li span.odfLiEnd { clear: both; line-height:0; width:0; height:0; margin:0; padding:0; }
+    span.footnodeNumber { padding-right:1em; }
+    * { margin:0; }
+    .Heading_20_1 { font-size:24pt; margin-bottom:0.212cm; margin-top:0.423cm; font-family:Times New Roman; font-weight:bold; }
+    .Heading_20_2 { font-size:18pt; margin-bottom:0.212cm; margin-top:0.423cm; font-family:Times New Roman; font-weight:bold; }
+    .Standard { font-size:12pt; font-family:Times New Roman; }
+    .Text_20_body { font-size:12pt; font-family:Times New Roman; margin-top:0cm; margin-bottom:0.212cm; }
+    <!-- ODF styles with no properties representable as CSS -->
+    { }
+    </style></head><body dir="ltr" style="max-width:20.999cm;margin-top:2cm; margin-bottom:2cm; margin-left:2cm; margin-right:2cm; "><h1 class="Heading_20_1"><a name="_OU_Blog"><span/></a>OU Blog</h1><h2 class="Heading_20_2"><a name="_Kommentare"><span/></a>Kommentare</h2><p class="Text_20_body">Wenn Sie einen Blogeintrag erstellen (oder einen Blog aufbauen) knnen Sie whlen ob es anderen Leuten erlaubt ist diesem Eintrag Kommentare hinzu zu fgen.</p><p class="Text_20_body">Wenn Sie die Option auf Nein setzen wird niemand kommentieren knnen. Vielleicht mchten Sie das in ganz speziellen Fllen tun, vielleicht wenn ein umstrittener Beitrag rger in einem Kommentarabschnitt hervorrufen sollte.</p><p class="Text_20_body">Wenn Sie die Option auf Ja setzen, knnen Leute kommentieren, falls sie Zugang zum System und Blog haben. Selbst in Fllen, in denen Internet Nutzer das Blog sehen knnen ohne sich einloggen zu mssen, ist es ihnen nicht mglich einen Kommentar zu hinterlassen ohne sich einzuloggen.</p><p class="Standard"></p></body></html>
diff --git a/mod/oublog/lang/de/help/oublog/completion.html b/mod/oublog/lang/de/help/oublog/completion.html
new file mode 100644
index 0000000..6011047
--- /dev/null
+++ b/mod/oublog/lang/de/help/oublog/completion.html
@@ -0,0 +1,22 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!DOCTYPE html
+  PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0//EN" "http://www.w3.org/TR/MathML2/dtd/xhtml-math11-f.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml"><!--This file was converted to xhtml by OpenOffice.org - see http://xml.openoffice.org/odf2xhtml for more info.--><head profile="http://dublincore.org/documents/dcmi-terms/"><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title xml:lang="en-US">- no title specified</title><meta name="DCTERMS.title" content="" xml:lang="en-US"/><meta name="DCTERMS.language" content="en-US" scheme="DCTERMS.RFC4646"/><meta name="DCTERMS.source" content="http://xml.openoffice.org/odf2xhtml"/><meta name="DCTERMS.creator" content="Joachim Vogelgesang"/><meta name="DCTERMS.issued" content="2009-12-16T09:58:31" scheme="DCTERMS.W3CDTF"/><meta name="DCTERMS.contributor" content="Joachim Vogelgesang"/><meta name="DCTERMS.modified" content="2009-12-16T10:00:12" scheme="DCTERMS.W3CDTF"/><meta name="DCTERMS.provenance" content="" xml:lang="en-US"/><meta name="DCTERMS.subject" content="," xml:lang="en-US"/><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/" hreflang="en"/><link rel="schema.DCTERMS" href="http://purl.org/dc/terms/" hreflang="en"/><link rel="schema.DCTYPE" href="http://purl.org/dc/dcmitype/" hreflang="en"/><link rel="schema.DCAM" href="http://purl.org/dc/dcam/" hreflang="en"/><base href="."/><style type="text/css">
+    @page { size: 20.999cm 29.699cm; margin-top: 2cm; margin-bottom: 2cm; margin-left: 2cm; margin-right: 2cm }
+    table { border-collapse:collapse; border-spacing:0; empty-cells:show }
+    td, th { vertical-align:top; font-size:12pt;}
+    h1, h2, h3, h4, h5, h6 { clear:both }
+    ol, ul { margin:0; padding:0;}
+    li { list-style: none; margin:0; padding:0;}
+    li span.odfLiEnd { clear: both; line-height:0; width:0; height:0; margin:0; padding:0; }
+    span.footnodeNumber { padding-right:1em; }
+    * { margin:0; }
+    .Heading_20_1 { font-size:24pt; margin-bottom:0.212cm; margin-top:0.423cm; font-family:Times New Roman; font-weight:bold; }
+    .Heading_20_2 { font-size:18pt; margin-bottom:0.212cm; margin-top:0.423cm; font-family:Times New Roman; font-weight:bold; }
+    .P1 { font-size:12pt; margin-bottom:0.212cm; margin-top:0cm; font-family:Times New Roman; }
+    .P2 { font-size:12pt; margin-bottom:0cm; margin-top:0cm; font-family:Times New Roman; }
+    .Text_20_body { font-size:12pt; font-family:Times New Roman; margin-top:0cm; margin-bottom:0.212cm; }
+    .Bullet_20_Symbols { font-family:OpenSymbol; }
+    <!-- ODF styles with no properties representable as CSS -->
+    { }
+    </style></head><body dir="ltr" style="max-width:20.999cm;margin-top:2cm; margin-bottom:2cm; margin-left:2cm; margin-right:2cm; "><h1 class="Heading_20_1"><a name="_OU_Blog"><span/></a>OU Blog</h1><h2 class="Heading_20_2"><a name="_Vervollstndigungsoptionen"><span/></a>Vervollstndigungsoptionen</h2><ul><li><p class="P2" style="margin-left:0.748cm;"><span class="Bullet_20_Symbols" style="display:block;float:left;min-width:0.499cm;">.</span>Wenn Sie 'Eintrge erforderlich' whlen, dann wird das Blog als abgeschlossen gekennzeichnet werden fr Nutzer sobald sie die entsprechende Anzahl an Eintrgen gemacht haben. <span class="odfLiEnd"/></p></li><li><p class="P1" style="margin-left:0.748cm;"><span class="Bullet_20_Symbols" style="display:block;float:left;min-width:0.499cm;">.</span>Wenn Sie 'Kommentare erforderlich' whlen, dann wird das Blog als abgeschlossen gekennzeichnet werden fr Nutzer sobald sie die entsprechende Anzahl an Kommentaren gemacht haben. Die Kommentare knnen in jeglichem Beitrag enthalten sein, solange sie in diesem Blog sind. <span class="odfLiEnd"/></p></li></ul><p class="Text_20_body">Beachten Sie, dass Kurs und persnliche Blogs separat sind. Beitrge und Kommentare zu persnlichen Blogs haben keinen Einfluss auf Kursblogs. </p><p class="Text_20_body"></p></body></html>
diff --git a/mod/oublog/lang/de/help/oublog/feeds.html b/mod/oublog/lang/de/help/oublog/feeds.html
new file mode 100644
index 0000000..7ee8831
--- /dev/null
+++ b/mod/oublog/lang/de/help/oublog/feeds.html
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!DOCTYPE html
+  PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0//EN" "http://www.w3.org/TR/MathML2/dtd/xhtml-math11-f.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml"><!--This file was converted to xhtml by OpenOffice.org - see http://xml.openoffice.org/odf2xhtml for more info.--><head profile="http://dublincore.org/documents/dcmi-terms/"><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title xml:lang="en-US">- no title specified</title><meta name="DCTERMS.title" content="" xml:lang="en-US"/><meta name="DCTERMS.language" content="en-US" scheme="DCTERMS.RFC4646"/><meta name="DCTERMS.source" content="http://xml.openoffice.org/odf2xhtml"/><meta name="DCTERMS.creator" content="Joachim Vogelgesang"/><meta name="DCTERMS.issued" content="2009-12-16T09:58:31" scheme="DCTERMS.W3CDTF"/><meta name="DCTERMS.contributor" content="Joachim Vogelgesang"/><meta name="DCTERMS.modified" content="2009-12-16T10:01:00" scheme="DCTERMS.W3CDTF"/><meta name="DCTERMS.provenance" content="" xml:lang="en-US"/><meta name="DCTERMS.subject" content="," xml:lang="en-US"/><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/" hreflang="en"/><link rel="schema.DCTERMS" href="http://purl.org/dc/terms/" hreflang="en"/><link rel="schema.DCTYPE" href="http://purl.org/dc/dcmitype/" hreflang="en"/><link rel="schema.DCAM" href="http://purl.org/dc/dcam/" hreflang="en"/><base href="."/><style type="text/css">
+    @page { size: 20.999cm 29.699cm; margin-top: 2cm; margin-bottom: 2cm; margin-left: 2cm; margin-right: 2cm }
+    table { border-collapse:collapse; border-spacing:0; empty-cells:show }
+    td, th { vertical-align:top; font-size:12pt;}
+    h1, h2, h3, h4, h5, h6 { clear:both }
+    ol, ul { margin:0; padding:0;}
+    li { list-style: none; margin:0; padding:0;}
+    li span.odfLiEnd { clear: both; line-height:0; width:0; height:0; margin:0; padding:0; }
+    span.footnodeNumber { padding-right:1em; }
+    * { margin:0; }
+    .Heading_20_1 { font-size:24pt; margin-bottom:0.212cm; margin-top:0.423cm; font-family:Times New Roman; font-weight:bold; }
+    .Heading_20_2 { font-size:18pt; margin-bottom:0.212cm; margin-top:0.423cm; font-family:Times New Roman; font-weight:bold; }
+    .Heading_20_3 { font-size:14pt; margin-bottom:0.212cm; margin-top:0.423cm; font-family:Times New Roman; font-weight:bold; }
+    .Text_20_body { font-size:12pt; font-family:Times New Roman; margin-top:0cm; margin-bottom:0.212cm; }
+    .Bullet_20_Symbols { font-family:OpenSymbol; }
+    <!-- ODF styles with no properties representable as CSS -->
+    { }
+    </style></head><body dir="ltr" style="max-width:20.999cm;margin-top:2cm; margin-bottom:2cm; margin-left:2cm; margin-right:2cm; "><h1 class="Heading_20_1"><a name="_OU_Blog"><span/></a>OU Blog</h1><h2 class="Heading_20_2"><a name="_Feeds"><span/></a>Feeds</h2><h3 class="Heading_20_3"><a name="_Automatische_Benachrichtigung"><span/></a>Automatische Benachrichtigung</h3><p class="Text_20_body">Wenn Sie ein News-Reader-Programm oder eine Website benutzen, knnen Sie die Internetadresse des Atom oder RSS Links angeben, um auf den neuesten Stand gebracht zu werden wenn neue Beitrge in diesem Blog erstellt wurden. </p><p class="Text_20_body">Wenn es das Blog erlaubt Kommentare gegen individuelle Beitrge abzugeben, sind zustzliche Nur Kommentare Atom und RSS Links mglich. Sie knnen diese nutzen, um sich auf den neuesten Stand zu bringen, sobald ein neuer Kommentar zu einem der Beitrge in diesem Blog hinzugefgt wurde. </p><p class="Text_20_body">Sie mssen aber dieses Feature nicht nutzen.</p><h3 class="Heading_20_3"><a name="_Atom_und_RSS"><span/></a>Atom und RSS</h3><p class="Text_20_body">Atom und RSS sind zwei Formate fr die selbe Sache. Das erste ist in technisch besserer Form, das letztere dafr bekannter. Probieren Sie den Atom-Feed, wenn dieser nicht funktionieren sollte, benutzen Sie den RSS-Feed. </p><p class="Text_20_body"></p><p class="Text_20_body"></p></body></html>
diff --git a/mod/oublog/lang/de/help/oublog/tags.html b/mod/oublog/lang/de/help/oublog/tags.html
new file mode 100644
index 0000000..c7fc9fa
--- /dev/null
+++ b/mod/oublog/lang/de/help/oublog/tags.html
@@ -0,0 +1,22 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!DOCTYPE html
+  PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0//EN" "http://www.w3.org/TR/MathML2/dtd/xhtml-math11-f.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml"><!--This file was converted to xhtml by OpenOffice.org - see http://xml.openoffice.org/odf2xhtml for more info.--><head profile="http://dublincore.org/documents/dcmi-terms/"><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title xml:lang="en-US">- no title specified</title><meta name="DCTERMS.title" content="" xml:lang="en-US"/><meta name="DCTERMS.language" content="en-US" scheme="DCTERMS.RFC4646"/><meta name="DCTERMS.source" content="http://xml.openoffice.org/odf2xhtml"/><meta name="DCTERMS.creator" content="Joachim Vogelgesang"/><meta name="DCTERMS.issued" content="2009-12-16T09:58:31" scheme="DCTERMS.W3CDTF"/><meta name="DCTERMS.contributor" content="Joachim Vogelgesang"/><meta name="DCTERMS.modified" content="2009-12-16T10:01:42" scheme="DCTERMS.W3CDTF"/><meta name="DCTERMS.provenance" content="" xml:lang="en-US"/><meta name="DCTERMS.subject" content="," xml:lang="en-US"/><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/" hreflang="en"/><link rel="schema.DCTERMS" href="http://purl.org/dc/terms/" hreflang="en"/><link rel="schema.DCTYPE" href="http://purl.org/dc/dcmitype/" hreflang="en"/><link rel="schema.DCAM" href="http://purl.org/dc/dcam/" hreflang="en"/><base href="."/><style type="text/css">
+    @page { size: 20.999cm 29.699cm; margin-top: 2cm; margin-bottom: 2cm; margin-left: 2cm; margin-right: 2cm }
+    table { border-collapse:collapse; border-spacing:0; empty-cells:show }
+    td, th { vertical-align:top; font-size:12pt;}
+    h1, h2, h3, h4, h5, h6 { clear:both }
+    ol, ul { margin:0; padding:0;}
+    li { list-style: none; margin:0; padding:0;}
+    li span.odfLiEnd { clear: both; line-height:0; width:0; height:0; margin:0; padding:0; }
+    span.footnodeNumber { padding-right:1em; }
+    * { margin:0; }
+    .Heading_20_1 { font-size:24pt; margin-bottom:0.212cm; margin-top:0.423cm; font-family:Times New Roman; font-weight:bold; }
+    .Heading_20_2 { font-size:18pt; margin-bottom:0.212cm; margin-top:0.423cm; font-family:Times New Roman; font-weight:bold; }
+    .Heading_20_3 { font-size:14pt; margin-bottom:0.212cm; margin-top:0.423cm; font-family:Times New Roman; font-weight:bold; }
+    .Text_20_body { font-size:12pt; font-family:Times New Roman; margin-top:0cm; margin-bottom:0.212cm; }
+    .Bullet_20_Symbols { font-family:OpenSymbol; }
+    .Strong_20_Emphasis { font-weight:bold; }
+    <!-- ODF styles with no properties representable as CSS -->
+    { }
+    </style></head><body dir="ltr" style="max-width:20.999cm;margin-top:2cm; margin-bottom:2cm; margin-left:2cm; margin-right:2cm; "><h1 class="Heading_20_1"><a name="_OU_Blog"><span/></a>OU Blog</h1><h2 class="Heading_20_2"><a name="_Tags"><span/></a>Tags</h2><h3 class="Heading_20_3"><a name="_Was_sind_Tags?"><span/></a>Was sind Tags?</h3><p class="Text_20_body">Tags sind kurze Textstcke, die verwendet werden, um Ihre Blog-Beitrge zu kategorisieren. Sie werden im Allgemeinen in Kleinbuchstaben angezeigt. Die meisten Tags bestehen aus einem einzigen Wort, aber Sie knnen auch mehrere Wrter benutzen, wenn Sie mchten.</p><p class="Text_20_body">Setzen Sie Tags in das <span class="Strong_20_Emphasis">Tags</span> Feld wenn Sie einen Beitrag erstellen oder bearbeiten. Tags sind optional, Sie knnen das Feld auch leer lassen.</p><p class="Text_20_body">Beispiel: Wenn Sie oft ber Ihre Katze Fluffy schreiben, mchten Sie vielleicht den Tag <span class="Strong_20_Emphasis">Fluffy</span> fr diese Beitrge verwenden.</p><h3 class="Heading_20_3"><a name="_Mehrfach_Tags"><span/></a>Mehrfach Tags</h3><p class="Text_20_body">Sie knnen Mehrfach Tags in Ihrem Beitrag benutzen indem Sie sie durch Kommata trennen. Dies kann ntzlich sein, wenn Ihr Beitrag mehr als ein Thema abdeckt.</p><p class="Text_20_body">Beispiel: <span class="Strong_20_Emphasis">Fluffy, Globale Erwrmung</span></p><h3 class="Heading_20_3"><a name="_Nach_Tags_suchen"><span/></a>Nach Tags suchen</h3><p class="Text_20_body">Wenn Sie Tags in Ihren Beitrgen benutzen, erscheint der <span class="Strong_20_Emphasis">Tags</span> Block auf der Hauptseite des Blocks. Dies zeigt alle von Ihnen benutzten Tags. Sie knnen dann auf einen Tag klicken um alle Stellen zu sehen, die diesen Tag enthalten.</p><p class="Text_20_body">Beispiel: ein Leser, der an globaler Erwrmung interessiert ist, mag den <span class="Strong_20_Emphasis">Globale Erwrmung</span> Tag anklicken so dass er all die Stellen ber globale Erwrmung liest, ohne zu viele Beitrge ber Ihre Katze lesen zu mssen.</p><p class="Text_20_body"></p><p class="Text_20_body"></p><p class="Text_20_body"></p></body></html>
diff --git a/mod/oublog/lang/de/help/oublog/visibility.html b/mod/oublog/lang/de/help/oublog/visibility.html
new file mode 100644
index 0000000..d2e179b
--- /dev/null
+++ b/mod/oublog/lang/de/help/oublog/visibility.html
@@ -0,0 +1,24 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!DOCTYPE html
+  PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0//EN" "http://www.w3.org/TR/MathML2/dtd/xhtml-math11-f.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml"><!--This file was converted to xhtml by OpenOffice.org - see http://xml.openoffice.org/odf2xhtml for more info.--><head profile="http://dublincore.org/documents/dcmi-terms/"><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title xml:lang="en-US">- no title specified</title><meta name="DCTERMS.title" content="" xml:lang="en-US"/><meta name="DCTERMS.language" content="en-US" scheme="DCTERMS.RFC4646"/><meta name="DCTERMS.source" content="http://xml.openoffice.org/odf2xhtml"/><meta name="DCTERMS.creator" content="Joachim Vogelgesang"/><meta name="DCTERMS.issued" content="2009-12-16T09:58:31" scheme="DCTERMS.W3CDTF"/><meta name="DCTERMS.contributor" content="Joachim Vogelgesang"/><meta name="DCTERMS.modified" content="2009-12-16T10:02:20" scheme="DCTERMS.W3CDTF"/><meta name="DCTERMS.provenance" content="" xml:lang="en-US"/><meta name="DCTERMS.subject" content="," xml:lang="en-US"/><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/" hreflang="en"/><link rel="schema.DCTERMS" href="http://purl.org/dc/terms/" hreflang="en"/><link rel="schema.DCTYPE" href="http://purl.org/dc/dcmitype/" hreflang="en"/><link rel="schema.DCAM" href="http://purl.org/dc/dcam/" hreflang="en"/><base href="."/><style type="text/css">
+    @page { size: 20.999cm 29.699cm; margin-top: 2cm; margin-bottom: 2cm; margin-left: 2cm; margin-right: 2cm }
+    table { border-collapse:collapse; border-spacing:0; empty-cells:show }
+    td, th { vertical-align:top; font-size:12pt;}
+    h1, h2, h3, h4, h5, h6 { clear:both }
+    ol, ul { margin:0; padding:0;}
+    li { list-style: none; margin:0; padding:0;}
+    li span.odfLiEnd { clear: both; line-height:0; width:0; height:0; margin:0; padding:0; }
+    span.footnodeNumber { padding-right:1em; }
+    * { margin:0; }
+    .Heading_20_1 { font-size:24pt; margin-bottom:0.212cm; margin-top:0.423cm; font-family:Times New Roman; font-weight:bold; }
+    .Heading_20_2 { font-size:18pt; margin-bottom:0.212cm; margin-top:0.423cm; font-family:Times New Roman; font-weight:bold; }
+    .P2 { font-size:12pt; margin-bottom:0.212cm; margin-top:0cm; font-family:Times New Roman; }
+    .P4 { font-size:12pt; margin-bottom:0cm; margin-top:0cm; font-family:Times New Roman; }
+    .Text_20_body { font-size:12pt; font-family:Times New Roman; margin-top:0cm; margin-bottom:0.212cm; }
+    .Bullet_20_Symbols { font-family:OpenSymbol; }
+    .Emphasis { font-style:italic; }
+    .Strong_20_Emphasis { font-weight:bold; }
+    <!-- ODF styles with no properties representable as CSS -->
+    .Numbering_20_Symbols { }
+    </style></head><body dir="ltr" style="max-width:20.999cm;margin-top:2cm; margin-bottom:2cm; margin-left:2cm; margin-right:2cm; "><h1 class="Heading_20_1"><a name="_OU_Blog"><span/></a>OU Blog</h1><h2 class="Heading_20_2"><a name="_Sichtbarkeit"><span/></a>Sichtbarkeit</h2><p class="Text_20_body">Blog-Beitrge haben eine Option, die steuert, wer die Beitrge sehen darf. Es gibt bis zu drei Mglichkeiten in aufsteigender Reihenfolge die Sichtbarkeit zu erlauben. Die erste Mglichkeit ist, dass ein persnliches Blog anders ist als das in einem Kurs.</p><ol><li><p class="P2" style="margin-left:0.748cm;"><span class="Numbering_20_Symbols" style="display:block;float:left;min-width:0.499cm;">1.</span><span class="Emphasis">In einem persnlichen Blog:</span> <span class="Strong_20_Emphasis">Sichtbar nur fr den Blogbesitzer (privat)</span>  niemand* anderes kann diesen Beitrag sehen.<span class="odfLiEnd"/></p><p class="P2" style="margin-left:0.748cm;"><span class="Emphasis">In einem Kurs Blog:</span> <span class="Strong_20_Emphasis">Sichtbar fr Teilnehmer des Kurses</span>  um den Beitrag sehen zu knnen, mssen Sie Zugang zu dem Blog haben, normalerweise indem Sie in den Kurs eingeschrieben sind, in dem dieses Blog enthalten ist.</p></li><li><p class="P4" style="margin-left:0.748cm;"><span class="Numbering_20_Symbols" style="display:block;float:left;min-width:0.499cm;">2.</span><span class="Strong_20_Emphasis">Sichtbar fr jedermann, der in das System eingeloggt ist</span>  jedermann, der eingeloggt ist, kann den Beitrag sehen, selbst ohne Einschreibung in einen bestimmten Kurs. <span class="odfLiEnd"/></p></li><li><p class="P2" style="margin-left:0.748cm;"><span class="Numbering_20_Symbols" style="display:block;float:left;min-width:0.499cm;">3.</span><span class="Strong_20_Emphasis">Sichtbar fr jedermann weltweit</span>  jeder Internet Nutzer kann den Beitrag sehen, wenn Sie die Blogadresse verffentlichen. <span class="odfLiEnd"/></p></li></ol><p class="Text_20_body">Diese Option besteht fr das komplette Blog wie auch fr individuelle Beitrge. Wenn die Option fr das ganze Blog gesetzt ist, ist sie vorrangig. Zum Beispiel, wenn das ganze Blog auf die erste Stufe gesetzt wird, knnen Sie nicht die Stufen der individuellen Beitrge verndern.</p><p class="Text_20_body">* <span class="Emphasis">Systemadministratoren haben Zugriff zu allen gespeicherten Daten dieses speziellen EDV-Systems einschlielich der als 'privat' markierten Beitrge.</span></p><p class="Text_20_body"></p></body></html>
diff --git a/mod/oublog/lang/de/oublog.php b/mod/oublog/lang/de/oublog.php
new file mode 100644
index 0000000..c111e3c
--- /dev/null
+++ b/mod/oublog/lang/de/oublog.php
@@ -0,0 +1,139 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+$string['oublog'] = 'OU Blog';
+$string['modulename'] = 'OU Blog';
+$string['modulenameplural'] = 'OU Blogs';
+
+$string['oublog:view'] = 'Beitrge anschauen';
+$string['oublog:viewpersonal'] = 'Beitrge anschauen in den persnlichen Blogs';
+$string['oublog:contributepersonal'] = 'In persnlichen Blogs verschicken und kommentieren';
+$string['oublog:post'] = 'Einen neuen Beitrag erstellen';
+$string['oublog:comment'] = 'Kommentar zu einem Beitrag';
+$string['oublog:managecomments'] = 'Kommentare verwalten';
+$string['oublog:manageposts'] = 'Beitrge verwalten';
+$string['oublog:managelinks'] = 'Links verwalten';
+$string['oublog:audit'] = 'Gelschte Beitrge und alte Versionen anschauen';
+
+
+$string['newpost'] = 'Neuer Blogbeitrag';
+$string['title'] = 'Titel';
+$string['message'] = 'Nachricht';
+$string['tags'] = 'Tags';
+$string['tagsfield'] = 'Tags (durch Kommata getrennt)';
+$string['allowcomments'] = 'Kommentare erlauben';
+$string['nocomments'] = 'Kommentare sind nicht erlaubt';
+$string['visibility'] = 'Wer kann das lesen?';
+$string['maxvisibility'] = 'Maximale Sichtbarkeit';
+$string['yes'] = 'Ja';
+$string['no'] = 'Nein';
+$string['blogname'] = 'Blog Name';
+$string['summary'] = 'Zusammenfassung';
+
+$string['visibleyou'] = 'Nur fr Blogbesitzer sichtbar (privat)';
+$string['visiblecourseusers'] = 'Fr Teilnehmer dieses Kurses sichtbar';
+$string['visibleblogusers'] = 'Nur sichtbar fr Teilnehmer dieses Blogs';
+$string['visibleloggedinusers'] = 'Sichtbar fr jeden, der in das System eingeloggt ist';
+$string['visiblepublic'] = 'Sichtbar fr jedermann weltweit';
+
+
+$string['addpost'] = 'Blogbeitrag hinzufgen';
+$string['editpost'] = 'Blogbeitrag aktualisieren';
+$string['editsummary'] = 'Bearbeitet von {$a->editby}, {$a->editdate}';
+$string['editonsummary'] = 'Bearbeitet {$a->editdate}';
+
+$string['edit'] = 'Bearbeiten';
+$string['delete'] = 'Lschen';
+
+$string['olderposts'] = '&lt; ltere Beitrge';
+$string['newerposts'] = 'Neuere Beitrge &gt;';
+$string['extranavolderposts'] = 'ltere Beitrge: {$a->von}-{$a->an}';
+$string['extranavtag'] = 'Tag: {$a}';
+
+$string['comments'] = 'Kommentare';
+$string['ncomments'] = '{$a} Kommentare';
+$string['1comment'] = '1 Kommentar';
+$string['comment'] = 'Fgen Sie Ihren Kommentar hinzu';
+$string['lastcomment'] = '(Letzter von {$a->fullname}, {$a->timeposted})';
+$string['addcomment'] = 'Kommentar hinzufgen';
+
+$string['confirmdeletepost'] = 'Sind Sie sicher diesen Blogbeitrag lschen zu wollen?';
+$string['confirmdeletecomment'] = 'Sind Sie sicher diesen Kommentar lschen zu wollen?';
+$string['confirmdeletelink'] = 'Sind Sie sicher diesen Link lschen zu wollen?';
+
+$string['viewedit'] = 'Bearbeitung anschauen';
+$string['views'] = 'Alle Besuche in diesem Blog:';
+
+$string['addlink'] = 'Link hinzufgen';
+$string['links'] = 'hnliche Links';
+
+$string['subscribefeed'] = 'Einen Feed abonnieren (erfordert entsprechende Software) um eine Nachricht zu erhalten wenn der Blog aktualisiert wurde.';
+$string['feeds'] = 'Feeds';
+$string['blogfeed'] = 'Blog Feeds';
+$string['commentsfeed'] = 'Nur Kommentare';
+$string['atom'] = 'Atom';
+$string['rss'] = 'RSS';
+$string['atomfeed'] = 'Atom Feed';
+$string['rssfeed'] = 'RSS Feed';
+
+$string['newblogposts'] = 'Neue Blogbeitrge';
+
+$string['blogsummary'] = 'Blogzusammenfassung';
+$string['posts'] = 'Beitrge';
+
+$string['defaultpersonalblogname'] = '{$a}\'s Blog';
+
+$string['numposts'] = '{$a} Beitrge';
+
+$string['noblogposts'] = 'Keine Blogbeitrge';
+
+$string['blogoptions'] = 'Blog Optionen';
+
+$string['postedby'] = 'von {$a}';
+
+$string['deletedby'] = 'Gelscht von {$a->fullname}, {$a->timedeleted}';
+
+$string['newcomment'] = 'Neuer Blogkommentar';
+
+$string['searchthisblog'] = 'Dieses Blog suchen';
+$string['searchblogs'] = 'Blogs suchen';
+
+$string['url']='Volle Webadresse';
+
+$string['bloginfo']='Bloginformation';
+
+$string['feedhelp']='Feeds';
+
+$string['unsupportedbrowser']='<p>Ihr Browser kann keine Atom oder RSS Feeds direkt anzeigen.</p>
+<p>Feeds sind sehr ntzlich in separaten Computer-Programmen oder Websites. Wenn Sie dieses Feed in einem solchen Programm benutzen mchten, kopieren und fgen Sie die Adresse von Ihrer Browser-Adressleiste ein.</p>';
+
+$string['completionpostsgroup']='Beitrge erforderlich';
+$string['completionposts']='Nutzer muss Blogbeitrge erstellen:';
+$string['completionpostshelp']='Zur Vervollstndigung werden Beitrge bentigt';
+$string['completioncommentsgroup']='Kommentare erforderlich';
+$string['completioncomments']='Sie mssen Blogbeitrge kommentieren:';
+$string['completioncommentshelp']='Zur Vervollstndigung werden Kommentare bentigt';
+
+$string['maybehiddenposts']='Dieses Blog beinhaltet mglicherweise Eintrge, die nur fr eingeloggte Teilnehmer sichtbar sind. Wenn Sie einen Account fr das System haben, bitte <a href=\'{$a}\'>loggen Sie sich fr vollen Blogzugang ein</a>.';
+$string['guestblog']='Wenn Sie einen Account auf dem System haben, bitte
+<a href=\'{$a}\'>fr vollen Blogzugang einloggen </a>.';
+$string['noposts']='Es gibt keine sichtbaren Beitrge in diesem Blog.';
+
+$string['accessdenied']='Entschuldigung: Sie haben keinen Zugriff auf diese Seite.';
+$string['siteentries'] = 'Seiteneintrge sehen';
+$string['overviewnumentrylog1'] = 'Eintrag seit letztem Login';
+$string['overviewnumentrylog'] = 'Eintrge seit letztem Login';
+$string['overviewnumentryvw1'] = 'Eintrag seit dem letzten Anschauen';
+$string['overviewnumentryvw'] = 'Eintrge seit dem letzten Anschauen';
\ No newline at end of file
diff --git a/mod/oublog/lang/en/oublog.php b/mod/oublog/lang/en/oublog.php
new file mode 100644
index 0000000..90f750a
--- /dev/null
+++ b/mod/oublog/lang/en/oublog.php
@@ -0,0 +1,651 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+$string['attachments'] = "Attachments";
+$string['oublog'] = 'OU blog';
+$string['modulename'] = 'OU blog';
+$string['modulenameplural'] = 'OU blogs';
+$string['modulename_help'] = 'This allows for the creation of blogs within a module (which are separate
+to the core Moodle blog system). You can have module-wide blogs (everyone in the module posts to the same
+blog), group blogs, or individual blogs. The blog activity can be renamed to reflect its purpose e.g. Learning Log.';
+
+$string['oublogintro'] = 'Intro';
+$string['lastmodified'] = 'Last post: {$a}';
+$string['strftimerecent'] = '%d %B %y, %H:%M';
+
+$string['oublog:view'] = 'View posts';
+$string['oublog:addinstance'] = 'Add a new OU blog';
+$string['oublog:viewpersonal'] = 'View posts in personal blogs';
+$string['oublog:viewprivate'] = 'View private posts in personal blogs';
+$string['oublog:contributepersonal'] = 'Post and comment in personal blogs';
+$string['oublog:post'] = 'Create a new post';
+$string['oublog:comment'] = 'Comment on a post';
+$string['oublog:managecomments'] = 'Manage comments';
+$string['oublog:manageposts'] = 'Manage posts';
+$string['oublog:managelinks'] = 'Manage links';
+$string['oublog:audit'] = 'View deleted posts and old versions';
+$string['oublog:viewindividual'] = 'View individual blogs';
+$string['oublog:exportownpost'] = 'Export own post';
+$string['oublog:exportpost'] = 'Export post';
+$string['oublog:exportposts'] = 'Export posts';
+$string['oublog:ignorepostperiod'] = 'Ignore post time period';
+$string['oublog:ignorecommentperiod'] = 'Ignore comment time period';
+
+$string['advancedoptions'] = 'Advanced options';
+$string['limits'] = 'Contribution time period';
+$string['postfrom'] = 'Posting only allowed from';
+$string['postuntil'] = 'Posting only allowed until';
+$string['commentfrom'] = 'Commenting only allowed from';
+$string['commentuntil'] = 'Commenting only allowed until';
+$string['beforestartpost'] = 'You cannot create posts at this time. Post creation is available from {$a}.';
+$string['beforestartpostcapable'] = 'Students cannot create their own posts until {$a}.
+<br/> You have access to create posts before this time.';
+$string['beforeendpost'] = 'You can only create posts until {$a}.';
+$string['beforeendpostcapable'] = 'Students are able to create their own posts until {$a}.
+<br/> You have access to create posts after this time.';
+$string['afterendpost'] = 'You cannot create posts at this time. Post creation ended on {$a}.';
+$string['afterendpostcapable'] = 'Students were able to create their own posts until {$a}.
+<br/> You have access to create posts after this time.';
+$string['beforestartcomment'] = 'You cannot comment on posts at this time. Commenting is available from {$a}.';
+$string['beforestartcommentcapable'] = 'Students cannot comment on posts until {$a}.
+<br/> You have access to comment before this time.';
+$string['beforeendcomment'] = 'You can only comment on posts until {$a}.';
+$string['beforeendcommentcapable'] = 'Students are able to comment on posts until {$a}.
+<br/> You have access to comment after this time.';
+$string['afterendcomment'] = 'You cannot comment on posts at this time. Commenting ended on {$a}.';
+$string['afterendcommentcapable'] = 'Students were able to comment on posts until {$a}.
+<br/> You have access to comment after this time.';
+
+$string['mustprovidepost'] = 'Must provide postid';
+$string['newpost'] = 'New {$a} post';
+$string['removeblogs'] = 'Remove all blog entries';
+$string['title'] = 'Title';
+$string['message'] = 'Message';
+$string['tags'] = 'Tags';
+$string['tagsfield'] = 'Tags (separated by commas)';
+$string['allowcomments'] = 'Allow comments';
+$string['allowcommentsmax'] = 'Allow comments (if chosen for post)';
+$string['logincomments'] = 'Yes, from logged-in users';
+$string['permalink'] = 'Permalink';
+$string['publiccomments'] = 'Yes, from everybody (even if not logged in)';
+$string['publiccomments_info'] = 'If somebody adds a comment when they are not
+logged in, you will receive email notification and can approve the comment for
+display, or reject it. This is necessary in order to prevent spam.';
+$string['error_grouppubliccomments'] = 'You cannot allow public comments when the blog is in group mode';
+$string['nocomments'] = 'Comments not allowed';
+$string['visibility'] = 'Who can read this?';
+$string['visibility_help'] = '
+<p><strong>Visible to participants on this course</strong> &ndash; to view the post you must
+have been granted access to the activity, usually by being enrolled on the course that contains it.</p>
+
+<p><strong>Visible to everyone who is logged in to the system</strong> &ndash; everyone who is
+logged in can view the post, even if they\'re not enrolled on a specific course.</p>
+<p><strong>Visible to anyone in the world</strong> &ndash; any Internet user can see this post
+if you give them the address.</p>';
+$string['maxvisibility'] = 'Maximum visibility';
+$string['yes'] = 'Yes';
+$string['no'] = 'No';
+$string['blogname'] = 'Blog name';
+$string['summary'] = 'Summary';
+$string['statblockon'] = 'Show blog usage extra statistics';
+$string['statblockon_help'] = 'Enable extra statistics display in the Blog usage \'block\'.
+Personal (global), Visible Individual and Visible Group blogs only.';
+$string['oublogallpostslogin'] = 'Force login on all posts page';
+$string['oublogallpostslogin_desc'] = 'Enable to force login to the personal blog site entries page.
+When enabled only logged-in users will see the link to this page.';
+
+$string['globalusageexclude'] = 'Exclude from global usage stats';
+$string['globalusageexclude_desc'] = 'Comma-separated list of user ids to exclude users from the top usage stats list for global blog';
+
+$string['introonpost'] = 'Show intro when posting';
+
+$string['displayname_default'] = 'blog';
+$string['displayname'] = 'Alternate activity name (blank uses default)';
+$string['displayname_help'] = 'Set an alternate activity type name within the interface.
+
+Leaving blank/empty will mean the default (\'blog\') is used.
+
+The alternate name should start with a lower-case letter, this will be capitalised where needed.';
+
+$string['visibleyou'] = 'Visible only to the blog owner (private)';
+$string['visiblecourseusers'] = 'Visible to participants on this course';
+$string['visibleblogusers'] = 'Visible only to members of this blog';
+$string['visibleloggedinusers'] = 'Visible to everyone who is logged in to the system';
+$string['visiblepublic'] = 'Visible to anyone in the world';
+$string['invalidpostid'] = 'Invalid Postid';
+
+$string['addpost'] = 'Add post';
+$string['editpost'] = 'Update post';
+$string['editsummary'] = 'Edited by {$a->editby}, {$a->editdate}';
+$string['editonsummary'] = 'Edited {$a->editdate}';
+
+$string['edit'] = 'Edit';
+$string['delete'] = 'Delete';
+
+$string['olderposts'] = 'Previous posts';
+$string['newerposts'] = 'Newer posts';
+$string['extranavolderposts'] = 'Older posts: {$a->from}-{$a->to}';
+$string['extranavtag'] = 'Tag: {$a}';
+
+$string['comments'] = 'Comments';
+$string['recentcomments'] = 'Recent comments';
+$string['ncomments'] = '{$a} comments';
+$string['onecomment'] = '{$a} comment';
+$string['npending'] = '{$a} comments awaiting approval';
+$string['onepending'] = '{$a} comment awaiting approval';
+$string['npendingafter'] = ', {$a} awaiting approval';
+$string['onependingafter'] = ', {$a} awaiting approval';
+$string['comment'] = 'Add your comment';
+$string['lastcomment'] = '(latest comment by {$a->fullname}, {$a->timeposted})';
+$string['addcomment'] = 'Add comment';
+
+$string['confirmdeletepost'] = 'Are you sure you want to delete this post?';
+$string['confirmdeletecomment'] = 'Are you sure you want to delete this comment?';
+$string['confirmdeletelink'] = 'Are you sure you want to delete this link?';
+
+$string['viewedit'] = 'View edit';
+$string['views'] = 'Total visits to this {$a}:';
+
+$string['addlink'] = 'Add link';
+$string['editlink'] = 'Edit link';
+$string['links'] = 'Related links';
+
+$string['subscribefeed'] = 'Subscribe to a feed (requires appropriate software) to receive notification when this {$a} is updated.';
+$string['feeds'] = 'Feeds';
+$string['blogfeed'] = '{$a} feeds';
+$string['commentsfeed'] = 'Comments only';
+$string['atom'] = 'Atom';
+$string['rss'] = 'RSS';
+$string['atomfeed'] = 'Atom feed';
+$string['rssfeed'] = 'RSS feed';
+
+$string['newblogposts'] = 'New blog posts';
+
+$string['blogsummary'] = 'Blog summary';
+$string['posts'] = 'Posts';
+
+$string['defaultpersonalblogname'] = '{$a->name}\'s {$a->displayname}';
+
+$string['numposts'] = '{$a} posts';
+
+$string['noblogposts'] = 'No blog posts';
+
+$string['blogoptions'] = 'Blog options';
+
+$string['postedby'] = 'by {$a}';
+$string['postedbymoderated'] = 'by {$a->commenter} (approved by {$a->approver}, {$a->approvedate})';
+$string['postedbymoderatedaudit'] = 'by {$a->commenter} [{$a->ip}] (approved by {$a->approver}, {$a->approvedate})';
+
+$string['deletedby'] = 'Deleted by {$a->fullname}, {$a->timedeleted}';
+
+$string['newcomment'] = 'New comment';
+$string['postmessage'] = 'Post';
+
+$string['searchthisblog'] = 'Search this {$a}';
+$string['searchblogs'] = 'Search';
+$string['searchblogs_help'] = 'Type your search term and press Enter or click the button.
+
+To search for exact phrases use quote marks.
+
+To exclude a word insert a hyphen immediately before the word.
+
+Example: the search term <tt>picasso -sculpture &quot;early works&quot;</tt> will return results for &lsquo;picasso&rsquo; or the phrase &lsquo;early works&rsquo; but will exclude items containing &lsquo;sculpture&rsquo;.';
+
+$string['url'] = 'Full Web address';
+
+$string['bloginfo'] = 'blog information';
+
+$string['feedhelp'] = 'Feeds';
+$string['feedhelp_help'] = 'If you use feeds you can add these Atom or RSS links in order to keep up to date with posts.
+Most feed readers support Atom and RSS.
+
+If comments are enabled there are also feeds for &lsquo;Comments only&rsquo;.';
+$string['unsupportedbrowser'] = '<p>Your browser cannot display Atom or RSS feeds directly.</p>
+<p>Feeds are most useful in separate computer programs or websites. If you want
+to use this feed in such a program, copy and paste the address from your browser\'s
+address bar.</p>';
+
+$string['completionpostsgroup'] = 'Require posts';
+$string['completionpostsgroup_help'] = 'If you enable this option, the blog will be marked as complete for a student once they have made the specified number of posts.';
+$string['completionposts'] = 'User must make blog posts:';
+$string['completioncommentsgroup'] = 'Require comments';
+$string['completioncommentsgroup_help'] = 'If you enable this option, the blog will be marked as complete for a student once they have left the specified number of comments.';
+$string['completioncomments'] = 'User must make comments on blog posts:';
+
+$string['computingguide'] = 'Guide to OU blogs';
+$string['computingguideurl'] = 'Computing guide URL';
+$string['computingguideurlexplained'] = 'Enter the URL for the OU blogs omputing guide';
+
+$string['maybehiddenposts'] = 'This {$a->name} might contain posts that are only
+visible to logged-in users, or where only logged-in users can comment. If you
+have an account on the system, please <a href=\'{$a->link}\'>log in for full access</a>.';
+$string['guestblog'] = 'If you have an account on the system, please
+<a href=\'{$a}\'>log in for full access</a>.';
+$string['noposts'] = 'There are no visible posts in this {$a}.';
+$string['nopostsnotags'] = 'There are no visible posts in this {$a->blog}, for this tag {$a->tag}.';
+
+// Errors.
+$string['accessdenied'] = 'Sorry: you do not have access to view this page.';
+$string['invalidpost'] = 'Invalid Post Id';
+$string['invalidcomment'] = 'Invalid Comment Id';
+$string['invalidblog'] = 'Invalid Blog Id';
+$string['invalidedit'] = 'Invalid Edit Id';
+$string['invalidlink'] = 'Invalid Link Id';
+$string['personalblognotsetup'] = 'Personal blogs not set up';
+$string['tagupdatefailed'] = 'Failed to update tags';
+$string['commentsnotallowed'] = 'Comments are not allowed';
+$string['couldnotaddcomment'] = 'Could not add comment';
+$string['onlyworkspersonal'] = 'Only works for personal blogs';
+$string['couldnotaddlink'] = 'Could not add link';
+$string['notaddpostnogroup'] = 'Can\'t add post with no group';
+$string['notaddpost'] = 'Could not add post';
+$string['feedsnotenabled'] = 'Feeds are not enabled';
+$string['invalidformat'] = 'Format must be atom or rss';
+$string['deleteglobalblog'] = 'You can\'t delete the global blog';
+$string['globalblogmissing'] = 'Global blog is missing';
+$string['invalidvisibility'] = 'Invalid visbility level';
+$string['invalidvisbilitylevel'] = 'Invalid visibility level {$a}';
+$string['invalidblogdetails'] = 'Can\'t find details for blog post {$a}';
+
+$string['siteentries'] = 'View site entries';
+$string['overviewnumentrylog1'] = 'entry since last log in';
+$string['overviewnumentrylog'] = 'entries since last log in';
+$string['overviewnumentryvw1'] = 'entry since last viewed';
+$string['overviewnumentryvw'] = 'entries since last viewed';
+
+$string['individualblogs'] = 'Individual blogs';
+$string['no_blogtogetheroringroups'] = 'No (blog together or in groups)';
+$string['separateindividualblogs'] = 'Separate individual blogs';
+$string['visibleindividualblogs'] = 'Visible individual blogs';
+
+$string['separateindividual'] = 'Separate&nbsp;individuals';
+$string['visibleindividual'] = 'Visible&nbsp;individuals';
+$string['viewallusers'] = 'View all users';
+$string['viewallusersingroup'] = 'View all users in group';
+
+$string['re'] = 'Re: {$a}';
+
+$string['moderated_info'] = 'Because you are not logged in, your comment will
+only appear after it has been approved. If you
+have an account on the system, please <a href=\'{$a}\'>log in for full blog access</a>.';
+$string['moderated_authorname'] = 'Your name';
+$string['moderated_confirmvalue'] = 'yes';
+$string['moderated_confirminfo'] = 'Please enter <strong>yes</strong> below to confirm that you are a person.';
+$string['moderated_confirm'] = 'Confirmation';
+$string['moderated_addedcomment'] = 'Thank you for adding your comment, which has been successfully received. Your comment won\'t appear until it has been approved by the author of this post.';
+$string['moderated_submitted'] = 'Awaiting moderation';
+$string['moderated_typicaltime'] = 'In the past, this has usually taken about {$a}.';
+$string['error_noconfirm'] = 'Enter the bold text above, exactly as given, into this box.';
+$string['error_toomanycomments'] = 'You have made too many blog comments in the past hour from this internet address. Please wait a while then try again.';
+$string['moderated_awaiting'] = 'Comments awaiting approval';
+$string['moderated_awaitingnote'] = 'These comments are not visible to other users unless you approve them. Bear in mind that the system does not know the identity of commenters and comments may contain links which, if followed, could seriously <strong>damage your computer</strong>. If you are in any doubt, please reject comments <strong>without following any links</strong>.';
+$string['moderated_postername'] = 'using the name <strong>{$a}</strong>';
+$string['error_alreadyapproved'] = 'Comment already approved or rejected';
+$string['error_wrongkey'] = 'Comment key incorrect';
+$string['error_unspecified'] = 'The system cannot complete this request because an error occurred ({$a})';
+$string['error_moderatednotallowed'] = 'Moderated comments are no longer allowed on this blog or blog post';
+$string['moderated_approve'] = 'Approve this comment';
+$string['moderated_reject'] = 'Reject this comment';
+$string['moderated_rejectedon'] = 'Rejected {$a}:';
+$string['moderated_restrictpost'] = 'Restrict commenting on this post';
+$string['moderated_restrictblog'] = 'Restrict commenting on all your posts on this blog';
+$string['moderated_restrictpage'] = 'Restrict commenting';
+$string['moderated_restrictpost_info'] = 'Would you like to restrict comments on this post so that only people who are logged into the system can add comments?';
+$string['moderated_restrictblog_info'] = 'Would you like to restrict comments on all your posts on this blog so that only people who are logged into the system can add comments?';
+$string['moderated_emailsubject'] = 'Comment awaiting approval on: {$a->blog} ({$a->commenter})';
+$string['moderated_emailhtml'] =
+'<p>(This is an automatically-generated email. Please do not reply.)</p>
+<p>Someone has added a comment to your blog post: {$a->postlink}</p>
+<p>You need to <strong>approve the comment</strong> before it will appear in public.</p>
+<p>The system does not know the identity of the commenter and comments may
+contain links which, if followed, could seriously <strong>damage your
+computer</strong>. If you are in any doubt, please reject the comment
+<strong>without following any links</strong>.</p>
+<p>If you approve the comment, you take responsibility for posting it. Make sure
+it doesn\'t contain anything that\'s against the rules.</p>
+<hr/>
+<p>Name given: {$a->commenter}</p>
+<hr/>
+<h3>{$a->commenttitle}</h3>
+{$a->comment}
+<hr/>
+<ul class=\'oublog-approvereject\'>
+<li><a href=\'{$a->approvelink}\'>{$a->approvetext}</a></li>
+<li><a href=\'{$a->rejectlink}\'>{$a->rejecttext}</a></li>
+</ul>
+<p>
+You can also ignore this email. The comment will be rejected automatically
+after 30 days.
+</p>
+<p>
+If you receive too many of these emails, you may wish to restrict commenting
+to logged-in users only.
+</p>
+<ul class=\'oublog-restrict\'>
+<li><a href=\'{$a->restrictpostlink}\'>{$a->restrictposttext}</a></li>
+<li><a href=\'{$a->restrictbloglink}\'>{$a->restrictblogtext}</a></li>
+</ul>';
+$string['moderated_emailtext'] =
+'This is an automatically-generated email. Please do not reply.
+
+Someone has added a comment to your blog post:
+{$a->postlink}
+
+You need to approve the comment before it will appear in public.
+
+The system does not know the identity of the commenter and comments may
+contain links which, if followed, could seriously damage your computer.
+If you are in any doubt, please reject the comment without following any
+links.
+
+If you approve the comment, you take responsibility for posting it. Make
+sure it doesn\'t contain anything that\'s against the rules.
+
+-----------------------------------------------------------------------
+Name given: {$a->commenter}
+-----------------------------------------------------------------------
+{$a->commenttitle}
+{$a->comment}
+-----------------------------------------------------------------------
+
+* {$a->approvetext}:
+  {$a->approvelink}
+
+* {$a->rejecttext}:
+  {$a->rejectlink}
+
+You can also ignore this email. The comment will be rejected automatically
+after 30 days.
+
+If you receive too many of these emails, you may wish to restrict
+commenting to logged-in users only.
+
+* {$a->restrictposttext}:
+  {$a->restrictpostlink}
+
+* {$a->restrictblogtext}:
+  {$a->restrictbloglink}
+';
+
+$string['displayversion'] = 'OU blog version: <strong>{$a}</strong>';
+
+$string['pluginadministration'] = 'OU Blog administration';
+$string['pluginname'] = 'OU Blog';
+// Help strings.
+$string['allowcomments_help'] = '&lsquo;Yes, from signed-on users&rsquo; allows comments from users who have access to the post.
+
+&lsquo;Yes, from everybody&rsquo; allows comments from users and from the general public. You will receive emails to approve or reject comments from users who are not signed in.
+
+&lsquo;No&rsquo; prevents anyone from making a comment on this post.';
+$string['individualblogs_help'] = '
+<p><strong>No (blog together or in group)</strong>: <em>Individual blogs are not used</em> &ndash;
+There are no individual blogs set, everyone is part of a bigger community
+(depending on \'Group mode\' setting).</p>
+<p><strong>Separate individual blogs</strong>: <em>Individual blogs are used privately</em> &ndash;
+Individual users can only post to and see their own blogs,  unless they have permission("viewindividual") to view
+other individual blogs.</p>
+<p><strong>Visible individual blogs</strong>: <em>Individual blogs are used publically</em> &ndash;
+individual users can only post to their own blogs, but they can view other individual blog posts.</p>';
+
+$string['maxvisibility_help'] = '
+<p><em>On a personal blog:</em> <strong>Visible only to the blog owner (private)</strong> &ndash;
+nobody* else can see this post.</p>
+<p><em>On a course blog:</em> <strong>Visible to participants on this course</strong> &ndash; to view the post you must
+have been granted access to the blog, usually by being enrolled on the course that contains it.</p>
+
+<p><strong>Visible to everyone who is logged in to the system</strong> &ndash; everyone who is
+logged in can view the post, even if they\'re not enrolled on a specific course.</p>
+<p><strong>Visible to anyone in the world</strong> &ndash; any Internet user can see this post
+if you give them the blog\'s address.</p>
+
+<p>This option exists on the whole blog as well as on individual posts. If the
+option is set on the whole blog, that becomes a maximum. For example, if
+the whole blog is set to the first level, you cannot change the
+level of an individual post at all.</p>';
+$string['tags_help'] = 'Tags are labels that help you find and categorise posts.';
+// Used at OU only.
+$string['externaldashboardadd'] = 'Add blog to dashboard';
+$string['externaldashboardremove'] = 'Remove blog from dashboard';
+$string['viewblogdetails'] = 'View blog details';
+$string['viewblogposts'] = 'Return to blog';
+
+// User participation.
+$string['oublog:grade'] = 'Grade OU Blog user participation';
+$string['oublog:viewparticipation'] = 'View OU Blog user participation';
+$string['userparticipation'] = 'User participation';
+$string['usersparticipation'] = 'All users participation';
+$string['myparticipation'] = 'My participation summary';
+$string['savegrades'] = 'Save grades';
+$string['participation'] = 'Participation';
+$string['participationbyuser'] = 'Participation by user';
+$string['details'] = 'Details';
+$string['foruser'] = ' for {$a}';
+$string['postsby'] = 'Posts by {$a}';
+$string['commentsby'] = 'Comments by {$a}';
+$string['commentonby'] = 'Comment on post <u>{$a->title}</u> {$a->date} by <u>{$a->author}</u>';
+$string['nouserposts'] = 'No posts made.';
+$string['nousercomments'] = 'No comments made.';
+$string['gradesupdated'] = 'Grades updated';
+$string['usergrade'] = 'User grade';
+$string['nousergrade'] = 'User grade not available.';
+
+// Participation download strings.
+$string['downloadas'] = 'Download data as';
+$string['downloadcsv'] = 'Comma separated values text file';
+$string['postauthor'] = 'Post author';
+$string['postdate'] = 'Post date';
+$string['posttime'] = 'Post time';
+$string['posttitle'] = 'Post title';
+
+// Export.
+$string['exportedpost'] = 'Exported post';
+$string['exportpostscomments'] = ' all currently visible posts and their comments.';
+$string['exportuntitledpost'] = 'An untitled post ';
+
+$string['configmaxattachments'] = 'Default maximum number of attachments allowed per blog post.';
+$string['configmaxbytes'] = 'Default maximum size for all blog attachments on the site.
+(subject to course limits and other local settings)';
+$string['maxattachmentsize'] = 'Maximum attachment size';
+$string['maxattachments'] = 'Maximum number of attachments';
+$string['maxattachments_help'] = 'This setting specifies the maximum number of files that can be attached to a blog post.';
+$string['maxattachmentsize_help'] = 'This setting specifies the largest size of image/file that can be used in a blog post.';
+$string['attachments_help'] = 'You can optionally attach one or more files to a blog post. If you attach an image, it will be displayed after the message.';
+
+$string['remoteserver'] = 'Import from remote server';
+$string['configremoteserver'] = 'Root address (wwwroot) of remote server to be used for post imports.
+Blogs on this server will be shown in addition to those on local site when importing posts.';
+$string['remotetoken'] = 'Import remote server token';
+$string['configremotetoken'] = 'Web service user token for oublog webservices on import remote server.';
+
+$string['reportingemail'] = 'Reporting email addresses';
+$string['reportingemail_help'] = 'This setting specifies the email addresses of those who will be informed
+about issues with posts or comments within the OUBlog.
+They should be entered as a comma separated list.';
+$string['postalert'] = 'Report post';
+$string['commentalert'] = 'Report comment';
+$string['oublog_managealerts'] = 'Manage reported post/comment alerts';
+$string['untitledpost'] = 'Untitled post';
+$string['untitledcomment'] = 'Untitled comment';
+
+// Discovery block.
+$string['discovery'] = '{$a} usage';
+$string['timefilter_alltime'] = 'All time';
+$string['timefilter_thismonth'] = 'Past month';
+$string['timefilter_thisyear'] = 'Past year';
+$string['timefilter_label'] = 'Time period';
+$string['timefilter_submit'] = 'Update';
+$string['timefilter_open'] = 'Show options';
+$string['timefilter_close'] = 'Hide options';
+$string['visits'] = 'Most visited';
+$string['activeblogs'] = 'Active';
+$string['numberviews'] = '{$a} views';
+$string['visits_info_alltime'] = '{$a}s with the most number of visits';
+$string['visits_info_active'] = 'Active {$a}s (contain a post in the past month) with the most number of visits';
+$string['mostposts'] = 'Most posts';
+$string['numberposts'] = '{$a} posts';
+$string['posts_info_alltime'] = '{$a}s with the most number of posts';
+$string['posts_info_thisyear'] = '{$a}s with the most number of posts in the past year';
+$string['posts_info_thismonth'] = '{$a}s with the most number of posts in the past month';
+$string['mostcomments'] = 'Most comments';
+$string['numbercomments'] = '{$a} comments';
+$string['comments_info_alltime'] = '{$a}s with the most number of comments';
+$string['comments_info_thisyear'] = '{$a}s with the most number of comments added in the past year';
+$string['comments_info_thismonth'] = '{$a}s with the most number of comments added in the past month';
+$string['commentposts'] = 'Most commented posts';
+$string['commentposts_info_alltime'] = 'Posts with the most number of comments';
+$string['commentposts_info_thisyear'] = 'Posts with the most number of comments added in the past year';
+$string['commentposts_info_thismonth'] = 'Posts with the most number of comments added in the past month';
+
+// Delete and Email.
+$string['emailcontenthtml'] = 'This is a notification to advise you that your {$a->activityname} post with the
+following details has been deleted by \'{$a->firstname} {$a->lastname}\':<br />
+<br />
+Subject: {$a->subject}<br />
+{$a->activityname}: {$a->blog}<br />
+Course: {$a->course}<br />
+<br />
+<a href={$a->deleteurl} title="view deleted post">View the deleted post</a>';
+$string['deleteemailpostbutton'] = 'Delete and email';
+$string['deleteandemail'] = 'Delete and email';
+$string['emailmessage'] = 'Message';
+$string['cancel'] = 'Cancel';
+$string['deleteemailpostdescription'] = 'Select to delete the post or delete and send a customisable email notification.';
+$string['copytoself'] = 'Send a copy to yourself';
+$string['includepost'] = 'Include post';
+$string['deletedblogpost'] = 'Untitled post.';
+$string['emailerror'] = 'There was an error sending the email';
+$string['sendanddelete'] = 'Send and delete';
+$string['extra_emails'] = 'Email address of other recipients';
+$string['extra_emails_help'] = 'Enter one or more email address(es) separated by spaces or semicolons.';
+
+// Import pages.
+$string['allowimport'] = 'Enable post import';
+$string['allowimport_help'] = 'Allow any user to import pages from other blog activities they have access to.';
+$string['allowimport_invalid'] = 'Posts can only be imported when activity is set to individual mode.';
+$string['import'] = 'Import';
+$string['import_notallowed'] = 'Importing posts is disabled for this {$a}.';
+$string['import_step0_nonefound'] = 'You do not have access to any activities where posts can be imported from.';
+$string['import_step0_inst'] = 'From the list of blogs below, you may either import the entire blog or import selected posts.';
+$string['import_step0_numposts'] = '({$a} posts)';
+$string['import_step0_blog'] = 'Import blog';
+$string['import_step0_selected_posts'] = 'Import selected posts';
+$string['import_step1_inst'] = 'Select posts to import:';
+$string['import_step1_from'] = 'Import from:';
+$string['import_step1_table_title'] = 'Title';
+$string['import_step1_table_posted'] = 'Date posted';
+$string['import_step1_table_tags'] = 'Tags';
+$string['import_step1_table_include'] = 'Include in import';
+$string['import_step1_addtag'] = 'Filter by tag - {$a}';
+$string['import_step1_removetag'] = 'Remove tag filter - {$a}';
+$string['import_step1_include_label'] = 'Import post - {$a}';
+$string['import_step1_submit'] = 'Import';
+$string['import_step1_all'] = 'Select all';
+$string['import_step1_none'] = 'Select none';
+$string['import_step2_inst'] = 'Importing posts:';
+$string['import_step2_none'] = 'No posts selected for import.';
+$string['import_step2_prog'] = 'Importing in progress';
+$string['import_step2_total'] = '{$a} post(s) imported successfully';
+$string['import_step2_conflicts'] = '{$a} post(s) to import were identified as conflicts with existing posts.';
+$string['import_step2_conflicts_submit'] = 'Import conflicting posts';
+
+// My Participation.
+$string['contribution'] = 'Participation';
+$string['contribution_all'] = 'Participation - All time';
+$string['contribution_from'] = 'Participation - From {$a}';
+$string['contribution_to'] = 'Participation - To {$a}';
+$string['contribution_fromto'] = 'Participation - From {$a->start} To {$a->end}';
+$string['start'] = 'From';
+$string['end'] = 'To';
+$string['displayperiod'] = 'Participation selector From date - To date.';
+$string['info'] = 'Participation within the selected period.';
+$string['displayperiod_help'] = '<p>The default selects all entries.</p>
+<p>You can select \'From\' a date until todays entries.</p>
+<p>You can select all entries between a \'From\' date and a \'To\' date.</p>
+<p>Or you can select from the first entry \'To\' a date</p>';
+$string['nouserpostsfound'] = 'No posts made during this period.';
+$string['nousercommentsfound'] = 'No comments made during this period.';
+$string['numberpostsmore'] = 'Plus {$a} more posts';
+$string['numbercommentsmore'] = 'Plus {$a} more comments';
+$string['viewmyparticipation'] = 'View my participation';
+$string['viewallparticipation'] = 'View all participation';
+$string['timestartenderror'] = 'Selection end date cannot be earlier than the start date';
+
+$string['savefailtitle']='Post cannot be saved';
+$string['savefailnetwork'] = '<p>Unfortunately, your changes cannot be saved at this time.
+This is due to a network error; the website is temporarily unavailable or you have been signed out. </p>
+<p>Saving has been disabled on this blog.
+In order to retain any changes you must copy the edited blog content,
+access the Edit page again and then paste in your changes.</p>';
+
+$string['order'] = 'Order:';
+$string['alpha'] = 'A to Z';
+$string['use'] = 'Most used';
+$string['order_help'] = 'You can choose to order the display of the list of tags used,
+either in alphabetical order or by number of posts used in.
+Select the two links to switch between ordering methods,
+this choice is remembered and will be used on subsequent views.';
+$string['predefinedtags'] = 'Pre-defined tags';
+$string['predefinedtags_help'] = 'Give users tags to choose from when entering a tag on a post.
+Tags should be comma separated.';
+$string['official'] = 'Set';
+$string['invalidblogtags'] = 'Invalid blog tags';
+$string['nouserpostpartsfound'] = 'No posts made in this period.';
+$string['nousercommentpartsfound'] = 'No comments added in this period.';
+$string['participation_all'] = 'Participation - All time';
+$string['participation_from'] = 'Participation - From {$a}';
+$string['participation_to'] = 'Participation - To {$a}';
+$string['participation_fromto'] = 'Participation - From {$a->start} To {$a->end}';
+$string['recentposts'] = 'Recent posts';
+$string['commentonbyusers'] = 'Comment <u>{$a->commenttitle}</u> on post <u>{$a->posttitle}</u> <br> by <u>{$a->author}</u>';
+$string['commentdated'] = 'Dated';
+$string['postinfoblock'] = '<u>{$a->posttitle}</u> <br> <u>{$a->postdate}</u> <br> <u>{$a->sourcelink}</u>';
+$string['postdetail'] = 'Post detail';
+$string['group'] = 'Group ';
+$string['event:postcreated'] = 'Post created';
+$string['event:commentcreated'] = 'Comment created';
+$string['event:commentdeleted'] = 'Comment deleted';
+$string['event:postdeleted'] = 'Post deleted';
+$string['event:postupdated'] = 'Post updated';
+$string['event:postviewed'] = 'Post viewed';
+$string['event:commentapproved'] = 'Comment approved';
+$string['event:participationviewed'] = 'Participation viewed';
+$string['event:savefailed'] = 'Session fail on post save';
+$string['event:siteentriesviewed'] = 'Site entries viewed';
+$string['event:postimported'] = 'Post imported';
+$string['oublog:rate'] = 'Can rate posts.';
+$string['oublog:viewallratings'] = 'View all raw ratings given by individuals';
+$string['oublog:viewanyrating'] = 'View total ratings that anyone received';
+$string['oublog:viewrating'] = 'View the total rating you received';
+$string['grading'] = 'Grading';
+$string['grading_help'] = 'If you select this option, a grade for this blog will be added
+ to the course gradebook and calculated automatically.
+ Leave this off for a non-assessed blog, or one you plan to assess manually.';
+$string['grading_invalid'] = 'Posts can only be graded when either grade type or rating type are set.';
+$string['nograde'] = 'No grade (default)';
+$string['teachergrading'] = 'Teacher grades students';
+$string['userrating'] = 'Use ratings';
+$string['share'] = 'Share post';
+$string['tweet'] = 'Tweet';
+$string['oublogcrontask'] = 'OU blog maintenance jobs';
+
+$string['restricttags'] = 'Tag options';
+$string['restricttags_req'] = 'Must enter tags';
+$string['restricttags_req_set'] = 'Must enter pre-defined tags only';
+$string['restricttags_set'] = 'Allow pre-defined tags only';
+$string['restricttags_help'] = 'If you select this option, you can restrict
+tag entry to only those that are pre-defined at activity level and/or require that at least one tag be entered in a post.';
+$string['restricttagslist'] = 'You may only enter the \'Set\' tags: {$a}';
+$string['restricttagsvalidation'] = 'Only \'Set\' tags are allowed to be entered';
diff --git a/mod/oublog/lang/es/help/oublog/allowcomments.html b/mod/oublog/lang/es/help/oublog/allowcomments.html
new file mode 100644
index 0000000..bffa250
--- /dev/null
+++ b/mod/oublog/lang/es/help/oublog/allowcomments.html
@@ -0,0 +1,26 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
+<HTML>
+<HEAD>
+    <META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=windows-1252">
+    <TITLE></TITLE>
+    <META NAME="GENERATOR" CONTENT="OpenOffice.org 3.0  (Win32)">
+    <META NAME="CREATED" CONTENT="0;0">
+    <META NAME="CHANGEDBY" CONTENT="Enrique Robredo Mart&iacute;n">
+    <META NAME="CHANGED" CONTENT="20081005;11472100">
+</HEAD>
+<BODY LANG="es-ES" DIR="LTR">
+<H1>OU blog</H1>
+<H2>Comentarios</H2>
+<P>Cuando escribes una noticia (o la editas) puedes decidir qui&eacute;nes
+est&aacute;n autorizados para poder a&ntilde;adir comentarios a tu
+noticia.</P>
+<P>Si se elige la opci&oacute;n No, nadie podr&aacute; a&ntilde;adir
+comentarios. Esto lo debes hacer en casos especiales. such as if a
+controversial post might cause trouble to erupt in any comments
+section.</P>
+<P>Si se elige la opci&oacute;n S&iacute;, los usuarios pueden
+comentar las noticias si tienen acceso al blog y pueden acceder al
+sistema. Si el blog lo puede ver cualquier usuario aunque no est&eacute;
+registrado, &eacute;ste no podr&aacute; a&ntilde;adir comentarios.</P>
+</BODY>
+</HTML>
diff --git a/mod/oublog/lang/es/help/oublog/completion.html b/mod/oublog/lang/es/help/oublog/completion.html
new file mode 100644
index 0000000..b8c1528
--- /dev/null
+++ b/mod/oublog/lang/es/help/oublog/completion.html
@@ -0,0 +1,31 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
+<HTML>
+<HEAD>
+    <META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=windows-1252">
+    <TITLE></TITLE>
+    <META NAME="GENERATOR" CONTENT="OpenOffice.org 3.0  (Win32)">
+    <META NAME="CREATED" CONTENT="0;0">
+    <META NAME="CHANGEDBY" CONTENT="Enrique Robredo Mart&iacute;n">
+    <META NAME="CHANGED" CONTENT="20081005;11500400">
+</HEAD>
+<BODY LANG="es-ES" DIR="LTR">
+<H1>OU blog</H1>
+<H2>Opciones Completion</H2>
+<UL>
+    <LI><P STYLE="margin-bottom: 0cm">Si se elige &ldquo;Mensaje
+    requerido&rdquo;, entonces el blog se marcar&aacute; como que se ha
+    completado para un usuario que ha realizado el n&uacute;mero
+    especificado de env&iacute;os.
+    </P>
+    <LI><P>Si se elige &ldquo;Comenario requerido&rdquo;, el blog
+    quedar&aacute; marcado como completado para el usuario una vez que
+    haya cumplimentado sus comenarios. The comments can be on anyone's
+    post as long as it is within this blog.
+    </P>
+</UL>
+<P>Note that course and personal blogs are separate. Posts and
+comments to personal blogs don't count toward completion requirements
+for a course blog.
+</P>
+</BODY>
+</HTML>
diff --git a/mod/oublog/lang/es/help/oublog/feed.html b/mod/oublog/lang/es/help/oublog/feed.html
new file mode 100644
index 0000000..90b6e38
--- /dev/null
+++ b/mod/oublog/lang/es/help/oublog/feed.html
@@ -0,0 +1,32 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
+<HTML>
+<HEAD>
+    <META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=windows-1252">
+    <TITLE></TITLE>
+    <META NAME="GENERATOR" CONTENT="OpenOffice.org 3.0  (Win32)">
+    <META NAME="CREATED" CONTENT="0;0">
+    <META NAME="CHANGEDBY" CONTENT="Enrique Robredo Mart&iacute;n">
+    <META NAME="CHANGED" CONTENT="20081005;11551500">
+</HEAD>
+<BODY LANG="es-ES" DIR="LTR">
+<H1>OU blog</H1>
+<H2>Noticias</H2>
+<H3>Notificaciones autom&aacute;ticas</H3>
+<P>Si usted utiliza un programa lector de noticias o un sitio web, se
+puede a&ntilde;adir la direcci&oacute;n Atom o RSS para recibir las
+actualizaciones de los mensajes del blog.
+</P>
+<P>Una segunda opci&oacute;n de noticias pueden ser activadas por los
+propietarios del blog mediante las que se pueden leer los comentarios
+realizados.
+</P>
+<P>Your course doesn't require you to use this feature.
+</P>
+<H3>Atom y RSS</H3>
+<P>Atom and RSS son dos formatos que tienen la misma finalidad. La
+mayor&iacute;a de los lectores de noticias soportan cualquiera de los
+dos. Si uno de ellos no funciona correctamente, habr&aacute; que
+intentarlo con el otro.
+</P>
+</BODY>
+</HTML>
diff --git a/mod/oublog/lang/es/help/oublog/tags.html b/mod/oublog/lang/es/help/oublog/tags.html
new file mode 100644
index 0000000..3e66b82
--- /dev/null
+++ b/mod/oublog/lang/es/help/oublog/tags.html
@@ -0,0 +1,38 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
+<HTML>
+<HEAD>
+    <META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=windows-1252">
+    <TITLE></TITLE>
+    <META NAME="GENERATOR" CONTENT="OpenOffice.org 3.0  (Win32)">
+    <META NAME="CREATED" CONTENT="0;0">
+    <META NAME="CHANGEDBY" CONTENT="Enrique Robredo Mart&iacute;n">
+    <META NAME="CHANGED" CONTENT="20081005;12041600">
+    <META NAME="CHANGEDBY" CONTENT="Enrique Robredo Martn">
+</HEAD>
+<BODY LANG="es-ES" DIR="LTR">
+<H1>OU blog</H1>
+<H2>Etiquetas</H2>
+<H3>&iquest;Qu&eacute; son las etiquetas?</H3>
+<P>Las etiquetas son palabras &ldquo;clave&rdquo; que pueden
+utilizarse para crear categor&iacute;as en los mensajes del blog. Son
+frases sencillas, normalmente de una &uacute;nica palabra aunque se
+pueden utilizar m&uacute;ltiples palabras.</P>
+<P>Usted introduce las etiquetas mientras est&aacute; editando una
+noticia o puede dejar este campo en blanco puesto que no es
+obligatorio.</P>
+<P>Por ejemplo: Si se est&aacute; escribiendo una noticia sobre el
+calentamiento global, se pueden utilizar etiquetas como: ecolog&iacute;a,
+ecosistema, calentamiento global, efecto invernadero.</P>
+<H3>Etiquetas m&uacute;ltiples</H3>
+<P>Se pueden a&ntilde;adir varias etiquetas separadas por comas.</P>
+<P>Ejemplo: <STRONG> ecolog&iacute;a, ecosistema, calentamiento
+global, efecto invernadero</STRONG></P>
+<H3>Buscando por etiquetas</H3>
+<P>Cuando se utilizan las etiquetas en los mensajes, aparece un
+bloque que muestra las etiquetas como hiperv&iacute;nculos. Cada
+etiqueta viene acompa&ntilde;ada de un n&uacute;mero que indica el
+n&uacute;mero de mensajes en el blog que contienen dicha etiqueta. Si
+seleccionamos el hiperv&iacute;nculo correspondiente, se mostrar&aacute;n
+los mensajes contenidos en esa etiqueta.</P>
+</BODY>
+</HTML>
diff --git a/mod/oublog/lang/es/help/oublog/visibility.html b/mod/oublog/lang/es/help/oublog/visibility.html
new file mode 100644
index 0000000..84005ad
--- /dev/null
+++ b/mod/oublog/lang/es/help/oublog/visibility.html
@@ -0,0 +1,38 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
+<HTML>
+<HEAD>
+    <META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=windows-1252">
+    <TITLE></TITLE>
+    <META NAME="GENERATOR" CONTENT="OpenOffice.org 3.0  (Win32)">
+    <META NAME="CREATED" CONTENT="0;0">
+    <META NAME="CHANGEDBY" CONTENT="Enrique Robredo Mart&iacute;n">
+    <META NAME="CHANGED" CONTENT="20081005;12104700">
+</HEAD>
+<BODY LANG="es-ES" DIR="LTR">
+<H1>OU blog</H1>
+<H2>Visibilidad</H2>
+<P>Los mensaje del blog contienen la opci&oacute;n de mostrar qui&eacute;nes
+est&aacute;n autorizados a leerlos. Hay tres opciones en orden
+creciente de usuarios autorizados.</P>
+<OL>
+    <LI><P><EM>En un blog personal:</EM> <STRONG>Visible &uacute;nicamente
+    por el propietario (privado)</STRONG> &ndash; nadie* podr&aacute;
+    ver las noticias.</P>
+    <P><EM>En un blog de un curso:</EM> <STRONG>Los miembros de este
+    curso</STRONG> &ndash; Las noticias ser&aacute;n visibles para los
+    usuarios del curso en el que est&aacute; incluido el blog que
+    dispongan de alg&uacute;n rol.</P>
+    <LI><P STYLE="margin-bottom: 0cm"><STRONG>Cualquier usuario
+    registrado del sistema</STRONG> &ndash; Cualquiera que tenga una
+    cuenta de usuario podr&aacute; ver los post sin necesidad de
+    disponer de un rol en el curso espec&iacute;fico.
+    </P>
+    <LI><P><STRONG>Cualquier en el mundo</STRONG> &ndash; Cualquier
+    usuario de internet podr&aacute; ver las noticias si conoce la
+    direcci&oacute;n url del blog.
+    </P>
+</OL>
+<P>* Los administradores del sistema tienen acceso total a los
+mensajes incluidos los que est&eacute;n marcados como &ldquo;privados&rdquo;<EM>.</EM></P>
+</BODY>
+</HTML>
diff --git a/mod/oublog/lang/es/oublog.php b/mod/oublog/lang/es/oublog.php
new file mode 100644
index 0000000..dc6f703
--- /dev/null
+++ b/mod/oublog/lang/es/oublog.php
@@ -0,0 +1,115 @@
+<?php
+
+$string['oublog'] = 'OU blog';
+$string['modulename'] = 'OU blog';
+$string['modulenameplural'] = 'OU blogs';
+
+$string['oublog:view'] = 'Ver mensajes';
+$string['oublog:post'] = 'Crear nuevo mensaje';
+$string['oublog:comment'] = 'Comentar un mensaje';
+$string['oublog:managecomments'] = 'Gestionar comentarios';
+$string['oublog:manageposts'] = 'Gestionar mensajes';
+$string['oublog:managelinks'] = 'Gestionar vnculos';
+$string['oublog:audit'] = 'Ver mensajes eliminados y versiones anteriores';
+
+
+$string['newpost'] = 'Nuevo mensaje';
+$string['title'] = 'Ttulo';
+$string['message'] = 'Texto del mensaje';
+$string['tags'] = 'Etiquetas';
+$string['tagsfield'] = 'Etiquetas';
+$string['allowcomments'] = 'Permitir comentarios';
+$string['nocomments'] = 'No se permiten comentarios';
+$string['visibility'] = 'Este mensaje es visible para:';
+$string['maxvisibility'] = 'El blog es visible para';
+$string['yes'] = 'S';
+$string['no'] = 'No';
+$string['blogname'] = 'Nombre del Blog';
+$string['summary'] = 'Resumen';
+
+$string['visibleyou'] = 'Visible nicamente para el propietario (privado)';
+$string['visiblecourseusers'] = 'Los miembros de este curso';
+$string['visibleloggedinusers'] = 'Cualquier usuario registrado en el sistema';
+$string['visiblepublic'] = 'Cualquier usuario en el mundo';
+
+
+$string['addpost'] = 'Guardar mensaje de blog';
+$string['editpost'] = 'Actualizar mensaje de blog';
+$string['editsummary'] = 'Editado por {$a->editby}, {$a->editdate}';
+$string['editonsummary'] = 'Editado {$a->editdate}';
+
+$string['edit'] = 'Editar';
+$string['delete'] = 'Borrar';
+
+$string['olderposts'] = '&lt; Mensajes antiguos';
+$string['newerposts'] = 'Mensaje recientes &gt;';
+$string['extranavolderposts'] = 'Mensajes antiguos: {$a->from}-{$a->to}';
+$string['extranavtag'] = 'Etiqueta: {$a}';
+
+$string['comments'] = 'Comentarios';
+$string['ncomments'] = '{$a} comments';
+$string['1comment'] = '1 comentario';
+$string['comment'] = 'Comenta esta noticia';
+$string['lastcomment'] = '(ltimo comentario por {$a->fullname}, {$a->timeposted})';
+$string['addcomment'] = 'Publicar comentario';
+
+$string['confirmdeletepost'] = 'Seguro que quieres eliminar este mensaje?';
+$string['confirmdeletecomment'] = 'Seguro que quieres eliminar este comentario?';
+$string['confirmdeletelink'] = 'Seguro de querer eliminar este enlace?';
+
+$string['viewedit'] = 'Ver edicin';
+$string['views'] = 'Visitas a este blog:';
+
+$string['addlink'] = 'Nuevo enlace';
+$string['links'] = 'Enlaces relacionados';
+
+$string['subscribefeed'] = 'Suscribir a las noticias (requiere el software apropiado) para recibir notificaciones cuando este blog se actualice. ';
+$string['feeds'] = 'Noticias';
+$string['blogfeed'] = 'Noticias de blog';
+$string['commentsfeed'] = 'Solo comentarios';
+$string['atom'] = 'Atom';
+$string['rss'] = 'RSS';
+$string['atomfeed'] = 'Atom feed';
+$string['rssfeed'] = 'RSS feed';
+
+$string['newblogposts'] = 'Nuevos mensajes de blog';
+
+$string['blogsummary'] = 'Resumen de blog';
+$string['posts'] = 'Mensajes';
+
+$string['defaultpersonalblogname'] = '{$a}\'s blog';
+
+$string['numposts'] = '{$a} posts';
+
+$string['noblogposts'] = 'No hay mensajes de blog';
+
+$string['blogoptions'] = 'Opciones de blog';
+
+$string['postedby'] = 'por {$a}';
+
+$string['deletedby'] = 'Eliminado por {$a->fullname}, {$a->timedeleted}';
+
+$string['newcomment'] = 'Nuevo comentario';
+
+$string['searchthisblog'] = 'Buscar en el blog';
+
+$string['url']='Direccin web completa';
+
+$string['bloginfo']='Informacin del blog';
+
+$string['feedhelp']='Noticias';
+
+$string['unsupportedbrowser']='<p>Tu navegador no puede mostrar noticias Atom o RSS directamente.</p>
+<p>Feeds are most useful in separate computer programs or websites. If you want
+to use this feed in such a program, copy and paste the address from your browser\'s
+address bar.</p>';
+
+$string['completionpostsgroup']='Se requiere mensaje';
+$string['completionposts']='El usuario puede crear noticias:';
+$string['completionpostshelp']='Se requiere noticia para completar';
+$string['completioncommentsgroup']='Se requiere comentario';
+$string['completioncomments']='El usuario puede hacer comentarios a las noticias:';
+$string['completioncommentshelp']='Se requiere comentario para completar';
+
+$string['maybehiddenposts']='Este blog contiene mensajes que nicamente son visibles para los usuarios inscritos. Si usted tiene una cuenta de usuario, por favor <a href=\'{$a}\'>acceda para poder verlos</a>.';
+$string['noposts']='No hay mensajes visibles en este blog.';
\ No newline at end of file
diff --git a/mod/oublog/lang/ja/help/oublog/allowcomments.html b/mod/oublog/lang/ja/help/oublog/allowcomments.html
new file mode 100644
index 0000000..271f9b7
--- /dev/null
+++ b/mod/oublog/lang/ja/help/oublog/allowcomments.html
@@ -0,0 +1,9 @@
+<h1>OU blog</h1>
+
+<h2></h2>
+
+<p> ()</p>
+
+<p>NoNo</p>
+
+<p>Yes</p>
diff --git a/mod/oublog/lang/ja/help/oublog/completion.html b/mod/oublog/lang/ja/help/oublog/completion.html
new file mode 100644
index 0000000..eb29b64
--- /dev/null
+++ b/mod/oublog/lang/ja/help/oublog/completion.html
@@ -0,0 +1,17 @@
+<h1>OU blog</h1>
+
+<h2></h2>
+
+<ul>
+<li>
+
+</li>
+
+<li>
+
+</li>
+</ul>
+
+<p>
+
+</p>
diff --git a/mod/oublog/lang/ja/help/oublog/feed.html b/mod/oublog/lang/ja/help/oublog/feed.html
new file mode 100644
index 0000000..f972264
--- /dev/null
+++ b/mod/oublog/lang/ja/help/oublog/feed.html
@@ -0,0 +1,19 @@
+<h1>OU blog</h1>
+
+<h2></h2>
+
+<h3></h3>
+
+<p>
+AtomRSSURI
+</p>
+<p>
+AtomRSSAtomRSS
+</p>
+<p>
+
+</p>
+<h3>AtomRSS</h3>
+<p>
+AtomRSS2AtomAtomRSS.
+</p>
diff --git a/mod/oublog/lang/ja/help/oublog/tags.html b/mod/oublog/lang/ja/help/oublog/tags.html
new file mode 100644
index 0000000..da71ecb
--- /dev/null
+++ b/mod/oublog/lang/ja/help/oublog/tags.html
@@ -0,0 +1,23 @@
+<h1>OU blog</h1>
+
+<h2></h2>
+
+<h3>?</h3>
+
+<p></p>
+
+<p></p>
+
+<p>: </p>
+
+<h3></h3>
+
+<p></p>
+
+<p>: <strong>, </strong></p>
+
+<h3></h3>
+
+<p></p>
+
+<p>: </p>
diff --git a/mod/oublog/lang/ja/help/oublog/visibility.html b/mod/oublog/lang/ja/help/oublog/visibility.html
new file mode 100644
index 0000000..f60b46e
--- /dev/null
+++ b/mod/oublog/lang/ja/help/oublog/visibility.html
@@ -0,0 +1,18 @@
+<h1>OU blog</h1>
+
+<h2></h2>
+
+<p>3</p>
+
+<ol>
+<li>
+<p>: <strong>  () </strong> &ndash; *</p>
+<p>: <strong></strong> &ndash; </p>
+</li>
+<li><strong></strong> &ndash; </li>
+<li><strong></strong> &ndash; </li>
+</ol>
+
+<p></p>
+
+<p>* </p>
diff --git a/mod/oublog/lang/ja/oublog.php b/mod/oublog/lang/ja/oublog.php
new file mode 100644
index 0000000..8ffb446
--- /dev/null
+++ b/mod/oublog/lang/ja/oublog.php
@@ -0,0 +1,94 @@
+<?php
+$string['1comment'] = '1 ';
+$string['accessdenied'] = '';
+$string['addcomment'] = '';
+$string['addlink'] = '';
+$string['addpost'] = '';
+$string['allowcomments'] = '';
+$string['atom'] = 'Atom';
+$string['atomfeed'] = 'Atom';
+$string['blogfeed'] = '';
+$string['bloginfo'] = '';
+$string['blogname'] = '';
+$string['blogoptions'] = '';
+$string['blogsummary'] = '';
+$string['comment'] = '';
+$string['comments'] = '';
+$string['commentsfeed'] = '';
+$string['completioncomments'] = ':';
+$string['completioncommentsgroup'] = '';
+$string['completioncommentshelp'] = '';
+$string['completionposts'] = ':';
+$string['completionpostsgroup'] = '';
+$string['completionpostshelp'] = '';
+$string['confirmdeletecomment'] = '?';
+$string['confirmdeletelink'] = '?';
+$string['confirmdeletepost'] = '?';
+$string['defaultpersonalblogname'] = '{$a} ';
+$string['delete'] = '';
+$string['deletedby'] = ': {$a->fullname} - : {$a->timedeleted}';
+$string['edit'] = '';
+$string['editonsummary'] = ': {$a->editdate}';
+$string['editpost'] = '';
+$string['editsummary'] = ': {$a->editby} - : {$a->editdate}';
+$string['extranavolderposts'] = ': {$a->from}-{$a->to}';
+$string['extranavtag'] = ': {$a}';
+$string['feedhelp'] = '';
+$string['feeds'] = '';
+$string['guestblog'] = '<a href=\"{$a}\"></a>';
+$string['lastcomment'] = '( by {$a->fullname} - {$a->timeposted})';
+$string['links'] = '';
+$string['maxvisibility'] = '';
+$string['maybehiddenposts'] = '<a href=\"{$a}\"></a>';
+$string['message'] = '';
+$string['modulename'] = 'OU blog';
+$string['modulenameplural'] = 'OU blog';
+$string['ncomments'] = '{$a} ';
+$string['newblogposts'] = '';
+$string['newcomment'] = '';
+$string['newerposts'] = ' &gt;';
+$string['newpost'] = '';
+$string['no'] = 'No';
+$string['noblogposts'] = '';
+$string['nocomments'] = '';
+$string['noposts'] = '';
+$string['numposts'] = '{$a} ';
+$string['olderposts'] = '&lt; ';
+$string['oublog'] = 'OU blog';
+$string['oublog:audit'] = '';
+$string['oublog:comment'] = '';
+$string['oublog:contributepersonal'] = '';
+$string['oublog:managecomments'] = '';
+$string['oublog:managelinks'] = '';
+$string['oublog:manageposts'] = '';
+$string['oublog:post'] = '';
+$string['oublog:view'] = '';
+$string['oublog:viewpersonal'] = '';
+$string['overviewnumentrylog'] = '';
+$string['overviewnumentrylog1'] = '';
+$string['overviewnumentryvw'] = '';
+$string['overviewnumentryvw1'] = '';
+$string['postedby'] = 'by {$a}';
+$string['posts'] = '';
+$string['rss'] = 'RSS';
+$string['rssfeed'] = 'RSS';
+$string['searchblogs'] = '';
+$string['searchthisblog'] = '';
+$string['siteentries'] = '';
+$string['subscribefeed'] = ' ()';
+$string['summary'] = '';
+$string['tags'] = '';
+$string['tagsfield'] = ' ()';
+$string['title'] = '';
+$string['unsupportedbrowser'] = '<p>AtomRSS</p>
+<p>URI</p>';
+$string['url'] = '';
+$string['viewedit'] = '';
+$string['views'] = ':';
+$string['visibility'] = '?';
+$string['visibleblogusers'] = '';
+$string['visiblecourseusers'] = '';
+$string['visibleloggedinusers'] = '';
+$string['visiblepublic'] = '';
+$string['visibleyou'] = ' ()';
+$string['yes'] = 'Yes';
\ No newline at end of file
diff --git a/mod/oublog/lang/pt_br/oublog.php b/mod/oublog/lang/pt_br/oublog.php
new file mode 100644
index 0000000..b7de45c
--- /dev/null
+++ b/mod/oublog/lang/pt_br/oublog.php
@@ -0,0 +1,186 @@
+<?php
+defined('MOODLE_INTERNAL') || die();
+
+$string['accessdenied'] = 'Desculpe: Voc no tem permisso para olhar esta pgina.';
+$string['addcomment'] = 'Adicionar comentrio';
+$string['addlink'] = 'Adicionar link';
+$string['addpost'] = 'Adicionar mensagem';
+$string['allowcomments'] = 'Permitir comentrio';
+$string['allowcomments_help'] = '<p>Se voc escolher \'No, comentrios no permitidos\', ningum poder comentar. Voc preferir fazer isto em casos especiais, tais como quando ocorrer uma postagem controversa que possa gerar muitos comentrios.</p> <p>Quando voc escolhe \'Sim, de usurios logados\' isto significa que pessoas podem comentar se elas tiverem permisso de visualizar o blog, e quiserem logar no sistema.</p> <p>Se optar por tornar a postagem pblica ao mundo, voc pode escolher \'Sim, de qualquer um\'. Esta opo permite comentrios de qualquer usurio logado no ambiente e de pessoas em geral. Quando o usurio adiciona um comentario sem estar logado, o comentrio no aparecer imediatamente; um email ser enviado para a pessoa que fez a postagem para aprovar ou rejeitar o comentrio. No escolha esta opo para suas postagens a menos que voc tenha certeza de gerenciar estas mensagens.</p>';
+$string['allowcommentsmax'] = 'Permitir comentrios';
+$string['atom'] = 'Atom';
+$string['atomfeed'] = 'Feed Atom';
+$string['attachments'] = 'Anexos';
+$string['blogfeed'] = 'Blog feeds';
+$string['bloginfo'] = 'Informaes do blog';
+$string['blogname'] = 'Nome do blog';
+$string['blogoptions'] = 'Opes do blog';
+$string['blogsummary'] = 'Sumario do blog';
+$string['comment'] = 'Adicione seu comentrio';
+$string['comments'] = 'Comentrios';
+$string['commentsfeed'] = 'Comentrios somente';
+$string['commentsnotallowed'] = 'Comentrios no so permitidos';
+$string['completioncomments'] = 'Usurio deve fazer comentrios as mensagens postadas';
+$string['completioncommentsgroup'] = 'Requer comentrio';
+$string['completioncommentshelp'] = 'Requerendo comentrios para completar';
+$string['completionposts'] = 'Usurio deve postar mensagem';
+$string['completionpostsgroup'] = 'Requer postagem';
+$string['completionpostshelp'] = 'Requerendo postagem para completar';
+$string['computingguide'] = 'Guia para OU blogs';
+$string['computingguideurl'] = 'URL do Guia';
+$string['computingguideurlexplained'] = 'Entre com a URL para o guia do OU blog';
+$string['confirmdeletecomment'] = 'Voc tem certeza que deseja apagar este comentrio?';
+$string['confirmdeletelink'] = 'Voc tem certeza que deseja apagar este link?';
+$string['confirmdeletepost'] = 'Voc tem certeza que deseja apagar esta mensagem?';
+$string['couldnotaddcomment'] = 'No pode adicionar comentario';
+$string['couldnotaddlink'] = 'No pode adicionar link';
+$string['defaultpersonalblogname'] = 'blog de {$a}';
+$string['delete'] = 'Apagar';
+$string['deletedby'] = 'Apagado por {$a->fullname}, {$a->timedeleted}';
+$string['deleteglobalblog'] = 'Voc no pode apagar o blog global';
+$string['displayversion'] = 'OU blog verso: <strong>{$a}</strong>';
+$string['edit'] = 'Editar';
+$string['editlink'] = 'Editar link';
+$string['editonsummary'] = 'Editado em {$a->editdate}';
+$string['editpost'] = 'Atualizar mensagem';
+$string['editsummary'] = 'Editado por {$a->editby}, {$a->editdate}';
+$string['error_alreadyapproved'] = 'Comentrio j aprovado ou rejeitado';
+$string['error_grouppubliccomments'] = 'Voc no pode permitir comentrios pblicos quando o blog  de grupo';
+$string['error_moderatednotallowed'] = 'Comentrios moderados no so mais permitidos neste blog ou em mensagens';
+$string['error_noconfirm'] = 'Enter the bold text above, exactly as given, into this box.';
+$string['error_toomanycomments'] = 'Voc realizou muitos comentrios na ltima hora do mesmo endereo da Internet. Por favor aguarde e tente novamente.';
+$string['error_unspecified'] = 'O sistema no pode completar sua requisio pois ocorreu um error ({$a})';
+$string['error_wrongkey'] = 'Chave de comentrio incorreta';
+$string['externaldashboardadd'] = 'Adicionar blog ao dashboard';
+$string['externaldashboardremove'] = 'Remover blog do dashboard';
+$string['extranavolderposts'] = 'ltima postagem: {$a->from}-{$a->to}';
+$string['extranavtag'] = 'Marca: {$a}';
+$string['feedhelp'] = 'feeds';
+$string['feedhelp_help'] = '<p> Se voc usa um programa leitor de noticias ou pgina web, voc pode adicionar o endereo web do Atom ou link RSS para ficar atualizado sobre as novas postagens. </p> <p> Se o blog mermitir comentrios, voc poder ver os novos comentrios realizados.</p> <p> Seu curso no requer que voc use esse recurso.</p> <h3>Atom e RSS</h3> <p> Atom e RSS so dois formatos com a mesma finalidade. O primeiro  um modelo tecnologicamente mais puro, o ltimo  mais conhecido. A maioria dos leitores de notcias suportam ambos os formatos. Tente o link Atom, se isto no funcionar, tente o RSS.</p>';
+$string['feeds'] = 'Feeds';
+$string['feedsnotenabled'] = 'Feeds no esto habilitadas';
+$string['globalblogmissing'] = 'Blog Global faltando';
+$string['guestblog'] = 'Se voc tem uma conta no sistema, por favor <a href=\'{$a}\'>logue para ter total acesso</a>.';
+$string['individualblogs'] = 'blogs Individuais';
+$string['individualblogs_help'] = '<p><strong>No(blog em grupo)</strong>: <em>Blogs individuais no so usados</em> &ndash; Todos so parte de uma grande comunidade (dependendo das configuraes de grupos).</p> <p><strong>Blogs individuais separados</strong>: <em>Blogs individuais so usadas em carter privado</em> &ndash; Usurios individuais somente podem postar e ver seus prprios blogs, a menos que eles tenham permisso para ver outros blogs individuais.</p> <p><strong>Blogs individuais visveis</strong>: <em>Blogs individuais so vistos publicamente</em> &ndash; Usurios individuais podem somente postar nos seus prprios blogs, mas podem ver postagens em outros blogs individuais.</p>';
+$string['invalidblog'] = 'Identificador de blog invlido';
+$string['invalidblogdetails'] = 'No posso encontrar detalhes da mensagem do blog {$a}';
+$string['invalidcomment'] = 'Identificador de comentrio invlido';
+$string['invalidedit'] = 'Identificador de Edio invlido';
+$string['invalidformat'] = 'Formato deve ser atom ou rss';
+$string['invalidlink'] = 'identificador de Link invlido';
+$string['invalidpost'] = 'Identificador de mensagem invlido';
+$string['invalidpostid'] = 'Identificador de mensagem invlido';
+$string['invalidvisbilitylevel'] = 'Nvel de visibilidade invlido {$a}';
+$string['invalidvisibility'] = 'Nvel de visibilidade invlido';
+$string['lastcomment'] = '(ltimo por {$a->fullname}, {$a->timeposted})';
+$string['links'] = 'Links relacionados';
+$string['logincomments'] = 'Sim, de usurios logados';
+$string['maxvisibility'] = 'Mxima visibilidade';
+$string['maxvisibility_help'] = '<p><em>No blog pessoal:</em> <strong>Visvel somente para o proprietrio do blog (privado)</strong> &ndash; ninguem mais pode ver suas postagens.</p> <p><em>No blog do curso:</em> <strong>Visivel para participantes do curso</strong> &ndash; para visualizar as mensagens voc deve ser um participante do curso onde o blog foi disponibilizado.</p> <p><strong>Visvel para qualquer um que esteja logado no ambiente</strong> &ndash; Qualquer usurio pode ver suas postagens, mesmo que este no faa parte de um curso em especfico.</p> <p><strong>Visivel para todos</strong> &ndash; qualquer usurio da Internet pode ver suas postagens se voc der a ele o endereo do seu blog.</p> <p>Esta opo existe para o blog como um todo, assim como para mensagens individuais. Se a opo  configurada para todo o blog, ela se torna mxima. Por exemplo, Se o blog for configurado para visivel para todos, voc no poder mudar essa deciso para as mensagens individualmente.</p>';
+$string['maybehiddenposts'] = 'Este blog contem mensagens que so visveis somente para usurios logados. Se voc tem um conta, por favor, <a href=\'{$a}\'>logue nela</a>.';
+$string['message'] = 'Mensagem';
+$string['moderated_addedcomment'] = 'Obrigado por adicionar seu comentrio, que foi recebido com sucesso. Seu comentrio no aparecer at que seja aprovado pelo autor da mensagem.';
+$string['moderated_approve'] = 'Aprovar este comentrio';
+$string['moderated_authorname'] = 'Seu nome';
+$string['moderated_awaiting'] = 'Comentrio aguardando aprovao';
+$string['moderated_awaitingnote'] = 'Estes comentrios no so visveis para outros usurios a menos que voc os aprove. Tenha em mente que o sistema no conhece a identidade de quem comentou e comentrios podem conter links que, se seguidos, podem <strong>danificar seu computador</strong> seriamente. Se voc tiver dvidas, por favor rejeite o comentrio <strong>sem seguir qualquer link</strong>.';
+$string['moderated_confirm'] = 'Confirmao';
+$string['moderated_confirminfo'] = 'Por favor entre <strong>Sim</strong> abaixo para confirmar que voc  uma pessoa.';
+$string['moderated_confirmvalue'] = 'Sim';
+$string['moderated_emailhtml'] = '<p>(Esta  uma mensagem de email automtica. Por favor no responda.)</p> <p>Alguem adicionaou um comentrio a sua mensagem no blog: {$a->postlink}</p> <p>Voc precisa <strong>aprovar o comentrio</strong> antes que ela possa ser visualizado por outros.</p> <p>O sistema no conhece a identidade do autor do comentrio e o comentrio poder conter links que se seguidos, podero <strong>danificar seriamente seu computador</strong>. Se voc tem dvidas, por favor rejeite o comentrio <strong>sem seguir nenhum dos seus links</strong>.</p> <p>Se voc aprovar o comentrio, voc assume a responsabiliade por ele. Tenha certeza que ele no contem nenhum contedo que fira qualquer norma.</p> <hr/> <p>Nome dado: {$a->commenter}</p> <hr/> <h3>{$a->commenttitle}</h3> {$a->comment} <hr/> <ul class=\'oublog-approvereject\'> <li><a href=\'{$a->approvelink}\'>{$a->approvetext}</a></li> <li><a href=\'{$a->rejectlink}\'>{$a->rejecttext}</a></li> </ul> <p> Voc pode tambm ignorar este email. O comentrio ser rejeitado automaticamente depois de 30 dias.</p><p>Se voc recebe muitos emails deste tipo, voc desejar restringir os comentrios somente para usurio logados. </p> <ul class=\'oublog-restrict\'> <li><a href=\'{$a->restrictpostlink}\'>{$a->restrictposttext}</a></li> <li><a href=\'{$a->restrictbloglink}\'>{$a->restrictblogtext}</a></li> </ul>';
+$string['moderated_emailsubject'] = 'Comentrio aguardando aprovao em: {$a->blog} ({$a->commenter})';
+$string['moderated_emailtext'] = 'Esta  uma mensagem de email automtica. Por favor no responda. Alguem adicionaou um comentrio a sua mensagem no blog: {$a->postlink} Voc precisa aprovar o comentrio antes que ela possa ser visualizado por outros. O sistema no conhece a identidade do autor do comentrio e o comentrio poder conter links que se seguidos, podero danificar seriamente seu computador. Se voc tem dvidas, por favor rejeite o comentrio sem seguir nenhum dos seus links. Se voc aprovar o comentrio, voc assume a responsabiliade por ele. Tenha certeza que ele no contem nenhum contedo que fira qualquer norma. ----------------------------------------------------------------------- Nome dado: {$a->commenter} ----------------------------------------------------------------------- {$a->commenttitle} {$a->comment} ----------------------------------------------------------------------- * {$a->approvetext}: {$a->approvelink} * {$a->rejecttext}: {$a->rejectlink} Voc pode tambm ignorar este email. O comentrio ser rejeitado automaticamente depois de 30 dias. Se voc recebe muitos emails deste tipo, voc desejar restringir os comentrios somente para usurio logados. * {$a->restrictposttext}: {$a->restrictpostlink} * {$a->restrictblogtext}: {$a->restrictbloglink}';
+$string['moderated_info'] = 'Porque voc no est logado, seus comentrios somente sero mostrados depois de serem aprovados. Se voc tem uma conta no sistema, por favor <a href=\'{$a}\'>logue para um completo acesso ao blog</a>.';
+$string['moderated_postername'] = 'Usando o nome <strong>{$a}</strong>';
+$string['moderated_reject'] = 'Rejeitar este comentrio';
+$string['moderated_rejectedon'] = 'Rejeitado {$a}:';
+$string['moderated_restrictblog'] = 'Restringir comentrios a todas suas mensagens neste blog';
+$string['moderated_restrictblog_info'] = 'Voc gostaria de restringir comentrios a todas as suas mensagens neste blog e permitir somente para pessoas que esto logados no sistema?';
+$string['moderated_restrictpage'] = 'Restringir comentrios';
+$string['moderated_restrictpost'] = 'Restringir comentrios a esta mensagem';
+$string['moderated_restrictpost_info'] = 'Voc gostaria de restringir comentrios a esta mensagem permitindo somente que pessoas logadas no sistema possam faz-lo?';
+$string['moderated_submitted'] = 'Aguardando moderao';
+$string['moderated_typicaltime'] = 'No passado, isto levava por volta de {$a}.';
+$string['modulename'] = 'OU blog';
+$string['modulenameplural'] = 'OU blogs';
+$string['mustprovidepost'] = 'Deve providenciar postagem';
+$string['ncomments'] = '{$a} comentrios';
+$string['newblogposts'] = 'Novas mensagens';
+$string['newcomment'] = 'Novo comentrio';
+$string['newerposts'] = 'Mensagens Mais novas &gt;';
+$string['newpost'] = 'Nova mensagem';
+$string['no'] = 'No';
+$string['noblogposts'] = 'Nenhuma mensagem';
+$string['no_blogtogetheroringroups'] = 'No (em grupo)';
+$string['nocomments'] = 'No, Comentrios no permitidos';
+$string['noposts'] = 'No h mensagens visveis neste blog.';
+$string['notaddpost'] = 'No foi possvel adicionar mensagem';
+$string['notaddpostnogroup'] = 'No posso adicionar mensagem sem grupo';
+$string['npending'] = '{$a} comentrios aguardando aprovao';
+$string['npendingafter'] = ', {$a} aguardando aprovao';
+$string['numposts'] = '{$a} mensagens';
+$string['olderposts'] = '&lt; mensagens mais velhas';
+$string['onecomment'] = '{$a} comentrio';
+$string['onepending'] = '{$a} comentrio aguardando aprovao';
+$string['onependingafter'] = ', {$a} aguardando aprovao';
+$string['onlyworkspersonal'] = 'Somente funciona para blogs pessoais';
+$string['oublog'] = 'OU blog';
+$string['oublog:audit'] = 'Visualizar mensagens apagadas e verses velhas';
+$string['oublog:comment'] = 'Comentar uma mensagem';
+$string['oublog:contributepersonal'] = 'Poste e comente nos blogs pessoais';
+$string['oublog:exportownpost'] = 'Exportar proprias mensagens';
+$string['oublog:exportpost'] = 'Exportar mensagens';
+$string['oublog:managecomments'] = 'Administrar comentrios';
+$string['oublog:managelinks'] = 'Administrar links';
+$string['oublog:manageposts'] = 'Administrar mensagens';
+$string['oublog:post'] = 'Crie uma nova mensagem';
+$string['oublog:view'] = 'Visualizar mensagem';
+$string['oublog:viewindividual'] = 'Blogs individuais visveis';
+$string['oublog:viewpersonal'] = 'Visualizar mensagens de blogs pessoais';
+$string['overviewnumentrylog'] = 'Registros desde o ltimo login';
+$string['overviewnumentrylog1'] = 'Registro desde o ltimo login';
+$string['overviewnumentryvw'] = 'Registros desde ltima visualizao';
+$string['overviewnumentryvw1'] = 'Registro desde ltima visualizao';
+$string['personalblognotsetup'] = 'Blogs pessoais no configurados';
+$string['pluginadministration'] = 'Administrao do OU Blog';
+$string['pluginname'] = 'OU Blog';
+$string['postedby'] = 'por {$a}';
+$string['postedbymoderated'] = 'por {$a->commenter} (aprovado por by {$a->approver}, {$a->approvedate})';
+$string['postedbymoderatedaudit'] = 'por {$a->commenter} [{$a->ip}] (aprovado por {$a->approver}, {$a->approvedate})';
+$string['posts'] = 'Mensagens';
+$string['publiccomments'] = 'Sim, de qualquer um (mesmo se no logado)';
+$string['publiccomments_info'] = 'Se alguem adicionar um comentrio quando no esta logado, voc receber um e-mail de notificao e poder aprovar o comentario para exibio, ou rejeit-lo. Isso  preciso para se prevenir de spam.';
+$string['re'] = 'Re: {$a}';
+$string['rss'] = 'RSS';
+$string['rssfeed'] = 'RSS feed';
+$string['searchblogs'] = 'Pesquisar nos Blogs';
+$string['searchthisblog'] = 'Pesquisar este blog';
+$string['separateindividual'] = 'Individual&nbsp;separado';
+$string['separateindividualblogs'] = 'Blogs individuais separados';
+$string['siteentries'] = 'Visualizar entradas de sites';
+$string['subscribefeed'] = 'Assinar uma feed (requer software apropriado) para receber notificaes quando for atualizado.';
+$string['summary'] = 'Sumrio';
+$string['tags'] = 'Marcas';
+$string['tagsfield'] = 'Marcas (separadas por vrgula)';
+$string['tags_help'] = '<p>Marcas so pequenos trechos de texto que podem ser usados para categorizar as mensagens do seu blog. Elas so geralmente mostradas em caixa baixa. A maioria das marcas so um nica palavra, mas voc pode tambm usar multiplas palavras se preferir.</p>';
+$string['tagupdatefailed'] = 'Falha ao atualizar Marcas';
+$string['title'] = 'Ttulo';
+$string['unsupportedbrowser'] = '<p>Seu navegador no pode mostrar feeds Atom ou RSS diretamente.</p> <p>Feeds so mais teis usando um programa especfico ou site. Se voc que usar este feed em tal programa, copie e cole o endereo da barra de endereos do seu navegador.</p>';
+$string['url'] = 'Endereo Web completo (URL)';
+$string['viewallusers'] = 'Visualizar todos os usurios';
+$string['viewallusersingroup'] = 'Visualizar todos os usurios do grupo';
+$string['viewblogdetails'] = 'Ver detalhes do blog';
+$string['viewblogposts'] = 'Retornar ao blog';
+$string['viewedit'] = 'Visualizar edio';
+$string['views'] = 'Total de visitas a este blog:';
+$string['visibility'] = 'Quem pode ler isto?';
+$string['visibility_help'] = '<p><strong>Visvel para participantes deste curso</strong> &ndash; para visualizar a mensagem voc deve ter permisso de acesso ao blog, geralmente membros do curso a tem.</p> <p><strong>Visivel para qualquer um que esteja logado no sistema</strong> &ndash; qualquer um que esteja logado pode ver as mensagens, mesmo se ele no for membro do curso.</p> <p><strong>Visvel para qualquer um no mundo</strong> &ndash; qualquer usurio da internet pode ver sua mensagem se voc der o endereo do seu blog.</p>';  
+$string['visibleblogusers'] = 'Visvel somente para membros do blog';
+$string['visiblecourseusers'] = 'Visvel para participantes deste curso';
+$string['visibleindividual'] = 'Visualizar&nbsp;individual';
+$string['visibleindividualblogs'] = 'Blogs individuais visveis';
+$string['visibleloggedinusers'] = 'Visivel para todos os que estiverem logados no sistema';
+$string['visiblepublic'] = 'Visvel para todos';
+$string['visibleyou'] = 'Visvel somente para o proprietrio';
+$string['yes'] = 'Sim';
diff --git a/mod/oublog/lib.php b/mod/oublog/lib.php
new file mode 100644
index 0000000..6bbb076
--- /dev/null
+++ b/mod/oublog/lib.php
@@ -0,0 +1,1514 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+/**
+ * Library of functions for the oublog module.
+ *
+ * This contains functions that are called also from outside the oublog module
+ * Functions that are only called by the quiz module itself are in {@link locallib.php}
+ *
+ * @author Matt Clarkson <mattc@catalyst.net.nz>
+ * @author Sam Marshall <s.marshall@open.ac.uk>
+ * @license http://www.gnu.org/copyleft/gpl.html GNU Public License
+ * @package oublog
+ */
+
+
+
+
+/**
+ * Given an object containing all the necessary data,
+ * (defined by the form in mod_form.php) this function
+ * will create a new instance and return the id number
+ * of the new instance.
+ *
+ * @param object $oublog the data from the mod form
+ * @return int The id od the newly inserted module
+ */
+function oublog_add_instance($oublog) {
+    global $DB;
+    // Generate an accesstoken.
+    $oublog->accesstoken = md5(uniqid(rand(), true));
+
+    if (empty($oublog->ratingtime) || empty($oublog->assessed)) {
+        $oublog->assesstimestart = 0;
+        $oublog->assesstimefinish = 0;
+    }
+
+    if (!$oublog->id = $DB->insert_record('oublog', $oublog)) {
+        return(false);
+    }
+    if (!empty($oublog->tagslist)) {
+        $blogtags = oublog_clarify_tags($oublog->tagslist);
+        // For each tag added to the blog check if it exists in oublog_tags table,
+        // if it does not a tag record is created.
+        foreach ($blogtags as $tag) {
+            if (!$DB->get_record('oublog_tags', array('tag' => $tag))) {
+                $DB->insert_record('oublog_tags', (object) array('tag' => $tag));
+            }
+        }
+    }
+    oublog_grade_item_update($oublog);
+
+    return($oublog->id);
+}
+
+
+
+/**
+ * Given an object containing all the necessary data,(defined by the
+ * form in mod_form.php) this function will update an existing instance
+ * with new data.
+ *
+ * @param object $oublog the data from the mod form
+ * @return boolean true on success, false on failure.
+ */
+function oublog_update_instance($oublog) {
+    global $DB;
+    $oublog->id = $oublog->instance;
+
+    if (!$DB->get_record('oublog', array('id' => $oublog->id))) {
+        return(false);
+    }
+
+    if (empty($oublog->ratingtime) || empty($oublog->assessed)) {
+        $oublog->assesstimestart = 0;
+        $oublog->assesstimefinish = 0;
+    }
+
+    if (!$DB->update_record('oublog', $oublog)) {
+        return(false);
+    }
+
+    $blogtags = oublog_clarify_tags($oublog->tagslist);
+    // For each tag in the blog check if it already exists in oublog_tags table,
+    // if it does not a tag record is created.
+    foreach ($blogtags as $tag) {
+        if (!$DB->get_record('oublog_tags', array('tag' => $tag))) {
+            $DB->insert_record('oublog_tags', (object) array('tag' => $tag));
+        }
+    }
+
+    oublog_grade_item_update($oublog);
+
+    return(true);
+}
+
+
+
+/**
+ * Given an ID of an instance of this module, this function will
+ * permanently delete the instance and any data that depends on it.
+ *
+ * @param int $id The ID of the module instance
+ * @return boolena true on success, false on failure.
+ */
+function oublog_delete_instance($oublogid) {
+    global $DB, $CFG;
+    if (!$oublog = $DB->get_record('oublog', array('id'=>$oublogid))) {
+        return(false);
+    }
+
+    if ($oublog->global) {
+        print_error('deleteglobalblog', 'oublog');
+    }
+
+    if ($instances = $DB->get_records('oublog_instances', array('oublogid'=>$oublog->id))) {
+
+        foreach ($instances as $oubloginstancesid => $bloginstance) {
+            // tags
+            $DB->delete_records('oublog_taginstances', array('oubloginstancesid'=>$oubloginstancesid));
+
+            if ($posts = $DB->get_records('oublog_posts', array('oubloginstancesid'=>$oubloginstancesid))) {
+
+                foreach ($posts as $postid => $post) {
+                    // comments
+                    $DB->delete_records('oublog_comments', array('postid'=>$postid));
+
+                    // edits
+                    $DB->delete_records('oublog_edits', array('postid'=>$postid));
+                }
+
+                // posts
+                $DB->delete_records('oublog_posts', array('oubloginstancesid'=>$oubloginstancesid));
+
+            }
+        }
+    }
+
+    // links
+    $DB->delete_records('oublog_links', array('oublogid'=>$oublog->id));
+
+    // instances
+    $DB->delete_records('oublog_instances', array('oublogid'=>$oublog->id));
+
+    // Fulltext search data
+    require_once(dirname(__FILE__).'/locallib.php');
+    if (oublog_search_installed()) {
+        $moduleid=$DB->get_field('modules', 'id', array('name'=>'oublog'));
+        $cm=$DB->get_record('course_modules', array('module'=>$moduleid, 'instance'=>$oublog->id));
+        if (!$cm) {
+            print_error('invalidcoursemodule');
+        }
+        local_ousearch_document::delete_module_instance_data($cm);
+    }
+
+    oublog_grade_item_delete($oublog);
+
+    // oublog
+    return($DB->delete_records('oublog', array('id'=>$oublog->id)));
+
+}
+
+
+
+/**
+ * Return a small object with summary information about what a
+ * user has done with a given particular instance of this module
+ * Used for user activity reports.
+ *
+ * @param object $course
+ * @param object $user
+ * @param object $mod
+ * @param object $oublog
+ * @return object containing a time and info properties
+ */
+function oublog_user_outline($course, $user, $mod, $oublog) {
+    global $CFG, $DB;
+
+    $sql = "SELECT count(*) AS postcnt, MAX(timeposted) as lastpost
+            FROM {oublog_posts} p
+                INNER JOIN {oublog_instances} i ON p.oubloginstancesid = i.id
+            WHERE p.deletedby IS NULL AND i.userid = ? AND oublogid = ?";
+
+    if ($postinfo = $DB->get_record_sql($sql, array($user->id, $mod->instance))) {
+        $result = new stdClass();
+        $result->info = get_string('numposts', 'oublog', $postinfo->postcnt);
+        $result->time = $postinfo->lastpost;
+
+        return($result);
+    }
+
+    return(null);
+}
+
+
+
+/**
+ * Print a detailed representation of what a user has done with
+ * a given particular instance of this module, for user activity reports.
+ *
+ * @param object $course
+ * @param object $user
+ * @param object $mod
+ * @param object $oublog
+ * @return object containing a time and info properties
+ */
+function oublog_user_complete($course, $user, $mod, $oublog) {
+    global $CFG, $DB, $PAGE;
+    include_once($CFG->dirroot.'/mod/oublog/locallib.php');
+
+    $oublogoutput = $PAGE->get_renderer('mod_oublog');
+
+    $baseurl = $CFG->wwwroot.'/mod/oublog/view.php?id='.$mod->id;
+
+    $sql = "SELECT p.*
+            FROM {oublog_posts} p
+                INNER JOIN {oublog_instances} i ON p.oubloginstancesid = i.id
+            WHERE p.deletedby IS NULL AND i.userid = ? AND oublogid = ? ";
+
+    if ($posts = $DB->get_records_sql($sql, array($user->id, $mod->instance))) {
+        foreach ($posts as $post) {
+            $postdata = oublog_get_post($post->id);
+            echo $oublogoutput->render_post($mod, $oublog, $postdata, $baseurl, 'course');
+        }
+    } else {
+        echo get_string('noblogposts', 'oublog');
+    }
+
+    return(null);
+}
+
+
+
+/**
+ * Given a course and a time, this module should find recent activity
+ * that has occurred in newmodule activities and print it out.
+ * Return true if there was output, or false is there was none.
+ *
+ * @param object $course
+ * @param bool $isteacher
+ * @param int $timestart
+ * @return boolean true on success, false on failure.
+ **/
+function oublog_print_recent_activity($course, $isteacher, $timestart) {
+    global $CFG, $DB, $OUTPUT;
+
+    include_once('locallib.php');
+
+    $sql = "SELECT i.oublogid, p.id AS postid, p.*, u.firstname, u.lastname, u.email, u.idnumber, i.userid
+            FROM {oublog_posts} p
+                INNER JOIN {oublog_instances} i ON p.oubloginstancesid = i.id
+                INNER JOIN {oublog} b ON i.oublogid = b.id
+                INNER JOIN {user} u ON i.userid = u.id
+            WHERE b.course = ? AND p.deletedby IS NULL AND p.timeposted >= ? ";
+
+    if (!$rs = $DB->get_recordset_sql($sql, array($course->id, $timestart))) {
+        return(true);
+    }
+
+    $modinfo = get_fast_modinfo($course);
+
+    $strftimerecent = get_string('strftimerecent');
+    echo $OUTPUT->heading(get_string('newblogposts', 'oublog'), 3);
+
+    echo "\n<ul class='unlist'>\n";
+    foreach ($rs as $blog) {
+        if (!isset($modinfo->instances['oublog'][$blog->oublogid])) {
+            // not visible
+            continue;
+        }
+        $cm = $modinfo->instances['oublog'][$blog->oublogid];
+        if (!$cm->uservisible) {
+            continue;
+        }
+        if (!has_capability('mod/oublog:view', context_module::instance($cm->id))) {
+            continue;
+        }
+        if (!has_capability('mod/oublog:view', context_user::instance($blog->userid))) {
+            continue;
+        }
+
+        $groupmode = oublog_get_activity_groupmode($cm, $course);
+
+        if ($groupmode) {
+            if ($blog->groupid && $groupmode != VISIBLEGROUPS) {
+                // separate mode
+                if (isguestuser()) {
+                    // shortcut
+                    continue;
+                }
+
+                if (is_null($modinfo->groups)) {
+                    $modinfo->groups = groups_get_user_groups($course->id); // load all my groups and cache it in modinfo
+                }
+
+                if (!array_key_exists($blog->groupid, $modinfo->groups[0])) {
+                    continue;
+                }
+            }
+        }
+
+        echo '<li><div class="head">'.
+               '<div class="date">'.oublog_date($blog->timeposted, $strftimerecent).'</div>'.
+               '<div class="name">'.fullname($blog).'</div>'.
+             '</div>';
+        echo '<div class="info">';
+        echo "<a href=\"{$CFG->wwwroot}/mod/oublog/viewpost.php?post={$blog->postid}\">";
+        echo break_up_long_words(format_string(empty($blog->title) ? $blog->message : $blog->title));
+        echo '</a>';
+        echo '</div>';
+    }
+    $rs->close();
+    echo "</ul>\n";
+}
+
+
+
+/**
+ * Get recent activity for a course
+ *
+ * @param array $activities
+ * @param int $index
+ * @param int $timestart
+ * @param int $courseid
+ * @param int $cmid
+ * @param int $userid
+ * @param int $groupid
+ * @return bool
+ */
+function oublog_get_recent_mod_activity(&$activities, &$index, $timestart, $courseid, $cmid, $userid=0, $groupid=0) {
+    global $CFG, $COURSE, $DB;
+
+    $sql = "SELECT i.oublogid, p.id AS postid, p.*, u.firstname, u.lastname, u.email, u.idnumber, u.picture, u.imagealt, i.userid
+            FROM {oublog_posts} p
+                INNER JOIN {oublog_instances} i ON p.oubloginstancesid = i.id
+                INNER JOIN {oublog} b ON i.oublogid = b.id
+                INNER JOIN {user} u ON i.userid = u.id
+            WHERE b.course = ? AND p.deletedby IS NULL AND p.timeposted >= ? ";
+
+    if (!$rs = $DB->get_recordset_sql($sql, array($courseid, $timestart))) {
+        return(true);
+    }
+
+    $modinfo = get_fast_modinfo($COURSE);
+
+    foreach ($rs as $blog) {
+        if (!isset($modinfo->instances['oublog'][$blog->oublogid])) {
+            // not visible
+            continue;
+        }
+        $cm = $modinfo->instances['oublog'][$blog->oublogid];
+        if (!$cm->uservisible) {
+            continue;
+        }
+        if (!has_capability('mod/oublog:view', context_module::instance($cm->id))) {
+            continue;
+        }
+        if (!has_capability('mod/oublog:view', context_user::instance($blog->userid))) {
+            continue;
+        }
+
+        $groupmode = oublog_get_activity_groupmode($cm, $COURSE);
+
+        if ($groupmode) {
+            if ($blog->groupid && $groupmode != VISIBLEGROUPS) {
+                // separate mode
+                if (isguestuser()) {
+                    // shortcut
+                    continue;
+                }
+
+                if (is_null($modinfo->groups)) {
+                    $modinfo->groups = groups_get_user_groups($courseid); // load all my groups and cache it in modinfo
+                }
+
+                if (!array_key_exists($blog->groupid, $modinfo->groups[0])) {
+                    continue;
+                }
+            }
+        }
+
+        $tmpactivity = new stdClass();
+
+        $tmpactivity->type         = 'oublog';
+        $tmpactivity->cmid         = $cm->id;
+        $tmpactivity->name         = $blog->title;
+        $tmpactivity->sectionnum   = $cm->sectionnum;
+        $tmpactivity->timeposted    = $blog->timeposted;
+
+        $tmpactivity->content = new stdClass();
+        $tmpactivity->content->postid   = $blog->postid;
+        $tmpactivity->content->title    = format_string($blog->title);
+
+        $tmpactivity->user = new stdClass();
+        $tmpactivity->user->id        = $blog->userid;
+        $tmpactivity->user->firstname = $blog->firstname;
+        $tmpactivity->user->lastname  = $blog->lastname;
+        $tmpactivity->user->picture   = $blog->picture;
+        $tmpactivity->user->imagealt  = $blog->imagealt;
+        $tmpactivity->user->email     = $blog->email;
+
+        $activities[$index++] = $tmpactivity;
+    }
+    $rs->close();
+}
+
+
+/**
+ * Print recent oublog activity for a course
+ *
+ * @param object $activity
+ * @param int $courseid
+ * @param bool $detail
+ * @param array $modnames
+ * @param bool $viewfullnames
+ */
+function oublog_print_recent_mod_activity($activity, $courseid, $detail, $modnames, $viewfullnames) {
+    global $CFG, $OUTPUT;
+
+    echo '<table border="0" cellpadding="3" cellspacing="0" class=oublog-recent">';
+
+    echo "<tr><td class=\"userpicture\" valign=\"top\">";
+    echo $OUTPUT->user_picture($activity->user, array('courseid'=>$courseid));
+    echo "</td><td>";
+
+    echo '<div class="title">';
+    if ($detail) {
+        echo "<img src=\"".$OUTPUT->pix_url('icon', $activity->type)."\" class=\"icon\" alt=\"".s($activity->title)."\" />";
+    }
+    echo "<a href=\"$CFG->wwwroot/mod/oublog/viewpost.php?post={$activity->content->postid}\">{$activity->content->title}</a>";
+    echo '</div>';
+
+    echo '<div class="user">';
+    $fullname = fullname($activity->user, $viewfullnames);
+    echo "<a href=\"$CFG->wwwroot/user/view.php?id={$activity->user->id}&amp;course=$courseid\">"
+    ."{$fullname}</a> - ".oublog_date($activity->timeposted);
+    echo '</div>';
+    echo "</td></tr></table>";
+
+    return;
+}
+
+
+/**
+ * Obtains a search document given the ousearch parameters.
+ * @param object $document Object containing fields from the ousearch documents table
+ * @return mixed False if object can't be found, otherwise object containing the following
+ *   fields: ->content, ->title, ->url, ->activityname, ->activityurl
+ */
+function oublog_ousearch_get_document($document) {
+    global $CFG, $DB;
+    require_once('locallib.php');
+
+    // Get data
+    if (!($cm=$DB->get_record('course_modules', array('id' => $document->coursemoduleid)))) {
+        return false;
+    }
+    if (!($oublog=$DB->get_record('oublog', array('id' => $cm->instance)))) {
+        return false;
+    }
+    if (!($post=$DB->get_record_sql("
+SELECT
+    p.*,bi.userid
+FROM
+{oublog_posts} p
+    INNER JOIN {oublog_instances} bi ON p.oubloginstancesid=bi.id
+WHERE
+    p.id= ? ", array($document->intref1)))) {
+        return false;
+    }
+
+    $result=new StdClass;
+
+    // Set up activity name and URL
+    $result->activityname=$oublog->name;
+    if ($oublog->global) {
+        $result->activityurl=$CFG->wwwroot.'/mod/oublog/view.php?user='.
+        $document->userid;
+    } else {
+        $result->activityurl=$CFG->wwwroot.'/mod/oublog/view.php?id='.
+        $document->coursemoduleid;
+    }
+
+    // Now do the post details
+    $result->title=$post->title;
+    $result->content=$post->message;
+    $result->url=$CFG->wwwroot.'/mod/oublog/viewpost.php?post='.$document->intref1;
+
+    // Sort out tags for use as extrastrings
+    $taglist=oublog_get_post_tags($post, true);
+    if (count($taglist)!=0) {
+        $result->extrastrings=$taglist;
+    }
+
+    // Post object is used in filter
+    $result->data=$post;
+
+    return $result;
+}
+
+/**
+ * Update all documents for ousearch.
+ * @param bool $feedback If true, prints feedback as HTML list items
+ * @param int $courseid If specified, restricts to particular courseid
+ */
+function oublog_ousearch_update_all($feedback=false, $courseid=0) {
+    global $CFG, $DB;
+    require_once($CFG->dirroot . '/mod/oublog/locallib.php');
+
+    // Get all existing blogs as $cm objects (which we are going to need to
+    // do the updates). get_records is ok here because we're only taking a
+    // few fields and there's unlikely to be more than a few thousand blog
+    // instances [user blogs all use a single course-module]
+    $coursemodules=$DB->get_records_sql("
+SELECT
+    cm.id,cm.course,cm.instance
+FROM
+{modules} m
+    INNER JOIN {course_modules} cm ON m.id=cm.module
+WHERE
+    m.name='oublog'".($courseid ? " AND cm.course= ? " : ""), array($courseid));
+    if (!$coursemodules) {
+        $coursemodules = array();
+    }
+
+    // Display info and loop around each coursemodule
+    if ($feedback) {
+        print '<li><strong>'.count($coursemodules).'</strong> instances to process.</li>';
+        $dotcount=0;
+    }
+    $posts=0; $instances=0;
+    foreach ($coursemodules as $coursemodule) {
+
+        // Get all the posts that aren't deleted
+        $rs=$DB->get_recordset_sql("
+SELECT
+    p.id,p.title,p.message,p.groupid,i.userid
+FROM
+{oublog_instances} i
+    INNER JOIN {oublog_posts} p ON p.oubloginstancesid=i.id
+WHERE
+    p.deletedby IS NULL AND i.oublogid= ? ", array($coursemodule->instance));
+
+        foreach ($rs as $post) {
+            oublog_search_update($post, $coursemodule);
+
+            // Add to count and do user feedback every 100 posts
+            $posts++;
+            if ($feedback && ($posts%100)==0) {
+                if ($dotcount==0) {
+                    print '<li>';
+                }
+                print '.';
+                $dotcount++;
+                if ($dotcount == 20 || $instances == count($coursemodules)) {
+                    print "done $posts posts ($instances instances)</li>";
+                    $dotcount=0;
+                }
+                flush();
+            }
+        }
+        $rs->close();
+
+        $instances++;
+    }
+    if ($feedback && ($dotcount!=0 || $posts<100)) {
+        print ($dotcount==0?'<li>':'')."done $posts posts ($instances instances)</li>";
+    }
+}
+
+/**
+ * Indicates API features that the module supports.
+ *
+ * @param string $feature
+ * @return mixed True if yes (some features may use other values)
+ */
+function oublog_supports($feature) {
+    switch($feature) {
+        case FEATURE_COMPLETION_TRACKS_VIEWS: return true;
+        case FEATURE_COMPLETION_HAS_RULES: return true;
+        case FEATURE_BACKUP_MOODLE2: return true;
+        case FEATURE_MOD_INTRO: return true;
+        case FEATURE_GROUPINGS: return true;
+        case FEATURE_GROUPS: return true;
+        case FEATURE_GRADE_HAS_GRADE: return true;
+        case FEATURE_RATE: return true;
+        default: return null;
+    }
+}
+
+/**
+ * Obtains the automatic completion state for this module based on any conditions
+ * in module settings.
+ *
+ * @param object $course Course
+ * @param object $cm Course-module
+ * @param int $userid User ID
+ * @param bool $type Type of comparison (or/and; can be used as return value if no conditions)
+ * @return bool True if completed, false if not, $type if conditions not set.
+ */
+function oublog_get_completion_state($course, $cm, $userid, $type) {
+    global $DB;
+
+    // Get oublog details
+    if (!($oublog=$DB->get_record('oublog', array('id' => $cm->instance)))) {
+        throw new Exception("Can't find oublog {$cm->instance}");
+    }
+
+    $result=$type; // Default return value
+
+    if ($oublog->completionposts) {
+        // Count of posts by user
+        $value = $oublog->completionposts <= $DB->get_field_sql("
+SELECT
+    COUNT(1)
+FROM
+{oublog_instances} i
+    INNER JOIN {oublog_posts} p ON i.id=p.oubloginstancesid
+WHERE
+    i.userid= ? AND i.oublogid=? AND p.deletedby IS NULL", array($userid, $oublog->id));
+        if ($type==COMPLETION_AND) {
+            $result=$result && $value;
+        } else {
+            $result=$result || $value;
+        }
+    }
+    if ($oublog->completioncomments) {
+        // Count of comments by user (on posts by any user)
+        $value = $oublog->completioncomments <= $DB->get_field_sql("
+SELECT
+    COUNT(1)
+FROM
+{oublog_comments} c
+    INNER JOIN {oublog_posts} p ON p.id=c.postid
+    INNER JOIN {oublog_instances} i ON i.id=p.oubloginstancesid
+WHERE
+    c.userid= ? AND i.oublogid= ? AND p.deletedby IS NULL AND c.deletedby IS NULL", array($userid, $oublog->id));
+        if ($type==COMPLETION_AND) {
+            $result=$result && $value;
+        } else {
+            $result=$result || $value;
+        }
+    }
+
+    return $result;
+}
+
+
+/**
+ * This function returns a summary of all the postings since the current user
+ * last logged in.
+ */
+function oublog_print_overview($courses, &$htmlarray) {
+    global $USER, $CFG, $DB;
+
+    if (empty($courses) || !is_array($courses) || count($courses) == 0) {
+        return array();
+    }
+
+    if (!$blogs = get_all_instances_in_courses('oublog', $courses)) {
+        return;
+    }
+
+    // get all  logs in ONE query
+    $sql = "SELECT instance,cmid,l.course,COUNT(l.id) as count FROM {log} l "
+    ." JOIN {course_modules} cm ON cm.id = cmid "
+    ." WHERE (";
+    $params = array();
+    foreach ($courses as $course) {
+        $sql .= '(l.course = ? AND l.time > ? )  OR ';
+        $params[] = $course->id;
+        $params[] = $course->lastaccess;
+    }
+    $sql = substr($sql, 0, -3); // take off the last OR
+
+    // Ignore comment actions for now, only entries.
+    $sql .= ") AND l.module = 'oublog' AND action in('add post','edit post')
+      AND userid != ? GROUP BY cmid,l.course,instance";
+    $params[] = $USER->id;
+    if (!$new = $DB->get_records_sql($sql, $params)) {
+        $new = array(); // avoid warnings
+    }
+
+    $strblogs = get_string('modulenameplural', 'oublog');
+
+    $site = get_site();
+    if (count( $courses ) == 1 && isset( $courses[$site->id])) {
+        $strnumrespsince1 = get_string('overviewnumentrylog1', 'oublog');
+        $strnumrespsince = get_string('overviewnumentrylog', 'oublog');
+    } else {
+        $strnumrespsince1 = get_string('overviewnumentryvw1', 'oublog');
+        $strnumrespsince = get_string('overviewnumentryvw', 'oublog');
+    }
+
+    // Go through the list of all oublog instances build previously, and check whether
+    // they have had any activity.
+    foreach ($blogs as $blog) {
+        if (array_key_exists($blog->id, $new) && !empty($new[$blog->id])) {
+            $count = $new[$blog->id]->count;
+            if ($count > 0) {
+                if ($count == 1) {
+                    $strresp = $strnumrespsince1;
+                } else {
+                    $strresp = $strnumrespsince;
+                }
+
+                $str = '<div class="overview oublog"><div class="name">'.
+                $strblogs.': <a title="'.$strblogs.'" href="';
+                if ($blog->global=='1') {
+                    $str .= $CFG->wwwroot.'/mod/oublog/allposts.php">'.$blog->name.'</a></div>';
+                } else {
+                    $str .= $CFG->wwwroot.'/mod/oublog/view.php?id='.$new[$blog->id]->cmid.'">'.$blog->name.'</a></div>';
+                }
+                $str .= '<div class="info">';
+                $str .= $count.' '.$strresp;
+                $str .= '</div></div>';
+
+                if (!array_key_exists($blog->course, $htmlarray)) {
+                    $htmlarray[$blog->course] = array();
+                }
+                if (!array_key_exists('oublog', $htmlarray[$blog->course])) {
+                    $htmlarray[$blog->course]['oublog'] = ''; // initialize, avoid warnings
+                }
+                $htmlarray[$blog->course]['oublog'] .= $str;
+
+            }
+
+        }
+
+    }
+
+}
+
+/**
+ * Serves the oublog attachments. Implements needed access control ;-)
+ *
+ * @param object $course
+ * @param object $cm
+ * @param object $context
+ * @param string $filearea
+ * @param array $args
+ * @param bool $forcedownload
+ * @return bool false if file not found, does not return if found - justsend the file
+ */
+function oublog_pluginfile($course, $cm, $context, $filearea, $args, $forcedownload) {
+    global $CFG, $DB, $USER;
+
+    if ($context->contextlevel != CONTEXT_MODULE) {
+        return false;
+    }
+
+    $fileareas = array('attachment', 'message', 'edit', 'messagecomment', 'summary');
+    if (!in_array($filearea, $fileareas)) {
+        return false;
+    }
+    require_once(dirname(__FILE__).'/locallib.php');
+    if ($filearea=='edit') {
+        $editid = (int)array_shift($args);
+
+        if (!$edit = $DB->get_record('oublog_edits', array('id'=>$editid))) {
+            return false;
+        }
+        $postid = $edit->postid;
+        $fileid = $editid;
+    } else {
+        $postid = (int)array_shift($args);
+        $fileid = $postid;
+    }
+
+    if ($filearea != 'summary') {
+        if ($filearea == 'messagecomment') {
+            if (!$comment = $DB->get_record('oublog_comments', array('id' => $postid), 'postid')) {
+                return false;
+            }
+            $postid = $comment->postid;
+        }
+        if (!$post = $DB->get_record('oublog_posts', array('id'=>$postid))) {
+            return false;
+        }
+        if (!($oublog = oublog_get_blog_from_postid($post->id))) {
+            return false;
+        }
+    }
+
+    $fs = get_file_storage();
+    $relativepath = implode('/', $args);
+    $fullpath = "/$context->id/mod_oublog/$filearea/$fileid/$relativepath";
+
+    if (!$file = $fs->get_file_by_hash(sha1($fullpath)) or $file->is_directory()) {
+        return false;
+    }
+
+    // Make sure we're allowed to see it...
+    // Check if coming from webservice - if so always allow.
+    $ajax = constant('AJAX_SCRIPT') ? true : false;
+    if ($filearea != 'summary' && !$ajax && !oublog_can_view_post($post, $USER, $context, $oublog->global)) {
+        return false;
+    }
+    if ($filearea == 'attachment') {
+        $forcedownload = true;
+    } else {
+        $forcedownload = false;
+    }
+    // Finally send the file.
+    send_stored_file($file, 0, 0, $forcedownload);
+}
+
+/**
+ * File browsing support for oublog module.
+ * @param object $browser
+ * @param object $areas
+ * @param object $course
+ * @param object $cm
+ * @param object $context
+ * @param string $filearea
+ * @param int $itemid
+ * @param string $filepath
+ * @param string $filename
+ * @return file_info instance Representing an actual file or folder (null if not found
+ * or cannot access)
+ */
+function oublog_get_file_info($browser, $areas, $course, $cm, $context, $filearea,
+        $itemid, $filepath, $filename) {
+    global $CFG, $USER, $DB;
+    require_once($CFG->dirroot . '/mod/oublog/locallib.php');
+
+    if ($context->contextlevel != CONTEXT_MODULE) {
+        return null;
+    }
+    $fileareas = array('attachment', 'message', 'edit', 'messagecomment');
+    if (!in_array($filearea, $fileareas)) {
+        return null;
+    }
+    $postid = $itemid;
+    if ($filearea == 'messagecomment') {
+        if (!$comment = $DB->get_record('oublog_comments', array('id' => $postid), 'postid')) {
+            return null;
+        }
+        $postid = $comment->postid;
+    }
+
+    if (!($oublog = oublog_get_blog_from_postid($postid))) {
+        return null;
+    }
+    // Check if the user is allowed to view the blog.
+    if (!has_capability('mod/oublog:view', $context)) {
+        return null;
+    }
+
+    if (!$post = oublog_get_post($postid)) {
+        return null;
+    }
+    // Check if the user is allowed to view the post
+    try {
+        if (!oublog_can_view_post($post, $USER, $context, $oublog->global)) {
+            return null;
+        }
+    } catch (mod_oublog_exception $e) {
+        return null;
+    }
+
+    $fs = get_file_storage();
+    $filepath = is_null($filepath) ? '/' : $filepath;
+    $filename = is_null($filename) ? '.' : $filename;
+    if (!($storedfile = $fs->get_file($context->id, 'mod_oublog', $filearea, $itemid,
+            $filepath, $filename))) {
+        return null;
+    }
+
+    $urlbase = $CFG->wwwroot . '/pluginfile.php';
+    return new file_info_stored($browser, $context, $storedfile, $urlbase, $filearea,
+            $itemid, true, true, false);
+}
+
+/**
+ * Sets the module uservisible to false if the user has not got the view capability
+ * @param cm_info $cm
+ */
+function oublog_cm_info_dynamic(cm_info $cm) {
+    global $remoteuserid, $USER;
+    $userid = $USER;
+    if (isset($remoteuserid) && !empty($remoteuserid)) {
+        // Hack using dodgy global. The actual user id for specific user e.g. from webservice.
+        $userid = $remoteuserid;
+    }
+    $capability = 'mod/oublog:view';
+    if ($cm->course == SITEID && $cm->instance == 1) {
+        // Is global blog (To save DB call we make suspect assumption it is instance 1)?
+        $capability = 'mod/oublog:viewpersonal';
+    }
+    if (!has_capability($capability,
+            context_module::instance($cm->id), $userid)) {
+        $cm->set_user_visible(false);
+        $cm->set_available(false);
+    }
+}
+
+/**
+ * Show last updated date + time (post created).
+ *
+ * @param cm_info $cm
+ */
+function oublog_cm_info_view(cm_info $cm) {
+    global $CFG;
+    if (!$cm->uservisible) {
+        return;
+    }
+    require_once($CFG->dirroot . '/mod/oublog/locallib.php');
+
+    $lastpostdate = oublog_get_last_modified($cm, $cm->get_course());
+    if (!empty($lastpostdate)) {
+        $cm->set_after_link(html_writer::span(get_string('lastmodified', 'oublog',
+                        userdate($lastpostdate, get_string('strftimerecent', 'oublog'))), 'lastmodtext oubloglmt'));
+    }
+}
+
+/**
+ * Return blogs on course that have last modified date for current user
+ *
+ * @param stdClass $course
+ * @return array
+ */
+function oublog_get_ourecent_activity($course) {
+    global $CFG;
+    require_once($CFG->dirroot . '/mod/oublog/locallib.php');
+
+    $modinfo = get_fast_modinfo($course);
+
+    $return = array();
+
+    foreach ($modinfo->get_instances_of('oublog') as $blog) {
+        if ($blog->uservisible) {
+            $lastpostdate = oublog_get_last_modified($blog, $blog->get_course());
+            if (!empty($lastpostdate)) {
+                $data = new stdClass();
+                $data->cm = $blog;
+                $data->text = get_string('lastmodified', 'oublog',
+                        userdate($lastpostdate, get_string('strftimerecent', 'oublog')));
+                $data->date = $lastpostdate;
+                $return[$data->cm->id] = $data;
+            }
+        }
+    }
+    return $return;
+}
+
+/**
+ * Create grade item for given oublog
+ *
+ * @param object $oublog
+ * @param mixed $grades optional array/object of grade(s); 'reset' means reset grades in gradebook
+ * @return int 0 if ok, error code otherwise
+ */
+function oublog_grade_item_update($oublog, $grades = null) {
+    global $CFG;
+    require_once($CFG->libdir . '/gradelib.php');
+    require_once($CFG->dirroot . '/mod/oublog/locallib.php');
+    // Use 'grade' or 'scale' depends upon 'grading'.
+    if ($oublog->grading == OUBLOG_USE_RATING) {
+        $oublogscale = $oublog->scale;
+    } else if ($oublog->grading == OUBLOG_NO_GRADING) {
+        $oublogscale = 0;
+    } else {
+        $oublogscale = $oublog->grade;
+    }
+
+    $params = array('itemname' => $oublog->name);
+
+    if ($oublogscale > 0) {
+        $params['gradetype'] = GRADE_TYPE_VALUE;
+        $params['grademax'] = $oublogscale;
+        $params['grademin'] = 0;
+
+    } else if ($oublogscale < 0) {
+        $params['gradetype'] = GRADE_TYPE_SCALE;
+        $params['scaleid'] = -$oublogscale;
+
+    } else {
+        $params['gradetype'] = GRADE_TYPE_NONE;
+    }
+
+    if ($grades === 'reset') {
+        $params['reset'] = true;
+        $grades = null;
+    }
+
+    return grade_update('mod/oublog', $oublog->course, 'mod',
+        'oublog', $oublog->id, 0, $grades, $params);
+}
+
+/**
+ * Delete grade item for given oublog
+ *
+ * @param object $oublog object
+ * @return object oublog
+ */
+function oublog_grade_item_delete($oublog) {
+    global $CFG;
+    require_once($CFG->libdir.'/gradelib.php');
+
+    return grade_update('mod/oublog', $oublog->course, 'mod',
+        'oublog', $oublog->id, 0, null, array('deleted' => 1));
+}
+
+/**
+ * Returns all other caps used in oublog at module level.
+ */
+function oublog_get_extra_capabilities() {
+    return array('moodle/site:accessallgroups', 'moodle/site:viewfullnames',
+            'report/oualerts:managealerts', 'report/restrictuser:view',
+            'report/restrictuser:restrict', 'report/restrictuser:removerestrict');
+}
+
+/**
+ * Implementation of the function for printing the form elements that control
+ * whether the course reset functionality affects the oublog.
+ *
+ * @param object $mform form passed by reference
+ */
+function oublog_reset_course_form_definition(&$mform) {
+    $mform->addElement('header', 'oublogheader', get_string('modulenameplural', 'oublog'));
+    $mform->addElement('advcheckbox', 'reset_oublog', get_string('removeblogs', 'oublog'));
+}
+
+/**
+ * Actual implementation of the reset course functionality, delete all
+ * oublog posts.
+ *
+ * @global object
+ * @global object
+ * @param object $data the data submitted from the reset course.
+ * @return array status array
+ */
+function oublog_reset_userdata($data) {
+    global $DB;
+
+    $componentstr = get_string('modulenameplural', 'oublog');
+    $status = array();
+
+    if (!empty($data->reset_oublog)) {
+        // Delete post-related data.
+        $postidsql = "SELECT pst.id
+                        FROM {oublog_posts} pst
+                        JOIN {oublog_instances} ins ON (ins.id = pst.oubloginstancesid)
+                        JOIN {oublog} obl ON (obl.id = ins.oublogid)
+                       WHERE obl.course = ?";
+        $params = array($data->courseid);
+        $DB->delete_records_select('oublog_comments', "postid IN ($postidsql)", $params);
+        $DB->delete_records_select('oublog_comments_moderated', "postid IN ($postidsql)", $params);
+        $DB->delete_records_select('oublog_edits', "postid IN ($postidsql)", $params);
+
+        // Delete instance-related data.
+        $insidsql = "SELECT ins.id
+                       FROM {oublog_instances} ins
+                       JOIN {oublog} obl ON (obl.id = ins.oublogid)
+                      WHERE obl.course = ?";
+        $DB->delete_records_select('oublog_links', "oubloginstancesid IN ($insidsql)", $params);
+        $DB->delete_records_select('oublog_taginstances', "oubloginstancesid IN ($insidsql)", $params);
+        $DB->delete_records_select('oublog_posts', "oubloginstancesid IN ($insidsql)", $params);
+
+        $blogidsql = "SELECT obl.id
+                        FROM {oublog} obl
+                       WHERE obl.course = ?";
+        // Delete instances:
+        $DB->delete_records_select('oublog_instances', "oublogid IN ($blogidsql)", $params);
+
+        // Reset views:
+        $DB->execute("UPDATE {oublog} SET views = 0 WHERE course = ?", $params);
+
+        $rm = new rating_manager();
+        $ratingdeloptions = new stdClass;
+        $ratingdeloptions->component = 'mod_oublog';
+        $ratingdeloptions->ratingarea = 'post';
+
+        // Now get rid of all attachments and ratings.
+        $fs = get_file_storage();
+        $oublogs = get_coursemodules_in_course('oublog', $data->courseid);
+        if ($oublogs) {
+            foreach ($oublogs as $oublogid => $unused) {
+                if (!$cm = get_coursemodule_from_instance('oublog', $oublogid)) {
+                    continue;
+                }
+                $context = context_module::instance($cm->id);
+                $fs->delete_area_files($context->id, 'mod_oublog', 'attachment');
+                $fs->delete_area_files($context->id, 'mod_oublog', 'message');
+                $fs->delete_area_files($context->id, 'mod_oublog', 'messagecomment');
+
+                $ratingdeloptions->contextid = $context->id;
+                $rm->delete_ratings($ratingdeloptions);
+            }
+        }
+
+        $status[] = array(
+                'component' => $componentstr,
+                'item' => get_string('removeblogs', 'oublog'),
+                'error' => false
+        );
+    }
+    return $status;
+}
+
+/**
+ * List of view style log actions
+ * @return array
+ */
+function oublog_get_view_actions() {
+    return array('view', 'view all');
+}
+
+/**
+ * List of update style log actions
+ * @return array
+ */
+function oublog_get_post_actions() {
+    return array('update', 'add', 'add comment', 'add post', 'edit post');
+}
+
+function oublog_oualerts_additional_recipients($type, $id) {
+    global $CFG, $USER, $DB;
+    require_once($CFG->dirroot . '/mod/oublog/locallib.php');
+    $additionalemails = '';
+
+    switch ($type) {
+        case 'post':
+            $data = oublog_get_blog_from_postid ($id);
+            break;
+        case 'comment':
+            $postid = $DB->get_field('oublog_comments', 'postid', array('id' => $id));
+            $data = oublog_get_blog_from_postid($postid);
+            break;
+        default:
+            $data = false;
+            break;
+    }
+    if ($data != false) {
+        // Return alert recipients addresses for notification.
+        $reportingemails = oublog_get_reportingemail($data);
+        if ($reportingemails != false) {
+            $additionalemails = explode(',', trim($reportingemails));
+        }
+    }
+    return $additionalemails;
+}
+
+function oublog_oualerts_custom_info($item, $id) {
+    global $CFG, $USER, $DB;
+
+    require_once($CFG->dirroot . '/mod/oublog/locallib.php');
+
+    switch ($item) {
+        case 'post':
+            $data =  oublog_get_post($id);
+            $itemtitle = get_string('untitledpost', 'oublog');
+            break;
+        case 'comment':
+            $data = $DB->get_record('oublog_comments', array('id' => $id));
+            $itemtitle = get_string('untitledcomment', 'oublog');
+            break;
+        default:
+            $data = false;
+            break;
+    }
+
+    if ($data != false && !empty($data->title)) {
+        $itemtitle = $data->title;
+    }
+    // Return just the title string value of the post or comment.
+    return $itemtitle;
+}
+
+/**
+ * If OU alerts is enabled, and the blog has reporting email setup,
+ * if the user has the report/oualerts:managealerts capability for the context then
+ * the link to the alerts report should be added.
+ *
+ * @global object
+ * @global object
+ */
+function oublog_extend_settings_navigation(settings_navigation $settings, navigation_node $node) {
+    global $DB, $CFG, $PAGE;
+
+    if (!$oublog = $DB->get_record("oublog", array("id" => $PAGE->cm->instance))) {
+        return;
+    }
+
+    include_once($CFG->dirroot.'/mod/oublog/locallib.php');
+    if (oublog_oualerts_enabled() && oublog_get_reportingemail($oublog)) {
+        if (has_capability('report/oualerts:managealerts',
+                context_module::instance($PAGE->cm->id))) {
+            $node->add(get_string('oublog_managealerts', 'oublog'),
+                    new moodle_url('/report/oualerts/manage.php', array('cmid' => $PAGE->cm->id,
+                            'coursename' => $PAGE->course->id, 'contextcourseid' => $PAGE->course->id)),
+                            settings_navigation::TYPE_CUSTOM);
+        }
+    }
+}
+
+/**
+ * Return rating related permissions
+ *
+ * @param string $options the context id
+ * @return array an associative array of the user's rating permissions
+ */
+function oublog_rating_permissions($contextid, $component, $ratingarea) {
+    $context = context::instance_by_id($contextid, MUST_EXIST);
+    if ($component != 'mod_oublog' || $ratingarea != 'post') {
+        // We don't know about this component/ratingarea so just return null to get the
+        // default restrictive permissions.
+        return null;
+    }
+    return array(
+        'view' => has_capability('mod/oublog:viewrating', $context),
+        'viewany' => has_capability('mod/oublog:viewanyrating', $context),
+        'viewall' => has_capability('mod/oublog:viewallratings', $context),
+        'rate' => has_capability('mod/oublog:rate', $context)
+    );
+}
+
+/**
+ * Validates a submitted rating
+ * @param array $params submitted data
+ *            context => object the context in which the rated items exists [required]
+ *            component => The component for this module - should always be mod_oublog [required]
+ *            ratingarea => object the context in which the rated items exists [required]
+ *            itemid => int the ID of the object being rated [required]
+ *            scaleid => int the scale from which the user can select a rating. Used for bounds checking. [required]
+ *            rating => int the submitted rating
+ *            rateduserid => int the id of the user whose items have been rated. NOT the user who submitted the ratings. 0 to update all. [required]
+ *            aggregation => int the aggregation method to apply when calculating grades ie RATING_AGGREGATE_AVERAGE [optional]
+ * @return boolean true if the rating is valid. Will throw rating_exception if not
+ */
+function oublog_rating_validate($params) {
+    global $DB, $USER;
+
+    // Check the component is mod_oublog.
+    if ($params['component'] != 'mod_oublog') {
+        throw new rating_exception('invalidcomponent');
+    }
+
+    // Check the ratingarea is post (the only rating area in oublog).
+    if ($params['ratingarea'] != 'post') {
+        throw new rating_exception('invalidratingarea');
+    }
+
+    // Check the rateduserid is not the current user .. you can't rate your own posts.
+    if ($params['rateduserid'] == $USER->id) {
+        throw new rating_exception('nopermissiontorate');
+    }
+
+    $oublogsql = "SELECT p.id, o.id as oublogid, o.scale, o.course, p.timeposted,
+                          o.assessed, o.assesstimestart, o.assesstimefinish
+                    FROM {oublog} o
+                    JOIN {oublog_instances} i ON i.oublogid = o.id
+                    JOIN {oublog_posts} p ON p.oubloginstancesid = i.id
+                   WHERE p.id = :itemid";
+
+    $oublogparams = array('itemid' => $params['itemid']);
+    $info = $DB->get_record_sql($oublogsql, $oublogparams);
+    if (!$info) {
+        // Item doesn't exist.
+        throw new rating_exception('invaliditemid');
+    }
+
+    if ($info->scale != $params['scaleid']) {
+        // The scale being submitted doesnt match the one in the database.
+        throw new rating_exception('invalidscaleid');
+    }
+
+    // Check that the submitted rating is valid for the scale.
+
+    // Lower limit.
+    if ($params['rating'] < 0 && $params['rating'] != RATING_UNSET_RATING) {
+        throw new rating_exception('invalidnum');
+    }
+
+    // Upper limit.
+    if ($info->scale < 0) {
+        // Its a custom scale.
+        $scalerecord = $DB->get_record('scale', array('id' => -$info->scale));
+        if ($scalerecord) {
+            $scalearray = explode(',', $scalerecord->scale);
+            if ($params['rating'] > count($scalearray)) {
+                throw new rating_exception('invalidnum');
+            }
+        } else {
+            throw new rating_exception('invalidscaleid');
+        }
+    } else if ($params['rating'] > $info->scale) {
+        // If its numeric and submitted rating is above maximum.
+        throw new rating_exception('invalidnum');
+    }
+
+    if (!$info->assessed) {
+        // Item isnt approved.
+        throw new rating_exception('nopermissiontorate');
+    }
+
+    // Check the item we're rating was created in the assessable time window.
+    if (!empty($info->assesstimestart) && !empty($info->assesstimefinish)) {
+        if ($info->timeposted < $info->assesstimestart || $info->timeposted > $info->assesstimefinish) {
+            throw new rating_exception('notavailable');
+        }
+    }
+
+    $cm = get_coursemodule_from_instance('oublog', $info->oublogid, $info->course, false, MUST_EXIST);
+    $context = context_module::instance($cm->id, MUST_EXIST);
+
+    // If the supplied context doesnt match the item's context.
+    if ($context->id != $params['context']->id) {
+        throw new rating_exception('invalidcontext');
+    }
+
+    return true;
+}
+
+/**
+ * Can the current user see ratings for a given itemid?
+ *
+ * @param array $params submitted data
+ *            contextid => int contextid [required]
+ *            component => The component for this module - should always be mod_oublog [required]
+ *            ratingarea => object the context in which the rated items exists [required]
+ *            itemid => int the ID of the object being rated [required]
+ *            scaleid => int scale id [optional]
+ * @return bool
+ * @throws coding_exception
+ * @throws rating_exception
+ */
+function mod_oublog_rating_can_see_item_ratings($params) {
+    global $USER, $CFG;
+    require_once(dirname(__FILE__) . '/locallib.php');
+
+    // Check the component is mod_forum.
+    if (!isset($params['component']) || $params['component'] != 'mod_oublog') {
+        throw new rating_exception('invalidcomponent');
+    }
+
+    // Check the ratingarea is post (the only rating area in forum).
+    if (!isset($params['ratingarea']) || $params['ratingarea'] != 'post') {
+        throw new rating_exception('invalidratingarea');
+    }
+
+    if (!isset($params['itemid'])) {
+        throw new rating_exception('invaliditemid');
+    }
+    $context = context::instance_by_id($params['contextid']);
+
+    $blog = oublog_get_blog_from_postid($params['itemid']);
+    $post = oublog_get_post($params['itemid'], true);
+
+    if (!oublog_can_view_post($post, $USER, $context, $blog->global)) {
+        return false;
+    }
+
+    if (!has_capability('mod/oublog:viewallratings', $context)) {
+        return false;
+    }
+    return true;
+}
+
+/**
+ * Update activity grades
+ *
+ * @global object
+ * @global object
+ * @param object $oublog
+ * @param int $userid specific user only, 0 means all
+ * @param bool $nullifnone
+ */
+function oublog_update_grades($oublog, $userid = 0, $nullifnone = true) {
+    global $CFG, $DB;
+    require_once($CFG->libdir . '/gradelib.php');
+    require_once($CFG->dirroot . '/mod/oublog/locallib.php');
+    if ($oublog->grading != OUBLOG_USE_RATING) {
+        return;
+    }
+    if (!$oublog->assessed) {
+        oublog_grade_item_update($oublog);
+    } else if ($grades = oublog_get_user_grades($oublog, $userid)) {
+        oublog_grade_item_update($oublog, $grades);
+    } else if ($userid && $nullifnone) {
+        $grade = new stdClass();
+        $grade->userid = $userid;
+        $grade->rawgrade = null;
+        oublog_grade_item_update($oublog, $grade);
+    } else {
+        oublog_grade_item_update($oublog);
+    }
+}
+
+/**
+ * Return grade for given user or all users.
+ *
+ * @global object
+ * @param object $dataplus
+ * @param int $userid optional user id, 0 means all users
+ * @return array array of grades, false if none
+ */
+function oublog_get_user_grades($oublog, $userid = 0) {
+    global $CFG, $DB;
+    require_once($CFG->dirroot . '/rating/lib.php');
+    require_once($CFG->dirroot . '/mod/oublog/locallib.php');
+
+    $options = new stdClass();
+    $options->component = 'mod_oublog';
+    $options->ratingarea = 'post';
+    $options->modulename = 'oublog';
+    $options->moduleid = $oublog->id;
+    $options->userid = $userid;
+    $options->aggregationmethod = $oublog->assessed;
+    $options->scaleid = $oublog->scale;
+    $options->cmid = $oublog->cmidnumber;
+
+    // There now follows a lift of get_user_grades() from rating lib
+    // but with the requirement for items modified.
+    $rm = new rating_manager();
+
+    if (!isset($options->component)) {
+        throw new coding_exception(
+                'The component option is now a required option when getting user grades from ratings.'
+        );
+    }
+    if (!isset($options->ratingarea)) {
+        throw new coding_exception(
+                'The ratingarea option is now a required option when getting user grades from ratings.'
+        );
+    }
+
+    // Going direct to the db for the context id seemed wrong.
+    $context = context_module::instance($options->cmid );
+
+    $params = array();
+    $params['contextid'] = $context->id;
+    $params['component'] = $options->component;
+    $params['ratingarea'] = $options->ratingarea;
+    $scaleid = $options->scaleid;
+    $aggregationstring = $rm->get_aggregation_method($options->aggregationmethod);
+    // If userid is not 0 we only want the grade for a single user.
+    $singleuserwhere = '';
+    if ($options->userid != 0) {
+        // Get the grades for the {posts} the user is responsible for.
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmidnumber);
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, 0, $options->userid);
+        foreach ($posts as $post) {
+            $postids[] = (int)$post->id;
+        }
+        $params['userid'] = $userid;
+        $singleuserwhere = " AND i.userid = :userid";
+    }
+
+    $sql = "SELECT u.id as id, u.id AS userid, $aggregationstring(r.rating) AS rawgrade
+              FROM {oublog} o
+              JOIN {oublog_instances} i ON i.oublogid = o.id
+              JOIN {oublog_posts} p ON p.oubloginstancesid = i.id
+              JOIN {rating} r ON r.itemid = p.id
+              JOIN {user} u ON i.userid = u.id
+             WHERE r.contextid = :contextid
+                   AND r.component = :component
+                   AND r.ratingarea = :ratingarea
+                   $singleuserwhere
+          GROUP BY u.id";
+
+    $results = $DB->get_records_sql($sql, $params);
+
+    if ($results) {
+        $scale = null;
+        $max = 0;
+        if ($options->scaleid >= 0) {
+            // Numeric.
+            $max = $options->scaleid;
+        } else {
+            // Custom scales.
+            $scale = $DB->get_record('scale', array('id' => -$options->scaleid));
+            if ($scale) {
+                $scale = explode(',', $scale->scale);
+                $max = count($scale);
+            } else {
+                debugging(
+                    'rating_manager::get_user_grades() received a scale ID that doesnt exist'
+                );
+            }
+        }
+
+        // It could throw off the grading if count and sum returned a rawgrade higher than scale
+        // so to prevent it we review the results and ensure that rawgrade does not exceed
+        // the scale, if it does we set rawgrade = scale (i.e. full credit).
+        foreach ($results as $rid => $result) {
+            if ($options->scaleid >= 0) {
+                // Numeric.
+                if ($result->rawgrade > $options->scaleid) {
+                    $results[$rid]->rawgrade = $options->scaleid;
+                }
+            } else {
+                // Scales.
+                if (!empty($scale) && $result->rawgrade > $max) {
+                    $results[$rid]->rawgrade = $max;
+                }
+            }
+        }
+    }
+    return $results;
+}
diff --git a/mod/oublog/link_form.php b/mod/oublog/link_form.php
new file mode 100644
index 0000000..3d1b8bb
--- /dev/null
+++ b/mod/oublog/link_form.php
@@ -0,0 +1,57 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+require_once($CFG->libdir.'/formslib.php');
+
+class mod_oublog_link_form extends moodleform {
+
+    public function definition() {
+
+        global $CFG;
+
+        $edit = $this->_customdata['edit'];
+
+        $mform =& $this->_form;
+
+        $mform->addElement('header', 'general', '');
+
+        $mform->addElement('text', 'title', get_string('title', 'oublog'), 'size="48"');
+        $mform->setType('title', PARAM_TEXT);
+        $mform->addRule('title', get_string('required'), 'required', null, 'client');
+
+        $mform->addElement('text', 'url', get_string('url', 'oublog'), 'size="48"');
+        $mform->setType('url', PARAM_URL);
+        $mform->addRule('url', get_string('required'), 'required', null, 'client');
+
+        if ($edit) {
+            $submitstring = get_string('savechanges');
+        } else {
+            $submitstring = get_string('addlink', 'oublog');
+        }
+
+        $this->add_action_buttons(true, $submitstring);
+
+        // Hidden form vars.
+        $mform->addElement('hidden', 'blog');
+        $mform->setType('blog', PARAM_INT);
+
+        $mform->addElement('hidden', 'bloginstance');
+        $mform->setType('bloginstance', PARAM_INT);
+
+        $mform->addElement('hidden', 'link');
+        $mform->setType('link', PARAM_INT);
+
+    }
+}
\ No newline at end of file
diff --git a/mod/oublog/locallib.php b/mod/oublog/locallib.php
new file mode 100644
index 0000000..75f26cbad
--- /dev/null
+++ b/mod/oublog/locallib.php
@@ -0,0 +1,5272 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Library of functions used by the oublog module.
+ *
+ * This contains functions that are called from within the oublog module only
+ * Functions that are also called by core Moodle are in {@link lib.php}
+ *
+ * @author Matt Clarkson <mattc@catalyst.net.nz>
+ * @author Sam Marshall <s.marshall@open.ac.uk>
+ * @author M Kassaei <m.kassaei@open.ac.uk>
+ * @license http://www.gnu.org/copyleft/gpl.html GNU Public License
+ * @package oublog
+ */
+
+require_once($CFG->libdir . '/portfolio/caller.php');
+require_once($CFG->libdir . '/gradelib.php');
+require_once($CFG->libdir . '/filelib.php');
+/**#@+
+ * Constants defining the visibility levels of blog posts
+ */
+define('OUBLOG_VISIBILITY_COURSEUSER',   100);
+define('OUBLOG_VISIBILITY_LOGGEDINUSER', 200);
+define('OUBLOG_VISIBILITY_PUBLIC',       300);
+/**#@-*/
+
+/**#@+
+ * Constants defining the ability to post comments
+ */
+define('OUBLOG_COMMENTS_PREVENT', 0);
+define('OUBLOG_COMMENTS_ALLOW',   1);
+define('OUBLOG_COMMENTS_ALLOWPUBLIC', 2);
+/**#@-*/
+
+/**#@+
+ * Constants for the 'approval' field in modreated comments
+ */
+define('OUBLOG_MODERATED_UNSET', 0);
+define('OUBLOG_MODERATED_APPROVED', 1);
+define('OUBLOG_MODERATED_REJECTED', 2);
+/**#@-*/
+
+/**#@+
+ * Constant defining the number of posts to display per page
+ */
+define('OUBLOG_POSTS_PER_PAGE', 20);
+/**#@-*/
+
+/**#@+
+ * Constant defining the max number of items in an RSS or Atom feed
+ */
+define('OUBLOG_MAX_FEED_ITEMS', 20);
+/**#@-*/
+
+/**#@+
+ * Constants defining the visibility for participation pages
+ */
+define('OUBLOG_USER_PARTICIPATION', 2);
+define('OUBLOG_MY_PARTICIPATION', 1);
+define('OUBLOG_NO_PARTICIPATION', 0);
+define('OUBLOG_PARTICIPATION_PERPAGE', 50);
+/**#@-*/
+
+// Constants defining stats time filter.
+define('OUBLOG_STATS_TIMEFILTER_ALL', 0);
+define('OUBLOG_STATS_TIMEFILTER_MONTH', 1);
+define('OUBLOG_STATS_TIMEFILTER_YEAR', 2);
+
+// Constants defining grading options.
+define('OUBLOG_NO_GRADING', 0);
+define('OUBLOG_TEACHER_GRADING', 1);
+define('OUBLOG_USE_RATING', 2);
+
+/**
+ * Get a blog from a user id
+ *
+ * @param int $userid
+ * @return mixed Oublog object on success, false on failure
+ */
+function oublog_get_personal_blog($userid) {
+    global $CFG, $DB;
+
+    if (!$blog = $DB->get_record('oublog', array('global'=>1))) {
+        print_error('globalblogmissing', 'oublog');
+    }
+
+    if (!$oubloginstance = $DB->get_record('oublog_instances', array('oublogid'=>$blog->id, 'userid'=>$userid))) {
+        $user = $DB->get_record('user', array('id'=>$userid));
+        $a = (object) array('name' => fullname($user), 'displayname' => oublog_get_displayname($blog));
+        oublog_add_bloginstance($blog->id, $userid, get_string('defaultpersonalblogname', 'oublog', $a));
+        if (!$oubloginstance = $DB->get_record('oublog_instances', array('oublogid'=>$blog->id, 'userid'=>$user->id))) {
+            print_error('invalidblog', 'oublog');
+        }
+    }
+
+    return(array($blog, $oubloginstance));
+}
+
+/**
+ * Obtains the oublog object based on a post ID.
+ * @param int $postid Post ID
+ * @return object Moodle data object for oublog row, or false if not found
+ */
+function oublog_get_blog_from_postid($postid) {
+    global $DB;
+    $postid = (int)$postid;
+    return $DB->get_record_sql("
+SELECT
+    o.*
+FROM
+    {oublog_posts} p
+    INNER JOIN {oublog_instances} i on i.id = p.oubloginstancesid
+    INNER JOIN {oublog} o ON o.id = i.oublogid
+WHERE
+    p.id= ? ", array($postid));
+}
+
+/**
+ * Checks if a user is allowed to view a blog. If not, will not return (calls
+ * an error function and exits).
+ * @param object $oublog
+ * @param object $context
+ * @param object $cm
+ * @return void
+ */
+function oublog_check_view_permissions($oublog, $context, $cm=null) {
+    global $COURSE, $PAGE, $DB;
+
+    $capability=$oublog->global ? 'mod/oublog:viewpersonal' : 'mod/oublog:view';
+
+    switch ($oublog->maxvisibility) {
+        case OUBLOG_VISIBILITY_PUBLIC:
+            if ($oublog->course == $COURSE->id or empty($oublog->course)) {
+                $oublogcourse = $COURSE;
+            } else {
+                $oublogcourse = $DB->get_record('course', array('id'=>$oublog->course),
+                        '*', MUST_EXIST);
+            }
+            $PAGE->set_course($oublogcourse);
+            $PAGE->set_cm($cm, $oublogcourse);
+            $PAGE->set_pagelayout('incourse');
+            return;
+
+        case OUBLOG_VISIBILITY_LOGGEDINUSER:
+            require_login(SITEID, false);
+            if ($oublog->course == $COURSE->id or empty($oublog->course)) {
+                $oublogcourse = $COURSE;
+            } else {
+                $oublogcourse = $DB->get_record('course', array('id'=>$oublog->course),
+                        '*', MUST_EXIST);
+            }
+            $PAGE->set_course($oublogcourse);
+            $PAGE->set_cm($cm, $oublogcourse);
+            $PAGE->set_pagelayout('incourse');
+            // Check oublog:view cap
+            if (!has_capability($capability, $context)) {
+                print_error('accessdenied', 'oublog');
+            }
+            return;
+
+        case OUBLOG_VISIBILITY_COURSEUSER:
+            require_course_login($oublog->course, false, $cm);
+            // Check oublog:view cap
+            if (!has_capability($capability, $context)) {
+                print_error('accessdenied', 'oublog');
+            }
+            return;
+
+        default:
+            print_error('invalidvisibility', 'oublog');
+    }
+}
+
+/**
+ * Checks if user can post to the blog depending on time limits
+ * @param object $oublog
+ * @param context $context
+ * @return bool True if can post
+ */
+function oublog_can_post_now($oublog, $context) {
+    if (($oublog->postfrom == 0 || $oublog->postfrom <= time()) &&
+            ($oublog->postuntil == 0 || $oublog->postuntil > time())) {
+        // Within time limits.
+        return true;
+    }
+    if ($oublog->global && $context->contextlevel != CONTEXT_SYSTEM) {
+        // Global blog override and check at system context.
+        $context = context_system::instance();
+    }
+    return has_capability('mod/oublog:ignorepostperiod', $context);
+}
+
+/**
+ * Determines whether the user can make a post to the given blog.
+ * @param $oublog Blog object
+ * @param $bloguserid Userid of person who owns blog (only needed for
+ *   personal blog)
+ * @param $cm Course-module (only needed if not personal blog)
+ * @return bool True if user is allowed to make posts
+ */
+function oublog_can_post($oublog, $bloguserid=0, $cm=null) {
+    global $USER;
+    if ($oublog->global) {
+        if ($bloguserid==0) {
+            debugging('Calls to oublog_can_post for personal blogs must supply userid!', DEBUG_DEVELOPER);
+        }
+        // This needs to be your blog and you need the 'contributepersonal'
+        // permission at system level
+        return $bloguserid==$USER->id &&
+            has_capability('mod/oublog:contributepersonal',
+                context_system::instance());
+    } else {
+        // Need specific post permission in this blog
+        return has_capability('mod/oublog:post',
+            context_module::instance($cm->id));
+    }
+}
+
+/**
+ * Determines whether the user can comment on the given blog post, presuming
+ * that they are allowed to see it.
+ * @param $cm Course-module (null if personal blog)
+ * @param $oublog Blog object
+ * @param $post Post object
+ * @param bool $ignoretime True to ignore any comment time limits
+ * @return bool True if user is allowed to make comments
+ */
+function oublog_can_comment($cm, $oublog, $post, $ignoretime = false) {
+    global $USER;
+
+    if ($oublog->global) {
+        // Just need the 'contributepersonal' permission at system level, OR
+        // if you are not logged in but the blog allows public comments.
+        // Note that if you ARE logged in you must have the capability. This is
+        // because logged-in comments do not go through moderation, so we want
+        // to be able to prevent them by removing the capability. They will
+        // still be able to make comments by logging out, but these will then
+        // go through moderation.
+        $blogok =
+                (!isloggedin() && $oublog->allowcomments == OUBLOG_COMMENTS_ALLOWPUBLIC) ||
+                has_capability('mod/oublog:contributepersonal',
+                    context_system::instance());
+    } else {
+        $modcontext = context_module::instance($cm->id);
+
+        // Three ways you can comment to a course blog:
+        $blogok =
+                // 1. Blog allows public comments and you're not logged in.
+                $oublog->allowcomments == (OUBLOG_COMMENTS_ALLOWPUBLIC && !isloggedin()) ||
+
+                // 2. Post is visible to all logged-in users+, and you have the
+                // comment capabilty in context.
+                ($post->visibility >= OUBLOG_VISIBILITY_LOGGEDINUSER
+                    && $oublog->maxvisibility >= OUBLOG_VISIBILITY_LOGGEDINUSER
+                    && has_capability('mod/oublog:comment',
+                        $modcontext)) ||
+
+                // 3. You have comment permission in the specific context
+                // (= course member) and you are allowed to write to the blog
+                // group i.e. it's your group.
+                (has_capability('mod/oublog:comment', $modcontext) &&
+                    oublog_is_writable_group($cm));
+
+        // Note this logic is still a bit weird with regard to groups. If
+        // there is a course blog with visible groups, users in other groups
+        // can't comment; there is a CONTRIB bug request for us to make an
+        // option for this. In that same situation, if a post is set to be
+        // visible to logged-in users, now people not in groups can suddenly
+        // comment. Hmmm. We might need another level of ->allowcomments to
+        // make this make sense, or some other changes.
+    }
+
+    // Test comment time period.
+    $timeok = (($oublog->commentfrom == 0 || $oublog->commentfrom <= time()) &&
+            ($oublog->commentuntil == 0 || $oublog->commentuntil > time()));
+    if ($ignoretime) {
+        $timeok = true;
+    }
+    if (!$timeok && has_capability('mod/oublog:ignorecommentperiod',
+            $oublog->global ? context_system::instance() : context_module::instance($cm->id))) {
+                $timeok = true;
+    }
+
+    // If the blog allows comments, this post must allow comments and either
+    // it allows public comments or you're logged in (and not guest)
+    return $blogok && $post->allowcomments &&
+            ($post->allowcomments >= OUBLOG_COMMENTS_ALLOWPUBLIC ||
+                (isloggedin() && !isguestuser())) && $timeok;
+}
+
+/**
+ * Wrapper around groups_get_activity_group.
+ * @param object $cm Moodle course-module (possibly with extra cache fields)
+ * @param boolean $update True to update from URL (must be first call on page)
+ */
+function oublog_get_activity_group($cm, $update=false) {
+    return groups_get_activity_group($cm, $update);
+}
+
+/**
+ * Wrapper around groups_get_activity_groupmode.
+ * @param object $cm Moodle course-module (possibly with extra cache fields)
+ * @param object $course Optional course parameter; should be included in
+ *   first call in page
+ */
+function oublog_get_activity_groupmode($cm, $course=null) {
+    return groups_get_activity_groupmode($cm, $course);
+}
+
+/**
+ * Checks whether a group is writable GIVEN THAT YOU CAN SEE THE BLOG
+ * (i.e. this does not handle the separate-groups case, only visible-groups).
+ * The information is static-cached so this function can be called multiple
+ * times.
+ * @param object $cm Moodle course-module
+ */
+function oublog_is_writable_group($cm) {
+    static $writablecm;
+    if (!isset($writablecm)) {
+        $writablecm = array();
+    }
+    if (!isset($writablecm[$cm->id])) {
+        $writablecm[$cm->id] = array();
+    }
+    $groupmode = oublog_get_activity_groupmode($cm, $cm->course);
+    if ($groupmode != VISIBLEGROUPS) {
+        // If no groups, then they must be allowed to access this;
+        // if separate groups, then because this is defined to only work
+        // for entries you can see, you must be allowed to access; so only
+        // doubt is for visible groups.
+        return true;
+    }
+    $groupid = oublog_get_activity_group($cm);
+    if (isset($writablecm[$cm->id][$groupid])) {
+        return $writablecm[$cm->id][$groupid];
+    }
+    $writablecm[$cm->id][$groupid] = groups_is_member($groupid) ||
+        has_capability('moodle/site:accessallgroups',
+            context_module::instance($cm->id));
+    return $writablecm[$cm->id][$groupid];
+}
+
+/**
+ * Determine if a user can view a post. Note that you must also call
+ * oublog_check_view_permissions for the blog as a whole.
+ *
+ * @param object $post
+ * @param object $user
+ * @param object $context
+ * @param bool $personalblog True if this is on a personal blog
+ * @return bool
+ */
+function oublog_can_view_post($post, $user, $context, $personalblog) {
+    if (empty($post->userid)) {
+        // Not sent userid from pluginfile etc so get it.
+        global $DB;
+        if ($instance = $DB->get_record('oublog_instances',
+                array('id' => $post->oubloginstancesid), 'userid')) {
+            $post->userid = $instance->userid;
+        }
+    }
+    // If you dont have capabilities and its not yours, you cant see it.
+    if ($post->deletedby && !has_capability('mod/oublog:manageposts', $context, $user->id) &&
+                ($post->userid !== $user->id)) {
+        return false;
+    }
+    // Public visibility means everyone
+    if ($post->visibility == OUBLOG_VISIBILITY_PUBLIC) {
+        return true;
+    }
+    // Logged-in user visibility means everyone logged in, but no guests
+    if ($post->visibility==OUBLOG_VISIBILITY_LOGGEDINUSER &&
+        (isloggedin() && !isguestuser())) {
+        return true;
+    } else if ($post->visibility==OUBLOG_VISIBILITY_LOGGEDINUSER) {
+        return false;
+    }
+
+    if ($post->visibility!=OUBLOG_VISIBILITY_COURSEUSER) {
+        print_error('invalidvisibilitylevel', 'oublog', '', $post->visibility);
+    }
+
+    // Otherwise this is set to course visibility
+    if ($personalblog) {
+        // Private posts - only same user or has capability viewprivate can see.
+        if (has_capability('mod/oublog:viewprivate', context_system::instance(), $user->id)) {
+            return true;
+        }
+        return $post->userid == $user->id;
+    } else {
+        // Check oublog:view capability at module level
+        // This might not have been checked yet because if the blog is
+        // set to public, you're allowed to view it, but maybe not this
+        // post.
+        return has_capability('mod/oublog:view', $context, $user->id);
+    }
+}
+
+
+
+/**
+ * Add a new blog post
+ *
+ * @param mixed $post An object containing all required post fields
+ * @param object $cm Course-module for blog
+ * @return mixed PostID on success or false
+ */
+function oublog_add_post($post, $cm, $oublog, $course) {
+    global $DB, $CFG;
+    require_once($CFG->libdir . '/completionlib.php');
+    $post->itemid = $post->message['itemid'];
+    $post->message = $post->message['text'];
+    $modcontext = context_module::instance($cm->id);
+
+    if (!isset($post->oubloginstancesid)) {
+        if (!$post->oubloginstancesid = $DB->get_field('oublog_instances', 'id', array('oublogid'=>$post->oublogid, 'userid'=>$post->userid))) {
+            if (!$post->oubloginstancesid = oublog_add_bloginstance($post->oublogid, $post->userid)) {
+                return(false);
+            }
+        }
+    }
+    if (!isset($post->timeposted)) {
+        $post->timeposted = time();
+    }
+
+    // Begin transaction
+    $tw = $DB->start_delegated_transaction();
+
+    if (!$postid = $DB->insert_record('oublog_posts', $post)) {
+        return(false);
+    }
+    // Now do filestuff.
+    if ($post->attachments) {
+        file_save_draft_area_files($post->attachments, $modcontext->id, 'mod_oublog', 'attachment', $postid, array('subdirs' => 0));
+    }
+
+    $post->message = file_save_draft_area_files($post->itemid, $modcontext->id, 'mod_oublog', 'message', $postid, array('subdirs'=>0), $post->message);
+    $DB->set_field('oublog_posts', 'message', $post->message, array('id'=>$postid));
+    if (isset($post->tags)) {
+        oublog_update_item_tags($post->oubloginstancesid, $postid, $post->tags, $post->visibility);
+    }
+
+    $post->id=$postid; // Needed by the below
+    if (!oublog_search_update($post, $cm)) {
+        return(false);
+    }
+
+    // Inform completion system, if available
+    $completion = new completion_info($course);
+    if ($completion->is_enabled($cm) && ($oublog->completionposts)) {
+        $completion->update_state($cm, COMPLETION_COMPLETE);
+    }
+
+    $tw->allow_commit();
+
+    return($postid);
+}
+
+
+
+/**
+ * Update a blog post
+ *
+ * @param mixed $post An object containing all required post fields
+ * @param object $cm Course-module for blog
+ * @return bool
+ */
+function oublog_edit_post($post, $cm) {
+    global $USER, $DB;
+    $post->itemid = $post->message['itemid'];
+    $post->message = $post->message['text'];
+    $modcontext = context_module::instance($cm->id);
+    if (!isset($post->id) || !$oldpost = $DB->get_record('oublog_posts', array('id'=>$post->id))) {
+        return(false);
+    }
+
+    if (!$post->oubloginstancesid = $DB->get_field('oublog_instances', 'id', array('oublogid'=>$post->oublogid, 'userid'=>$post->userid))) {
+        return(false);
+    }
+
+    // Begin transaction
+    $tw = $DB->start_delegated_transaction();
+
+    // insert edit history
+    $edit = new stdClass();
+    $edit->postid       = $post->id;
+    $edit->userid       = $USER->id;
+    $edit->timeupdated  = time();
+    $edit->oldtitle     = $oldpost->title;
+    $edit->oldmessage   = $oldpost->message;
+
+    if (!$editid = $DB->insert_record('oublog_edits', $edit)) {
+        return(false);
+    }
+    // Get list of files attached to this post and attach them to the edit.
+    $fs = get_file_storage();
+    if ($files = $fs->get_area_files($modcontext->id, 'mod_oublog', 'attachment', $post->id, "timemodified", false)) {
+        foreach ($files as $file) {
+            // Add this file to the edit record.
+            $fs->create_file_from_storedfile(array(
+                'filearea' => 'edit',
+                'itemid' => $editid), $file);
+        }
+    }
+    // Save new files.
+    $post->message = file_save_draft_area_files($post->itemid, $modcontext->id, 'mod_oublog', 'message', $post->id, array('subdirs'=>0), $post->message);
+    file_save_draft_area_files($post->attachments, $modcontext->id, 'mod_oublog', 'attachment', $post->id, array('subdirs' => 0));
+
+    // Update tags
+    if (!oublog_update_item_tags($post->oubloginstancesid, $post->id, $post->tags, $post->visibility)) {
+        return(false);
+    }
+
+    // Update the post
+    $post->timeupdated = $edit->timeupdated;
+    $post->lasteditedby = $USER->id;
+
+    if (isset($post->groupid)) {
+        unset($post->groupid); // Can't change group
+    }
+
+    if (!$DB->update_record('oublog_posts', $post)) {
+        return(false);
+    }
+
+    if (!oublog_search_update($post, $cm)) {
+        return(false);
+    }
+
+    $tw->allow_commit();
+
+    return(true);
+}
+
+
+
+/**
+ * Get all data required to print a list of blog posts as efficiently as possible
+ *
+ *
+ * @param object $oublog
+ * @param int $offset
+ * @param int $userid
+ * @param bool $ignoreprivate set true to not return private posts (global blog only)
+ * @return mixed all data to print a list of blog posts
+ */
+function oublog_get_posts($oublog, $context, $offset = 0, $cm, $groupid, $individualid = -1,
+        $userid = null, $tag = '', $canaudit = false, $ignoreprivate = null) {
+    global $CFG, $USER, $DB;
+    $params = array();
+    $sqlwhere = "bi.oublogid = ?";
+    $params[] = $oublog->id;
+    $sqljoin = '';
+
+    if (isset($userid)) {
+        $sqlwhere .= " AND bi.userid = ? ";
+        $params[] = $userid;
+    }
+
+    // Individual blog.
+    if ($individualid > -1) {
+        $capable = oublog_individual_has_permissions($cm, $oublog, $groupid, $individualid);
+        oublog_individual_add_to_sqlwhere($sqlwhere, $params, 'bi.userid', $oublog->id, $groupid, $individualid, $capable);
+    } else {// No individual blog.
+        if (isset($groupid) && $groupid) {
+            $sqlwhere .= " AND p.groupid =  ? ";
+            $params[] = $groupid;
+        }
+    }
+    if (!$canaudit) {
+        $sqlwhere .= " AND (p.deletedby IS NULL or bi.userid = ?)";
+        $params[] = $USER->id;
+    }
+    if ($tag) {
+        $sqlwhere .= " AND t.tag = ? ";
+        $params[] = $tag;
+        $sqljoin  .= " INNER JOIN {oublog_taginstances} ti ON p.id = ti.postid
+                       INNER JOIN {oublog_tags} t ON ti.tagid = t.id ";
+    }
+
+    // Visibility checks.
+    if (!isloggedin() || isguestuser()) {
+        $sqlwhere .= " AND p.visibility =" . OUBLOG_VISIBILITY_PUBLIC;
+    } else {
+        if ($oublog->global) {
+            // Unless the current user has manageposts capability,
+            // they cannot view 'private' posts except their own.
+            if ($ignoreprivate) {
+                $sqlwhere .= ' AND (p.visibility > ' . OUBLOG_VISIBILITY_COURSEUSER . ')';
+            } else if (!has_capability('mod/oublog:manageposts', context_system::instance())) {
+                $sqlwhere .= " AND (p.visibility >" . OUBLOG_VISIBILITY_COURSEUSER .
+                        " OR (p.visibility = " . OUBLOG_VISIBILITY_COURSEUSER . " AND u.id = ?))";
+                $params[] = $USER->id;
+            }
+        } else {
+            $context = context_module::instance($cm->id);
+            if (has_capability('mod/oublog:view', $context)) {
+                $sqlwhere .= " AND (p.visibility >= " . OUBLOG_VISIBILITY_COURSEUSER . " )";
+            } else {
+                $sqlwhere .= " AND p.visibility > " . OUBLOG_VISIBILITY_COURSEUSER;
+            }
+        }
+    }
+    $usernamefields = get_all_user_name_fields(true, 'u');
+    $delusernamefields = get_all_user_name_fields(true, 'ud', null, 'del');
+    $editusernamefields = get_all_user_name_fields(true, 'ue', null, 'ed');
+
+    // Get posts. The post has the field timeposted not timecreated,
+    // which is tested in rating::user_can_rate().
+    $fieldlist = "p.*, p.timeposted AS timecreated,  bi.oublogid, $usernamefields,
+                  bi.userid, u.idnumber, u.picture, u.imagealt, u.email, u.username,
+                $delusernamefields,
+                $editusernamefields";
+    $from = "FROM {oublog_posts} p
+                INNER JOIN {oublog_instances} bi ON p.oubloginstancesid = bi.id
+                INNER JOIN {user} u ON bi.userid = u.id
+                LEFT JOIN {user} ud ON p.deletedby = ud.id
+                LEFT JOIN {user} ue ON p.lasteditedby = ue.id
+                $sqljoin";
+    $sql = "SELECT $fieldlist
+            $from
+            WHERE  $sqlwhere
+            ORDER BY p.timeposted DESC
+            ";
+    $countsql = "SELECT count(p.id) $from WHERE $sqlwhere";
+
+    $rs = $DB->get_recordset_sql($sql, $params, $offset, OUBLOG_POSTS_PER_PAGE);
+    // Get paging info
+    $recordcnt = $DB->count_records_sql($countsql, $params);
+    if (!$rs->valid()) {
+        return array(false, $recordcnt);
+    }
+
+    $cnt        = 0;
+    $posts      = array();
+    $postids    = array();
+
+    foreach ($rs as $post) {
+        if ($cnt > OUBLOG_POSTS_PER_PAGE) {
+            break;
+        }
+        if (oublog_can_view_post($post, $USER, $context, $oublog->global)) {
+            if ($oublog->maxvisibility < $post->visibility) {
+                $post->visibility = $oublog->maxvisibility;
+            }
+            if ($oublog->allowcomments == OUBLOG_COMMENTS_PREVENT) {
+                $post->allowcomments = OUBLOG_COMMENTS_PREVENT;
+            }
+
+            $posts[$post->id] = $post;
+            $postids[] = (int)$post->id;
+            $cnt++;
+        }
+    }
+    $rs->close();
+
+    if (empty($posts)) {
+        return array(true, $recordcnt);
+    }
+
+    // Get tags for all posts on page
+    $sql = "SELECT t.*, ti.postid
+            FROM {oublog_taginstances} ti
+            INNER JOIN {oublog_tags} t ON ti.tagid = t.id
+            WHERE ti.postid IN (".implode(",", $postids).") ";
+
+    $rs = $DB->get_recordset_sql($sql);
+    foreach ($rs as $tag) {
+        $posts[$tag->postid]->tags[$tag->id] = $tag->tag;
+    }
+
+    // Load ratings.
+    require_once($CFG->dirroot.'/rating/lib.php');
+    if ($oublog->assessed != RATING_AGGREGATE_NONE) {
+        $ratingoptions = new stdClass();
+        $ratingoptions->context = $context;
+        $ratingoptions->component = 'mod_oublog';
+        $ratingoptions->ratingarea = 'post';
+        $ratingoptions->items = $posts;
+        $ratingoptions->aggregate = $oublog->assessed;// The aggregation method.
+        $ratingoptions->scaleid = $oublog->scale;
+        $ratingoptions->userid = $USER->id;
+        $ratingoptions->assesstimestart = $oublog->assesstimestart;
+        $ratingoptions->assesstimefinish = $oublog->assesstimefinish;
+
+        $rm = new rating_manager();
+        $posts = $rm->get_ratings($ratingoptions);
+    }
+    $rs->close();
+
+    // Get comments for post on the page
+    $sql = "SELECT c.id, c.postid, c.timeposted, c.authorname, c.authorip, c.timeapproved, c.userid, $usernamefields, u.picture, u.imagealt, u.email, u.idnumber
+            FROM {oublog_comments} c
+            LEFT JOIN {user} u ON c.userid = u.id
+            WHERE c.postid IN (".implode(",", $postids).") AND c.deletedby IS NULL
+            ORDER BY c.timeposted ASC ";
+
+    $rs = $DB->get_recordset_sql($sql);
+    foreach ($rs as $comment) {
+        $posts[$comment->postid]->comments[$comment->id] = $comment;
+    }
+    $rs->close();
+    // Get count of comments waiting approval for posts on the page...
+    if ($oublog->allowcomments >= OUBLOG_COMMENTS_ALLOWPUBLIC) {
+        // Make list of all posts that allow public comments
+        $publicallowed = array();
+        foreach ($posts as $post) {
+            if ($post->allowcomments >= OUBLOG_COMMENTS_ALLOWPUBLIC) {
+                $publicallowed[] = (int)$post->id;
+            }
+        }
+        // Only run a db query if there are some posts that allow public
+        // comments (so, no performance degradation if feature is not used)
+        if (count($publicallowed) > 0) {
+            $sql = "SELECT cm.postid, COUNT(1) AS numpending
+                    FROM {oublog_comments_moderated} cm
+                    WHERE cm.postid IN (".implode(",", $publicallowed).")
+                    AND cm.approval = 0
+                    GROUP BY cm.postid";
+            $rs = $DB->get_recordset_sql($sql);
+            foreach ($rs as $postinfo) {
+                $posts[$postinfo->postid]->pendingcomments = $postinfo->numpending;
+            }
+            $rs->close();
+        }
+    }
+
+    return(array($posts, $recordcnt));
+}
+
+
+
+
+/**
+ * Get all data required to print a single blog post as efficiently as possible
+ *
+ *
+ * @param int $postid
+ * @return mixed all data to print a list of blog posts
+ */
+function oublog_get_post($postid, $canaudit=false) {
+    global $DB;
+    $usernamefields = get_all_user_name_fields(true, 'u');
+    $delusernamefields = get_all_user_name_fields(true, 'ud', null, 'del');
+    $editusernamefields = get_all_user_name_fields(true, 'ue', null, 'ed');
+
+    // Get post
+    $sql = "SELECT p.*, bi.oublogid, $usernamefields, u.picture, u.imagealt, bi.userid, u.idnumber, u.email, u.username, u.mailformat,
+                    $delusernamefields,
+                    $editusernamefields
+            FROM {oublog_posts} p
+                INNER JOIN {oublog_instances} bi ON p.oubloginstancesid = bi.id
+                INNER JOIN {user} u ON bi.userid = u.id
+                LEFT JOIN {user} ud ON p.deletedby = ud.id
+                LEFT JOIN {user} ue ON p.lasteditedby = ue.id
+            WHERE p.id = ?
+            ORDER BY p.timeposted DESC
+            ";
+
+    if (!$post = $DB->get_record_sql($sql, array($postid))) {
+        return(false);
+    }
+
+    // Get tags for all posts on page
+    $sql = "SELECT t.*, ti.postid
+            FROM {oublog_taginstances} ti
+            INNER JOIN {oublog_tags} t ON ti.tagid = t.id
+            WHERE ti.postid = ? ";
+
+    $rs = $DB->get_recordset_sql($sql, array($postid));
+    foreach ($rs as $tag) {
+        $post->tags[$tag->id] = $tag->tag;
+    }
+    $rs->close();
+
+    // Get comments for post on the page
+    if ($post->allowcomments) {
+        $sql = "SELECT c.*, $usernamefields, u.picture, u.imagealt, u.email, u.idnumber,
+                    $delusernamefields
+                FROM {oublog_comments} c
+                LEFT JOIN {user} u ON c.userid = u.id
+                LEFT JOIN {user} ud ON c.deletedby = ud.id
+                WHERE c.postid = ? ";
+
+        if (!$canaudit) {
+            $sql .= "AND c.deletedby IS NULL ";
+        }
+
+        $sql .= "ORDER BY c.timeposted ASC ";
+
+        $rs = $DB->get_recordset_sql($sql, array($postid));
+        foreach ($rs as $comment) {
+            $post->comments[$comment->id] = $comment;
+        }
+        $rs->close();
+    }
+
+    // Get edits for this post
+    $sql = "SELECT e.id, e.timeupdated, e.oldtitle, e.userid, $usernamefields, u.picture, u.imagealt, u.email, u.idnumber
+            FROM {oublog_edits} e
+            INNER JOIN {user} u ON e.userid = u.id
+            WHERE e.postid = ?
+            ORDER BY e.timeupdated DESC ";
+
+    $rs = $DB->get_recordset_sql($sql, array($postid));
+    foreach ($rs as $edit) {
+        $post->edits[$edit->id] = $edit;
+    }
+    $rs->close();
+
+    return($post);
+}
+
+
+/**
+ * Add a blog_instance
+ *
+ * @param int $oublogid
+ * @param int $userid
+ * @param string $name
+ * @param string $summary
+ * @return mixed oubloginstancesid on success or false
+ */
+function oublog_add_bloginstance($oublogid, $userid, $name='', $summary=null) {
+    global $DB;
+    $oubloginstance = new stdClass;
+    $oubloginstance->oublogid      = $oublogid;
+    $oubloginstance->userid        = $userid;
+    $oubloginstance->name          = $name;
+    $oubloginstance->summary       = $summary;
+    $oubloginstance->accesstoken   = md5(uniqid(rand(), true));
+
+    return($DB->insert_record('oublog_instances', $oubloginstance));
+}
+
+/**
+ * Clarifies a $tags value which may be a string or an array of values,
+ * returning an array of strings.
+ * @param mixed $tags
+ * @return array Array of tag strings
+ */
+function oublog_clarify_tags($tags) {
+    if (is_string($tags)) {
+        if (!$tags = explode(',', $tags)) {
+            return array();
+        }
+    } else if (!is_array($tags)) {
+        return array();
+    }
+
+    foreach ($tags as $idx => $tag) {
+        $tag = core_text::strtolower(trim($tag));
+        if (empty($tag)) {
+            unset($tags[$idx]);
+            continue;
+        }
+
+        $tags[$idx] = $tag;
+    }
+
+    $tags = array_unique($tags);
+
+    return $tags;
+}
+
+/**
+ * Update a posts tags
+ *
+ * @param int $oubloginstanceid
+ * @param int $postid
+ * @param mixed $tags Comma separated string or an array
+ * @uses $CFG
+ */
+function oublog_update_item_tags($oubloginstancesid, $postid, $tags, $postvisibility=OUBLOG_VISIBILITY_COURSEUSER) {
+    global $CFG, $DB;
+
+    $tagssql = array();
+    $tagids = array();
+
+    // Removed any existing
+    $DB->delete_records('oublog_taginstances', array('postid'=>$postid));
+
+    $tags=oublog_clarify_tags($tags);
+
+    if (empty($tags)) {
+        return(true);
+    }
+
+    // get the id's of the know tags
+    list($tagsql, $tagparams) = $DB->get_in_or_equal($tags);
+    $sql = "SELECT tag, id FROM {oublog_tags} WHERE tag $tagsql";
+    $tagids = $DB->get_records_sql($sql, $tagparams);
+
+    // insert the remainder
+    foreach ($tags as $tag) {
+        if (!isset($tagids[$tag])) {
+            $tagobj = (object) array('tag' => $tag);
+            $tagobj->id = $DB->insert_record('oublog_tags', $tagobj);
+            $tagids[$tag] = $tagobj;
+        }
+        $taginstance = new stdClass();
+        $taginstance->tagid = $tagids[$tag]->id;
+        $taginstance->postid = $postid;
+        $taginstance->oubloginstancesid = $oubloginstancesid;
+
+        $DB->insert_record('oublog_taginstances', $taginstance);
+
+    }
+
+    return(true);
+}
+
+
+
+/**
+ * Get post tags in a CSV format
+ *
+ * @param int $postid
+ * @return string
+ * @uses $CFG;
+ */
+function oublog_get_tags_csv($postid) {
+    global $DB;
+
+    $sql = "SELECT t.tag
+            FROM {oublog_taginstances} ti
+            INNER JOIN {oublog_tags} t ON ti.tagid = t.id
+            WHERE ti.postid = ? ";
+
+    if ($tags = $DB->get_fieldset_sql($sql, array($postid))) {
+        return(implode(', ', $tags));
+    } else {
+        return('');
+    }
+}
+
+
+
+/**
+ * Get weighted tags for a given blog or blog instance
+ *
+ * @param int $oublogid
+ * @param int $oubloginstanceid
+ * @return array Tag data
+ */
+function oublog_get_tags($oublog, $groupid, $cm, $oubloginstanceid=null, $individualid=-1, $tagorder = 'alpha') {
+    global $CFG, $DB, $USER;
+    $tags = array();
+    $params = array();
+    $sqlwhere = "bi.oublogid = ? ";
+    $params[] = $oublog->id;
+
+    // If individual blog.
+    if ($individualid > -1) {
+        $capable = oublog_individual_has_permissions($cm, $oublog, $groupid, $individualid);
+        oublog_individual_add_to_sqlwhere($sqlwhere, $params, 'bi.userid', $oublog->id, $groupid,
+                $individualid, $capable);
+    } else {
+        // No individual blog.
+        if (isset($oubloginstanceid)) {
+            $sqlwhere .= "AND ti.oubloginstancesid = ? ";
+            $params[] = $oubloginstanceid;
+        }
+        if (isset($groupid) && $groupid) {
+            $sqlwhere .= " AND p.groupid = ? ";
+            $params[] = $groupid;
+        }
+        if (!empty($cm->groupingid)) {
+            if ($groups = $DB->get_records('groupings_groups',
+                    array('groupingid' => $cm->groupingid), null, 'groupid')) {
+                $sqlwhere .= " AND p.groupid IN (" . implode(',', array_keys($groups)) . ") ";
+            }
+        }
+    }
+    // Visibility check.
+    if (!isloggedin() || isguestuser()) {
+        $sqlwhere .= " AND p.visibility = " . OUBLOG_VISIBILITY_PUBLIC;
+    } else {
+        if ($oublog->global) {
+            $sqlwhere .= " AND (p.visibility > " . OUBLOG_VISIBILITY_COURSEUSER .
+                    " OR (p.visibility = " . OUBLOG_VISIBILITY_COURSEUSER . " AND u.id = ?))";
+            $params[] = $USER->id;
+        } else {
+            $context = context_module::instance($cm->id);
+            if (!has_capability('mod/oublog:view', $context, $USER->id)) {
+                $sqlwhere .= " AND (p.visibility > " . OUBLOG_VISIBILITY_COURSEUSER . ")";
+            }
+        }
+    }
+
+    $sql = "SELECT t.id, t.tag, COUNT(ti.id) AS count
+            FROM {oublog_instances} bi
+                INNER JOIN {oublog_taginstances} ti ON ti.oubloginstancesid = bi.id
+                INNER JOIN {oublog_tags} t ON ti.tagid = t.id
+                INNER JOIN {oublog_posts} p ON ti.postid = p.id
+                INNER JOIN {user} u ON u.id = bi.userid
+            WHERE $sqlwhere
+            GROUP BY t.id, t.tag
+            ORDER BY count DESC";
+
+    if ($tags = $DB->get_records_sql($sql, $params)) {
+        $first = array_shift($tags);
+        $max = $first->count;
+        array_unshift($tags, $first);
+
+        $last = array_pop($tags);
+        $min = $last->count;
+        array_push($tags, $last);
+
+        $delta = $max-$min+0.00000001;
+
+        foreach ($tags as $idx => $tag) {
+            $tags[$idx]->weight = round(($tag->count-$min)/$delta*4);
+        }
+        if ($tagorder == 'alpha') {
+            uasort($tags, function($a, $b) {
+                return strcmp ($a->tag,  $b->tag);
+            });
+        }
+    }
+    return($tags);
+}
+
+
+
+/**
+ * Print a tag cloud for a given blog or blog instance
+ *
+ * @param string $baseurl
+ * @param int $oublogid
+ * @param int $groupid
+ * @param object $cm
+ * @param int $oubloginstanceid
+ * @return string Tag cloud HTML
+ */
+function oublog_get_tag_cloud($baseurl, $oublog, $groupid, $cm, $oubloginstanceid=null, $individualid=-1, $tagorder) {
+    $cloud = '';
+    $urlparts= array();
+
+    $baseurl = oublog_replace_url_param($baseurl, 'tag');
+    if (!$tags = oublog_get_tags($oublog, $groupid, $cm, $oubloginstanceid, $individualid, $tagorder)) {
+        return($cloud);
+    }
+
+    $cloud .= html_writer::start_tag('div', array('class' => 'oublog-tag-items'));
+    foreach ($tags as $tag) {
+        $cloud .= '<a href="'.$baseurl.'&amp;tag='.urlencode($tag->tag).'" class="oublog-tag-cloud-'.
+            $tag->weight.'"><span class="oublog-tagname">'.strtr(($tag->tag), array(' '=>'&nbsp;')).
+            '</span><span class="oublog-tagcount">('.$tag->count.')</span></a> ';
+    }
+    $cloud .= html_writer::end_tag('div');
+
+    return($cloud);
+}
+
+/**
+ * Gets tags available to choose from
+ * @param object $oublog
+ * @param int $groupid
+ * @param object $cm
+ * @param int $oubloginstanceid
+ * @param int $individualid
+ * @return array of tag objects
+ */
+function oublog_get_tag_list($oublog, $groupid, $cm, $oubloginstanceid = null, $individualid=-1) {
+    global $DB;
+
+    $tags = oublog_get_tags($oublog, $groupid, $cm, $oubloginstanceid, $individualid, 'alpha');
+
+    $blogtags = oublog_clarify_tags($oublog->tagslist);
+
+    // For each tag added to the blog check if it is already in use
+    // in the post, if it is then the 'Official' label is added to it.
+    $existingtagnames = array();
+    foreach ($tags as $idx => $tag) {
+        if (in_array($tags[$idx]->tag, $blogtags)) {
+            $tag->label = get_string('official', 'oublog');
+            // Flat array of existing in use 'Set' tags.
+            $existingtagnames[] = $tags[$idx]->tag;
+        } else if ($oublog->restricttags == 1 || $oublog->restricttags == 3) {
+            // If we are restricting, remove this non-offical tag.
+            unset($tags[$idx]);
+        }
+    }
+    // For each 'Official' tag added, if it is NOT already in use,
+    // then add it to the list of tags.
+    foreach ($blogtags as $blogtag) {
+        if (!in_array($blogtag, $existingtagnames)) {
+            $tagobject = (object) array('tag' => $blogtag);
+            $tagobject->label = get_string('official', 'oublog');
+            $tagobject->count = 0;
+            $tags[] = $tagobject;
+        }
+    }
+
+    return $tags;
+}
+
+/**
+ * Translate a visibility number into a language string
+ *
+ * @param int $vislevel
+ * @param bool $personal True if this is a personal blog
+ * @return string
+ */
+function oublog_get_visibility_string($vislevel, $personal) {
+
+    // Modify visibility string for optional shared activity blog
+    global $CFG, $COURSE;
+    $visibleusers = 'visiblecourseusers';
+    $sharedactvfile = $CFG->dirroot.'/course/format/sharedactv/sharedactv.php';
+    if (file_exists($sharedactvfile)) {
+        include_once($sharedactvfile);
+        if (function_exists('sharedactv_is_magic_course') && sharedactv_is_magic_course($COURSE)) {
+            $visibleusers = 'visibleblogusers';
+        }
+    }
+
+    switch ($vislevel) {
+        case OUBLOG_VISIBILITY_COURSEUSER:
+            return get_string($personal ? 'visibleyou' : $visibleusers, 'oublog');
+        case OUBLOG_VISIBILITY_LOGGEDINUSER:
+            return(get_string('visibleloggedinusers', 'oublog'));
+        case OUBLOG_VISIBILITY_PUBLIC:
+            return(get_string('visiblepublic', 'oublog'));
+        default:
+            print_error('invalidvisibility', 'oublog');
+    }
+}
+
+
+/**
+ * Add a blog comment
+ *
+ * @param object $comment
+ * @return mixed commentid on success or false
+ */
+function oublog_add_comment($course, $cm, $oublog, $comment) {
+    global $DB, $CFG;
+    require_once($CFG->libdir . '/completionlib.php');
+    if (!isset($comment->timeposted)) {
+        $comment->timeposted = time();
+    }
+    // Begin transaction.
+    $tw = $DB->start_delegated_transaction();
+    // Prepare comment id for draft area.
+    $comment->message = '';
+    $id = $DB->insert_record('oublog_comments', $comment);
+    // Save out any images from the comment message text.
+    $context = context_module::instance($cm->id);
+    $draftid = file_get_submitted_draft_itemid('messagecomment');
+    $comment->message = file_save_draft_area_files($draftid, $context->id, 'mod_oublog',
+            'messagecomment', $id, array('subdirs' => true), $comment->messagecomment['text']);
+    $comment->id = $id;
+    // Save the comment.
+    $DB->set_field('oublog_comments', 'message', $comment->message, array('id' => $id));
+    if ($id) {
+        // Inform completion system, if available.
+        $completion = new completion_info($course);
+        if ($completion->is_enabled($cm) && ($oublog->completioncomments)) {
+            $completion->update_state($cm, COMPLETION_COMPLETE);
+        }
+    }
+    // Commit transaction and return id.
+    $tw->allow_commit();
+    return $id;
+}
+
+
+
+/**
+ * Update the hit count for a blog and return the current hits
+ *
+ * @param object $oublog
+ * @param object $oubloginstance
+ * @return int
+ */
+function oublog_update_views($oublog, $oubloginstance) {
+    global $SESSION, $DB;
+
+    if ($oublog->global && isset($oubloginstance)) {
+        if (!isset($SESSION->bloginstanceview[$oubloginstance->id])) {
+            $SESSION->bloginstanceview[$oubloginstance->id] = true;
+            $oubloginstance->views++;
+            $sql = "UPDATE {oublog_instances} SET views = views + 1 WHERE id = ?";
+            $DB->execute($sql, array($oubloginstance->id));
+        }
+        return($oubloginstance->views);
+    } else {
+        if (!isset($SESSION->blogview[$oublog->id])) {
+            $SESSION->blogview[$oublog->id] = true;
+            $oublog->views++;
+            $sql = "UPDATE {oublog} SET views = views + 1 WHERE id = ?";
+            $DB->execute($sql, array($oublog->id));
+        }
+        return($oublog->views);
+    }
+
+}
+
+/**
+ * Checks for a permission which you have EITHER if you have the specific
+ * permission OR if it's your own personal blog and you have post permission to
+ * that blog.
+ *
+ * @param string $capability
+ * @param object $oublog
+ * @param object $oubloginstance (required for personal blog access)
+ * @param object $context
+ * @return bool True if you have permission
+ */
+function oublog_has_userblog_permission($capability, $oublog, $oubloginstance, $context) {
+    // For personal blogs you can do these things EITHER if you have the capability
+    // (ie for admins) OR if you are that user and you are allowed to post
+    // to blog (not banned)
+    global $USER;
+    if ($oublog->global && $oubloginstance && $USER->id == $oubloginstance->userid &&
+        has_capability('mod/oublog:contributepersonal', $context)) {
+        return true;
+    }
+    // Otherwise require the capability (note this also allows eg admin access
+    // to personal blogs)
+    return has_capability($capability, $context);
+}
+
+function oublog_require_userblog_permission($capability, $oublog, $oubloginstance, $context) {
+    if (!oublog_has_userblog_permission($capability, $oublog, $oubloginstance, $context)) {
+        require_capability($capability, $context);
+    }
+}
+
+/**
+ * Get the list of relevant links in HTML format
+ *
+ * @param object $oublog
+ * @param object $oubloginstance
+ * @param object $context
+ * @return string HTML on success, false on failure
+ */
+function oublog_get_links($oublog, $oubloginstance, $context) {
+    global $CFG, $DB, $OUTPUT;
+
+    $strmoveup      = get_string('moveup');
+    $strmovedown    = get_string('movedown');
+    $stredit        = get_string('edit');
+    $strdelete      = get_string('delete');
+
+    $canmanagelinks = oublog_has_userblog_permission('mod/oublog:managelinks', $oublog, $oubloginstance, $context);
+
+    if ($oublog->global) {
+        $links = $DB->get_records('oublog_links', array('oubloginstancesid'=>$oubloginstance->id), 'sortorder');
+    } else {
+        $links = $DB->get_records('oublog_links', array('oublogid'=>$oublog->id), 'sortorder');
+    }
+    $html = '';
+
+    if ($links) {
+
+        $html .= '<ul class="unlist">';
+        $numlinks = count($links);
+        $i=0;
+        foreach ($links as $link) {
+            $i++;
+            $html .= '<li>';
+            $html .= '<a href="'.htmlentities($link->url).'" class="oublog-elink">'.format_string($link->title).'</a> ';
+
+            if ($canmanagelinks) {
+                if ($i > 1) {
+                    $html .= '<form action="movelink.php" method="post" style="display:inline" title="'.$strmoveup.'">';
+                    $html .= '<div>';
+                    $html .= '<input type="image" src="'.$OUTPUT->pix_url('t/up').'" alt="'.$strmoveup.'" />';
+                    $html .= '<input type="hidden" name="down" value="0" />';
+                    $html .= '<input type="hidden" name="link" value="'.$link->id.'" />';
+                    $html .= '<input type="hidden" name="returnurl" value="'.$_SERVER['REQUEST_URI'].'" />';
+                    $html .= '<input type="hidden" name="sesskey" value="'.sesskey().'" />';
+                    $html .= '</div>';
+                    $html .= '</form>';
+                }
+                if ($i < $numlinks) {
+                    $html .= '<form action="movelink.php" method="post" style="display:inline" title="'.$strmovedown.'">';
+                    $html .= '<div>';
+                    $html .= '<input type="image" src="'.$OUTPUT->pix_url('t/down').'" alt="'.$strmovedown.'" />';
+                    $html .= '<input type="hidden" name="down" value="1" />';
+                    $html .= '<input type="hidden" name="link" value="'.$link->id.'" />';
+                    $html .= '<input type="hidden" name="returnurl" value="'.$_SERVER['REQUEST_URI'].'" />';
+                    $html .= '<input type="hidden" name="sesskey" value="'.sesskey().'" />';
+                    $html .= '</div>';
+                    $html .= '</form>';
+                }
+                $html .= '<a href="editlink.php?blog='.$oublog->id.'&amp;link='.$link->id.'" title="'.
+                    $stredit.'"><img src="'.$OUTPUT->pix_url('t/edit').'" alt="'.$stredit.
+                    '" class="iconsmall" /></a>';
+                $html .= '<a href="deletelink.php?blog='.$oublog->id.'&amp;link='.$link->id.'" title="'.
+                    $strdelete.'"><img src="'.$OUTPUT->pix_url('t/delete').'" alt="'.$strdelete.
+                    '" class="iconsmall" /></a>';
+            }
+            $html .= '</li>';
+        }
+        $html .= '</ul>';
+    }
+
+    if ($canmanagelinks) {
+        if ($oublog->global) {
+            $html .= '<a href="editlink.php?blog='.$oublog->id.'&amp;bloginstance='.$oubloginstance->id.'" class="oublog-links">'.get_string('addlink', 'oublog').'</a>';
+        } else {
+            $html .= '<a href="editlink.php?blog='.$oublog->id.'"  class="oublog-links">'.get_string('addlink', 'oublog').'</a>';
+        }
+    }
+
+    return($html);
+
+}
+
+
+
+/**
+ * Insert a link into the DB
+ *
+ * @param object $link
+ * @return bool true on success, false on faulure
+ */
+function oublog_add_link($link) {
+    global $DB;
+
+    // $link->oubloginstancesid is only set for personal blogs
+    if (isset($link->oubloginstanceid)) {
+        $sql = "SELECT MAX(sortorder) AS sortorder FROM {oublog_links} WHERE oubloginstancesid = ? ";
+        $sortorder = $DB->get_field_sql($sql, array($link->oubloginstancesid));
+        $sortorder++;
+    } else {
+        $sql = "SELECT MAX(sortorder) AS sortorder FROM {oublog_links} WHERE oublogid = ?";
+        $sortorder = $DB->get_field_sql($sql, array($link->oublogid));
+        $sortorder++;
+    }
+
+    $link->sortorder = $sortorder;
+    if (!$DB->insert_record('oublog_links', $link)) {
+        return(false);
+    }
+
+    return(true);
+}
+
+
+
+/**
+ * Update a link in the DB
+ *
+ * @param object $link
+ * @return bool true on success, false on faulure
+ */
+function oublog_edit_link($link) {
+    global $DB;
+    unset($link->sortorder);
+
+    return($DB->update_record('oublog_links', $link));
+}
+
+
+
+/**
+ * Delete a link from the DB
+ *
+ * @param object $oublog
+ * @param object $link
+ * @return bool true on success, false on faulure
+ */
+function oublog_delete_link($oublog, $link) {
+    global $DB;
+    $params = array();
+    if ($oublog->global) {
+        $where = "oubloginstancesid = ? ";
+        $params[] = $link->oubloginstancesid;
+    } else {
+        $where = "oublogid = ? ";
+        $params[] = $link->oublogid;
+    }
+
+    if (!$DB->delete_records('oublog_links', array('id'=>$link->id))) {
+        return(false);
+    }
+
+    $sql = "UPDATE {oublog_links}
+            SET sortorder = sortorder - 1
+            WHERE $where AND sortorder > ?";
+    $params[] = $link->sortorder;
+    return($DB->execute($sql, $params));
+}
+
+
+
+/**
+ * Return a timestamp of when a blog, or comment was last updated
+ *
+ * @param int $blogid
+ * @param int $bloginstancesid
+ * @param int $postid
+ * @param bool $comments
+ * @return int last modified timestamp
+ */
+function oublog_feed_last_changed($blogid, $bloginstancesid, $postid, $comments) {
+    global $DB;
+    $params = array();
+
+    // Comments or posts?
+    if ($comments) {
+        $sql = "SELECT MAX(c.timeposted) AS timeposted
+                FROM {oublog_comments} c ";
+        if ($postid) {
+            $sqljoin = '';
+            $sqlwhere = "WHERE p.postid = ? ";
+            $params[] = $postid;
+        } else if ($bloginstancesid) {
+            $sqljoin  = "INNER JOIN {oublog_posts} p ON c.postid = p.id ";
+            $sqlwhere = "WHERE p.oubloginstancesid = ? ";
+            $params[] = $bloginstancesid;
+        } else {
+            $sqljoin  = "INNER JOIN {oublog_posts} p ON c.postid = p.id
+                         INNER JOIN {oublog_instances} i ON p.oubloginstancesid = i.id ";
+            $sqlwhere = "WHERE i.oublogid = ? ";
+            $params[] = $blogid;
+        }
+
+    } else {
+        $sql = "SELECT MAX(p.timeposted) AS timeposted
+                FROM {oublog_posts} p ";
+
+        if ($bloginstancesid) {
+            $sqljoin  = '';
+            $sqlwhere = "WHERE p.oubloginstancesid = ? ";
+            $params[] = $bloginstancesid;
+        } else {
+            $sqljoin  = "INNER JOIN {oublog_instances} i ON p.oubloginstancesid = i.id ";
+            $sqlwhere = "WHERE i.oublogid = ? ";
+            $params[] = $blogid;
+        }
+    }
+
+    return($DB->get_field_sql($sql.$sqljoin.$sqlwhere, $params));
+}
+
+
+
+/**
+ * Get blog comments in a format compatable with RSS lib
+ *
+ * @param int $blogid
+ * @param int $bloginstancesid
+ * @param int $postid
+ * @param object $user
+ * @param int $allowedvisibility
+ * @param int $groupid
+ * @param object $cm
+ * @param object $oublog
+ * @param int $individualid
+ * @return array
+ */
+function oublog_get_feed_comments($blogid, $bloginstancesid, $postid, $user, $allowedvisibility,
+        $groupid, $cm, $oublog, $individualid = -1) {
+    global $CFG, $DB;
+    $params = array();
+    $items = array();
+
+    if ($postid) {
+        $sqlwhere = "AND p.id = ? ";
+        $params[] = $postid;
+    } else if ($bloginstancesid) {
+        $sqlwhere = "AND p.oubloginstancesid = ? ";
+        $params[] = $bloginstancesid;
+    } else {
+        $sqlwhere = "AND i.oublogid = ? ";
+        $params[] = $blogid;
+    }
+    if ($individualid > 0 || $oublog->individual > OUBLOG_NO_INDIVIDUAL_BLOGS) {
+        $capable = oublog_individual_has_permissions($cm, $oublog, $groupid, $individualid, $user->id);
+        oublog_individual_add_to_sqlwhere($sqlwhere, $params, 'i.userid', $oublog->id, $groupid, $individualid, $capable);
+    } else {
+        if (isset($groupid) && $groupid) {
+            $sqlwhere .= " AND p.groupid = ? ";
+            $params[] = $groupid;
+        } else if (!empty($cm->groupingid)) {
+            if ($groups = $DB->get_records('groupings_groups',
+                    array('groupingid' => $cm->groupingid), null, 'groupid')) {
+                $sqlwhere .= " AND p.groupid ";
+                list ($grpssql, $grpsparams) = $DB->get_in_or_equal(array_keys($groups));
+                $params = array_merge($params, $grpsparams);
+                $sqlwhere .= $grpssql;
+            }
+        }
+    }
+    $usernamefields = get_all_user_name_fields(true, 'u');
+
+    $sql = "SELECT p.title AS posttitle, p.message AS postmessage, c.id, c.postid, c.title,
+                    c.message AS description, c.timeposted AS pubdate, c.authorname, c.authorip,
+                    c.timeapproved, i.userid, $usernamefields, u.picture, u.imagealt,
+                    u.email, u.idnumber
+            FROM {oublog_comments} c
+            INNER JOIN {oublog_posts} p ON c.postid = p.id
+            INNER JOIN {oublog_instances} i ON p.oubloginstancesid = i.id
+            LEFT JOIN {user} u ON c.userid = u.id
+            WHERE c.deletedby IS NULL AND p.deletedby IS NULL
+            AND p.visibility >= $allowedvisibility $sqlwhere
+            ORDER BY GREATEST(c.timeapproved, c.timeposted) DESC ";
+
+    $rs = $DB->get_recordset_sql($sql, $params, 0, OUBLOG_MAX_FEED_ITEMS);
+    $modcontext = context_module::instance($cm->id);
+
+    foreach ($rs as $item) {
+        $item->link = $CFG->wwwroot.'/mod/oublog/viewpost.php?post='.$item->postid;
+        // Rewrite image urls in oublog posts comments.
+        $item->description = file_rewrite_pluginfile_urls($item->description,
+                'mod/oublog/pluginfile.php', $modcontext->id, 'mod_oublog',
+                'messagecomment', $item->id);
+
+        if ($item->title) {
+            $item->description = "<h3>" . s($item->title) . "</h3>"
+                    . $item->description;
+        }
+
+        // Add post title if there, otherwise add shorten post message instead.
+        if ($item->posttitle) {
+            $linktopost = get_string('re', 'oublog', $item->posttitle);
+        } else {
+            $linktopost = get_string('re', 'oublog', html_to_text(shorten_text($item->postmessage)));
+        }
+        $item->title = $linktopost;
+        $item->author = fullname($item);
+
+        // For moderated posts, use different data
+        if ($item->authorname) {
+            // Author name from name instead of user field
+            $item->authorname = $item->author;
+
+            // Keep posted time just in case
+            $item->timeposted = $item->pubdate;
+
+            // Publication date = approval time (should be consistent with
+            // expected feed behaviour)
+            $item->pubdate = $item->timeapproved;
+        }
+
+        $items[] = $item;
+    }
+    $rs->close();
+    return($items);
+}
+
+
+
+/**
+ * Get post in a format compatable with RSS lib
+ *
+ * @param int $blogid
+ * @param int $bloginstancesid
+ * @param object $user
+ * @param bool $allowedvisibility
+ * @param int $groupid
+ * @param object $cm
+ * @return array
+ */
+function oublog_get_feed_posts($blogid, $bloginstance, $user, $allowedvisibility, $groupid, $cm, $oublog, $individualid=-1) {
+    global $CFG, $DB;
+    $params = array();
+    $items = array();
+
+    if ($bloginstance) {
+        $sqlwhere = "AND p.oubloginstancesid = ? ";
+        $params[] = $bloginstance->id;
+    } else {
+        $sqlwhere = "AND i.oublogid = ? ";
+        $params[] = $blogid;
+    }
+    // If individual blog.
+    if ($individualid > 0 || $oublog->individual > OUBLOG_NO_INDIVIDUAL_BLOGS) {
+        $capable = oublog_individual_has_permissions($cm, $oublog, $groupid, $individualid, $user->id);
+        oublog_individual_add_to_sqlwhere($sqlwhere, $params, 'i.userid', $oublog->id, $groupid, $individualid, $capable);
+    } else {// No individual blog.
+        if ($groupid) {
+            $sqlwhere .= " AND p.groupid = ? ";
+            $params[] = $groupid;
+        } else if (!empty($cm->groupingid)) {
+            if ($groups = $DB->get_records('groupings_groups', array('groupingid' => $cm->groupingid), null, 'groupid')) {
+                $sqlwhere .= "AND p.groupid IN (".implode(',', array_keys($groups)).") ";
+            }
+        }
+    }
+    // Scheme URL for tags
+    $scheme = $CFG->wwwroot . '/mod/oublog/';
+    if ($oublog->global) {
+        if (!$bloginstance) {
+            $scheme .= 'allposts.php?tag=';
+        } else {
+            $scheme .= 'view.php?user=' . $bloginstance->userid . '&tag=';
+        }
+    } else {
+        $scheme .= 'view.php?id=' . $cm->id;
+        if ($groupid) {
+            $scheme .= '&group=' . $groupid;
+        }
+        $scheme .= '&tag=';
+    }
+    $usernamefields = get_all_user_name_fields(true, 'u');
+
+    // Get posts
+    $sql = "SELECT p.id, p.title, p.message AS description, p.timeposted AS pubdate, i.userid, $usernamefields, u.email, u.picture, u.imagealt, u.idnumber
+            FROM {oublog_posts} p
+            INNER JOIN {oublog_instances} i ON p.oubloginstancesid = i.id
+            INNER JOIN {user} u ON i.userid = u.id
+            WHERE p.deletedby IS NULL AND p.visibility >= $allowedvisibility $sqlwhere
+            ORDER BY p.timeposted DESC ";
+
+    $rs = $DB->get_recordset_sql($sql, $params, 0, OUBLOG_MAX_FEED_ITEMS);
+    $modcontext = context_module::instance($cm->id);
+    foreach ($rs as $item) {
+        $item->link = $CFG->wwwroot.'/mod/oublog/viewpost.php?post='.$item->id;
+        $item->author = fullname($item);
+        $item->tags = array();
+        $item->tagscheme = $scheme;
+        // Feeds do not allow blank titles
+        if ((string)$item->title === '') {
+            $item->title = html_to_text(shorten_text($item->description));
+        }
+        // Rewrite image urls in oublog posts.
+        $item->description = file_rewrite_pluginfile_urls($item->description,
+                'mod/oublog/pluginfile.php', $modcontext->id,
+                'mod_oublog', 'message', $item->id);
+        $items[$item->id] = $item;
+    }
+    $rs->close();
+
+    // Get all tags related to these posts and fill them in
+    $sql = "SELECT p.id AS postid, t.id AS tagid, t.tag
+            FROM {oublog_posts} p
+            INNER JOIN {oublog_instances} i ON p.oubloginstancesid = i.id
+            INNER JOIN {oublog_taginstances} ti ON p.id = ti.postid
+            INNER JOIN {oublog_tags} t ON ti.tagid = t.id
+            WHERE p.deletedby IS NULL AND p.visibility >= $allowedvisibility $sqlwhere";
+
+    $rs = $DB->get_recordset_sql($sql, $params);
+    foreach ($rs as $tag) {
+        if (array_key_exists($tag->postid, $items)) {
+            $items[$tag->postid]->tags[$tag->tagid] = $tag->tag;
+        }
+    }
+    $rs->close();
+    return($items);
+}
+
+
+
+/**
+ * Get a url to a feed
+ *
+ * @param string $format atom or rss
+ * @param object $oublog
+ * @param object $bloginstance
+ * @param int $groupid
+ * @param bool $comments
+ * @param int $postid
+ * @param unknown_type $context
+ * @return string
+ * @uses $CFG
+ * @uses $USER
+ */
+function oublog_get_feedurl($format, $oublog, $bloginstance, $groupid, $comments, $postid, $cm, $individualid=0) {
+    global $CFG, $USER;
+    $url  = $CFG->wwwroot.'/mod/oublog/feed.php';
+    $url .= '?format='.$format;
+    $url .= '&amp;blog='.$oublog->id;
+    if ($oublog->global) {
+        if ((is_null($bloginstance) || is_string($bloginstance) && $bloginstance=='all')) {
+            $url .= '&amp;bloginstance=all';
+            $accesstoken = $oublog->accesstoken;
+        } else {
+            $url .= '&amp;bloginstance='.$bloginstance->id;
+            $accesstoken = $bloginstance->accesstoken;
+        }
+    } else {
+        $accesstoken = $oublog->accesstoken;
+    }
+
+    if ($groupid) {
+        $url .= '&amp;group='.$groupid;
+    }
+    // If individual blog.
+    if ($individualid > 0) {
+        $url .= '&amp;individual='.$individualid;
+    }
+
+    $url .= '&amp;comments='.$comments;
+
+    // Visibility level
+    if (isloggedin() && !isguestuser()) {
+        $url .= '&amp;viewer='.$USER->id;
+        // Don't use the 'full' token in personal blogs. We don't need personal
+        // blog feeds to include draft posts, even for the user (who's the only
+        // one allowed to see them) and it generates potential confusion.
+        if (!$oublog->global && oublog_can_post($oublog, 0, $cm)) {
+            // Full token changed to v2 after a security issue
+            $url .= '&amp;full='.md5($accesstoken.$USER->id.OUBLOG_VISIBILITY_COURSEUSER . 'v2');
+        } else {
+            $url .= '&amp;loggedin='.md5($accesstoken.$USER->id.OUBLOG_VISIBILITY_LOGGEDINUSER);
+        }
+    }
+
+    return($url);
+}
+
+
+
+/**
+ * Get a block containing links to the Atom and RSS feeds
+ *
+ * @param object $oublog
+ * @param object $bloginstance
+ * @param int $groupid
+ * @param int $postid
+ * @param object $context
+ * @return string HTML of block
+ * @uses $CFG
+ */
+function oublog_get_feedblock($oublog, $bloginstance, $groupid, $postid, $cm, $individualid=-1) {
+    global $CFG, $OUTPUT;
+
+    if (!$CFG->enablerssfeeds) {
+        return(false);
+    }
+
+    $blogurlatom = oublog_get_feedurl('atom',  $oublog, $bloginstance, $groupid, false, false, $cm, $individualid);
+    $blogurlrss = oublog_get_feedurl('rss',  $oublog, $bloginstance, $groupid, false, false, $cm, $individualid);
+
+    if (!is_string($bloginstance)) {
+        $commentsurlatom = oublog_get_feedurl('atom',  $oublog, $bloginstance, $groupid, true, $postid, $cm, $individualid);
+        $commentsurlrss = oublog_get_feedurl('rss',  $oublog, $bloginstance, $groupid, true, $postid, $cm, $individualid);
+    }
+
+    $html  = '<div id="oublog-feedtext">' . get_string('subscribefeed', 'oublog', oublog_get_displayname($oublog));
+    $html .= $OUTPUT->help_icon('feedhelp', 'oublog');
+    $html .= '</div>';
+    $html .= '<div class="oublog-feedlinks">';
+    $html .= '<span class="oublog-feedlinks-feedtitle">' . get_string('blogfeed', 'oublog', oublog_get_displayname($oublog, true)) . ': </span>';
+    $html .= '<span class="oublog-feedlinks-feedtype">';
+    $html .= '<br/><a href="'.$blogurlatom.'">'.get_string('atom', 'oublog').'</a> ';
+    $html .= '<br/><a href="'.$blogurlrss.'">'.get_string('rss', 'oublog').'</a>';
+    $html .= '</span>';
+
+    if ($oublog->allowcomments) {
+        if (!is_string($bloginstance)) {
+            $html .= '<div class="oublog-links">';
+            $html .= '<span class="oublog-feedcommentlinks-feedtitle">'.get_string('commentsfeed', 'oublog') . ': </span>';
+            $html .= '<br/><a href="'.$commentsurlatom.'">'.get_string('comments', 'oublog').' '.get_string('atom', 'oublog').'</a> ';
+            $html .= '<br/><a href="'.$commentsurlrss.'">'.get_string('comments', 'oublog').' '.get_string('rss', 'oublog').'</a>';
+            $html .= '</div>';
+        }
+    }
+    $html .= '</div>';
+    return ($html);
+}
+
+
+
+/**
+ * Get extra meta tags that need to go into the page header
+ *
+ * @param object $oublog
+ * @param object $bloginstance
+ * @param int $groupid
+ * @param object $context
+ * @return string
+ */
+function oublog_get_meta_tags($oublog, $bloginstance, $groupid, $cm, $post = null) {
+    global $CFG;
+
+    $meta = '';
+    $blogurlatom = oublog_get_feedurl('atom',  $oublog, $bloginstance, $groupid, false, false, $cm);
+    $blogurlrss = oublog_get_feedurl('rss',  $oublog, $bloginstance, $groupid, false, false, $cm);
+
+    if ($CFG->enablerssfeeds) {
+        $meta .= '<link rel="alternate" type="application/atom+xml" title="'.get_string('atomfeed', 'oublog').'" href="'.$blogurlatom .'" />';
+        $meta .= '<link rel="alternate" type="application/atom+xml" title="'.get_string('rssfeed', 'oublog').'" href="'.$blogurlrss .'" />';
+    }
+    if (isset($post)) {
+        $postname = !(empty($post->title)) ? $post->title : get_string('untitledpost', 'oublog');
+        $meta .= '<meta property="og:type" content="article" />';
+        $meta .= '<meta property="og:title" content="' . $postname . '" />';
+        $meta .= '<meta property="og:description" content="' . $oublog->name . '" />';
+        $meta .= '<meta property="og:url" content="' . $CFG->wwwroot .
+                '/mod/oublog/viewpost.php?post=' . $post->id. '" />';
+    }
+
+    return ($meta);
+}
+
+
+
+/**
+ * replace a variable withing a querystring
+ *
+ * @param string $url
+ * @param string $replacekey
+ * @param string $newvalue
+ * @return string
+ */
+function oublog_replace_url_param($url, $replacekey, $newvalue=null) {
+
+    $urlparts = parse_url(html_entity_decode($url));
+
+    $queryparts = array();
+
+    parse_str($urlparts['query'], $queryparts);
+
+    unset($queryparts[$replacekey]);
+
+    if ($newvalue) {
+        $queryparts[$replacekey] = $newvalue;
+    }
+
+    foreach ($queryparts as $key => $value) {
+        $queryparts[$key] = "$key=$value";
+    }
+    $url = $urlparts['path'].'?'.implode('&amp;', $queryparts);
+
+    return($url);
+}
+
+/** @return True if OU search extension is installed */
+function oublog_search_installed() {
+    return @include_once(dirname(__FILE__).'/../../local/ousearch/searchlib.php');
+}
+
+/**
+ * Obtains a search document relating to a particular blog post.
+ *
+ * @param object $post Post object. Required fields: id (optionally also
+ *   groupid, userid save a db query)
+ * @param object $cm Course-module object. Required fields: id, course
+ * @return ousearch_doument
+ */
+function oublog_get_search_document($post, $cm) {
+    global $DB;
+    // Set up 'search document' to refer to this post
+    $doc=new local_ousearch_document();
+    $doc->init_module_instance('oublog', $cm);
+    if (!isset($post->userid) || !isset($post->groupid)) {
+        $results=$DB->get_record_sql("
+SELECT
+    p.groupid,i.userid
+FROM
+{oublog_posts} p
+    INNER JOIN {oublog_instances} i ON p.oubloginstancesid=i.id
+WHERE
+    p.id= ?", array($post->id));
+        if (!$results) {
+            print_error('invalidblogdetails', 'oublog');
+        }
+        $post->userid=$results->userid;
+        $post->groupid=$results->groupid;
+    }
+    if ($post->groupid) {
+        $doc->set_group_id($post->groupid);
+    }
+    $doc->set_user_id($post->userid);
+    $doc->set_int_refs($post->id);
+    return $doc;
+}
+
+/**
+ * Obtains tags for a $post object whether or not it currently has them
+ * defined in some way. (If they're not defined, uses a database query.)
+ *
+ * @param object $post Post object, must contain ->id at least
+ * @param bool $includespaces If true, replaces the _ with space again
+ * @return array Array of tags (may be empty)
+ */
+function oublog_get_post_tags($post, $includespaces = false) {
+    global $CFG, $DB;
+
+    // Work out tags from existing data if possible (to save adding a query)
+    if (isset($post->tags)) {
+        $taglist=oublog_clarify_tags($post->tags);
+    } else {
+        // Tags aren't in post so use database query
+        $rs=$DB->get_recordset_sql("
+SELECT
+    t.tag
+FROM
+    {oublog_taginstances} ti
+    INNER JOIN {oublog_tags} t ON ti.tagid = t.id
+WHERE
+    ti.postid=?", array($post->id));
+        $taglist=array();
+        foreach ($rs as $rec) {
+            $taglist[]=$rec->tag;
+        }
+        $rs->close();
+    }
+    if ($includespaces) {
+        foreach ($taglist as $ix => $tag) {
+            // Make the spaces in tags back into spaces so they're searchable (sigh)
+            $taglist[$ix]=str_replace('_', ' ', $tag);
+        }
+    }
+
+    return $taglist;
+}
+
+/**
+ * Updates the fulltext search information for a post which is being added or
+ * updated.
+ * @param object $post Post data, including slashes for database. Must have
+ *   fields id,userid,groupid (if applicable), title, message
+ * @param object $cm Course-module
+ * @return True if search update was successful
+ */
+function oublog_search_update($post, $cm) {
+    // Do nothing if OU search is not installed
+    if (!oublog_search_installed()) {
+        return true;
+    }
+
+    // Get search document
+    $doc=oublog_get_search_document($post, $cm);
+
+    // Sort out tags for use as extrastrings
+    $taglist=oublog_get_post_tags($post, true);
+    if (count($taglist)==0) {
+        $taglist=null;
+    }
+
+    // Update information about this post (works ok for add or edit)
+    $doc->update($post->title, $post->message, null, null, $taglist);
+    return true;
+}
+
+function oublog_date($time, $insentence = false) {
+    if (function_exists('specially_shrunken_date')) {
+        return specially_shrunken_date($time, $insentence);
+    } else {
+        return userdate($time);
+    }
+}
+
+/**
+ * Creates navigation for a blog page header.
+ * @param object $cm Moodle course-modules object
+ * @param object $oublog Row object from 'oublog' table
+ * @param object $oubloginstance Row object from 'oubloginstance' table
+ * @param object $oubloguser Moodle user object
+ * @param array $extranav Optional additional navigation entry; may be an array
+ *   of nav entries, a single nav entry (array with
+ *   'name', optional 'link', and 'type' fields), or null for none
+ * @return object Navigation item object
+ */
+function oublog_build_navigation($oublog, $oubloginstance, $oubloguser) {
+    global $PAGE;
+    if ($oublog->global && !empty($oubloguser)) {
+        $PAGE->navbar->add(fullname($oubloguser), new moodle_url('/user/view.php', array('id'=>$oubloguser->id)));
+        $PAGE->navbar->add(format_string($oubloginstance->name), new moodle_url('/mod/oublog/view.php', array('user'=>$oubloguser->id)));
+    }
+}
+
+/*///////////////////////////////*/
+// Constants for individual blogs.
+define('OUBLOG_NO_INDIVIDUAL_BLOGS', 0);
+define('OUBLOG_SEPARATE_INDIVIDUAL_BLOGS', 1);
+define('OUBLOG_VISIBLE_INDIVIDUAL_BLOGS', 2);
+
+/**
+ * Get an object with details of individual activity
+ * @param $cm
+ * @param $urlroot
+ * @param $oublog
+ * @param $currentgroup
+ * @param $context
+ * @return an object
+ */
+function oublog_individual_get_activity_details($cm, $urlroot, $oublog, $currentgroup, $context) {
+    global $CFG, $USER, $SESSION, $OUTPUT;
+    if (strpos($urlroot, 'http') !== 0) { // Will also work for https
+        debugging('oublog_print_individual_activity_menu requires absolute URL for ' .
+            '$urlroot, not <tt>' . s($urlroot) . '</tt>. Example: ' .
+            'oublog_print_individual_activity_menu($cm, $CFG->wwwroot . \'/mod/mymodule/view.php?id=13\');',
+        DEBUG_DEVELOPER);
+    }
+    // get groupmode and individualmode
+    $groupmode = oublog_get_activity_groupmode($cm);
+    $individualmode = $oublog->individual;
+
+    // No individual blogs.
+    if ($individualmode == OUBLOG_NO_INDIVIDUAL_BLOGS) {
+        return '';
+    }
+    // If no groups or 'all groups' selection' ($currentgroup == 0).
+    if ($groupmode == NOGROUPS || $currentgroup == 0) {
+        // Visible individual.
+        if ($individualmode == OUBLOG_VISIBLE_INDIVIDUAL_BLOGS) {
+            $allowedindividuals = oublog_individual_get_all_users($cm->course, $cm->instance);
+        }
+        // Separate individual (check capability of present user.
+        if ($individualmode == OUBLOG_SEPARATE_INDIVIDUAL_BLOGS) {
+            $allowedindividuals = oublog_individual_get_all_users($cm->course, $cm->instance, 0, $context);
+        }
+    }
+
+    // If a group is selected ($currentgroup > 0).
+    if ($currentgroup > 0) {
+        // Visible individual.
+        if ($individualmode == OUBLOG_VISIBLE_INDIVIDUAL_BLOGS) {
+            $allowedindividuals = oublog_individual_get_all_users($cm->course, $cm->instance, $currentgroup );
+        }
+        // Separate individual.
+        if ($individualmode == OUBLOG_SEPARATE_INDIVIDUAL_BLOGS) {
+            $allowedindividuals = oublog_individual_get_all_users($cm->course, $cm->instance, $currentgroup, $context);
+        }
+    }
+    $activeindividual = oublog_individual_get_active_user($allowedindividuals, $individualmode, true);
+
+    // Setup the drop-down menu.
+    $menu = array();
+    if (count($allowedindividuals) > 1) {
+        if ($currentgroup > 0) {// Selected group.
+            $menu[0] = get_string('viewallusersingroup', 'oublog');
+        } else {// No groups or all groups.
+            $menu[0] = get_string('viewallusers', 'oublog');
+        }
+    }
+
+    if ($allowedindividuals) {
+        foreach ($allowedindividuals as $user) {
+            $menu[$user->id] = format_string($user->firstname . ' ' . $user->lastname);
+        }
+    }
+
+    if ($individualmode == OUBLOG_VISIBLE_INDIVIDUAL_BLOGS) {
+        $label = get_string('visibleindividual', 'oublog') . '&nbsp;';
+    } else {
+        $label = get_string('separateindividual', 'oublog') . '&nbsp;';
+    }
+
+    $output = "";
+
+    if (count($menu) == 1) {
+        $name = reset($menu);
+        $output = $label.':&nbsp;'.$name;
+    } else {
+        $active = '';
+        foreach ($menu as $value => $item) {
+            $url = $urlroot.'&amp;individual='.$value;
+            $url = str_replace($CFG->wwwroot, '', $url);
+            $url = str_replace('&amp;', '&', $url);
+            $urls[$url] = $item;
+            if ($activeindividual == $value) {
+                $active = $url;
+            }
+        }
+        if (!empty($urls)) {
+            $select = new url_select($urls, $active, null, 'selectindividual');
+
+            $select->set_label($label);
+
+            $output = $OUTPUT->render($select);
+        }
+    }
+
+    $output = '<div class="oublog-individualselector">'.$output.'</div>';
+    // Set up the object details needed.
+    $individualdetails = new stdClass;
+    $individualdetails->display = $output;
+    $individualdetails->activeindividual = $activeindividual;
+    $individualdetails->mode = $individualmode;
+    $individualdetails->userids = array_keys($allowedindividuals);
+    $individualdetails->newblogpost = true;
+
+    // Hid the "New blog post" button.
+    if ((($activeindividual == 0) && !array_key_exists($USER->id, $allowedindividuals))
+        ||($activeindividual > 0 && $activeindividual != $USER->id)) {
+        $individualdetails->newblogpost = false;
+    }
+    return $individualdetails;
+}
+
+
+function oublog_individual_get_all_users($courseid, $oublogid, $currentgroup=0, $context=0) {
+    global $CFG, $USER;
+    // Add present user to the list.
+    $currentuser = array();
+    $user = new stdClass;
+    $user->firstname = $USER->firstname;
+    $user->lastname = $USER->lastname;
+    $user->id = $USER->id;
+    $currentuser[$USER->id] = $user;
+    if ($context && !has_capability('mod/oublog:viewindividual', $context)) {
+        return $currentuser;
+    }
+    // No groups or all groups selected.
+    if ($currentgroup == 0) {
+        $userswhoposted = oublog_individual_get_users_who_posted_to_this_blog($oublogid);
+    } else if ($currentgroup > 0) {// A group is selected.
+        // Users who posted to the blog and belong to the selected group.
+        $userswhoposted = oublog_individual_get_users_who_posted_to_this_blog($oublogid, $currentgroup);
+    }
+
+    if (!$userswhoposted) {
+        $userswhoposted = array();
+    }
+    $keys = array_keys($userswhoposted);
+    if (in_array($USER->id, $keys)) {
+        return $userswhoposted;
+    } else {
+        if ($currentgroup == 0 || groups_is_member($currentgroup, $USER->id)) {
+            return $currentuser + $userswhoposted;
+        } else {
+            return $userswhoposted;
+        }
+    }
+}
+
+
+function oublog_individual_get_users_who_posted_to_this_blog($oublogid, $currentgroup=0) {
+    global $DB;
+    $params = array();
+    if ($currentgroup > 0) {
+        $sql = "SELECT u.id, u.firstname, u.lastname
+                FROM {user} u
+                INNER JOIN {oublog_instances} bi
+                ON bi.oublogid = ? AND bi.userid = u.id
+                INNER JOIN {groups_members} gm
+                ON bi.userid = gm.userid
+                WHERE gm.groupid = ?
+                ORDER BY u.firstname ASC, u.lastname ASC";
+        $params[] = $oublogid;
+        $params[] = $currentgroup;
+    } else {
+        $sql = "SELECT u.id, u.firstname, u.lastname
+            FROM {user} u
+            JOIN {oublog_instances} bi
+            ON bi.oublogid = $oublogid AND bi.userid = u.id
+            ORDER BY u.firstname ASC, u.lastname ASC";
+    }
+    if ($userswhoposted = $DB->get_records_sql($sql, $params)) {
+        return $userswhoposted;
+    }
+    return array();
+}
+
+
+function oublog_individual_get_active_user($allowedindividuals, $individualmode, $update=false) {
+    global $USER, $SESSION;
+
+    // Only one userid in the list (this could be $USER->id or any other userid).
+    if (count($allowedindividuals) == 1) {
+        $chosenindividual =  array_keys($allowedindividuals);
+        return $chosenindividual[0];
+    }
+    if (!property_exists($SESSION, 'oublog_individualid')) {
+        $SESSION->oublog_individualid = '';
+    }
+
+    // set new active individual if requested
+    $changeindividual = optional_param('individual', -1, PARAM_INT);
+
+    if ($update && $changeindividual != -1) {
+        $SESSION->oublog_individualid = $changeindividual;
+    } else if (isset($SESSION->oublog_individualid)) {
+        return $SESSION->oublog_individualid;
+    } else {
+        $SESSION->oublog_individualid = $USER->id;
+    }
+    return $SESSION->oublog_individualid;
+}
+
+
+function oublog_individual_has_permissions($cm, $oublog, $groupid, $individualid=-1, $userid=0) {
+    global $USER;
+    if (!$userid) {
+        $userid = $USER->id;
+    }
+
+    // Chosen an individual user who is the logged-in user.
+    if ($individualid > 0 && $userid == $individualid) {
+        return true;
+    }
+
+    // Get context.
+    $context = context_module::instance($cm->id);
+
+    // No individual blogs.
+    $individualmode = $oublog->individual;
+    if ($individualmode == OUBLOG_NO_INDIVIDUAL_BLOGS) {
+        return true;
+    }
+
+    $groupmode = oublog_get_activity_groupmode($cm);
+
+    // Separate individual.
+    if ($individualmode == OUBLOG_SEPARATE_INDIVIDUAL_BLOGS) {
+        if (!has_capability('mod/oublog:viewindividual', $context, $userid)) {
+            return false;
+        }
+
+        // No group.
+        if ($groupmode == NOGROUPS) {
+            return true;
+        }
+
+        // Chosen a group.
+        if ($groupid > 0) {
+            // Visible group.
+            if ($groupmode == VISIBLEGROUPS) {
+                return true;
+            }
+            // Has access to all groups.
+            if (has_capability('moodle/site:accessallgroups', $context, $userid)) {
+                return true;
+            }
+            // Same group.
+            if (groups_is_member($groupid, $userid) &&
+                groups_is_member($groupid, $individualid)) {
+                return true;
+            }
+            return false;
+        } else {
+            if (has_capability('moodle/site:accessallgroups', $context, $userid)) {
+                return true;
+            }
+        }
+
+        return false;
+    } else if ($individualmode == OUBLOG_VISIBLE_INDIVIDUAL_BLOGS) {// Visible individual.
+        // No group.
+        if ($groupmode == NOGROUPS) {
+            return true;
+        }
+        // Visible group.
+        if ($groupmode == VISIBLEGROUPS) {
+            return true;
+        }
+        // Separate groups.
+        if ($groupmode == SEPARATEGROUPS) {
+            // Have accessallgroups.
+            if (has_capability('moodle/site:accessallgroups', $context, $userid)) {
+                return true;
+            }
+            // If they don't have accessallgroups then they must select a group
+            if (!$groupid) {
+                return false;
+            }
+            // Chosen individual.
+            if ($individualid > 0) {
+                // Same group.
+                if (groups_is_member($groupid, $userid) &&
+                    groups_is_member($groupid, $individualid)) {
+                    return true;
+                }
+                return false;
+            } else {
+                // Chosen all users in the group.
+                if (groups_is_member($groupid, $userid)) {
+                    return true;
+                }
+                return false;
+            }
+        }
+        return false;
+    }
+    return false;
+}
+
+
+function oublog_individual_add_to_sqlwhere(&$sqlwhere, &$params, $userfield, $oublogid, $groupid=0, $individualid=0, $capable=true) {
+    // Has not capability.
+    if (!$capable) {
+        return;
+    }
+
+    // Only one user is chosen.
+    if ($individualid > 0) {
+        $sqlwhere .= " AND $userfield = ? ";
+        $params[] = $individualid;
+        return;
+    }
+
+    // A list of user is chosen.
+    $from = " FROM {oublog_instances} bi ";
+    $where = " WHERE bi.oublogid=$oublogid ";
+
+    // Individuals within a group.
+    if (isset($groupid) && $groupid > 0) {
+        $from .= " INNER JOIN {groups_members} gm
+                    ON bi.userid = gm.userid";
+        $where .= " AND gm.groupid= ? ";
+        $params[] = $groupid;
+        $where .= " AND bi.userid=gm.userid ";
+    }
+    $subsql =  "SELECT bi.userid $from $where";
+    $sqlwhere .= " AND $userfield IN ($subsql)";
+}
+
+/**
+ * Get last-modified time for blog, as it appears to this user. This takes into
+ * account the user's groups/individual settings if required. Only works on
+ * course blogs. (Does not check that user can view the blog.)
+ *
+ * This data is all in a static: so can be called in multiple places without issue
+ *
+ * @param object $cm Course-modules entry for wiki
+ * @param object $Course Course object
+ * @param int $userid User ID or 0 = current
+ * @return int Last-modified time for this user as seconds since epoch
+ */
+function oublog_get_last_modified($cm, $course, $userid=0) {
+    global $USER, $DB;
+    if (!$userid) {
+        $userid = $USER->id;
+    }
+
+    static $results;
+    if (!isset($results)) {
+        $results = array();
+    }
+    if (!array_key_exists($userid, $results)) {
+        $results[$userid] = array();
+    } else if (array_key_exists($cm->id, $results[$userid])) {
+        return $results[$userid][$cm->id];
+    }
+
+    static $oublogs; // Cache all blogs in this course, saves extra DB calls.
+    if (!isset($oublogs)) {
+        $oublogs = array();
+    }
+    if (empty($oublogs[$course->id])) {
+        $oublogs[$course->id] = $DB->get_records('oublog', array('course' => $course->id));
+    }
+
+    // Get blog record and groupmode.
+    if (!isset($oublogs[$course->id][$cm->instance])) {
+        return false;
+    }
+    $oublog = $oublogs[$course->id][$cm->instance];
+    $groupmode = oublog_get_activity_groupmode($cm, $course);
+
+    // Default applies no restriction
+    $restrictjoin = '';
+    $restrictwhere = '';
+    $rwparam = array();
+    $context = context_module::instance($cm->id);
+
+    // Restrict to separate groups
+    if ($groupmode == SEPARATEGROUPS &&
+        !has_capability('moodle/site:accessallgroups', $context, $userid)) {
+
+        if ($oublog->individual) {
+            // In individual mode, group restriction works by shared grouping
+            $restrictjoin .= "
+INNER JOIN {groups_members} gm2 ON gm2.userid = bi.userid
+INNER JOIN {groups} g ON g.id = gm2.groupid";
+            $groupfield = "g.id";
+            $restrictwhere .= "
+AND g.courseid = ?";
+            $rwparam[] = $course->id;
+        } else {
+            // Outside individual mode, group restriction works based on groupid
+            // in post.
+            $groupfield = "p.groupid";
+        }
+        $restrictjoin .= "
+INNER JOIN {groups_members} gm ON gm.groupid = $groupfield";
+        $restrictwhere .= "
+AND gm.userid = ?";
+        $rwparam[] = $userid;
+
+        if ($cm->groupingid) {
+            $restrictjoin .= "
+INNER JOIN {groupings_groups} gg ON gg.groupid = $groupfield";
+            $restrictwhere .= "
+AND gg.groupingid = ?";
+            $rwparam[] = $cm->groupingid;
+        }
+    }
+
+    // Restrict to separate individuals
+    if ($oublog->individual == OUBLOG_SEPARATE_INDIVIDUAL_BLOGS &&
+        !has_capability('mod/oublog:viewindividual', $context, $userid)) {
+        // Um, only your own blog
+        $restrictwhere .= "
+AND bi.userid = ?";
+        $rwparam[] = $userid;
+    }
+
+    // Query for newest version that follows these restrictions.
+    $result = $DB->get_field_sql("
+SELECT
+    MAX(p.timeposted)
+FROM
+    {oublog_posts} p
+    INNER JOIN {oublog_instances} bi ON p.oubloginstancesid = bi.id
+    $restrictjoin
+WHERE
+    bi.oublogid = ?
+    AND p.timedeleted IS NULL
+    $restrictwhere", array_merge(array($oublog->id), $rwparam));
+
+    $results[$userid][$cm->id] = $result;
+
+    return $result;
+}
+
+/**
+ * For moderated users; rate-limits comments by IP address.
+ * @return True if user has made too many comments within past hour
+ */
+function oublog_too_many_comments_from_ip() {
+    global $DB;
+    $ip = getremoteaddr();
+    $hourago = time() - 3600;
+    $count = $DB->count_records_sql("SELECT COUNT(1) FROM " .
+        "{oublog_comments_moderated} WHERE authorip = ? " .
+        "AND timeposted > ?", array($ip, $hourago));
+    // Max comments per hour = 10 at present
+    return $count > 10;
+}
+
+/**
+ * Works out the typical time it takes a given user to approve blog entries,
+ * based on all entries from the past year.
+ * @param int $userid User ID
+ * @return string String representation of typical time e.g. '24 hours' or
+ *   '3 days', or false if unable to estimate yet
+ */
+function oublog_get_typical_approval_time($userid) {
+    global $DB;
+
+    // Get delays for all the posts they approved in the past year
+    $rs = $DB->get_recordset_sql("
+SELECT (bc.timeapproved - bc.timeposted) AS delay FROM {oublog_comments} bc
+INNER JOIN {oublog_posts} bp on bc.postid = bp.id
+INNER JOIN {oublog_instances} bi on bp.oubloginstancesid = bi.id
+WHERE
+bi.userid=?
+AND bc.userid IS NULL
+ORDER BY (bc.timeapproved - bc.timeposted)", array($userid));
+    if (empty($rs)) {
+        print_error('invalidblog', 'oublog');
+    }
+    $times = array();
+    foreach ($rs as $rec) {
+        $times[] = $rec->delay;
+    }
+    $rs->close();
+
+    // If the author hasn't approved that many comments, don't give an estimate
+    if (count($times) < 5) {
+        return false;
+    }
+
+    // Use the 75th percentile
+    $index = floor((count($times) * 3) / 4);
+    $delay = $times[$index];
+
+    // If it's less than a day
+    if ($delay < 24 * 3600) {
+        // Round up to hours (at least 2)
+        $delay = ceil($delay/3600);
+        if ($delay < 2) {
+            $delay = 2;
+        }
+        return get_string('numhours', '', $delay);
+    } else {
+        // Round up to days (at least 2)
+        $delay = ceil($delay / (24*3600));
+        if ($delay < 2) {
+            $delay = 2;
+        }
+        return get_string('numdays', '', $delay);
+    }
+}
+
+/**
+ * Applies high security restrictions to HTML input from moderated comments.
+ * Recursive function.
+ * @param $element DOM element
+ */
+function oublog_apply_high_security(DOMElement $element) {
+    // Note that Moodle security should probably already prevent this (and
+    // should include a whitelist approach), but just to increase the paranoia
+    // level a bit with these comments.
+    static $allowtags = array(
+        'html' => 1, 'body' => 1,
+        'em' => 1, 'strong' => 1, 'b' => 1, 'i' => 1, 'del' => 1, 'sup' => 1,
+            'sub' => 1, 'span' => 1, 'a' => 1, 'img' => 1,
+        'p' => 1, 'div' => 1
+    );
+
+    // Chuck away any disallowed tags
+    if (!array_key_exists(strtolower($element->tagName), $allowtags)) {
+        $parent = $element->parentNode;
+        while ($child = $element->firstChild) {
+            $element->removeChild($child);
+            $parent->insertBefore($child, $element);
+            if ($child->nodeType == XML_ELEMENT_NODE) {
+                oublog_apply_high_security($child);
+            }
+        }
+        $parent->removeChild($element);
+        return;
+    }
+
+    // Chuck away all attributes except href, src pointing to a folder or HTML, image
+    // (this prevents SWF embed by link, if site is unwise enough to have that
+    // turned on)
+    $attributenames = array();
+    $keepattributes = array();
+    foreach ($element->attributes as $name => $value) {
+        $attributenames[] = $name;
+        $keep = false;
+        if ($name === 'href' && preg_match('~^https?://~', $value->nodeValue)) {
+            $keep = true;
+        } else if ($name === 'src' &&
+                preg_match('~^https?://.*\.(jpg|jpeg|png|gif|svg)$~', $value->nodeValue)) {
+            $keep = true;
+        } else if ($name === 'alt') {
+            $keep = true;
+        }
+        if ($keep) {
+            $keepattributes[$name] = $value->nodeValue;
+        }
+    }
+    foreach ($attributenames as $name) {
+        $element->removeAttribute($name);
+    }
+    foreach ($keepattributes as $name => $value) {
+        $element->setAttribute($name, $value);
+    }
+
+    // Recurse to children
+    $children = array();
+    foreach ($element->childNodes as $child) {
+        $children[] = $child;
+    }
+    foreach ($children as $child) {
+        if ($child->nodeType == XML_ELEMENT_NODE) {
+            oublog_apply_high_security($child);
+        }
+    }
+}
+
+/**
+ * Adds a new moderated comment into the database ready for approval, and sends
+ * an approval email to the moderator (person who owns the blog post).
+ * @param object $oublog Blog object
+ * @param object $oubloginstance Blog instance object
+ * @param object $post Blog post object
+ * @param object $comment Comment object (including slashes)
+ */
+function oublog_add_comment_moderated($oublog, $oubloginstance, $post, $comment) {
+    global $CFG, $USER, $SESSION, $SITE, $DB;
+
+    // Extra security on moderated comment
+    $dom = @DOMDocument::loadHTML('<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /></head><body><div>' .
+            $comment->messagecomment . '</div></body></html>');
+    oublog_apply_high_security($dom->documentElement);
+    $html = $dom->saveHTML();
+    $start = strpos($html, '<body><div>') + 11;
+    $end = strrpos($html, '</div></body>');
+    $comment->message = substr($html, $start, $end - $start);
+    $comment->title = trim($comment->title);
+
+    // Add comment to database
+    unset($comment->userid);
+    $comment->timeposted = time();
+    $comment->authorip = getremoteaddr();
+    // Secret key is half the SHA-1 of a random number plus current time
+    $comment->secretkey = substr(sha1(rand() . microtime(true)), 0, 20);
+    $comment->id = $DB->insert_record('oublog_comments_moderated', $comment);
+    if (!$comment->id) {
+        return false;
+    }
+
+    // Get blog owner
+    $result = true;
+    $user = $DB->get_record('user', array('id'=>$oubloginstance->userid));
+    if (!$user) {
+        $result = false;
+        $user = (object)array('lang'=>'');
+    }
+
+    // Change language temporarily (UGH - this is horrible but there doesn't
+    // seem to be a way to do it in moodle without logging in as the other
+    // user). This is based on (defeating) the logic in current_language.
+    $oldsessionlang = null;
+    if (!empty($SESSION->lang)) {
+        // If this user has chosen a language in session, turn that off
+        $oldsessionlang = $SESSION->lang;
+        $SESSION->lang = null;
+    }
+    $USER->lang = $user->lang;
+
+    // Subject line
+    $commenterhtml = s($comment->authorname);
+    $a = (object)array(
+        'blog' => s($oublog->global ? $oubloginstance->name : $oublog->name),
+        'commenter' => $commenterhtml
+    );
+    $subject = get_string('moderated_emailsubject', 'oublog', $a);
+
+    // Main text
+    $approvebase = $CFG->wwwroot . '/mod/oublog/approve.php?mcomment=' .
+        $comment->id . '&amp;key=' . $comment->secretkey;
+    $a = (object)array(
+        'postlink' => '<a href="' . $CFG->wwwroot .
+            '/mod/oublog/viewpost.php?post=' . $post->id . '">' .
+            ($post->title ? s($post->title) : shorten_text(strip_tags($post->message))) .
+            '</a>',
+        'commenter' => $commenterhtml,
+        'commenttitle' => $comment->title ? $comment->title : '',
+        'comment' =>
+            format_text($comment->message, FORMAT_MOODLE,
+            null, $oublog->course),
+        'approvelink' => $approvebase . '&amp;approve=1',
+        'approvetext' => get_string('moderated_approve', 'oublog'),
+        'rejectlink' => $approvebase . '&amp;approve=0',
+        'rejecttext' => get_string('moderated_reject', 'oublog'),
+        'restrictpostlink' => $CFG->wwwroot .
+            '/mod/oublog/restrictcomments.php?post=' . $post->id,
+        'restrictposttext' => get_string('moderated_restrictpost', 'oublog'),
+        'restrictbloglink' => $CFG->wwwroot .
+            '/mod/oublog/restrictcomments.php?blog=' . $oublog->id,
+        'restrictblogtext' => get_string('moderated_restrictblog', 'oublog')
+    );
+    $messagetext = get_string('moderated_emailtext', 'oublog', $a);
+    $messagehtml = get_string('moderated_emailhtml', 'oublog', $a);
+    // hack to remove empty tags when there is no title
+    $messagehtml = str_replace('<h3></h3>', '', $messagehtml);
+    $result = $result && email_to_user($user, $SITE->fullname,
+        $subject, $messagetext, $messagehtml);
+
+    // Put language back
+    if ($oldsessionlang) {
+        $SESSION->lang = $oldsessionlang;
+    }
+    $USER->lang = null;
+
+    if (!$result) {
+        // Oh well, better delete it from database
+        $DB->delete_records('oublog_comments_moderated', array('id'=>$comment->id));
+        return false;
+    }
+    return true;
+}
+
+/**
+ * Obtains comments that are awaiting moderation for a particulasr post
+ * @param object $oublog Moodle data object from oublog
+ * @param object $post Moodle data object from oublog_posts
+ * @param bool $includeset If true, includes comments which have already been
+ *   rejected or approved, as well as those which await processing
+ * @return array Array of Moodle data objects from oublog_comments_moderated;
+ *   empty array (not false) if none; objects are in date order (oldest first)
+ */
+function oublog_get_moderated_comments($oublog, $post, $includeset=false) {
+    global $DB;
+    // Don't bother checking if public comments are not allowed
+    if ($oublog->allowcomments < OUBLOG_COMMENTS_ALLOWPUBLIC
+            && $post->allowcomments < OUBLOG_COMMENTS_ALLOWPUBLIC) {
+        return array();
+    }
+
+    // Query for moderated comments
+    $result = $DB->get_records_select('oublog_comments_moderated',
+        ($includeset ? '' : 'approval=0 AND ') . 'postid= ?', array($post->id), 'id');
+    return $result ? $result : array();
+}
+
+/**
+ * Approves or rejects a moderated comment.
+ * @param object $mcomment Moderated comment object (no slashes)
+ * @param bool $approve True to approve, false to reject
+ * @return ID of new comment row, or false if failure
+ */
+function oublog_approve_comment($mcomment, $approve) {
+    global $DB;
+    // Get current time and start transaction
+    $now = time();
+    $tw = $DB->start_delegated_transaction();;
+
+    // Update the moderated comment record
+    $update = (object)array(
+        'id' => $mcomment->id,
+        'approval' => $approve ? OUBLOG_MODERATED_APPROVED :
+            OUBLOG_MODERATED_REJECTED,
+        'timeset' => $now
+    );
+    if (!$DB->update_record('oublog_comments_moderated', $update)) {
+        return false;
+    }
+
+    // Add the new comment record
+    if ($approve) {
+        $insert = (object)array(
+            'postid' => $mcomment->postid,
+            'title' => $mcomment->title,
+            'message' => $mcomment->message,
+            'timeposted' => $mcomment->timeposted,
+            'authorname' => $mcomment->authorname,
+            'authorip' => $mcomment->authorip,
+            'timeapproved' => $now);
+        if (!($id = $DB->insert_record('oublog_comments', $insert))) {
+            return false;
+        }
+    } else {
+        $id = true;
+    }
+
+    // Commit transaction and return id
+    $tw->allow_commit();
+    return $id;
+}
+
+/**
+ * Gets the extra navigation needed for pages relating to a post.
+ * @param object $post Moodle database object for post
+ * @param bool $link True if post name should be a link
+ */
+function oublog_get_post_extranav($post, $link=true) {
+    global $PAGE;
+    if ($link) {
+        $url = new moodle_url('/mod/oublog/viewpost.php', array('post'=>$post->id));
+    } else {
+        $url = null;
+    }
+    if (!empty($post->title)) {
+        $PAGE->navbar->add(format_string($post->title), $url);
+    } else {
+        $PAGE->navbar->add(shorten_text(format_string($post->message, 30)), $url);
+    }
+}
+
+class oublog_portfolio_caller extends portfolio_module_caller_base {
+
+    protected $postid;
+    protected $attachment;
+
+    private $post;
+    private $keyedfiles = array(); // keyed on entry
+
+    /**
+     * @return array
+     */
+    public static function expected_callbackargs() {
+        return array(
+            'postid'       => false,
+            'attachment'   => false,
+        );
+    }
+    /**
+     * @param array $callbackargs
+     */
+    public function __construct($callbackargs) {
+        parent::__construct($callbackargs);
+        if (!$this->postid) {
+            throw new portfolio_caller_exception('mustprovidepost', 'oublog');
+        }
+    }
+    /**
+     * @global object
+     */
+    public function load_data() {
+        global $DB;
+
+        if ($this->postid) {
+            if (!$this->post = oublog_get_post($this->postid, false)) {
+                throw new portfolio_caller_exception('invalidpostid', 'oublog');
+            }
+        }
+
+        if (!$this->oubloginstance = $DB->get_record('oublog_instances', array('id'=>$this->post->oubloginstancesid))) {
+            throw new portfolio_caller_exception('postid', 'oublog');
+        }
+
+        if (!$this->oublog = $DB->get_record('oublog', array('id' => $this->oubloginstance->oublogid))) {
+            throw new portfolio_caller_exception('invalidpostid', 'oublog');
+        }
+
+        if (!$this->cm = get_coursemodule_from_instance('oublog', $this->oublog->id)) {
+            throw new portfolio_caller_exception('invalidcoursemodule');
+        }
+
+        $this->modcontext = context_module::instance($this->cm->id);
+        $fs = get_file_storage();
+        $files = array();
+        $attach = $fs->get_area_files($this->modcontext->id, 'mod_oublog', 'attachment', $this->post->id);
+        $embed = $fs->get_area_files($this->modcontext->id, 'mod_oublog', 'message', $this->post->id);
+        if (!empty($this->post->comments)) {
+            foreach ($this->post->comments as $comment) {
+                $comments = $fs->get_area_files($this->modcontext->id, 'mod_oublog',
+                        'messagecomment', $comment->id);
+                $files = array_merge($files, $comments);
+            }
+        }
+        $files = array_merge($attach, $embed, $files);
+        $this->set_file_and_format_data($files);
+        if (!empty($this->multifiles)) {
+            $this->keyedfiles[$this->post->id] = $this->multifiles;
+        } else if (!empty($this->singlefile)) {
+            $this->keyedfiles[$this->post->id] = array($this->singlefile);
+        }
+        if (empty($this->multifiles) && !empty($this->singlefile)) {
+            $this->multifiles = array($this->singlefile); // copy_files workaround
+        }
+        // depending on whether there are files or not, we might have to change richhtml/plainhtml
+        if (!empty($this->multifiles)) {
+            $this->add_format(PORTFOLIO_FORMAT_RICHHTML);
+        } else {
+            $this->add_format(PORTFOLIO_FORMAT_PLAINHTML);
+        }
+    }
+
+    /**
+     * @global object
+     * @return string
+     */
+    public function get_return_url() {
+        global $CFG;
+        return $CFG->wwwroot . '/mod/oublog/viewpost.php?post=' . $this->post->id;
+    }
+    /**
+     * @global object
+     * @return array
+     */
+    public function get_navigation() {
+        global $CFG;
+        $title = '';
+        if (!empty($this->post->title)) {
+            $title = format_string($this->post->title);
+        } else {
+            $title = shorten_text(format_string($this->post->message, 30));
+        }
+        $navlinks = array();
+        $navlinks[] = array(
+            'name' => $title,
+            'link' => $CFG->wwwroot . '/mod/oublog/viewpost.php?post=' . $this->post->id,
+            'type' => 'title'
+        );
+        return array($navlinks, $this->cm);
+    }
+    /**
+     * either a whole discussion
+     * a single post, with or without attachment
+     * or just an attachment with no post
+     *
+     * @global object
+     * @global object
+     * @uses PORTFOLIO_FORMAT_RICH
+     * @return mixed
+     */
+    public function prepare_package() {
+        global $CFG;
+
+        $posthtml = $this->prepare_post($this->post, true);
+
+        $content = $posthtml;
+        $name = 'post.html';
+        $manifest = ($this->exporter->get('format') instanceof PORTFOLIO_FORMAT_RICH);
+        if (!empty($this->multifiles)) {
+            foreach ($this->multifiles as $f) {
+                $this->get('exporter')->copy_existing_file($f);
+            }
+        }
+        $this->get('exporter')->write_new_file($content, $name, $manifest);
+    }
+
+    /**
+     * this is a very cut down version of what is in forum_make_mail_post
+     *
+     * @global object
+     * @param int $post
+     * @return string
+     */
+    protected function prepare_post($post, $usehtmls = true) {
+        global $PAGE;
+        $output = '';
+        if ($usehtmls) {
+            $output .= '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" ' .
+                    '"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">' .
+                    html_writer::start_tag('html', array('xmlns' => 'http://www.w3.org/1999/xhtml'));
+            $output .= html_writer::tag('head',
+                    html_writer::empty_tag('meta',
+                    array('http-equiv' => 'Content-Type', 'content' => 'text/html; charset=utf-8')) .
+                    html_writer::tag('title', get_string('exportedpost', 'oublog')));
+            $output .= html_writer::start_tag('body') . "\n";
+        }
+        if (!$oublog = oublog_get_blog_from_postid($post->id)) {
+            print_error('invalidpost', 'oublog');
+        }
+        if (!$cm = get_coursemodule_from_instance('oublog', $oublog->id)) {
+            print_error('invalidcoursemodule');
+        }
+        $oublogoutput = $PAGE->get_renderer('mod_oublog');
+        $context = context_module::instance($cm->id);
+        $canmanageposts = has_capability('mod/oublog:manageposts', $context);
+
+        if ($oublog->global) {
+            $blogtype = 'personal';
+        } else {
+            $blogtype = 'course';
+        }
+        $post->allowcomments = false;
+        // Provide format from the exporter to renderers incase its required.
+        $format = $this->get('exporter')->get('format');
+        $output .= $oublogoutput->render_post($cm, $oublog, $post, false, $blogtype,
+                $canmanageposts, false, false, true, $format);
+        if (!empty($post->comments)) {
+            $output .= $oublogoutput->render_comments($post, $oublog, false, false, true, $cm, $format);
+        }
+        if ($usehtmls) {
+            $output .= html_writer::end_tag('body') . html_writer::end_tag('html');
+        }
+        return $output;
+    }
+    /**
+     * @return string
+     */
+    public function get_sha1() {
+        $filesha = '';
+        try {
+            $filesha = $this->get_sha1_file();
+        } catch (portfolio_caller_exception $e) {
+            // No files.
+        }
+
+        return sha1($filesha . ',' . $this->post->title . ',' . $this->post->message);
+    }
+
+    public function expected_time() {
+        return $this->expected_time_file();
+    }
+    /**
+     * @uses CONTEXT_MODULE
+     * @return bool
+     */
+    public function check_permissions() {
+        $context = context_module::instance($this->cm->id);
+        return (has_capability('mod/oublog:exportpost', $context)
+            || ($this->oubloginstance->userid == $this->user->id
+                && has_capability('mod/oublog:exportownpost', $context)));
+    }
+    /**
+     * @return string
+     */
+    public static function display_name() {
+        return get_string('modulename', 'oublog');
+    }
+
+    public static function base_supported_formats() {
+        return array(PORTFOLIO_FORMAT_FILE, PORTFOLIO_FORMAT_RICHHTML, PORTFOLIO_FORMAT_PLAINHTML);
+    }
+}
+
+/**
+ * Returns html for a search form for the nav bar
+ * @param string $name blog identifier field e.g. id
+ * @param string $value blog identifier value e.g. 266
+ * @param string $strblogsearch search this blog text
+ * @param string $querytext optional search term
+ * @returns string html
+ */
+function oublog_get_search_form($name, $value, $strblogsearch, $querytext='') {
+    if (!oublog_search_installed()) {
+        return '';
+    }
+    global $OUTPUT;
+    $out = html_writer::start_tag('form', array('action' => 'search.php', 'method' => 'get'));
+    $out .= html_writer::start_tag('div');
+    $out .= html_writer::tag('label', $strblogsearch . ' ', array('for' => 'oublog_searchquery'));
+    $out .= $OUTPUT->help_icon('searchblogs', 'oublog');
+    $out .= html_writer::empty_tag('input', array('type' => 'hidden', 'name' => $name,
+            'value' => $value));
+    $out .= html_writer::empty_tag('input', array('type' => 'text', 'name' => 'query',
+            'id' => 'oublog_searchquery', 'value' => $querytext));
+    $out .= html_writer::empty_tag('input', array('type' => 'image',
+            'id' => 'ousearch_searchbutton', 'alt' => get_string('search'),
+            'title' => get_string('search'), 'src' => $OUTPUT->pix_url('i/search')));
+    $out .= html_writer::end_tag('div');
+    $out .= html_writer::end_tag('form');
+    return $out;
+}
+
+/**
+ * Checks what level of participation the currently
+ * logged in user can view
+ *
+ * @param object $course current course object
+ * @param object $oublog current oublog object
+ * @param object $cm current course module object
+ * @param int $groupid optional group id term
+ */
+function oublog_can_view_participation($course, $oublog, $cm, $groupid=0) {
+    global $USER;
+
+    // no participation at all on global blogs
+    if ($oublog->global == 1) {
+        return OUBLOG_NO_PARTICIPATION;
+    }
+
+    $context = context_module::instance($cm->id);
+
+    $groupmode = groups_get_activity_groupmode($cm, $course);
+    $allowgroup =
+            ($groupmode == NOGROUPS || $groupmode == VISIBLEGROUPS)
+            || (has_capability('moodle/site:accessallgroups', $context))
+            || (groups_is_member($groupid, $USER->id));
+
+    if (has_capability('mod/oublog:viewparticipation', $context)
+        && $allowgroup
+        && (($oublog->individual == OUBLOG_VISIBLE_INDIVIDUAL_BLOGS
+        || $oublog->individual == OUBLOG_NO_INDIVIDUAL_BLOGS)
+        || has_capability('mod/oublog:viewindividual', $context))) {
+        return OUBLOG_USER_PARTICIPATION;
+    } else if ((has_capability('mod/oublog:post', $context)
+        || has_capability('mod/oublog:comment', $context))
+        && $allowgroup) {
+        return OUBLOG_MY_PARTICIPATION;
+    }
+
+    return OUBLOG_NO_PARTICIPATION;
+}
+
+/**
+ * Checks if current user is allowed to grade the given blog.
+ * @param object $course Moodle course object
+ * @param object $oublog Row from oublog table
+ * @param object $cm Course-module object
+ * @param int $groupid Optional group id
+ * @return bool True if you can grade the blog
+ */
+function oublog_can_grade($course, $oublog, $cm, $groupid=0) {
+    global $USER;
+
+    // Cannot grade if blog has grading turned off
+    if ($oublog->grading == OUBLOG_NO_GRADING) {
+        return false;
+    }
+
+    // Cannot grade if you do not have the capability
+    $context = context_module::instance($cm->id);
+    if (!has_capability('mod/oublog:grade', $context)) {
+        return false;
+    }
+
+    // Grading is a 'write' activity so you can only do it for your own
+    // group unless you have accessallgroups
+    $groupmode = groups_get_activity_groupmode($cm, $course);
+    $ok = $groupmode == NOGROUPS ||
+            has_capability('moodle/site:accessallgroups', $context) ||
+            ($groupid && groups_is_member($groupid, $USER->id));
+    return $ok;
+}
+
+/**
+ * Returns information about the participation of users in this blog.
+ *
+ * @param object $oublog current oublog object
+ * @param object $context current context
+ * @param int $groupid optional group id term
+ * @param object $cm course-module object
+ * @param object $course current course object
+ * @param int $start optional start date
+ * @param int $end optional end date
+ * @param string $sort optional string to sort users by fields
+ * @return array user participation
+ */
+function oublog_get_participation($oublog, $context, $groupid = 0, $cm,
+    $course, $start = null, $end = null, $sort = 'u.firstname,u.lastname') {
+    global $DB;
+
+    // get user objects
+    list($esql, $params) = get_enrolled_sql($context, 'mod/oublog:post', $groupid);
+    $fields = user_picture::fields('u');
+    $fields .= ',u.username,u.idnumber';
+    $sql = "SELECT $fields
+                FROM {user} u
+                JOIN ($esql) eu ON eu.id = u.id
+                ORDER BY $sort ASC";
+    $users = $DB->get_records_sql($sql, $params);
+    if (empty($users)) {
+        return array();
+    }
+    if ($oublog->individual > 0) {
+        $groupid = 0;
+    }
+    $postswhere = ' WHERE bi.userid IN (' . implode(',', array_keys($users)) .')';
+    $commentswhere = ' WHERE c.userid IN (' . implode(',', array_keys($users)) .')';
+
+    $groupcheck = $groupid ? 'AND groupid = :groupid' : '';
+
+    $period = $cperiod = '';
+    if ($start) {
+        $period = 'AND timeposted > :timestart';
+    }
+    if ($end) {
+        $period .= ' AND timeposted < :timeend';
+    }
+
+    $postssql = 'SELECT bi.userid, p.posts
+        FROM {oublog_instances} bi
+        LEFT OUTER JOIN (
+            SELECT oubloginstancesid, COUNT(id) as posts
+            FROM {oublog_posts}
+            WHERE timedeleted IS NULL ' . $groupcheck . $period . '
+            GROUP BY oubloginstancesid
+        ) p ON p.oubloginstancesid = bi.id' .
+        $postswhere .
+        ' AND bi.oublogid = :oublogid';
+
+    if ($start) {
+        $cperiod = 'AND c.timeposted > :timestart';
+    }
+    if ($end) {
+        $cperiod .= ' AND c.timeposted < :timeend';
+    }
+
+    $commentssql = 'SELECT c.userid, COUNT(c.id) AS comments
+        FROM {oublog_comments} c, {oublog_instances} bi ' .
+        $commentswhere .
+        ' AND c.postid IN (
+            SELECT id
+            FROM {oublog_posts}
+            WHERE oubloginstancesid = bi.id ' . $groupcheck . $cperiod . '
+            AND timedeleted IS NULL
+        )
+        AND c.timedeleted IS NULL
+        AND bi.oublogid = :oublogid GROUP BY c.userid';
+    $params['oublogid'] = $oublog->id;
+    $params['groupid'] = $groupid;
+    $params['timestart'] = $start;
+    $params['timeend'] = $end;
+
+    // get all user post information
+    $posts = $DB->get_records_sql($postssql, $params);
+
+    // get all user comment information
+    $comments = $DB->get_records_sql($commentssql, $params);
+
+    if (!empty($users)) {
+        // is grading enabled and available for the current user
+        $gradinginfo = null;
+        if (oublog_can_grade($course, $oublog, $cm, $groupid)) {
+            $gradinginfo = grade_get_grades($course->id, 'mod',
+                'oublog', $oublog->id, array_keys($users));
+        }
+
+        foreach ($users as $user) {
+            if (!empty($posts) && isset($posts[$user->id])) {
+                $user->posts = $posts[$user->id]->posts;
+            }
+            if (!empty($comments) && isset($comments[$user->id])) {
+                $user->comments = $comments[$user->id]->comments;
+            }
+            if ($gradinginfo && !empty($gradinginfo->items[0]->grades)) {
+                if (isset($gradinginfo->items[0]->grades[$user->id])) {
+                    $user->gradeobj = $gradinginfo->items[0]->grades[$user->id];
+                }
+            }
+        }
+    }
+
+    return $users;
+}
+
+/**
+ * Returns user participation to view in userparticipation.php
+ *
+ * @param object $oublog current oublog object
+ * @param object $context current context
+ * @param int $userid required userid term for participation being viewed
+ * @param int $groupid optional group id term
+ * @param object $cm course-module object
+ * @param object $course current course object
+ * @param int $start optional start date
+ * @param int $end optional end date
+ * @param bool $getposts Return post data
+ * @param bool $getcomments Return comment data
+ * @param int $limitfrom limit posts/comments from
+ * @param int $limitnum number of posts/comments (data only) to limit to
+ * @param bool $getgrades return grade info
+ * @return array user participation
+ */
+function oublog_get_user_participation($oublog, $context,
+        $userid, $groupid = 0, $cm, $course, $start = null, $end = null,
+        $getposts = true, $getcomments = true, $limitfrom = null, $limitnum = null, $getgrades = false) {
+    global $DB;
+    $testgroupid = $groupid;
+    if ($oublog->individual > 0) {
+        $testgroupid = 0;
+    }
+    $groupcheck = $testgroupid ? 'AND groupid = :groupid' : '';
+    $period = $cperiod = '';
+    if ($start) {
+        $period = 'AND timeposted > :timestart ';
+    }
+    if ($end) {
+        $period .= 'AND timeposted < :timeend ';
+    }
+
+    $postssql = 'SELECT id, title, message, timeposted
+        FROM {oublog_posts}
+        WHERE oubloginstancesid = (
+            SELECT id
+            FROM {oublog_instances}
+            WHERE oublogid = :oublogid AND userid = :userid
+        )
+        AND timedeleted IS NULL ' . $groupcheck . $period;
+    $postsqlorder = ' ORDER BY timeposted DESC';
+
+    if ($start) {
+        $cperiod = 'AND c.timeposted > :timestart ';
+    }
+    if ($end) {
+        $cperiod .= 'AND c.timeposted < :timeend ';
+    }
+    $authornamefields = get_all_user_name_fields(true, 'a');
+    $postauthornamefields = get_all_user_name_fields(true, 'pa', '', 'poster');
+    $commentssql = 'SELECT c.id, c.postid, c.title, c.message, c.timeposted,
+        a.id AS authorid, ' . $authornamefields . ',' . $postauthornamefields . ',
+        p.title AS posttitle, p.timeposted AS postdate
+        FROM {user} a, {oublog_comments} c
+            INNER JOIN {oublog_posts} p ON (c.postid = p.id)
+            INNER JOIN {oublog_instances} bi ON (bi.id = p.oubloginstancesid)
+            INNER JOIN {user} pa on bi.userid = pa.id
+        WHERE bi.oublogid = :oublogid AND a.id = bi.userid
+        AND p.timedeleted IS NULL ' . $groupcheck . $cperiod . '
+        AND c.userid = :userid AND c.timedeleted IS NULL';
+    $commentsqlorder = ' ORDER BY c.timeposted DESC';
+    $params = array(
+        'oublogid' => $oublog->id,
+        'userid' => $userid,
+        'groupid' => $testgroupid,
+        'timestart' => $start,
+        'timeend' => $end
+    );
+
+    $fields = user_picture::fields();
+    $fields .= ',username,idnumber';
+    $user = $DB->get_record('user', array('id' => $userid), $fields, MUST_EXIST);
+    $participation = new stdClass();
+    $participation->user = $user;
+    $participation->numposts = $DB->get_field_sql("SELECT COUNT(1) FROM ($postssql) as p", $params);
+    if ($getposts) {
+        $participation->posts = $DB->get_records_sql($postssql . $postsqlorder, $params, $limitfrom, $limitnum);
+    } else {
+        $participation->posts = array();
+    }
+    $participation->numcomments = $DB->get_field_sql("SELECT COUNT(1) FROM ($commentssql) as p", $params);
+    if ($getcomments) {
+        $participation->comments = $DB->get_records_sql($commentssql . $commentsqlorder, $params, $limitfrom, $limitnum);
+    } else {
+        $participation->comments = array();
+    }
+    if ($getgrades && oublog_can_grade($course, $oublog, $cm, $groupid)) {
+        $gradinginfo = grade_get_grades($course->id, 'mod',
+            'oublog', $oublog->id, array($userid));
+        $participation->gradeobj = $gradinginfo->items[0]->grades[$userid];
+    }
+    return $participation;
+}
+
+/**
+ * Grades users from the participation.php page
+ *
+ * @param array $newgrades array of grade records to update
+ * @param array $oldgrades array of old grade records to check
+ * @param object $cm current course module object
+ * @param object $oublog current oublog object
+ * @param object $course current course object
+ */
+function oublog_update_manual_grades($newgrades, $oldgrades, $cm, $oublog, $course) {
+    global $CFG, $SESSION;
+
+    require_once($CFG->libdir.'/gradelib.php');
+
+    $grades = array();
+    foreach ($oldgrades as $key => $user) {
+        if (array_key_exists($key, $newgrades)) {
+            if (empty($user->gradeobj->grade)
+                || ($newgrades[$key] != $user->gradeobj->grade)) {
+                $grade = new StdClass;
+                $grade->userid = $key;
+                $grade->dategraded = time();
+                if ($newgrades[$key] == -1) {
+                    // no grade
+                    $grade->rawgrade = null;
+                } else {
+                    $grade->rawgrade = $newgrades[$key];
+                }
+                $oublog->cmidnumber = $cm->id;
+
+                $grades[$key] = $grade;
+            }
+        }
+    }
+    oublog_grade_item_update($oublog, $grades);
+
+    // Add a message to display to the page.
+    if (!isset($SESSION->oubloggradesupdated)) {
+        $SESSION->oubloggradesupdated = get_string('gradesupdated', 'oublog');
+    }
+}
+
+// Blog 'discovery'/stats functions.
+/**
+ * Generates oublog visitor statistics output.
+ * @param object $oublog
+ * @param object $cm
+ * @param mod_oublog_renderer $renderer
+ * @param bool $ajax true to return data object rather than html
+ */
+function oublog_stats_output_visitstats($oublog, $cm, $renderer = null, $ajax = false) {
+    global $PAGE, $DB;
+    if (!$renderer) {
+        $renderer = $PAGE->get_renderer('mod_oublog');
+    }
+    // This is only for personal blogs (can't support course, individual or group blogs).
+    if (!$oublog->global || ($oublog->global && ($oublog->individual != OUBLOG_NO_INDIVIDUAL_BLOGS
+            || $cm->groupmode != NOGROUPS))) {
+        return;
+    }
+    if (isset($_POST['timefilter_visitstats']) && isloggedin()) {
+        // Get the posted form value to set user pref (do this from post as need to to init form).
+        set_user_preference('mod_oublog_visitformfilter', $_POST['timefilter_visitstats']);
+    }
+
+    $default = get_user_preferences('mod_oublog_visitformfilter', OUBLOG_STATS_TIMEFILTER_MONTH);
+
+    // Create time filter options form.
+    $customdata = array(
+            'options' => array(OUBLOG_STATS_TIMEFILTER_ALL => get_string('timefilter_alltime', 'oublog'),
+                    OUBLOG_STATS_TIMEFILTER_MONTH => get_string('activeblogs', 'oublog')),
+            'default' => $default,
+            'type' => 'visitstats',
+            );
+    if ($oublog->global && $curindividual = optional_param('user', 0, PARAM_INT)) {
+        $customdata['params']['user'] = $curindividual;
+    }
+    if (!$oublog->global) {
+        $customdata['cmid'] = $cm->id;
+    }
+
+    $timefilter = new oublog_stats_timefilter_form(null, $customdata);
+
+    // First, get the stats for this blog.
+    list($filtertime, $filterselected) = $timefilter->get_selected_time($default);
+
+    if ($filtertime == 0) {
+        // No time filter - just get instances from table.
+        if ($oublog->global && $excludedlist = get_config('mod_oublog', 'globalusageexclude')) {
+            // There are user ids to exclude in the global blog stats.
+            $sql = 'SELECT * from {oublog_instances} WHERE oublogid =? AND views >0';
+            $params = array($oublog->id);
+            list($insql, $inparams) = $DB->get_in_or_equal(explode(',', $excludedlist),
+                    SQL_PARAMS_QM, 'param', false);
+            $sql .= " AND userid $insql";
+            $params = array_merge($params, $inparams);
+            $sql .= ' order by views DESC, name ASC';
+            $blogs = $DB->get_records_sql($sql, $params, 0, 5);
+        } else {
+            $blogs = $DB->get_records_select('oublog_instances', 'oublogid =? AND views >0',
+                    array($oublog->id), 'views DESC, name ASC', '*', 0, 5);
+        }
+    } else {
+        // Time filter - get instances from sub-query based on matching post criteria.
+        $sql = 'SELECT bi.* FROM {oublog_instances} bi
+            WHERE bi.id IN (
+                (SELECT bi2.id FROM {oublog_instances} bi2
+                JOIN {oublog_posts} p on p.oubloginstancesid = bi2.id
+                JOIN {user} u on u.id = bi2.userid
+                WHERE bi2.oublogid = ?
+                AND bi2.views > 0
+                AND p.deletedby IS NULL AND p.timeposted >= ?';
+        $params = array($oublog->id, $filtertime);
+        if ($oublog->global || ($oublog->maxvisibility == OUBLOG_VISIBILITY_PUBLIC && !isloggedin())) {
+            // Only include visible posts on global blogs and public blogs when not logged in.
+            $sql .= 'AND p.visibility >= ? ';
+            if (!isloggedin()) {
+                $params[] = OUBLOG_VISIBILITY_PUBLIC;
+            } else {
+                $params[] = OUBLOG_VISIBILITY_LOGGEDINUSER;
+            }
+        }
+        if ($oublog->global) {
+            if ($excludedlist = get_config('mod_oublog', 'globalusageexclude')) {
+                // There are user ids to exclude in the global blog stats.
+                list($insql, $inparams) = $DB->get_in_or_equal(explode(',', $excludedlist),
+                        SQL_PARAMS_QM, 'param', false);
+                $sql .= " AND bi2.userid $insql";
+                $params = array_merge($params, $inparams);
+            }
+        }
+        $sql .= ' GROUP BY bi2.id)) ORDER BY bi.views DESC, bi.name ASC';
+        $blogs = $DB->get_records_sql($sql, $params, 0, 5);
+    }
+    // Generate content data ready to send to renderer.
+    $maintitle = get_string('visits', 'oublog');// The title of the 'section';
+    if ($filterselected == OUBLOG_STATS_TIMEFILTER_ALL) {
+        $title = get_string('timefilter_alltime', 'oublog');// Sub-heading.
+        $info = get_string('visits_info_alltime', 'oublog', oublog_get_displayname($oublog, true));
+    } else {
+        $title = get_string('activeblogs', 'oublog');// Sub-heading.
+        $info = get_string('visits_info_active', 'oublog', oublog_get_displayname($oublog));
+    }
+    $content = '';
+    if ($blogs) {
+        $maxnum = reset($blogs)->views;
+        foreach ($blogs as $blog) {
+            // Create the stat view for the blog.
+            $percent = $blog->views / $maxnum * 100;
+            $stat = get_string('numberviews', 'oublog', number_format($blog->views));
+            if ($oublog->global) {
+                $url = new moodle_url('/mod/oublog/view.php', array('user' => $blog->userid));
+            } else {
+                $url = new moodle_url('/mod/oublog/view.php',
+                        array('id' => $cm->id, 'individual' => $blog->userid));
+            }
+            $user = $DB->get_record('user', array('id' => $blog->userid));
+            if ($blog->name == '') {
+                $a = (object) array('name' => fullname($user),
+                        'displayname' => oublog_get_displayname($oublog));
+                $blog->name = get_string('defaultpersonalblogname', 'oublog', $a);
+            }
+            $label = html_writer::link($url, $blog->name);
+            $statinfo = new oublog_statsinfo($user, $percent, $stat, $url, $label);
+            $content .= $renderer->render($statinfo);
+        }
+    }
+
+    return $renderer->render_stats_view('visitstats', $maintitle, $content, $title, $info, $timefilter, $ajax);
+}
+/**
+ * Generates oublog most posts statistics output.
+ * @param object $oublog
+ * @param object $cm
+ * @param mod_oublog_renderer $renderer
+ * @param bool $ajax true to return data object rather than html
+ */
+function oublog_stats_output_poststats($oublog, $cm, $renderer = null, $ajax = false) {
+    global $PAGE, $DB;
+    if (!$renderer) {
+        $renderer = $PAGE->get_renderer('mod_oublog');
+    }
+    // This is only for personal blogs, visible individual blogs, visible group blogs.
+    if (!$oublog->global && ($oublog->individual == OUBLOG_SEPARATE_INDIVIDUAL_BLOGS ||
+            ($oublog->individual == OUBLOG_NO_INDIVIDUAL_BLOGS && $cm->groupmode <= SEPARATEGROUPS))) {
+        return;
+    }
+
+    $curgroup = -1;
+    if ($cm->groupmode > NOGROUPS) {
+        // Get currently viewed group.
+        $curgroup = optional_param('curgroup', oublog_get_activity_group($cm), PARAM_INT);
+    }
+
+    if (isset($_POST['timefilter_poststats']) && isloggedin()) {
+        // Get the posted form value to set user pref (do this from post as need to to init form).
+        set_user_preference('mod_oublog_postformfilter', $_POST['timefilter_poststats']);
+    }
+    $default = get_user_preferences('mod_oublog_postformfilter', OUBLOG_STATS_TIMEFILTER_MONTH);
+
+    // Create time filter options form.
+    $customdata = array(
+            'options' => array(
+                    OUBLOG_STATS_TIMEFILTER_ALL => get_string('timefilter_alltime', 'oublog'),
+                    OUBLOG_STATS_TIMEFILTER_YEAR => get_string('timefilter_thisyear', 'oublog'),
+                    OUBLOG_STATS_TIMEFILTER_MONTH => get_string('timefilter_thismonth', 'oublog')),
+            'default' => $default,
+            'type' => 'poststats',
+            'params' => array('curgroup', $curgroup)
+    );
+    if ($oublog->global && $curindividual = optional_param('user', 0, PARAM_INT)) {
+        $customdata['params']['user'] = $curindividual;
+    }
+    if (!$oublog->global) {
+        $customdata['cmid'] = $cm->id;
+    }
+
+    $timefilter = new oublog_stats_timefilter_form(null, $customdata);
+
+    // First, get the stats for this blog.
+    list($filtertime, $filterselected) = $timefilter->get_selected_time($default);
+
+    $listgroups = false;
+    if (!$oublog->global && $cm->groupmode == VISIBLEGROUPS &&
+            $oublog->individual == OUBLOG_NO_INDIVIDUAL_BLOGS) {
+        // We show groups rather than individuals (Visible groups set).
+        $listgroups = true;
+    }
+
+    if ($listgroups) {
+        // Get group posts, not individuals.
+        $params = array($oublog->id, $filtertime);
+        $sql = "SELECT p.groupid, count(p.id) as posts
+                    FROM {oublog_posts} p
+                    JOIN {oublog_instances} bi on p.oubloginstancesid = bi.id
+                    JOIN {groups} as g on g.id = p.groupid
+                    WHERE bi.oublogid = ?
+                    AND p.deletedby IS NULL AND p.timeposted >= ?
+                    AND p.groupid > 0
+                    GROUP BY p.groupid
+                    ORDER BY posts DESC";
+    } else {
+        $subwhere = '';
+        $extrajoin = '';
+        $params = array($oublog->id, $filtertime);
+        if ($oublog->global || ($oublog->maxvisibility == OUBLOG_VISIBILITY_PUBLIC && !isloggedin())) {
+            // Only include visible posts on global blogs and public blogs when not logged in.
+            $subwhere .= 'AND p.visibility >= ? ';
+            if (!isloggedin()) {
+                $params[] = OUBLOG_VISIBILITY_PUBLIC;
+            } else {
+                $params[] = OUBLOG_VISIBILITY_LOGGEDINUSER;
+            }
+        }
+        if (!$oublog->global && $cm->groupmode != NOGROUPS && $curgroup > 0 &&
+                $oublog->individual > OUBLOG_NO_INDIVIDUAL_BLOGS) {
+            // Selected a group in an individual blog - get users in that group to filter results.
+            if ($users = groups_get_members($curgroup, 'u.id')) {
+                list($insql, $inparams) = $DB->get_in_or_equal(array_keys($users));
+                $subwhere .= " AND bi2.userid $insql";
+                $params = array_merge($params, $inparams);
+            } else {
+                // No users in this group! Hack to return nothing.
+                $subwhere .= " AND bi2.userid IS NULL";
+            }
+        } else {
+            if ($oublog->global) {
+                if ($excludedlist = get_config('mod_oublog', 'globalusageexclude')) {
+                    // There are user ids to exclude in the global blog stats.
+                    list($insql, $inparams) = $DB->get_in_or_equal(explode(',', $excludedlist),
+                            SQL_PARAMS_QM, 'param', false);
+                    $subwhere .= " AND bi2.userid $insql";
+                    $params = array_merge($params, $inparams);
+                }
+            }
+            // Not getting specific user(s) so join user table to ensure they still exist in system.
+            $extrajoin .= 'JOIN {user} u on u.id = bi2.userid';
+        }
+        // Time filter - get instances from sub query based on matching post criteria.
+        $sql = "SELECT bi.*, pos.posts
+        FROM {oublog_instances} bi
+        JOIN (SELECT p.oubloginstancesid, count(p.id) as posts
+              FROM {oublog_posts} p
+              JOIN {oublog_instances} bi2 on bi2.id = p.oubloginstancesid
+              $extrajoin
+              WHERE bi2.oublogid = ?
+              AND p.deletedby IS NULL AND p.timeposted >= ? $subwhere
+              GROUP BY p.oubloginstancesid
+        ) as pos on pos.oubloginstancesid = bi.id
+        ORDER BY posts DESC";
+    }
+    $blogs = $DB->get_records_sql($sql, $params, 0, 5);
+
+    // Generate content data ready to send to renderer.
+    $maintitle = get_string('mostposts', 'oublog');// The title of the 'section';
+    switch ($filterselected) {
+        case OUBLOG_STATS_TIMEFILTER_ALL:
+            $title = get_string('timefilter_alltime', 'oublog');// Sub-heading.
+            $info = get_string('posts_info_alltime', 'oublog', oublog_get_displayname($oublog, true));
+            break;
+        case OUBLOG_STATS_TIMEFILTER_YEAR:
+            $title = get_string('timefilter_thisyear', 'oublog');// Sub-heading.
+            $info = get_string('posts_info_thisyear', 'oublog', oublog_get_displayname($oublog, true));
+            break;
+        case OUBLOG_STATS_TIMEFILTER_MONTH:
+            $title = get_string('timefilter_thismonth', 'oublog');// Sub-heading.
+            $info = get_string('posts_info_thismonth', 'oublog', oublog_get_displayname($oublog, true));
+            break;
+    }
+    $content = '';
+    if ($blogs) {
+        $maxnum = reset($blogs)->posts;
+        foreach ($blogs as $blog) {
+            // Create the stat view for the blog.
+            $percent = $blog->posts / $maxnum * 100;
+            $stat = get_string('numberposts', 'oublog', number_format($blog->posts));
+            if ($oublog->global) {
+                $url = new moodle_url('/mod/oublog/view.php', array('user' => $blog->userid));
+            } else if ($listgroups && isset($blog->groupid)) {
+                $url = new moodle_url('/mod/oublog/view.php',
+                        array('id' => $cm->id, 'group' => $blog->groupid));
+            } else {
+                $urlparams = array('id' => $cm->id, 'individual' => $blog->userid);
+                if ($curgroup != -1) {
+                    $urlparams['group'] = $curgroup;
+                }
+                $url = new moodle_url('/mod/oublog/view.php', $urlparams);
+            }
+            if ($listgroups && isset($blog->groupid)) {
+                // We are reffering to a group, not a user.
+                $user = $DB->get_record('groups', array('id' => $blog->groupid));
+                $a = (object) array('name' => $user->name,
+                        'displayname' => oublog_get_displayname($oublog));
+                $blog->name = format_string(get_string('defaultpersonalblogname', 'oublog', $a));
+            } else {
+                $user = $DB->get_record('user', array('id' => $blog->userid));
+                if ($blog->name == '') {
+                    $a = (object) array('name' => fullname($user),
+                            'displayname' => oublog_get_displayname($oublog));
+                    $blog->name = get_string('defaultpersonalblogname', 'oublog', $a);
+                }
+            }
+            $label = html_writer::link($url, $blog->name);
+            $statinfo = new oublog_statsinfo($user, $percent, $stat, $url, $label);
+            $content .= $renderer->render($statinfo);
+        }
+    }
+
+    return $renderer->render_stats_view('poststats', $maintitle, $content, $title, $info, $timefilter, $ajax);
+}
+/**
+ * Generates oublog most number of comments statistics output.
+ * @param object $oublog
+ * @param object $cm
+ * @param mod_oublog_renderer $renderer
+ * @param bool $ajax true to return data object rather than html
+ */
+function oublog_stats_output_commentstats($oublog, $cm, $renderer = null, $ajax = false) {
+    global $PAGE, $DB;
+    if (!$renderer) {
+        $renderer = $PAGE->get_renderer('mod_oublog');
+    }
+    // This is only for personal blogs, visible individual blogs, visible group blogs.
+    if ($oublog->allowcomments == OUBLOG_COMMENTS_PREVENT ||
+            $oublog->individual == OUBLOG_SEPARATE_INDIVIDUAL_BLOGS ||
+            (!$oublog->global && $oublog->individual == OUBLOG_NO_INDIVIDUAL_BLOGS &&
+                    $cm->groupmode <= SEPARATEGROUPS)) {
+        return;
+    }
+
+    $curgroup = -1;
+    if ($cm->groupmode > NOGROUPS) {
+        // Get currently viewed group.
+        $curgroup = optional_param('curgroup', oublog_get_activity_group($cm), PARAM_INT);
+    }
+
+    if (isset($_POST['timefilter_commentstats']) && isloggedin()) {
+        // Get the posted form value to set user pref (do this from post as need to to init form).
+        set_user_preference('mod_oublog_commentformfilter', $_POST['timefilter_commentstats']);
+    }
+    $default = get_user_preferences('mod_oublog_commentformfilter', OUBLOG_STATS_TIMEFILTER_MONTH);
+
+    // Create time filter options form.
+    $customdata = array(
+            'options' => array(OUBLOG_STATS_TIMEFILTER_ALL => get_string('timefilter_alltime', 'oublog'),
+                    OUBLOG_STATS_TIMEFILTER_YEAR => get_string('timefilter_thisyear', 'oublog'),
+                    OUBLOG_STATS_TIMEFILTER_MONTH => get_string('timefilter_thismonth', 'oublog')),
+            'default' => $default,
+            'type' => 'commentstats',
+            'params' => array('curgroup', $curgroup)
+    );
+    if ($oublog->global && $curindividual = optional_param('user', 0, PARAM_INT)) {
+        $customdata['params']['user'] = $curindividual;
+    }
+    if (!$oublog->global) {
+        $customdata['cmid'] = $cm->id;
+    }
+
+    $timefilter = new oublog_stats_timefilter_form(null, $customdata);
+
+    // First, get the stats for this blog.
+    list($filtertime, $filterselected) = $timefilter->get_selected_time($default);
+
+    $listgroups = false;
+    if (!$oublog->global && $cm->groupmode == VISIBLEGROUPS &&
+            $oublog->individual == OUBLOG_NO_INDIVIDUAL_BLOGS) {
+        // We show groups rather than individuals.
+        $listgroups = true;
+    }
+
+    if ($listgroups) {
+        // Get group posts, not individuals.
+        $sql = 'SELECT p.groupid, count(c.id) as comments
+            FROM {oublog_comments} c
+            JOIN {oublog_posts} p on p.id = c.postid
+            JOIN {oublog_instances} bi on p.oubloginstancesid = bi.id
+            JOIN {groups} as g on g.id = p.groupid
+            WHERE bi.oublogid = ?
+            AND p.groupid > 0
+            AND p.deletedby IS NULL
+            AND p.allowcomments > ?
+            AND c.deletedby IS NULL AND c.timeposted >= ? AND c.userid <> bi.userid
+            GROUP BY p.groupid
+            ORDER BY comments DESC';
+        $params = array($oublog->id, OUBLOG_COMMENTS_PREVENT, $filtertime);
+    } else {
+        $subwhere = '';
+        $extrajoin = '';
+        $params = array($oublog->id, OUBLOG_COMMENTS_PREVENT);
+        if ($oublog->global || ($oublog->maxvisibility == OUBLOG_VISIBILITY_PUBLIC && !isloggedin())) {
+            // Only include visible posts on global blogs and public blogs when not logged in.
+            $subwhere .= 'AND p.visibility >= ? ';
+            if (!isloggedin()) {
+                $params[] = OUBLOG_VISIBILITY_PUBLIC;
+            } else {
+                $params[] = OUBLOG_VISIBILITY_LOGGEDINUSER;
+            }
+        }
+        if (!$oublog->global && $cm->groupmode != NOGROUPS && $curgroup > 0 &&
+                $oublog->individual > OUBLOG_NO_INDIVIDUAL_BLOGS) {
+            // Selected a group in an individual blog - get users in that group to filter results.
+            if ($users = groups_get_members($curgroup, 'u.id')) {
+                list($insql, $inparams) = $DB->get_in_or_equal(array_keys($users));
+                $subwhere .= " AND bi2.userid $insql";
+                $params = array_merge($params, $inparams);
+            } else {
+                // No users in this group! Hack to return nothing.
+                $subwhere .= " AND bi2.userid IS NULL";
+            }
+        } else {
+            if ($oublog->global) {
+                if ($excludedlist = get_config('mod_oublog', 'globalusageexclude')) {
+                    // There are user ids to exclude in the global blog stats.
+                    list($insql, $inparams) = $DB->get_in_or_equal(explode(',', $excludedlist),
+                            SQL_PARAMS_QM, 'param', false);
+                    $subwhere .= " AND bi2.userid $insql";
+                    $params = array_merge($params, $inparams);
+                }
+            }
+            // Not getting specific user(s) so join user table to ensure they still exist in system.
+            $extrajoin .= 'JOIN {user} u on u.id = bi2.userid';
+        }
+        $params[] = $filtertime;
+        // Time filter - get instances from sub query based on matching post criteria.
+        $sql = "SELECT bi.*, pos.comments
+        FROM {oublog_instances} bi
+        JOIN (SELECT p.oubloginstancesid, count(c.id) as comments
+            FROM {oublog_comments} c
+            JOIN {oublog_posts} p on p.id = c.postid
+            JOIN {oublog_instances} bi2 on bi2.id = p.oubloginstancesid
+            $extrajoin
+            WHERE bi2.oublogid = ?
+            AND p.allowcomments > ?
+            AND p.deletedby IS NULL $subwhere
+            AND c.deletedby IS NULL AND c.timeposted >= ?
+            AND (c.userid <> bi2.userid OR c.userid IS NULL)
+            GROUP BY p.oubloginstancesid
+        ) as pos on pos.oubloginstancesid = bi.id
+        ORDER BY comments DESC";
+    }
+    $blogs = $DB->get_records_sql($sql, $params, 0, 5);
+
+    // Generate content data ready to send to renderer.
+    $maintitle = get_string('mostcomments', 'oublog');// The title of the 'section';
+    switch ($filterselected) {
+        case OUBLOG_STATS_TIMEFILTER_ALL:
+            $title = get_string('timefilter_alltime', 'oublog');// Sub-heading.
+            $info = get_string('comments_info_alltime', 'oublog', oublog_get_displayname($oublog, true));
+        break;
+        case OUBLOG_STATS_TIMEFILTER_YEAR:
+            $title = get_string('timefilter_thisyear', 'oublog');// Sub-heading.
+            $info = get_string('comments_info_thisyear', 'oublog', oublog_get_displayname($oublog, true));
+                break;
+        case OUBLOG_STATS_TIMEFILTER_MONTH:
+            $title = get_string('timefilter_thismonth', 'oublog');// Sub-heading.
+            $info = get_string('comments_info_thismonth', 'oublog', oublog_get_displayname($oublog, true));
+        break;
+    }
+    $content = '';
+    if ($blogs) {
+        $maxnum = reset($blogs)->comments;
+        foreach ($blogs as $blog) {
+            // Create the stat view for the blog.
+            $percent = $blog->comments / $maxnum * 100;
+            $stat = get_string('numbercomments', 'oublog', number_format($blog->comments));
+            if ($oublog->global) {
+                $url = new moodle_url('/mod/oublog/view.php', array('user' => $blog->userid));
+            } else if ($listgroups && isset($blog->groupid)) {
+                $url = new moodle_url('/mod/oublog/view.php',
+                    array('id' => $cm->id, 'group' => $blog->groupid));
+            } else {
+                $urlparams = array('id' => $cm->id, 'individual' => $blog->userid);
+                if ($curgroup != -1) {
+                    $urlparams['group'] = $curgroup;
+                }
+                $url = new moodle_url('/mod/oublog/view.php', $urlparams);
+            }
+            if ($listgroups && isset($blog->groupid)) {
+                // We are reffering to a group, not a user.
+                $user = $DB->get_record('groups', array('id' => $blog->groupid));
+                $a = (object) array('name' => $user->name,
+                        'displayname' => oublog_get_displayname($oublog));
+                $blog->name = format_string(get_string('defaultpersonalblogname', 'oublog', $a));
+            } else {
+                $user = $DB->get_record('user', array('id' => $blog->userid));
+                if ($blog->name == '') {
+                    $a = (object) array('name' => fullname($user),
+                            'displayname' => oublog_get_displayname($oublog));
+                    $blog->name = get_string('defaultpersonalblogname', 'oublog', $a);
+                }
+            }
+            $label = html_writer::link($url, $blog->name);
+            $statinfo = new oublog_statsinfo($user, $percent, $stat, $url, $label);
+            $content .= $renderer->render($statinfo);
+        }
+    }
+
+    return $renderer->render_stats_view('commentstats', $maintitle, $content, $title, $info, $timefilter, $ajax);
+}
+/**
+ * Generates oublog most commented posts statistics output.
+ * @param object $oublog
+ * @param object $cm
+ * @param mod_oublog_renderer $renderer
+ * @param bool $ajax true to return data object rather than html
+ * @param bool $allposts true to include posts across all blogs in instance (personal blog only)
+ * @param int $curindividual User ID for current individual blog instance
+ */
+function oublog_stats_output_commentpoststats($oublog, $cm, $renderer = null, $ajax = false,
+        $allposts = false, $curindividual = -1, $globalindividual = null) {
+    global $PAGE, $DB, $USER;
+    if (!$renderer) {
+        $renderer = $PAGE->get_renderer('mod_oublog');
+    }
+    // This is not for separate individual blogs.
+    if ($oublog->allowcomments == OUBLOG_COMMENTS_PREVENT ||
+            $oublog->individual == OUBLOG_SEPARATE_INDIVIDUAL_BLOGS) {
+        return;
+    }
+    if ($oublog->global) {
+        // Only search for sent value if global blog as we only support in this.
+        $allposts = optional_param('allposts', $allposts, PARAM_BOOL);
+    }
+    $curgroup = -1;
+    if (!$allposts && $cm->groupmode > NOGROUPS) {
+        // Get currently viewed group.
+        $curgroup = optional_param('curgroup', oublog_get_activity_group($cm), PARAM_INT);
+    }
+    if (!$allposts && $oublog->individual > OUBLOG_NO_INDIVIDUAL_BLOGS) {
+        // Work out current individual.
+        $curindividual = optional_param('curindividual', $curindividual, PARAM_INT);
+    } else if ($oublog->global && !$allposts) {
+        $curindividual = optional_param('globalindividual', $globalindividual, PARAM_INT);
+        if ($curindividual == -1) {
+            // Get current user as not sent.
+            $curindividual = optional_param('user', $USER->id, PARAM_INT);
+        }
+    }
+
+    if (isset($_POST['timefilter_commentpoststats']) && isloggedin()) {
+        // Get the posted form value to set user pref (do this from post as need to to init form).
+        set_user_preference('mod_oublog_commentpostformfilter', $_POST['timefilter_commentpoststats']);
+    }
+
+    $default = get_user_preferences('mod_oublog_commentpostformfilter', OUBLOG_STATS_TIMEFILTER_MONTH);
+
+    // Create time filter options form.
+    $customdata = array(
+            'options' => array(OUBLOG_STATS_TIMEFILTER_ALL => get_string('timefilter_alltime', 'oublog'),
+                    OUBLOG_STATS_TIMEFILTER_YEAR => get_string('timefilter_thisyear', 'oublog'),
+                    OUBLOG_STATS_TIMEFILTER_MONTH => get_string('timefilter_thismonth', 'oublog')),
+            'default' => $default,
+            'type' => 'commentpoststats',
+            'params' => array(
+                    'allposts' => $allposts,
+                    'curgroup' => $curgroup,
+                    'curindividual' => $curindividual,
+                    'globalindividual' => $globalindividual
+                    )
+    );
+    if ($oublog->global && !$allposts && $curindividual != -1) {
+        $customdata['params']['user'] = $curindividual;
+    }
+    if (!$oublog->global) {
+        $customdata['cmid'] = $cm->id;
+    }
+
+    $timefilter = new oublog_stats_timefilter_form(null, $customdata);
+
+    // First, get the stats for this blog.
+    list($filtertime, $filterselected) = $timefilter->get_selected_time($default);
+
+    $instwhere = '';
+    $postwhere = '';
+    $extrajoin = '';
+    if ($cm->groupmode > NOGROUPS && $oublog->individual == OUBLOG_NO_INDIVIDUAL_BLOGS) {
+        // Join the group table so only groups that still exist included.
+        $extrajoin .= 'JOIN {groups} g on g.id = p.groupid ';
+    }
+    $params = array($oublog->id);
+    if ($curindividual > 0) {
+        $instwhere = 'AND bi2.userid = ?';
+        $params[] = $curindividual;
+    } else if ($cm->groupmode != NOGROUPS && $curgroup > 0 &&
+            $oublog->individual > OUBLOG_NO_INDIVIDUAL_BLOGS) {
+        // Selected a group in an individual blog (no user selected) - get group to filter results.
+        if ($users = groups_get_members($curgroup, 'u.id')) {
+            list($insql, $inparams) = $DB->get_in_or_equal(array_keys($users));
+            $instwhere .= " AND bi2.userid $insql";
+            $params = array_merge($params, $inparams);
+        } else {
+            // No users in this group! Hack to return nothing.
+            $instwhere .= " AND bi2.userid IS NULL";
+        }
+    } else {
+        // Not getting specific user(s) so join user table to ensure they still exist in system.
+        $extrajoin .= 'JOIN {user} u on u.id = bi2.userid';
+        if ($allposts) {
+            // Get any excluded user ids, add not in() against instance user id.
+            if ($excludedlist = get_config('mod_oublog', 'globalusageexclude')) {
+                 list($insql, $inparams) = $DB->get_in_or_equal(explode(',', $excludedlist),
+                         SQL_PARAMS_QM, 'param', false);
+                 $instwhere .= ' AND (bi2.userid ' . $insql . ')';
+                 $params = array_merge($params, $inparams);
+            }
+        }
+    }
+    $params[] = OUBLOG_COMMENTS_PREVENT;
+    if ($oublog->global || ($oublog->maxvisibility == OUBLOG_VISIBILITY_PUBLIC && !isloggedin())) {
+        // Only include visible posts on global blogs and public blogs when not logged in.
+        $postwhere .= 'AND p.visibility >= ? ';
+        if (!isloggedin()) {
+            $params[] = OUBLOG_VISIBILITY_PUBLIC;
+        } else {
+            $params[] = OUBLOG_VISIBILITY_LOGGEDINUSER;
+        }
+    }
+    if ($curgroup > 0 && $oublog->individual == OUBLOG_NO_INDIVIDUAL_BLOGS) {
+        $postwhere .= 'AND p.groupid = ?';
+        $params[] = $curgroup;
+    }
+    $params[] = $filtertime;
+    // Time filter - get instances from sub query based on matching post criteria.
+    $sql = "SELECT posts.*, bi.userid, bi.name, pos.comments
+        FROM {oublog_posts} posts
+        JOIN (SELECT p.id as pid, count(c.id) as comments
+            FROM {oublog_comments} c
+            JOIN {oublog_posts} p on p.id = c.postid
+            JOIN {oublog_instances} bi2 on bi2.id = p.oubloginstancesid
+            $extrajoin
+            WHERE bi2.oublogid = ? $instwhere
+            AND p.allowcomments > ?
+            AND p.deletedby IS NULL $postwhere
+            AND c.deletedby IS NULL AND c.timeposted >= ?
+            AND (c.userid <> bi2.userid OR c.userid IS NULL)
+            GROUP BY p.id
+        ) as pos on pos.pid = posts.id
+        JOIN {oublog_instances} bi on bi.id = posts.oubloginstancesid
+        ORDER BY pos.comments DESC, posts.title ASC, posts.id DESC";
+
+    $blogs = $DB->get_records_sql($sql, $params, 0, 5);
+
+    // Generate content data ready to send to renderer.
+    $maintitle = get_string('commentposts', 'oublog');// The title of the 'section';
+    switch ($filterselected) {
+        case OUBLOG_STATS_TIMEFILTER_ALL:
+            $title = get_string('timefilter_alltime', 'oublog');// Sub-heading.
+            $info = get_string('commentposts_info_alltime', 'oublog');
+        break;
+        case OUBLOG_STATS_TIMEFILTER_YEAR:
+            $title = get_string('timefilter_thisyear', 'oublog');// Sub-heading.
+            $info = get_string('commentposts_info_thisyear', 'oublog');
+        break;
+        case OUBLOG_STATS_TIMEFILTER_MONTH:
+            $title = get_string('timefilter_thismonth', 'oublog');// Sub-heading.
+            $info = get_string('commentposts_info_thismonth', 'oublog');
+        break;
+    }
+    $content = '';
+    if ($blogs) {
+        $maxnum = reset($blogs)->comments;
+        foreach ($blogs as $blog) {
+            // Create the stat view for the blog.
+            $percent = $blog->comments / $maxnum * 100;
+            $stat = get_string('numbercomments', 'oublog', number_format($blog->comments));
+            $url = new moodle_url('/mod/oublog/viewpost.php', array('post' => $blog->id));
+            $user = $DB->get_record('user', array('id' => $blog->userid));
+            if ($blog->name == '') {
+                // Default name.
+                $a = (object) array('name' => fullname($user),
+                        'displayname' => oublog_get_displayname($oublog));
+                $blog->name = get_string('defaultpersonalblogname', 'oublog', $a);
+            }
+            $showblogname = false;
+            if (!$oublog->global && $oublog->individual == OUBLOG_NO_INDIVIDUAL_BLOGS &&
+                    $cm->groupmode > NOGROUPS && $curgroup == 0) {
+                // We are reffering to all group blogs, not an individual or single group.
+                $group = $DB->get_record('groups', array('id' => $blog->groupid), 'name');
+                $a = (object) array('name' => $group->name,
+                        'displayname' => oublog_get_displayname($oublog));
+                $blog->name = format_string(get_string('defaultpersonalblogname', 'oublog', $a));
+                $showblogname = true;
+            }
+            if (($oublog->global && $curindividual <= 0) ||
+                    ($oublog->individual > OUBLOG_NO_INDIVIDUAL_BLOGS && $curindividual <= 0)) {
+                // Show the blog name in these cases.
+                $showblogname = true;
+            }
+
+            $postname = !(empty($blog->title)) ? $blog->title : get_string('untitledpost', 'oublog');
+            $label = html_writer::div(html_writer::link($url, $postname), 'oublogstats_commentposts_posttitle');
+            if ($showblogname) {
+                if ($oublog->global) {
+                    $bparams = array('user' => $blog->userid);
+                } else {
+                    $bparams = array('id' => $cm->id);
+                    if ($cm->groupmode > NOGROUPS && $oublog->individual >= OUBLOG_NO_INDIVIDUAL_BLOGS
+                            && $curgroup > 0) {
+                        // Force link to current group as post might be associated elsewhere(or 0).
+                        $bparams['group'] = $curgroup;
+                    } else if ($cm->groupmode > NOGROUPS && $blog->groupid > 0) {
+                        $bparams['group'] = $blog->groupid;
+                    }
+                    if ($oublog->individual != OUBLOG_NO_INDIVIDUAL_BLOGS) {
+                        $bparams['individual'] = $blog->userid;
+                    }
+                }
+                $burl = new moodle_url('/mod/oublog/view.php', $bparams);
+                $label .= html_writer::div(oublog_date($blog->timeposted) .
+                             '<br/>' .
+                          html_writer::link($burl, $blog->name), 'oublogstats_commentposts_blogname');
+            } else {
+                // We have room to put post time instead.
+                $label .= html_writer::div(oublog_date($blog->timeposted) , 'oublogstats_commentposts_blogname');
+            }
+            $statinfo = new oublog_statsinfo($user, $percent, $stat, $url, $label);
+            $content .= $renderer->render($statinfo);
+        }
+    }
+
+    return $renderer->render_stats_view('commentpoststats', $maintitle, $content, $title, $info, $timefilter, $ajax);
+}
+/**
+ * Generates oublog single user participation statistics output.
+ * @param object $oublog
+ * @param object $cm
+ * @param mod_oublog_renderer $renderer
+ * @param bool $ajax true to return data object rather than html
+ */
+function oublog_stats_output_myparticipation($oublog, $cm, $renderer = null, $course, $currentindividual, $globalindividual = null) {
+    global $PAGE, $DB, $USER, $OUTPUT;
+    if (!isloggedin()) {// My participation is only visible to actual users.
+        return;
+    }
+    if (!$renderer) {
+        $renderer = $PAGE->get_renderer('mod_oublog');
+    }
+    // Setup My Participation capability check.
+    $curgroup = oublog_get_activity_group($cm);
+    $canview = oublog_can_view_participation($course, $oublog, $cm, $curgroup);
+    if ($oublog->global) {
+        $currentindividual = $globalindividual;
+    }
+    // Dont show the 'block' if user cant participate.
+    if (($oublog->global && $currentindividual != $USER->id) ||
+            ($oublog->individual > OUBLOG_NO_INDIVIDUAL_BLOGS && $currentindividual != $USER->id)) {
+        return;
+    }
+    if (!$oublog->global && $canview == OUBLOG_NO_PARTICIPATION) {
+        return;
+    }
+    $context = context_module::instance($cm->id);
+    // Get the participation object containing User, Posts and Comments.
+    $participation = oublog_get_user_participation($oublog, $context,
+            $USER->id, $curgroup, $cm, $course, null, null, true, true, null, 8);
+    // Generate content data to send to renderer.
+    $maintitle = get_string('myparticipation', 'oublog');// The title of the block 'section'.
+    $content = '';
+    $postedcount = $commentedcount = $commenttotal = 0;
+    $postshow = 8;
+    $postscount = $participation->numposts;
+    if ($participation->numcomments <= 4) {
+        $commenttotal = $participation->numcomments;
+    } else {
+        $commenttotal = 4;
+    }
+    if (!$participation->posts) {
+        $content .= html_writer::tag('p', get_string('nouserposts', 'oublog'));
+    } else {
+        $percent = $stat = null;
+        $content .= html_writer::tag('h3', get_string('numberposts', 'oublog', $participation->numposts));
+        foreach ($participation->posts as $post) {
+            if ($postedcount >= ($postshow - $commenttotal)) {
+                break;
+            }
+            $url = new moodle_url('/mod/oublog/viewpost.php', array('post' => $post->id));
+            $postname = !(empty($post->title)) ? $post->title : get_string('untitledpost', 'oublog');
+            $label = html_writer::div(html_writer::link($url, $postname), 'oublogstats_posts_posttitle');
+            $label .= html_writer::div(oublog_date($post->timeposted) , 'oublogstats_commentposts_blogname');
+            $statinfo = new oublog_statsinfo($participation->user, $percent, $stat, $url, $label);
+            $content .= $renderer->render($statinfo);
+            $postedcount++;
+        }
+    }
+    // Pre test the numbers of posts/comments for display upto max.
+    $postspluscount = $participation->numposts - $postedcount;
+    if ($postspluscount >= 1) {
+        $content .= html_writer::tag('p', get_string('numberpostsmore', 'oublog', $postspluscount));
+    }
+    if (!$participation->comments) {
+        $content .= html_writer::tag('p', get_string('nousercomments', 'oublog'));
+    } else {
+        $percent = $stat = null;// Removing all stats div.
+        $content .= html_writer::tag('h3', get_string('numbercomments', 'oublog', $participation->numcomments));
+        foreach ($participation->comments as $comment) {
+            if (($commentedcount + $postedcount) >= $postshow ) {
+                break;
+            }
+            $url = new moodle_url('/mod/oublog/viewpost.php', array('post' => $comment->postid));
+            $lnkurl = $url->out() . '#cid' . $comment->id;
+            $commentname = !(empty($comment->title)) ? $comment->title : get_string('untitledcomment', 'oublog');
+            $label = html_writer::div(html_writer::link($lnkurl, $commentname), 'oublogstats_commentposts_posttitle');
+            $label .= html_writer::div(oublog_date($comment->timeposted) , 'oublogstats_commentposts_blogname');
+            $statinfo = new oublog_statsinfo($participation->user, $percent, $stat, $url, $label);
+            $content .= $renderer->render($statinfo);
+            $commentedcount++;
+        }
+    }
+    // If the number of comments is more than can be shown.
+    $commentspluscount = $participation->numcomments - $commentedcount;
+    if ($commentspluscount >= 1) {
+        $content .= html_writer::tag('p', get_string('numbercommentsmore', 'oublog', $commentspluscount));
+    }
+    $params = array(
+        'id' => $cm->id,
+        'group' => $curgroup,
+        'user' => $participation->user->id
+    );
+    $url = new moodle_url('/mod/oublog/userparticipation.php', $params);
+    $viewmyparticipation = html_writer::link($url, get_string('viewmyparticipation', 'oublog'));
+    $content .= html_writer::start_tag('div', array('class' => 'oublog-post-content'));
+    $content .= html_writer::tag('h3', $viewmyparticipation, array('class' => 'oublog-post-title'));
+    $content .= html_writer::end_tag('div');
+
+    return $renderer->render_stats_view('myparticipation', $maintitle,
+            $content, null, null , null, false);
+}
+/**
+ * Generates oublog multiple users participation statistics output.
+ * @param object $oublog
+ * @param object $cm
+ * @param mod_oublog_renderer $renderer
+ * @param bool $ return data object rather than html
+ */
+function oublog_stats_output_participation($oublog, $cm, $renderer = null, $course, $allposts = false, $curindividual = -1, $globalindividual = null) {
+    global $PAGE, $DB, $USER, $OUTPUT;
+    if (!$renderer) {
+        $renderer = $PAGE->get_renderer('mod_oublog');
+    }
+    // Setup Participation capability checks.
+    $curgroup = oublog_get_activity_group($cm);
+    // Get blogtype, groupmode and individualmode
+    $blogtype = $oublog->global;
+    $groupmode = oublog_get_activity_groupmode($cm, $course);
+    $individualmode = $oublog->individual;
+    // Dont show on personal blogs if not logged in.
+    if ($blogtype && !isloggedin()) {
+        return;
+    }
+    // Dont show if current individual is not 0 and either separate individual blog or
+    // visible individual with no comments.
+    if (isset($curindividual) && $curindividual != 0 &&
+            $oublog->allowcomments == OUBLOG_COMMENTS_PREVENT &&
+            $individualmode != OUBLOG_NO_INDIVIDUAL_BLOGS) {
+        return;
+    }
+    $context = context_module::instance($cm->id);
+    $curindividual = $curindividual ? $curindividual : $globalindividual;
+    if ($curindividual == -1) {
+        $curindividual = $globalindividual;
+    }
+    // Get the participation object with counts of posts and comments.
+    $limitnum = 8;
+    $start = $end = $page = $limitfrom = $tab = 0;
+    $getposts = $getcomments = true;
+    if ($oublog->global) {
+        // Dont want to see posts on personal blogs.
+        $getposts = false;
+    }
+    if ($oublog->allowcomments < OUBLOG_COMMENTS_ALLOW ) {
+        // Dont want to see comments visible individual blogs.
+        $getcomments = false;
+    }
+    $participation = oublog_get_participation_details($oublog, $curgroup, $curindividual,
+            $start, $end, $page, $getposts, $getcomments, $limitfrom, $limitnum);
+    // Generate content data to send to renderer.
+    $maintitle = get_string('participation', 'oublog');// The title of the block 'section'.
+    $content = '';
+    $postedcount = $commentedcount = $commenttotal = 0;
+    $postshow = 8;
+    if (count($participation->comments) <= 4) {
+        $commenttotal = count($participation->comments);
+    } else if (count($participation->comments) >= 4) {
+        $commenttotal = 4;
+    }
+    if (!$participation->posts) {
+        if (!$blogtype && $individualmode != OUBLOG_VISIBLE_INDIVIDUAL_BLOGS) {
+            $content .= html_writer::tag('p', get_string('nouserposts', 'oublog'));
+        }
+        // For visible individual blogs show post activity also when no individual selected.
+    } else {
+        $percent = $stat = null;
+        $content .= html_writer::tag('p', get_string('recentposts', 'oublog'));
+        foreach ($participation->posts as $post) {
+            // Post user object required for oublog_statsinfo.
+            $postuser = new stdClass();
+            $postuser->id = $post->userid;
+            $postuser->groupid = $post->groupid;
+            $fields = explode(',', user_picture::fields('', null, '', null));
+            foreach ($fields as $field) {
+                if ($field != 'id') {
+                    $pfield = $field;
+                    $postuser->$field = $post->$field;
+                }
+            }
+            $linktext = $name = $grpname = $dispname = '';
+            $bparams = array();
+            $a = (object) array('name' => $name, 'displayname' => $dispname);
+            if ($postedcount >= ($postshow - $commenttotal)) {
+                break;
+            }
+            $url = new moodle_url('/mod/oublog/viewpost.php',
+                    array('post' => $post->id));
+            $postname = !(empty($post->title)) ? $post->title :
+                    get_string('untitledpost', 'oublog');
+            $label = html_writer::div(html_writer::link($url, $postname),
+                    'oublogstats_posts_posttitle');
+            if (oublog_get_displayname($oublog) &&
+                    ($postuser->id != $curindividual)) {
+                $dispname = oublog_get_displayname($oublog);
+            }
+            if ($post->blogname != "") {
+                $name = $post->blogname;
+            } else if ($groupmode > NOGROUPS && $individualmode == OUBLOG_NO_INDIVIDUAL_BLOGS) {
+                if ($post->groupid != $curgroup) {
+                    $bparams['id'] = $cm->id;
+                    $bparams['group'] = $post->groupid;
+                    $grpname = groups_get_group_name($post->groupid);
+                    $a = (object) array('name' => $grpname, 'displayname' => $dispname);
+                    $linktext = get_string('defaultpersonalblogname', 'oublog', $a);
+                }
+            } else if ($individualmode != OUBLOG_NO_INDIVIDUAL_BLOGS) {
+                $bparams['individual'] = $post->userid;
+                if ($postuser->id != $curindividual) {
+                    $name = fullname($postuser);
+                    $a = (object) array('name' => $name, 'displayname' => $dispname);
+                    $linktext = get_string('defaultpersonalblogname', 'oublog', $a);
+                }
+            }
+            if (!$groupmode && $grpname != "" || $name !="") {
+                $bparams['id'] = $cm->id;
+                $bparams['individual'] = $post->userid;
+                $a = (object) array('name' => $name, 'displayname' => $dispname);
+                $linktext = get_string('defaultpersonalblogname', 'oublog', $a);
+            }
+            $burl = new moodle_url('/mod/oublog/view.php', $bparams);
+            if ($linktext != "") {
+                // We output post time followed by a link.
+                $label .= html_writer::div(oublog_date($post->timeposted) .
+                        html_writer::empty_tag('br', array()) .
+                        html_writer::link($burl, $linktext), 'oublogstats_commentposts_blogname');
+            } else {
+                // We output just post.
+                $label .= html_writer::div(oublog_date($post->timeposted), 'oublogstats_commentposts_blogname');
+            }
+            $statinfo = new oublog_statsinfo($postuser, $percent, $stat, $url, $label);
+            $content .= $renderer->render($statinfo);
+            $postedcount++;
+        }
+    }
+    // Pre test the numbers of posts/comments for display upto max.
+    $postspluscount = count($participation->posts) - $postedcount;
+    if ($postspluscount >= 1 && !$blogtype && !$individualmode) {
+        $content .= html_writer::tag('p', get_string('numberpostsmore', 'oublog', $postspluscount));
+    }
+    unset($bparams);
+    if (!$participation->comments && $getcomments) {
+        $content .= html_writer::tag('p', get_string('nousercomments', 'oublog'));
+    } else {
+        $percent = $stat = null;// Removing all stats div.
+        if ($blogtype || $getcomments) {
+            $content .= html_writer::tag('p', get_string('recentcomments', 'oublog'));
+        }
+        foreach ($participation->comments as $comment) {
+            // Comment user object required for oublog_statsinfo.
+            $commentuser = new stdClass();
+            if (empty($comment->commenterid)) {
+                $commentuser->id =-1;
+            } else {
+                $commentuser->id = $comment->commenterid;
+            }
+            $fields = explode(',', user_picture::fields('', null, '', 'commenter'));
+            foreach ($fields as $field) {
+                if ($field != 'id') {
+                    $cfield = "commenter" . $field;
+                    $commentuser->$field = $comment->$cfield;
+                }
+            }
+            // Comment poster object required.
+            $commentposter = new stdClass();
+            $commentposter->id = $comment->posterid;
+            $fields = explode(',', user_picture::fields('', null, '', 'poster'));
+            foreach ($fields as $field) {
+                if ($field != 'id') {
+                    $cfield = "poster" . $field;
+                    $commentposter->$field = $comment->$cfield;
+                }
+            }
+            $commentuser->groupid = $comment->groupid;
+            if (($commentedcount + $postedcount) >= $postshow) {
+                break;
+            }
+            $url = new moodle_url('/mod/oublog/viewpost.php',
+                    array('post' => $comment->postid));
+            $lnkurl = $url->out() . '#cid' . $comment->id;
+            $commentname = !(empty($comment->title)) ? $comment->title :
+                    get_string('untitledcomment', 'oublog');
+            $label = html_writer::div(html_writer::link($lnkurl, $commentname),
+                    'oublogstats_commentposts_posttitle');
+            $linktext = $name = $grpname = $dispname = '';
+            $a = (object) array('name' => $name, 'displayname' => $dispname);
+            $bparams = array();
+            if (oublog_get_displayname($oublog) &&
+                    ($comment->posterid != $curindividual)) {
+                $dispname = oublog_get_displayname($oublog);
+            }
+            if ($comment->bloginstancename && ($curindividual != $comment->posterid)) {
+                $bparams['user'] = $comment->posterid;
+                $name = $comment->bloginstancename;
+            } else if ($groupmode > NOGROUPS && $individualmode == OUBLOG_NO_INDIVIDUAL_BLOGS) {
+                if ($comment->groupid != $curgroup) {
+                    $bparams['id'] = $cm->id;
+                    $bparams['group'] = $comment->groupid;
+                    $grpname = groups_get_group_name($comment->groupid);
+                    $a = (object) array('name' => $grpname, 'displayname' => $dispname);
+                    $linktext = get_string('defaultpersonalblogname', 'oublog', $a);
+                }
+            } else if ($individualmode != OUBLOG_NO_INDIVIDUAL_BLOGS) {
+                $bparams['id'] = $cm->id;
+                $bparams['individual'] = $comment->posterid;
+                if ($comment->posterid != $curindividual) {
+                    $name = fullname($commentposter);
+                    $a = (object) array('name' => $name, 'displayname' => $dispname);
+                    $linktext = get_string('defaultpersonalblogname', 'oublog', $a);
+                }
+            }
+            // Personal or Course Wide.
+            if (!$groupmode && $grpname != "" || $name !="") {
+                $bparams['individual'] = $comment->posterid;
+                $a = (object) array('name' => $name, 'displayname' => $dispname);
+                $linktext = get_string('defaultpersonalblogname', 'oublog', $a);
+            }
+            if (!$groupmode && $oublog->individual == 0 && $comment->posterid != $curindividual) {
+                if (!$oublog->global) {
+                    $bparams['id'] = $cm->id;
+                }
+                $bparams['individual'] = $comment->posterid;
+                if ($oublog->global) {
+                    $linktext = $comment->bloginstancename;
+                }
+            }
+            $burl = new moodle_url('/mod/oublog/view.php', $bparams);
+            if ($linktext != "") {
+                // We output post time followed by a link.
+                $label .= html_writer::div(oublog_date($comment->timeposted) . html_writer::empty_tag('br', array()) .
+                        html_writer::link($burl, $linktext), 'oublogstats_commentposts_blogname');
+            } else {
+                // We output just post.
+                $label .= html_writer::div(oublog_date($comment->timeposted) , 'oublogstats_commentposts_blogname');
+            }
+            $statinfo = new oublog_statsinfo($commentuser, $percent, $stat, $url, $label);
+            $content .= $renderer->render($statinfo);
+            $commentedcount++;
+        }
+    }
+    // If the number of comments is more than can be shown.
+    $commentspluscount = count($participation->comments) - $commentedcount;
+    if ($commentspluscount >= 1) {
+        $content .= html_writer::tag('p', get_string('numbercommentsmore', 'oublog', $commentspluscount));
+    }
+    $params = array(
+        'id' => $cm->id,
+        'group' => $curgroup,
+        'individual' => $curindividual
+    );
+    if (!$blogtype) {
+        if (!$allposts) {
+            $url = new moodle_url('/mod/oublog/participationlist.php', $params);
+            $viewparticipation = html_writer::div(html_writer::link($url, get_string('viewallparticipation', 'oublog')));
+            $content .= html_writer::start_tag('div', array('class' => 'oublog-post-content'));
+            $content .= html_writer::tag('h3', $viewparticipation, array('class' => 'oublog-post-title'));
+            $content .= html_writer::end_tag('div');
+        }
+    }
+
+    return $renderer->render_stats_view('participation', $maintitle,
+            $content, null, null , null);
+}
+/**
+ * This function should return summary info for all posts/comments for the specified blog
+ * (or against a blog instance if individual set), excluding those by current user,
+ * and based on parameters sent.
+ * If individual is set then only comments should be returned.
+ */
+function oublog_get_participation_details($oublog, $groupid, $individual,
+        $start = null, $end = null, $page = 0, $getposts = true,
+        $getcomments = true, $limitfrom = null, $limitnum = null) {
+    global $DB, $USER;
+    $gmgroup = $gminner = $groupcheck = $postvisibility = $postallowcomments = '';
+    $period = $cperiod = $limitcount = $thispostuser = $thiscommentuser = '';
+    $visibility = OUBLOG_VISIBILITY_COURSEUSER;
+    if ($oublog->allowcomments >= OUBLOG_COMMENTS_ALLOW) {
+        $allowcomments = OUBLOG_COMMENTS_ALLOW;
+    } else {
+        $allowcomments = OUBLOG_COMMENTS_PREVENT;
+    }
+    $postallowcomments = 'AND p.allowcomments >= ' . OUBLOG_COMMENTS_ALLOW;
+    // If selected a group in an individual blog (no user selected) -
+    // get group to filter results.
+    if (($oublog->individual != OUBLOG_NO_INDIVIDUAL_BLOGS) && isset($groupid) && $groupid > 0) {
+        $gminner = "INNER JOIN {groups_members} gm ON bi.userid = gm.userid";
+        $gmgroup = "gm.groupid AS gmgroup, ";
+        $groupcheck = " AND gm.groupid = :gmgroupid ";
+    } else {
+        $groupcheck = $groupid ? 'AND p.groupid = :pgroupid ' : '';
+    }
+    if ($start) {
+        $period = 'AND timeposted > :timestart ';
+    }
+    if ($end) {
+        $period .= 'AND timeposted < :timeend ';
+    }
+    if ($individual > 0 ) {
+        $thispostuser = 'AND u.id = :userid ';
+        $thiscommentuser = 'AND Ub.id = :userid ';
+    }
+    if ($oublog->global || ($oublog->maxvisibility == OUBLOG_VISIBILITY_PUBLIC
+            && !isloggedin())) {
+        // Only include visible posts on global blogs and public blogs when not logged in.
+        $postvisibility = 'AND p.visibility >= :visibility ';
+        if (!isloggedin()) {
+            $visibility = OUBLOG_VISIBILITY_PUBLIC;
+        } else {
+            $visibility = OUBLOG_VISIBILITY_LOGGEDINUSER;
+        }
+    }
+
+    $posterfields = user_picture::fields('u', null, 'posteridx');
+    $postssql = "SELECT p.id, p.title, p.timeposted, p.groupid, $gmgroup
+    p.allowcomments, p.visibility,
+    bi.userid, bi.name AS blogname, $posterfields
+    FROM {oublog_posts} p
+    INNER JOIN {oublog_instances} bi ON p.oubloginstancesid = bi.id
+    INNER JOIN {user} u ON bi.userid = u.id ". $gminner ."
+    WHERE p.deletedby IS NULL AND oublogid = :oublogid
+    AND p.timedeleted IS NULL " . $groupcheck . $period . $thispostuser .
+    $postvisibility;
+    $postssqlorder = ' ORDER BY p.timeposted DESC ';
+    if ($start) {
+        $cperiod = 'AND c.timeposted > :timestart ';
+    }
+    if ($end) {
+        $cperiod .= 'AND c.timeposted < :timeend ';
+    }
+    $commenterfields = user_picture::fields('Ua', null, 'commenteridx', 'commenter');
+    $posterfields = user_picture::fields('Ub', null, 'posteridx', 'poster');
+    $commentssql = "SELECT c.id, c.postid, c.title, c.timeposted, c.userid,
+    Ua.id AS commenterid, $commenterfields, Ub.id AS posterid, $posterfields,
+    p.title AS posttitle, p.timeposted AS postdate, p.allowcomments, p.visibility,
+    bi.oublogid, bi.name AS bloginstancename,
+    bi.userid AS postauthorid, $gmgroup p.groupid
+    FROM {oublog_comments} c
+    JOIN {oublog_posts} p ON (c.postid = p.id)
+    JOIN {oublog_instances} bi ON (bi.id = p.oubloginstancesid) ". $gminner ."
+    LEFT JOIN {user} Ua ON Ua.id = c.userid
+    LEFT JOIN {user} Ub ON Ub.id = bi.userid
+    WHERE bi.oublogid = :oublogid
+    AND p.timedeleted IS NULL AND c.timedeleted IS NULL " . $groupcheck .
+    $cperiod . $thiscommentuser .
+    $postvisibility . $postallowcomments ."
+    AND c.postid = p.id ";
+    $commentsqlorder = 'ORDER BY c.timeposted DESC ';
+
+    $params = array(
+            'oublogid' => $oublog->id,
+            'pgroupid' => $groupid,
+            'gmgroupid' => $groupid,
+            'timestart' => $start,
+            'timeend' => $end,
+            'userid' => $individual,
+            'visibility' => $visibility,
+            'allowcomments' => $allowcomments
+    );
+    $participation = new stdClass();
+    $participation->postscount = $DB->get_field_sql("SELECT COUNT(1) FROM ($postssql) as p", $params);
+    if ($getposts) {
+        $participation->posts = $DB->get_records_sql($postssql . $postssqlorder, $params, $limitfrom, $limitnum);
+    } else {
+        $participation->posts = array();
+    }
+    $participation->commentscount = $DB->get_field_sql("SELECT COUNT(1) FROM ($commentssql) as p", $params);
+    if ($getcomments) {
+        $participation->comments = $DB->get_records_sql($commentssql . $commentsqlorder, $params, $limitfrom, $limitnum);
+    } else {
+        $participation->comments = array();
+    }
+    return $participation;
+}
+
+
+require_once($CFG->libdir . '/formslib.php');
+class oublog_stats_timefilter_form extends moodleform {
+
+    private $type = '';
+
+    public function definition() {
+        global $CFG;
+
+        $mform =& $this->_form;
+        $cdata = $this->_customdata;
+        /*
+         * We Expect custom data to have following format:
+         * 'options' => array used for select drop down
+         * 'default' => default/selected option
+         * 'type' => 'type' of stat this is used in - must be same as function name suffix
+         * 'cmid' => blog course module id
+         * 'params' => key(name)/value array to make into hidden inputs (value must be integer)
+         */
+        if (isset($cdata['type'])) {
+            $this->type = $cdata['type'];
+        }
+        if (!empty($cdata['params']) && is_array($cdata['params'])) {
+            foreach ($cdata['params'] as $param => $value) {
+                $mform->addElement('hidden', $param, $value);
+                $mform->setType($param, PARAM_INT);
+            }
+        }
+        if (!empty($cdata['options'])) {
+            if (!isset($cdata['attributes']) || !is_array($cdata['attributes'])) {
+                $cdata['attributes'] = array();
+            }
+            $mform->addElement('select', 'timefilter_' . $this->type, get_string('timefilter_label', 'oublog'), $cdata['options'], $cdata['attributes']);
+            if (isset($cdata['default'])) {
+                $mform->setDefault('timefilter_' . $this->type, $cdata['default']);
+            }
+            if (isset($cdata['type'])) {
+                $mform->addElement('hidden', 'type', $cdata['type']);
+                $mform->setType('type', PARAM_ALPHA);
+            }
+            if (isset($cdata['cmid'])) {
+                $mform->addElement('hidden', 'id', $cdata['cmid']);
+                $mform->setType('id', PARAM_INT);
+            }
+            $this->add_action_buttons(false, get_string('timefilter_submit', 'oublog'));
+        }
+    }
+
+    public function render() {
+        // Override render so we can output js to page.
+        global $PAGE;
+        if (isset($this->type)) {
+            $PAGE->requires->yui_module('moodle-mod_oublog-statsupdate', 'M.mod_oublog.statsupdate.init',
+                    array($this->type));
+        }
+        return parent::render();
+    }
+
+    protected function get_form_identifier() {
+        // Override form name to ensure unique.
+        return parent::get_form_identifier() . '_' . $this->type;
+    }
+
+    public function add_action_buttons($cancel = true, $submitlabel = null) {
+        // Override submit to ensure name unique.
+        $mform =& $this->_form;
+        $mform->addElement('submit', 'submitbutton' . '_' . $this->type, $submitlabel);
+        $mform->closeHeaderBefore('submitbutton' . '_' . $this->type);
+    }
+
+    /**
+     * Returns time selected in this form or uses default if none yet.
+     * Returns as a unix time to use in sql or 0 if no time filter.
+     * @param int $default
+     * @return array (time ago, selected constant)
+     */
+    public function get_selected_time($default) {
+        if ($data = $this->get_data()) {
+            $elname = 'timefilter_' . $this->type;
+            if (isset($data->$elname)) {
+                $default = $data->$elname;
+            }
+        }
+        switch ($default) {
+            case OUBLOG_STATS_TIMEFILTER_ALL:
+                return array(0, OUBLOG_STATS_TIMEFILTER_ALL);
+                break;
+            case OUBLOG_STATS_TIMEFILTER_MONTH:
+                return array(strtotime('1 month ago'), OUBLOG_STATS_TIMEFILTER_MONTH);
+                break;
+            case OUBLOG_STATS_TIMEFILTER_YEAR:
+                return array(strtotime('1 year ago'), OUBLOG_STATS_TIMEFILTER_YEAR);
+                break;
+        }
+    }
+}
+
+class oublog_all_portfolio_caller extends oublog_portfolio_caller {
+
+    protected $postid;
+    protected $attachment;
+    protected $currentgroup;
+    protected $offset;
+    protected $currentindividual;
+    protected $oubloguserid;
+    protected $canaudit;
+    protected $tag;
+    protected $oublogid;
+    protected $cmid;
+
+    private $post;
+    protected $files = array();
+    private $keyedfiles = array();// Keyed on entry.
+
+    /**
+     * @return array
+     */
+    public static function expected_callbackargs() {
+        return array(
+                'postid' => false,
+                'oublogid' => true,
+                'currentgroup' => true,
+                'offset' => true,
+                'currentindividual' => true,
+                'oubloguserid' => true,
+                'canaudit' => true,
+                'cmid' => true,
+                'tag' => true,
+        );
+    }
+
+    /**
+     * @param array $callbackargs
+     */
+    public function __construct($callbackargs) {
+        parent::__construct($callbackargs);
+        if (!$this->oublogid) {
+            throw new portfolio_caller_exception('mustprovidepost', 'oublog');
+        }
+    }
+
+    /**
+     * @global object
+     */
+    public function load_data() {
+        global $DB, $COURSE;
+        if (!$this->oublog = $DB->get_record('oublog', array('id' => $this->oublogid))) {
+            throw new portfolio_caller_exception('invalidpostid', 'oublog');
+        }
+        if (!$this->cm = get_coursemodule_from_instance('oublog', $this->oublogid)) {
+            throw new portfolio_caller_exception('invalidcoursemodule');
+        }
+        // Convert tag from id to name.
+        if (!empty($this->tag)) {
+            if ($tagrec = $DB->get_record('oublog_tags', array('id' => $this->tag), 'tag')) {
+                $this->tag = $tagrec->tag;
+            }
+        }
+        // Call early to cache group mode - stops debugging warning from oublog_get_posts later.
+        $this->cm->activitygroupmode = oublog_get_activity_groupmode($this->cm, $COURSE);
+        $context = context_module::instance($this->cm->id);
+        $this->modcontext = $context;
+        if ($this->canaudit == 1) {
+            $this->canaudit = true;
+        } else {
+            $this->canaudit = false;
+        }
+        if (empty($this->oubloguserid)) {
+            $this->oubloguserid = null;
+        }
+        if (empty($this->currentindividual) || $this->currentindividual == 0) {
+            $this->currentindividual = -1;
+        }
+        list($this->posts, $recordcount) = oublog_get_posts($this->oublog,
+                $context, $this->offset, $this->cm, $this->currentgroup, $this->currentindividual,
+                $this->oubloguserid, $this->tag, $this->canaudit);
+
+        $fs = get_file_storage();
+        $this->multifiles = array();
+        foreach ($this->posts as $post) {
+            $files = array();
+            $attach = $fs->get_area_files($this->modcontext->id,
+                    'mod_oublog', 'attachment', $post->id);
+            $embed  = $fs->get_area_files($this->modcontext->id,
+                    'mod_oublog', 'message', $post->id);
+            if (!empty($post->comments)) {
+                foreach ($post->comments as $commentpost) {
+                    $embedcomments  = $fs->get_area_files($this->modcontext->id,
+                            'mod_oublog', 'messagecomment', $commentpost->id);
+                    $files = array_merge($files, $embedcomments);
+                }
+            }
+            $files = array_merge($files, $attach, $embed);
+            if ($files) {
+                $this->keyedfiles[$post->id] = $files;
+            } else {
+                continue;
+            }
+            $this->multifiles = array_merge($this->multifiles, $files);
+        }
+        $this->set_file_and_format_data($this->multifiles);
+
+        if (empty($this->multifiles) && !empty($this->singlefile)) {
+            $this->multifiles = array($this->singlefile); // Copy_files workaround.
+        }
+        // Depending on whether there are files or not, we might have to change richhtml/plainhtml.
+        if (!empty($this->multifiles)) {
+            $this->add_format(PORTFOLIO_FORMAT_RICHHTML);
+        } else {
+            $this->add_format(PORTFOLIO_FORMAT_PLAINHTML);
+        }
+    }
+
+    /**
+     * @global object
+     * @return string
+     */
+    public function get_return_url() {
+        global $CFG;
+        return $CFG->wwwroot . '/mod/oublog/view.php?id=' . $this->cmid;
+    }
+
+    /**
+     * @global object
+     * @return array
+     */
+    public function get_navigation() {
+        global $CFG;
+        $navlinks = array();
+        return array($navlinks, $this->cm);
+    }
+
+    /**
+     * A whole blog from a single post, with or without attachments
+     *
+     * @global object
+     * @uses PORTFOLIO_FORMAT_RICH
+     * @return mixed
+     */
+    public function prepare_package() {
+        global $CFG;
+        $plugin = $this->get('exporter')->get('instance')->get('plugin');
+        $posttitles = array();
+        $outputhtml = '';
+        // Exporting a set of posts from the view page.
+        foreach ($this->posts as $post) {
+            $post = oublog_get_post($post->id);
+            if ($plugin != 'rtf') {
+                $outputhtml = $this->prepare_post($post, true);
+                // If post is titled use that as file name for export.
+                if ($post->title) {
+                    $name = $post->title . '.html';
+                } else {
+                    $name = get_string('exportuntitledpost', 'oublog') . $post->id . '.html';
+                }
+                // If post title already exists make it unique.
+                if (in_array(strtolower($post->title), $posttitles) and $post->title != '' ) {
+                    $name = $post->title . ' ' . $post->id . '.html';
+                    $post->title = $post->title . ' id ' . $post->id;
+                }
+            } else {
+                // Ensure multiple posts and their comments
+                // are included in the html for export.
+                $outputhtml .= $this->prepare_post($post, false);
+            }
+            // Ensure multiple files contained within this post and it's comments
+            // are included in the exported file.
+            $manifest = ($this->exporter->get('format') instanceof PORTFOLIO_FORMAT_RICH);
+            if (!empty($this->multifiles)) {
+                foreach ($this->multifiles as $file) {
+                    $this->get('exporter')->copy_existing_file($file);
+                }
+            }
+            if ($plugin != 'rtf') {
+                $this->get('exporter')->write_new_file($outputhtml, $name, $manifest);
+                $posttitles[] = strtolower($post->title);
+            }
+        }
+        if ($plugin == 'rtf') {
+            $name = $this->oublog->name . '.html';
+            $this->get('exporter')->write_new_file($outputhtml, $name, $manifest);
+        }
+    }
+
+    /**
+     * @return string
+     */
+    public function get_sha1() {
+        $filesha = '';
+        try {
+            $filesha = $this->get_sha1_file();
+        } catch (portfolio_caller_exception $e) {
+            // No files.
+        }
+        if ($this->oublog) {
+            return sha1($filesha . ',' . $this->oublog->name . ',' . $this->oublog->intro);
+        } else {
+            $sha1s = array($filesha);
+            foreach ($this->posts as $post) {
+                $sha1s[] = sha1($post->title . ',' . $post->message);
+            }
+            return sha1(implode(',', $sha1s));
+        }
+    }
+    /**
+     * @uses CONTEXT_MODULE
+     * @return bool
+     */
+    public function check_permissions() {
+        $context = context_module::instance($this->cm->id);
+        return (has_capability('mod/oublog:exportpost', $context));
+    }
+}
+
+function oublog_get_displayname($oublog, $upperfirst = false) {
+    if (empty($oublog->displayname)) {
+        $string = get_string('displayname_default', 'oublog');
+    } else {
+        $string = $oublog->displayname;
+    }
+    if ($upperfirst) {
+        return ucfirst($string);
+    } else {
+        return $string;
+    }
+}
+
+function oublog_get_reportingemail($oublog) {
+    return $oublog->reportingemail;
+}
+
+/*
+ * Call to check if OU Alerts plugin exists.
+ * If so, includes the library suppport, otherwise return false.
+ *
+ * @return bool True if OU Alerts extension is enabled.
+ */
+function oublog_oualerts_enabled() {
+    global $CFG;
+
+    if (file_exists($CFG->dirroot . '/report/oualerts/locallib.php')) {
+        @include_once($CFG->dirroot . '/report/oualerts/locallib.php');
+        return oualerts_enabled();
+    }
+
+    return false;
+}
+
+/**
+ * Calls a remote server externallib web services during import
+ * We use the Moodle curl cache to store responses (for 120 secs default)
+ * @param string $function
+ * @param array $params (name => value)
+ * @return array json decoded result or false if not configured
+ */
+function oublog_import_remote_call($function, $params = null) {
+    $settings = get_config('mod_oublog');
+    if (empty($settings->remoteserver) && empty($settings->remotetoken)) {
+        return false;
+    }
+    if (is_null($params)) {
+        $params = array();
+    }
+    $curl = new curl(array('cache' => true, 'module_cache' => 'oublog_import'));
+    $url = $settings->remoteserver . '/webservice/rest/server.php';
+    $params['moodlewsrestformat'] = 'json';
+    $params['wsfunction'] = $function;
+    $params['wstoken'] = $settings->remotetoken;
+    $options = array();
+    $options['RETURNTRANSFER'] = true;
+    $options['SSL_VERIFYPEER'] = false;
+    $result = $curl->get($url, $params, $options);
+    $json = json_decode($result);
+    if (empty($result) || $curl->get_errno() || !empty($json->exception)) {
+        $errinfo = !empty($json->exception) ? !empty($json->debuginfo) ? $json->debuginfo : $json->message : $curl->error;
+        throw new moodle_exception('Failed to contact ' . $settings->remoteserver . ' : ' . $errinfo);
+        return false;
+    }
+    return $json;
+}
+
+/**
+ * Class defined here to extend the curl class and call the multi() function with no options set.
+ */
+class oublog_public_curl_multi extends curl {
+    public function public_multi($requests, $options = array()) {
+        return $this->multi($requests, $options);
+    }
+}
+
+/**
+ * Downloads files from remote system and adds into local file table
+ * Uses webservice pluginfile so lib picks up is from this and allows access to files.
+ * @param array $files - array of file-like objects (returned from externallib get_posts)
+ * @param int $newcontid - context id to use for new files
+ * @param int $newitemid - item id to use for new files
+ */
+function oublog_import_remotefiles($files, $newcontid, $newitemid) {
+    $settings = get_config('mod_oublog');
+    if (empty($settings->remoteserver) && empty($settings->remotetoken) || empty($files)) {
+        return false;
+    }
+    $fs = get_file_storage();
+    $options = array('RETURNTRANSFER' => true);
+    $requests = array();
+    foreach ($files as $file) {
+        $requests[] = array('url' => $settings->remoteserver . '/webservice/pluginfile.php/' .
+                $file->contextid . '/mod_oublog/' . $file->filearea . '/' . $file->itemid . $file->filepath .
+                rawurlencode($file->filename) . '?token=' . $settings->remotetoken);
+    }
+    $curl = new oublog_public_curl_multi();
+    $responses = $curl->public_multi($requests, $options);
+    $count = count($files);
+    for ($i = 0; $i < $count; $i++) {
+        if (empty($files[$i])) {
+            continue;
+        }
+        $fileinfo = $files[$i];
+        $fileinfo->contextid = $newcontid;
+        $fileinfo->itemid = $newitemid;
+        $fileinfo->component = 'mod_oublog';
+        $fs->create_file_from_string($fileinfo, $responses[$i]);
+    }
+    return true;
+}
+
+/**
+ * Gets all blogs on the system (and on remote system if defined) that can be imported from
+ * @param int $userid
+ * @param int $curcmid Current blog cmid (excludes this from list returned)
+ * @return array of blog 'info objects' [cmid, name, coursename, numposts]
+ */
+function oublog_import_getblogs($userid = 0, $curcmid = null) {
+    global $DB, $USER, $SITE;
+    if ($userid == 0) {
+        $userid = $USER->id;
+    }
+    $retarray = array();
+    $courses = enrol_get_users_courses($userid, true);
+    array_unshift($courses, get_site());
+    $courses[0]->site = true;// Mark the global site.
+    foreach ($courses as $course) {
+        $crsmodinfo = get_fast_modinfo($course, $userid);
+        $blogs = $crsmodinfo->get_instances_of('oublog');
+        foreach ($blogs as $blogcm) {
+            if ($curcmid && $blogcm->id == $curcmid) {
+                continue;// Ignore current blog.
+            }
+            $blogcontext = context_module::instance($blogcm->id);
+            if ($blogoublog = $DB->get_record('oublog', array('id' => $blogcm->instance))) {
+                $canview = $blogcm->uservisible;
+                if ($canview) {
+                    $canview = has_capability('mod/oublog:view', $blogcontext, $userid);
+                }
+                if ($blogoublog->global) {
+                    // Ignore uservisible for global blog and only check cap.
+                    $canview = has_capability('mod/oublog:viewpersonal', context_system::instance(), $userid);
+                }
+                if ($canview) {
+                    if ($blogoublog->global) {
+                        // Global blog, only show if user instance available.
+                        if (!$blogoubloginst = $DB->get_record('oublog_instances',
+                                array('oublogid' => $blogoublog->id, 'userid' => $userid))) {
+                            continue;
+                        }
+                    } else if ($blogoublog->individual == OUBLOG_NO_INDIVIDUAL_BLOGS) {
+                        // Only allow individual blogs.
+                        continue;
+                    }
+                    $blogob = new stdClass();
+                    $blogob->cmid = $blogcm->id;
+                    $blogob->coursename = '';
+                    if (!$blogoublog->global) {
+                        $blogob->coursename = $blogcm->get_course()->shortname . ' ' .
+                                get_course_display_name_for_list($blogcm->get_course());
+                    }
+                    // Get number of posts (specific to user, doesn't work with group blogs).
+                    $sql = 'SELECT count(p.id) as total
+                        FROM {oublog_posts} p
+                        INNER JOIN {oublog_instances} bi on bi.id = p.oubloginstancesid
+                        WHERE bi.userid = ?
+                        AND bi.oublogid = ?
+                        AND p.deletedby IS NULL';
+                    $count = $DB->get_field_sql($sql, array($userid, $blogoublog->id));
+                    $blogob->numposts = $count ? $count : 0;
+                    $blogoublogname = $blogcm->get_formatted_name();
+                    if ($blogoublog->global) {
+                        $blogoublogname = $blogoubloginst->name;
+                    }
+                    $blogob->name = $blogoublogname;
+                    $retarray[] = $blogob;
+                }
+            }
+        }
+    }
+    return $retarray;
+}
+/**
+ * Returns blog info - cm, oublog
+ * Also checks is a valid blog for import
+ * (Throws exception on access error)
+ * @param int $cmid
+ * @param int $userid
+ * @return array (cm id, oublog id, context id, blog name, course shortname)
+ */
+function oublog_import_getbloginfo($cmid, $userid = 0) {
+    global $DB, $USER;
+    if ($userid == 0) {
+        $userid = $USER->id;
+    }
+    $bcourse = $DB->get_record_select('course',
+            'id = (SELECT course FROM {course_modules} WHERE id = ?)', array($cmid),
+            '*', MUST_EXIST);
+    $bmodinfo = get_fast_modinfo($bcourse, $userid);
+    $bcm = $bmodinfo->get_cm($cmid);
+    if ($bcm->modname !== 'oublog') {
+        throw new moodle_exception('invalidcoursemodule', 'error');
+    }
+    if (!$boublog = $DB->get_record('oublog', array('id' => $bcm->instance))) {
+        throw new moodle_exception('invalidcoursemodule', 'error');
+    }
+    $bcontext = context_module::instance($bcm->id);
+    $canview = $bcm->uservisible;
+    if ($canview) {
+        $canview = has_capability('mod/oublog:view', $bcontext, $userid);
+    }
+    if ($boublog->global) {
+        // Ignore uservisible for global blog and only check cap.
+        $canview = has_capability('mod/oublog:viewpersonal', context_system::instance(), $userid);
+    }
+    if (!$canview ||
+            (!$boublog->global && $boublog->individual == OUBLOG_NO_INDIVIDUAL_BLOGS)) {
+        // Not allowed to get pages from selected blog.
+        throw new moodle_exception('import_notallowed', 'oublog', '', oublog_get_displayname($boublog));
+    }
+    if ($boublog->global) {
+        $boublogname = $DB->get_field('oublog_instances', 'name',
+                array('oublogid' => $boublog->id, 'userid' => $userid));
+        $shortname = '';
+    } else {
+        $boublogname = $bcm->get_course()->shortname . ' ' .
+                get_course_display_name_for_list($bcm->get_course()) .
+                ' : ' . $bcm->get_formatted_name();
+        $shortname = $bcm->get_course()->shortname;
+    }
+    return array($bcm->id, $boublog->id, $bcontext->id, $boublogname, $shortname);
+}
+
+/**
+ * Returns importable posts, total posts and selected tag info
+ * @param int $blogid - ID of blog
+ * @param string $sort - SQL sort for posts
+ * @param int $userid
+ * @param int $page - page number for pagination (100 per page)
+ * @param array $tags - comma separated sequence of selected tag ids to filter by
+ * @return array (posts, total in DB, selected tag info)
+ */
+function oublog_import_getallposts($blogid, $sort, $userid = 0, $page = 0, $tags = null) {
+    global $DB, $USER;
+    if ($userid == 0) {
+        $userid = $USER->id;
+    }
+    $perpage = 100;// Must match value in import.php.
+    $sqlparams = array($userid, $blogid);
+    $tagjoin = '';
+    $tagwhere = '';
+    $tagnames = '';
+    $total = 0;
+    if ($tags) {
+        $tagarr = array_unique(explode(',', $tags));
+        // Filter by joining tag instances.
+        list($taginwhere, $tagparams) = $DB->get_in_or_equal($tagarr);
+        $tagjoin = "INNER JOIN (
+        SELECT ti.postid, count(*) as tagcount FROM {oublog_taginstances} ti WHERE ti.tagid $taginwhere
+        group by ti.postid) as hastags on hastags.postid = p.id";
+        $tagwhere = 'AND hastags.tagcount = ?';
+        $sqlparams = array_merge($tagparams, $sqlparams, array(count($tagarr)));
+        // Get selected tag names.
+        $tagnames = $DB->get_records_select('oublog_tags', "id $taginwhere", $tagparams, 'tag ASC');
+    }
+    $sql = "SELECT p.id, p.timeposted, p.title
+        FROM {oublog_posts} p
+        INNER JOIN {oublog_instances} bi on bi.id = p.oubloginstancesid
+        $tagjoin
+        WHERE bi.userid = ?
+        AND bi.oublogid = ?
+        AND p.deletedby IS NULL
+        $tagwhere
+        ORDER BY p." . $sort;
+
+    $limitfrom = $page * $perpage;
+
+    if ($posts = $DB->get_records_sql($sql, $sqlparams, $limitfrom, $perpage)) {
+        // Add in post tags from single query.
+        list($inwhere, $inparams) = $DB->get_in_or_equal(array_keys($posts));
+        $tsql = 'SELECT t.*, ti.postid
+            FROM {oublog_taginstances} ti
+            INNER JOIN {oublog_tags} t ON ti.tagid = t.id
+            WHERE ti.postid ' . $inwhere . ' ORDER BY t.tag';
+        $rs = $DB->get_recordset_sql($tsql, $inparams);
+        foreach ($rs as $tag) {
+            $postid = $tag->postid;
+            if (!isset($posts[$postid]->tags)) {
+                $posts[$postid]->tags = array();
+            }
+            $posts[$postid]->tags[$tag->id] = $tag->tag;
+        }
+        $rs->close();
+        // Add total record count.
+        $total = $DB->get_field_sql('SELECT count(tot.id) FROM (' . $sql . ') as tot', $sqlparams);
+    }
+    return array($posts, $total, $tagnames);
+}
+
+/**
+ * Returns posts specified (inc tags and comments)
+ * @param int $blogid - oublog id
+ * @param int $bcontextid - oublog mod context id
+ * @param array $selected - array of selected post ids
+ * @param bool $inccomments - include comments?
+ * @param int $userid - user id (ensures user is post author)
+ * @param bool $importall - indicate whether or not get all posts
+ * @return array posts
+ */
+function oublog_import_getposts($blogid, $bcontextid, $selected, $inccomments = false, $userid = 0, $importall = false) {
+    global $DB, $USER;
+    if ($userid == 0) {
+        $userid = $USER->id;
+    }
+    $sqlwhere = "bi.userid = ? AND bi.oublogid = ?  AND p.deletedby IS NULL";
+    $sqlparams = array();
+    if ($importall) {
+        $sqlparams = array($userid, $blogid);
+    } else {
+        list($inwhere, $params) = $DB->get_in_or_equal($selected);
+        $sqlwhere .= " AND p.id $inwhere";
+        $sqlparams = array_merge(array($userid, $blogid), $params);
+    }
+    $sql = "SELECT p.*
+        FROM {oublog_posts} p
+        INNER JOIN {oublog_instances} bi on bi.id = p.oubloginstancesid
+        WHERE $sqlwhere
+        ORDER BY p.id ASC";
+    if (!$posts = $DB->get_records_sql($sql, $sqlparams)) {
+        return array();
+    }
+    $files = get_file_storage();
+    // Get post images and attachments.
+    foreach ($posts as &$post) {
+        $post->comments = array();// Add in a comment array for use later.
+        $post->images = $files->get_area_files($bcontextid, 'mod_oublog', 'message', $post->id, 'itemid', false);
+        $post->attachments = $files->get_area_files($bcontextid, 'mod_oublog', 'attachment', $post->id, 'itemid', false);
+        if (empty($post->images)) {
+            $post->images = array();
+        }
+        if (empty($post->attachments)) {
+            $post->attachments = array();
+        }
+    }
+    // Add in post tags from single query.
+    list($inwhere, $inparams) = $DB->get_in_or_equal(array_keys($posts));
+    $tsql = 'SELECT t.*, ti.postid
+        FROM {oublog_taginstances} ti
+        INNER JOIN {oublog_tags} t ON ti.tagid = t.id
+        WHERE ti.postid ' . $inwhere;
+    $rs = $DB->get_recordset_sql($tsql, $inparams);
+    foreach ($rs as $tag) {
+        $postid = $tag->postid;
+        if (!isset($posts[$postid]->tags)) {
+            $posts[$postid]->tags = array();
+        }
+        $posts[$postid]->tags[] = $tag;
+    }
+    $rs->close();
+    if ($inccomments) {
+        // Get comments for post on the page.
+        $sql = "SELECT c.*
+            FROM {oublog_comments} c
+            WHERE c.postid $inwhere AND c.deletedby IS NULL AND c.userid = ?
+            ORDER BY c.timeposted ASC";
+        $inparams[] = $userid;
+        $rs = $DB->get_recordset_sql($sql, $inparams);
+        foreach ($rs as $comment) {
+            $comment->images = $files->get_area_files($bcontextid, 'mod_oublog', 'messagecomment',
+                        $comment->id, 'itemid', false);
+            if (empty($comment->images)) {
+                $comment->images = array();
+            }
+            $posts[$comment->postid]->comments[$comment->id] = $comment;
+        }
+        $rs->close();
+    }
+    return $posts;
+}
+
+class oublog_participation_timefilter_form extends moodleform {
+
+    public function definition() {
+        global $CFG;
+
+        $mform =& $this->_form;
+        $cdata = $this->_customdata;
+        /*
+         * We Expect custom data to have following format:
+         * 'cmid' => blog course module id
+         * 'startyear' => course startyear
+         * 'params' => key(name)/value array to make into hidden inputs (value must be integer)
+         */
+        if (!empty($cdata['params']) && is_array($cdata['params'])) {
+            foreach ($cdata['params'] as $param => $value) {
+                $mform->addElement('hidden', $param, $value);
+                $mform->setType($param, PARAM_INT);
+            }
+        }
+        // Data selectors, with optional enabling checkboxes.
+        $mform->addElement('date_selector', 'start',
+                get_string('start', 'oublog'), array('startyear' => gmdate("Y", $cdata['startyear']),
+                        'stopyear' => gmdate("Y"), 'optional' => true));
+        $mform->addHelpButton('start', 'displayperiod', 'oublog');
+
+        $mform->addElement('date_selector', 'end',
+                get_string('end', 'oublog'), array('startyear' => gmdate("Y", $cdata['startyear']),
+                        'stopyear' => gmdate("Y"), 'optional' => true));
+
+        if (isset($cdata['type'])) {
+            $mform->addElement('hidden', 'type', $cdata['type']);
+            $mform->setType('type', PARAM_ALPHA);
+        }
+        if (isset($cdata['cmid'])) {
+            $mform->addElement('hidden', 'id', $cdata['cmid']);
+            $mform->setType('id', PARAM_INT);
+        }
+        if (isset($cdata['user'])) {
+            $mform->addElement('hidden', 'user', $cdata['user']);
+            $mform->setType('user', PARAM_INT);
+        }
+        if (isset($cdata['group'])) {
+            $mform->addElement('hidden', 'group', $cdata['group']);
+            $mform->setType('group', PARAM_INT);
+        }
+        $this->add_action_buttons(false, get_string('timefilter_submit', 'oublog'));
+    }
+
+    public function validation($data, $files) {
+        $errors = parent::validation($data, $files);
+        if (!empty($data['start']) and !empty($data['end'])) {
+            if ($data['start'] > $data['end']) {
+                $errors['start'] = get_string('timestartenderror', 'oublog');
+            }
+        }
+        return $errors;
+    }
+}
diff --git a/mod/oublog/migratepersonal.php b/mod/oublog/migratepersonal.php
new file mode 100644
index 0000000..1b486d7
--- /dev/null
+++ b/mod/oublog/migratepersonal.php
@@ -0,0 +1,1028 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Import migrated personal blogs from a 1.9 system
+ * These reside in dataroot  - provides means to delete imported data files
+ *
+ * @package    mod
+ * @subpackage oublog
+ * @copyright  2012 The open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+require_once(dirname(__FILE__) . '/../../config.php');
+require_once($CFG->dirroot . '/auth/sams_soap/auth.php');
+require_once($CFG->dirroot . '/mod/oublog/locallib.php');
+require_once($CFG->dirroot . '/mod/oublog/lib.php');
+
+require_login();
+$context = context_system::instance();
+require_capability('moodle/site:config', $context);
+
+$datadir = $CFG->dataroot . '/oublog/migration';
+
+$action = optional_param('action', 'NONE', PARAM_ALPHA);
+
+$PAGE->set_context($context);
+$PAGE->set_url('/mod/oublog/migratepersonal.php', array('action' => $action));
+
+// Setup form for uploading zip files.
+require_once("$CFG->libdir/formslib.php");
+require_once("$CFG->libdir/uploadlib.php");
+class importpersonal extends moodleform {
+    public function definition() {
+        $mform =& $this->_form;
+        $mform->addElement('filepicker', 'attachment', 'Import 1.9 data zip', null, array('accepted_types' => '*.zip'));
+        $this->add_action_buttons(false, 'Import');
+    }
+}
+$form = new importpersonal();
+
+if ($data = $form->get_data()) {
+    // Upload file.
+    @raise_memory_limit(MEMORY_EXTRA);
+    @set_time_limit(0);
+    $file = $form->save_temp_file('attachment');
+    output('', true);
+    $fp = get_file_packer();
+    // Check file is vaild.
+    $files = $fp->list_files($file);
+    output('', true);
+    if (!isset($files[0]->pathname) || strpos($files[0]->pathname, 'pb') !== 0) {
+        print_error('Invalid migration zip file.');
+    }
+    $fp->extract_to_pathname($file, $datadir);
+    unlink($file);
+    output('Unzipped file ready for importing');
+    echo $OUTPUT->continue_button($PAGE->url);
+    exit;
+}
+
+print $OUTPUT->header();
+
+print $OUTPUT->heading('Import migrated personal blog data');
+
+if ($action == 'DELETE') {
+    // Delete an attempt folder.
+    require_sesskey();
+    $name = required_param('name', PARAM_PATH);
+    $dirname = $datadir . '/' . $name;
+    if (!file_exists($dirname) || $name == '' || strpos($name, 'pb') === false) {
+        print_error('Directory does not exist.');
+    }
+    if (optional_param('confirm', false, PARAM_BOOL)) {
+        if (fulldelete($dirname)) {
+            print 'Folder deleted.';
+        }
+    } else {
+        $link = $CFG->wwwroot . '/mod/oublog/migratepersonal.php';
+        $params = "?action=DELETE&name=$name&confirm=1&sesskey=" . sesskey();
+        print $OUTPUT->confirm('Are you sure you want to delete?', $link . $params, $link);
+    }
+} else if ($action == 'GO') {
+    require_sesskey();
+    $name = required_param('name', PARAM_PATH);
+    $dirname = $datadir . '/' . $name;
+    if (!file_exists($dirname) || $name == '' || strpos($name, 'pb') === false) {
+        print_error('Directory does not exist.');
+    }
+    if (optional_param('confirm', false, PARAM_BOOL)) {
+        // Process the folder.
+        @raise_memory_limit(MEMORY_EXTRA);
+        @set_time_limit(0);
+        migrate_backup($dirname);
+    } else {
+        if (!file_exists($dirname . '/success.txt') || !file_exists($dirname . '/oublog.xml')) {
+            print_error('Data no good. Missing key files.');
+        }
+        // File checks/info.
+        $doc = new DOMDocument();
+        $doc->load($dirname . '/oublog.xml');
+        $instances = $doc->getElementsByTagName('INSTANCE');
+        print '<p>' . $instances->length . ' instances in dataset.</p>';
+        if (file_exists($dirname . '/imported.xml')) {
+            $doc = new DOMDocument();
+            $doc->load($dirname . '/imported.xml');
+            $tags = $doc->getElementsByTagName('instance');
+            print '<p>Have processed ' . $tags->length . ' previously.</p>';
+        }
+        $link = $CFG->wwwroot . '/mod/oublog/migratepersonal.php';
+        $params = "?action=GO&name=$name&confirm=1&sesskey=" . sesskey();
+        $form = $OUTPUT->confirm('You cannot undo this (it will attempt to rollback DB on error). Continue?',
+                $link . $params, $link);
+        // Add in server image/link match switching.
+        $form = str_replace('<input type="submit" value="Continue" />',
+                '<input id="acct" name="acct" type="checkbox">Images point to Acct?</input><br />
+                <input name="kill" type="checkbox" checked="checked">Trial (rollback transactions)?</input><br />
+                <label for="total">Instances to process in this run:</label>
+                <select id="total" name="total">
+                <option value="0">All available</option>
+                <option value="500">500</option>
+                <option value="1000">1000</option>
+                <option value="5000">5000</option>
+                </select><br />
+                <input name="ignore" type="checkbox">Re-process instances already added? (Really shouldn\'t select this)</input><br />
+                <input name="tagsonly" type="checkbox">Fix already imported posts tags (and nothing else)</input><br />
+                <input type="submit" value="Continue" />', $form);
+        $form .= '<p>Select checkbox when images and urls in data set are pointing to learnacct not live server.</p>
+                 <p>Only select to fix tags when a version of the migration script where they were not imported correctly was used.</p>
+                    <p>Once successfully added an instance will not be processed again and will be skipped.</p>';
+        echo $form;
+    }
+}
+
+if ($action == 'NONE') {
+    // SHOW MAIN INTERFACE.
+    // Show number of personal blog instances.
+    if (!$blog = $DB->get_record('oublog', array('global' => 1))) {
+        print_error('globalblogmissing', 'oublog');
+    }
+    $bloginsts = $DB->get_record_sql('SELECT COUNT(id) as count FROM {oublog_instances} WHERE oublogid = ?',
+            array($blog->id));
+    print "<p>There are <strong>$bloginsts->count</strong> personal blog instances on the system at present";
+    print '<br />Imported instances will not override their settings - posts will be added to existing instances</p>';
+    $form->display();
+    // Display list of previous attempts and provide some management of these.
+    $attemps = array();
+    // Get folder info.
+    if (file_exists($datadir)) {
+        $folders = glob($datadir . '/pb*', GLOB_ONLYDIR);
+        foreach ($folders as $folder) {
+            $info = new stdClass();
+            $info->path = $folder;
+            $info->folder = substr($folder, strrpos($folder, '/') + 1);
+            $info->size = 0;
+            $info->size = @exec("du -b $folder | awk '{print $1}'");
+            $info->date = str_replace('pb', '', $info->folder);
+            $info->ok = file_exists($folder . '/success.txt') ? 'OK' : 'Failed';
+            $attemps[] = $info;
+        }
+    }
+    // Now show.
+    print '<div id="existing"><p>Previous backups:</p>';
+    foreach ($attemps as $attempt) {
+        print '<p>' . userdate($attempt->date) . ' : ' . formatbytes($attempt->size) . ' (' . $attempt->ok . ') ';
+        // Delete.
+        print '<a href="' . $CFG->wwwroot . '/mod/oublog/migratepersonal.php?action=DELETE&name=' . $attempt->folder . '&sesskey=' . sesskey() . '">';
+        print $OUTPUT->pix_icon('t/delete', 'Delete') . '</a> ';
+        // Zip.
+        print '<a href="' . $CFG->wwwroot . '/mod/oublog/migratepersonal.php?action=GO&name=' . $attempt->folder . '&sesskey=' . sesskey() . '">';
+        print $OUTPUT->pix_icon('i/restore', 'Import data') . '</a>';
+        print '</p>';
+    }
+    print '</div>';
+}
+
+print $OUTPUT->footer();
+exit;
+
+/**
+ * Start the import of personal blog data
+ * @param string $dir path of directory containing backup data
+ */
+function migrate_backup($dir) {
+    global $DB, $CFG, $SOURCESERVER;
+    $SOURCESERVER = 'http://learn.open.ac.uk';
+    if (optional_param('acct', false, PARAM_BOOL)) {
+        $SOURCESERVER = 'http://learnacct.open.ac.uk';
+    }
+    if ($kill = optional_param('kill', false, PARAM_BOOL)) {
+        output('<b>Trial run</b>, will perform rollback on each instance.');
+    }
+    if ($tagsonly = optional_param('tagsonly', false, PARAM_BOOL)) {
+        output('<b>Tags only</b>, will only fix tags, not add posts.');
+    }
+    // Load in XML.
+    $doc = new DOMDocument();
+    $doc->load($dir . '/oublog.xml');
+    $instancetags = $doc->getElementsByTagName('INSTANCE');
+    output('Total = ' . $instancetags->length . ' instances ');
+
+    $total = required_param('total', PARAM_INT);
+    $max = $total == 0 ? $instancetags->length + 1 : $total;
+    output('Max instances to process: ' . $max);
+
+    // Get xml that stores old instance ID's of those instances already processed.
+    $donedoc = new DOMDocument();
+    $done = array();
+    $donetag = null;
+    if (!optional_param('ignore', false, PARAM_BOOL) && file_exists($dir . '/imported.xml')) {
+        $donedoc->load($dir . '/imported.xml');
+        $donestr = $donedoc->saveXML();
+        $donetag = $donedoc->getElementsByTagName('imported')->item(0);
+        $tags = $donetag->childNodes->item(0);
+        while ($tags != null) {
+            // Store ids in array using fast looping.
+            $done[$tags->nodeValue] = '';
+            $tags->parentNode->removeChild($tags);
+            $tags = $donetag->childNodes->item(0);
+        }
+        // Reinstate childnodes.
+        $donedoc->loadXML($donestr);
+        $donestr = null;
+        output('Have already processed ' . count($done) . ' instances');
+    } else {
+        $donedoc->appendChild($donedoc->createElement('imported'));
+    }
+    $donetag = $donedoc->getElementsByTagName('imported')->item(0);
+    $count = 0;
+    $instances = array();// Stores data (as object) about each instance in array.
+    $tags = $instancetags->item(0);
+    // Fast looping of node list by always accessing first tag (faster than foreach).
+    while ($tags != null && $count < $max) {
+        $info = childnodes_to_object($tags);
+        // Remove tag we just processed.
+        $tags->parentNode->removeChild($tags);
+        // Get the next tag to parse.
+        $tags = $instancetags->item(0);
+        // Have we processed this instance before? If so, skip.
+        if (isset($done[$info->id])) {
+            $info = null;
+            continue;
+        }
+        $instances[$info->id] = $info;
+        $info = null;
+        $count++;
+    }
+    // Throw away xml as no longer need.
+    $doc = null;
+    $instancetags = null;
+    $tags = null;
+    output("Ready to process $count instances");
+
+    // Process each blog instance - checking for existing user instance.
+    $blog = $DB->get_record('oublog', array('global' => 1), 'id', MUST_EXIST);
+    $blog->global = 1;
+    output('Got global blog record');
+    if (!$cm = get_coursemodule_from_instance('oublog', $blog->id)) {
+        print_error('invalidcoursemodule');
+    }
+    $blogcontext = context_module::instance($cm->id);
+
+    // Vars used to store blog user content xml data.
+    $xmlcontent = new DOMDocument();
+    $xmlfilenum = -1;
+    $xpath = null;// Xpath for current content xml file.
+
+    foreach ($instances as &$instance) {
+        // Transaction per instance (ensure any existing are cleared up).
+        if (isset($trans) && ($trans instanceof moodle_transaction)) {
+            // Commit what has been done (errors will have rolled back already).
+            $DB->commit_delegated_transaction($trans);
+            $trans = null;
+        }
+        $trans = $DB->start_delegated_transaction();
+        try {
+            // Find/create user.
+            if (!$instance->newuserid = oublog_search_create_user($instance)) {
+                output("<b>Error: Skipping blog for $instance->username</b>");
+                continue;
+            }
+
+            // Work out new instance number (either from new or existing record).
+            if ($bloginst = $DB->get_record('oublog_instances',
+                    array('oublogid' => $blog->id, 'userid' => $instance->newuserid), 'id')) {
+                $instance->newid = $bloginst->id;
+                $bloginst = null;
+            } else {
+                if ($tagsonly) {
+                    output("<b>Error: Skipping create instance for {$instance->username} as in tag only mode</b>");
+                    continue;
+                }
+                // Create instance.
+                $newbloginst = new stdClass();
+                $newbloginst->oublogid = $blog->id;
+                $newbloginst->userid = $instance->newuserid;
+                $newbloginst->name = $instance->name;
+                $newbloginst->summary = blogxml_isempty($instance->summary) ? '' : $instance->summary;
+                $newbloginst->summary = oublog_decode_perbloglinks($newbloginst->summary, $xpath);
+                $newbloginst->accesstoken = $instance->accesstoken;
+                $newbloginst->views = $instance->views;
+                if (!($instance->newid = $DB->insert_record('oublog_instances', $newbloginst))) {
+                    output("<b>Failed to add blog instance $instance->name</b>");
+                    continue;
+                }
+                $newbloginst = null;
+                // Migrate any mystuff images in summary.
+                if (strpos($instance->summary, '@@PLUGINFILE@@')
+                        || stripos($instance->summary, $SOURCESERVER . '/pix/smartpix.php/ou/s/')) {
+                    $updaterec = new stdClass();
+                    $updaterec->id = $instance->newid;
+                    $updaterec->summary = oublog_add_files($instance->summary, $dir, $blogcontext->id,
+                            'summary', $instance->newid);
+                    $DB->update_record('oublog_instances', $updaterec);
+                    $updaterec = null;
+                }
+            }
+
+            output('Finished setup blog instance for ' . $instance->username . ' :new id=' . $instance->newid);
+
+            // What is XML file for current instance, load if not current one.
+            $instfilenum = get_filenumber($instance->id);
+            if ($instfilenum != $xmlfilenum) {
+                // Load our XML into current var.
+                if (!$xmlcontent->load($dir . '/i' . $instfilenum . '.xml')) {
+                    output('<b>Error: Failed to load user data</b> file number ' . $instfilenum);
+                    continue;
+                }
+                $xmlfilenum = $instfilenum;
+                $xpath = new DOMXPath($xmlcontent);
+                // Get data from XML into vars for quick access.
+                $alllinks = array();
+                $linktags = $xmlcontent->getElementsByTagName('LINK');
+                foreach ($linktags as $l) {
+                    $linkob = childnodes_to_object($l);
+                    if (!isset($alllinks[$linkob->oubloginstancesid])) {
+                        $alllinks[$linkob->oubloginstancesid] = array();
+                    }
+                    $alllinks[$linkob->oubloginstancesid][] = $linkob;
+                    $linkob = null;
+                }
+                $linktags = null;
+                if ($tagsonly) {
+                    $alllinks = array();// Ignore any links in tag fix mode;
+                }
+                $allusers = array();
+                $usertags = $xmlcontent->getElementsByTagName('USER');
+                foreach ($usertags as $t) {
+                    $allusers[$t->getAttribute('id')] = childnodes_to_object($t);
+                }
+                $usertags = null;
+                $allposts = array();
+                $posttags = $xmlcontent->getElementsByTagName('POST');
+                $tag = $posttags->item(0);
+                // Fast looping for posts as probably the most tags.
+                while ($tag != null) {
+                    $linkob = childnodes_to_object($tag);
+                    $tag->parentNode->removeChild($tag);
+                    $tag = $posttags->item(0);
+                    if (!isset($linkob->oubloginstancesid)) {
+                        continue;
+                    }
+                    if (!isset($allposts[$linkob->oubloginstancesid])) {
+                        $allposts[$linkob->oubloginstancesid] = array();
+                    }
+                    $allposts[$linkob->oubloginstancesid][] = $linkob;
+                    $linkob = null;
+                }
+                $posttags = null;
+                $alltags = array();
+                $tagtags = $xmlcontent->getElementsByTagName('TAG');
+                foreach ($tagtags as $l) {
+                    $linkob = childnodes_to_object($l);
+                    if (!isset($linkob->postid)) {
+                        continue;
+                    }
+                    if (!isset($alltags[$linkob->postid])) {
+                        $alltags[$linkob->postid] = array();
+                    }
+                    $alltags[$linkob->postid][] = $linkob;
+                    $linkob = null;
+                }
+                $tagtags = null;
+                $alledits = array();
+                $edittags = $xmlcontent->getElementsByTagName('EDIT');
+                foreach ($edittags as $l) {
+                    $linkob = childnodes_to_object($l);
+                    if (!isset($linkob->postid)) {
+                        continue;
+                    }
+                    if (!isset($alledits[$linkob->postid])) {
+                        $alledits[$linkob->postid] = array();
+                    }
+                    $alledits[$linkob->postid][] = $linkob;
+                    $linkob = null;
+                }
+                $edittags = null;
+                if ($tagsonly) {
+                    $alledits = array();// Ignore any edits in tag fix mode;
+                }
+                $allcomments = array();
+                $commenttags = $xmlcontent->getElementsByTagName('COMMENT');
+                foreach ($commenttags as $l) {
+                    $linkob = childnodes_to_object($l);
+                    if (!isset($linkob->postid)) {
+                        continue;
+                    }
+                    if (!isset($allcomments[$linkob->postid])) {
+                        $allcomments[$linkob->postid] = array();
+                    }
+                    $allcomments[$linkob->postid][] = $linkob;
+                    $linkob = null;
+                }
+                $commenttags = null;
+                if ($tagsonly) {
+                    $allcomments = array();// Ignore any comments in tag fix mode;
+                }
+                output('Loaded user data file ' . $xmlfilenum);
+            }
+            // Store posts info for this instance (used in link checks).
+            $postinfo = array();
+            if (isset($allposts[$instance->id])) {
+                // Create a clone of the array as it contains objects...
+                $postinfo = serialize($allposts[$instance->id]);
+                $postinfo = unserialize($postinfo);
+            }
+
+            // Create instance links.
+            // $links = $xpath->query("/DATA/LINKS/LINK[OUBLOGINSTANCESID=$instance->id]");
+            $links = array();
+            if (isset($alllinks[$instance->id])) {
+                $links = $alllinks[$instance->id];
+            }
+            $linksa = array();
+            // Sort by SORTORDER - so lowest first.
+            foreach ($links as $newlink) {
+                // Create new link object and add to our new array.
+                // $newlink = childnodes_to_object($link);
+                $newlink->oubloginstancesid = $instance->newid;
+                $newlink->oublogid = $blog->id;
+                unset($newlink->id);
+                if (!isset($newlink->sortorder)) {
+                    $newlink->sortorder = 0;
+                }
+                $linksa[] = $newlink;
+            }
+            $links = null;
+            // Sort by SORTORDER - so lowest first.
+            usort($linksa, 'oublog_sort_links');
+            foreach ($linksa as $link) {
+                // Create link.
+                $link->url = oublog_decode_perbloglinks($link->url, $xpath, $postinfo, $instance->userid);
+                if (!oublog_add_link($link)) {
+                    output("Error: Failed to create link for blog:$instance->newid");
+                }
+            }
+            $linksa = null;
+            // End of link creation code.
+            output('Finished links');
+            output('Processing posts');
+            // PROCESS Blog posts.
+            $instance->postmapping = array();// Store old + new ids.
+            // $posts = $xpath->query("/DATA/POSTS/POST[OUBLOGINSTANCESID=$instance->id]");
+            $posts = array();
+            if (isset($allposts[$instance->id])) {
+                $posts = $allposts[$instance->id];
+            }
+            output(count($posts) . ' posts to process');
+            foreach ($posts as $newpost) {
+                // Sort out post object ready to save.
+                // $newpost = childnodes_to_object($post);
+                $oldid = $newpost->id;
+                unset($newpost->id);
+                $newpost->groupid = 0;// Just in case!
+                $newpost->oubloginstancesid = $instance->newid;
+                if (!is_null($newpost->deletedby)) {
+                    if ($tagsonly) {
+                        continue;// Don't update deleted post tags.
+                    }
+                    if ($newpost->deletedby == $instance->userid) {
+                        // Most of the time will be blog user.
+                        $newpost->deletedby = $instance->newuserid;
+                    } else {
+                        // Find mapped user id in this system.
+                        // $users = $xpath->query("/DATA/USERS/USER[@id=$newpost->deletedby]");
+                        $users = isset($allusers[$newpost->deletedby]) ? $allusers[$newpost->deletedby] : false;
+                        if (!$users) {
+                            $newpost->deletedby = false;
+                        } else {
+                            $newpost->deletedby = oublog_search_create_user($users);
+                        }
+                        if ($newpost->deletedby == false) {
+                            output("Error: Failed to get/make user id for deletedby, old post id: $oldid");
+                            $newpost->deletedby = $instance->newuserid;
+                        }
+                    }
+                }
+                if (!$tagsonly) {
+                    if (!is_null($newpost->lasteditedby)) {
+                        if ($newpost->lasteditedby == $instance->userid) {
+                            // Most of the time will be blog user.
+                            $newpost->lasteditedby = $instance->newuserid;
+                        } else {
+                            // Find mapped user id in this system.
+                            // $users = $xpath->query("/DATA/USERS/USER[@id=$newpost->lasteditedby]");
+                            $users = isset($allusers[$newpost->lasteditedby]) ? $allusers[$newpost->lasteditedby] : false;
+                            if (!$users) {
+                                $newpost->lasteditedby = false;
+                            } else {
+                                $newpost->lasteditedby = oublog_search_create_user($users);
+                            }
+                            if ($newpost->lasteditedby == false) {
+                                output("Error: Failed to get/make user id for edited by, old post id: $oldid");
+                                $newpost->lasteditedby = $instance->newuserid;
+                            }
+                        }
+                    }
+                    $newpost->message = oublog_decode_perbloglinks($newpost->message, $xpath, $postinfo, $instance->userid);
+                    if (!$postid = $DB->insert_record('oublog_posts', $newpost)) {
+                        output("<b>Error: Failed to create post, old id = $oldid</b>");
+                        continue;
+                    }
+                } else {
+                    // Tag fix only mode. Search for post previously created to use as $postid.
+                    if (!$post = $DB->get_record_sql('select id, message from {oublog_posts} where oubloginstancesid
+                             = :oubloginstancesid and timeposted = :timeposted and title = :title and deletedby is null',
+                            array('oubloginstancesid' => $instance->newid, 'timeposted' => $newpost->timeposted,
+                                'title' => $newpost->title))) {
+                        output("<b>Error: Failed to find post (TAG FIX), old id = $oldid</b>");
+                        continue;
+                    }
+                    $postid = $post->id;
+                    $newpost->message = $post->message;// Ensure matches that on system.
+                    // Store existing tags so any extra added not removed.
+                    $tagnames = oublog_get_post_tags($post);
+                    $post = null;
+                }
+                $instance->postmapping[$oldid] = $postid;// Record old/new id mapping.
+                output('', true);// Output dots.
+                // Migrate any mystuff images in message.
+                if (!$tagsonly && (strpos($newpost->message, '@@PLUGINFILE@@')
+                        || stripos($newpost->message, $SOURCESERVER . '/pix/smartpix.php/ou/s/'))) {
+                    $updaterec = new stdClass();
+                    $updaterec->id = $postid;
+                    $updaterec->message = oublog_add_files($newpost->message, $dir, $blogcontext->id,
+                            'message', $postid);
+                    $DB->update_record('oublog_posts', $updaterec);
+                    $updaterec = null;
+                }
+                // Add post tags (also used in search to save DB query).
+                $newpost->tags = array();
+                // $tags = $xpath->query("/DATA/TAGS/TAG[POSTID=$oldid]");
+                if (!$tagsonly || empty($tagnames)) {
+                    $tagnames = array();
+                }
+                $tags = array();
+                if (isset($alltags[$oldid])) {
+                    $tags = $alltags[$oldid];
+                }
+                foreach ($tags as $tag) {
+                    $tagnames[] = $tag->tagname;
+                }
+                if (!empty($tagnames)) {
+                    $tagnames = array_unique(array_filter($tagnames));
+                    oublog_update_item_tags($instance->newid, $postid, $tagnames);
+                    $newpost->tags = $tagnames;
+                    $tagnames = null;
+                }
+                if (is_null($newpost->deletedby)) {
+                    // Update search.
+                    $newpost->id = $postid;
+                    $newpost->userid = $instance->newuserid;
+                    oublog_search_update($newpost, $cm);
+                    output('', true);
+                }
+                $newpost = null;
+            }
+            $posts = null;
+            // End Blog post processing.
+            output('Finished Posts');
+            // From now on all data is got from looping through postmapping array each time.
+
+            // PROCESS Blog EDITS.
+            foreach ($instance->postmapping as $oldpostid => $newpostid) {
+                // $edits = $xpath->query("/DATA/EDITS/EDIT[POSTID=$oldpostid]");
+                $edits = array();
+                if (isset($alledits[$oldpostid])) {
+                    $edits = $alledits[$oldpostid];
+                }
+                foreach ($edits as $newedit) {
+                    // Sort out edit object ready to save.
+                    // $newedit = childnodes_to_object($edit);
+                    unset($newedit->id);
+                    $newedit->postid = $newpostid;
+                    if ($newedit->userid == $instance->userid) {
+                        // Most of the time will be blog user.
+                        $newedit->userid = $instance->newuserid;
+                    } else {
+                        // Find mapped user id in this system.
+                        // $users = $xpath->query("/DATA/USERS/USER[@id=$newedit->userid]");
+                        $users = isset($allusers[$newedit->userid]) ? $allusers[$newedit->userid] : false;
+                        if (!$users) {
+                            $newedit->userid = false;
+                        } else {
+                            $newedit->userid = oublog_search_create_user($users);
+                        }
+                        if ($newedit->userid == false) {
+                            output("Error: Failed to get/make user id for edit rec, old post id: $oldpostid");
+                            $newedit->userid = $instance->newuserid;
+                        }
+                    }
+                    $newedit->oldmessage = oublog_decode_perbloglinks($newedit->oldmessage, $xpath, $postinfo, $instance->userid);
+                    output('', true);// Output dots.
+                    // Migrate any mystuff images in message.
+                    if (strpos($newedit->oldmessage, '@@PLUGINFILE@@')
+                            || stripos($newedit->oldmessage, $SOURCESERVER . '/pix/smartpix.php/ou/s/')) {
+                        $newedit->oldmessage = oublog_add_files($newedit->oldmessage, $dir, $blogcontext->id,
+                                'message', $newpostid);
+                    }
+                    if (!$newid = $DB->insert_record('oublog_edits', $newedit)) {
+                        output("Error: Failed to create edit for old post id: $oldpostid");
+                        continue;
+                    }
+                    $newedit = null;
+                }
+                $edits = null;
+            }
+            output('Finished edits');
+            // End Blog EDITS processing.
+
+            // Process blog comments (Standard + Approved only).
+            foreach ($instance->postmapping as $oldpostid => $newpostid) {
+                // $comments = $xpath->query("/DATA/COMMENTS/COMMENT[POSTID=$oldpostid]");
+                $comments = array();
+                if (isset($allcomments[$oldpostid])) {
+                    $comments = $allcomments[$oldpostid];
+                }
+                foreach ($comments as $newcomment) {
+                    // Sort out edit object ready to save.
+                    // $newcomment = childnodes_to_object($comment);
+                    $newcomment->postid = $newpostid;
+                    if (!blogxml_isempty($newcomment->userid)) {
+                        if ($newcomment->userid == $instance->userid) {
+                            // Most of the time will be blog user.
+                            $newcomment->userid = $instance->newuserid;
+                        } else {
+                            // Find mapped user id in this system.
+                            // $users = $xpath->query("/DATA/USERS/USER[@id='$newcomment->userid']");
+                            $users = isset($allusers[$newcomment->userid]) ? $allusers[$newcomment->userid] : false;
+                            if (!$users || empty($users)) {
+                                $newcomment->userid = false;
+                            } else {
+                                $newcomment->userid = oublog_search_create_user($users);
+                            }
+                            if ($newcomment->userid == false) {
+                                output("Error: Failed to get/make user id for comment, old id: $newcomment->id file:$xmlfilenum");
+                                continue;// Skip this comment.
+                            }
+                        }
+                    }
+                    if (!blogxml_isempty($newcomment->deletedby)) {
+                        if ($newcomment->deletedby == $instance->userid) {
+                            // Most of the time will be blog user.
+                            $newcomment->deletedby = $instance->newuserid;
+                        } else {
+                            // Find mapped user id in this system.
+                            // $users = $xpath->query("/DATA/USERS/USER[@id=$newcomment->deletedby]");
+                            $users = isset($allusers[$newcomment->deletedby]) ? $allusers[$newcomment->deletedby] : false;
+                            if (!$users) {
+                                $newcomment->deletedby = false;
+                            } else {
+                                $newcomment->deletedby = oublog_search_create_user($users);
+                            }
+                            if ($newcomment->deletedby == false) {
+                                output("Error: Failed to get/make user id for comment deletedby, old id: $newcomment->id");
+                                $newcomment->deletedby = $instance->newuserid;
+                            }
+                        }
+                    }
+                    $newcomment->message = oublog_decode_perbloglinks($newcomment->message, $xpath, $postinfo, $instance->userid);
+                    unset($newcomment->id);
+                    if (!$newid = $DB->insert_record('oublog_comments', $newcomment)) {
+                        output("Error: Failed to create comment for old post id: $oldpostid");
+                        continue;
+                    }
+                    output('', true);// Output dots.
+                    // Migrate any mystuff images in message.
+                    if (strpos($newcomment->message, '@@PLUGINFILE@@')
+                            || stripos($newcomment->message, $SOURCESERVER . '/pix/smartpix.php/ou/s/')) {
+                        $updaterec = new stdClass();
+                        $updaterec->id = $newid;
+                        $updaterec->message = oublog_add_files($newcomment->message, $dir, $blogcontext->id,
+                                'messagecomment', $newid);
+                        $DB->update_record('oublog_comments', $updaterec);
+                        $updaterec = null;
+                    }
+                    $newcomment = null;
+                }
+                $comments = null;
+            }
+            output('Finished comments');
+            // End comments.
+
+            // Commit everything in this instance.
+            if ($kill) {
+                throw new moodle_exception('kill');
+            } else {
+                // Commit and save that instance has been imported.
+                $trans->allow_commit();
+                $trans->dispose();
+                $donetag->appendChild($donedoc->createElement('instance', $instance->id));
+                if (!$donedoc->save($dir . '/imported.xml')) {
+                    output('<b>Error saving xml record of instance, will be picked up next save</b>');
+                }
+            }
+        } catch (moodle_exception $e) {
+            output('<b>Code error:</b> ' . $e->debuginfo);
+            try {
+                output('Rollback transation');
+                $trans->rollback($e);
+            } catch (moodle_exception $e) {
+                output('<b>Code error:</b> ' . $e->debuginfo);
+                $trans = null;
+                continue;
+            } catch (Exception $e) {
+                output('<b>Code error:</b> ' . $e->debuginfo);
+                $trans = null;
+                continue;
+            }
+        } catch (Exception $e) {
+            output('<b>Code error:</b> ' . $e->debuginfo);
+            $trans->rollback($e);
+            $trans = null;
+            continue;
+        }
+        $trans = null;
+    }
+
+    output('<b>Finished</b>');
+}
+
+/**
+ * Searches for user based on username.
+ * Creates a new user if not exist, based on info sent.
+ * Mirrors SAMS SOAP user creation.
+ * @param object $info
+ * @return int new ID or false
+ */
+function oublog_search_create_user($info) {
+    global $DB, $CFG;
+    if (empty($info->username)) {
+        return false;
+    }
+    // Check our local static cache of users already processed.
+    static $users;
+    if (!isset($users)) {
+        $users = array();
+    } else if (!empty($users[$info->username])) {
+        return $users[$info->username];
+    }
+    // Does user exist in system?
+    if ($user = $DB->get_record('user', array('username' => $info->username), 'id')) {
+        $info->newuserid = $user->id;
+    } else {
+        // Create user record with min info - expecting it to be updated when user logs in.
+        $user = new stdClass();
+        $user->username = $info->username;
+        $user->firstname = !blogxml_isempty($info->firstname)
+        ? $info->firstname : 'New';
+        $user->lastname = !blogxml_isempty($info->lastname)
+        ? $info->lastname : 'User';
+        $user->idnumber = isset($info->idnumber) ? $info->idnumber : '';
+        $user->email = !blogxml_isempty($info->email)
+        ? $info->email : 'lts-vle-noreply@open.ac.uk';
+        if ($user->email == 'lts-vle-noreply@open.ac.uk') {
+            $user->emailstop = 1;
+        }
+        $user->country = 'GB';
+        $user->mnethostid = $CFG->mnet_localhost_id;
+        $user->lang = $CFG->lang;
+        $user->confirmed = 1;
+        $user->auth = 'sams_soap';
+        $user->firstaccess = time();
+        $user->picture = 0;
+        $user->maildisplay = 0;
+        // Set a dummy password (we won't ever check it).
+        $user->password = hash_internal_user_password('SAMSsupplied');
+        $user->trackforums = 1;
+        try {
+            $user->id = $DB->insert_record('user', $user, true);
+        } catch (moodle_exception $e) {
+            output("<strong>Failed to add user $user->username</strong>");
+            return false;
+        }
+        // Add user to role.
+        try {
+            $auth = new auth_plugin_sams_soap();
+            $auth->assign_role($user);
+        } catch (moodle_exception $e) {
+            output("<strong>Failed to assign user role for $user->username<strong>");
+        }
+        $info->newuserid = $user->id;
+        $user = null;
+    }
+    $users[$info->username] = $info->newuserid;
+    return $info->newuserid;
+}
+
+/**
+ * Finds refs to images in text and adds files to DB and rewrite text content
+ * @param string $text - text to search/replace
+ * @param string $dir - dir to get images from
+ * @param int $contextid
+ * @param string $filearea - name of file area to add to
+ * @param int $itemid - number of item id to use in files table
+ */
+function oublog_add_files($text, $dir, $contextid, $filearea, $itemid) {
+    global $CFG, $OUTPUT, $SOURCESERVER;
+    if (strpos($text, '@@PLUGINFILE@@')) {
+        require_once($CFG->dirroot . '/lib/filestorage/file_storage.php');
+        static $knownfiles;
+        if (!isset($knownfiles)) {
+            $knownfiles = array();
+        }
+        $pattern = '#<img.*?src="(@@PLUGINFILE@@(.*?))"#';
+        preg_match_all($pattern, $text, $matches);
+        $filerecord = new stdClass();
+        $filerecord->filearea = $filearea;
+        $filerecord->itemid = $itemid;
+        $filerecord->contextid = $contextid;
+        $filerecord->component = 'mod_oublog';
+        $filerecord->filepath = '/';
+        $fs = get_file_storage();
+        for ($a = 0, $len = count($matches[2]); $a < $len; $a++) {
+            // Add MyStuff images in a folder based on user name.
+            $match = $matches[2][$a];
+            try {
+                $paths = explode('/', $match);
+                $filerecord->filename = array_pop($paths);
+                if (strpos($filerecord->filename, '.')) {
+                    // Looks like we got filename OK so try and store, check if already done first.
+                    if (!isset($knownfiles[$contextid . $filearea . $itemid . $filerecord->filename])) {
+                        // Import file into system.
+                        if (!$fs->file_exists($contextid, 'mod_oublog', $filearea, $itemid, '/', $filerecord->filename)) {
+                            $fs->create_file_from_pathname($filerecord, $dir . $match);
+                            // Store we've processed so no need to import again (saves 1 query).
+                            $knownfiles[$contextid . $filearea . $itemid . $filerecord->filename] = 0;
+                        }
+                    }
+                    // Replace full path to just filename for rewrite plugin urls.
+                    $text = str_replace($match, '/' . $filerecord->filename, $text);
+                }
+            } catch (moodle_exception $e) {
+                // TODO clean up match if fail?
+                output('Failed to import file ' . $match . ' : ' . $e->getMessage());
+            }
+        }
+        $matches = null;
+    }
+    if (stripos($text, $SOURCESERVER . '/pix/smartpix.php/ou/s/')) {
+        // Search for hard-coded Emoticons and convert to local versions.
+        $pattern = '#<img.*?src="(' . $SOURCESERVER . '/pix/smartpix.php/ou/s/(.*?))"#';
+        preg_match_all($pattern, $text, $matches);
+        for ($a = 0, $len = count($matches[2]); $a < $len; $a++) {
+            // Add MyStuff images in a folder based on user name.
+            $match = $matches[2][$a];
+            $match = str_ireplace('.gif', '', $match);
+            $newurl = $OUTPUT->pix_url('/s/' . $match);
+            $text = str_replace($matches[1][$a], $newurl, $text);
+        }
+    }
+    return $text;
+}
+
+/**
+ * Switches any encode backup links to 'proper' form.
+ * Will search for user info and add as needed.
+ * @param string $content
+ * @param xpath $xpath
+ */
+function oublog_decode_perbloglinks($content, $xpath, $userposts = null, $olduserid = null) {
+    global $CFG, $SOURCESERVER;
+    $result = $content;
+    if (strpos($content, '$@OUBLOGVIEWUSER') !== false) {
+        // Process blog links.
+        $searchstring = '/\$@(OUBLOGVIEWUSER)\*([0-9]+)@\$/';
+        preg_match_all($searchstring, $result, $foundset);
+        if ($foundset[0]) {
+            // Iterate over foundset[2]. They are the old_ids.
+            foreach ($foundset[2] as $old_id) {
+                // We get the needed variables here (stored in users in xml)
+                $users = $xpath->query("/DATA/USERS/USER[@id=$old_id]");
+                $newid = false;
+                if ($users->length != 0) {
+                    $user = childnodes_to_object($users->item(0));
+                    if (!empty($user->username)) {
+                        $newid = urlencode($user->username);
+                    }
+                }
+                // Update the link to its new location.
+                if (!empty($newid)) {
+                    // Now replace it.
+                    $result = str_replace("$@OUBLOGVIEWUSER*$old_id@$", $CFG->wwwroot.'/mod/oublog/view.php?u=' . $newid, $result);
+                } else {
+                    // Can't find, leave it as original.
+                    $result = str_replace("$@OUBLOGVIEWUSER*$old_id@$", $SOURCESERVER . '/mod/oublog/view.php?user=' . $old_id, $result);
+                }
+            }
+        }
+    }
+    if (strpos($content, '$@OUBLOGVIEWPOST') !== false) {
+        // Porcess post links.
+        $searchstring = '/\$@(OUBLOGVIEWPOST)\*([0-9]+)@\$/';
+        preg_match_all($searchstring, $result, $foundset);
+        if ($foundset[0]) {
+            // Iterate over foundset[2]. They are the old_ids.
+            foreach ($foundset[2] as $old_id) {
+                $newusername = false;
+                $newposttime = false;
+                //See if this user made the post refered to, if so use their details.
+                if ($userposts && $olduserid) {
+                    foreach ($userposts as $post) {
+                        if (isset($post->id) && $post->id == $old_id && !empty($post->timeposted)) {
+                            $newposttime = $post->timeposted;
+                            // We get the needed variables here (stored in users in xml).
+                            $users = $xpath->query("/DATA/USERS/USER[@id={$olduserid}]");
+                            if ($users->length != 0) {
+                                $user = childnodes_to_object($users->item(0));
+                                if (!empty($user->username)) {
+                                    $newusername = urlencode($user->username);
+                                }
+                            }
+                            break;;
+                        }
+                    }
+                }
+                // Update the link to its new location.
+                if (!empty($newusername) && !empty($newposttime)) {
+                    // Now replace it.
+                    $posturl = new moodle_url('/mod/oublog/viewpost.php', array('u' => $newusername, 'time' => $newposttime, 'post' => 0));
+                    $result = str_replace("$@OUBLOGVIEWPOST*$old_id@$", $posturl->out(false), $result);
+                } else {
+                    // Can't find, leave it as original.
+                    $result = str_replace("$@OUBLOGVIEWPOST*$old_id@$", $SOURCESERVER . '/mod/oublog/viewpost.php?post=' . $old_id, $result);
+                }
+            }
+        }
+    }
+    return $result;
+}
+
+// Used by link usort.
+function oublog_sort_links($a, $b) {
+    if ($a->sortorder == $b->sortorder) {
+        return 0;
+    }
+    return ($a->sortorder < $b->sortorder) ? -1 : 1;
+}
+
+function childnodes_to_object(DOMElement $node) {
+    $node = clone $node;// Must clone or else original will have nodes removed.
+    // Add all child elements as properties.
+    $info = new stdClass();
+    // Fast looping of node list by always accessing first tag (faster than foreach).
+    $el = $node->childNodes->item(0);
+    while ($el != null) {
+        $elname = strtolower($el->nodeName);
+        if ($el->hasChildNodes() && !($el->childNodes->length == 1 && $el->childNodes->item(0)->nodeType == XML_TEXT_NODE)) {
+            $info->{$elname} = childnodes_to_object($el);
+        } else if ($el->nodeType != XML_TEXT_NODE) {
+            if ($el->nodeValue == '$@NULL@$') {
+                $info->{$elname} = null;
+            } else {
+                $info->{$elname} = $el->nodeValue;
+            }
+        }
+        $el->parentNode->removeChild($el);
+        $el = $node->childNodes->item(0);
+    }
+    return $info;
+}
+
+function formatbytes($bytes, $precision = 2) {
+    $units = array('B', 'KB', 'MB', 'GB', 'TB');
+
+    $bytes = max($bytes, 0);
+    $pow = floor(($bytes ? log($bytes) : 0) / log(1024));
+    $pow = min($pow, count($units) - 1);
+
+    $bytes /= pow(1024, $pow);
+
+    return round($bytes, $precision) . ' ' . $units[$pow];
+}
+
+// Returns the appropriate file number per every 1000 - numbers are rounded down.
+function get_filenumber($number) {
+    return round($number, -3, PHP_ROUND_HALF_DOWN);
+}
+
+/**
+ * Test if value from xml is empty/null
+ * @param string $value
+ */
+function blogxml_isempty($value) {
+    if (empty($value) || $value == '$@NULL@$' || is_null($value)) {
+        return true;
+    }
+    return false;
+}
+
+function output($string, $nolbr = false) {
+    $linebreak = $nolbr ? '' : '<br />';
+    print ("$linebreak$string .");
+    flush();
+}
diff --git a/mod/oublog/mod_form.php b/mod/oublog/mod_form.php
new file mode 100644
index 0000000..95d81c2
--- /dev/null
+++ b/mod/oublog/mod_form.php
@@ -0,0 +1,334 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+/**
+ * Define the OU Blog module creation form
+ *
+ * @access Matt Clarkson <mattc@catalyst.net.nz>
+ * @package oublog
+ */
+if (defined('OUBLOG_EDIT_INSTANCE')) {
+
+    require_once($CFG->libdir.'/formslib.php');
+    abstract class moodleform_mod extends moodleform {
+    } // Fake that we are using the moodleform_mod base class.
+
+} else {
+    require_once('moodleform_mod.php');
+}
+require_once('locallib.php');
+
+class mod_oublog_mod_form extends moodleform_mod {
+
+    public function definition() {
+
+        global $COURSE, $CFG;
+        $mform    = $this->_form;
+
+        $mform->addElement('header', 'general', get_string('general', 'form'));
+
+        // Adding the standard "name" field.
+        $mform->addElement('text', 'name', get_string('blogname', 'oublog'), array('size'=>'64'));
+        $mform->setType('name', PARAM_TEXT);
+        $mform->addRule('name', null, 'required', null, 'client');
+        $mform->addRule('name', get_string('maximumchars', '', 255), 'maxlength', 255, 'client');
+
+        if (!defined('OUBLOG_EDIT_INSTANCE')) {
+            $this->standard_intro_elements(get_string('oublogintro', 'oublog'));
+            // Adding the "allowcomments" field.
+            $options = array(OUBLOG_COMMENTS_ALLOW => get_string('logincomments', 'oublog'),
+                    OUBLOG_COMMENTS_ALLOWPUBLIC => get_string('publiccomments', 'oublog'),
+                    OUBLOG_COMMENTS_PREVENT => get_string('nocomments', 'oublog'));
+
+            $mform->addElement('select', 'allowcomments', get_string('allowcommentsmax', 'oublog'), $options);
+            $mform->setType('allowcomments', PARAM_INT);
+            $mform->addHelpButton('allowcomments', 'allowcomments', 'oublog');
+
+            // Adding the "individual" field.
+            $options = array(OUBLOG_NO_INDIVIDUAL_BLOGS => get_string('no_blogtogetheroringroups', 'oublog'),
+                    OUBLOG_SEPARATE_INDIVIDUAL_BLOGS => get_string('separateindividualblogs', 'oublog'),
+                    OUBLOG_VISIBLE_INDIVIDUAL_BLOGS => get_string('visibleindividualblogs', 'oublog'));
+            $mform->addElement('select', 'individual', get_string('individualblogs', 'oublog'), $options);
+            $mform->setType('individual', PARAM_INT);
+            $mform->setDefault('individual', OUBLOG_NO_INDIVIDUAL_BLOGS);
+            $mform->addHelpButton('individual', 'individualblogs', 'oublog');
+
+            // Disable "maxvisibility" field when "individual" field is set (not default).
+            $mform->disabledIf('maxvisibility', 'individual', OUBLOG_NO_INDIVIDUAL_BLOGS, OUBLOG_NO_INDIVIDUAL_BLOGS);
+
+            // Adding the "maxvisibility" field.
+            $options = array(OUBLOG_VISIBILITY_COURSEUSER => get_string('visiblecourseusers', 'oublog'),
+                    OUBLOG_VISIBILITY_LOGGEDINUSER => get_string('visibleloggedinusers', 'oublog'),
+                    OUBLOG_VISIBILITY_PUBLIC => get_string('visiblepublic', 'oublog'));
+
+            $mform->addElement('select', 'maxvisibility', get_string('maxvisibility', 'oublog'), $options);
+            $mform->setType('maxvisibility', PARAM_INT);
+            $mform->addHelpButton('maxvisibility', 'maxvisibility', 'oublog');
+
+            // Whether intro text shows on post form pages.
+            $mform->addElement('checkbox', 'introonpost', get_string('introonpost', 'oublog'), '', 0);
+
+            // Max size of attachments.
+            $modulesettings = get_config('mod_oublog');
+            $choices = get_max_upload_sizes($CFG->maxbytes, $COURSE->maxbytes);
+            $mform->addElement('select', 'maxbytes',
+                    get_string('maxattachmentsize', 'oublog'), $choices);
+            $mform->addHelpButton('maxbytes', 'maxattachmentsize', 'oublog');
+            $mform->setDefault('maxbytes', $modulesettings->maxbytes);
+
+            // Max number of attachments.
+            $choices = array(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 20 => 20, 50 => 50, 100 => 100);
+            $mform->addElement('select', 'maxattachments',
+                    get_string('maxattachments', 'oublog'), $choices);
+            $mform->addHelpButton('maxattachments', 'maxattachments', 'oublog');
+            $mform->setDefault('maxattachments', $modulesettings->maxattachments);
+
+            // Show OU Alerts reporting link.
+            if (oublog_oualerts_enabled()) {
+                $mform->addElement('text', 'reportingemail', get_string('reportingemail', 'oublog'),
+                        array('size'=>'48'));
+                $mform->addHelpButton('reportingemail', 'reportingemail', 'oublog');
+                $mform->setType('reportingemail', PARAM_NOTAGS);
+                $mform->addRule('reportingemail', get_string('maximumchars', '', 255),
+                        'maxlength', 255, 'client');
+            }
+
+            $mform->addElement('header', 'advanced', get_string('advancedoptions', 'oublog'));
+
+            // Enable the stats block.
+            $mform->addElement('checkbox', 'statblockon', get_string('statblockon', 'oublog'), '', 0);
+            $mform->addHelpButton('statblockon', 'statblockon', 'oublog');
+
+            $mform->addElement('text', 'displayname', get_string('displayname', 'oublog'),
+                    array('size'=>'48'));
+            $mform->addHelpButton('displayname', 'displayname', 'oublog');
+            $mform->setType('displayname', PARAM_NOTAGS);
+            $mform->addRule('displayname', get_string('maximumchars', '', 255),
+                    'maxlength', 255, 'client');
+
+            $mform->addElement('checkbox', 'allowimport', get_string('allowimport', 'oublog'), '', 0);
+            $mform->addHelpButton('allowimport', 'allowimport', 'oublog');
+
+            $mform->addElement('header', 'tagheading', get_string('tags', 'oublog'));
+
+            $mform->addElement('text', 'tagslist', get_string('tags', 'oublog'),
+                            array('size'=>'48'));
+            $mform->addHelpButton('tagslist', 'predefinedtags', 'oublog');
+            $mform->setType('tagslist', PARAM_TAGLIST);
+            $mform->addRule('tagslist', get_string('maximumchars', '', 255),
+                            'maxlength', 255, 'client');
+
+            $tagopts = array(
+                    '0' => get_string('none'),
+                    '1' => get_string('restricttags_set', 'oublog'),
+                    '2' => get_string('restricttags_req', 'oublog'),
+                    '3' => get_string('restricttags_req_set', 'oublog'),
+            );
+            $mform->addElement('select', 'restricttags', get_string('restricttags', 'oublog'), $tagopts);
+            $mform->addHelpButton('restricttags', 'restricttags', 'oublog');
+
+            $mform->addElement('header', 'limits', get_string('limits', 'oublog'));
+
+            // Limiting post/comments dates.
+            $mform->addElement('date_time_selector', 'postfrom',
+                    get_string('postfrom', 'oublog'), array('optional' => true));
+            $mform->addElement('date_time_selector', 'postuntil',
+                    get_string('postuntil', 'oublog'), array('optional' => true));
+            $mform->addElement('date_time_selector', 'commentfrom',
+                    get_string('commentfrom', 'oublog'), array('optional' => true));
+            $mform->addElement('date_time_selector', 'commentuntil',
+                    get_string('commentuntil', 'oublog'), array('optional' => true));
+
+            $mform->disabledIf('commentfrom', 'allowcomments', 'eq', 0);
+            $mform->disabledIf('commentuntil', 'allowcomments', 'eq', 0);
+
+            $mform->addElement('header', 'modstandardgrade', get_string('grade'));
+            // Adding the "grading" field.
+            $options = array(OUBLOG_NO_GRADING => get_string('nograde', 'oublog'),
+                    OUBLOG_TEACHER_GRADING => get_string('teachergrading', 'oublog'),
+                    OUBLOG_USE_RATING => get_string('userrating', 'oublog'));
+            $mform->addElement('select', 'grading', get_string('grading', 'oublog'), $options);
+            $mform->setType('grading', PARAM_INT);
+            $mform->addHelpButton('grading', 'grading', 'oublog');
+
+            $mform->addElement('modgrade', 'grade', get_string('grade'));
+            $mform->addHelpButton('grade', 'modgrade', 'grades');
+            $mform->setDefault('grade', $CFG->gradepointdefault);
+            $mform->disabledIf('grade', 'grading', 'ne', OUBLOG_TEACHER_GRADING);
+
+            // Add standard elements, common to all modules.
+            $features = new stdClass;
+            $features->groupings = true;
+            $this->standard_coursemodule_elements($features);
+        } else {
+            // Adding the "summary" field.
+            $mform->addElement('editor', 'summary_editor', get_string('summary', 'oublog'), null,
+                    array('maxfiles' => EDITOR_UNLIMITED_FILES, 'maxbytes' => $CFG->maxbytes));
+            $mform->setType('summary', PARAM_RAW);
+            $mform->addElement('hidden', 'instance');
+            $mform->setType('instance', PARAM_INT);
+        }
+
+        // Add standard buttons, common to all modules.
+        $this->add_action_buttons();
+
+    }
+
+    public function add_completion_rules() {
+        $mform =& $this->_form;
+
+        $group=array();
+        $group[] =& $mform->createElement('checkbox', 'completionpostsenabled', ' ', get_string('completionposts', 'oublog'));
+        $group[] =& $mform->createElement('text', 'completionposts', ' ', array('size'=>3));
+        $mform->setType('completionposts', PARAM_INT);
+        $mform->addGroup($group, 'completionpostsgroup', get_string('completionpostsgroup', 'oublog'), array(' '), false);
+        $mform->addHelpButton('completionpostsgroup', 'completionpostsgroup', 'oublog');
+        $mform->disabledIf('completionposts', 'completionpostsenabled', 'notchecked');
+
+        $group=array();
+        $group[] =& $mform->createElement('checkbox', 'completioncommentsenabled', ' ', get_string('completioncomments', 'oublog'));
+        $group[] =& $mform->createElement('text', 'completioncomments', ' ', array('size'=>3));
+        $mform->setType('completioncomments', PARAM_INT);
+        $mform->addGroup($group, 'completioncommentsgroup', get_string('completioncommentsgroup', 'oublog'), array(' '), false);
+        $mform->addHelpButton('completioncommentsgroup', 'completioncommentsgroup', 'oublog');
+        $mform->disabledIf('completioncomments', 'completioncommentsenabled', 'notchecked');
+
+        // Restriction for grade completion
+        $mform->disabledIf('completionusegrade', 'grade', 'eq', 0);
+
+        return array('completionpostsgroup', 'completioncommentsgroup');
+    }
+
+    public function completion_rule_enabled($data) {
+        return ((!empty($data['completionpostsenabled']) && $data['completionposts']!=0)) ||
+            ((!empty($data['completioncommentsenabled']) && $data['completioncomments']!=0));
+    }
+
+    public function get_data() {
+        $data=parent::get_data();
+        if (!$data) {
+            return false;
+        }
+        // Turn off completion settings if the checkboxes aren't ticked
+        $autocompletion=!empty($data->completion) && $data->completion==COMPLETION_TRACKING_AUTOMATIC;
+        if (empty($data->completionpostsenabled) || !$autocompletion) {
+            $data->completionposts=0;
+        }
+        if (empty($data->completioncommentsenabled) || !$autocompletion) {
+            $data->completioncomments=0;
+        }
+        // If maxvisibility is disabled by individual mode, ensure it's limited to course.
+        if (isset($data->individual) && ($data->individual == OUBLOG_SEPARATE_INDIVIDUAL_BLOGS
+                || $data->individual == OUBLOG_VISIBLE_INDIVIDUAL_BLOGS)) {
+            $data->maxvisibility = OUBLOG_VISIBILITY_COURSEUSER;
+        }
+        // Set the reportingemail to null if empty so that we have consistency.
+        if (empty($data->reportingemail)) {
+            $data->reportingemail = null;
+        }
+        // Set statblockon to null if empty so that we have consistency.
+        if (empty($data->statblockon)) {
+            $data->statblockon = 0;
+        }
+        if (empty($data->displayname)) {
+            $data->displayname = null;
+        }
+        if (empty($data->allowimport)) {
+            $data->allowimport = 0;
+        }
+        if (empty($data->introonpost)) {
+            $data->introonpost = 0;
+        }
+        if (!empty($data->tagslist)) {
+            $data->tagslist = core_text::strtolower(trim($data->tagslist));
+        }
+        if (empty($data->restricttags)) {
+            $data->restricttags = 0;
+        }
+        if (empty($data->postfrom)) {
+            $data->postfrom = 0;
+        }
+        if (empty($data->postuntil)) {
+            $data->postuntil = 0;
+        }
+        if (empty($data->commentfrom)) {
+            $data->commentfrom = 0;
+        }
+        if (empty($data->commentuntil)) {
+            $data->commentuntil = 0;
+        }
+        if (isset($data->grading) && $data->grading == OUBLOG_NO_GRADING) {
+            // Unset grade if grading turned off.
+            $data->grade = 0;
+        }
+        return $data;
+    }
+
+    public function data_preprocessing(&$default_values) {
+        // Set up the completion checkboxes which aren't part of standard data.
+        // We also make the default value (if you turn on the checkbox) for those
+        // numbers to be 1, this will not apply unless checkbox is ticked.
+        $default_values['completionpostsenabled']=
+            !empty($default_values['completionposts']) ? 1 : 0;
+        if (empty($default_values['completionposts'])) {
+            $default_values['completionposts']=1;
+        }
+        $default_values['completioncommentsenabled']=
+            !empty($default_values['completioncomments']) ? 1 : 0;
+        if (empty($default_values['completioncomments'])) {
+            $default_values['completioncomments']=1;
+        }
+    }
+
+    public function validation($data, $files) {
+        global $DB;
+        $errors = parent::validation($data, $files);
+        if (!empty($data['groupmode']) && isset($data['allowcomments']) &&
+                $data['allowcomments'] == OUBLOG_COMMENTS_ALLOWPUBLIC) {
+            $errors['allowcomments'] = get_string('error_grouppubliccomments', 'oublog');
+        }
+        if (!empty($data['reportingemail'])) {
+            $emails = explode(',', trim($data['reportingemail']));
+            foreach ($emails as $email) {
+                if (!validate_email($email)) {
+                    $errors['reportingemail'] = get_string('invalidemail', 'forumng');
+                }
+            }
+        }
+        if (!empty($data['allowimport']) && $data['individual'] == OUBLOG_NO_INDIVIDUAL_BLOGS) {
+            // Can only import on individual or global blogs.
+            if (!empty($data['instance'])) {
+                if (!$DB->get_field('oublog', 'global', array('id' => $data['instance']))) {
+                    $errors['allowimport'] = get_string('allowimport_invalid', 'oublog');
+                }
+            } else {
+                $errors['allowimport'] = get_string('allowimport_invalid', 'oublog');
+            }
+        }
+        // If form is on blog edit page rather than the blog options edit instance page.
+        if (isset($data['grading'])) {
+           if (($data['grading'] == OUBLOG_TEACHER_GRADING && empty($data['grade'])) ||
+                    ($data['grading'] == OUBLOG_USE_RATING && empty($data['assessed']))) {
+                $errors['grading'] = get_string('grading_invalid', 'oublog');
+            }
+        }
+        if (isset($data['restricttags']) && empty($data['tagslist'])
+                && ($data['restricttags'] == 1 || $data['restricttags'] == 3)) {
+            // When forcing use of pre-defined tags must define some.
+            $errors['tagslist'] = get_string('required');
+        }
+        return $errors;
+    }
+}
diff --git a/mod/oublog/module.js b/mod/oublog/module.js
new file mode 100644
index 0000000..abd6d9e
--- /dev/null
+++ b/mod/oublog/module.js
@@ -0,0 +1,223 @@
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Javascript helper function for OUBlog.
+ *
+ * @package    mod
+ * @subpackage oublog
+ * @copyright  2013 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+M.mod_oublog = M.mod_oublog || {};
+
+M.mod_oublog.init = function(Y) {
+    M.mod_oublog.hidewarning(Y);
+    var comments = Y.one('#id_allowcomments');
+    if (comments) {
+        comments.on('change', function(e){M.mod_oublog.hidewarning(Y);});
+    }
+};
+
+M.mod_oublog.hidewarning = function(Y) {
+    var field = Y.one('#publicwarningmarker');
+    if (field) {
+        field = field.get('parentNode').get('parentNode');
+        var select = Y.one('#id_allowcomments');
+        field.setStyle('display', select.get('value') == 2 ? 'block' : 'none');
+    }
+};
+
+/*Discovery 'block'*/
+
+M.mod_oublog.init_showhide = function(Y, name, curpref) {
+    var block = Y.one('.oublog_statsview_content_' + name);
+    if (block) {
+        var showhide = block.one('.block_action_oublog');
+        var form = block.one('form.mform');
+        if (showhide && form) {
+            var hideinfo = block.one('.oublog_stats_minus');
+            var showinfo = block.one('.oublog_stats_plus');
+            if (curpref == 1) {
+                form.addClass('oublog_displaynone');
+                hideinfo.addClass('oublog_displaynone');
+                showinfo.removeClass('oublog_displaynone');
+            }
+            showhide.on(['click', 'keypress'], function(e) {
+                if (!e.keyCode || (e.keyCode && e.keyCode == 13)) {
+                    e.preventDefault();
+                    if (curpref == 1) {
+                        hideinfo.removeClass('oublog_displaynone');
+                        showinfo.addClass('oublog_displaynone');
+                        form.removeClass('oublog_displaynone');
+                        if (!Y.one('body').hasClass('notloggedin')) {
+                            M.util.set_user_preference('mod_oublog_hidestatsform_' + name, 0);
+                        }
+                        curpref = 0;
+                    } else {
+                        hideinfo.addClass('oublog_displaynone');
+                        showinfo.removeClass('oublog_displaynone');
+                        form.addClass('oublog_displaynone');
+                        if (!Y.one('body').hasClass('notloggedin')) {
+                            M.util.set_user_preference('mod_oublog_hidestatsform_' + name, 1);
+                        }
+                        curpref = 1;
+                    }
+                }
+            });
+        }
+    }
+};
+
+M.mod_oublog.init_deleteandemail = function(Y, cmid, postid) {
+    this.Y = Y;
+    this.YAHOO = Y.YUI2;
+    // Trap for individual 'Delete' links.
+    var delbtns = Y.one('a.oublog_deleteandemail_' + postid);
+    delbtns.on('click', function(e) {
+        var uri =  e.target.get('href');
+        // Show the dialogue.
+        delbtns.set('disabled', false);
+        var content = M.util.get_string('deleteemailpostdescription', 'oublog');
+        var panel = new M.core.dialogue({
+            bodyContent: content,
+            width: 400,
+            centered: true,
+            render: true,
+            zIndex: 50,
+            buttons: {},
+            plugins: [Y.Plugin.Drag],
+            modal: true});
+                // Add the two Delete and Cancel buttons to the bottom of the dialog.
+                panel.addButton({
+                    label: M.util.get_string('delete', 'oublog'),
+                    section: Y.WidgetStdMod.FOOTER,
+                    action : function (e) {
+                        e.preventDefault();
+                        // Add on the 'confirm' delete marker to the link uri.
+                        uri += '&confirm=1';
+                        document.location.href = uri;
+                        panel.hide();
+                        panel.destroy();
+                    }
+                });
+                panel.addButton({
+                    label: M.util.get_string('deleteandemail', 'oublog'),
+                    section: Y.WidgetStdMod.FOOTER,
+                    action : function (e) {
+                        e.preventDefault();
+                        // Add on the 'email' marker to the link uri.
+                        uri += '&email=1';
+                        document.location.href = uri;
+                        panel.hide();
+                        panel.destroy();
+                    }
+                });
+                panel.addButton({
+                    value  : 'Cancel',
+                    section: Y.WidgetStdMod.FOOTER,
+                    action : function (e) {
+                        e.preventDefault();
+                        panel.hide();
+                        panel.destroy();
+                        Y.one('a.oublog_deleteandemail_' + postid).focus();
+                    }
+                });
+        e.preventDefault();
+        Y.one('a.oublog_deleteandemail_' + postid).focus();
+        panel.show();
+    });
+
+};
+
+/* Import table */
+M.mod_oublog.init_posttable = function(Y) {
+    var includehead = Y.one('.flexible .header.c3');
+    var postchecks = Y.all('.flexible td.c3 input[type=checkbox]');
+    if (includehead && postchecks) {
+        // Add select all/none links to column header.
+        includehead.append('<a href="#" class="oublog_import_all">' + M.util.get_string('import_step1_all', 'oublog') +
+                '</a> / <a href="#" class="oublog_import_none">' + M.util.get_string('import_step1_none', 'oublog') + '</a>');
+        var all = Y.one('.flexible .c3 .oublog_import_all');
+        if (all) {
+            all.on('click', function(e) {
+                postchecks.set('checked', true);
+                postchecks.each(function(check){updatepreselect(check);});
+                e.preventDefault();
+                return false;
+                });
+        }
+        var none = Y.one('.flexible .c3 .oublog_import_none');
+        if (none) {
+            none.on('click', function(e) {
+                postchecks.set('checked', false);
+                postchecks.each(function(check){updatepreselect(check);});
+                e.preventDefault();
+                return false;});
+        }
+    }
+
+    var updatepreselect = function(check) {
+        var preselect = preselectinput.get('value');
+        var id = check.get('name').substr(5);
+        if (check.get('checked')) {
+         // Add id to preselect value.
+            if (id) {
+                var prearray = preselect.split(',');
+                for (var i = 0, len = prearray.length; i < len; i++) {
+                    if (prearray[i] == id) {
+                        // Already have, return.
+                        return;
+                    }
+                }
+                prearray.push(id);
+                preselectinput.set('value', prearray.join());
+                updatelinks(prearray);
+            }
+        } else {
+         // De-selecting, remove from preselect.
+            if (preselect && id) {
+                var prearray = preselect.split(',');
+                for (var i = 0, len = prearray.length; i < len; i++) {
+                    if (prearray[i] == id) {
+                        prearray.splice(i, 1);
+                        preselectinput.set('value', prearray.join());
+                        updatelinks(prearray);
+                        return;
+                    }
+                }
+            }
+        }
+    };
+
+    var updatelinks = function(prearray) {
+        // Update link query strings.
+        Y.all('.oublog_import_step1 form .paging a, .flexible a').each(function(link) {
+            var linkurl = link.get('href');
+            var params = Y.QueryString.parse(linkurl.substr(linkurl.indexOf('&')));
+            params.preselected = prearray.join();
+            var newurl = Y.QueryString.stringify(params);
+            link.set('href', linkurl.substr(0, linkurl.indexOf('&')) + '&' + newurl);
+        });
+    };
+
+    var preselectinput = Y.one('form input[name=preselected]');
+    if (postchecks && preselectinput) {
+        postchecks.on('click', function(check) {
+            updatepreselect(check.target);
+        });
+    }
+};
diff --git a/mod/oublog/movelink.php b/mod/oublog/movelink.php
new file mode 100644
index 0000000..7c5b8c1
--- /dev/null
+++ b/mod/oublog/movelink.php
@@ -0,0 +1,85 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+/**
+ * This page allows a user to change a links position in the list
+ *
+ * @author Matt Clarkson <mattc@catalyst.net.nz>
+ * @package oublog
+ */
+
+require_once("../../config.php");
+require_once("locallib.php");
+
+$link = required_param('link', PARAM_INT);
+$down = required_param('down', PARAM_INT);
+$returnurl = required_param('returnurl', PARAM_RAW);
+
+if (!$link = $DB->get_record('oublog_links', array('id'=>$link))) {
+    print_error('invalidlink', 'oublog');
+}
+if (!$oublog = $DB->get_record("oublog", array("id"=>$link->oublogid))) {
+    print_error('invalidblog', 'oublog');
+}
+if (!$cm = get_coursemodule_from_instance('oublog', $link->oublogid)) {
+    print_error('invalidcoursemodule');
+}
+
+require_sesskey();
+
+$context = context_module::instance($cm->id);
+
+$oubloginstance = $link->oubloginstancesid ? $DB->get_record('oublog_instances', array('id'=>$link->oubloginstancesid)) : null;
+oublog_require_userblog_permission('mod/oublog:managelinks', $oublog, $oubloginstance, $context);
+
+$params = array();
+if ($oublog->global) {
+    $where = "oubloginstancesid = ? ";
+    $params[] = $link->oubloginstancesid;
+} else {
+    $where = "oublogid = ? ";
+    $params[] = $link->oublogid;
+}
+
+// Get the max sort order
+$maxsortorder = $DB->get_field_sql("SELECT MAX(sortorder) FROM {oublog_links} WHERE $where", $params);
+
+if ($down == 1) { // Move link down
+    if ($link->sortorder != $maxsortorder) {
+        $sql = "UPDATE {oublog_links} SET sortorder = ?
+                WHERE $where AND sortorder = ?";
+
+        $DB->execute($sql, array_merge(array($link->sortorder), $params, array($link->sortorder+1)));
+
+        $sql = "UPDATE {oublog_links} SET sortorder = ?
+                WHERE id = ? ";
+
+        $DB->execute($sql, array($link->sortorder+1, $link->id));
+    }
+} else { // Move link up
+    if ($link->sortorder != 1) {
+        $sql = "UPDATE {oublog_links} SET sortorder = ?
+                WHERE $where AND sortorder = ?";
+
+        $DB->execute($sql, array_merge(array($link->sortorder), $params, array($link->sortorder-1)));
+
+        $sql = "UPDATE {oublog_links} SET sortorder = ?
+                WHERE id = ? ";
+
+        $DB->execute($sql, array($link->sortorder-1, $link->id));
+    }
+}
+
+redirect($returnurl);
diff --git a/mod/oublog/participation.php b/mod/oublog/participation.php
new file mode 100644
index 0000000..4ebd175
--- /dev/null
+++ b/mod/oublog/participation.php
@@ -0,0 +1,185 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Page for viewing all user participation
+ *
+ * @package mod
+ * @subpackage oublog
+ * @copyright 2011 The Open University
+ * @author Stacey Walker <stacey@catalyst-eu.net>
+ * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+require_once(dirname(__FILE__) . '/../../config.php');
+require_once($CFG->dirroot.'/mod/oublog/locallib.php');
+
+$id         = required_param('id', PARAM_INT); // Course Module ID
+$groupid    = optional_param('group', 0, PARAM_INT);
+$download   = optional_param('download', '', PARAM_TEXT);
+$page       = optional_param('page', 0, PARAM_INT); // flexible_table page
+
+$params = array(
+    'id'        => $id,
+    'group'     => $groupid,
+    'download'  => $download,
+    'page'      => $page,
+);
+$url = new moodle_url('/mod/oublog/participation.php', $params);
+$PAGE->set_url($url);
+
+$cm = get_coursemodule_from_id('oublog', $id, 0, false, MUST_EXIST);
+$course = $DB->get_record('course', array('id' => $cm->course), '*', MUST_EXIST);
+$oublog = $DB->get_record('oublog', array('id' => $cm->instance), '*', MUST_EXIST);
+
+$PAGE->set_cm($cm);
+$context = context_module::instance($cm->id);
+$PAGE->set_pagelayout('incourse');
+require_course_login($course, true, $cm);
+
+// participation capability check
+$canview = oublog_can_view_participation($course, $oublog, $cm, $groupid);
+if ($canview != OUBLOG_USER_PARTICIPATION) {
+    print_error('nopermissiontoshow');
+}
+$viewfullnames = has_capability('moodle/site:viewfullnames', $context);
+
+$groupname = '';
+if ($groupid) {
+    $groupname = $DB->get_field('groups', 'name', array('id' => $groupid));
+}
+
+// set up whether the group selector should display
+$showgroupselector = true;
+if ($oublog->individual) {
+    // if separate individual and visible group, do not show groupselector
+    // unless the current user has permission
+    if ($oublog->individual == OUBLOG_SEPARATE_INDIVIDUAL_BLOGS
+        && !has_capability('mod/oublog:viewindividual', $context)) {
+        $showgroupselector = false;
+    }
+}
+
+// All enrolled users for table pagination.
+$coursecontext = context_course::instance($course->id);
+// If data has been received from this form.
+$curgroup = -1;
+if ($cm->groupmode > NOGROUPS) {
+    // Get currently viewed group.
+    $curgroup = optional_param('curgroup', oublog_get_activity_group($cm), PARAM_INT);
+}
+// Create time filter options form.
+$default = get_user_preferences('mod_oublog_postformfilter', OUBLOG_STATS_TIMEFILTER_ALL);
+    // Create time filter options form.
+    $customdata = array(
+            'type' => 'participation',
+            'cmid' => $cm->id,
+            'user' => $USER->id,
+            'group' => $groupid,
+            'download' => $download,
+            'page' => $page,
+            'startyear' => $course->startdate,
+            'params' => array('curgroup', $curgroup)
+    );
+$timefilter = new oublog_participation_timefilter_form(null, $customdata);
+
+// If data has been received from this form.
+$start = $end = 0;
+$info = 'The info needs to be provided';
+if ($submitted = $timefilter->get_data()) {
+    if ($submitted->start) {
+        $start = strtotime('00:00:00', $submitted->start);
+    }
+    if ($submitted->end) {
+        $end = strtotime('23:59:59', $submitted->end);
+    }
+}
+
+$participation = oublog_get_participation($oublog, $context, $groupid, $cm, $course, $start, $end);
+$PAGE->navbar->add(get_string('userparticipation', 'oublog'));
+$PAGE->set_title(format_string($oublog->name));
+$PAGE->set_heading(format_string($oublog->name));
+
+// Log visit list event.
+$params = array(
+    'context' => $context,
+    'objectid' => $oublog->id,
+    'other' => array(
+        'info' => 'user participation',
+        'logurl' => 'participation.php?id=' . $cm->id
+    )
+);
+$event = \mod_oublog\event\participation_viewed::create($params);
+$event->add_record_snapshot('course', $course);
+$event->trigger();
+
+$oublogoutput = $PAGE->get_renderer('mod_oublog');
+
+if (empty($download)) {
+    echo $OUTPUT->header();
+
+    // Gets a message after grades updated.
+    if (isset($SESSION->oubloggradesupdated)) {
+        $message = $SESSION->oubloggradesupdated;
+        unset($SESSION->oubloggradesupdated);
+        echo $OUTPUT->notification($message, 'notifysuccess');
+    }
+
+    // Print Groups drop-down menu.
+    echo '<div class="oublog-groups-individual-selectors">';
+    $returnurl = $CFG->wwwroot . '/mod/oublog/participation.php?id=' . $cm->id;
+    if ($showgroupselector) {
+        groups_print_activity_menu($cm, $returnurl);
+    }
+    echo '</div>';
+}
+
+if (!$start && !$end) {
+    $title = get_string('participation_all', 'oublog');
+    $info = get_string('participation_all', 'oublog');
+}
+$startdate = userdate($start);
+$enddate = userdate($end);
+if ($start && !$end) {
+    $title = get_string('participation', 'oublog');
+    $info = get_string('participation_from', 'oublog', $startdate);
+}
+if (!$start && $end) {
+    $title = get_string('participation', 'oublog');
+    $info = get_string('participation_to', 'oublog', $enddate);
+}
+if ($start && $end) {
+    $a = new stdClass();
+    $a->start = $startdate;
+    $a->end = $enddate;
+    $title = get_string('participation', 'oublog');
+    $info = get_string('participation_fromto', 'oublog', $a);
+}
+if (empty($download)) {
+    echo html_writer::tag('h2', $info,
+            array('class' => 'oublog-post-title'));
+    $timefilter->display();
+}
+
+$oublogoutput->render_participation_list($cm, $course, $oublog, $groupid,
+    $download, $page, $participation, $coursecontext, $viewfullnames,
+    $groupname);
+
+echo $oublogoutput->get_link_back_to_oublog($cm->name, $cm->id);
+
+if (empty($download)) {
+    echo $OUTPUT->footer();
+}
diff --git a/mod/oublog/participation_table.php b/mod/oublog/participation_table.php
new file mode 100644
index 0000000..e62ce86
--- /dev/null
+++ b/mod/oublog/participation_table.php
@@ -0,0 +1,306 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Subclass of flexible_table for participation and download
+ *
+ * @package    mod
+ * @subpackage oublog
+ * @copyright 2011 The Open University
+ * @author Stacey Walker <stacey@catalyst-eu.net>
+ * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ **/
+
+require_once($CFG->libdir.'/tablelib.php');
+
+
+/**
+ * Class oublog_participation_table
+ * extends flexible_table to override header and download rules
+ */
+class oublog_participation_table extends flexible_table {
+
+    public $cm;
+    public $course;
+    public $oublog;
+    public $groupid;
+    public $groupname;
+    public $extraheaders;
+    private $hasgrades;
+
+    public function __construct($cm, $course, $oublog, $groupid = 0,
+        $groupname, $hasgrades) {
+
+        $this->cm = $cm;
+        $this->course = $course;
+        $this->oublog = $oublog;
+        $this->groupid = $groupid;
+        $this->groupname = $groupname;
+        $this->hasgrades = $hasgrades;
+        parent::__construct('mod-oublog-participation');
+    }
+
+    /**
+     * Setup the columns and headers and other properties of the table and then
+     * call flexible_table::setup() method.
+     */
+    public function setup($download = '') {
+        global $CFG;
+
+        // extra headers for export only
+        if (!empty($download)) {
+            $this->extraheaders = array(
+                format_string($this->course->shortname, true),
+                format_string($this->oublog->name, true),
+            );
+            if (!empty($this->groupname)) {
+                $this->extraheaders[] = $this->groupname;
+            }
+        }
+
+        // Define table columns
+        $columns = array(
+            'picture',
+            'fullname',
+            'posts',
+            'comments'
+        );
+        $headers = array(
+            '',
+            get_string('user'),
+            get_string('posts', 'oublog'),
+            get_string('comments', 'oublog'),
+        );
+
+        // unset picture column + headers if download
+        if (!empty($download)) {
+            unset($columns[0]);
+            unset($headers[0]);
+        }
+
+        if ($this->hasgrades) {
+            $columns[] = 'grade';
+            $headers[] = get_string('grades');
+        }
+
+        $this->define_columns($columns);
+        $this->define_headers($headers);
+        $this->define_baseurl($CFG->wwwroot . '/mod/oublog/participation.php?id=' .
+            $this->cm->id . '&amp;group=' . $this->groupid);
+
+        $this->column_class('fullname', 'fullname');
+        $this->column_class('posts', 'posts');
+        $this->column_class('comments', 'comments');
+
+        $this->set_attribute('cellspacing', '0');
+        $this->set_attribute('id', 'participation');
+        $this->set_attribute('class', 'generaltable');
+        $this->set_attribute('width', '100%');
+        $this->set_attribute('align', 'center');
+        $this->sortable(false);
+
+        parent::setup();
+    }
+
+    /**
+     * This function is not part of the public api.
+     *
+     * Overriding here to avoid downloading in unsupported formats
+     */
+    public function get_download_menu() {
+        $exportclasses = array('csv' => get_string('downloadcsv', 'oublog'));
+        return $exportclasses;
+    }
+
+    /**
+     * This function is not part of the public api.
+     * You don't normally need to call this. It is called automatically when
+     * needed when you start adding data to the table.
+     *
+     */
+    public function start_output() {
+        $this->started_output = true;
+        if ($this->exportclass !== null) {
+            $this->exportclass->start_table($this->sheettitle);
+            $this->exportclass->output_headers($this->extraheaders);
+            $this->exportclass->output_headers($this->headers);
+        } else {
+            $this->start_html();
+            $this->print_headers();
+        }
+    }
+
+    /**
+     * Override to output grade form header
+     * @see flexible_table::wrap_html_start()
+     */
+    public function wrap_html_start() {
+        if ($this->hasgrades && !$this->is_downloading()) {
+            echo $this->grade_form_header();
+        }
+    }
+
+    public function grade_form_header() {
+        global $USER;
+        $output = '';
+        $formattrs = array();
+        $formattrs['action'] = new moodle_url('/mod/oublog/savegrades.php');
+        $formattrs['id']     = 'savegrades';
+        $formattrs['method'] = 'post';
+        $output = html_writer::start_tag('form', $formattrs);
+        $output .= html_writer::empty_tag('input', array('type' => 'hidden', 'name' => 'id',
+            'value' => $this->cm->id));
+        $output .= html_writer::empty_tag('input', array('type' => 'hidden', 'name' => 'group',
+            'value' => $this->groupid));
+        $output .= html_writer::empty_tag('input', array('type' => 'hidden', 'name' => 'sesskey',
+            'value' => $USER->sesskey));
+        return $output;
+    }
+
+    public function grade_form_footer() {
+        $output = '';
+        $savegrades = html_writer::empty_tag('input', array('type' => 'submit',
+            'name' => 'savegrades', 'value' => get_string('savegrades', 'oublog')));
+        $output = html_writer::tag('div', $savegrades, array('class' => 'savegradesbutton'));
+        $output .= html_writer::end_tag('form');
+        return $output;
+    }
+
+}
+
+
+/**
+ * Class oublog_user_participation_table
+ * extends flexible_table to override header and download rules
+ *
+ * The table for the context of oublog is only used for facilitating
+ * the CSV download all other view is done using standard oublog divs
+ * and classes
+ */
+class oublog_user_participation_table extends flexible_table {
+
+    public $cmid;
+    public $course;
+    public $oublog;
+    public $userid;
+    public $userfullname;
+    public $groupname;
+    public $groupid;
+
+    // Customised column and header info
+    public $detailsheader;
+    public $postsheader;
+    public $commentsheader;
+    public $posts;
+    public $comments;
+
+    public function __construct($cmid, $course, $oublog, $userid, $userfullname,
+        $groupname, $groupid) {
+
+        $this->cmid = $cmid;
+        $this->course = $course;
+        $this->oublog = $oublog;
+        $this->userid = $userid;
+        $this->userfullname = $userfullname;
+        $this->groupname = $groupname;
+        $this->groupid = $groupid;
+        parent::__construct('mod-oublog-user-participation');
+    }
+
+    public function setup($download = '') {
+        global $CFG, $PAGE;
+
+        // Extra headers
+        $this->postsheader = array(
+            get_string('date'),
+            get_string('time'),
+            get_string('title', 'oublog'),
+            get_string('content'),
+            get_string('attachments', 'oublog'),
+        );
+
+        $this->commentsheader = array(
+            get_string('date'),
+            get_string('time'),
+            get_string('title', 'oublog'),
+            get_string('content'),
+            get_string('postauthor', 'oublog'),
+            get_string('postdate', 'oublog'),
+            get_string('posttime', 'oublog'),
+            get_string('posttitle', 'oublog'),
+        );
+        $this->posts = array(get_string('posts', 'oublog'));
+        $this->comments = array(get_string('comments', 'oublog'));
+
+        $headers = array(
+            format_string($this->course->shortname, true),
+            format_string($this->oublog->name, true),
+        );
+        if (!empty($this->groupname)) {
+            $headers[] = $this->groupname;
+        }
+        $headers[] = $this->userfullname;
+
+        // set columns as the maximum otherwise the table
+        // won't add_data correctly
+        $columns = array();
+        for ($i = 1; $i <= 8; $i++) {
+            $columns[] = 'column'.$i;
+        }
+
+        $this->define_columns($columns);
+        $this->define_headers($headers);
+        $this->define_baseurl($PAGE->url);
+
+        $this->set_attribute('cellspacing', '0');
+        $this->set_attribute('id', 'participation');
+        $this->set_attribute('class', 'participation');
+        $this->set_attribute('width', '100%');
+        $this->set_attribute('align', 'center');
+        $this->sortable(false);
+
+        parent::setup();
+    }
+
+    /**
+     * This function is not part of the public api.
+     *
+     * Overriding here to avoid downloading in unsupported formats
+     */
+    public function get_download_menu() {
+        $exportclasses = array('csv' => get_string('downloadcsv', 'oublog'));
+        return $exportclasses;
+    }
+
+    /**
+     * This function is not part of the public api.
+     *
+     * Overriding here to only print the download button on this page
+     */
+    public function download_buttons() {
+        $html = '';
+        if ($this->is_downloadable() && !$this->is_downloading()) {
+            $downloadoptions = $this->get_download_menu();
+            $html = '<form action="'. $this->baseurl .'" method="post">';
+            $html .= '<div class="mdl-align">';
+            $html .= '<input type="submit" value="'.get_string('downloadas', 'oublog').'"/> ';
+            $html .= html_writer::select($downloadoptions, 'download',
+                $this->download, false);
+            $html .= '</div></form>';
+        }
+        return $html;
+    }
+}
diff --git a/mod/oublog/participationlist.php b/mod/oublog/participationlist.php
new file mode 100644
index 0000000..6e6af33
--- /dev/null
+++ b/mod/oublog/participationlist.php
@@ -0,0 +1,202 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Page for viewing user  participation list
+ *
+ * @package mod_oublog
+ * @copyright 2014 The Open University
+ * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+require_once(dirname(__FILE__) . '/../../config.php');
+require_once($CFG->dirroot.'/mod/oublog/locallib.php');
+require_once($CFG->libdir.'/gradelib.php');
+
+$id = required_param('id', PARAM_INT); // Course Module ID.
+$groupid = optional_param('group', 0, PARAM_INT);
+$page = optional_param('page', 0, PARAM_INT);
+$curindividual = optional_param('individual', 0, PARAM_INT);
+$tab = optional_param('tab', 0, PARAM_INT);// Current tab, 0:Posts, 1:Comments.
+if ($groupid < 0) {
+    $groupid = 0;
+}
+$params = array(
+    'id' => $id,
+    'individual' => $curindividual,
+    'group' => $groupid,
+    'page' => $page,
+    'tab' => $tab
+);
+$url = new moodle_url('/mod/oublog/participationlist.php', $params);
+$PAGE->set_url($url);
+$getposts = true;
+$getcomments = false;
+$limitnum = OUBLOG_PARTICIPATION_PERPAGE;
+$limitfrom = empty($page) ? null : $page * $limitnum;
+
+$cm = get_coursemodule_from_id('oublog', $id, 0, false, MUST_EXIST);
+$course = $DB->get_record('course', array('id' => $cm->course), '*', MUST_EXIST);
+$oublog = $DB->get_record('oublog', array('id' => $cm->instance), '*', MUST_EXIST);
+
+$PAGE->set_cm($cm);
+$context = context_module::instance($cm->id);
+$PAGE->set_pagelayout('incourse');
+require_course_login($course, true, $cm);
+
+// Create time filter options form.
+$customdata = array(
+        'cmid' => $cm->id,
+        'individual' => $curindividual,
+        'group' => $groupid,
+        'startyear' => $course->startdate,
+        'params' => array( 'tab' => $tab)
+);
+$timefilter = new oublog_participation_timefilter_form(null, $customdata);
+
+$start = $end = 0;
+// If data has been received from this form.
+if ($submitted = $timefilter->get_data()) {
+    if ($submitted->start) {
+        $start = strtotime('00:00:00', $submitted->start);
+    }
+    if ($submitted->end) {
+        $end = strtotime('23:59:59', $submitted->end);
+    }
+} else {
+    // Recieved via post back for tab useage.
+    if ($start = optional_param('start', null, PARAM_INT)) {
+        $timefilter->set_data(array('start' => $start));
+        $start = strtotime('00:00:00', $start);
+    }
+    if ($end = optional_param('end', null, PARAM_INT)) {
+        $timefilter->set_data(array('end' => $end));
+        $end = strtotime('23:59:59', $end);
+    }
+}
+// Customise data sought based on current tab.
+switch($tab) {
+    case 1:
+        $getposts = false;
+        $getcomments = true;
+        break;
+    case 2:
+        $getposts = false;
+        break;
+}
+
+$url->params(array('individual' => $curindividual, 'start' => $start, 'end' => $end, 'group' => $groupid));
+$PAGE->set_url($url);
+// Add extra navigation link for users who can see all participation.
+$PAGE->navbar->add(get_string('viewallparticipation', 'oublog'));
+$PAGE->set_title(format_string($oublog->name));
+$PAGE->set_heading(format_string($oublog->name));
+$oublogoutput = $PAGE->get_renderer('mod_oublog');
+
+echo $OUTPUT->header();
+
+// Print Groups drop-down menu.
+groups_print_activity_menu($cm, $url);
+if ($oublog->individual) {
+    $individualdetails = oublog_individual_get_activity_details($cm, $url, $oublog,
+            $groupid, $context);
+    if ($individualdetails) {
+        $curindividual = $individualdetails->activeindividual;
+        $oublog->individual = $individualdetails->mode;
+        echo $individualdetails->display;
+        $url->params(array('individual' => $curindividual, 'start' => $start, 'end' => $end));
+        $PAGE->set_url($url);
+    }
+}
+if (!$start && !$end) {
+    $title = get_string('participation_all', 'oublog');
+    $info = get_string('participation_all', 'oublog');
+}
+$startdate = userdate($start, get_string('strftimedaydate'));
+$enddate = userdate($end, get_string('strftimedaydate'));
+if ($start && !$end) {
+    $title = get_string('participation', 'oublog');
+    $info = get_string('participation_from', 'oublog', $startdate);
+}
+if (!$start && $end) {
+    $title = get_string('participation', 'oublog');
+    $info = get_string('participation_to', 'oublog', $enddate);
+}
+if ($start && $end) {
+    $a = new stdClass();
+    $a->start = $startdate;
+    $a->end = $enddate;
+    $title = get_string('participation', 'oublog');
+    $info = get_string('participation_fromto', 'oublog', $a);
+}
+$participation = oublog_get_participation_details($oublog, $groupid, $curindividual,
+    $start, $end, $page, $getposts, $getcomments, $limitfrom, $limitnum);
+
+$url->params(array('individual' => $curindividual, 'start' => $start, 'end' => $end));
+echo html_writer::tag('h2', $info, array('class' => 'oublog-post-title'));
+$timefilter->display();
+
+$taburl = clone $url;
+$taburl->remove_params(array('page', 'tab'));
+$tabs = array(
+        new tabobject('tab0', $taburl, $participation->postscount . ' ' . get_string('posts', 'oublog')),
+        new tabobject('tab1', $taburl->out() . '&amp;tab=1', $participation->commentscount . ' ' .
+                 get_string('comments', 'oublog')),
+);
+
+echo $OUTPUT->tabtree($tabs, "tab$tab");
+
+// Output message when no content for tab.
+$warning = '';
+if ($tab == 0 && (!isset($participation->postscount) || $participation->postscount < 1)) {
+    $warning = get_string('nouserpostsfound', 'oublog');
+    $getposts = false;
+} else if ($tab == 1 && (!isset($participation->commentscount) || $participation->commentscount < 1)) {
+    $warning = get_string('nousercommentsfound', 'oublog');
+    $getcomments = false;
+}
+
+if (!empty($warning)) {
+    $output = $OUTPUT->box_start('generalbox', 'notice');
+    $output .= html_writer::tag('p', $warning);
+    $output .= $OUTPUT->box_end();
+    echo $output;
+}
+
+$pagingurl = new moodle_url('/mod/oublog/participationlist.php',
+        array('id' => $cm->id, 'individual' => $curindividual,
+        'page' => $page, 'start' => $start, 'end' => $end, 'tab' => $tab, 'group' => $groupid));
+
+echo $oublogoutput->render_all_users_participation_table($cm, $course, $oublog,
+        $page, $limitnum, $participation, $getposts, $getcomments,
+        $start, $end, $pagingurl);
+
+echo $oublogoutput->get_link_back_to_oublog($cm->name, $cm->id);
+
+echo $OUTPUT->footer();
+
+// Log visit list event.
+$params = array(
+    'context' => $context,
+    'objectid' => $oublog->id,
+    'other' => array(
+        'info' => 'all participation',
+        'logurl' => 'participationlist.php?id=' . $cm->id
+    )
+);
+$event = \mod_oublog\event\participation_viewed::create($params);
+$event->add_record_snapshot('course', $course);
+$event->trigger();
diff --git a/mod/oublog/pix/icon.gif b/mod/oublog/pix/icon.gif
new file mode 100644
index 0000000000000000000000000000000000000000..1f04b9715554ea01c0815b403de722f44a4dd619
GIT binary patch
literal 592
zcmZ?wbhEHb6krfwc;>*sZ(pDr(fs+x|2N<M8$>p5J%01io3F3G{ugj4*mCUVi_ibh
z-+c7)%m1lskNFf%d-e7It1tiepSihw_xUBe&j0=QKcINp`u*n}(t09m=g(Mw?C|AB
zAAbDL>Rfr`@}q*@l@DHj{r>y^w_pDwYUWQ{cWlbqV{Hrf)X&@$Su@`zr6;;}{<h;c
zAHM$TT{!LN<ww)k9b2~R{Gm&aUVQog=Ij53JI-%Aar5)f|G)qK-+b)myYK(se*6F7
z`~P>}{=fhJ|KpGUpMLyjFi!jb|3AY}28usf7#SEG7<53M0L2Ld``QKv2St7^E<+w3
z0RdwrQSK%Me)cIw%+oDrs&GuOm^pu@^`b@U;%19isPZndu;8^{ZoPK11cQOi4)YB=
z_UzGMkl(r6#{B3pVFpHRE6&|k_7^T*R6eu8>iUiAQVcq_wyYbZ?>)9<V`OBz_rUDQ
zV@8ITc6JX0Wo<wG(9`{4r*AJJ^MiAW`hkP|3M?TU5fO_Q9+r}<t6)fa=+4DyVw5!{
UVM2p~f*^;-<hBDX3mh1%0TL9{`Tzg`

literal 0
HcmV?d00001

diff --git a/mod/oublog/pix/icon.png b/mod/oublog/pix/icon.png
new file mode 100644
index 0000000000000000000000000000000000000000..1e01bcfa5728a97f1fb8dffa10fbffe4090627df
GIT binary patch
literal 1147
zcmV->1cdvEP)<h;3K|Lk000e1NJLTq000mG000mO1^@s6AM^iV00009a7bBm000XU
z000XU0RWnu7ytkPIcY;fP*7-ZbZ>KLZ*U+<Lqi~Na&Km7Y-Iodc-pOzu}Z^G6o$VW
zMa7|32;$&yCs9yr)xnHOTZ$l9t3#5lNkf&=B;4GpeF#Ul4leFKfs>=)p!fv7f#TG`
zAxLl%!EgG`&*5<32cu%worY0{L9A7~=}6b}<?ItPOaVYA%u>76Isk~1IN~P)K3@?4
z&zpALY4A7Z!&GTt0&I7qECf*j`WHIYAjW_h^ivJu4lvb8y9VL`DD`rG0ZKvcZ$L@8
zo)6*!Fng}&gE0q~LGCMnsiR8`P)pL0I_sTkS+y)n+TA3G<nbue(IAuiahRwyQ5_w1
zf&4!J7W2h+(~)ac%i3G#pK(23=JtMs0L0Q`krjkPb^hIjvGe;}+!!yz;Vn#0ifs1^
zZZ=@yy2w_mP~L+3@fX6gPyQSUvnK!m03c&XQcVB=dL;k=fP(-4`Tqa_fam}KQV0M6
z6<7cOI+p+d7jM^EACLe50=!8?K~#9!gp<u{RA&^%fA9Sm$C*jyL&r1*Oj18^Au%DQ
zC<#pz7b-|W?OK;YsVj?%F6y7)LbPf@rJF)2OfkfTCQYa|YD_YI6r(9PHc?wMHqK0D
z?!9y0_r6`E5uFA+@NCXGob#NA^S}o}YaJi{@$~$I8~xubSGQ^trTMvwQ)AbU0Br8s
zed+hntBFGX1-*y9IJMjWQM0Z2?zJCs<)=5XEQ>#9|DsrS=|1``GYcklVH1C9fJm}|
zf8y-`8KY)ki{~t`=A#Bu=~d{!Cu}PGnK9NUG_#qn2}fechR&t_gs7!-<L3)HY5Ywr
z7Df7!s_QX+cLLvt(sl4Figptf8Q=$?Vc4iSq1P?F=JBJ)+|NE>@Y)c*QYfW}tgwhC
z8c5gKq~r@yg)AXcysyFR^u5Wcq4VuhO6ubE%shRDl#*>-on*(e=#{GhShuBz<c94$
z_v(kOchw&_ccT5%-fe`V5q=#UA-pn7B9R0Hre(1r8s(GEPx7kZQB)es&=^|l`1It+
zWdE7tM>@7{LI{CY0b4uUaVidLn;Hp}qP3-&@|!tAwt;DYDZmf{>-N>}bGflA3D5J;
zL4aF!n4X%ZSdk>xZsg9y6H-wFQwZwQ>+n4J-rd%dn?EI5Tbd~pOWgYHHijKS1_t|&
zouyK>h=olS@;Q9BO#PZxijG8S2>yd5>=@FQ1X2-Sm8N@FFQcOmDfu=Fl`5_)u|tiR
zAt*Rd4K&pNd<{zLoY8aW%Z%OBL1V{W9M`Ap_(*4-h<<~sG>+1g<svFd<0$Zyrm8eb
zlM(Oyz~Msv<)zX7@2E>P^6`!X{E^q#0t^8{EK-)iTNcB6+R{5~z3^Es@0^;QcUwxX
z!W2ttFPbLMpcawU(6_HGUHIQC58R*o1?XGGcv&C^WcIbCFE1tk9RRT-RN>pM8E^mq
N002ovPDHLkV1ls#7^46H

literal 0
HcmV?d00001

diff --git a/mod/oublog/pluginfile.php b/mod/oublog/pluginfile.php
new file mode 100644
index 0000000..3543e90
--- /dev/null
+++ b/mod/oublog/pluginfile.php
@@ -0,0 +1,57 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * A script to serve files from OU Blog client ONLY
+ * Used so can apply restrictions on core pluginfile, but leave this open to world
+ *
+ * @package    mod
+ * @subpackage oublog
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+require_once('../../config.php');
+require_once($CFG->dirroot . '/lib/filelib.php');
+
+$relativepath = get_file_argument();
+
+// Relative path must start with '/'.
+if (!$relativepath) {
+    print_error('invalidargorconf');
+} else if ($relativepath{0} != '/') {
+    print_error('pathdoesnotstartslash');
+}
+
+// Extract relative path components.
+$args = explode('/', ltrim($relativepath, '/'));
+
+if (count($args) == 0) { // Always at least user id.
+    print_error('invalidarguments');
+}
+$contextid = (int)array_shift($args);
+$component = array_shift($args);
+$filearea = array_shift($args);
+$draftid = (int)array_shift($args);
+
+if ($component !== 'mod_oublog' && ($filearea !== 'message' || $filearea !== 'attachment'
+        || $filearea !== 'messagecomment' || $filearea !== 'summary')) {
+    send_file_not_found();
+}
+// Following code must match root pluginfile.php (can't include, so must duplicate).
+$forcedownload = optional_param('forcedownload', 0, PARAM_BOOL);
+$preview = optional_param('preview', null, PARAM_ALPHANUM);
+
+file_pluginfile($relativepath, $forcedownload, $preview);
diff --git a/mod/oublog/post_form.php b/mod/oublog/post_form.php
new file mode 100644
index 0000000..7bcdd69
--- /dev/null
+++ b/mod/oublog/post_form.php
@@ -0,0 +1,166 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+require_once($CFG->libdir.'/formslib.php');
+
+class mod_oublog_post_form extends moodleform {
+
+    private $restricttags = 0;
+    private $requiretags = 0;
+    private $availtags = array();
+
+    public function definition() {
+
+        global $CFG;
+
+        $individualblog = $this->_customdata['individual'];
+        $maxvisibility = $this->_customdata['maxvisibility'];
+        $allowcomments = $this->_customdata['allowcomments'];
+        $edit          = $this->_customdata['edit'];
+        $personal      = $this->_customdata['personal'];
+        $maxbytes      = $this->_customdata['maxbytes'];
+        $maxattachments = $this->_customdata['maxattachments'];
+        $referurl = $this->_customdata['referurl'];
+        $this->restricttags = false;
+        $this->requiretags = false;
+
+        if ($this->_customdata['restricttags'] == 1 || $this->_customdata['restricttags'] == 3) {
+            $this->restricttags = true;
+        }
+        if ($this->_customdata['restricttags'] == 2 || $this->_customdata['restricttags'] == 3) {
+            $this->requiretags = true;
+        }
+        $atags = array();
+        // Get list of tags from 'availtags' customdata.
+        if ($this->_customdata['availtags'] != false && $this->restricttags == true) {
+            $this->availtags = $this->_customdata['availtags'];
+            foreach ($this->availtags as $tag) {
+                $atags[] = $tag->tag;
+            }
+        }
+
+        $mform    =& $this->_form;
+
+        $mform->addElement('header', 'general', '');
+
+        $mform->addElement('text', 'title', get_string('title', 'oublog'), 'size="48"');
+        $mform->setType('title', PARAM_TEXT);
+
+        $mform->addElement('editor', 'message', get_string('message', 'oublog'),
+                array('cols' => 50, 'rows' => 30),
+                array('maxfiles' => EDITOR_UNLIMITED_FILES, 'maxbytes' => $maxbytes));
+        $mform->addRule('message', get_string('required'), 'required', null, 'client');
+
+        if ($this->restricttags) {
+            $mform->addElement('static', 'restricttagswarning', '', get_string('restricttagslist', 'oublog', implode(',', $atags)));
+        }
+
+        $mform->addElement('textarea', 'tags', get_string('tagsfield', 'oublog'), array('cols'=>48, 'rows'=>2));
+        $mform->setType('tags', PARAM_TAGLIST);
+        $mform->addHelpButton('tags', 'tags', 'oublog');
+        if ($this->requiretags) {
+            $mform->addRule('tags', get_string('required'), 'required', null, 'client');
+        }
+
+        $options = array();
+        if ($allowcomments) {
+            $options[OUBLOG_COMMENTS_ALLOW] = get_string('logincomments', 'oublog');
+            if ($allowcomments >= OUBLOG_COMMENTS_ALLOWPUBLIC
+                && OUBLOG_VISIBILITY_PUBLIC <= $maxvisibility) {
+                $maybepubliccomments = true;
+                $options[OUBLOG_COMMENTS_ALLOWPUBLIC] = get_string('publiccomments', 'oublog');
+            }
+            $options[OUBLOG_COMMENTS_PREVENT] = get_string('no', 'oublog');
+
+            $mform->addElement('select', 'allowcomments', get_string('allowcomments', 'oublog'), $options);
+            $mform->setType('allowcomments', PARAM_INT);
+            $mform->addHelpButton('allowcomments', 'allowcomments', 'oublog');
+
+            if (isset($maybepubliccomments)) {
+                // NOTE - module.js adds a listener to allowcomments that hides/shows this element as mforms doesn't support this.
+                $mform->addElement('static', 'publicwarning', '', '<div id="publicwarningmarker"></div>'. get_string('publiccomments_info', 'oublog'));
+            }
+        } else {
+            $mform->addElement('hidden', 'allowcomments', OUBLOG_COMMENTS_PREVENT);
+            $mform->setType('allowcomments', PARAM_INT);
+        }
+
+        $options = array();
+        if (OUBLOG_VISIBILITY_COURSEUSER <= $maxvisibility) {
+            $options[OUBLOG_VISIBILITY_COURSEUSER] = oublog_get_visibility_string(OUBLOG_VISIBILITY_COURSEUSER, $personal);
+        }
+        if (OUBLOG_VISIBILITY_LOGGEDINUSER <= $maxvisibility) {
+            $options[OUBLOG_VISIBILITY_LOGGEDINUSER] = oublog_get_visibility_string(OUBLOG_VISIBILITY_LOGGEDINUSER, $personal);
+        }
+        if (OUBLOG_VISIBILITY_PUBLIC <= $maxvisibility) {
+            $options[OUBLOG_VISIBILITY_PUBLIC] = oublog_get_visibility_string(OUBLOG_VISIBILITY_PUBLIC, $personal);
+        }
+        if ($individualblog > OUBLOG_NO_INDIVIDUAL_BLOGS) {
+            $mform->addElement('hidden', 'visibility', OUBLOG_VISIBILITY_COURSEUSER);
+            $mform->setType('visibility', PARAM_INT);
+        } else if (OUBLOG_VISIBILITY_COURSEUSER != $maxvisibility) {
+            $mform->addElement('select', 'visibility', get_string('visibility', 'oublog'), $options);
+            $mform->setType('visibility', PARAM_INT);
+            $mform->addHelpButton('visibility', 'visibility', 'oublog');
+        } else {
+            $mform->addElement('hidden', 'visibility', OUBLOG_VISIBILITY_COURSEUSER);
+            $mform->setType('visibility', PARAM_INT);
+        }
+        if ($maxattachments > 0) {
+            $mform->addElement('filemanager', 'attachments', get_string('attachments', 'oublog'), null,
+                    array('subdirs' => 0, 'maxbytes' => $maxbytes, 'maxfiles' => $maxattachments));
+            $mform->addHelpButton('attachments', 'attachments', 'oublog');
+        }
+
+        if ($edit) {
+            $submitstring = get_string('savechanges');
+        } else {
+            $submitstring = get_string('addpost', 'oublog');
+        }
+
+        $this->add_action_buttons(true, $submitstring);
+
+        // Hidden form vars.
+        $mform->addElement('hidden', 'blog');
+        $mform->setType('blog', PARAM_INT);
+
+        $mform->addElement('hidden', 'post');
+        $mform->setType('post', PARAM_INT);
+
+        $mform->addElement('hidden', 'referurl', $referurl);
+        $mform->setType('referurl', PARAM_LOCALURL);
+
+    }
+
+    public function validation($data, $files) {
+        $errors = parent::validation($data, $files);
+        $testtags = 0;
+        $atags = $formtags = array();
+        if ($this->restricttags) {
+            foreach ($this->availtags as $tag) {
+                $atags[] = $tag->tag;
+            }
+            if (!empty($data['tags'])) {
+                $formtags = explode(",", $data['tags']);
+                $testtags = count(array_diff($formtags, $atags));
+            }
+        }
+        if ($this->restricttags && $testtags > 0) {
+            $errors['tags'] = get_string('restricttagsvalidation', 'oublog');
+        }
+        return $errors;
+    }
+}
diff --git a/mod/oublog/renderer.php b/mod/oublog/renderer.php
new file mode 100644
index 0000000..e80b08c
--- /dev/null
+++ b/mod/oublog/renderer.php
@@ -0,0 +1,1649 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Moodle renderer used to display special elements of the lesson module
+ *
+ * @package    mod
+ * @subpackage oublog
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ **/
+
+defined('MOODLE_INTERNAL') || die();
+
+class mod_oublog_renderer extends plugin_renderer_base {
+
+    /**
+     * Print a single blog post
+     *
+     * @param object $cm current course module object
+     * @param object $oublog Blog object
+     * @param string $viewname name of view controller file
+     * @return string
+     */
+    public function render_header($cm, $oublog, $viewname) {
+        // This function is empty and for theme renderers to override.
+    }
+
+    /**
+     * Hook run prior to displaying the page header. Note that this does not return anything
+     * and must not echo any output, because nothing can be displayed prior to the header, so it
+     * isn't a normal renderer function!
+     *
+     * @param stdClass $cm current course module object
+     * @param stdClass $oublog Blog object
+     * @param string $viewname name of view controller file
+     */
+    public function pre_display($cm, $oublog, $viewname) {
+        // This function is empty and for theme renderers to override.
+    }
+
+    /**
+     * Print a single blog post
+     *
+     * @param object $cm current course module object
+     * @param object $oublog Blog object
+     * @param object $post Structure containing all post info and comments
+     * @param string $baseurl Base URL of current page
+     * @param string $blogtype Blog level ie course or above
+     * @param bool $canmanageposts Has capability toggle
+     * @param bool $canaudit Has capability toggle
+     * @param bool $cancomment Has capability toggle
+     * @param bool $forexport Export output rendering toggle
+     * @param bool $email Email output rendering toggle
+     * @param bool $socialshareposition Position social sharing buttons top or bottom of post
+     * @return bool
+     */
+    public function render_post($cm, $oublog, $post, $baseurl, $blogtype,
+            $canmanageposts = false, $canaudit = false, $commentcount = true,
+            $forexport = false, $format = false, $email = false, $socialshareposition = 'top') {
+        global $CFG, $USER, $OUTPUT;
+        $output = '';
+        $modcontext = context_module::instance($cm->id);
+        $referurl = $baseurl;
+        // Get rid of any existing tag from the URL as we only support one at a time.
+        $baseurl = preg_replace('~&amp;tag=[^&]*~', '', $baseurl);
+
+        $strcomment = get_string('comment', 'oublog');
+        $strtags = get_string('tags', 'oublog');
+        $stredit = get_string('edit', 'oublog');
+        $strdelete = get_string('delete', 'oublog');
+        $strpermalink = get_string('permalink', 'oublog');
+
+        $row = '';
+        if (isset($post->row)) {
+            $row = ($post->row % 2) ? 'oublog-odd' : 'oublog-even';
+        }
+
+        $extraclasses = $post->deletedby ? ' oublog-deleted' : '';
+        $extraclasses .= ' oublog-hasuserpic';
+        $extraclasses .= ' ' . $row;
+
+        $output .= html_writer::start_tag('div', array('class' => 'oublog-post'. $extraclasses));
+        $output .= html_writer::start_tag('div', array('class' => 'oublog-post-top'));
+        $output .= html_writer::start_tag('div', array('class' => 'oublog-social-container'));
+        $fs = get_file_storage();
+        if ($files = $fs->get_area_files($modcontext->id, 'mod_oublog', 'attachment', $post->id,
+                'timemodified', false)) {
+            $output .= html_writer::start_tag('div', array('class' => 'oublog-post-attachments'));
+            $output .= html_writer::tag('span', get_string('attachments', 'mod_oublog') . ': ');
+            foreach ($files as $file) {
+                if (!$forexport && !$email) {
+                    $filename = $file->get_filename();
+                    $mimetype = $file->get_mimetype();
+                    $iconimage = html_writer::empty_tag('img',
+                            array('src' => $this->output->pix_url(file_mimetype_icon($mimetype)),
+                            'alt' => $mimetype, 'class' => 'icon'));
+                    if ($post->visibility == OUBLOG_VISIBILITY_PUBLIC) {
+                        $fileurlbase = '/mod/oublog/pluginfile.php';
+                    } else {
+                        $fileurlbase = '/pluginfile.php';
+                    }
+                    $filepath = '/' . $modcontext->id . '/mod_oublog/attachment/'
+                            . $post->id . '/' . $filename;
+                    $path = moodle_url::make_file_url($fileurlbase, $filepath, true);
+                    $output .= html_writer::start_tag('div', array('class' => 'oublog-post-attachment'));
+                    $output .= html_writer::tag('a', $iconimage, array('href' => $path));
+                    $output .= html_writer::tag('a', s($filename), array('href' => $path));
+                    $output .= html_writer::end_tag('div');
+                } else {
+                    $filename = $file->get_filename();
+                    if (is_object($format)) {
+                        $output .= $format->file_output($file) . ' ';
+                    } else {
+                        $output .= $filename . ' ';
+                    }
+                }
+            }
+            $output .= html_writer::end_tag('div');
+        }
+        if ($socialshareposition == 'top') {
+            $output .= $this->render_post_socialshares($cm, $oublog, $post, $baseurl, $blogtype,
+                    $canmanageposts, $canaudit, $commentcount, $forexport, $format, $email);
+        }
+        $output .= html_writer::end_tag('div');
+
+        $output .= html_writer::start_tag('div', array('class' => 'oublog-post-top-content'));
+        if (!$forexport) {
+            $output .= html_writer::start_tag('div', array('class' => 'oublog-userpic'));
+            $postuser = new stdClass();
+            $postuser->id = $post->userid;
+            $postuser->firstname = $post->firstname;
+            $postuser->lastname = $post->lastname;
+            $postuser->email = $post->email;
+            $postuser->imagealt = $post->imagealt;
+            $postuser->picture = $post->picture;
+            $postuser->firstnamephonetic = $post->firstnamephonetic;
+            $postuser->lastnamephonetic = $post->lastnamephonetic;
+            $postuser->middlename = $post->middlename;
+            $postuser->alternatename = $post->alternatename;
+            $output .= $this->output->user_picture($postuser,
+                    array('courseid' => $oublog->course, 'size' => 70));
+            $output .= html_writer::end_tag('div');
+        }
+        $output .= html_writer::start_tag('div', array('class' => 'oublog-post-top-details'));
+        $formattedtitle = format_string($post->title);
+        if (trim($formattedtitle) !== '') {
+            $output .= html_writer::tag('h2',
+                    format_string($post->title), array('class' => 'oublog-title'));
+        } else if (!$forexport) {
+            $posttitle = get_accesshide(get_string('newpost', 'mod_oublog',
+                    oublog_get_displayname($oublog)));
+            $output .= html_writer::tag('h2', $posttitle, array('class' => 'oublog-title'));
+        }
+
+        if ($post->deletedby) {
+            $deluser = new stdClass();
+            // Get user name fields.
+            $delusernamefields = get_all_user_name_fields(false, null, 'del');
+            foreach ($delusernamefields as $namefield => $retnamefield) {
+                $deluser->$namefield = $post->$retnamefield;
+            }
+
+            $a = new stdClass();
+
+            $a->fullname = html_writer::tag('a', fullname($deluser),
+                    array('href' => $CFG->wwwroot . '/user/view.php?id=' . $post->deletedby));
+            $a->timedeleted = oublog_date($post->timedeleted);
+            $output .= html_writer::tag('div', get_string('deletedby', 'oublog', $a),
+                    array('class' => 'oublog-post-deletedby'));
+        }
+
+        $output .= html_writer::start_tag('div', array('class' => 'oublog-post-date'));
+        $output .= oublog_date($post->timeposted);
+        $output .= html_writer::empty_tag('br', array());
+        $output .= ' ';
+        if ($blogtype == 'course' || strpos($_SERVER['REQUEST_URI'], 'allposts.php') != 0) {
+            $output .= html_writer::start_tag('div', array('class' => 'oublog-postedby'));
+            if (!$forexport) {
+                $output .= get_string('postedby', 'oublog', '<a href="' .
+                        $CFG->wwwroot.'/user/view.php?id=' . $post->userid . '&amp;course=' .
+                        $oublog->course . '">' . fullname($post) . '</a>');
+            } else {
+                $output .= get_string('postedby', 'oublog',  fullname($post));
+            }
+            $output .= html_writer::end_tag('div');
+        }
+        $output .= html_writer::end_tag('div');
+
+        if (!$oublog->individual) {
+            $output .= html_writer::start_tag('div', array('class' => 'oublog-post-visibility'));
+            $output .= oublog_get_visibility_string($post->visibility, $blogtype == 'personal');
+            $output .= html_writer::end_tag('div');
+        }
+
+        if (isset($post->edits) && ($canaudit || $post->userid == $USER->id)) {
+            $output .= html_writer::start_tag('div', array('class' => 'oublog-post-editsummary'));
+            foreach ($post->edits as $edit) {
+                $a = new stdClass();
+                $a->editby = fullname($edit);
+                $a->editdate = oublog_date($edit->timeupdated);
+                if (!$forexport && !$email) {
+                    if ($edit->userid == $post->userid) {
+                        $output .= '- '.html_writer::tag('a', get_string('editsummary',
+                                'oublog', $a), array('href' => $CFG->wwwroot .
+                                '/mod/oublog/viewedit.php?edit=' . $edit->id));
+                    } else {
+                        $output .= '- '.html_writer::tag('a', get_string('editonsummary',
+                                'oublog', $a), array('href' => $CFG->wwwroot .
+                                '/mod/oublog/viewedit.php?edit=' . $edit->id));
+                    }
+                } else {
+                    if ($edit->userid == $post->userid) {
+                        $output .= '- '.  get_string('editsummary', 'oublog', $a);
+                    } else {
+                        $output .= '- '. get_string('editonsummary', 'oublog', $a);
+                    }
+                }
+                $output .= html_writer::empty_tag('br', array());
+            }
+            $output .= html_writer::end_tag('div');
+        } else if ($post->lasteditedby) {
+            $edit = new StdClass;
+            // Get user name fields.
+            $editusernamefields = get_all_user_name_fields(false, null, 'ed');
+            foreach ($editusernamefields as $namefield => $retnamefield) {
+                $edit->$namefield = $post->$retnamefield;
+            }
+
+            $a = new stdClass();
+            $a->editby = fullname($edit);
+            $a->editdate = oublog_date($post->timeupdated);
+            $output .= html_writer::tag('div', get_string('editsummary', 'oublog', $a),
+                    array('class' => 'oublog-post-editsummary'));
+        }
+
+        $output .= html_writer::end_tag('div');
+        $output .= html_writer::end_tag('div');
+        $output .= html_writer::end_tag('div');
+        $output .= html_writer::start_tag('div', array('class' => 'oublog-post-content'));
+        if (!$forexport) {
+            if ($post->visibility == OUBLOG_VISIBILITY_PUBLIC || $email) {
+                $fileurlbase = 'mod/oublog/pluginfile.php';
+            } else {
+                $fileurlbase = 'pluginfile.php';
+            }
+            $post->message = file_rewrite_pluginfile_urls($post->message, $fileurlbase,
+                    $modcontext->id, 'mod_oublog', 'message', $post->id);
+        } else {
+            require_once($CFG->libdir . '/portfoliolib.php');
+            $post->message = portfolio_rewrite_pluginfile_urls($post->message, $modcontext->id,
+                    'mod_oublog', 'message', $post->id, $format);
+        }
+        $posttextoptions = new stdClass();
+        if (trusttext_active() && has_capability('moodle/site:trustcontent', $modcontext,
+                $post->userid)) {
+            // Support trusted text when initial author is safe (post editors are not checked!).
+            $posttextoptions->trusted = true;
+            $posttextoptions->context = $modcontext;
+        }
+        $output .= format_text($post->message, FORMAT_HTML, $posttextoptions);
+        $output .= html_writer::end_tag('div');
+        $output .= html_writer::start_tag('div', array('class' => 'oublog-post-bottom'));
+
+        if (isset($post->tags)) {
+            $output .= html_writer::start_tag('div', array('class' => 'oublog-post-tags')) .
+                    $strtags . ': ';
+            $tagcounter = 1;
+            // Get rid of page from the URL we dont want it in tags.
+            $pagelessurl = preg_replace('/&page=[^&]*/', '', $baseurl);
+            foreach ($post->tags as $taglink) {
+                $taglinktext = $taglink;
+                if ($tagcounter < count($post->tags)) {
+                    $taglinktext .= ',';
+                }
+                if (!$forexport && !$email) {
+                    $output .= html_writer::tag('a', $taglinktext, array('href' => $pagelessurl .
+                            '&tag=' . urlencode($taglink))) . ' ';
+                } else {
+                    $output .= $taglinktext . ' ';
+                }
+                $tagcounter++;
+            }
+            $output .= html_writer::end_tag('div');
+        }
+        if (!$forexport && !$email) {
+            // Output ratings.
+            if (!empty($post->rating)) {
+                $output .= html_writer::div($OUTPUT->render($post->rating), 'oublog-post-rating');
+            }
+        }
+        $output .= html_writer::start_tag('div', array('class' => 'oublog-post-links'));
+        if (!$forexport && !$email) {
+            $output .= html_writer::tag('a', $strpermalink, array('href' => $CFG->wwwroot .
+                    '/mod/oublog/viewpost.php?post=' . $post->id)).' ';
+        }
+
+        if (!$post->deletedby) {
+            if (($post->userid == $USER->id || $canmanageposts)) {
+                if (!$forexport && !$email) {
+                    $output .= html_writer::tag('a', $stredit, array('href' => $CFG->wwwroot .
+                            '/mod/oublog/editpost.php?blog=' . $post->oublogid .
+                            '&post=' . $post->id . '&referurl=' . urlencode($referurl))) . ' ';
+                    if (($post->userid !== $USER->id)) {
+                        // Add email and 'oublog_deleteandemail' to delete link.
+                        $output .= html_writer::tag('a', $strdelete, array('href' => $CFG->wwwroot .
+                                '/mod/oublog/deletepost.php?blog=' . $post->oublogid .
+                                '&post=' . $post->id . '&delete=1' . '&referurl=' . urlencode($referurl),
+                                'class' => 'oublog_deleteandemail_' . $post->id));
+                        self::render_oublog_print_delete_dialog($cm->id, $post->id);
+                    } else {
+                        $output .= html_writer::tag('a', $strdelete, array('href' => $CFG->wwwroot .
+                                '/mod/oublog/deletepost.php?blog=' . $post->oublogid .
+                                '&post=' . $post->id . '&delete=1' . '&referurl=' . urlencode($referurl)));
+                    }
+                    $output .= ' ';
+                }
+            }
+            // Show portfolio export link.
+            if (!empty($CFG->enableportfolios) &&
+                    (has_capability('mod/oublog:exportpost', $modcontext) ||
+                    ($post->userid == $USER->id &&
+                    has_capability('mod/oublog:exportownpost', $modcontext)))) {
+                if (!$forexport && !$email) {
+                    require_once($CFG->libdir . '/portfoliolib.php');
+                    $button = new portfolio_add_button();
+                    $button->set_callback_options('oublog_portfolio_caller',
+                            array('postid' => $post->id), 'mod_oublog');
+                    if (empty($files)) {
+                        $button->set_formats(PORTFOLIO_FORMAT_PLAINHTML);
+                    } else {
+                        $button->set_formats(PORTFOLIO_FORMAT_RICHHTML);
+                    }
+                    $output .= $button->to_html(PORTFOLIO_ADD_TEXT_LINK).' ';
+                }
+            }
+            // Show OU Alerts reporting link.
+            if (isloggedin() && oublog_oualerts_enabled()
+                    && oublog_get_reportingemail($oublog) && !($post->userid == $USER->id)
+                    && !$post->deletedby) {
+                $itemnurl = new moodle_url('/mod/oublog/viewpost.php', array('post' => $post->id));
+                $reportlink = oualerts_generate_alert_form_url('oublog', $modcontext->id,
+                        'post', $post->id, $itemnurl, $itemnurl, '', false, true);
+                if ($reportlink != '' && !$forexport && !$email) {
+                    $output .= html_writer::tag('a', get_string('postalert', 'oublog'),
+                            array('href' => $reportlink));
+                }
+            }
+
+            // Show comments.
+            if ($post->allowcomments) {
+                // If this is the current user's post, show pending comments too.
+                $showpendingcomments = $post->userid == $USER->id && !empty($post->pendingcomments);
+                if ((isset($post->comments) || $showpendingcomments) && $commentcount) {
+                    // Show number of comments.
+                    if (isset($post->comments)) {
+                        $linktext = get_string(
+                                count($post->comments) == 1 ? 'onecomment' : 'ncomments',
+                                'oublog', count($post->comments));
+                    }
+                    // Show number of pending comments.
+                    if (isset($post->pendingcomments)) {
+                        // Use different string if we already have normal comments too.
+                        if (isset($post->comments)) {
+                            $linktext .= get_string(
+                                    $post->pendingcomments == 1 ? 'onependingafter' : 'npendingafter',
+                                    'oublog', $post->pendingcomments);
+                        } else {
+                            $linktext = get_string(
+                                    $post->pendingcomments == 1 ? 'onepending' : 'npending',
+                                    'oublog', $post->pendingcomments);
+                        }
+                    }
+                    if (!$forexport) {
+                        // Display link.
+                        $output .= html_writer::tag('a', $linktext, array('href' => $CFG->wwwroot .
+                                '/mod/oublog/viewpost.php?post=' . $post->id . '#oublogcomments'));
+                    } else {
+                        $output .= $linktext;
+                    }
+                    // Display information about most recent comment.
+                    if (isset($post->comments)) {
+                        $last = array_pop($post->comments);
+                        array_push($post->comments, $last);
+                        $a = new stdClass();
+                        if ($last->userid) {
+                            $a->fullname = fullname($last);
+                        } else {
+                            $a->fullname = s($last->authorname);
+                        }
+                        $a->timeposted = oublog_date($last->timeposted, true);
+                        $output .= html_writer::tag('span', ' ' . get_string('lastcomment',
+                                'oublog', $a), array('class' => 'oublog_links_comment'));
+                    }
+                } else if (oublog_can_comment($cm, $oublog, $post)) {
+                    if (!$forexport && !$email) {
+                        $output .= html_writer::tag('a', $strcomment, array(
+                                'href' => $CFG->wwwroot . '/mod/oublog/editcomment.php?blog=' .
+                                $post->oublogid . '&post=' . $post->id));
+                    }
+                }
+            }
+        }
+
+        $output .= html_writer::end_tag('div');
+        $output .= html_writer::end_tag('div');
+
+        if ($socialshareposition == 'bottom') {
+            $output .= $this->render_post_socialshares($cm, $oublog, $post, $baseurl, $blogtype,
+                    $canmanageposts, $canaudit, $commentcount, $forexport, $format, $email);
+        }
+
+        $output .= html_writer::tag('div', '', array('style' => 'clear: both'));
+
+        $output .= html_writer::end_tag('div');
+
+        return $output;
+    }
+
+    /**
+     * Print post social sharing buttons.
+     *
+     * @param object $cm current course module object
+     * @param object $oublog Blog object
+     * @param object $post Structure containing all post info and comments
+     * @param string $baseurl Base URL of current page
+     * @param string $blogtype Blog level ie course or above
+     * @param bool $canmanageposts Has capability toggle
+     * @param bool $canaudit Has capability toggle
+     * @param bool $cancomment Has capability toggle
+     * @param bool $forexport Export output rendering toggle
+     * @param bool $email Email output rendering toggle
+     * @return bool
+     */
+    protected function render_post_socialshares($cm, $oublog, $post, $baseurl, $blogtype,
+            $canmanageposts = false, $canaudit = false, $commentcount = true,
+            $forexport = false, $format = false, $email = false) {
+
+        $output = '';
+
+        // Only show widgets if blog is global ect.
+        if ($oublog->global && $oublog->maxvisibility == OUBLOG_VISIBILITY_PUBLIC) {
+            if ($post->visibility == OUBLOG_VISIBILITY_PUBLIC && !$forexport && !$email) {
+                list($oublog, $oubloginstance) = oublog_get_personal_blog($post->userid);
+                $oubloginstancename = $oubloginstance->name;
+
+                $linktext = get_string('tweet', 'oublog');
+                $purl = new moodle_url('/mod/oublog/viewpost.php', array('post' => $post->id));
+                $postname = !(empty($post->title)) ? $post->title : get_string('untitledpost', 'oublog');
+                $output .= html_writer::start_tag('div', array('class' => 'oublog-post-socialshares'));
+                $output .= html_writer::tag('div', get_string('share', 'oublog'),
+                        array('class' => 'oublog-post-share-title'));
+                $output .= html_writer::start_tag('div', array('class' => 'oublog-post-share'));
+
+                // Show tweet link.
+                $output .= html_writer::start_tag('div',
+                        array('class' => 'share-button'));
+                $params = array('url' => $purl, 'dnt' => true, 'count' => 'none',
+                        'text' => $postname . " " . $oubloginstance->name,
+                        'class' => 'twitter-share-button');
+                $turl = new moodle_url('https://twitter.com/share', $params);
+                $output .= html_writer::link($turl, $linktext, $params);
+                $output .= html_writer::end_tag('div');
+
+                // Show facebook link.
+                $output .= html_writer::start_tag('div',
+                        array('class' => 'share-button'));
+                $output .= html_writer::start_tag('div',
+                        array('class' => 'fb-share-button',
+                        'data-href' => $purl,
+                        'data-layout' => 'button'));
+                $output .= html_writer::end_tag('div');
+                $output .= html_writer::end_tag('div');
+
+                // Show googleplus link.
+                $output .= html_writer::start_tag('div',
+                        array('class' => 'share-button'));
+                $output .= html_writer::start_tag('div',
+                        array('class' => 'g-plus',
+                        'data-href' => $purl,
+                        'data-action' => 'share',
+                        'data-height' => 20,
+                        'data-annotation' => 'none'));
+                $output .= html_writer::end_tag('div');
+                $output .= html_writer::end_tag('div');
+
+                $output .= html_writer::end_tag('div');
+                $output .= html_writer::end_tag('div');
+
+                // With JS enabled show social widget buttons.
+                self::render_twitter_js();
+                $output .= self::render_facebook_js();
+                $output .= self::render_googleplus_js();
+            }
+        }
+
+        return $output;
+    }
+
+    /**
+     * Returns output for time limit messages
+     * @param string $stringname
+     * @param int $time Unix time when restricted
+     * @param context $capable Used to alter stringname for moderators if true
+     * @param string $type 'post' or 'comment' - used for div class
+     * @return string
+     */
+    public function render_time_limit_msg($stringname, $time, $capable = false, $type = 'post') {
+        $extra = $capable ? 'capable' : '';
+        return html_writer::div(get_string($stringname . $extra, 'oublog',
+                userdate($time, get_string('strftimedatetimeshort', 'langconfig'))),
+                "oublog_time_limit_msg oublog_time_limit_msg_$type");
+    }
+
+    /**
+     * Print all user participation records for display
+     *
+     * @param object $cm current course module object
+     * @param object $course current course object
+     * @param object $oublog current oublog object
+     * @param int $groupid optional group id, no group = 0
+     * @param string $download download type (csv only, default '')
+     * @param int $page flexible_table pagination page
+     * @param array $participation mixed array of user participation values
+     * @param object $context current context
+     * @param bool $viewfullnames flag for global users fullnames capability
+     * @param string groupname group name for display, default ''
+     */
+    public function render_participation_list($cm, $course, $oublog, $groupid,
+        $download, $page, $participation, $context, $viewfullnames, $groupname) {
+        global $DB, $CFG, $OUTPUT;
+
+        require_once($CFG->dirroot.'/mod/oublog/participation_table.php');
+        $perpage = OUBLOG_PARTICIPATION_PERPAGE;
+
+        // Filename for downloading setup.
+        $filename = "$course->shortname-".format_string($oublog->name, true);
+        if (!empty($groupname)) {
+            $filename .= '-'.format_string($groupname, true);
+        }
+
+        $hasgrades = !empty($participation) && isset(reset($participation)->gradeobj);
+        $table = new oublog_participation_table($cm, $course, $oublog,
+            $groupid, $groupname, $hasgrades);
+        $table->setup($download);
+        $table->is_downloading($download, $filename, get_string('participation', 'oublog'));
+
+        if (!empty($participation)) {
+            if (!$table->is_downloading()) {
+                if ($perpage > count($participation)) {
+                    $perpage = count($participation);
+                }
+                $table->pagesize($perpage, count($participation));
+                $offset = $page * $perpage;
+                $endposition = $offset + $perpage;
+            } else {
+                // Always export all users.
+                $endposition = count($participation);
+                $offset = 0;
+            }
+            $currentposition = 0;
+            foreach ($participation as $user) {
+                if ($currentposition == $offset && $offset < $endposition) {
+                    $fullname = fullname($user, $viewfullnames);
+
+                    // Control details link.
+                    $details = false;
+
+                    // Counts.
+                    $posts = 0;
+                    if (isset($user->posts)) {
+                        $posts = $user->posts;
+                        $details = true;
+                    }
+                    $comments = 0;
+                    if (isset($user->comments)) {
+                        $comments = $user->comments;
+                        $details = true;
+                    }
+
+                    // User details.
+                    if (!$table->is_downloading()) {
+                        $picture = $OUTPUT->user_picture($user);
+                        $userurl = new moodle_url('/user/view.php?',
+                            array('id' => $user->id, 'course' => $course->id));
+                        $userdetails = html_writer::link($userurl, $fullname);
+                        if ($details) {
+                            $detailparams = array('id' => $cm->id,
+                                'user' => $user->id, 'group' => $groupid);
+                            $detailurl = new moodle_url('/mod/oublog/userparticipation.php',
+                                $detailparams);
+                            $accesshidetext = get_string('foruser', 'oublog', $fullname);
+                            $accesshide = html_writer::tag('span', $accesshidetext,
+                                array('class' => 'accesshide'));
+                            $detaillink = html_writer::start_tag('small');
+                            $detaillink .= ' (';
+                            $detaillink .= html_writer::link($detailurl,
+                                get_string('details', 'oublog') . $accesshide);
+                            $detaillink .= ')';
+                            $detaillink .= html_writer::end_tag('small');
+                            $userdetails .= $detaillink;
+                        }
+                    }
+
+                    // Grades.
+                    if ($oublog->grading != OUBLOG_NO_GRADING && isset($user->gradeobj)) {
+                        if (!$table->is_downloading()) {
+                            $attributes = array('userid' => $user->id);
+                            if (empty($user->gradeobj->grade)) {
+                                $user->grade = -1;
+                            } else {
+                                $user->grade = abs($user->gradeobj->grade);
+                            }
+                            $menu = html_writer::select(make_grades_menu($oublog->grade),
+                                'menu['.$user->id.']', $user->grade,
+                                array(-1 => get_string('nograde')), $attributes);
+                            $gradeitem = '<div id="gradeuser'.$user->id.'">'. $menu .'</div>';
+                        } else {
+                            if (!isset($user->gradeobj->grade)) {
+                                $gradeitem = get_string('nograde');
+                            } else {
+                                $gradeitem = $user->gradeobj->grade;
+                            }
+                        }
+                    }
+
+                    // Add row.
+                    if (!$table->is_downloading()) {
+                        $row = array($picture, $userdetails, $posts, $comments);
+                    } else {
+                        $row = array($fullname, $posts, $comments);
+                    }
+                    if (isset($gradeitem)) {
+                        $row[] = $gradeitem;
+                    }
+                    $table->add_data($row);
+                    $offset++;
+                }
+                $currentposition++;
+            }
+        }
+        $table->finish_output();
+        if (!$table->is_downloading()) {
+            // Print the grade form footer if necessary.
+            if ($oublog->grading != OUBLOG_NO_GRADING && !empty($participation)) {
+                echo $table->grade_form_footer();
+            }
+        }
+    }
+
+    /**
+     * Print single user participation for display
+     *
+     * @param object $cm current course module object
+     * @param object $course current course object
+     * @param object $oublog current oublog object
+     * @param int $userid user id of user to view participation for
+     * @param int $groupid optional group id, no group = 0
+     * @param string $download download type (csv only, default '')
+     * @param int $page flexible_table pagination page
+     * @param array $participation mixed array of user participation values
+     * @param object $context current context
+     * @param bool $viewfullnames flag for global users fullnames capability
+     * @param string groupname group name for display, default ''
+     */
+    public function render_user_participation_list($cm, $course, $oublog, $participation, $groupid,
+        $download, $page, $context, $viewfullnames, $groupname) {
+        global $DB, $CFG;
+
+        $user = $participation->user;
+        $fullname = fullname($user, $viewfullnames);
+
+        // Setup the table.
+        require_once($CFG->dirroot.'/mod/oublog/participation_table.php');
+        $filename = "$course->shortname-".format_string($oublog->name, true);
+        if ($groupname !== '') {
+            $filename .= '-'.format_string($groupname, true);
+        }
+        $filename .= '-'.format_string($fullname, true);
+        $table = new oublog_user_participation_table($cm->id, $course, $oublog,
+            $user->id, $fullname, $groupname, $groupid);
+        $table->setup($download);
+        $table->is_downloading($download, $filename, get_string('participation', 'oublog'));
+
+        // Print standard output.
+        $output = '';
+        $modcontext = context_module::instance($cm->id);
+        if (!$table->is_downloading()) {
+            if ($participation->posts) {
+                $output .= html_writer::tag('h2', get_string('postsby', 'oublog', $fullname));
+                $counter = 0;
+                foreach ($participation->posts as $post) {
+                    $row = ($counter % 2) ? 'oublog-odd' : 'oublog-even';
+                    $counter++;
+                    $output .= html_writer::start_tag('div',
+                        array('class' => 'oublog-post ' . $row));
+                    $output .= html_writer::start_tag('div',
+                            array('class' => 'oublog-post-top'));
+                    // Post attachments.
+                    $fs = get_file_storage();
+                    if ($files = $fs->get_area_files($modcontext->id, 'mod_oublog', 'attachment',
+                            $post->id, 'timemodified', false)) {
+                        $output .= html_writer::start_tag('div',
+                                array('class' => 'oublog-post-attachments'));
+                        foreach ($files as $file) {
+                            $filename = $file->get_filename();
+                            $mimetype = $file->get_mimetype();
+                            $iconimage = html_writer::empty_tag('img', array(
+                                    'src' => $this->output->pix_url(file_mimetype_icon($mimetype)),
+                                    'alt' => $mimetype, 'class' => 'icon'
+                            ));
+                            $fileurlbase = $CFG->wwwroot . '/pluginfile.php';
+                            $filepath = '/' . $modcontext->id . '/mod_oublog/attachment/'
+                            . $post->id . '/' . $filename;
+                            $path = moodle_url::make_file_url($fileurlbase, $filepath);
+                            $output .= html_writer::tag('a', $iconimage, array('href' => $path));
+                            $output .= html_writer::tag('a', s($filename), array('href' => $path));
+                        }
+                        $output .= html_writer::end_tag('div');
+                    }
+                    // Post title and date.
+                    if (isset($post->title) && !empty($post->title)) {
+                        $viewposturl = new moodle_url('/mod/oublog/viewpost.php',
+                            array('post' => $post->id));
+                        $viewpost = html_writer::link($viewposturl, s($post->title));
+                        $output .= html_writer::tag('h3', $viewpost,
+                            array('class' => 'oublog-post-title'));
+                        $output .= html_writer::start_tag('div',
+                            array('class' => 'oublog-post-date'));
+                        $output .= oublog_date($post->timeposted);
+                        $output .= html_writer::end_tag('div');
+                    } else {
+                        $viewposturl = new moodle_url('/mod/oublog/viewpost.php',
+                            array('post' => $post->id));
+                        $viewpost = html_writer::link($viewposturl,
+                            oublog_date($post->timeposted));
+                        $output .= html_writer::tag('h3', $viewpost,
+                            array('class' => 'oublog-post-title'));
+                    }
+                    $output .= html_writer::end_tag('div');
+                    // Post content.
+                    $output .= html_writer::start_tag('div',
+                        array('class' => 'oublog-post-content'));
+                    $post->message = file_rewrite_pluginfile_urls($post->message,
+                        'pluginfile.php', $modcontext->id, 'mod_oublog',
+                        'message', $post->id);
+                    $output .= format_text($post->message, FORMAT_HTML);
+                    $output .= html_writer::end_tag('div');
+
+                    // End display box.
+                    $output .= html_writer::end_tag('div');
+                }
+            }
+
+            if ($participation->comments) {
+                $output .= html_writer::tag('h2', get_string('commentsby', 'oublog', $fullname));
+                $output .= html_writer::start_tag('div',
+                        array('id' => 'oublogcomments', 'class' => 'oublog-post-comments oublogpartcomments'));
+                foreach ($participation->comments as $comment) {
+                    $output .= html_writer::start_tag('div', array('class' => 'oublog-comment'));
+
+                    $author = new stdClass();
+                    $author->id = $comment->authorid;
+                    $userfields = get_all_user_name_fields(false, '', 'poster');
+                    foreach ($userfields as $field => $retfield) {
+                        $author->$field = $comment->$retfield;
+                    }
+                    $authorurl = new moodle_url('/user/view.php', array('id' => $author->id));
+                    $authorlink = html_writer::link($authorurl, fullname($author, $viewfullnames));
+                    if (isset($comment->posttitle) && !empty($comment->posttitle)) {
+                        $viewposturl = new moodle_url('/mod/oublog/viewpost.php',
+                            array('post' => $comment->postid));
+                        $viewpostlink = html_writer::link($viewposturl, s($comment->posttitle));
+                        $strparams = array('title' => $viewpostlink, 'author' => $authorlink,
+                                'date' => oublog_date($comment->postdate));
+                        $output .= html_writer::tag('h3', get_string('commentonby', 'oublog',
+                                $strparams));
+                    } else {
+                        $viewposturl = new moodle_url('/mod/oublog/viewpost.php',
+                            array('post' => $comment->postid));
+                        $viewpostlink = html_writer::link($viewposturl,
+                            oublog_date($comment->postdate));
+                        $strparams = array('title' => $viewpostlink, 'author' => $authorlink, 'date' => '');
+                        $output .= html_writer::tag('h3', get_string('commentonby', 'oublog',
+                            $strparams));
+                    }
+
+                    // Comment title.
+                    if (isset($comment->title) && !empty($comment->title)) {
+                        $output .= html_writer::tag('h3', s($comment->title),
+                            array('class' => 'oublog-comment-title'));
+                    }
+
+                    // Comment content and date.
+                    $output .= html_writer::start_tag('div',
+                        array('class' => 'oublog-comment-date'));
+                    $output .= oublog_date($comment->timeposted);
+                    $output .= html_writer::end_tag('div');
+                    $output .= html_writer::start_tag('div',
+                        array('class' => 'oublog-comment-content'));
+                    $comment->message = file_rewrite_pluginfile_urls($comment->message,
+                            'pluginfile.php', $modcontext->id, 'mod_oublog',
+                            'messagecomment', $comment->id);
+                    $output .= format_text($comment->message, FORMAT_HTML);
+                    $output .= html_writer::end_tag('div');
+
+                    // End display box.
+                    $output .= html_writer::end_tag('div');
+                }
+                $output .= html_writer::end_tag('div');
+            }
+            if (!empty($participation->posts) || !empty($participation->comments)) {
+                // Only printing the download buttons.
+                echo $table->download_buttons();
+            }
+
+            // Print the actual output.
+            echo $output;
+
+            // Grade.
+            if (isset($participation->gradeobj)) {
+                $this->render_user_grade($course, $cm, $oublog, $participation, $groupid);
+            }
+        } else {
+            // Posts.
+            if ($participation->posts) {
+                $table->add_data($table->posts);
+                $table->add_data($table->postsheader);
+                foreach ($participation->posts as $post) {
+                    $row = array();
+                    $row[] = userdate($post->timeposted, get_string('strftimedate'));
+                    $row[] = userdate($post->timeposted, get_string('strftimetime'));
+                    $row[] = (isset($post->title) && !empty($post->title)) ? $post->title : '';
+                    $post->message = file_rewrite_pluginfile_urls($post->message,
+                        'pluginfile.php', $modcontext->id, 'mod_oublog',
+                        'message', $post->id);
+                    $row[] = format_text($post->message, FORMAT_HTML);
+                    $fs = get_file_storage();
+                    if ($files = $fs->get_area_files($modcontext->id, 'mod_oublog', 'attachment',
+                            $post->id, 'timemodified', false)) {
+                        $attachmentstring = '';
+                        foreach ($files as $file) {
+                            $filename = $file->get_filename();
+                            $attachmentstring .= ' ' . $filename . ', ';
+                        }
+                        $attachmentstring = substr($attachmentstring, 0, -2);
+                        $row[] = $attachmentstring;
+                    } else {
+                        $row[] = '';
+                    }
+                    $table->add_data($row);
+                }
+            }
+
+            // Comments.
+            if ($participation->comments) {
+                $table->add_data($table->comments);
+                $table->add_data($table->commentsheader);
+                foreach ($participation->comments as $comment) {
+                    $author = new stdClass();
+                    $author->id = $comment->authorid;
+                    $userfields = get_all_user_name_fields();
+                    foreach ($userfields as $field) {
+                        $author->$field = $comment->$field;
+                    }
+                    $authorfullname = fullname($author, $viewfullnames);
+
+                    $row = array();
+                    $row[] = userdate($comment->timeposted, get_string('strftimedate'));
+                    $row[] = userdate($comment->timeposted, get_string('strftimetime'));
+                    $row[] = (isset($comment->title)) ? $comment->title : '';
+                    $comment->message = file_rewrite_pluginfile_urls($comment->message,
+                            'pluginfile.php', $modcontext->id, 'mod_oublog',
+                            'messagecomment', $comment->id);
+                    $row[] = format_text($comment->message, FORMAT_HTML);
+                    $row[] = $authorfullname;
+                    $row[] = userdate($comment->postdate, get_string('strftimedate'));
+                    $row[] = userdate($comment->postdate, get_string('strftimetime'));
+                    $row[] = (isset($comment->posttitle)) ? $comment->posttitle : '';
+                    $table->add_data($row);
+                }
+            }
+            if (!$participation->posts && !$participation->comments) {
+                $table->add_data(array(''));
+            }
+            $table->finish_output();
+        }
+
+    }
+
+    /**
+     * Render single users grading form
+     *
+     * @param object $course current course object
+     * @param object $cm current course module object
+     * @param object $oublog current oublog object
+     * @param object $user current user participation object
+     * @param id $groupid optional group id, no group = 0
+     */
+    public function render_user_grade($course, $cm, $oublog, $user, $groupid) {
+        global $CFG, $USER;
+
+        if (is_null($user->gradeobj->grade)) {
+            $user->gradeobj->grade = -1;
+        }
+        if ($user->gradeobj->grade != -1) {
+            $user->grade = abs($user->gradeobj->grade);
+        }
+        $grademenu = make_grades_menu($oublog->grade);
+        $grademenu[-1] = get_string('nograde');
+
+        $formparams = array();
+        $formparams['id'] = $cm->id;
+        $formparams['user'] = $user->user->id;
+        $formparams['group'] = $groupid;
+        $formparams['sesskey'] = $USER->sesskey;
+        $formaction = new moodle_url('/mod/oublog/savegrades.php', $formparams);
+        $mform = new MoodleQuickForm('savegrade', 'post', $formaction,
+            '', array('class' => 'savegrade'));
+        $mform->addElement('header', 'usergrade', get_string('usergrade', 'oublog'));
+        $mform->addElement('select', 'grade', get_string('grade'), $grademenu);
+        $mform->setDefault('grade', $user->gradeobj->grade);
+        $mform->addElement('submit', 'savechanges', get_string('savechanges'));
+
+        $mform->display();
+    }
+
+    /**
+     * Print comments which relate to a single blog post
+     *
+     * @param object $post Structure containing all post info and comments
+     * @param object $oublog Blog object
+     * @param bool $canmanagecomments Has capability toggle
+     * @param bool $canaudit Has capability toggle
+     * @param bool $forexport Export output rendering toggle
+     * @param object $cm Current course module object
+     * @param string $format
+     * @param boolean $contenttitle True to position title with content
+     * @return html
+     */
+    public function render_comments($post, $oublog, $canaudit, $canmanagecomments, $forexport,
+            $cm, $format = false, $contenttitle = false) {
+        global $DB, $CFG, $USER, $OUTPUT;
+        $viewfullnames = true;
+        $strdelete      = get_string('delete', 'oublog');
+        $strcomments    = get_string('comments', 'oublog');
+        $output = '';
+        $modcontext = context_module::instance($cm->id);
+        if (!$canmanagecomments) {
+            $context = context_module::instance($cm->id);
+            $canmanagecomments = has_capability('mod/oublog:managecomments', $context);
+        }
+
+        // IE needs tabindex="-1" or focus ends up in the wrong place when you
+        // follow a link like .../mod/oublog/viewpost.php?post=123#oublogcomments.
+        $output .= html_writer::start_tag('div', array('class' => 'oublog-post-comments',
+                'id' => 'oublogcomments', 'tabindex' => '-1'));
+        $counter = 0;
+        foreach ($post->comments as $comment) {
+            $extraclasses = $comment->deletedby ? ' oublog-deleted' : '';
+            $extraclasses .= ' oublog-hasuserpic';
+            $title = '';
+            if (trim(format_string($comment->title)) !== '') {
+                $title = html_writer::tag('h3', format_string($comment->title),
+                        array('class' => 'oublog-title'));
+            } else if (!$forexport) {
+                $commenttitle = get_accesshide(get_string('newcomment', 'mod_oublog'));
+                $title = html_writer::tag('h3', $commenttitle, array('class' => 'oublog-title'));
+            }
+
+            $output .= html_writer::start_tag('div', array(
+                    'class' => 'oublog-comment' . $extraclasses, 'id' => 'cid' . $comment->id));
+            if ($counter == 0) {
+                $output .= html_writer::tag('h2', format_string($strcomments),
+                        array('class' => 'oublog-commentstitle'));
+            }
+            if ($comment->deletedby) {
+                $deluser = new stdClass();
+                $fields = get_all_user_name_fields(false, null, 'del');
+                foreach ($fields as $field => $dfield) {
+                    $deluser->$field = $comment->$dfield;
+                }
+
+                $a = new stdClass();
+                $a->fullname = '<a href="../../user/view.php?id=' . $comment->deletedby . '">' .
+                        fullname($deluser) . '</a>';
+                $a->timedeleted = oublog_date($comment->timedeleted);
+
+                $output .= html_writer::tag('div', get_string('deletedby', 'oublog', $a),
+                        array('class' => 'oublog-comment-deletedby'));
+            }
+            $output .= html_writer::start_div('oublog-comment-details');
+            if ($comment->userid && !$forexport) {
+                $output .= html_writer::start_tag('div', array('class' => 'oublog-userpic'));
+                $commentuser = new stdClass();
+                $fields = explode(',', user_picture::fields());
+                foreach ($fields as $field) {
+                    if ($field != 'id') {
+                        $commentuser->$field = $comment->$field;
+                    }
+                }
+                $commentuser->id = $comment->userid;
+
+                $output .= $OUTPUT->user_picture($commentuser,
+                        array('courseid' => $oublog->course, 'size' => 70));
+                $output .= html_writer::end_tag('div');
+            }
+            if (!$contenttitle) {
+                $output .= $title;
+            }
+            $output .= html_writer::start_tag('div', array('class' => 'oublog-post-date'));
+            $output .= oublog_date($comment->timeposted);
+            $output .= html_writer::start_tag('div', array('class' => 'oublog-postedby'));
+            if ($comment->userid ) {
+                if (!$forexport) {
+                    $output .= get_string('postedby', 'oublog',
+                            '<a href="../../user/view.php?id=' . $comment->userid .
+                            '&amp;course=' . $oublog->course . '">' .
+                            fullname($comment) . '</a>');
+                } else {
+                    $output .= get_string('postedby', 'oublog', fullname($comment) );
+                }
+            } else {
+                $output .= get_string(
+                        $canaudit ? 'postedbymoderatedaudit' : 'postedbymoderated',
+                        'oublog', (object)array(
+                                'commenter' => s($comment->authorname),
+                                'approver' => '<a href="../../user/view.php?id=' .
+                                $comment->userid . '&amp;course=' . $oublog->course .
+                                '">' . fullname($post) . '</a>',
+                                'approvedate' => oublog_date($comment->timeapproved),
+                                'ip' => s($comment->authorip)));
+            }
+            $output .= html_writer::end_tag('div');
+            $output .= html_writer::end_tag('div');
+            $output .= html_writer::end_div();
+            $output .= html_writer::start_tag('div',
+                    array('class' => 'oublog-comment-content'));
+            if ($contenttitle) {
+                $output .= $title;
+            }
+            if (!$forexport) {
+                if ($post->visibility == OUBLOG_VISIBILITY_PUBLIC) {
+                    $fileurlbase = 'mod/oublog/pluginfile.php';
+                } else {
+                    $fileurlbase = 'pluginfile.php';
+                }
+                $comment->message = file_rewrite_pluginfile_urls($comment->message,
+                        $fileurlbase, $modcontext->id, 'mod_oublog', 'messagecomment',
+                        $comment->id);
+            } else {
+                $comment->message = portfolio_rewrite_pluginfile_urls($comment->message,
+                        $modcontext->id, 'mod_oublog', 'messagecomment', $comment->id, $format);
+            }
+            $output .= format_text($comment->message, FORMAT_HTML);
+            $output .= html_writer::end_tag('div');
+            $output .= html_writer::start_tag('div',
+                    array('class' => 'oublog-post-links'));
+            if (!$comment->deletedby) {
+                // You can delete your own comments, or comments on your own
+                // personal blog, or if you can manage comments.
+                if (($comment->userid && $comment->userid == $USER->id) ||
+                        ($oublog->global && $post->userid == $USER->id) ||
+                        $canmanagecomments ) {
+                    if (!$forexport) {
+                        $output .= '<a href="deletecomment.php?comment=' .
+                                $comment->id . '">' . $strdelete.'</a>';
+                    } else {
+                        $output .= $strdelete;
+                    }
+                }
+            }
+            // Show OU Alerts reporting link.
+            if (isloggedin() && oublog_oualerts_enabled()
+                    && oublog_get_reportingemail($oublog) && !($comment->userid == $USER->id)
+                    && !$comment->deletedby) {
+                $itmurl = new moodle_url('/mod/oublog/viewpost.php',
+                         array('post' => $post->id));
+                $itemurl = $itmurl->out() . '#cid' . $comment->id;
+                $retnurl = new moodle_url('/mod/oublog/viewpost.php',
+                         array('post' => $post->id));
+                $returnurl = $retnurl->out() . '#cid' . $comment->id;
+                $reportlink = oualerts_generate_alert_form_url('oublog', $modcontext->id,
+                        'comment', $comment->id, $itemurl, $returnurl, '', false, true);
+                if ($reportlink != '') {
+                    $output .= html_writer::tag('a', get_string('commentalert', 'oublog'),
+                            array('href' => $reportlink));
+                }
+            }
+
+            $output .= html_writer::end_tag('div');
+            $output .= html_writer::end_tag('div');
+            $counter++;
+        }
+
+        $output .= html_writer::end_tag('div');
+        return $output;
+    }
+
+    /**
+     * Override this within theme to add content before posts in view.php
+     */
+    public function render_viewpage_prepost() {
+        return;
+    }
+
+    /**
+     * Output Blog intro if introonpost is set for this blog.
+     *
+     * @param object $oublog
+     * @param object $cm
+     */
+    public function render_pre_postform($oublog, $cm) {
+        if (empty($oublog->introonpost)) {
+            return '';
+        }
+        $context = context_module::instance($cm->id);
+        $content = file_rewrite_pluginfile_urls($oublog->intro, 'pluginfile.php',
+                $context->id, 'mod_oublog', 'intro', null);
+        $content = format_text($content, $oublog->introformat);
+        return html_writer::div($content, 'oublog_editpost_intro');
+    }
+
+    /**
+     * Print all user participation records for display
+     *
+     * @param object $cm current course module object
+     * @param object $course current course object
+     * @param object $oublog current oublog object
+     * @param int $page html_table pagination page
+     * @param array $participation mixed array of user participation values
+     */
+    public function render_all_users_participation_table($cm, $course, $oublog,
+            $page, $limitnum, $participation,
+            $getposts, $getcomments, $start, $end, $pagingurl) {
+        global $DB, $CFG, $OUTPUT, $USER;
+        require_once($CFG->dirroot.'/mod/oublog/participation_table.php');
+        $groupmode = oublog_get_activity_groupmode($cm, $course);
+        $thepagingbar = "";
+        if (!empty($participation->posts) && $participation->postscount > $limitnum) {
+            $thepagingbar = $OUTPUT->paging_bar($participation->postscount, $page, $limitnum, $pagingurl);
+        } else if (!empty($participation->comments) && $participation->commentscount > $limitnum) {
+            $thepagingbar = $OUTPUT->paging_bar($participation->commentscount, $page, $limitnum, $pagingurl);
+        }
+        if ($getposts) {
+            $output = '';
+            $output .= html_writer::tag('h2', $participation->postscount .' '. get_string('posts', 'oublog'));
+            // Provide paging if postscount exceeds posts perpage.
+            $output .= $thepagingbar;
+            $poststable = new html_table();
+            $poststable->head = array(
+                    get_string('user'),
+                    get_string('title', 'oublog'),
+                    get_string('date'),
+                    oublog_get_displayname($oublog, true)
+            );
+            $poststable->size = array('25%', '25%', '25%', '25%');
+            $poststable->colclasses = array('oublog_usersinfo_col', '', '', '');
+            $poststable->attributes['class'] = 'oublog generaltable ';
+            $poststable->data = array();
+            foreach ($participation->posts as $post) {
+                // Post user object required for user_picture.
+                $postuser = new stdClass();
+                $postuser->id = $post->userid;
+                $fields = explode(',', user_picture::fields('', null, '', 'poster'));
+                foreach ($fields as $field) {
+                    if ($field != 'id') {
+                        $postuser->$field = $post->$field;
+                    }
+                }
+                $fullname = fullname($postuser);
+
+                $row = array();
+                $row[] = $OUTPUT->user_picture($postuser,
+                        array('class' => 'userpicture')) . $fullname;
+                $url = new moodle_url('/mod/oublog/viewpost.php', array('post' => $post->id));
+                $postname = !(empty($post->title)) ? $post->title : get_string('untitledpost', 'oublog');
+                $row[] = html_writer::div(html_writer::link($url, $postname), '');
+                $row[] = html_writer::div(oublog_date($post->timeposted));
+                $bparams = array('id' => $cm->id);
+                $linktext = $name = $grpname = $dispname = '';
+                if (oublog_get_displayname($oublog)) {
+                    $dispname = oublog_get_displayname($oublog);
+                }
+                if ($post->blogname != "") {
+                    $linktext = $post->blogname;
+                } else if ($oublog->name != "") {
+                    if ($groupmode > NOGROUPS && isset($post->groupid) && $post->groupid > 0) {
+                        $bparams['group'] = $post->groupid;
+                        $grpname = groups_get_group_name($post->groupid);
+                    } else if ($oublog->individual != OUBLOG_NO_INDIVIDUAL_BLOGS) {
+                        $bparams['individual'] = $post->userid;
+                        $name = fullname($postuser);
+                    }
+                    if ($post->groupid == 0 && $oublog->individual > OUBLOG_NO_INDIVIDUAL_BLOGS) {
+                        $name = fullname($postuser);
+                    } else if (!$groupmode) {
+                        $name = $oublog->name;
+                    }
+                    $a = (object) array('name' => $grpname . " " . $name, 'displayname' => $dispname);
+                    $linktext = get_string('defaultpersonalblogname', 'oublog', $a);
+                }
+                if (!$groupmode && !$oublog->global && $oublog->individual == 0) {
+                    $a = (object) array('name' => $grpname . " " . $name, 'displayname' => $dispname);
+                    $linktext = get_string('defaultpersonalblogname', 'oublog', $a);
+                }
+                if (!$groupmode) {
+                    $linktext = $name;
+                }
+                $burl = new moodle_url('/mod/oublog/view.php', $bparams);
+                $row[] = html_writer::link($burl, $linktext);
+                $poststable->data[] = $row;
+            }
+            $output .= html_writer::table($poststable);
+            $output .= $thepagingbar;
+            return $output;
+        }
+        if ($getcomments) {
+            $output = '';
+            // Do the comments stuff here.
+            if (!$participation->comments) {
+                $output .= html_writer::tag('h2', get_string('nousercomments', 'oublog'));
+            } else {
+                $output .= html_writer::tag('h2', $participation->commentscount .' '. get_string('comments', 'oublog'));
+                // Provide paging if commentscount exceeds posts perpage.
+                $output .= $thepagingbar;
+                $commenttable = new html_table();
+                $commenttable->head = array(
+                        get_string('user'),
+                        get_string('title', 'oublog'),
+                        get_string('date'),
+                        get_string('post')
+                );
+                $commenttable->size = array('25%', '25%', '25%', '25%');
+                $commenttable->colclasses = array('oublog_usersinfo_col ', '', '', 'oublog_postsinfo_col');
+                $commenttable->attributes['class'] = 'oublog generaltable ';
+                $commenttable->data = array();
+                unset($bparams);
+                foreach ($participation->comments as $comment) {
+                    $row = array();
+                    // Comment author object required for user_picture.
+                    $commentauthor = new stdClass();
+                    $commentauthor->id = $comment->commenterid;
+                    $fields = explode(',', user_picture::fields('', null, '', 'commenter'));
+                    foreach ($fields as $field) {
+                        if ($field != 'id') {
+                            $cfield = "commenter" . $field;
+                            $commentauthor->$field = $comment->$cfield;
+                        }
+                    }
+                    $viewposturl = new moodle_url('/mod/oublog/viewpost.php', array('post' => $comment->postid));
+                    $viewpostcommenturl = $viewposturl->out() . '#cid' . $comment->id;
+                    $commenttitle = !(empty($comment->title)) ? $comment->title : get_string('untitledcomment', 'oublog');
+                    $posttitle = !(empty($comment->posttitle)) ? $comment->posttitle : get_string('untitledpost', 'oublog');
+                    $viewcommentlink = html_writer::link($viewpostcommenturl, s($commenttitle));
+                    // User cell.
+                    $usercell = $OUTPUT->user_picture($commentauthor, array('class' => 'userpicture'));
+                    $usercell .= html_writer::start_tag('div', array('class' => ''));
+                    $usercell .= fullname($commentauthor);
+                    $usercell .= html_writer::end_tag('div');
+                    $row[] = $usercell;
+                    // Comments cell.
+                    $row[] = $viewcommentlink;
+                    // Comment date cell.
+                    $row[] = userdate($comment->timeposted);
+                    // Start of cell 4 code should resemble view page block code.
+                    $postauthor = new stdClass();
+                    $postauthor->id = $comment->posterid;
+                    $postauthor->groupid = $comment->groupid;
+                    $fields = explode(',', user_picture::fields('', null, '', 'poster'));
+                    foreach ($fields as $field) {
+                        if ($field != 'id') {
+                            $pfield = "poster" . $field;
+                            $postauthor->$field = $comment->$pfield;
+                        }
+                    }
+                    $bparams = array('id' => $cm->id);
+                    $linktext = $name = $grpname = $dispname = '';
+                    if (oublog_get_displayname($oublog)) {
+                        $dispname = oublog_get_displayname($oublog);
+                    }
+                    if ($comment->bloginstancename != '') {
+                        $bparams['individual'] = $comment->posterid;
+                        $bparams['group'] = $comment->groupid;
+                        $name = fullname($postauthor);
+                    } else if ($oublog->name != "") {
+                        if ($groupmode > NOGROUPS && isset($comment->groupid) &&  $comment->groupid > 0) {
+                            $bparams['group'] = $comment->groupid;
+                            $grpname = groups_get_group_name($comment->groupid);
+                        } else if ($oublog->individual != OUBLOG_NO_INDIVIDUAL_BLOGS) {
+                            $bparams['individual'] = $comment->posterid;
+                            $name = fullname($postauthor);
+                        }
+                        if ($comment->groupid == 0 && $oublog->individual > OUBLOG_NO_INDIVIDUAL_BLOGS) {
+                            $name = fullname($postauthor);
+                        } else if (!$groupmode) {
+                            $name = $oublog->name;
+                        }
+                        $a = (object) array('name' => $grpname . $name, 'displayname' => $dispname);
+                        $linktext = get_string('defaultpersonalblogname', 'oublog', $a);
+                    }
+                    if (!$groupmode && !$oublog->global && $oublog->individual == 0) {
+                        // Personal or course wide.
+                        $a = (object) array('name' => $grpname . $name, 'displayname' => $dispname);
+                        $linktext = get_string('defaultpersonalblogname', 'oublog', $a);
+                    }
+                    if (!$groupmode) {
+                        $linktext = $name;
+                    }
+                    $postauthorurl = new moodle_url('/mod/oublog/view.php', $bparams);
+                    $postauthorlink = html_writer::link($postauthorurl, $linktext);
+                    $viewpostlink = html_writer::link($viewposturl, s($posttitle));
+                    // Posts cell.
+                    $postscell = html_writer::start_tag('div', array('class' => 'oublog_postsinfo'));
+                    $postscell .= $OUTPUT->user_picture($postauthor,
+                            array('courseid' => $oublog->course, 'class' => 'userpicture'));
+                    $postscell .= html_writer::start_tag('div', array('class' => 'oublog_postscell'));
+                    $postscell .= html_writer::start_tag('div', array('class' => 'oublog_postsinfo_label'));
+                    $postscell .= html_writer::start_tag('div', array('class' => 'oublog_postscell_posttitle'));
+                    $postscell .= html_writer::link($postauthorlink, $viewpostlink );
+                    $postscell .= html_writer::end_tag('div');
+                    $postscell .= html_writer::start_tag('div', array('class' => 'oublogstats_commentposts_blogname'));
+                    $postscell .= html_writer::empty_tag('br', array());
+                    $postscell .= oublog_date($comment->postdate);
+                    $postscell .= html_writer::empty_tag('br', array());
+                    $postscell .= $postauthorlink;
+                    $postscell .= html_writer::end_tag('div');
+                    $postscell .= html_writer::end_tag('div');
+                    $postscell .= html_writer::end_tag('div');
+                    $postscell .= html_writer::end_tag('div');
+                    $postscell .= html_writer::end_tag('div');
+                    $row[] = $postscell;
+                    $commenttable->data[] = $row;
+                }
+                $output .= html_writer::table($commenttable);
+                $output .= $thepagingbar;
+                return $output;
+            }
+        }
+    }
+
+    // Blog stats renderers.
+
+    /**
+     * Output an unordered list - for accordion
+     * @param string $name
+     * @param array $tabs
+     * @param int $default Default tab to open
+     */
+    public function render_stats_container($name, $tabs, $default = 1) {
+        global $PAGE;
+        $out = html_writer::start_tag('ul', array('class' => "oublog-accordion oublog-accordion-$name"));
+        foreach ($tabs as $tab) {
+            if (!empty($tab)) {
+                $out .= html_writer::tag('li', $tab);
+            }
+        }
+        $out .= html_writer::end_tag('ul');
+
+        $default = get_user_preferences("oublog_accordion_{$name}_open", $default);
+        user_preference_allow_ajax_update("oublog_accordion_{$name}_open", PARAM_INT);
+        $this->include_accordion_js($name, $default);
+
+        return $out;
+    }
+
+    /**
+     * Include the js file
+     * @param string $name
+     * @param int $default Default tab to open
+     */
+    public function include_accordion_js($name, $default = 1) {
+        global $PAGE;
+        $PAGE->requires->yui_module('moodle-mod_oublog-accordion', 'M.mod_oublog.accordion.init',
+                array($name, $default));
+    }
+
+    public function render_stats_view($name, $maintitle, $content, $subtitle = '', $info = '', $form = null, $ajax = false) {
+        global $PAGE, $OUTPUT;
+        if ($ajax) {
+            // Don't render - return the data.
+            $out = new stdClass();
+            $out->name = $name;
+            $out->maintitle = $maintitle;
+            $out->maintitleclass = 'oublog_statsview_title';
+            $out->subtitle = $subtitle;
+            $out->subtitleclass = 'oublog_statsview_subtitle';
+            $out->content = $content;
+            $out->info = $info;
+            $out->infoclass = "oublog_{$name}_info";
+            $out->containerclass = "oublog_statsview_content_$name";
+            $out->contentclass = "oublog_statsview_innercontent_$name";
+            return $out;
+        }
+        $out = '';
+        if (!empty($subtitle)) {
+            $out .= $OUTPUT->heading($subtitle, 3, 'oublog_statsview_subtitle');
+        }
+        if (!empty($info)) {
+            $out .= html_writer::start_tag('a', array('class' => 'block_action_oublog', 'tabindex' => 0, 'href' => '#'));
+
+            $minushide = '';
+            $plushide = ' oublog_displaynone';
+            if ($userpref = get_user_preferences("mod_oublog_hidestatsform_$name", false)) {
+                $minushide = ' oublog_displaynone';
+                $plushide = '';
+            }
+            // Setup Javascript for stats view.
+            user_preference_allow_ajax_update("mod_oublog_hidestatsform_$name", PARAM_BOOL);
+            $PAGE->requires->js('/mod/oublog/module.js');
+            $module = array ('name' => 'mod_oublog');
+            $module['fullpath'] = '/mod/oublog/module.js';
+            $module['requires'] = array('node', 'node-event-delegate');
+            $module['strings'] = array();
+            $PAGE->requires->js_init_call('M.mod_oublog.init_showhide', array($name, $userpref), false, $module);
+
+            $out .= $this->output->pix_icon('t/switch_minus', get_string('timefilter_close', 'oublog'), 'moodle',
+                    array('class' => 'oublog_stats_minus' . $minushide));
+            $out .= $this->output->pix_icon('t/switch_plus', get_string('timefilter_open', 'oublog'), 'moodle',
+                    array('class' => 'oublog_stats_plus' . $plushide));
+            $out .= html_writer::end_tag('a');
+
+            // Stats bar - call once per 'view'.
+            $PAGE->requires->yui_module('moodle-mod_oublog-statsbar', 'M.mod_oublog.statsbar.init',
+                    array("oublog_statsview_content_$name"));
+            $out .= html_writer::tag('p', $info, array('class' => "oublog_{$name}_info"));
+        }
+        if (!empty($form)) {
+            $out .= $form->render();
+        }
+        $out .= html_writer::div($content, "oublog_statsview_innercontent oublog_statsview_innercontent_$name");
+        return html_writer::div($this->output->heading($maintitle, 2), 'oublog_statsview_title') .
+            $this->output->container($out, "oublog_statsview_content oublog_statsview_content_$name");
+    }
+
+    /**
+     * Renders the 'statsinfo' widget - info chart on a blog/post
+     * @param oublog_statsinfo $info
+     * @return string
+     */
+    public function render_oublog_statsinfo(oublog_statsinfo $info) {
+        global $COURSE, $OUTPUT;
+        $out = '';
+        // Get the avatar picture for user/group.
+        if (isset($info->user->courseid)) {
+            // Group not user.
+            if (!$userpic = print_group_picture($info->user, $info->user->courseid, true, true, true)) {
+                // No group pic set, use default user image.
+                $userpic = $OUTPUT->pix_icon('u/f2', '');
+            }
+        } else {
+            $userpic = $this->output->user_picture($info->user, array('courseid' => $COURSE->id, 'link' => true));
+        }
+        $avatar = html_writer::span($userpic, 'oublog_statsinfo_avatar');
+        $infodiv = html_writer::start_div('oublog_statsinfo_infocol');
+        if ($info->stat) {
+            $infodiv .= html_writer::start_div('oublog_statsinfo_bar');
+            $infodiv .= html_writer::tag('span', $info->stat, array('class' => 'percent_' . $info->percent));
+            $infodiv .= html_writer::end_div();
+        }
+        $infodiv .= html_writer::div($info->label, 'oublog_statsinfo_label');
+        $infodiv .= html_writer::end_div();
+        $out = $avatar . $infodiv;
+        return $this->output->container($out, 'oublog_statsinfo');
+    }
+
+    public function render_oublog_print_delete_dialog($cmid, $postid) {
+        global $PAGE;
+        $PAGE->requires->js('/mod/oublog/module.js');
+        $stringlist[] = array('deleteemailpostdescription', 'oublog');
+        $stringlist[] = array('delete', 'oublog');
+        $stringlist[] = array('deleteandemail', 'oublog');
+        $stringlist[] = array('cancel', 'oublog');
+        $jsmodule = array(
+                'name' => 'mod_oublog.init_deleteandemail',
+                'fullpath' => '/mod/oublog/module.js',
+                'requires' => array('base', 'event', 'node', 'panel', 'anim', 'moodle-core-notification-dialogue', 'button'),
+                'strings' => $stringlist);
+        $PAGE->requires->js_init_call('M.mod_oublog.init_deleteandemail', array($cmid, $postid), true, $jsmodule);
+    }
+
+    /**
+     * Renders the ordering label, help and links in tags block
+     * @param string $selected
+     * @return html
+     */
+    public function render_tag_order($selected) {
+        global $PAGE, $OUTPUT;
+
+        $output = '';
+        $strorder = get_string('order', 'oublog');
+        $stralpha = get_string('alpha', 'oublog');
+        $struse = get_string('use', 'oublog');
+        $output .= html_writer::start_tag('div', array('class' => 'oublog-tag-order'));
+        $output .= $strorder . $OUTPUT->help_icon('order', 'oublog');
+        $output .= html_writer::start_tag('span', array('class' => 'oublog-tag-order-actions'));
+        if ($selected == 'use') {
+            $burl = new moodle_url($PAGE->url, array('tagorder' => 'alpha'));
+            $output .= "&nbsp;" . html_writer::link($burl, $stralpha) . " | " . $struse;
+        } else {
+            $burl = new moodle_url($PAGE->url, array('tagorder' => 'use'));
+            $output .= "&nbsp;" . $stralpha . " | " . html_writer::link($burl, $struse);
+        }
+        $output .= html_writer::end_tag('span');
+        $output .= html_writer::end_tag('div');
+        return $output;
+    }
+
+    /**
+     * Renders Twitter widget js code into the page.
+     */
+    public function render_twitter_js() {
+        global $PAGE;
+        static $loaded;
+        if ($loaded || $PAGE->devicetypeinuse == 'legacy') {
+            return;
+        } else {
+            $PAGE->requires->js_init_code("Y.Get.js('https://platform.twitter.com/widgets.js', {async:true})");
+            $loaded = true;
+        }
+    }
+
+    /**
+     * Renders Facebook widget js code into the page.
+     */
+    public function render_facebook_js() {
+        global $PAGE;
+        static $loaded;
+        if ($loaded || $PAGE->devicetypeinuse == 'legacy') {
+            return;
+        } else {
+            $facebookjs = <<<EOF
+<div id="fb-root"></div>
+EOF;
+            $PAGE->requires->js_init_code(
+                    "Y.Get.js('https://connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.5', {async:true})");
+            $loaded = true;
+            return $facebookjs;
+        }
+    }
+
+    /**
+     * Renders Google+ widget js code into the page.
+     */
+    public function render_googleplus_js() {
+        global $PAGE;
+        static $loaded;
+        if ($loaded || $PAGE->devicetypeinuse == 'legacy') {
+            return;
+        } else {
+            $PAGE->requires->js_init_code("Y.Get.js('https://apis.google.com/js/platform.js', {async:true})");
+            $loaded = true;
+            return;
+        }
+    }
+
+    /**
+     * Render socialmedia widgets into the 'summary block'.
+     */
+    public function render_summary($summary, $oubloguser) {
+        return $summary;
+    }
+
+    public function render_export_button_top($context, $oublog, $post, $oubloguserid,
+            $canaudit, $offset, $currentgroup, $currentindividual, $tagid, $cm, $courseid) {
+        return '';
+    }
+
+    public function render_export_button_bottom($context, $oublog, $post, $oubloguserid,
+            $canaudit, $offset, $currentgroup, $currentindividual, $tagid, $cm) {
+
+        global $CFG;
+
+        $output = '';
+
+        $output .= '<div id="addexportpostsbutton">';
+
+        $button = new portfolio_add_button();
+        $button->set_callback_options('oublog_all_portfolio_caller',
+                array('postid' => $post->id,
+                        'oublogid' => $oublog->id,
+                        'offset' => $offset,
+                        'currentgroup' => $currentgroup,
+                        'currentindividual' => $currentindividual,
+                        'oubloguserid' => $oubloguserid,
+                        'canaudit' => $canaudit,
+                        'tag' => $tagid,
+                        'cmid' => $cm->id), 'mod_oublog');
+        $output .= $button->to_html(PORTFOLIO_ADD_TEXT_LINK) . get_string('exportpostscomments', 'oublog');
+
+        $output .= '</div>';
+
+        return $output;
+    }
+
+    /**
+     * Return a button-like link which takes the user back to the main page.
+     *
+     * @param string $label, String.
+     * @param int $id, cmid or userid (if blog is global).
+     * @param bool $global, set to true when global blog.
+     * @return string
+     */
+    public function get_link_back_to_oublog($label, $id, $global = false) {
+        $idstring = 'id';
+        if ($global) {
+            $idstring = 'user';
+        }
+        $url = new moodle_url('/mod/oublog/view.php', array($idstring => $id));
+        return html_writer::tag('div', link_arrow_left($label, $url), array('id' => 'oublog-arrowback'));
+    }
+
+}
+
+class oublog_statsinfo implements renderable {
+    public $percent = 0;
+    public $url = '';
+    public $label = '';
+    public $user;
+    public $stat = '';
+
+    /**
+     *
+     * @param stdClass $user user/group for avatar picture
+     * @param int $percent Percent bar will go
+     * @param string $stat Stat text shown in bar
+     * @param moodle_url $url url for user pic link
+     * @param string $label Label that appears under bar
+     */
+    public function __construct(stdClass $user, $percent, $stat, moodle_url $url, $label) {
+        $this->percent = round($percent);
+        $this->label = $label;
+        $this->url = $url;
+        $this->user = $user;
+        $this->stat = $stat;
+    }
+}
diff --git a/mod/oublog/restrictcomments.php b/mod/oublog/restrictcomments.php
new file mode 100644
index 0000000..a462dad
--- /dev/null
+++ b/mod/oublog/restrictcomments.php
@@ -0,0 +1,148 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+// You can restrict comments (=change your posts so that they only permit
+// comments from signed-in users) on either a post or a blog. A confirmation
+// screen displays first.
+require_once('../../config.php');
+require_once('locallib.php');
+
+// Get post or blog details
+$postid = optional_param('post', 0, PARAM_INT);
+if ($postid) {
+    $isblog = false;
+    if (!$oublog = oublog_get_blog_from_postid($postid)) {
+        print_error('invalidrequest');
+    }
+} else {
+    $blogid = required_param('blog', PARAM_INT);
+    $isblog = true;
+    if (!$oublog = $DB->get_record('oublog', array('id'=>$blogid))) {
+        print_error('invalidrequest');
+    }
+}
+
+// Get other details and check access
+if (!$cm = get_coursemodule_from_instance('oublog', $oublog->id)) {
+    print_error('invalidcoursemodule');
+}
+if (!$course = $DB->get_record("course", array("id"=>$cm->course))) {
+    print_error('coursemisconf');
+}
+
+// Require login and access to blog
+require_login($course, $cm);
+$context = context_module::instance($cm->id);
+oublog_check_view_permissions($oublog, $context, $cm);
+
+// You must be able to post to blog (if blog = site blog, then your one)
+if (!oublog_can_post($oublog, $USER->id, $cm)) {
+    print_error('accessdenied', 'oublog');
+}
+
+// If there was a specified post, it must be yours
+if (!$isblog) {
+    $userid = $DB->get_field_sql("
+SELECT
+    bi.userid
+FROM
+    {oublog_posts} bp
+    INNER JOIN {oublog_instances} bi ON bi.id=bp.oubloginstancesid
+WHERE
+    bp.id = ?", array($postid));
+    if ($userid !== $USER->id) {
+        print_error('accessdenied', 'oublog');
+    }
+}
+
+// Is this the actual change or just the confirm?
+if ($_SERVER['REQUEST_METHOD'] == 'POST') {
+    require_sesskey();
+
+    // Apply actual change
+    $rparam = array();
+    if ($isblog) {
+        $restriction = 'b.id = ? ';
+        $rparam[] = $blogid;
+    } else {
+        $restriction = 'bp.id = ? ';
+        $rparam[] = $postid;
+    }
+    if (!$DB->execute("
+UPDATE {oublog_posts} SET allowcomments = " . OUBLOG_COMMENTS_ALLOW ."
+WHERE id IN (
+SELECT bp.id FROM
+    {oublog_posts} bp
+    INNER JOIN {oublog_instances} bi ON bi.id = bp.oubloginstancesid
+    INNER JOIN {oublog} b ON b.id = bi.oublogid
+WHERE
+    bi.userid = ?
+    AND bp.allowcomments >= " . OUBLOG_COMMENTS_ALLOWPUBLIC . "
+    AND $restriction)", array_merge(array($USER->id), $rparam))) {
+        print_error('error_unspecified', 'oublog', 'RC3');
+    }
+
+    // Redirect
+    if ($isblog) {
+        if ($oublog->global) {
+            redirect('view.php?user=' . $USER->id);
+        } else {
+            redirect('view.php?id=' . $cm->id);
+        }
+    } else {
+        redirect('viewpost.php?post=' . $postid);
+    }
+}
+
+// This is the confirm screen. Do navigation first...
+$oubloginstance = $DB->get_record('oublog_instances', array('oublogid'=>$oublog->id, 'userid'=>$USER->id));
+oublog_build_navigation($oublog, $oubloginstance, $USER);
+if (!$isblog) {
+    $post = $DB->get_record('oublog_posts', array('id'=>$postid));
+    oublog_get_post_extranav($post);
+}
+
+$PAGE->navbar->add(get_string('moderated_restrictpage', 'oublog'));
+$PAGE->set_title(format_string($oublog->name));
+$PAGE->set_heading(format_string($course->fullname));
+echo $OUTPUT->header();
+
+
+if ($isblog) {
+    if ($oublog->global) {
+        $nourl = 'view.php';
+        $noparams = array('user' => $USER->id);
+    } else {
+        $nourl = 'view.php';
+        $noparams = array('id' => $cm->id);
+    }
+    $yesparams = array('blog' => $blogid);
+} else {
+    $nourl ='viewpost.php';
+    $noparams = array('post' => $postid);
+    $yesparams = array('post' => $postid);
+}
+$yesparams['sesskey'] = sesskey();
+
+// Display the query
+echo $OUTPUT->confirm(get_string('moderated_restrict' . ($isblog ? 'blog' : 'post') . '_info',
+            'oublog'),
+                     new moodle_url('/mod/oublog/restrictcomments.php', $yesparams),
+                     new moodle_url('mod/oublog/'.$nourl, $noparams));
+
+
+// Page footer
+echo $OUTPUT->footer();
diff --git a/mod/oublog/savegrades.php b/mod/oublog/savegrades.php
new file mode 100644
index 0000000..4d20204
--- /dev/null
+++ b/mod/oublog/savegrades.php
@@ -0,0 +1,76 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Page for saving grades for all or one user participation
+ *
+ * @package mod
+ * @subpackage oublog
+ * @copyright 2011 The Open University
+ * @author Stacey Walker <stacey@catalyst-eu.net>
+ * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+require_once(dirname(__FILE__) . '/../../config.php');
+require_once($CFG->dirroot.'/mod/oublog/locallib.php');
+
+$id         = required_param('id', PARAM_INT); // Course Module ID
+$groupid    = optional_param('group', 0, PARAM_INT);
+$userid     = optional_param('user', 0, PARAM_INT);
+
+$params = array();
+$params['id'] = $id;
+$params['group'] = $groupid;
+$url = new moodle_url('/mod/oublog/savegrades.php');
+if ($id) {
+    $cm = get_coursemodule_from_id('oublog', $id, 0, false, MUST_EXIST);
+    $course = $DB->get_record('course', array('id' => $cm->course), '*', MUST_EXIST);
+    $oublog = $DB->get_record('oublog', array('id' => $cm->instance), '*', MUST_EXIST);
+
+    $PAGE->set_cm($cm);
+}
+$context = context_module::instance($cm->id);
+require_course_login($course, true, $cm);
+require_sesskey();
+
+// participation capability check
+$canview = oublog_can_view_participation($course, $oublog, $cm, $groupid);
+if ($canview != OUBLOG_USER_PARTICIPATION) {
+    print_error('nopermissiontoshow');
+}
+
+// grading capability check
+if (!oublog_can_grade($course, $oublog, $cm, $groupid)) {
+    print_error('nopermissiontoshow');
+}
+
+$mode = '';
+if (!empty($_POST['menu'])) {
+    $gradeinfo = $_POST['menu'];
+    $oldgrades = oublog_get_participation($oublog, $context, $groupid, $cm, $course);
+} else if ($userid && !empty($_POST['grade'])) {
+    $gradeinfo[$userid] = $_POST['grade'];
+    $user = oublog_get_user_participation($oublog, $context, $userid, $groupid, $cm, $course);
+    $oldgrades = array($userid => $user);
+}
+
+// Update grades.
+if (!empty($gradeinfo)) {
+    oublog_update_manual_grades($gradeinfo, $oldgrades, $cm, $oublog, $course);
+}
+
+// redirect
+redirect('participation.php?id=' . $id . '&group=' . $groupid);
diff --git a/mod/oublog/search.php b/mod/oublog/search.php
new file mode 100644
index 0000000..ef36797
--- /dev/null
+++ b/mod/oublog/search.php
@@ -0,0 +1,212 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Search results page.
+ *
+ * @copyright &copy; 2007 The Open University
+ * @author s.marshall@open.ac.uk
+ * @license http://www.gnu.org/copyleft/gpl.html GNU Public License
+ * @package oublog
+ *//** */
+require_once('../../config.php');
+require_once('locallib.php');
+require_once($CFG->dirroot.'/local/ousearch/searchlib.php');
+
+$id     = optional_param('id', 0, PARAM_INT);       // Course Module ID
+$user   = optional_param('user', 0, PARAM_INT);     // User ID
+$querytext = required_param('query', PARAM_RAW);
+$querytexthtml = htmlspecialchars($querytext);
+
+if ($id) {
+    if (!$cm = get_coursemodule_from_id('oublog', $id)) {
+        print_error('invalidcoursemodule');
+    }
+
+    if (!$course = $DB->get_record("course", array("id"=>$cm->course))) {
+        print_error('coursemisconf');
+    }
+
+    if (!$oublog = $DB->get_record("oublog", array("id"=>$cm->instance))) {
+        print_error('invalidcoursemodule');
+    }
+    $oubloguser = (object) array('id' => null);
+    $oubloginstance = null;
+    $oubloginstanceid = null;
+
+} else if ($user) {
+    if (!$oubloguser = $DB->get_record('user', array('id'=>$user))) {
+        print_error('invaliduserid');
+    }
+    if (!list($oublog, $oubloginstance) = oublog_get_personal_blog($oubloguser->id)) {
+        print_error('invalidcoursemodule');
+    }
+    if (!$cm = get_coursemodule_from_instance('oublog', $oublog->id)) {
+        print_error('invalidcoursemodule');
+    }
+    if (!$course = $DB->get_record("course", array("id"=>$oublog->course))) {
+        print_error('coursemisconf');
+    }
+    $oubloginstanceid = $oubloginstance->id;
+} else {
+    print_error('missingrequiredfield');
+}
+
+$context = context_module::instance($cm->id);
+$PAGE->set_context($context);
+
+$url = new moodle_url('/mod/oublog/search.php', array('id'=>$id, 'user'=>$user, 'query'=>$querytext));
+$PAGE->set_url($url);
+$PAGE->set_cm($cm);
+$PAGE->set_title(format_string($oublog->name));
+oublog_check_view_permissions($oublog, $context, $cm);
+
+if ($oublog->global) {
+    // Check this user is allowed to view the user's blog
+    if ($oublog->maxvisibility != OUBLOG_VISIBILITY_PUBLIC && isset($oubloguser)) {
+        $usercontext = context_user::instance($oubloguser->id);
+        require_capability('mod/oublog:view', $usercontext);
+    }
+    $returnurl = $CFG->wwwroot . "/mod/oublog/search.php?user=$user&query=$querytext";
+    $mreturnurl = new moodle_url('/mod/oublog/view.php', array('user'=>$user));
+} else {
+    $returnurl = $CFG->wwwroot . "/mod/oublog/search.php?id=$id&query=$querytext";
+    $mreturnurl = new moodle_url('/mod/oublog/view.php', array('id'=>$id));
+}
+
+// Set up groups
+$currentgroup = oublog_get_activity_group($cm, true);
+$groupmode = oublog_get_activity_groupmode($cm, $course);
+// Note I am not sure this check is necessary, maybe it is handled by
+// oublog_get_activity_group? Or maybe more checks are needed? Not sure.
+if ($currentgroup===0 && $groupmode==SEPARATEGROUPS) {
+    require_capability('moodle/site:accessallgroups', $context);
+}
+
+if ($oublog->individual) {
+    // Individual selector.
+    $individualdetails = oublog_individual_get_activity_details($cm, $returnurl, $oublog,
+            $currentgroup, $context);
+}
+
+// Print the header
+$stroublog      = get_string('modulename', 'oublog');
+$strblogsearch = get_string('searchthisblog', 'oublog', oublog_get_displayname($oublog));
+$strblogssearch  = get_string('searchblogs', 'oublog');
+
+
+if ($oublog->global) {
+    if (!is_null($oubloginstance)) {
+        $name = $oubloginstance->name;
+        $buttontext = oublog_get_search_form('user', $oubloguser->id, $strblogsearch,
+                $querytexthtml);
+    } else {
+        $buttontext = oublog_get_search_form('id', $cm->id, $strblogssearch,
+                $querytexthtml);
+    }
+
+    if (isset($name)) {
+        $PAGE->navbar->add(fullname($oubloguser), new moodle_url('/user/view.php', array('id'=>$oubloguser->id)));
+        $PAGE->navbar->add(format_string($oubloginstance->name), $mreturnurl);
+    } else {
+        $PAGE->navbar->add(format_string($oublog->name), new moodle_url('/mod/oublog/allposts.php'));
+    }
+
+} else {
+    $name = $oublog->name;
+
+    $buttontext = oublog_get_search_form('id', $cm->id, $strblogsearch, $querytexthtml);
+}
+
+$PAGE->navbar->add(get_string('searchfor', 'local_ousearch', $querytext));
+$PAGE->set_button($buttontext);
+
+echo $OUTPUT->header();
+
+// Print Groups and individual drop-down menu.
+echo html_writer::start_div('oublog-groups-individual-selectors');
+
+// Print Groups
+groups_print_activity_menu($cm, $returnurl);
+
+if ($oublog->individual && $individualdetails) {
+    echo $individualdetails->display;
+}
+
+echo html_writer::end_div();
+
+global $modulecontext, $personalblog;
+$modulecontext=$context;
+$personalblog=$oublog->global ? true : false;
+
+// FINALLY do the actual query
+$query=new local_ousearch_search($querytext);
+$query->set_coursemodule($cm);
+if ($oublog->global && isset($oubloguser)) {
+    $query->set_user_id($oubloguser->id);
+} else if ($oublog->individual != OUBLOG_NO_INDIVIDUAL_BLOGS) {
+    if (!empty($individualdetails->activeindividual)) {
+        // Only get results for currently selected user.
+        $query->set_user_id($individualdetails->activeindividual, false);
+    } else if ($groupmode && $currentgroup) {
+        // All individual, get results for all users in current group.
+        $sepcontext = $oublog->individual == OUBLOG_SEPARATE_INDIVIDUAL_BLOGS ? $context : 0;
+        $usersingroup = oublog_individual_get_all_users($course->id, $oublog->id,
+                $currentgroup, $sepcontext);
+        if ($usersingroup) {
+            $query->set_user_ids(array_keys($usersingroup), false);
+        } else {
+            // Stop groups with no members returning all results.
+            $query->set_user_ids(local_ousearch_search::NONE, false);
+        }
+    }
+}
+
+if ($groupmode && $currentgroup && $oublog->individual == OUBLOG_NO_INDIVIDUAL_BLOGS) {
+    $query->set_group_id($currentgroup);
+}
+$query->set_filter('visibility_filter');
+
+$searchurl = 'search.php?'.(empty($id) ? 'user='.$oubloguser->id : 'id='.$cm->id);
+
+$foundsomething=$query->display_results($searchurl);
+
+echo $foundsomething;
+
+// Add link to search the rest of this website if service available.
+if (!empty($CFG->block_resources_search_baseurl)) {
+    $params = array('course' => $course->id, 'query' => $querytext);
+    $restofwebsiteurl = new moodle_url('/blocks/resources_search/search.php', $params);
+    $strrestofwebsite = get_string('restofwebsite', 'local_ousearch');
+    $altlink = html_writer::start_tag('div', array('class' => 'advanced-search-link'));
+    $altlink .= html_writer::link($restofwebsiteurl, $strrestofwebsite);
+    $altlink .= html_writer::end_tag('div');
+    print $altlink;
+}
+
+// Footer
+echo $OUTPUT->footer();
+
+/**
+ * Function filters search results to exclude ones that don't meet the
+ * visibility criterion.
+ *
+ * @param object $result Search result data
+ */
+function visibility_filter(&$result) {
+    global $USER, $modulecontext, $personalblog;
+    return oublog_can_view_post($result->data, $USER, $modulecontext, $personalblog);
+}
diff --git a/mod/oublog/settings.php b/mod/oublog/settings.php
new file mode 100644
index 0000000..426f774
--- /dev/null
+++ b/mod/oublog/settings.php
@@ -0,0 +1,56 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+// Dodgy hack to setup the global blog instance (section not created yet on install).
+if (!isset($CFG->oublogsetup)) {
+    if ($pbcm = get_coursemodule_from_instance('oublog', 1 , SITEID, 1)) {
+        $mod = new stdClass();
+        $mod->id= $pbcm->id;
+        $mod->section = course_add_cm_to_section($pbcm->course, $pbcm->id, 1);
+        $DB->update_record('course_modules', $mod);
+    }
+    set_config('oublogsetup', true);
+}
+
+$plugin = new stdClass();
+require($CFG->dirroot . '/mod/oublog/version.php');
+$settings->add(new admin_setting_heading('oublog_version', '',
+    get_string('displayversion', 'oublog', $plugin->release)));
+
+if (isset($CFG->maxbytes)) {
+    // Default maximum size for attachments allowed per post per oublog.
+    $settings->add(new admin_setting_configselect('mod_oublog/maxbytes',
+            get_string('maxattachmentsize', 'oublog'),
+            get_string('configmaxbytes', 'oublog'), 512000, get_max_upload_sizes($CFG->maxbytes)));
+}
+
+// Default number of attachments allowed per post in all oublogs.
+$settings->add(new admin_setting_configtext('mod_oublog/maxattachments',
+        get_string('maxattachments', 'oublog'),
+        get_string('configmaxattachments', 'oublog'), 9, PARAM_INT));
+
+$settings->add(new admin_setting_configcheckbox('oublogallpostslogin',
+        get_string('oublogallpostslogin', 'oublog'), get_string('oublogallpostslogin_desc', 'oublog'), 1));
+
+$settings->add(new admin_setting_configtext('mod_oublog/globalusageexclude',
+        get_string('globalusageexclude', 'oublog'), get_string('globalusageexclude_desc', 'oublog'), ''));
+
+$settings->add(new admin_setting_configtext('mod_oublog/remoteserver',
+        get_string('remoteserver', 'oublog'),
+        get_string('configremoteserver', 'oublog'), '', PARAM_URL));
+$settings->add(new admin_setting_configtext('mod_oublog/remotetoken',
+        get_string('remotetoken', 'oublog'),
+        get_string('configremotetoken', 'oublog'), '', PARAM_ALPHANUM));
diff --git a/mod/oublog/stats_update.php b/mod/oublog/stats_update.php
new file mode 100644
index 0000000..91b64f7
--- /dev/null
+++ b/mod/oublog/stats_update.php
@@ -0,0 +1,68 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Called via ajax when updating blog stats.
+ * cmid (id param) must be sent unless a personal blog page.
+ *
+ * @package    mod
+ * @subpackage oublog
+ * @copyright  2013 The open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+define('AJAX_SCRIPT', true);
+header('Content-Type: application/json');
+require_once(dirname(__FILE__) . '/../../config.php');
+require_once($CFG->dirroot . '/mod/oublog/locallib.php');
+
+require_sesskey();
+$type = required_param('type', PARAM_ALPHA);
+$id = optional_param('id', 0, PARAM_INT);
+
+if ($id) {
+    // Load efficiently (and with full $cm data) using get_fast_modinfo.
+    $course = $DB->get_record_select('course',
+            'id = (SELECT course FROM {course_modules} WHERE id = ?)', array($id),
+            '*', MUST_EXIST);
+
+    $modinfo = get_fast_modinfo($course);
+    $cm = $modinfo->get_cm($id);
+    if ($cm->modname !== 'oublog') {
+        print_error('invalidcoursemodule');
+    }
+
+    if (!$oublog = $DB->get_record('oublog', array('id' => $cm->instance))) {
+        print_error('invalidcoursemodule');
+    }
+} else {
+    // Global personal blog.
+    if (!$oublog = $DB->get_record('oublog', array('global' => 1))) {
+        print_error('personalblognotsetup', 'oublog');
+    }
+
+    if (!$cm = get_coursemodule_from_instance('oublog', $oublog->id)) {
+        print_error('invalidcoursemodule');
+    }
+}
+
+oublog_check_view_permissions($oublog, context_module::instance($cm->id), $cm);
+
+$func = "oublog_stats_output_$type";
+
+if (function_exists($func)) {
+    echo json_encode($func($oublog, $cm, null, true));
+}
diff --git a/mod/oublog/styles.css b/mod/oublog/styles.css
new file mode 100644
index 0000000..6d08052
--- /dev/null
+++ b/mod/oublog/styles.css
@@ -0,0 +1,732 @@
+#oublog-tags a {
+    text-decoration:none;
+}
+#oublog-tags a:hover .oublog-tagname{
+    text-decoration:underline;
+}
+.oublog-sideblock a:hover,
+#oublog-links a:hover,
+.oublog-post-links a:hover,
+.oublog-post-top a:hover,
+.oublog-post-bottom a:hover,
+.oublog-paging a:hover,
+.oublog-postedby a:hover {
+    text-decoration:underline;
+}
+
+#oublog-feeds a {
+    text-decoration:none;
+}
+#oublog-feeds a:hover .oublog-tagname{
+    text-decoration:underline;
+}
+
+.oublog-post-date a, .oublog-post-tags a, .oublog-post-links a, .oublog-post-editsummary a, .oublog-post-attachments a {
+    text-decoration: none;
+}
+
+.oublog-tagcount {
+    margin-left:2px;
+    font-size: 0.85em;
+}
+
+.oublog-tag-cloud-0 .oublog-tagname {
+    font-size: 0.85em;
+}
+
+.oublog-tag-cloud-1 .oublog-tagname {
+    font-size: 0.95em;
+}
+
+.oublog-tag-cloud-2 .oublog-tagname {
+    font-size: 1.1em;
+}
+
+.oublog-tag-cloud-3 .oublog-tagname {
+    font-size: 1.25em;
+}
+
+.oublog-tag-cloud-4 .oublog-tagname {
+    font-size: 1.4em;
+}
+
+#page-mod-oublog-view #middle-column .singlebutton {
+    margin-bottom:1em;
+}
+
+.oublog-post {
+    padding: 1em;
+    min-height:0; /* ie7 */
+}
+.oublog-post.oublog-odd, .oublog-post-commented {
+    background-color: #F2F2F2;
+    -moz-border-radius: 5px;
+    -webkit-border-radius: 5px;
+    border-radius: 5px;
+}
+.oublog-sideblock {
+    border: 1px solid #ddd;
+    margin: 0 0 1em;
+    padding: 0.5em;
+    background-color: #F2F2F2;
+    min-height:0; /* ie7 */
+}
+.ie6 .oublog-post *, .ie6 .oublog-comment *,
+.ie6 .oublog-post, .ie6 .oublog-comment {
+    height:0;
+}
+.ie6 .oublog-post img,
+.ie6 .oublog-comment img,
+.ie6 .oublog-post ul,
+.ie6 .oublog-comment ul,
+.ie6 .oublog-post ol,
+.ie6 .oublog-comment ol,
+.ie6 .oublog-post li,
+.ie6 .oublog-comment li {
+    height:auto;
+}
+.oublog-post .oublog-post-top {
+    margin-bottom: 1em;
+}
+.oublog-post .oublog-post-top-details {
+    margin-left: 80px;
+}
+
+.oublog-post-date, .oublog-post-visibility, .oublog-post-tags, .oublog-post-links, .oublog-post-editsummary, .oublog-links, .oublog-post-rating{
+    font-size: 0.85em;
+}
+
+.oublog-post-tags, .oublog-post-rating {
+    margin-bottom:0.7em;
+}
+
+.oublog-post-links a {
+    margin-right: 1em;
+}
+
+.oublog-postedby {
+    margin-top: 0.4em;
+    margin-bottom: 0.4em;
+}
+
+.oublog-post-visibility {
+    margin-bottom: 0.4em;
+    font-weight: bold;
+}
+
+.oublog-post h2.oublog-title {
+    margin: 0 0 0.5em 0;
+    font-size: 1.2em;
+}
+
+.oublog-post h3.oublog-title {
+    font-size: 1em;
+    margin: 0 0 0.5em 0;
+    padding-bottom: 4px;
+    border-bottom-width: 1px;
+    border-bottom-style: solid;
+    border-bottom-color: #aaaaaa;
+}
+
+.oublog-post .oublog-post-attachments {
+    float: right;
+    padding: 5px;
+    -moz-border-radius: 5px;
+    -webkit-border-radius: 5px;
+    border-radius: 5px;
+    background-color: #E7E7E7;
+    width: 200px;
+    margin-bottom: 0.4em;
+    font-size: 0.85em;
+}
+
+.oublog-post .oublog-social-container {
+    float: right;
+    width: 200px;
+}
+
+.oublog-post .oublog-post-socialshares {
+    float: right;
+    padding: 5px;
+    -moz-border-radius: 5px;
+    -webkit-border-radius: 5px;
+    border-radius: 5px;
+    background-color: #6E6E6E;
+    width: 201px;
+    font-size: 0.85em;
+    color: white;
+    margin-bottom: .5em;
+}
+
+.oublog-post .oublog-post-attachment {
+    display: inline;
+    word-break: break-all;
+    margin-right: .75em;
+}
+.oublog-post .oublog-post-share {
+    margin-top: .2em;
+    word-break: break-all;
+    margin-right: .75em;
+}
+
+.fb_iframe_widget {
+    z-index: 4;
+}
+
+.share-button {
+    display: inline;
+    padding-left: 5px;
+    vertical-align: top;
+    float: left;
+}
+
+.twitter-share-button {
+    /* JS disabled text link */
+    color: white;
+}
+
+.fb-share-button {
+    padding-left: 5px;
+    vertical-align: top;
+}
+.oublog-post-content,
+.oublog-comment-content {
+    margin:0.4em 0;
+    margin-bottom:1.2em;
+    min-height:0; /* ie7... */
+    clear: both;
+}
+.ie6 .oublog-post-content,
+.ie6 .oublog-comment-content {
+    height:auto !important;
+    width:99%; /* for some reason it actually believes 'height' on this element */
+}
+
+.oublog-deleted {
+    color: #aaa;
+}
+
+div.oublog-deleted div.oublog-userpic,
+div.oublog-deleted .oublog-post-attachments a,
+div.oublog-deleted .oublog-post-content {
+    opacity: 0.5;
+    filter: alpha(opacity=50);
+}
+
+.oublog-paging {
+    border-top: 1px solid #F2F2F2;
+    margin-top: .5em;
+    margin-bottom: 1em;
+}
+
+#oublog-single-post-view .oublog-post {
+    border: none;
+    background-color: transparent;
+    padding: 0;
+}
+#oublogcomments {
+    padding: 1em;
+}
+#oublogcomments:focus {
+    outline: 0;
+}
+#oublogcomments.oublogpartcomments {
+    background-color: #F2F2F2;
+}
+#oublogcomments .oublog-comment {
+    padding: 1em;
+    background-color: #FFFFFF;
+    -moz-border-radius: 5px;
+    -webkit-border-radius: 5px;
+    border-radius: 5px;
+    margin-bottom: .5em;
+}
+
+#oublogcomments .oublog-comment h2.oublog-commentstitle {
+    margin-top: 0;
+    padding-bottom: .5em;
+    border-bottom: 1px solid #F2F2F2;
+}
+
+.oublog-comment .oublog-userpic {
+    margin-right: 10px;
+    margin-bottom: 1em;
+}
+.oublog-comment h3.oublog-title {
+    margin: 0 0 0.5em 0;
+    font-weight: normal;
+}
+.oublog-comment h2.oublog-comment-title {
+    margin: 0 0 0.5em 0;
+    font-size:1em;
+    font-weight: normal;
+    padding-bottom: 4px;
+    border-bottom-width: 1px;
+    border-bottom-style: dotted;
+    border-bottom-color: #aaaaaa;
+}
+
+.oublog-comment h3.oublog-comment-title {
+    margin: 0 0 0.5em 0;
+    font-size: 1em;
+    padding-bottom: 4px;
+    border-bottom-width: 1px;
+    border-bottom-style: dotted;
+    border-bottom-color: #aaaaaa;
+}
+
+.oublog-comment h3, .oublog-comment h4 {
+    margin: 0em;
+}
+
+.oublog-comment-date, .oublog-comment-visibility, .oublog-comment-tags, .oublog-comment-links, .oublog-comment-editsummary {
+    font-size: 0.85em;
+}
+
+.oublog-views {
+    text-align: center;
+    font-size: 0.85em;
+}
+
+.feedicon {
+    vertical-align: middle;
+    margin-right: 4px;
+    margin-left: 120px;
+    border:0px;
+ }
+
+.oublog-post-deletedby, .oublog-comment-deletedby {
+    color:#8D0047;
+    font-weight: bold;
+}
+.oublog-comment-deletedby {
+    margin-bottom: 8px;
+}
+
+.oublog-topofpage {
+    clear:both;
+    padding-bottom:1em;
+}
+
+#page-mod-oublog-view #left-column,
+#page-mod-oublog-allposts #left-column {
+  width:12em;
+    float:left;
+}
+#page-mod-oublog-view #right-column,
+#page-mod-oublog-viewpost #right-column,
+#page-mod-oublog-viewedit #right-column,
+#page-mod-oublog-allposts #right-column {
+  width:12em;
+    float:right;
+}
+
+.oublog-userpic {
+    float: left;
+    width: 70px;
+    padding-top: .25em;
+}
+.oublog-userpic .userpicture {
+    width: 70px;
+    height: 70px;
+}
+
+#page-mod-oublog-view .groupselector {
+  float: none;
+  display:inline;
+  margin-right:1em;
+  margin-bottom:0.5em;
+}
+
+.oublog-individualselector {
+  font-size:0.85em;
+  display:inline;
+  margin-right:0.5em;
+  margin-bottom:0.5em;
+  white-space: nowrap;
+}
+div.oublog-individualselector {
+  font-size:0.85em;
+}
+.oublog-groups-individual-selectors {
+  margin-bottom:1.0em;
+  line-height: 1.6em;
+}
+#page-mod-oublog-search .oublog-individualselector {
+    display: block;
+}
+
+.oublog-post-content,.oublog-comment-content {
+  overflow:hidden;
+}
+
+.oublog-awaiting {
+    margin-top: 2em;
+}
+.oublog-awaiting .oublog-comment-content {
+    margin-bottom: 0.5em;
+}
+.oublog-awaiting form {
+    margin: 0 0 1.5em;
+}
+.oublog-awaiting input {
+    font-size: 0.85em;
+}
+
+.oublog-rejected {
+    color: #aaa;
+}
+.oublog-rejected-info {
+    color: black;
+    margin-bottom: 0.5em;
+    font-size: 0.85em;
+    display: inline;
+}
+
+.oublog-newerposts {
+    margin: .5em 0 1em;
+    float: right;
+}
+.oublog-olderposts {
+    margin: .5em 0 1em;
+    float: left;
+}
+.oublog-newerposts a, .oublog-olderposts a {
+    text-decoration: none;
+}
+#page-mod-oublog-participation table#participation {
+    margin-top: 1em;
+}
+
+#page-mod-oublog-userparticipation .oublog-comment-date {
+    font-size: 1em;
+}
+#page-mod-oublog-userparticipation .tabtree {
+    margin-top: 1.25em;
+}
+#oublogbuttons form,
+#oublogbuttons div {
+    display: inline;
+}
+#oublogbuttons {
+    margin-bottom: 1em;
+}
+#oublogbuttons .participationbutton {
+    margin-left: 0.5em;
+}
+#page-mod-oublog-editpost .fp-pathbar {
+    display: none;
+}
+#oublog-links a {
+    text-decoration: none;
+}
+#oublog-links .unlist form div {
+    display: inline;
+}
+#oublog-feedtext {
+    font-size: 0.85em;
+}
+.oublog-feedlinks a {
+    text-decoration: none;
+}
+#addexportpostsbutton {
+    clear:both;
+}
+
+/* Stats block. */
+#oublog-discover .oublog_statsinfo {
+    clear: both;
+    margin-bottom: .5em;
+}
+#oublog-discover .oublog_statsinfo_avatar {
+    float: left;
+}
+#oublog-discover .oublog_statsinfo_avatar .userpicture {
+    width: 35px;
+    height: 35px;
+    margin-right: 6px;
+}
+#oublog-discover .oublog_statsinfo_infocol {
+    margin-left: 41px;
+}
+.oublog_displaynone {
+    display: none;
+}
+.oublog_statsview_content h3 {
+    float: left;
+    margin-top: 0;
+}
+.oublog_statsview_content p {
+    clear: both;
+    margin-bottom: .5em;
+}
+.block_action_oublog {
+    float: right;
+    display: none;
+}
+.jsenabled .block_action_oublog {
+    display: block;
+}
+.oublog_statsinfo_bar span.oublogbar {
+    padding-top: .25em;
+    padding-bottom: .25em;
+    padding-left: 5px;
+    position: relative;
+    display: block;
+}
+#oublog-discover .oublog_statsview_content .felement.fsubmit input {
+    float: left;
+}
+#oublog-discover .ajaxworking {
+    position: relative;
+    float: left;
+    width: 20px;
+    height: 20px;
+    background: url([[pix:i/ajaxloader]]) no-repeat;
+    top: 4px;
+    left: 2px;
+}
+#oublog-discover .oublogstats_commentposts_blogname {
+    font-size: .85em;
+}
+ul.oublog-accordion {
+    list-style: none;
+    margin: 0;
+}
+div.oublog-accordion-closed {
+    display: none;
+}
+.oublog-accordion li .oublog_statsview_title h2 {
+    cursor: pointer;
+    font-size: 1.15em;
+}
+/* Blog usage stats */
+.oublog_statsinfo {
+    margin-left: 10px;
+}
+.oublog_statsview_content p {
+    clear: left;
+    margin-left: 10px;
+}
+.oublog_statsinfo_bar {
+    font-size: .85em;
+}
+.oublog_statsinfo_bar span.oublogbar {
+    background: #0070a8;
+    color: #ffffff;
+}
+.oublog_statsview_content form {
+    margin-left: 10px;
+    margin-bottom: .5em;
+}
+.oublog_statsview_content form fieldset div {
+    margin: 0;
+}
+#page .oublog_statsview_content form .fitem .fitemtitle {
+    width: 5.5em;
+    text-align: left;
+}
+.oublog_statsview_content form .fitem .felement,
+.ie .oublog_statsview_content form .fitem .felement {
+    margin-left: 5.5em;
+}
+.oublog_statsview_content form .fitem .fsubmit {
+    margin-left: 5em;
+}
+ul.oublog-accordion li {
+    border: 1px solid #e3e3e3;
+    background-color: #ffffff;
+    -webkit-border-radius: 5px;
+    -moz-border-radius: 5px;
+    border-radius: 5px;
+}
+ul.oublog-accordion li h2 {
+    margin: .5em;
+}
+ul.oublog-accordion li.oublog-accordion-closed {
+    background-repeat: repeat-x;
+    background-position: left bottom;
+}
+ul.oublog-accordion li .oublog_statsview_content {
+    margin-right: 10px;
+}
+/** Import Posts **/
+.oublog_import_step UL {
+    list-style: none;
+}
+#page-mod-oublog-import .oublog_import_step h3 {
+    font-weight: bold;
+}
+.oublog_import_step1_from span {
+    font-weight: bold;
+}
+.oublog_import_step.oublog_import_step1 form div.no-overflow {
+    overflow: visible;
+}
+.oublog_import_step1 a.oublog_import_tag {
+    display: inline;
+    margin-left: .25em;
+}
+.oublog_import_step1 table.flexible {
+    width: 100%;
+}
+.oublog_import_step1 .flexible td label {
+    position: absolute;
+    top: -1000em;
+}
+.oublog_import_step1 .flexible .cell.c0 {
+    min-width: 10em;
+}
+.oublog_import_step1 .flexible .cell.c2 {
+    min-width: 8em;
+}
+.oublog_import_step1 .flexible .cell.c3,
+.oublog_import_step1 .flexible .header.c3 {
+    max-width: 8em;
+}
+.oublog_import_step1 form div input[type=submit] {
+    margin-right: .5em;
+}
+.oublog_import_step1 .flexible .header.c3 a {
+    font-size: .75em;
+}
+
+/* For new table outputs */
+.oublog-postuser td {
+     overflow: hidden;
+}
+.oublog-postuser a,
+.oublog-postuser img {
+    margin-right:10px;
+}
+
+.oublog-postuser img td{
+    margin-right:12px;
+}
+.oublog-startedby-wrapper {
+    margin-left: 51px;
+    overflow: hidden;
+}
+
+.oublog-postuserimage {
+    display: inline;
+    margin-right: 10px;
+    overflow: hidden;
+}
+
+.oublog-postuser {
+    display: inline;
+    text-align: left;
+    overflow: hidden;
+}
+/* Comments tab Posts block. */
+.oublog_postsinfo_col {
+    margin-left: 41px;
+    margin-top: .5em;
+}
+.oublog_postsinfo_avatar {
+    overflow: hidden;
+
+}
+.oublog_postsinfo_avatar .userpicture {
+    width: 35px;
+    height: 35px;
+    margin-top: 5px;
+    margin-right: 6px;
+}
+.oublog_userinfo_col td {
+     vertical-align: top;
+     overflow: hidden;
+}
+.oublog_usersinfo_col a,
+.oublog_usersinfo_col img {
+    float: left;
+    vertical-align: top;
+    margin-right: 4px;
+}
+.oublog_postsinfo {
+    clear: both;
+    margin-bottom: .5em;
+}
+.oublog_postsinfo_col a,
+.oublog_postsinfo_col img {
+    float: left;
+    vertical-align: top;
+}
+.oublog_postscell {
+    margin-left: 40px;
+    margin-bottom: 2px;
+}
+.oublog_postscell_posttitle {
+    font-size: 1em;
+    font-color: green;
+}
+/* Normal Moodle tables modified locally. */
+.oublog.generaltable th,
+.oublog.generaltable td {
+    padding: 8px;
+    vertical-align: top;
+    text-align: left;
+}
+label[for=oublog_searchquery] {
+	display: inline;
+}
+/** Tag selector **/
+#page-mod-oublog-editpost .yui3-aclist-content {
+	height: 200px;
+    overflow-y: auto;
+}
+div.tagselector_result {
+	position: relative;
+}
+div.tagselector_result .tagselector_result_title {
+	display: inline;
+}
+div.tagselector_result .tagselector_result_info {
+	position: relative;
+	padding: 1px;
+	padding-left: 4px;
+	padding-right: 4px;
+	background-color: #f2f2f2;
+	-webkit-border-radius: 3px;
+    -moz-border-radius: 3px;
+    border-radius: 3px;
+    margin-left: .25em;
+    display: inline-block;
+    white-space: nowrap;
+}
+.yui3-aclist-item-active div.tagselector_result .tagselector_result_info {
+	color: black;
+}
+
+.oublog-tag-order {
+    margin-bottom: .5em;
+}
+
+.oublog_time_limit_msg {
+    margin-bottom: 0.5em;
+    padding: 5px;
+    border: 1px dotted #555;
+}
+
+.oubloglmt {
+    font-size: 0.8em;
+    margin-left: 5px;
+}
+#oublog-arrowback {
+    margin: 1em 0;
+}
+
+.oublog_link_import_selectedposts {
+    padding-left: 10px;
+}
+.oublog_link_import_blog {
+    padding-left: 10px;
+}
+
+#oublog_import_result_container {
+    display: none;
+}
+#oublog_import_result_container h3 {
+    text-align: center;
+}
\ No newline at end of file
diff --git a/mod/oublog/tests/behat/basic.feature b/mod/oublog/tests/behat/basic.feature
new file mode 100644
index 0000000..1042bcc
--- /dev/null
+++ b/mod/oublog/tests/behat/basic.feature
@@ -0,0 +1,666 @@
+@ou @ou_vle @mod @mod_oublog @oublog_basic
+Feature: Test Post and Comment on OUBlog entry
+  In order to use OUBblog features
+  As a user
+  I need to be able to complete basic operations
+
+  Background:
+    Given the following "users" exist:
+      | username | firstname | lastname | email |
+      | teacher1 | Teacher | 1 | teacher1@asd.com |
+      | student1 | Student | 1 | student1@asd.com |
+      | student2 | Student | 2 | student2@asd.com |
+    And the following "courses" exist:
+      | fullname | shortname | category |
+      | Course 1 | C1 | 0 |
+    And the following "course enrolments" exist:
+      | user | course | role |
+      | teacher1 | C1 | editingteacher |
+      | student1 | C1 | student |
+      | student2 | C1 | student |
+    And the following "groups" exist:
+      | name | course | idnumber |
+      | G1 | C1 | G1 |
+      | G2 | C1 | G2 |
+    And the following "group members" exist:
+      | user | group |
+      | student1 | G1 |
+      | student2 | G2 |
+    And the following "activities" exist:
+      | activity | name | intro  | course | idnumber |
+      | oublog | Test oublog basics | Test oublog basics intro text | C1 | oublog1 |
+
+  Scenario: Multiple blog type tests - basic access etc
+    Given I log in as "teacher1"
+    And I am on homepage
+    And I follow "Course 1"
+    And I turn editing mode on
+    When I add a "OU blog" to section "1" and I fill the form with:
+      | Blog name | B.SG |
+      | Group mode | Separate groups |
+    And I add a "OU blog" to section "1" and I fill the form with:
+      | Blog name | B.VG |
+      | Group mode | Visible groups |
+    And I add a "OU blog" to section "1" and I fill the form with:
+      | Blog name | B.SI |
+      | Individual blogs | Separate individual blogs |
+    And I add a "OU blog" to section "1" and I fill the form with:
+      | Blog name | B.VI |
+      | Individual blogs | Visible individual blogs |
+    And I add a "OU blog" to section "1" and I fill the form with:
+      | Blog name | B.SISG |
+      | Individual blogs | Separate individual blogs |
+      | Group mode | Separate groups |
+    And I add a "OU blog" to section "1" and I fill the form with:
+      | Blog name | B.SIVG |
+      | Individual blogs | Separate individual blogs |
+      | Group mode | Visible groups |
+    And I add a "OU blog" to section "1" and I fill the form with:
+      | Blog name | B.VISG |
+      | Individual blogs | Visible individual blogs |
+      | Group mode | Separate groups |
+    And I add a "OU blog" to section "1" and I fill the form with:
+      | Blog name | B.VIVG |
+      | Individual blogs | Visible individual blogs |
+      | Group mode | Visible groups |
+    Then I should see "Test oublog basics"
+    # Editing teacher adds posts to all the blogs.
+    Given I follow "Test oublog basics"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P0 |
+      | Message | P0 |
+    And I press "Add post"
+    And I follow "Course 1"
+    Given I follow "B.SG"
+    And I set the field "Separate groups" to "G1"
+    And I press "Go"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P2 |
+      | Message | P2 |
+    And I press "Add post"
+    Given I set the field "Separate groups" to "G2"
+    And I press "Go"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P3 |
+      | Message | P3 |
+    And I press "Add post"
+    And I follow "Course 1"
+    Given I follow "B.SI"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P10 |
+      | Message | P10 |
+    And I press "Add post"
+    And I follow "Course 1"
+    Given I follow "B.VI"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P13 |
+      | Message | P13 |
+    And I press "Add post"
+    Then I log out
+    # Student 1 adds posts.
+    Given I log in as "student1"
+    And I am on homepage
+    And I follow "Course 1"
+    Given I follow "Test oublog basics"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P1 |
+      | Message | P1 |
+    And I press "Add post"
+    And I follow "Course 1"
+    Given I follow "B.SG"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P4 |
+      | Message | P4 |
+    And I press "Add post"
+    And I follow "Course 1"
+    Given I follow "B.VG"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P6 |
+      | Message | P6 |
+    And I press "Add post"
+    And I follow "Course 1"
+    Given I follow "B.SI"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P8 |
+      | Message | P8 |
+    And I press "Add post"
+    And I follow "Course 1"
+    Given I follow "B.VI"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P11 |
+      | Message | P11 |
+    And I press "Add post"
+    And I follow "Course 1"
+    Given I follow "B.SISG"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P15 |
+      | Message | P15 |
+    And I press "Add post"
+    And I follow "Course 1"
+    Given I follow "B.SIVG"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P16 |
+      | Message | P16 |
+    And I press "Add post"
+    And I follow "Course 1"
+    Given I follow "B.VISG"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P17 |
+      | Message | P17 |
+    And I press "Add post"
+    And I follow "Course 1"
+    Given I follow "B.VIVG"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P18 |
+      | Message | P18 |
+    And I press "Add post"
+    And I follow "Course 1"
+    Then I log out
+    # Student 2 adds posts.
+    Given I log in as "student2"
+    And I am on homepage
+    And I follow "Course 1"
+    Given I follow "B.SG"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P5 |
+      | Message | P5 |
+    And I press "Add post"
+    And I follow "Course 1"
+    Given I follow "B.VG"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P7 |
+      | Message | P7 |
+    And I press "Add post"
+    And I follow "Course 1"
+    Given I follow "B.SI"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P9 |
+      | Message | P9 |
+    And I press "Add post"
+    And I follow "Course 1"
+    Given I follow "B.VI"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P12 |
+      | Message | P12 |
+    And I press "Add post"
+    And I follow "Course 1"
+    Given I follow "B.SISG"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P19 |
+      | Message | P19 |
+    And I press "Add post"
+    And I follow "Course 1"
+    Given I follow "B.SIVG"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P20 |
+      | Message | P20 |
+    And I press "Add post"
+    And I follow "Course 1"
+    Given I follow "B.VISG"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P21 |
+      | Message | P21 |
+    And I press "Add post"
+    And I follow "Course 1"
+    Given I follow "B.VIVG"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P22 |
+      | Message | P22 |
+    And I press "Add post"
+    And I follow "Course 1"
+    Then I log out
+    # Editing teacher - check view.
+    Given I log in as "teacher1"
+    And I am on homepage
+    And I follow "Course 1"
+    When I follow "B.SG"
+    Then the "Separate groups" select box should contain "G1"
+    And the "Separate groups" select box should contain "G2"
+    And the field "Separate groups" matches value "All participants"
+    And I should see "P2" in the "#oublog-posts" "css_element"
+    And I should see "P3" in the "#oublog-posts" "css_element"
+    Given I set the field "Separate groups" to "G1"
+    When I press "Go"
+    Then I should see "P4" in the "#oublog-posts" "css_element"
+    And I should not see "P5" in the "#oublog-posts" "css_element"
+    Given I follow "Course 1"
+    When I follow "B.SI"
+    Then the "jump" select box should contain "Student 1"
+    And the field "jump" matches value "View all users"
+    And I should see "P10" in the "#oublog-posts" "css_element"
+    And I should see "P8" in the "#oublog-posts" "css_element"
+    And I should see "P9" in the "#oublog-posts" "css_element"
+    Given I set the field "jump" to "Teacher 1"
+    When I press "Go"
+    Then I should see "P10" in the "#oublog-posts" "css_element"
+    And I should not see "P9" in the "#oublog-posts" "css_element"
+    Given I follow "Course 1"
+    When I follow "B.SISG"
+    Then the "Separate groups" select box should contain "All participants"
+    And the "Separate groups" select box should contain "G2"
+    And the field "Separate groups" matches value "G1"
+    And I should see "P15" in the "#oublog-posts" "css_element"
+    And I should not see "P19" in the "#oublog-posts" "css_element"
+    Given I set the field "Separate groups" to "All participants"
+    When I press "Go"
+    Then the "jump" select box should contain "Student 1"
+    And the field "jump" matches value "Teacher 1"
+    And I should not see "P15" in the "#region-main" "css_element"
+    Given I set the field "jump" to "Student 2"
+    When I click on "#selectindividual input[type=submit]" "css_element"
+    Then I should see "P19" in the "#oublog-posts" "css_element"
+    And I should not see "P15" in the "#oublog-posts" "css_element"
+    Given I follow "Course 1"
+    When I follow "B.SIVG"
+    Then the "Visible groups" select box should contain "G1"
+    And the "Visible groups" select box should contain "G2"
+    And the field "Visible groups" matches value "All participants"
+    And the "jump" select box should contain "Student 2"
+    And I should see "P20" in the "#oublog-posts" "css_element"
+    And I should not see "P16" in the "#oublog-posts" "css_element"
+    Given I set the field "jump" to "View all users"
+    When I click on "#selectindividual input[type=submit]" "css_element"
+    Then I should see "P20" in the "#oublog-posts" "css_element"
+    And I should see "P16" in the "#oublog-posts" "css_element"
+    Given I set the field "Visible groups" to "G1"
+    When I press "Go"
+    Then I should see "P16" in the "#oublog-posts" "css_element"
+    And I should not see "P20" in the "#oublog-posts" "css_element"
+    Given I follow "Course 1"
+    When I follow "B.VISG"
+    Then the "Separate groups" select box should contain "All participants"
+    And the "Separate groups" select box should contain "G2"
+    And the field "Separate groups" matches value "G1"
+    And I should see "P17" in the "#oublog-posts" "css_element"
+    And I should not see "P21" in the "#oublog-posts" "css_element"
+    Given I set the field "Separate groups" to "All participants"
+    When I press "Go"
+    Then I should see "P21" in the "#oublog-posts" "css_element"
+    And I should see "P17" in the "#oublog-posts" "css_element"
+    Given I set the field "jump" to "Student 1"
+    When I click on "#selectindividual input[type=submit]" "css_element"
+    Then I should see "P17" in the "#oublog-posts" "css_element"
+    And I should not see "P21" in the "#oublog-posts" "css_element"
+    Given I follow "Course 1"
+    When I follow "B.VIVG"
+    Then the "Visible groups" select box should contain "G1"
+    And the "Visible groups" select box should contain "G2"
+    And the field "Visible groups" matches value "All participants"
+    And the "jump" select box should contain "View all users"
+    And I should see "P18" in the "#oublog-posts" "css_element"
+    Given I set the field "jump" to "View all users"
+    When I click on "#selectindividual input[type=submit]" "css_element"
+    Then I should see "P18" in the "#oublog-posts" "css_element"
+    And I should see "P22" in the "#oublog-posts" "css_element"
+    Given I set the field "Visible groups" to "G2"
+    When I press "Go"
+    Then I should see "P22" in the "#oublog-posts" "css_element"
+    And I should not see "P18" in the "#oublog-posts" "css_element"
+    Given I follow "Course 1"
+    When I log out
+    # Student 1 - check view.
+    Given I log in as "student1"
+    And I am on homepage
+    And I follow "Course 1"
+    When I follow "B.SG"
+    Then I should see "P4" in the "#oublog-posts" "css_element"
+    And I should see "P2" in the "#oublog-posts" "css_element"
+    And ".groupselector select" "css_element" should not exist
+    And I follow "Course 1"
+    When I follow "B.VG"
+    Then ".groupselector select" "css_element" should exist
+    And the field "Visible groups" matches value "G1"
+    And the "Visible groups" select box should contain "G2"
+    And the "Visible groups" select box should contain "All participants"
+    And I should see "P6" in the "#oublog-posts" "css_element"
+    And I should not see "P7" in the "#oublog-posts" "css_element"
+    Given I set the field "Visible groups" to "G2"
+    When I press "Go"
+    Then I should see "P7" in the "#oublog-posts" "css_element"
+    And I should not see "P6" in the "#oublog-posts" "css_element"
+    And I follow "Course 1"
+    When I follow "B.SI"
+    Then I should see "P8" in the "#oublog-posts" "css_element"
+    And ".oublog-individualselector select" "css_element" should not exist
+    And I follow "Course 1"
+    When I follow "B.VI"
+    Then I should see "P11" in the "#oublog-posts" "css_element"
+    And the field "jump" matches value "View all users"
+    And the "jump" select box should contain "Student 2"
+    Given I set the field "jump" to "Student 2"
+    When I press "Go"
+    Then I should see "P12" in the "#oublog-posts" "css_element"
+    And I should not see "P11" in the "#oublog-posts" "css_element"
+    Given I follow "Course 1"
+    When I follow "B.SISG"
+    Then I should see "P15" in the "#oublog-posts" "css_element"
+    And I should not see "P19" in the "#oublog-posts" "css_element"
+    And ".oublog-individualselector select" "css_element" should not exist
+    And ".groupselector select" "css_element" should not exist
+    Given I follow "Course 1"
+    When I follow "B.SIVG"
+    Then I should see "P16" in the "#oublog-posts" "css_element"
+    And I should not see "P20" in the "#oublog-posts" "css_element"
+    And ".oublog-individualselector select" "css_element" should not exist
+    Given I follow "Course 1"
+    When I follow "B.VISG"
+    Then I should see "P17" in the "#oublog-posts" "css_element"
+    And I should not see "P21" in the "#oublog-posts" "css_element"
+    And ".groupselector select" "css_element" should not exist
+    Given I follow "Course 1"
+    When I follow "B.VIVG"
+    Then I should see "P22" in the "#oublog-posts" "css_element"
+    And I should not see "P18" in the "#oublog-posts" "css_element"
+    Given I set the field "Visible groups" to "All participants"
+    When I press "Go"
+    Given I set the field "jump" to "View all users"
+    When I click on "#selectindividual input[type=submit]" "css_element"
+    Then I should see "P18" in the "#oublog-posts" "css_element"
+    Given I follow "Course 1"
+    When I log out
+    # Student2 - check view.
+    Given I log in as "student2"
+    And I am on homepage
+    And I follow "Course 1"
+    When I follow "Test oublog basics"
+    Then I should see "P0" in the ".oublog-post.oublog-even .oublog-post-content" "css_element"
+    And I should see "P1" in the ".oublog-post.oublog-odd .oublog-post-content" "css_element"
+
+  @javascript
+  Scenario: Check tag sorting and filter by tag as student
+    Given I log in as "teacher1"
+    And I am on homepage
+    And I follow "Course 1"
+    When I follow "Test oublog basics"
+    And I press "New blog post"
+    # Before the 'Set' tags restriction
+    And I should not see "You may only enter the 'Set' tags:"
+    And I set the following fields to these values:
+      | Title | SC02 OUBlog post01 from teacher1 |
+      | Message | SC02 Teacher OUBlog post01 content |
+      | Tags | ctag3sc02 |
+    And I press "Add post"
+    And I log out
+
+    # Student tests without Set tags restrictions.
+    Given I log in as "student1"
+    And I follow "Course 1"
+    And I follow "Test oublog basics"
+    And I press "New blog post"
+    # Before the 'Set' tags restriction
+    And I should not see "You may only enter the 'Set' tags:"
+    And I set the following fields to these values:
+      | Title | SC02 OUBlog post01 from student |
+      | Message | SC02 Student OUBlog post01 content |
+      | Tags | ctag3sc02, btag2sc02 |
+    And I press "Add post"
+    And I press "New blog post"
+    And I set the following fields to these values:
+      | Title | SC02 OUBlog post02 from student |
+      | Message | SC02 Student OUBlog post02 content filtered by tag|
+      | Tags | atag1sc02, btag2sc02, ctag3sc02 |
+    And I press "Add post"
+
+    # Should see tags in default Alphabetical order.
+    Then I should see "atag1sc02(1) btag2sc02(2) ctag3sc02(3)"
+    And I follow "Most used"
+    And I should see "ctag3sc02(3) btag2sc02(2) atag1sc02(1)"
+
+    # Check filter by tag.
+    Given I follow "atag1sc02"
+    And I should not see "OUBlog post from teacher1"
+    And I should not see "Teacher OUBlog post01 content"
+    And I should not see "OUBlog post from student1"
+    And I should not see "Student OUBlog post01 content"
+
+    # Check post edit with attachment.
+    Given I follow "Edit"
+    And I set the following fields to these values:
+      | Title | SC02 OUBlog post02 from student edited post subject |
+      | Message | SC02 Student OUBlog post02 content filtered by tag edited post body |
+      | Tags | atag1sc02, btag2sc02, ctag3sc02, dtag3sc02 |
+    And I upload "lib/tests/fixtures/empty.txt" file to "Attachments" filemanager
+    And I press "Save changes"
+    And I wait to be redirected
+    Then I should see "SC02 OUBlog post02 from student edited post subject"
+    And I should see "SC02 Student OUBlog post02 content filtered by tag edited post body"
+    And I should see "dtag3sc02"
+    And I should see "empty.txt"
+    And I should see "Edited by Student 1"
+    Given I follow "Permalink"
+    And I click on ".oublog-post-editsummary a" "css_element"
+    Then I should not see "SC02 Student OUBlog post02 content filtered by tag edited post body"
+
+    # Delete student post01 the second post made.
+    Given I follow "Test oublog basics"
+    When I click on "Delete" "link" in the ".oublog-post:nth-child(2) .oublog-post-links" "css_element"
+    And I wait to be redirected
+    Then I should see "Are you sure you want to delete this post?"
+    And I press "Delete"
+    And I wait to be redirected
+    Then I should see "SC02 OUBlog post02 from student edited post subject"
+    And ".oublog-deleted" "css_element" should exist
+    And ".oublog-post-deletedby" "css_element" should exist
+    And I should see "Deleted by"
+    And "Delete" "link" should not exist in the ".oublog-deleted" "css_element"
+    And "Add your comment" "link" should not exist in the ".oublog-deleted" "css_element"
+
+    # Check post comments with comments enabled.
+    Then I should see "SC02 OUBlog post02 from student edited post subject"
+    And I should see "SC02 Student OUBlog post02 content filtered by tag edited post body"
+    Given I follow "Add your comment"
+    And I set the field "Title" to "$My own >nasty< \"string\"!"
+    And I set the field "Add your comment" to "$My own >nasty< \"string\"!"
+    And I press "Add comment"
+    Then I should see "SC02 OUBlog post02 from student"
+    And I should see "$My own >nasty< \"string\"!"
+    And I log out
+
+    # Check post with restrictions enabled as Teacher.
+    Given I log in as "teacher1"
+    And I follow "Course 1"
+    When I follow "Test oublog basics"
+    And I navigate to "Edit settings" in current page administration
+    # Add the 'Set' tags restriction
+    When I set the following fields to these values:
+      | Tags | ctag4sc02, btag5sc02, dogtag |
+      | Tag options | 1 |
+    And I press "Save and display"
+
+    # Test only the predefined tags are allowed.
+    And I press "New blog post"
+    Then I should see "You may only enter the 'Set' tags:"
+    And I set the following fields to these values:
+      | Title | SC02 OUBlog post02 from teacher1 |
+      | Message | SC02 OUBlog post02 teacher content |
+      | Tags | ctag4sc02, btag5sc02, catsndogs |
+    And I press "Add post"
+
+    # Warning tags are now restricted
+    Then I should see "Only 'Set' tags are allowed to be entered"
+    And I set the following fields to these values:
+      | Tags | dogtag |
+    And I press "Add post"
+    Then I should see "SC02 OUBlog post02 from teacher1"
+    And I should see "SC02 OUBlog post02 teacher content"
+
+    # Should see tags in default Alphabetical order.
+    Then I should see "ctag3sc02(2) dogtag(1) dtag3sc02(1)"
+    And I log out
+
+
+  Scenario: Further standard regression/basic tests - non-js.
+    # Check post with comments disabled as Teacher.
+    Given I log in as "teacher1"
+    And I am on homepage
+    And I follow "Course 1"
+    When I follow "Test oublog basics"
+    And I navigate to "Edit settings" in current page administration
+    When I set the following fields to these values:
+      | Allow comments | Comments not allowed |
+    And I press "Save and display"
+    And I press "New blog post"
+    Then "#fitem_id_visibility" "css_element" should not exist
+    And I set the following fields to these values:
+      | Title | Post01 from teacher |
+      | Message | OUBlog post01 content |
+    And I press "Add post"
+
+    # Check related links 'block'.
+    Given I follow "Add link"
+    And I set the following fields to these values:
+      | Title | Teachers Personal blog test |
+      | Full Web address | http://127.0.0.1/mod/oublog/view.php?user=3 |
+    When I press "id_submitbutton"
+    Then "Teachers Personal blog test" "link" should exist
+    And "#oublog-links form" "css_element" should not exist
+    Given I follow "Add link"
+    And I set the following fields to these values:
+      | Title | Teachers Personal blog link2 |
+      | Full Web address | http://www.open.ac.uk |
+    When I press "id_submitbutton"
+    Then "#oublog-links form" "css_element" should exist
+    And "Personal blog link2" "link" should exist
+
+    Given I click on "//aside[@id='oublog-links']//li[2]//input[@type='image']" "xpath_element"
+
+    Then I should see "Teachers Personal blog link2" in the "//aside[@id='oublog-links']//li[1]//a[1]" "xpath_element"
+    Given I click on "//aside[@id='oublog-links']//li[1]//a[@title='Delete']" "xpath_element"
+    When I press "Continue"
+    Then I should not see "Teachers Personal blog link2"
+    And "#oublog-links form" "css_element" should not exist
+    And I log out
+
+    # Student test comments disabled and related link.
+    Given I log in as "student1"
+    And I follow "Course 1"
+    When I follow "Test oublog basics"
+    Then "Add your comment" "link" should not exist in the ".oublog-post" "css_element"
+    And "Teachers Personal blog test" "link" should exist
+    Given I follow "Permalink"
+    Then "Add your comment" "link" should not exist in the ".oublog-post" "css_element"
+    And I log out
+    # Test commenting.
+    Given I log in as "teacher1"
+    And I am on homepage
+    And I follow "Course 1"
+    When I follow "Test oublog basics"
+    And I navigate to "Edit settings" in current page administration
+    When I set the following fields to these values:
+      | Allow comments | Yes, from logged-in users |
+    And I press "Save and display"
+    Then I should not see "Add your comment"
+    Given I click on "div.oublog-post-links a:nth-child(2)" "css_element"
+    And I set the field "Allow comments" to "Yes, from logged-in users"
+    And I press "Save changes"
+    When I follow "Add your comment"
+    And I set the field "Add your comment" to "Teacher comment"
+    And I press "Add comment"
+    Then I should see "Comments" in the ".oublog-commentstitle" "css_element"
+    And I should see "Teacher comment"
+    Given I follow "Add your comment"
+    And I set the field "Title" to "Title:Teacher comment 2"
+    And I set the field "Add your comment" to "Teacher comment 2"
+    And I press "Add comment"
+    Then I should see "Teacher comment 2"
+    And I should see "Title:Teacher comment 2"
+    Given I click on ".oublog-post-comments .oublog-comment:nth-child(2) .oublog-post-links a" "css_element"
+    When I press "Continue"
+    Then ".oublog-comment-deletedby" "css_element" should exist
+    Given I follow "Test oublog basics"
+    Then I should see "1 comment"
+    And I log out
+    Given I log in as "student1"
+    And I follow "Course 1"
+    When I follow "Test oublog basics"
+    Given I follow "1 comment"
+    Then I should not see "Teacher comment 2"
+    When I follow "Add your comment"
+    And I set the field "Title" to "Title:Student comment"
+    And I set the field "Add your comment" to "Student comment"
+    And I press "Add comment"
+    Then I should see "Student comment"
+    And I should see "Title:Student comment"
+    And "#cid1.oublog-deleted" "css_element" should not exist
+    Given I click on ".oublog-comment .oublog-post-links a" "css_element"
+    When I press "Cancel"
+    Then I should see "Comments" in the ".oublog-commentstitle" "css_element"
+    When I follow "Test oublog basics"
+    Then I should see "2 comments"
+    And I log out
+
+  Scenario: Check back to main page link
+    Given I log in as "teacher1"
+    And I am on homepage
+    And I follow "Course 1"
+    When I follow "Test oublog basics"
+    And I press "New blog post"
+    And I set the following fields to these values:
+      | Title | Teacher1 blog |
+      | Message | Teacher1 message |
+    And I press "Add post"
+    # Go to viewpost page and back to the main blog page
+    When I follow "Permalink"
+    Then "#oublog-arrowback" "css_element" should exist
+    And I should see "Test oublog basics" in the "#oublog-arrowback" "css_element"
+    Given I click on "#oublog-arrowback a" "css_element"
+    Then "#addpostbutton" "css_element" should exist
+    # Go to participation page and back to the main blog page
+    Given I press "Participation by user"
+    Then I should see "Participation - All time"
+    And "#oublog-arrowback" "css_element" should exist
+    And I should see "Test oublog basics" in the "#oublog-arrowback" "css_element"
+    Given I click on "#oublog-arrowback a" "css_element"
+    Then "#addpostbutton" "css_element" should exist
+    # Go to userparticipatiom page and back to the main blog page
+    When I expand "BLOG USAGE" node
+    And I expand "My participation summary" node
+    And I follow "View all participation"
+    Then I should see "Participation - All time"
+    And "#oublog-arrowback" "css_element" should exist
+    And I should see "Test oublog basics" in the "#oublog-arrowback" "css_element"
+    Given I click on "#oublog-arrowback a" "css_element"
+    Then "#addpostbutton" "css_element" should exist
+    # Go to participatiomlist page and back to the main blog page
+    When I expand "Participation" node
+    And I follow "View all participation"
+    Then I should see "Participation - All time"
+    And "#oublog-arrowback" "css_element" should exist
+    And I should see "Test oublog basics" in the "#oublog-arrowback" "css_element"
+    Given I click on "#oublog-arrowback a" "css_element"
+    Then "#addpostbutton" "css_element" should exist
+    And I log out
+
+  Scenario: Check info block doesn't appear if there's no summary
+    Given I log in as "teacher1"
+    And I am on homepage
+    And I follow "Course 1"
+    When I follow "Test oublog basics"
+    And "#oublog_info_block" "css_element" should exist
+    And I follow "Edit settings"
+    When I set the following fields to these values:
+      | Intro | |
+    And I press "Save and display"
+    And "#oublog_info_block" "css_element" should not exist
\ No newline at end of file
diff --git a/mod/oublog/tests/behat/behat_mod_oublog.php b/mod/oublog/tests/behat/behat_mod_oublog.php
new file mode 100644
index 0000000..afd7ede
--- /dev/null
+++ b/mod/oublog/tests/behat/behat_mod_oublog.php
@@ -0,0 +1,50 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Steps definitions related with the oublog activity.
+ *
+ * @package mod_oublog
+ * @category test
+ * @copyright 2015 The Open University
+ * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+// NOTE: no MOODLE_INTERNAL test here, this file may be required by behat before including /config.php.
+
+require_once(__DIR__ . '/../../../../lib/behat/behat_base.php');
+
+/**
+ * oublog-related steps definitions.
+ *
+ * @package    mod_oublog
+ * @category   test
+ * @copyright  2015 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+class behat_mod_oublog extends behat_base {
+
+    /**
+     * Simulates a user adding a personal oublog username to a URL entered into their browser address bar.
+     *
+     * @Given /^I visit the personal blog for "(?P<user_string>(?:[^"]|\\")*)"$/
+     * @param string $user the user name
+     */
+    public function i_visit_the_personal_blog_for($user) {
+        global $CFG;
+        $this->getSession()->visit($CFG->wwwroot .'/mod/oublog/view.php?u='. $user);
+    }
+}
diff --git a/mod/oublog/tests/behat/importblog.feature b/mod/oublog/tests/behat/importblog.feature
new file mode 100644
index 0000000..ff9113e
--- /dev/null
+++ b/mod/oublog/tests/behat/importblog.feature
@@ -0,0 +1,115 @@
+@ou @ou_vle @mod @mod_oublog @oublog_importblog
+Feature: Test import posts function for blog
+  In order to add OUBblog personal posts and OUBblog posts to current blog
+  As an user
+  I need to be able to import posts from another blogs
+
+  Background:
+    Given the following "users" exist:
+      | username | firstname | lastname | email            |
+      | student1 | Student1  | 1        | student1@asd.com |
+    And the following "courses" exist:
+      | fullname | shortname | format      | category |
+      | Course 1 | C1        | oustudyplan | 0        |
+    And the following "course enrolments" exist:
+      | user     | course | role    |
+      | student1 | C1     | student |
+    And the following "activities" exist:
+      | activity | name                 | intro                        | course | idnumber | allowimport | individual |
+      | oublog   | student 1 blog one   | The first blog of student 1  | C1     | oublog1  | 1           | 2          |
+      | oublog   | student 1 blog two   | The second blog of student 2 | C1     | oublog2  | 1           | 2          |
+      | oublog   | student 1 blog three | The second blog of student 3 | C1     | oublog3  | 1           | 2          |
+
+    # Student 1 add posts to the first blog
+    And I log in as "student1"
+    And I am on site homepage
+    And I am using the OSEP theme
+    And I follow "Course 1"
+    And I press "Expand all"
+    And I follow "student 1 blog one"
+    And I press "New blog post"
+    And I set the following fields to these values:
+      | Title      | Post 0 title                        |
+      | Message    | Post 0 message                      |
+      | Tags       | C#, Java                            |
+      | Attachment | lib/tests/fixtures/upload_users.csv |
+    And I press "Add post"
+    When I follow "Add your comment"
+    And I set the following fields to these values:
+      | Title            | Post 0 comment 1         |
+      | Add your comment | Post 0 Comment 1 message |
+    Then I click on "Add comment" "button"
+    When I follow "Add your comment"
+    And I set the following fields to these values:
+      | Title            | Post 0 comment 2         |
+      | Add your comment | Post 0 Comment 2 message |
+    Then I click on "Add comment" "button"
+    When I follow "student 1 blog one"
+    And I press "New blog post"
+    And I set the following fields to these values:
+      | Title   | Post 1 title   |
+      | Message | Post 1 message |
+      | Tags    | JS, PHP        |
+    And I press "Add post"
+
+  @javascript
+  Scenario: Display import selected posts and import blog links for each blog that has post.
+    Given I am on site homepage
+    And I follow "Course 1"
+    And I follow "student 1 blog two"
+    When I click on "Import" "button"
+    Then I should see "student 1 blog three (0 posts)"
+    Then I should see "student 1 blog one (2 posts)"
+    Then I should see "Import selected posts"
+    Then I should see "Import blog"
+
+  @javascript
+  Scenario: Navigate to post listing page when clicking on import selected posts link.
+    Given I am on site homepage
+    And I follow "Course 1"
+    And I follow "student 1 blog two"
+    And I click on "Import" "button"
+    When I follow "Import selected posts"
+    Then I should see "student 1 blog one"
+    Then I should see "Post 1 title"
+    Then I should see "Post 0 title"
+    And I follow "Select all"
+    And I click on "Import" "button"
+    Then I should see "2 post(s) imported successfully"
+    And I click on "Continue" "button"
+    Then I should see "Post 0 title"
+    Then I should see "Post 0 message"
+    Then I should see "Post 1 title"
+    Then I should see "Post 1 message"
+    Then I should see "js, php, c1"
+    Then I should see "c#, java, c1"
+    Then I should see "2 comments"
+    Then I should see "upload_users.csv"
+    And I follow "2 comments"
+    Then I should see "Post 0 comment 1"
+    Then I should see "Post 0 Comment 1 message"
+    Then I should see "Post 0 comment 2"
+    Then I should see "Post 0 Comment 2 message"
+
+  @javascript
+  Scenario: Perform the import all posts of the selected blog when clicking on import blog link.
+    Given I am on site homepage
+    And I follow "Course 1"
+    And I follow "student 1 blog two"
+    And I click on "Import" "button"
+    When I follow "Import blog"
+    Then I should see "2 post(s) imported successfully"
+    And I click on "Continue" "button"
+    Then I should see "Post 0 title"
+    Then I should see "Post 0 message"
+    Then I should see "Post 1 title"
+    Then I should see "Post 1 message"
+    Then I should see "js, php, c1"
+    Then I should see "c#, java, c1"
+    Then I should see "2 comments"
+    Then I should see "upload_users.csv"
+    And I follow "2 comments"
+    Then I should see "Post 0 comment 1"
+    Then I should see "Post 0 Comment 1 message"
+    Then I should see "Post 0 comment 2"
+    Then I should see "Post 0 Comment 2 message"
diff --git a/mod/oublog/tests/behat/lastupdated.feature b/mod/oublog/tests/behat/lastupdated.feature
new file mode 100644
index 0000000..56d059e
--- /dev/null
+++ b/mod/oublog/tests/behat/lastupdated.feature
@@ -0,0 +1,200 @@
+@ou @ou_vle @mod @mod_oublog @lastmodified
+Feature: Show last updated information on activity link
+  In know when a blog was last updated
+  As a user
+  I need to see the last post date on the blog link
+
+  Background:
+    Given the following "users" exist:
+      | username | firstname | lastname | email |
+      | student1 | Student | 1 | student1@asd.com |
+      | student2 | Student | 2 | student2@asd.com |
+    And the following "courses" exist:
+      | fullname | shortname | category |
+      | Course 1 | C1 | 0 |
+    And the following "course enrolments" exist:
+      | user | course | role |
+      | student1 | C1 | student |
+      | student2 | C1 | student |
+    And the following "groups" exist:
+      | name | course | idnumber |
+      | G1 | C1 | G1 |
+      | G2 | C1 | G2 |
+    And the following "group members" exist:
+      | user | group |
+      | student1 | G1 |
+      | student2 | G2 |
+
+  Scenario: Test course blog
+    Given I log in as "admin"
+    And I am on site homepage
+    When I follow "Course 1"
+    And I turn editing mode on
+    When I add a "OU blog" to section "1" and I fill the form with:
+      | Blog name | Test course oublog |
+    Then I should see "Test course oublog"
+    And ".lastmodtext.oubloglmt" "css_element" should not exist
+    Given I follow "Test course oublog"
+    And I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P0 |
+      | Message | P0 |
+    And I press "Add post"
+    When I follow "Course 1"
+    Then ".lastmodtext.oubloglmt" "css_element" should exist
+
+  Scenario: Group blog
+    Given I log in as "admin"
+    And I am on site homepage
+    And I follow "Course 1"
+    And I turn editing mode on
+    When I add a "OU blog" to section "1" and I fill the form with:
+      | Blog name | B.SG |
+      | Group mode | Separate groups |
+    And I add a "OU blog" to section "1" and I fill the form with:
+      | Blog name | B.VG |
+      | Group mode | Visible groups |
+    Given I follow "B.SG"
+    And I set the field "Separate groups" to "G1"
+    And I press "Go"
+    And I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P1 |
+      | Message | P1 |
+    And I press "Add post"
+    And I follow "Course 1"
+    Given I follow "B.VG"
+    And I set the field "Visible groups" to "G1"
+    And I press "Go"
+    And I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P2 |
+      | Message | P2 |
+    And I press "Add post"
+    Given I log out
+    And I log in as "student1"
+    And I am on site homepage
+    And I follow "Course 1"
+    # Student should see both indicators.
+    Then "/descendant::div[@class='activityinstance'][1]//span[@class='lastmodtext oubloglmt']" "xpath_element" should exist
+    And "/descendant::div[@class='activityinstance'][2]//span[@class='lastmodtext oubloglmt']" "xpath_element" should exist
+    Given I log out
+    And I log in as "student2"
+    And I am on site homepage
+    And I follow "Course 1"
+    # Student should see only visible group indicators.
+    Then "/descendant::div[@class='activityinstance'][1]//span[@class='lastmodtext oubloglmt']" "xpath_element" should not exist
+    And "/descendant::div[@class='activityinstance'][2]//span[@class='lastmodtext oubloglmt']" "xpath_element" should exist
+
+  Scenario: Indivdual blogs
+    Given I log in as "admin"
+    And I am on site homepage
+    And I follow "Course 1"
+    And I turn editing mode on
+    And I add a "OU blog" to section "1" and I fill the form with:
+      | Blog name | B.SI |
+      | Individual blogs | Separate individual blogs |
+    And I add a "OU blog" to section "1" and I fill the form with:
+      | Blog name | B.VI |
+      | Individual blogs | Visible individual blogs |
+    And I follow "B.SI"
+    And I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P1 |
+      | Message | P1 |
+    And I press "Add post"
+    And I follow "Course 1"
+    And I follow "B.VI"
+    And I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P2 |
+      | Message | P2 |
+    And I press "Add post"
+    Given I log out
+    And I log in as "student1"
+    And I am on site homepage
+    And I follow "Course 1"
+    # Student should see visible indicator only.
+    Then "/descendant::div[@class='activityinstance'][1]//span[@class='lastmodtext oubloglmt']" "xpath_element" should not exist
+    And "/descendant::div[@class='activityinstance'][2]//span[@class='lastmodtext oubloglmt']" "xpath_element" should exist
+
+  Scenario: Mixed blogs
+    Given I log in as "admin"
+    And I am on site homepage
+    And I follow "Course 1"
+    And I turn editing mode on
+    And I add a "OU blog" to section "1" and I fill the form with:
+      | Blog name | B.SISG |
+      | Individual blogs | Separate individual blogs |
+      | Group mode | Separate groups |
+    And I add a "OU blog" to section "1" and I fill the form with:
+      | Blog name | B.SIVG |
+      | Individual blogs | Separate individual blogs |
+      | Group mode | Visible groups |
+    And I add a "OU blog" to section "1" and I fill the form with:
+      | Blog name | B.VISG |
+      | Individual blogs | Visible individual blogs |
+      | Group mode | Separate groups |
+    And I add a "OU blog" to section "1" and I fill the form with:
+      | Blog name | B.VIVG |
+      | Individual blogs | Visible individual blogs |
+      | Group mode | Visible groups |
+    # Admin adds post to every blog.
+    And I follow "B.SISG"
+    And I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P1 |
+      | Message | P1 |
+    And I press "Add post"
+    And I follow "Course 1"
+    And I follow "B.SIVG"
+    And I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P2 |
+      | Message | P2 |
+    And I press "Add post"
+    And I follow "Course 1"
+    And I follow "B.VISG"
+    And I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P3 |
+      | Message | P3 |
+    And I press "Add post"
+    And I follow "Course 1"
+    And I follow "B.VIVG"
+    And I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P1 |
+      | Message | P1 |
+    And I press "Add post"
+    When I follow "Course 1"
+    Then "/descendant::div[@class='activityinstance'][1]//span[@class='lastmodtext oubloglmt']" "xpath_element" should exist
+    And "/descendant::div[@class='activityinstance'][2]//span[@class='lastmodtext oubloglmt']" "xpath_element" should exist
+    And "/descendant::div[@class='activityinstance'][3]//span[@class='lastmodtext oubloglmt']" "xpath_element" should exist
+    And "/descendant::div[@class='activityinstance'][4]//span[@class='lastmodtext oubloglmt']" "xpath_element" should exist
+    And I log out
+    Given I log in as "student1"
+    And I am on site homepage
+    And I follow "Course 1"
+    # Student should see visible indicator only.
+    Then "/descendant::div[@class='activityinstance'][1]//span[@class='lastmodtext oubloglmt']" "xpath_element" should not exist
+    And "/descendant::div[@class='activityinstance'][2]//span[@class='lastmodtext oubloglmt']" "xpath_element" should not exist
+    And "/descendant::div[@class='activityinstance'][3]//span[@class='lastmodtext oubloglmt']" "xpath_element" should not exist
+    And "/descendant::div[@class='activityinstance'][4]//span[@class='lastmodtext oubloglmt']" "xpath_element" should exist
+    Given I follow "B.VISG"
+    And I press "New blog post"
+    And I set the following fields to these values:
+      | Title | P3 |
+      | Message | P3 |
+    And I press "Add post"
+    When I follow "Course 1"
+    Then "/descendant::div[@class='activityinstance'][3]//span[@class='lastmodtext oubloglmt']" "xpath_element" should exist
+    And I log out
+    Given I log in as "student2"
+    And I am on site homepage
+    And I follow "Course 1"
+    # Student should see visible group+individuals only.
+    Then "/descendant::div[@class='activityinstance'][1]//span[@class='lastmodtext oubloglmt']" "xpath_element" should not exist
+    And "/descendant::div[@class='activityinstance'][2]//span[@class='lastmodtext oubloglmt']" "xpath_element" should not exist
+    And "/descendant::div[@class='activityinstance'][3]//span[@class='lastmodtext oubloglmt']" "xpath_element" should not exist
+    And "/descendant::div[@class='activityinstance'][4]//span[@class='lastmodtext oubloglmt']" "xpath_element" should exist
diff --git a/mod/oublog/tests/behat/personalblog.feature b/mod/oublog/tests/behat/personalblog.feature
new file mode 100644
index 0000000..8ab326a
--- /dev/null
+++ b/mod/oublog/tests/behat/personalblog.feature
@@ -0,0 +1,396 @@
+@ou @ou_vle @mod @mod_oublog @oublog_personal
+Feature: Test Post and Comment on Personal OUBlog
+  In order to engage with OUBblog personal posts and comments
+  As an external user
+  I need to be able to see OUBblog personal post entries
+  # Note this test will only pass on OU systems as using an OU custom step.
+
+  @javascript
+  Scenario: Admin edits the blog options
+    Given I log in as "admin"
+    And I am using the OU theme
+    And I am on site homepage
+    And I follow "Personal Blogs"
+    And I follow "Blog options"
+    Then I should see "Blog name"
+    And I should see "Summary"
+    And I set the following fields to these values:
+      | Blog name| Admin User's blog edited |
+      | Summary | SC01 edited the Admin User's summary block |
+    And I press "Save changes"
+    And I should see "Admin User's blog edited"
+    And I should see "SC01 edited the Admin User's summary block"
+
+    # Admin adds posts.
+    Given I press "New blog post"
+    And I should see "New blog post"
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post01 |
+      | Message | Admin Persblog post01 content |
+    And I press "Add post"
+    Then I should see "Personal OUBlog post01"
+    And I should see "Admin Persblog post01 content"
+    And I should see "Visible only to the blog owner (private)"
+    Given I press "New blog post"
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post02 |
+      | Message | Admin Persblog post02 content |
+      | Who can read this | Visible to everyone who is logged in to the system |
+    When I press "Add post"
+    Then I should see "Visible to everyone who is logged in to the system"
+
+    # Admin adds multiple comments.
+    Given I follow "Add your comment"
+    When I set the field "Add your comment" to "$My own >nasty< \"string\"!"
+    And I press "Add comment"
+    Then I should see "Comments" in the ".oublog-commentstitle" "css_element"
+    And I follow "Add your comment"
+    And I set the field "Add your comment" to "Another $Nasty <string?>"
+    And I press "Add comment"
+    And I follow "Admin User's blog edited"
+    Then "2 comments" "link" should exist
+    And I log out (in the OU theme)
+
+    # User not logged in tests visibility of Admin Users personal post.
+    Given I visit the personal blog for "admin"
+    Then "You are not logged in" "text" should exist
+    And I should not see "Personal OUBlog post"
+    And I should not see "Admin User's blog"
+
+    # Check logged-in visibility.
+    Given the following "users" exist:
+      | username | firstname | lastname | email |
+      | student1 | Student | 1 | student1@asd.com |
+
+    Given I log in as "student1"
+    And I visit the personal blog for "admin"
+    Then I should see "Personal OUBlog post02"
+    When I click on "Permalink" "link" in the ".oublog-post .oublog-post-links" "css_element"
+    Then I should see "Personal OUBlog post02"
+    And I should see "Admin User's blog"
+    Given I log out (in the OU theme)
+
+    # Admin changes post to world visibility.
+    Given I log in as "admin"
+    And I am on site homepage
+    And I follow "Personal Blogs"
+    When I click on "Edit" "link" in the ".oublog-post .oublog-post-links" "css_element"
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post01 WorldVis |
+      | Message | Admin Persblog post01 content WorldVis |
+      | Tags | edap01 |
+      | Who can read this | Visible to anyone in the world |
+      | Allow comments | Yes, from everybody (even if not logged in) |
+    And I press "Save changes"
+    And I wait to be redirected
+    Then I should see "Personal OUBlog post01 WorldVis"
+    And I should see "Admin Persblog post01 content WorldVis"
+    And I should see "edap01"
+    And I should see "Total visits to this blog: 3"
+    And I log out (in the OU theme)
+
+    # User not logged in tests Admin Users post and comments.
+    And I wait to be redirected
+    Then "You are not logged in" "text" should exist
+    And I visit the personal blog for "admin"
+    Then I should see "Admin User's blog edited"
+    And I should see "log in for full access"
+    And I should see "Total visits to this blog: 4"
+    Given I follow "2 comments"
+    Then I should see "Personal OUBlog post01 WorldVis"
+    And I should see "Admin Persblog post01 content WorldVis"
+    And I should see "edap01"
+    And I should see "Comments" in the ".oublog-commentstitle" "css_element"
+    And I should see "$My own >nasty< \"string\"!"
+    And I should see "Another $Nasty"
+    Given I follow "Add your comment"
+    And I set the following fields to these values:
+      | Your name | NoLog |
+      | Title | NoLogTitle |
+      | Add your comment | NoLogComent |
+      | Confirmation | yes |
+    When I press "Add comment"
+    Then I should see "Thank you for adding your comment"
+    Given I press "Continue"
+    Then I should see "Comments"
+
+    # Admin confirm moderated comment.
+    Given I log in as "admin"
+    And I am on site homepage
+    And I follow "Personal Blogs"
+    And I follow "2 comments, 1 awaiting approval"
+    When I press "Approve this comment"
+    Then I should see "approved by Admin User"
+    And I should see "NoLogTitle"
+    And I should see "NoLogComent"
+
+    # Pagination on blog view + allposts.
+    Given I follow "Admin User's blog edited"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post02 |
+      | Message | Admin Persblog post02 content |
+      | Who can read this | Visible to anyone in the world |
+    And I press "Add post"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post03 |
+      | Message | Admin Persblog post03 content |
+      | Who can read this | Visible to anyone in the world |
+    And I press "Add post"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post04 |
+      | Message | Admin Persblog post04 content |
+      | Who can read this | Visible to anyone in the world |
+    And I press "Add post"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post05 |
+      | Message | Admin Persblog post05 content |
+      | Who can read this | Visible to anyone in the world |
+    And I press "Add post"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post06 |
+      | Message | Admin Persblog post06 content |
+      | Who can read this | Visible to anyone in the world |
+    And I press "Add post"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post07 |
+      | Message | Admin Persblog post07 content |
+      | Who can read this | Visible to anyone in the world |
+    And I press "Add post"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post08 |
+      | Message | Admin Persblog post08 content |
+      | Who can read this | Visible to anyone in the world |
+    And I press "Add post"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post09 |
+      | Message | Admin Persblog post09 content |
+      | Who can read this | Visible to anyone in the world |
+    And I press "Add post"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post10 |
+      | Message | Admin Persblog post10 content |
+      | Who can read this | Visible to anyone in the world |
+    And I press "Add post"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post11 |
+      | Message | Admin Persblog post11 content |
+      | Who can read this | Visible to anyone in the world |
+    And I press "Add post"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post12 |
+      | Message | Admin Persblog post12 content |
+      | Who can read this | Visible to anyone in the world |
+    And I press "Add post"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post13 |
+      | Message | Admin Persblog post13 content |
+      | Who can read this | Visible to anyone in the world |
+    And I press "Add post"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post14 |
+      | Message | Admin Persblog post14 content |
+      | Who can read this | Visible to anyone in the world |
+    And I press "Add post"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post15 |
+      | Message | Admin Persblog post15 content |
+      | Who can read this | Visible to anyone in the world |
+    And I press "Add post"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post16 |
+      | Message | Admin Persblog post16 content |
+      | Who can read this | Visible to anyone in the world |
+    And I press "Add post"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post17 |
+      | Message | Admin Persblog post17 content |
+      | Who can read this | Visible to anyone in the world |
+    And I press "Add post"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post18 |
+      | Message | Admin Persblog post18 content |
+      | Who can read this | Visible to anyone in the world |
+    And I press "Add post"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post19 |
+      | Message | Admin Persblog post19 content |
+      | Who can read this | Visible to anyone in the world |
+    And I press "Add post"
+    Then ".oublog-paging" "css_element" should not exist
+    Given I press "New blog post"
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post20 |
+      | Message | Admin Persblog post20 content |
+    When I press "Add post"
+    Then ".oublog-paging" "css_element" should exist
+    And I should see "Next" in the ".oublog-paging" "css_element"
+    And I should not see "Previous" in the ".oublog-paging" "css_element"
+    And I click on "2" "link" in the ".oublog-paging" "css_element"
+    Then I should see "Personal OUBlog post01"
+    Given I follow "View site entries"
+    Then I should not see "Personal OUBlog post20"
+    And I should see "Personal OUBlog post19"
+    Given I follow "Admin User's blog edited"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post21 |
+      | Message | Admin Persblog post21 content |
+      | Who can read this | Visible to anyone in the world |
+    And I press "Add post"
+    When I press "New blog post"
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post22 |
+      | Message | Admin Persblog post22 content |
+      | Who can read this | Visible to anyone in the world |
+      | Tags (separated by commas) | Taggy1 |
+    And I press "Add post"
+    And I follow "Next"
+    And I should see "Previous" in the ".oublog-paging" "css_element"
+    And I should not see "Next" in the ".oublog-paging" "css_element"
+    Then I should see "Personal OUBlog post02" in the "div.oublog-post-top-details h2.oublog-title" "css_element"
+    And I should not see "Personal OUBlog post22" in the "div.oublog-post-top-details h2.oublog-title" "css_element"
+
+    # 'Edit' post01 ie 3rd post on the second page
+    And I click on "Edit" "link" in the ".oublog-post:nth-child(3) .oublog-post-links" "css_element"
+    And I wait to be redirected
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post01 edited |
+      | Message | Admin Persblog post01 content edited for return url test|
+    And I press "Save changes"
+    # Confirm return to correct page after edit
+    And I should see "Previous" in the ".oublog-paging" "css_element"
+    And I should not see "Next" in the ".oublog-paging" "css_element"
+    And I should see "Personal OUBlog post02" in the "div.oublog-post-top-details h2.oublog-title" "css_element"
+    And I should not see "Personal OUBlog post22" in the "div.oublog-post-top-details h2.oublog-title" "css_element"
+    # 'Delete' post01, 3rd post on second page
+    And I click on "Delete" "link" in the ".oublog-post:nth-child(3) .oublog-post-links" "css_element"
+    And I wait to be redirected
+    Then I should see "Are you sure you want to delete this post?"
+    Given I press "Cancel"
+    And I wait to be redirected
+    # Confirm return to correct page after cancel
+    And I should see "Previous" in the ".oublog-paging" "css_element"
+    And I should see "Personal OUBlog post02" in the "div.oublog-post-top-details h2.oublog-title" "css_element"
+    And I should not see "Personal OUBlog post22" in the "div.oublog-post-top-details h2.oublog-title" "css_element"
+    And I click on "Delete" "link" in the ".oublog-post:nth-child(3) .oublog-post-links" "css_element"
+    And I press "Delete"
+    And I wait to be redirected
+    # Confirm return to correct page after delete
+    And I should see "Previous" in the ".oublog-paging" "css_element"
+    And I should see "Personal OUBlog post02" in the "div.oublog-post-top-details h2.oublog-title" "css_element"
+    And I should see "Personal OUBlog post01 edited" in the "div.oublog-post.oublog-deleted div.oublog-post-top-details h2.oublog-title" "css_element"
+    And ".oublog-deleted" "css_element" should exist
+    And ".oublog-post-deletedby" "css_element" should exist
+    And I should see "Deleted by"
+    And I follow "View site entries"
+    Then I should see "Personal OUBlog post22"
+    Then I should not see "Personal OUBlog post01 WorldVis"
+    And I should see "Next" in the ".oublog-paging" "css_element"
+    And I should not see "Previous" in the ".oublog-paging" "css_element"
+    Given I follow "taggy1"
+    Then I should see "Personal OUBlog post22"
+    And I should not see "Personal OUBlog post21"
+    And I should not see "Next" in the ".oublog-paging" "css_element"
+    # 'Edit' the "taggy" post22
+    And I click on "Edit" "link" in the ".oublog-post-links" "css_element"
+    And I wait to be redirected
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post22 edited|
+      | Message | Admin Persblog post22 content edited for return url test|
+    And I press "Save changes"
+    # Confirm return to correct page after "taggy" edit
+    Then I should see "Personal OUBlog post22 edited" in the "div.oublog-post-top-details h2.oublog-title" "css_element"
+    And I should not see "Personal OUBlog post21" in the "div.oublog-post-top-details h2.oublog-title" "css_element"
+    And I should not see "Next" in the ".oublog-paging" "css_element"
+
+  # New scenario tests the Socialmedia widgets availability
+  Scenario: Admin tests the blog tweet facility
+    Given I log in as "admin"
+    And I am on site homepage
+    And I follow "Personal Blogs"
+
+    # Admin adds a Private post Tweet not available
+    Given I press "New blog post"
+    And I should see "New blog post"
+    And I set the following fields to these values:
+      | Title | SC02 Personal OUBlog post01 |
+      | Message | SC02 Admin Persblog post01 content Private |
+      | Tags | SC02edap01 |
+      | Who can read this | Visible only to the blog owner (private) |
+    And I press "Add post"
+    Then I should see "SC02 Personal OUBlog post01"
+    And I should see "SC02 Admin Persblog post01 content Private"
+    And I should see "sc02edap01"
+    And I should not see "Share this post"
+    And I should not see "Tweet"
+    And I should not see "Share"
+
+    # Admin adds a WorldVis post and Socialmedia widgets are available
+    Given I press "New blog post"
+    And I should see "New blog post"
+    And I set the following fields to these values:
+      | Title | SC02 Personal OUBlog post02 |
+      | Message | SC02 Admin Persblog post02 content WorldVis |
+      | Tags | SC02edap02 |
+      | Who can read this | Visible to anyone in the world |
+    And I press "Add post"
+    Then I should see "SC02 Personal OUBlog post02"
+    And I should see "SC02 Admin Persblog post02 content WorldVis"
+    And I should see "sc02edap02"
+    # Changed below to make more specific.
+    And I should see "Share post" in the "div.oublog-post-share-title" "css_element"
+    And I should see "Tweet" in the "div.share-button:nth-child(1)" "css_element"
+    And "div.share-button:nth-child(2) div.fb-share-button" "css_element" should exist
+    And "div.share-button:nth-child(3)" "css_element" should exist
+    # Admin opens viewpost page and Socialmedia widgets are available
+    And I click on "Permalink" "link" in the ".oublog-post-links" "css_element"
+    And I wait to be redirected
+    Then I should see "SC02 Personal OUBlog post02"
+    And I should see "SC02 Admin Persblog post02 content WorldVis"
+    And I should see "sc02edap02"
+    And I should see "Share post" in the "div.oublog-post-share-title" "css_element"
+    And I should see "Tweet" in the "div.share-button:nth-child(1)" "css_element"
+    And "div.share-button:nth-child(2) div.fb-share-button" "css_element" should exist
+    And "div.share-button:nth-child(3)" "css_element" should exist
+    And I should not see "SC02 Personal OUBlog post01"
+    And I should not see "SC02 Admin Persblog post01 content Private"
+
+  Scenario: Admin follows the link to the main page and back
+    Given I log in as "admin"
+    And I am on site homepage
+    And I follow "Personal Blogs"
+    And I follow "Blog options"
+    Then I should see "Blog name"
+    And I should see "Summary"
+    And I set the following fields to these values:
+      | Blog name| Admin User's blog follow the link to the main page |
+    When I press "Save changes"
+    Then I should see "Admin User's blog follow the link to the main page"
+    Given I press "New blog post"
+    And I set the following fields to these values:
+      | Title | Personal OUBlog post01 |
+      | Message | Admin Persblog post01 content |
+    When I press "Add post"
+    And I follow "Permalink"
+    Then "#oublog-arrowback" "css_element" should exist
+    And I should see "Admin User's blog follow the link to the main page" in the "#oublog-arrowback" "css_element"
+    Given I click on "#oublog-arrowback a" "css_element"
+    Then "#addpostbutton" "css_element" should exist
diff --git a/mod/oublog/tests/behat/rate_individuals.feature b/mod/oublog/tests/behat/rate_individuals.feature
new file mode 100644
index 0000000..af51ded
--- /dev/null
+++ b/mod/oublog/tests/behat/rate_individuals.feature
@@ -0,0 +1,91 @@
+@ou @ou_vle @mod @mod_oublog @oublog_rate
+Feature: Test rate individual posts
+  In order to provide student grades
+  As a teacher
+  I need to be able to set ratings on individual posts
+
+  Background:
+    Given the following "users" exist:
+      | username | firstname | lastname | email |
+      | teacher1 | Teacher | 1 | teacher1@asd.com |
+      | student1 | Student1 | 1 | student1@asd.com |
+    And the following "courses" exist:
+      | fullname | shortname | category |
+      | Course 1 | C1 | 0 |
+    And the following "course enrolments" exist:
+      | user | course | role |
+      | teacher1 | C1 | editingteacher |
+      | student1 | C1 | student |
+    And the following "activities" exist:
+      | activity | name | intro  | course | idnumber |
+      | oublog | Testing rate individuals posts | Testing separate blogs as multipe users | C1 | oublog1 |
+
+    # Admin changes settings
+    And I log in as "admin"
+    And I am on site homepage
+    And I follow "Course 1"
+    And I follow "Testing rate individuals posts"
+    And I follow "Edit settings"
+    # Maximum points of more than 10 gets very slow
+    And I set the following fields to these values:
+      | Grading | Use ratings |
+      | Aggregate type | Average of ratings |
+      | scale[modgrade_type] | Point |
+      | scale[modgrade_point] | 10 |
+    And I press "Save and display"
+    And I log out
+
+  Scenario: Teacher tests the rate post widget
+    Given I log in as "teacher1"
+    And I am on homepage
+    And I follow "Course 1"
+    And I follow "Testing rate individuals posts"
+    And I press "New blog post"
+    And I should see "New blog post"
+    And I set the following fields to these values:
+      | Title | SC06 teacher post01 |
+      | Message | SC06 teacher post01 content visible to admin and teacher |
+    And I press "Add post"
+    Then I should see "SC06 teacher post01"
+    And I should see "SC06 teacher post01 content visible to admin and teacher"
+    And "span.rating-aggregate-label" "css_element" should exist
+    And I should see "Average of ratings:"
+    And I log out
+
+    # Student1 user posts
+    Given I log in as "student1"
+    And I follow "Course 1"
+    And I follow "Testing rate individuals posts"
+    Given I press "New blog post"
+    And I should see "New blog post"
+    And I set the following fields to these values:
+      | Title | SC06 student1 post01 |
+      | Message | SC06 student1 post01 content |
+    And I press "Add post"
+    And I wait to be redirected
+    Then I should see "SC06 student1 post01"
+    And I should see "SC06 student1 post01 content"
+    And I log out
+
+    # Teacher checks visibility
+    Given I log in as "teacher1"
+    And I am on homepage
+    And I follow "Course 1"
+    And I follow "Testing rate individuals posts"
+    Then I should see "SC06 student1 post01"
+    And I should see "SC06 student1 post01 content"
+    And I should see "SC06 teacher post01"
+    And I should see "SC06 teacher post01 content visible to admin and teacher"
+
+    # Identify rating label & selector for student (wont see teachers selector)
+    And ".rating-aggregate-label" "css_element" should exist
+    And I should see "Average of ratings:"
+    And "//div[@class='oublog-post-rating']/form/div/input[@class='ratinginput']" "xpath_element" should exist
+    And the "rating" select box should contain "0"
+
+   # Teacher sets ratings for student
+   Given I set the field "rating" to "10"
+   And I click on "Rate" "button"
+   Then the "rating" select box should contain "10"
+   And "span.rating-aggregate-label" "css_element" should exist
+   And I should see "Average of ratings: 10 (1)"
diff --git a/mod/oublog/tests/behat/separate_individuals.feature b/mod/oublog/tests/behat/separate_individuals.feature
new file mode 100644
index 0000000..e82e07a
--- /dev/null
+++ b/mod/oublog/tests/behat/separate_individuals.feature
@@ -0,0 +1,123 @@
+@ou @ou_vle @mod @mod_oublog @oublog_separate
+Feature: Test Post and Comment on Seperate Individual Blogs
+  In order to engage with students posts and comments
+  As a teacher
+  I need to be able to see separate individual post entries
+
+  Background:
+    Given the following "users" exist:
+      | username | firstname | lastname | email |
+      | teacher1 | Teacher | 1 | teacher1@asd.com |
+      | student1 | Student1 | 1 | student1@asd.com |
+      | student2 | Student2 | 1 | student1@asd.com |
+    And the following "courses" exist:
+      | fullname | shortname | category |
+      | Course 1 | C1 | 0 |
+    And the following "course enrolments" exist:
+      | user | course | role |
+      | teacher1 | C1 | editingteacher |
+      | student1 | C1 | student |
+      | student2 | C1 | student |
+    And the following "activities" exist:
+      | activity | name | intro  | course | idnumber |
+      | oublog | Testing separate individuals oublogs | Testing separate blogs as multipe users | C1 | oublog1 |
+
+    # Admin changes settings for separate individuals
+    And I log in as "admin"
+    And I am on site homepage
+    And I follow "Course 1"
+    And I follow "Testing separate individuals oublogs"
+    And I follow "Edit settings"
+    And I set the following fields to these values:
+      | Individual blogs | Separate individual blogs |
+    And I press "Save and display"
+    And ".oublog-individualselector" "css_element" should exist
+    And I should see "There are no visible posts in this blog"
+    And I log out
+
+  Scenario: Teacher tests the separate blog visibility
+    Given I log in as "teacher1"
+    And I am on homepage
+    And I follow "Course 1"
+    And I follow "Testing separate individuals oublogs"
+    And I press "New blog post"
+    And I should see "New blog post"
+    And I set the following fields to these values:
+      | Title | SC05 teacher post01 |
+      | Message | SC05 teacher post01 content visible to admin and teacher |
+      | Tags | dtag4sc05, ctag3sc05  |
+    And I press "Add post"
+    Then I should see "SC05 teacher post01"
+    And I should see "SC05 teacher post01 content visible to admin and teacher"
+    Given I follow "Add your comment"
+    And I set the field "Add your comment" to "SC05 Teacher post01 comment visible to admin and teacher"
+    And I press "Add comment"
+    Then I should see "Comments" in the ".oublog-commentstitle" "css_element"
+    And I log out
+
+    # Student1 user posts
+    Given I log in as "student1"
+    And I follow "Course 1"
+    And I follow "Testing separate individuals oublogs"
+    And I should see "There are no visible posts in this blog"
+    Given I press "New blog post"
+    And I should see "New blog post"
+    And I set the following fields to these values:
+      | Title | SC05 student1 post01 |
+      | Message | SC05 student1 post01 content |
+      | Tags | ctag3sc05, btag2sc05 |
+    And I press "Add post"
+    And I wait to be redirected
+    Then I should see "SC05 student1 post01"
+    And I should see "SC05 student1 post01 content"
+    And I should not see "SC05 teacher post01"
+    And I should not see "SC05 teacher post01 content visible to admin and teacher"
+    And I log out
+
+    # Student2 user posts
+    Given I log in as "student2"
+    And I follow "Course 1"
+    And I follow "Testing separate individuals oublogs"
+    Then I should see "There are no visible posts in this blog"
+    Given I press "New blog post"
+    Then I should see "New blog post"
+    Given I set the following fields to these values:
+      | Title | SC05 student2 post01 |
+      | Message | SC05 student2 post01 content |
+      | Tags | btag2sc05, atag1sc05 |
+    And I press "Add post"
+    And I wait to be redirected
+    Then I should see "SC05 student2 post01 "
+    And I should see "SC05 student2 post01 content"
+    And I should not see "SC05 student1 post01"
+    And I should not see "SC05 student1 post01 content"
+    And I should not see "SC05 teacher post01"
+    And I should not see "SC05 teacher post01 content visible to admin and teacher"
+    And I log out
+
+    # Teacher check visibility
+    Given I log in as "teacher1"
+    And I am on homepage
+    And I follow "Course 1"
+    And I follow "Testing separate individuals oublogs"
+    Then I should see "SC05 student2 post01"
+    And I should see "SC05 student2 post01 content"
+    And I should see "SC05 student1 post01"
+    And I should see "SC05 student1 post01 content"
+    And I should see "SC05 teacher post01"
+    And I should see "SC05 teacher post01 content visible to admin and teacher"
+
+    # Should see tags in default Alphabetical order
+    And I should see "atag1sc05(1) btag2sc05(2) ctag3sc05(2) dtag4sc05(1)"
+
+    # Should see posts in the participation block
+    And "Participation" "text" should exist
+    And ".oublogstats_posts_posttitle" "css_element" should exist
+    And I should see "SC05 student2 post01" in the ".oublogstats_posts_posttitle" "css_element"
+    And ".oublog_statsview_innercontent_participation" "css_element" should exist
+    And I should see "Recent posts" in the ".oublog_statsview_innercontent_participation" "css_element"
+    And I should see "Recent comments" in the ".oublog_statsview_innercontent_participation" "css_element"
+    And ".oublogstats_commentposts_posttitle" "css_element" should exist
+    And I should see "Untitled comment" in the ".oublogstats_commentposts_posttitle" "css_element"
+    And ".oublogstats_commentposts_blogname" "css_element" should exist
+    And "View all participation" "link" should exist
diff --git a/mod/oublog/tests/behat/time.period.feature b/mod/oublog/tests/behat/time.period.feature
new file mode 100644
index 0000000..baf0d17
--- /dev/null
+++ b/mod/oublog/tests/behat/time.period.feature
@@ -0,0 +1,99 @@
+@ou @ou_vle @mod @mod_oublog @oublog_time
+Feature: Test time limited posts and comments
+  In order to limit students posts and comments to time periods
+  As a teacher
+  I need to be able to set time limits
+
+  Background:
+    Given the following "users" exist:
+      | username | firstname | lastname | email |
+      | student1 | Student1 | 1 | student1@asd.com |
+    And the following "courses" exist:
+      | fullname | shortname | category |
+      | Course 1 | C1 | 0 |
+    And the following "course enrolments" exist:
+      | user | course | role |
+      | student1 | C1 | student |
+    And the following "activities" exist:
+      | activity | name                   | intro                             | course | idnumber | postfrom   | postuntil  | commentfrom | commentuntil |
+      | oublog   | blog post start past   | A blog when posts start in past   | C1     | oublog1  | 1262307600 | 0          | 1262307600  | 0            |
+      | oublog   | blog post start future | A blog when posts start in future | C1     | oublog2  | 2524611600 | 0          | 2524611600  | 0            |
+      | oublog   | blog post end past     | A blog when posts start in past   | C1     | oublog3  | 0          | 1262307600 | 0           | 1262307600   |
+      | oublog   | blog post end future   | A blog when posts start in future | C1     | oublog4  | 0          | 2524611600 | 0           | 2524611600   |
+    Given I log in as "admin"
+    And I am on site homepage
+    And I follow "Course 1"
+    And I follow "blog post start future"
+    And I press "New blog post"
+    And I set the field "Message" to "Test"
+    And I press "Add post"
+    And I follow "Course 1"
+    And I follow "blog post end past"
+    And I press "New blog post"
+    And I set the field "Message" to "Test"
+    And I press "Add post"
+    And I log out
+
+  Scenario: Admin tests timed blogs
+   Given I log in as "admin"
+   And I am on site homepage
+   And I follow "Course 1"
+   # Test blog1.
+   When I follow "blog post start past"
+   Then I should not see "Students cannot create their own posts until"
+   And I should not see "Students cannot comment on posts until"
+   And "New blog post" "button" should exist
+   Given I follow "Course 1"
+   # Test blog2.
+   When I follow "blog post start future"
+   Then I should see "Students cannot create their own posts until"
+   And I should see "Students cannot comment on posts until"
+   And "New blog post" "button" should exist
+   And "Add your comment" "link" should exist
+   Given I follow "Course 1"
+   # Test blog3.
+   When I follow "blog post end past"
+   Then I should see "Students were able to create their own posts until"
+   And I should see "Students were able to comment on posts until"
+   And "New blog post" "button" should exist
+   And "Add your comment" "link" should exist
+   Given I follow "Course 1"
+   # Test blog4.
+   When I follow "blog post end future"
+   Then I should see "Students are able to create their own posts until"
+   # Test no comment message as no posts.
+   And I should not see "Students are able to comment on posts until"
+   And "New blog post" "button" should exist
+   Given I log out
+
+  Scenario: Admin tests timed blogs
+   Given I log in as "student1"
+   And I am on site homepage
+   And I follow "Course 1"
+   # Test blog1.
+   When I follow "blog post start past"
+   Then I should not see "You cannot create posts at this time"
+   And I should not see "You cannot comment on posts at this time"
+   And "New blog post" "button" should exist
+   Given I follow "Course 1"
+   # Test blog2.
+   When I follow "blog post start future"
+   Then I should see "You cannot create posts at this time"
+   And I should see "You cannot comment on posts at this time"
+   And "New blog post" "button" should not exist
+   And "Add your comment" "link" should not exist
+   Given I follow "Course 1"
+   # Test blog3.
+   When I follow "blog post end past"
+   Then I should see "You cannot create posts at this time"
+   And I should see "You cannot comment on posts at this time"
+   And "New blog post" "button" should not exist
+   And "Add your comment" "link" should not exist
+   Given I follow "Course 1"
+   # Test blog4.
+   When I follow "blog post end future"
+   Then I should see "You can only create posts until"
+   # Test no comment message as no posts.
+   And I should not see "You can only comment on posts until"
+   And "New blog post" "button" should exist
+   Given I follow "Course 1"
diff --git a/mod/oublog/tests/externallib_test.php b/mod/oublog/tests/externallib_test.php
new file mode 100644
index 0000000..c03a993
--- /dev/null
+++ b/mod/oublog/tests/externallib_test.php
@@ -0,0 +1,673 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+global $CFG;
+require_once($CFG->dirroot . '/mod/oublog/tests/oublog_test_lib.php');
+require_once($CFG->dirroot . '/mod/oublog/externallib.php');
+
+class externallib_test extends oublog_test_lib
+{
+    protected $course1;
+    protected $blog;
+
+    private function create_content($instance, $record = array()) {
+        global $USER, $DB, $CFG;
+        require_once($CFG->dirroot . '/mod/oublog/locallib.php');
+
+        $cm = get_coursemodule_from_instance('oublog', $instance->id);
+        $context = context_module::instance($cm->id);
+        $course = get_course($instance->course);
+
+        if (isset($record['comment'])) {
+            if (empty($record['comment']->postid)) {
+                throw new coding_exception('Must pass postid when creating comment');
+            }
+            if (empty($record['comment']->userid)) {
+                $record['comment']->userid = $USER->id;
+            }
+            if (empty($record['comment']->messagecomment)) {
+                if (empty($record['comment']->message)) {
+                    $record['comment']->messagecomment = array('text' => 'Test comment');
+                } else {
+                    // Support message being string to insert in db not form style.
+                    $record['comment']->messagecomment = array('text' => $record['comment']->message);
+                }
+            } else {
+                if (is_string($record['comment']->messagecomment)) {
+                    // Support message being string to insert in db not form style.
+                    $record['comment']->messagecomment = array('text' => $record['comment']->messagecomment);
+                }
+            }
+            return oublog_add_comment($course, $cm, $instance, $record['comment']);
+        }
+        return null;
+    }
+
+    protected function setUp() {
+        $this->resetAfterTest(true);
+
+        $this->course1 = $this->getDataGenerator()->create_course(array(
+            'fullname' => 'Course1',
+            'shortname' => 'C1'
+        ));
+
+        $user = $this->getDataGenerator()->create_user(array('email' => 'user@example.com', 'username' => 'user'));
+        $this->setUser($user);
+    }
+
+    // Test get_user_blogs.
+
+    /**
+     * Empty username.
+     */
+    public function test_get_user_blogs_nousername() {
+        global $USER;
+
+        $blog = $this->get_new_oublog($this->course1->id);
+        $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        $result = mod_oublog_external::get_user_blogs('');
+
+        // Expect return empty because no user name was given.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 0);
+    }
+
+    /**
+     *  Username with special character.
+     */
+    public function test_get_user_blogs_username_with_specialcharacter() {
+        global $USER;
+
+        $blog = $this->get_new_oublog($this->course1->id);
+        $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        // Expect invalid_parameter_exception because the passed username contain special character.
+        $this->setExpectedException('invalid_parameter_exception');
+
+        mod_oublog_external::get_user_blogs('username1****');
+    }
+
+    /**
+     *  Valid username but not existed.
+     */
+    public function test_get_user_blogs_username_valid_notexist() {
+        global $USER;
+
+        $blog = $this->get_new_oublog($this->course1->id);
+        $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        $result = mod_oublog_external::get_user_blogs('username2');
+
+        // Expect return nothing because the user name is not exist.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 0);
+    }
+
+    /**
+     *  Valid username and existed.
+     */
+    public function test_get_user_blogs_username_valid_exist() {
+        global $USER;
+
+        $blog1 = $this->get_new_oublog($this->course1->id,
+            array('name' => 'Blog1', 'individual' => OUBLOG_SEPARATE_INDIVIDUAL_BLOGS));
+        $blog2 = $this->get_new_oublog($this->course1->id,
+            array('name' => 'Blog2', 'individual' => OUBLOG_SEPARATE_INDIVIDUAL_BLOGS));
+        $this->get_new_post($blog1);
+        $this->get_new_post($blog1);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        $result = mod_oublog_external::get_user_blogs($USER->username);
+
+        // Expect return 2 blog and the number of comment of blog1 is 2, blog2 is 0..
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 2);
+        $this->assertEquals($result[0]->cmid, $blog1->cm->id);
+        $this->assertEquals($result[0]->remote, 1);
+        $this->assertEquals($result[0]->numposts, 2);
+        $this->assertEquals($result[1]->cmid, $blog2->cm->id);
+        $this->assertEquals($result[1]->remote, 1);
+        $this->assertEquals($result[1]->numposts, 0);
+    }
+
+    // Test get_blog_posts.
+
+    /**
+     *  Pass empty blogid other field valid and exist.
+     */
+    public function test_get_blog_posts_blogid_empty() {
+        global $USER;
+
+        $blog = $this->get_new_oublog($this->course1->id);
+        $post1id = $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        $result = mod_oublog_external::get_blog_posts(null, $blog->cm->id, $post1id, true, $USER->username);
+
+        // Expect return nothing because blogid as empty.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 0);
+    }
+
+    /**
+     *  Pass blogid as string other field valid and exist.
+     */
+    public function test_get_blog_posts_blogid_as_string() {
+        global $USER;
+
+        $blog = $this->get_new_oublog($this->course1->id);
+        $post1id = $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        // Expect exception because blogid expect integer pass a string.
+        $this->setExpectedException('invalid_parameter_exception');
+
+        mod_oublog_external::get_blog_posts('a', $blog->cm->id, $post1id, true, $USER->username);
+    }
+
+    /**
+     *  Pass empty $bcontextid other field valid and exist.
+     */
+    public function test_get_blog_posts_bcontextid_empty() {
+        global $USER;
+        $blog = $this->get_new_oublog($this->course1->id);
+        $post1id = $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        $result = mod_oublog_external::get_blog_posts($blog->id, null, $post1id, true, $USER->username);
+
+        // Expect return 1 post.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 1);
+        $this->assertEquals($result[$post1id]->id, $post1id);
+    }
+
+    /**
+     *  Pass $bcontextid as string other field valid and exist.
+     */
+    public function test_get_blog_posts_bcontextid_as_string() {
+        global $USER;
+
+        $blog = $this->get_new_oublog($this->course1->id);
+        $post1id = $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        // Expect exception because bcontextid expect integer pass a string.
+        $this->setExpectedException('invalid_parameter_exception');
+
+        mod_oublog_external::get_blog_posts($blog->id, 'a', $post1id, true, $USER->username);
+    }
+
+    /**
+     *  Pass empty selected other field valid and exist.
+     */
+    public function test_get_blog_posts_selected_empty() {
+        global $USER;
+        $blog = $this->get_new_oublog($this->course1->id);
+        $post1id = $this->get_new_post($blog);
+        $post1id = $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        $result = mod_oublog_external::get_blog_posts($blog->id, $blog->cm->id, null, true, $USER->username);
+
+        // Expect return all (2 posts).
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 2);
+    }
+
+    /**
+     *  Pass selected contain character other than number and comma other field valid and exist.
+     */
+    public function test_get_blog_posts_selected_special_character() {
+        global $USER;
+        $blog = $this->get_new_oublog($this->course1->id);
+        $post1id = $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        // Expect exception.
+        $this->setExpectedException('invalid_parameter_exception');
+
+        mod_oublog_external::get_blog_posts($blog->id, $blog->cm->id, '1,2;3', true, $USER->username);
+    }
+
+    /**
+     *  Pass not existed postid other field valid and exist.
+     */
+    public function test_get_blog_posts_selected_not_exist() {
+        global $USER;
+        $blog = $this->get_new_oublog($this->course1->id);
+        $post1id = $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        $result = mod_oublog_external::get_blog_posts($blog->id, $blog->cm->id, '1,2,3', true, $USER->username);
+
+        // Expect no data return.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 0);
+    }
+
+    /**
+     *  Pass empty inccomments, other field valid and exist
+     */
+    public function test_get_blog_posts_selected_inccomments_empty() {
+        global $USER;
+        $blog = $this->get_new_oublog($this->course1->id);
+        $post1id = $this->get_new_post($blog);
+        $comment1 = $this->get_comment_stub($post1id, $USER->id);
+        $comment2 = $this->get_comment_stub($post1id, $USER->id);
+        $this->create_content($blog, array('comment' => (object)clone $comment1));
+        $this->create_content($blog, array('comment' => (object)clone $comment2));
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        $result = mod_oublog_external::get_blog_posts($blog->id, $blog->cm->id, $post1id, null, $USER->username);
+
+        // Expect return 1 post with no comment.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 1);
+        $this->assertEquals($result[$post1id]->id, $post1id);
+        $this->assertEquals(count($result[$post1id]->comments), 0);
+    }
+
+    /**
+     *  Pass inccomments = false, other field valid and exist
+     */
+    public function test_get_blog_posts_selected_inccomments_false() {
+        global $USER;
+        $blog = $this->get_new_oublog($this->course1->id);
+        $post1id = $this->get_new_post($blog);
+        $comment1 = $this->get_comment_stub($post1id, $USER->id);
+        $comment2 = $this->get_comment_stub($post1id, $USER->id);
+        $this->create_content($blog, array('comment' => (object)clone $comment1));
+        $this->create_content($blog, array('comment' => (object)clone $comment2));
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        $result = mod_oublog_external::get_blog_posts($blog->id, $blog->cm->id, $post1id, false, $USER->username);
+
+        // Expect return 1 post with no comment.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 1);
+        $this->assertEquals($result[$post1id]->id, $post1id);
+        $this->assertEquals(count($result[$post1id]->comments), 0);
+    }
+
+    /**
+     *  Pass inccomments = true, other field valid and exist
+     */
+    public function test_get_blog_posts_selected_inccomments_true() {
+        global $USER;
+        $blog = $this->get_new_oublog($this->course1->id);
+        $post1id = $this->get_new_post($blog);
+        $comment1 = $this->get_comment_stub($post1id, $USER->id);
+        $comment2 = $this->get_comment_stub($post1id, $USER->id);
+        $this->create_content($blog, array('comment' => (object)clone $comment1));
+        $this->create_content($blog, array('comment' => (object)clone $comment2));
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        $result = mod_oublog_external::get_blog_posts($blog->id, $blog->cm->id, $post1id, true, $USER->username);
+
+        // Expect return 1 post with 2 comments.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 1);
+        $this->assertEquals($result[$post1id]->id, $post1id);
+        $this->assertEquals(count($result[$post1id]->comments), 2);
+    }
+
+    /**
+     *  Pass empty username, other field valid and exist
+     */
+    public function test_get_blog_posts_username_empty() {
+        global $USER;
+        $blog = $this->get_new_oublog($this->course1->id);
+        $post1id = $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        $result = mod_oublog_external::get_blog_posts($blog->id, $blog->cm->id, $post1id, true, null);
+
+        // Expect return nothing.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 0);
+    }
+
+    /**
+     *  Pass not existed username, other field valid and exist
+     */
+    public function test_get_blog_posts_username_not_exist() {
+        global $USER;
+        $blog = $this->get_new_oublog($this->course1->id);
+        $post1id = $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        $result = mod_oublog_external::get_blog_posts($blog->id, $blog->cm->id, $post1id, true, 'username2');
+
+        // Expect return nothing.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 0);
+    }
+
+    /**
+     *  Pass username contain special character, other field valid and exist
+     */
+    public function test_get_blog_posts_username_with_special_characters() {
+        global $USER;
+        $blog = $this->get_new_oublog($this->course1->id);
+        $post1id = $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        // Expect exception.
+        $this->setExpectedException('invalid_parameter_exception');
+
+        mod_oublog_external::get_blog_posts($blog->id, $blog->cm->id, $post1id, true, 'username1&');
+    }
+
+    // Test get_blog_allposts.
+
+    /**
+     *  Pass empty blogid, other field valid and exist.
+     */
+    public function test_get_blog_allposts_empty_blogid() {
+        global $USER;
+
+        $blog = $this->get_new_oublog($this->course1->id);
+        $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        $result = mod_oublog_external::get_blog_allposts(null, 'timeposted DESC', $USER->username);
+        // Expect return no post because blogid is null.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result['posts']), 0);
+    }
+
+    /**
+     *  Pass blogid as string, other field valid and exist.
+     */
+    public function test_get_blog_allposts_blogid_as_string() {
+        global $USER;
+
+        $blog = $this->get_new_oublog($this->course1->id);
+        $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        // Expect exception because blogid expect int but pass string.
+        $this->setExpectedException('invalid_parameter_exception');
+        mod_oublog_external::get_blog_allposts('string', 'timeposted DESC', $USER->username);
+    }
+
+    /**
+     *  Pass blogid valid but not exist, other field valid and exist.
+     */
+    public function test_get_blog_allposts_blogid_not_exist() {
+        global $USER;
+
+        $blog = $this->get_new_oublog($this->course1->id);
+        $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        $result = mod_oublog_external::get_blog_allposts(-1, 'timeposted DESC', $USER->username);
+        // Expect return no post because blogid not exist.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result['posts']), 0);
+    }
+
+    /**
+     *  Pass empty sort, other field valid and exist.
+     */
+    public function test_get_blog_allposts_empty_sort() {
+        global $USER;
+
+        $blog = $this->get_new_oublog($this->course1->id);
+        $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        // Expect exception because sort expect not null but pass empty.
+        $this->setExpectedException('dml_read_exception');
+        mod_oublog_external::get_blog_allposts($blog->id, null, $USER->username);
+    }
+
+    /**
+     *  Pass sort as int, other field valid and exist.
+     */
+    public function test_get_blog_allposts_sort_as_int() {
+        global $USER;
+
+        $blog = $this->get_new_oublog($this->course1->id);
+        $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        // Expect exception because sort expect text but pass int.
+        $this->setExpectedException('dml_read_exception');
+        mod_oublog_external::get_blog_allposts($blog->id, 1, $USER->username);
+    }
+
+    /**
+     *  Pass empty username, other field valid and exist.
+     */
+    public function test_get_blog_allposts_empty_username() {
+        global $USER;
+
+        $blog = $this->get_new_oublog($this->course1->id);
+        $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        // Expect no data return because username is empty.
+        $result = mod_oublog_external::get_blog_allposts($blog->id, 'timeposted DESC', '');
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 0);
+    }
+
+    /**
+     *  Pass username with special character, other field valid and exist.
+     */
+    public function test_get_blog_allposts_username_with_special_character() {
+        global $USER;
+
+        $blog = $this->get_new_oublog($this->course1->id);
+        $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        // Expect exception because username have special character.
+        $this->setExpectedException('invalid_parameter_exception');
+        mod_oublog_external::get_blog_allposts($blog->id, 'timeposted DESC', 'user$');
+    }
+
+    /**
+     *  Pass username valid but not exist, other field valid and exist.
+     */
+    public function test_get_blog_allposts_username_not_exist() {
+        global $USER;
+
+        $blog = $this->get_new_oublog($this->course1->id);
+        $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        // Expect no data return because username not exist.
+        $result = mod_oublog_external::get_blog_allposts($blog->id, 'timeposted DESC', 'user1');
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 0);
+    }
+
+    /**
+     *  Pass page as string, other field valid and exist.
+     */
+    public function test_get_blog_allposts_page_as_string() {
+        global $USER;
+
+        $blog = $this->get_new_oublog($this->course1->id);
+        $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        // Expect exception because page expect int but pass string.
+        $this->setExpectedException('invalid_parameter_exception');
+        mod_oublog_external::get_blog_allposts($blog->id, 'timeposted DESC', $USER->username, 'string');
+    }
+
+    /**
+     *  Pass tags not in format sequence type, other field valid and exist.
+     */
+    public function test_get_blog_allposts_tags_not_sequence_type() {
+        global $USER;
+
+        $blog = $this->get_new_oublog($this->course1->id);
+        $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        // Expect exception because tags not in format sequence type.
+        $this->setExpectedException('invalid_parameter_exception');
+        mod_oublog_external::get_blog_allposts($blog->id, 'timeposted DESC', $USER->username, 0, '1.2.3');
+    }
+
+    /**
+     *  Pass all field valid and exist.
+     */
+    public function test_get_blog_allposts_all_field_valid_and_exist() {
+        global $USER;
+
+        $blog = $this->get_new_oublog($this->course1->id);
+        $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        // Expect return 1 post.
+        $result = mod_oublog_external::get_blog_allposts($blog->id, 'timeposted DESC', $USER->username);
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result['posts']), 1);
+        $this->assertEquals($result['total'], 1);
+    }
+
+    // Test get_blog_info.
+
+    /**
+     *  Pass empty cmid, other field valid and exist.
+     */
+    public function test_get_blog_info_nocmid() {
+        global $USER;
+
+        $blog = $this->get_new_oublog($this->course1->id);
+        $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        $result = mod_oublog_external::get_blog_info(null, $USER->id);
+        // Expect return nothing because cmid is null.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 0);
+    }
+
+    /**
+     *  Pass cmid as string, other field valid and exist.
+     */
+    public function test_get_blog_info_cmid_as_string() {
+        global $USER;
+
+        $blog = $this->get_new_oublog($this->course1->id);
+        $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        // Expect exception because cmid expect int but pass string.
+        $this->setExpectedException('invalid_parameter_exception');
+
+        mod_oublog_external::get_blog_info('some string', $USER->id);
+    }
+
+    /**
+     *  Pass cmid valid but not exist, other field valid and exist.
+     */
+    public function test_get_blog_info_cmid_not_exist() {
+        global $USER;
+
+        $blog = $this->get_new_oublog($this->course1->id);
+        $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        $result = mod_oublog_external::get_blog_info(-1, $USER->id);
+
+        // Expect return nothing because cmid is not exist.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 0);
+    }
+
+    /**
+     * Pass empty username, other field valid and exist.
+     */
+    public function test_get_blog_info_empty_username() {
+        global $USER;
+
+        $blog = $this->get_new_oublog($this->course1->id);
+        $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        $result = mod_oublog_external::get_blog_info($blog->cm->id, '');
+
+        // Expect return nothing because cmid is not exist.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 0);
+    }
+
+    /**
+     * Pass username which contain special characters, other field valid and exist.
+     */
+    public function test_get_blog_info_username_with_special_characters() {
+        global $USER;
+
+        $blog = $this->get_new_oublog($this->course1->id);
+        $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        // Expect exception because username contain special characters.
+        $this->setExpectedException('invalid_parameter_exception');
+
+        mod_oublog_external::get_blog_info($blog->cm->id, 'username1&');
+    }
+
+    /**
+     *  Pass username valid but not exist, other field valid and exist.
+     */
+    public function test_get_blog_info_username_not_exist() {
+        global $USER;
+
+        $blog = $this->get_new_oublog($this->course1->id);
+        $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        $result = mod_oublog_external::get_blog_info($blog->cm->id, 'username2');
+
+        // Expect return nothing because username is not exist.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 0);
+    }
+
+    /**
+     *  Pass all field valid and exist.
+     */
+    public function test_get_blog_info_username_all_valid() {
+        global $USER;
+
+        $blog = $this->get_new_oublog($this->course1->id,
+            array('name' => 'Blog2', 'individual' => OUBLOG_SEPARATE_INDIVIDUAL_BLOGS));
+        $this->get_new_post($blog);
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        $result = mod_oublog_external::get_blog_info($blog->cm->id, $USER->username);
+        // Expect return blog info.
+        $this->assertNotNull($result);
+        $this->assertEquals($result['bcmid'], $blog->cm->id);
+        $this->assertEquals($result['boublogid'], $blog->id);
+        $this->assertEquals($result['boublogname'],
+        $this->course1->shortname . ' ' . $this->course1->fullname . ' : ' . $blog->name);
+        $this->assertEquals($result['bcoursename'], $this->course1->shortname);
+    }
+}
\ No newline at end of file
diff --git a/mod/oublog/tests/generator/lib.php b/mod/oublog/tests/generator/lib.php
new file mode 100644
index 0000000..eb80503
--- /dev/null
+++ b/mod/oublog/tests/generator/lib.php
@@ -0,0 +1,149 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * OUBLOG data generator
+ *
+ * @package    mod_oublog
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+
+/**
+ * oublog module data generator class
+ *
+ * @package    mod_oublog
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+class mod_oublog_generator extends testing_module_generator {
+
+    private $modcount = 0;
+
+    public function reset() {
+        $this->modcount = 0;
+        parent::reset();
+    }
+
+    public function create_instance($record = null, array $options = null) {
+        global $CFG, $SITE;
+        require_once($CFG->dirroot . '/mod/oublog/locallib.php');
+
+        $record = (object)(array)$record;
+
+        if (empty($record->course)) {
+            mtrace('Called mod_oublog generator create_instance() without $record->course.');
+            $record->course = $SITE;
+        }
+
+        if (!isset($record->maxvisibility) && !isset($options['maxvisibility'])) {
+            $record->maxvisibility = OUBLOG_VISIBILITY_COURSEUSER;
+        }
+        if (!isset($record->allowcomments) && !isset($options['allowcomments'])) {
+            $record->allowcomments = 1;
+        }
+        if (!isset($record->individual) && !isset($options['individual'])) {
+            $record->individual = OUBLOG_NO_INDIVIDUAL_BLOGS;
+        }
+        $this->modcount++;
+
+        if (!isset($record->name) && !isset($options['name'])) {
+            $record->name = 'OUBLOG' . $this->modcount;
+        } else if (isset($options['name'])) {
+            $record->name = $options['name'];// Name must be in $record.
+        }
+        if (!isset($record->grade) && !isset($options['grade'])) {
+            $record->grade = 0;
+        }
+        if (!isset($record->scale) && !isset($options['scale'])) {
+            $record->scale = 0;
+        }
+        if (!isset($record->grading) && !isset($options['grading'])) {
+            $record->grading = 0;
+        }
+        return parent::create_instance($record, (array)$options);
+    }
+
+    public function create_content($instance, $record = array()) {
+        global $USER, $DB, $CFG;
+        require_once($CFG->dirroot . '/mod/oublog/locallib.php');
+        // Send $record['post'] (object) or $record['comment'] (object).
+        // Returns id of post/comment created.
+
+        $cm = get_coursemodule_from_instance('oublog', $instance->id);
+        $context = context_module::instance($cm->id);
+        $course = get_course($instance->course);
+
+        // Default add a default post if nothing sent.
+        if (!isset($record['post']) && !isset($record['comment'])) {
+            $record['post'] = new stdClass();
+        }
+
+        if (isset($record['post'])) {
+            if (empty($record['post']->userid)) {
+                $record['post']->userid = $USER->id;
+            }
+            if (empty($record['post']->oublogid)) {
+                $record['post']->oublogid = $instance->id;
+            }
+            if (empty($record['post']->message)) {
+                $record['post']->message = array('text' => 'Test post');
+            } else if (is_string($record['post']->message)) {
+                // Support message being string to insert in db not form style.
+                $record['post']->message = array('text' => $record['post']->message);
+            }
+            if (empty($record['post']->message['itemid'])) {
+                // Draft files won't work anyway as no editor - so set to 1.
+                $record['post']->message['itemid'] = 1;
+            }
+            if (empty($record['post']->allowcomments)) {
+                $record['post']->allowcomments = OUBLOG_COMMENTS_ALLOW;
+            }
+            if (empty($record['post']->title)) {
+                $record['post']->title = '';
+            }
+            // Force attachments to be empty as will not work.
+            $record['post']->attachments = null;
+            if ($USER->id === 0) {
+                mtrace('oublog_add_post() will error as you must be a valid user to add a post');
+            }
+            return oublog_add_post($record['post'], $cm, $instance, $course);
+        } else if (isset($record['comment'])) {
+            if (empty($record['comment']->postid)) {
+                throw new coding_exception('Must pass postid when creating comment');
+            }
+            if (empty($record['comment']->userid)) {
+                $record['comment']->userid = $USER->id;
+            }
+            if (empty($record['comment']->messagecomment)) {
+                if (empty($record['comment']->message)) {
+                    $record['comment']->messagecomment = array('text' => 'Test comment');
+                } else {
+                    // Support message being string to insert in db not form style.
+                    $record['comment']->messagecomment = array('text' => $record['comment']->message);
+                }
+            } else if (is_string($record['post']->messagecomment)) {
+                // Support message being string to insert in db not form style.
+                $record['comment']->messagecomment = array('text' => $record['comment']->messagecomment);
+            }
+            return oublog_add_comment($course, $cm, $instance, $record['comment']);
+        }
+    }
+
+}
diff --git a/mod/oublog/tests/generator_test.php b/mod/oublog/tests/generator_test.php
new file mode 100644
index 0000000..62fd422
--- /dev/null
+++ b/mod/oublog/tests/generator_test.php
@@ -0,0 +1,124 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Unit tests testing oublog generator.
+ *
+ * @package    mod_oublog
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+
+if (!defined('MOODLE_INTERNAL')) {
+    die('Direct access to this script is forbidden.');// It must be included from a Moodle page.
+}
+global $CFG;
+require_once($CFG->dirroot . '/mod/oublog/tests/oublog_test_lib.php');
+require_once($CFG->dirroot . '/mod/oublog/locallib.php');
+
+class oublog_generator_test extends oublog_test_lib {
+
+    public function test_create_instance() {
+        $this->resetAfterTest(true);
+        // Test calling direct.
+        $options = new stdClass();
+        $options->course = $this->getDataGenerator()->create_course();
+        $generator = $this->getDataGenerator()->get_plugin_generator('mod_oublog');
+        $oublog = $generator->create_instance($options);
+        $this->assertNotEmpty($oublog);
+        $cm = get_coursemodule_from_instance('oublog', $oublog->id);
+        $this->assertNotEmpty($cm);
+        $this->assertEquals($oublog->id, $cm->instance);
+        $this->assertEquals($oublog->cmid, $cm->id);
+
+        // Test calling using oublog_test_lib.
+        $courseid = $this->get_new_course();
+        $blog = $this->get_new_oublog($courseid);
+        $this->assertNotEmpty($blog);
+        $this->assertNotEmpty($blog->cm);
+        $this->assertEquals($blog->id, $blog->cm->instance);
+
+        // Try setting some options and ensuring they get saved correctly.
+        $options->maxvisibility = OUBLOG_VISIBILITY_PUBLIC;
+        $options->allowcomments = 1;
+        $options->grade = 100;
+        $options->individual = OUBLOG_VISIBLE_INDIVIDUAL_BLOGS;
+        $options->displayname = 'LOG';
+        $options->statblockon = 1;
+        $options->allowimport = 1;
+        $options->groupmode = VISIBLEGROUPS;
+        $oublog = $generator->create_instance($options);
+        $this->assertNotEmpty($oublog);
+        $this->assertEquals($options->individual, $oublog->individual);
+        $this->assertEquals($options->displayname, $oublog->displayname);
+        $this->assertEquals($options->statblockon, $oublog->statblockon);
+        $this->assertEquals($options->allowimport, $oublog->allowimport);
+        $this->assertEquals($options->grade, $oublog->grade);
+        $cm = get_coursemodule_from_instance('oublog', $oublog->id);
+        $this->assertNotEmpty($cm);
+        $this->assertEquals($oublog->id, $cm->instance);
+        $this->assertEquals($options->groupmode, $cm->groupmode);
+    }
+
+    public function test_create_content() {
+        global $USER, $DB;
+        $this->resetAfterTest(true);
+        $this->setAdminUser();
+
+        $generator = $this->getDataGenerator()->get_plugin_generator('mod_oublog');
+        $options = new stdClass();
+        $options->course = $this->getDataGenerator()->create_course();
+        $oublog = $generator->create_instance($options);
+        $postid = $generator->create_content($oublog);
+
+        $post = oublog_get_post($postid);
+        $this->assertInstanceOf('stdClass', $post);
+        $this->assertEquals($USER->id, $post->userid);
+        // Try making post with basic options.
+        $postid = $generator->create_content($oublog, array('post' => (object) array('message' => 'testing')));
+
+        $post = $DB->get_record('oublog_posts', array('id' => $postid));
+        $this->assertInstanceOf('stdClass', $post);
+        $this->assertEquals('testing', $post->message);
+
+        // Test calling using oublog_test_lib inc attachments.
+        $postid = $this->get_new_post($oublog);
+        $post = $DB->get_record('oublog_posts', array('id' => $postid));
+        $this->assertInstanceOf('stdClass', $post);
+
+        $postid = $this->get_new_post($oublog, (object) array('attachments' => array('tst.txt' => 'abcd')));
+        $fs = get_file_storage();
+        $file = $fs->get_file_by_id($DB->get_field('files', 'id', array('component' => 'mod_oublog', 'filename' => 'tst.txt')));
+        $this->assertInstanceOf('stored_file', $file);
+        $this->assertEquals('tst.txt', $file->get_filename());
+
+        // Add an invalid comment and test exception.
+        try {
+            $commentid = $generator->create_content($oublog, array('comment' => (object) array()));
+            $this->fail('Exception expected as no post id sent when adding comment');
+        } catch (coding_exception $e) {
+            $this->assertEquals('Must pass postid when creating comment', $e->a);
+        }
+        // Add comment.
+        $options = (object) array('postid' => $postid, 'message' => 'test');
+        $commentid = $generator->create_content($oublog, array('comment' => $options));
+        $comment = $DB->get_record('oublog_comments', array('id' => $commentid));
+        $this->assertInstanceOf('stdClass', $comment);
+        $this->assertEquals('test', $comment->message);
+    }
+
+}
diff --git a/mod/oublog/tests/locallib_test.php b/mod/oublog/tests/locallib_test.php
new file mode 100644
index 0000000..ed66d40
--- /dev/null
+++ b/mod/oublog/tests/locallib_test.php
@@ -0,0 +1,1572 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Unit tests testing locallib functions inc access etc.
+ * To test all unit tests in this folder use cmd:
+ * find mod/oublog/tests/*_test.php -type f -print | xargs -n1 vendor/bin/phpunit --debug
+ *
+ * @package    mod_oublog
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+
+if (!defined('MOODLE_INTERNAL')) {
+    die('Direct access to this script is forbidden.');// It must be included from a Moodle page.
+}
+global $CFG;
+require_once($CFG->dirroot . '/mod/oublog/tests/oublog_test_lib.php');
+require_once($CFG->dirroot . '/mod/oublog/locallib.php');
+
+class oublog_locallib_test extends oublog_test_lib {
+
+    public $userid;
+    public $modules = array();
+    public $usercount = 0;
+
+    /*
+
+    Unit tests cover:
+    * Adding posts
+    * Adding comments
+    * Getting a single post
+    * Getting a list of posts
+    * Tags
+    * Time limited posting
+    * Last modified
+
+    // TODO: Unit tests do NOT cover:
+     * Personal blog auto creation on install has worked
+     * Access permissions (oublog_check_view_permissions + oublog_can_view_post, oublog_can_post + oublog_can_comment)
+     * Post edits (+ history)
+     * oublog_get_typical_approval_time() + oublog_too_many_comments_from_ip() [moderated comments]
+     * Usage stats block functions
+     * Importing posts (inc webservices + attachments)
+     * Portfolio exporting (Can unit test this?)
+     * Feeds
+     * Post reporting (OU alerts)
+     * Deleting a Post (inc email) - there is no back end function for this, the code is inline
+     * Deleting blog (and checking no data left behind)
+    */
+
+    public function test_oublog_add_post() {
+        global $SITE, $USER;
+        $this->resetAfterTest(true);
+        $this->setAdminUser();
+
+        // Whole course.
+        $course = $this->get_new_course();
+
+        $oublog = $this->get_new_oublog($course->id);
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+
+        // Whole course - basic post.
+        $poststub = $this->get_post_stub($oublog->id);
+
+        $postid = oublog_add_post(clone $poststub, $cm, $oublog, $course);
+        $this->assertTrue(is_int($postid));
+
+        $retpost = oublog_get_post($postid);
+        $this->assertInstanceOf('stdClass', $retpost);
+
+        $this->assertEquals($poststub->message['text'], $retpost->message);
+        $this->assertEquals($poststub->title, $retpost->title);
+        $this->assertEquals(fullname($USER), fullname($retpost));
+
+        // Personal blog.
+        $oublog = $this->get_new_oublog($SITE->id, array('global' => 1, 'visibility' => OUBLOG_VISIBILITY_PUBLIC));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+
+        // Personal - basic post.
+        $poststub = $this->get_post_stub($oublog->id);
+        $postid = oublog_add_post(clone $poststub, $cm, $oublog, $SITE);
+        $this->assertTrue(is_int($postid));
+        $retpost = oublog_get_post($postid);
+        $this->assertInstanceOf('stdClass', $retpost);
+        $this->assertEquals($poststub->message['text'], $retpost->message);
+        $this->assertEquals($poststub->title, $retpost->title);
+        $this->assertEquals(fullname($USER), fullname($retpost));
+    }
+
+    /* test_oublog_add_comment */
+    public function test_oublog_add_comment() {
+        global $SITE, $USER, $DB;
+        $this->resetAfterTest(true);
+        $this->setAdminUser();
+
+        // Test comment using Personal blog.
+        $oublog = $this->get_new_oublog($SITE->id, array('global' => 1, 'visibility' => OUBLOG_VISIBILITY_PUBLIC));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+
+        $post = $this->get_post_stub($oublog->id);
+        $postid = oublog_add_post($post, $cm, $oublog, $SITE);
+
+        $comment = new stdClass();
+        $comment->title = 'Test Comment';
+        $comment->messagecomment = array();
+        $comment->messagecomment['text'] = 'Message for test comment';
+        $comment->postid = $postid;
+        $comment->userid = $USER->id;
+
+        $commentid = oublog_add_comment($SITE, $cm, $oublog, $comment);
+        $this->assertTrue(is_int($commentid));
+        // Get post with comments to check created correctly.
+        $post = oublog_get_post($postid);
+        $this->assertNotEmpty($post->comments);
+        $this->assertTrue(array_key_exists($commentid, $post->comments));
+        $this->assertEquals($comment->message, $post->comments[$commentid]->message);
+        $this->assertEquals($comment->title, $post->comments[$commentid]->title);
+        $this->assertEquals(fullname($USER), fullname($post->comments[$commentid]));
+
+        // Check $canaudit sees deleted comments (and other users don't).
+        $DB->update_record('oublog_comments', (object) array('id' => $commentid, 'deletedby' => $USER->id));
+        $post = oublog_get_post($postid, true);
+        $this->assertNotEmpty($post->comments);
+        $post = oublog_get_post($postid);
+        $this->assertFalse(isset($post->comments));
+
+        // Check moderated (not logged-in comments).
+        $bloginstance = $DB->get_record('oublog_instances', array('id' => $post->oubloginstancesid));
+        $adminid = $USER->id;
+        $this->setGuestUser();
+        $this->assertFalse(oublog_too_many_comments_from_ip());
+        $modcomment = new stdClass();
+        $modcomment->messagecomment = 'TEST';
+        $modcomment->title = 'TITLE';
+        $modcomment->postid = $postid;
+        $modcomment->authorname = 'Unittest';
+
+        // Catch email sent.
+        unset_config('noemailever');
+        $sink = $this->redirectEmails();
+        // Update our admin user email as default is blank.
+        $DB->update_record('user', (object) array('id' => $adminid, 'email' => 'no-reply@www.example.com'));
+
+        $result = oublog_add_comment_moderated($oublog, $bloginstance, $post, $modcomment);
+        $messages = $sink->get_messages();
+        $this->assertTrue($result);
+        $this->assertEquals(1, count($messages));
+
+        $modcomment = $DB->get_record('oublog_comments_moderated', array('postid' => $postid));
+        $this->assertInstanceOf('stdClass', $modcomment);
+        $id = oublog_approve_comment($modcomment, true);
+        $this->assertTrue(is_int($id));
+        $saved = $DB->get_record('oublog_comments', array('authorname' => $modcomment->authorname));
+        $this->assertInstanceOf('stdClass', $saved);
+
+        // Check post without allowcomments returns no comments (even if added already).
+        $DB->update_record('oublog_posts', (object) array('id' => $postid, 'allowcomments' => 0));
+        $post = oublog_get_post($postid);
+        $this->assertFalse(isset($post->comments));
+    }
+
+    /*
+     Test getting mulitple posts
+    */
+    public function test_oublog_get_posts_course() {
+        global $SITE, $USER, $DB;
+        $this->resetAfterTest(true);
+        $this->setAdminUser();
+
+        $course = $this->get_new_course();
+        // Test posts using standard course blog.
+        $oublog = $this->get_new_oublog($course->id);
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+
+        $postcount = 3; // Number of posts to test.
+
+        $titlecheck = 'test_oublog_get_posts';
+
+        // First make sure we have some posts to use.
+        $posthashes = array();
+        for ($i = 1; $i <= $postcount; $i++) {
+            $posthashes[$i] = $this->get_post_stub($oublog->id);
+            $posthashes[$i]->title = $titlecheck . '_' . $i;
+        }
+
+        // Create the posts - assumes oublog_add_post is working.
+        $postids = array();
+        foreach ($posthashes as $posthash) {
+            $postids[] = oublog_add_post($posthash, $cm, $oublog, $course);
+        }
+
+        // Get a list of the posts.
+        $context = context_module::instance($cm->id);
+
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, 0);
+
+        // Same name of records returned that were added?
+        $this->assertEquals($postcount, $recordcount);
+
+        // First post returned should match the last one added.
+        $this->assertEquals($titlecheck . '_' . $postcount, $posts[max($postids)]->title);
+        // Check fullname details returned for post author.
+        $this->assertEquals(fullname($USER), fullname($posts[max($postids)]));
+
+        // Check deleted posts not shown.
+        $deleteinfo = new stdClass();
+        $deleteinfo->deletedby = $USER->id;
+        $deleteinfo->id = $posts[max($postids)]->id;
+        $DB->update_record('oublog_posts', $deleteinfo);
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, 0);
+        $this->assertEquals($postcount, $recordcount);// User should see own deleted posts.
+
+        $user = $this->get_new_user('student', $course->id);
+        $this->setUser($user);
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, 0);
+        $this->assertEquals($postcount - 1, $recordcount);// User should not see deleted posts.
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, 0, -1, null, '', true);
+        $this->assertEquals($postcount, $recordcount);// User should see deleted posts as can audit.
+    }
+
+    public function test_oublog_get_posts_group() {
+        global $SITE, $USER, $DB;
+        $this->resetAfterTest(true);
+        $this->setAdminUser();
+
+        $course = $this->get_new_course();
+        $groups = array();
+        // Test posts using standard course group blog.
+        $oublog = $this->get_new_oublog($course->id, array('groupmode' => SEPARATEGROUPS));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+
+        $postcount = 3; // Number of posts to test.
+
+        $titlecheck = 'test_oublog_get_posts';
+
+        // First make sure we have some posts to use.
+        $posthashes = array();
+        for ($i = 1; $i <= $postcount; $i++) {
+            $posthashes[$i] = $this->get_post_stub($oublog->id);
+            $posthashes[$i]->title = $titlecheck . '_' . $i;
+            $group = $this->get_new_group($course->id);
+            $groups[$i] = $group->id;
+            $posthashes[$i]->groupid = $group->id;
+        }
+
+        // Create the posts - assumes oublog_add_post is working.
+        $postids = array();
+        foreach ($posthashes as $posthash) {
+            $postids[] = oublog_add_post($posthash, $cm, $oublog, $course);
+        }
+
+        // Get a list of the posts.
+        $context = context_module::instance($cm->id);
+
+        // All groups.
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, 0);
+
+        // Same name of records returned that were added?
+        $this->assertEquals($postcount, $recordcount);
+
+        // First post returned should match the last one added.
+        $this->assertEquals($titlecheck . '_' . $postcount, $posts[max($postids)]->title);
+
+        // Specific (last) group.
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, $groups[count($groups)]);
+        $this->assertEquals(1, $recordcount);
+        $this->assertEquals($titlecheck . '_' . $postcount, $posts[max($postids)]->title);
+    }
+
+    public function test_oublog_get_posts_individual() {
+        global $USER, $DB;
+        $this->resetAfterTest(true);
+        $this->setAdminUser();
+
+        $course = $this->get_new_course();
+
+        $stud1 = $this->get_new_user('student', $course->id);
+        $stud2 = $this->get_new_user('student', $course->id);
+
+        // Test 1 -  posts using separate individual.
+        $oublog = $this->get_new_oublog($course->id, array('individual' => OUBLOG_SEPARATE_INDIVIDUAL_BLOGS));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+
+        // First make sure we have some posts to use.
+        $post1stub = $this->get_post_stub($oublog->id);
+        $post1stub->userid = $stud1->id;
+        oublog_add_post($post1stub, $cm, $oublog, $course);
+        $post2stub = $this->get_post_stub($oublog->id);
+        $post2stub->userid = $stud2->id;
+        oublog_add_post($post2stub, $cm, $oublog, $course);
+
+        // Get a list of the posts.
+        $context = context_module::instance($cm->id);
+
+        // All individuals.
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, 0);
+
+        // Same name of records returned that were added?
+        $this->assertEquals(2, $recordcount);
+
+        // Admin see one individual.
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, 0, $stud1->id);
+        $this->assertEquals(1, $recordcount);
+
+        // User see own.
+        $this->setUser($stud1);
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, 0, $stud1->id);
+        $this->assertEquals(1, $recordcount);
+
+        // User see others?
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, 0, $stud2->id);
+        // Odd behaviour in oublog_get_posts() + oublog_individual_add_to_sqlwhere() in this case.
+        // Due to user not being able to see blog the individual filter does not get applied.
+        $this->assertEquals(2, $recordcount);
+        // Give user permission to see other individuals.
+        $role = $DB->get_record('role', array('shortname' => 'student'));
+        role_change_permission($role->id, $context, 'mod/oublog:viewindividual', CAP_ALLOW);
+
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, 0, $stud2->id);
+        $this->assertEquals(1, $recordcount);
+
+        // Test 2. posts using visible individual with separate groups.
+        $this->setAdminUser();
+        $group1 = $this->get_new_group($course->id);
+        $group2 = $this->get_new_group($course->id);
+        $this->get_new_group_member($group1->id, $stud1->id);
+        $this->get_new_group_member($group2->id, $stud2->id);
+        $stud3 = $this->get_new_user('student', $course->id);
+        $this->get_new_group_member($group1->id, $stud3->id);// New user also in group 1.
+        $oublog = $this->get_new_oublog($course->id,
+                array('individual' => OUBLOG_VISIBLE_INDIVIDUAL_BLOGS, 'groupmode' => SEPARATEGROUPS));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+
+        // First make sure we have some posts to use.
+        $post1stub = $this->get_post_stub($oublog->id);
+        $post1stub->userid = $stud1->id;
+        oublog_add_post($post1stub, $cm, $oublog, $course);
+        $post2stub = $this->get_post_stub($oublog->id);
+        $post2stub->userid = $stud2->id;
+        oublog_add_post($post2stub, $cm, $oublog, $course);
+
+        // Get a list of the posts.
+        $context = context_module::instance($cm->id);
+
+        // Admin - group + individual 0.
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, 0, 0);
+        $this->assertEquals(2, $recordcount);
+        // Admin - group.
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, $group1->id, 0);
+        $this->assertEquals(1, $recordcount);
+        // Admin - individual.
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, $group1->id, $stud1->id);
+        $this->assertEquals(1, $recordcount);
+        // User Own group (but not their post).
+        $this->setUser($stud3);
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, $group1->id, 0);
+        $this->assertEquals(1, $recordcount);
+        // User own group and another individual.
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, $group1->id, $stud1->id);
+        $this->assertEquals(1, $recordcount);
+        // User other group (Note as don't have access all get returned as no filter applied).
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, $group2->id, 0);
+        $this->assertEquals(2, $recordcount);
+        // User other individual (Note as don't have access all get returned as no filter applied).
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, $group2->id, $stud2->id);
+        $this->assertEquals(2, $recordcount);
+    }
+
+    public function test_oublog_get_posts_personal() {
+        global $SITE, $USER, $DB;
+        $this->resetAfterTest(true);
+        $this->setAdminUser();
+
+        $stud1 = $this->get_new_user();
+        $stud2 = $this->get_new_user();
+
+        if (!$oublog = $DB->get_record('oublog', array('global' => 1))) {
+            $oublog = $this->get_new_oublog($SITE->id, array('global' => 1, 'maxvisibility' => OUBLOG_VISIBILITY_PUBLIC));
+        }
+
+        $cm = get_coursemodule_from_instance('oublog', $oublog->id);
+        $context = context_module::instance($cm->id);
+
+        // First make sure we have some posts to use.
+        $post1stub = $this->get_post_stub($oublog->id);
+        $post1stub->userid = $stud1->id;
+        $post1stub->visibility = OUBLOG_VISIBILITY_COURSEUSER;// Private.
+        oublog_add_post($post1stub, $cm, $oublog, $SITE);
+        $post2stub = $this->get_post_stub($oublog->id);
+        $post2stub->userid = $stud2->id;
+        $post2stub->visibility = OUBLOG_VISIBILITY_LOGGEDINUSER;// User must be logged in.
+        oublog_add_post($post2stub, $cm, $oublog, $SITE);
+        $post3stub = $this->get_post_stub($oublog->id);
+        $post3stub->userid = $stud2->id;
+        $post3stub->visibility = OUBLOG_VISIBILITY_PUBLIC;// Any user.
+        oublog_add_post($post3stub, $cm, $oublog, $SITE);
+
+        // Test 1 - posts using admin.
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, 0);
+        $this->assertEquals(3, $recordcount);
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, 0, -1, null, null, true, true);
+        $this->assertEquals(2, $recordcount);
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, 0, $stud2->id);
+        $this->assertEquals(2, $recordcount);
+        // Test 2 -  posts using logged in user.
+        $this->setUser($stud2);
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, 0);
+        $this->assertEquals(2, $recordcount);
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, 0, $stud1->id);
+        $this->assertEquals(0, $recordcount);
+        // Test 3 - posts using guest (not logged in).
+        $this->setGuestUser();
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, 0);
+        $this->assertEquals(1, $recordcount);
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, 0, $stud1->id);
+        $this->assertEquals(0, $recordcount);
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, 0, $cm, 0, $stud2->id);
+        $this->assertEquals(1, $recordcount);
+
+        // Test 4 - create multiple posts for pagination tests.
+        $this->setAdminUser();
+        // Number of posts/comments for tests.
+        $postcount = OUBLOG_POSTS_PER_PAGE;
+        // Create further post stubs for students, ie 3 pages.
+        // Create student 1s post stubs.
+        $posthashes = $postids = array();
+        for ($i = 1; $i <= $postcount; $i++) {
+            $posthashes[$i] = $this->get_post_stub($oublog->id);
+            $posthashes[$i]->userid = $stud1->id;
+            $posthashes[$i]->visibility = OUBLOG_VISIBILITY_PUBLIC;// Any user.
+        }
+        // Create student 1s posts.
+        foreach ($posthashes as $posthash) {
+            $postids[] = oublog_add_post($posthash, $cm, $oublog, $SITE);
+        }
+        // Create student 2s post stubs.
+        for ($i = 1; $i <= $postcount; $i++) {
+            $posthashes[$i] = $this->get_post_stub($oublog->id);
+            $posthashes[$i]->userid = $stud2->id;
+            $posthashes[$i]->visibility = OUBLOG_VISIBILITY_PUBLIC;
+        }
+        // Create student 2s posts.
+        foreach ($posthashes as $posthash) {
+            $postids[] = oublog_add_post($posthash, $cm, $oublog, $SITE);
+        }
+        // Setup pagination offset count for page 1.
+        $page = 0;
+        $offset = $page * OUBLOG_POSTS_PER_PAGE;
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, $offset, $cm, 0, -1, null, '', true, true);
+        $this->assertEquals(OUBLOG_POSTS_PER_PAGE * 2 + 2, $recordcount);// Includes count of lesser visibility posts.
+        $this->assertCount(OUBLOG_POSTS_PER_PAGE, $posts);// Includes only paged visibile posts.
+        // Setup pagination offset count for page 2.
+        $page = 1;
+        $offset = $page * OUBLOG_POSTS_PER_PAGE;
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, $offset, $cm, 0, -1, null, '', true, true);
+        $this->assertCount(OUBLOG_POSTS_PER_PAGE, $posts);// Includes only paged visibile posts.
+        // Setup pagination offset count for page 3.
+        $page = 2;
+        $offset = $page * OUBLOG_POSTS_PER_PAGE;
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, $offset, $cm, 0, -1, null, '', true, true);
+        $this->assertCount(2, $posts);// Includes only paged visibile posts.
+    }
+
+    /* test_oublog_get_last_modified */
+    public function test_oublog_get_last_modified() {
+        global $USER, $DB;
+        $this->resetAfterTest(true);
+        $this->setAdminUser();
+
+        $course = $this->get_new_course();
+        $oublog = $this->get_new_oublog($course->id);
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+        $stud1 = $this->get_new_user('student', $course->id);
+        $oublog2 = $this->get_new_oublog($course->id);
+
+        $post = $this->get_post_stub($oublog->id);
+        $postid = oublog_add_post($post, $cm, $oublog, $course);
+        $timeposted = $DB->get_field('oublog_posts', 'timeposted', array('id' => $postid));
+        $lastmodified = oublog_get_last_modified($cm, $course, $USER->id);
+        $this->assertTrue(is_numeric($lastmodified));
+        $this->assertEquals($timeposted, $lastmodified);
+
+        $result = oublog_get_last_modified($oublog2->cm, $course);
+        $this->assertEmpty($result);
+        $this->get_new_post($oublog2);
+
+        // Should static cache result, so remains empty.
+        $result = oublog_get_last_modified($oublog2->cm, $course);
+        $this->assertEmpty($result);
+
+        $result = oublog_get_last_modified($oublog2->cm, $course, $stud1->id);
+        $this->assertNotEmpty($result);
+        $result1 = oublog_get_last_modified($oublog2->cm, $course, $stud1->id);
+        $this->assertEquals($result, $result1);
+        // TODO: More comprehensive checking with separate group/individual blogs.
+    }
+
+    /*
+     * Add unit test to cover main oublog_get_participation_details(
+       * $oublog, $groupid, $individual, $start = null, $end = null,
+       * $page = 0, $getposts = true, $getcomments = true,
+       * $limitfrom = null, $limitnum = null) function.
+    */
+    public function test_oublog_get_participation_details() {
+        global $SITE, $USER, $DB;
+        $this->resetAfterTest(true);
+        $this->setAdminUser();
+        $now = time();
+        // Whole course.
+        // Single course for all subsequent tests?
+        $course = $this->get_new_course();
+        $oublog = $this->get_new_oublog($course->id);
+        $oublog->allowcomments = OUBLOG_COMMENTS_ALLOW;
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+        $student1 = $this->get_new_user('student', $course->id);
+        $student2 = $this->get_new_user('student', $course->id);
+        // Number of posts and comments to create for whole course tests.
+        $postcountwc = 3;
+        $titlecheck = 'test_oublog_get_parts_wc';
+        // Prepare to make some posts using the posts stub.
+        $posthashes = array();
+        for ($i = 1; $i <= $postcountwc; $i++) {
+            $posthashes[$i] = $this->get_post_stub($oublog->id);
+            $posthashes[$i]->title = 'Test Post ' . $titlecheck;
+            // Add the posting student.
+            $posthashes[$i]->userid = $student1->id;
+        }
+        // Create the posts - assumes oublog_add_post is working,
+        // also add student comments to those posts.
+        $postids = $commentids = array();
+        foreach ($posthashes as $posthash) {
+            $postids[] = oublog_add_post($posthash, $cm, $oublog, $course);
+            // Add the commenting student.
+            $comment = $this->get_comment_stub($posthash->id, $student2->id);
+            $comment->title .= " ".$titlecheck;
+            $commentids[] = oublog_add_comment($course, $cm, $oublog, $comment);
+        }
+        // Get the participation object with counts of posts and comments.
+        $curgroup = oublog_get_activity_group($cm);
+        $curindividual = 0;
+        $studentnamed = fullname($student1);
+        $limitnum = 4;
+        $start = $end = $page = $limitfrom = 0;
+        $getposts = true;
+        $getcomments = true;
+        $participation = oublog_get_participation_details($oublog, $curgroup, $curindividual,
+                $start, $end, $page, $getposts, $getcomments, $limitfrom, $limitnum);
+        // Test postscount && commentscount.
+        // The same number of records should be 'discovered' that were added.
+        $this->assertEquals($postcountwc, $participation->postscount);
+        $this->assertEquals($postcountwc, $participation->commentscount);
+        // This blog activity  allows comments.
+        $this->assertEquals(OUBLOG_COMMENTS_ALLOW, $oublog->allowcomments);
+        // The number of records should be 'returned' that were added.
+        $this->assertCount($postcountwc, $participation->posts);
+        $this->assertCount($postcountwc, $participation->comments);
+        // The posts returned should match the ones added.
+        foreach ($participation->posts as $post) {
+            // Do some basic checks - does it match our test post created above.
+            $this->assertInstanceOf('stdClass', $post);
+            $this->assertEquals('Test Post ' . $titlecheck, $post->title);
+            $this->assertEquals($student1->id, $post->userid);
+            $this->assertEquals(0, $post->groupid);
+            $postername = fullname($post);
+            $this->assertEquals($studentnamed, $postername);
+            $this->assertEquals($oublog->allowcomments, $post->allowcomments);
+        }
+        // Test comments object.
+        foreach ($participation->comments as $comment) {
+            // Same basic checks - does it match our test comment created above.
+            $this->assertInstanceOf('stdClass', $comment);
+            $this->assertEquals('Test Comment '. $titlecheck, $comment->title);
+            $this->assertEquals($oublog->id, $comment->oublogid);
+            $this->assertEquals($post->title, $comment->posttitle);
+            $this->assertEquals($post->userid, $comment->posterid);
+            $this->assertEquals($post->userid, $comment->postauthorid);
+            $this->assertEquals($post->groupid, $comment->groupid);
+            $this->assertEquals($post->visibility, $comment->visibility);
+            $this->assertEquals($studentnamed, $comment->posterfirstname ." ". $comment->posterlastname);
+        }
+
+        // Test for comments turned ON the blog.
+        // But turned OFF on ONE post.
+        $oublog->allowcomments = OUBLOG_COMMENTS_ALLOW;
+        $getposts = false;// Dont need to see posts.
+        $getcomments = true;// Do want to see comments.
+        // Create additional post.
+        $posttest = $this->get_post_stub($oublog->id);
+        $posttest->title = 'Test Post ' . $titlecheck;
+        // Add the posting student.
+        $posttest->userid = $student1->id;
+        // Add one post which doesnt allow comments
+        $posttest->allowcomments = OUBLOG_COMMENTS_PREVENT;
+        $postids[] = oublog_add_post($posttest, $cm, $oublog, $course);
+        // Attemt to add a student comment, though not allowed.
+        $comment3 = $this->get_comment_stub($posttest->id, $student2->id);
+        $comment3->title .= " NOT ALLOWED ".$titlecheck;
+        $commentids[] = oublog_add_comment($course, $cm, $oublog, $comment3);
+        $participation = oublog_get_participation_details($oublog, $curgroup, $curindividual,
+                $start, $end, $page, $getposts, $getcomments, $limitfrom, $limitnum);
+        // The number of posts that should be 'discovered' plus the new one.
+        $this->assertEquals($postcountwc + 1, $participation->postscount);
+        // The number of posts that should be 'returned'.
+        $this->assertCount(0, $participation->posts);
+        // This blog activity DOES allow comments.
+        $this->assertEquals(OUBLOG_COMMENTS_ALLOW, $oublog->allowcomments);
+        // The number of comments that should be 'discovered', does not not include the new one.
+        $this->assertEquals($postcountwc, $participation->commentscount);
+        // The number of comments to be 'returned' does not not include the new one.
+        $this->assertCount($postcountwc, $participation->comments);
+
+        // Separate groups.
+        $oublog = $this->get_new_oublog($course->id, array('groupmode' => SEPARATEGROUPS));
+        $group1 = $this->get_new_group($course->id);
+        $group2 = $this->get_new_group($course->id);
+        $this->get_new_group_member($group1->id, $student1->id);
+        $this->get_new_group_member($group2->id, $student2->id);
+        $postcountsg = 3;
+        $titlecheck = ' test_oublog_get_sg';
+        // Make some posts to use from post stub.
+        $posthashes = array();
+        for ($i = 1; $i <= $postcountsg; $i++) {
+            $posthashes[$i] = $this->get_post_stub($oublog->id);
+            $posthashes[$i]->title = $titlecheck;
+            // Add the posting student.
+            $posthashes[$i]->userid = $student1->id;
+            $posthashes[$i]->groupid = $group1->id;
+        }
+        // Create the posts assuming oublog_add_post is working.
+        $postids = array();
+        foreach ($posthashes as $posthash) {
+            $postids[] = oublog_add_post($posthash, $cm, $oublog, $course);
+            // Not adding comments for this test.
+        }
+
+        $curgroup = 0;// All groups.
+        $curindividual = 0;
+        $getposts = true;
+        $participation = oublog_get_participation_details($oublog, $curgroup, $curindividual,
+                $start, $end, $page, $getposts, $getcomments, $limitfrom, $limitnum);
+        // The number of posts that should be 'discovered' plus the new one.
+        $this->assertEquals($postcountsg, $participation->postscount);
+        // The number of posts that should be 'returned'.
+        $this->assertCount($postcountsg, $participation->posts);
+        // The number of comments should be 'discovered'.
+        $this->assertEquals(0, $participation->commentscount);
+        // The number of comments should be 'returned'.
+        $this->assertCount(0, $participation->comments);
+
+        // Test posts object. Only Group ONE
+        foreach ($participation->posts as $post) {
+            // Basic checks.
+            $this->assertInstanceOf('stdClass', $post);
+            $this->assertEquals($group1->id, $post->groupid);
+            $this->assertEquals($student1->id, $post->userid);
+            $postername = fullname($post);
+            $this->assertEquals($postername, $post->firstname ." ". $post->lastname);
+        }
+        // Prepare some more post stubs to use.
+        $posthashes = array();
+        for ($i = 1; $i <= $postcountsg; $i++) {
+            $posthashes[$i] = $this->get_post_stub($oublog->id);
+            $posthashes[$i]->title = $titlecheck;
+            // Add the posting student.
+            $posthashes[$i]->userid = $student2->id;
+            $posthashes[$i]->groupid = $group2->id;
+        }
+        // Creating the posts, and add comments.
+        $postids = array();
+        foreach ($posthashes as $posthash) {
+            $postids[] = oublog_add_post($posthash, $cm, $oublog, $course);
+            // Add the commenting student.
+            $comment = $this->get_comment_stub($posthash->id, $student2->id);
+            $comment->title .= $titlecheck;
+            $commentids[] = oublog_add_comment($course, $cm, $oublog, $comment);
+        }
+
+        // Test posts object. ONLY Group TWO.
+        $curgroup = $group2->id;
+        $curindividual = 0;
+        $participation = oublog_get_participation_details($oublog, $curgroup, $curindividual,
+                $start, $end, $page, $getposts, $getcomments, $limitfrom, $limitnum);
+        $this->assertEquals($postcountsg, $participation->postscount);
+        // No: of comments made same as posts.
+        $this->assertEquals($postcountsg, $participation->commentscount);
+        // Test posts object. ONLY Group TWO.
+        foreach ($participation->posts as $post) {
+            // Do some basic checks.
+            $this->assertInstanceOf('stdClass', $post);
+            $this->assertEquals($group2->id, $post->groupid);
+            $this->assertEquals($student2->id, $post->userid);
+        }
+        // Test comments object.
+        foreach ($participation->comments as $comment) {
+            // Do some basic checks - does it match our test post created above?.
+            $this->assertInstanceOf('stdClass', $comment);
+            $this->assertEquals('Test Comment' . $titlecheck, $comment->title);
+            $this->assertEquals($oublog->id, $comment->oublogid);
+            $this->assertEquals($post->title, $comment->posttitle);
+            $this->assertEquals($post->userid, $comment->posterid);
+        }
+
+        // Separate groups, separate individuals.
+        $oublog = $this->get_new_oublog($course->id, array(
+                'groupmode' => SEPARATEGROUPS,
+                'individual' => OUBLOG_SEPARATE_INDIVIDUAL_BLOGS));
+        $group5 = $this->get_new_group($course->id);
+        $group6 = $this->get_new_group($course->id);
+        $this->get_new_group_member($group5->id, $student1->id);
+        $this->get_new_group_member($group6->id, $student2->id);
+        // Number of posts/comments for these tests.
+        $postcountsgsi = 2;
+        $titlecheck = ' testing_oublog_sgsi_get_posts';
+        // Some post stubs to use in group 5.
+        $posthashes = array();
+        for ($i = 1; $i <= $postcountsgsi; $i++) {
+            $posthashes[$i] = $this->get_post_stub($oublog->id);
+            $posthashes[$i]->title = $titlecheck;
+            // Add the posting student.
+            $posthashes[$i]->userid = $student1->id;
+        }
+        // Create group 5's posts and comments.
+        $postids = array();
+        foreach ($posthashes as $posthash) {
+            $postids[] = oublog_add_post($posthash, $cm, $oublog, $course);
+            $comment = $this->get_comment_stub($posthash->id, $student1->id);
+            $comment->title .= $titlecheck;
+            $commentids[] = oublog_add_comment($course, $cm, $oublog, $comment);
+        }
+        // Make sure we have some post stubs to use in group 6.
+        $posthashes = array();
+        for ($i = 1; $i <= $postcountsgsi; $i++) {
+            $posthashes[$i] = $this->get_post_stub($oublog->id);
+            $posthashes[$i]->title = $titlecheck;
+            $posthashes[$i]->userid = $student2->id;
+
+        }
+        // Create group 6s posts and comments.
+        $postids = array();
+        foreach ($posthashes as $posthash) {
+            $postids[] = oublog_add_post($posthash, $cm, $oublog, $course);
+            $comment = $this->get_comment_stub($posthash->id, $student2->id);
+            $comment->title .= $titlecheck;
+            $commentids[] = oublog_add_comment($course, $cm, $oublog, $comment);
+        }
+
+        // Test no groups.
+        $curgroup = 0;
+        $curindividual = 0;
+        $getposts = true;
+        $getcomments = true;
+        $participation = oublog_get_participation_details($oublog, $curgroup, $curindividual,
+                $start, $end, $page, $getposts, $getcomments, $limitfrom, $limitnum);
+        // The number of posts that should be 'discovered', from both groups.
+        $this->assertEquals($postcountsgsi * 2, $participation->postscount);
+        // The number of posts that should be 'returned'.
+        $this->assertCount($postcountsgsi * 2, $participation->posts);
+        // The number of comments should be 'discovered', from both groups.
+        $this->assertEquals($postcountsgsi * 2, $participation->commentscount);
+        // The number of comments should be 'returned'.
+        $this->assertCount($postcountsgsi * 2, $participation->comments);
+
+        // Test of student in group 6.
+        $curgroup = $group6->id;
+        $curindividual = $student2->id;
+        $getposts = false;
+        $getcomments = true;
+        $participation = oublog_get_participation_details($oublog, $curgroup, $curindividual,
+                $start, $end, $page, $getposts, $getcomments, $limitfrom, $limitnum);
+        // The number of one students posts that should be 'discovered' from group.
+        $this->assertEquals($postcountsgsi, $participation->postscount);
+        // There are posts but should not be 'returned'.
+        $this->assertCount(0, $participation->posts);
+        // The number of comments that should be 'discovered', from both groups.
+        $this->assertEquals($postcountsgsi, $participation->commentscount);
+        // The number of comments that should be 'returned'.
+        $this->assertCount($postcountsgsi, $participation->comments);
+
+        // Test for student not in group 6.
+        $curgroup = $group6->id;
+        $curindividual = $student1->id;
+        $getposts = false;
+        $getcomments = true;
+        $participation = oublog_get_participation_details($oublog, $curgroup, $curindividual,
+                $start, $end, $page, $getposts, $getcomments, $limitfrom, $limitnum);
+        // Student not in the group could make no posts or comments
+        $this->assertEquals(0, $participation->postscount);
+        $this->assertCount(0, $participation->posts);
+        $this->assertEquals(0, $participation->commentscount);
+        $this->assertCount(0, $participation->comments);
+
+        // Separate individuals.
+        $oublog = $this->get_new_oublog($course->id, array(
+                'individual' => OUBLOG_SEPARATE_INDIVIDUAL_BLOGS));
+        // Number of posts/comments for these tests.
+        $postcountsi = 2;
+        $titlecheck = 'oublog_si_tests';
+        // Creating some post stubs for student 1 to use.
+        $posthashes = array();
+        for ($i = 1; $i <= $postcountsi; $i++) {
+            $posthashes[$i] = $this->get_post_stub($oublog->id);
+            $posthashes[$i]->title .= $titlecheck;
+            $posthashes[$i]->userid = $student1->id;
+        }
+        // Create student 1s posts and comments.
+        $postids = array();
+        foreach ($posthashes as $posthash) {
+            $postids[] = oublog_add_post($posthash, $cm, $oublog, $course);
+            $comment1 = $this->get_comment_stub($posthash->id, $student1->id);
+            $comment1->title .= $titlecheck;
+            $commentids[] = oublog_add_comment($course, $cm, $oublog, $comment1);
+            $comment2 = $this->get_comment_stub($posthash->id, $student2->id);
+            $comment2->title .= $titlecheck;
+            $commentids[] = oublog_add_comment($course, $cm, $oublog, $comment2);
+        }
+        // Create student 2s posts and comments.
+        for ($i = 1; $i <= $postcountsi; $i++) {
+            $posthashes[$i] = $this->get_post_stub($oublog->id);
+            $posthashes[$i]->title = $titlecheck;
+            $posthashes[$i]->userid = $student2->id;
+        }
+        foreach ($posthashes as $posthash) {
+            $postids[] = oublog_add_post($posthash, $cm, $oublog, $course);
+            $comment1 = $this->get_comment_stub($posthash->id, $student2->id);
+            $comment1->title .= $titlecheck;
+            $commentids[] = oublog_add_comment($course, $cm, $oublog, $comment1);
+            $comment2 = $this->get_comment_stub($posthash->id, $student2->id);
+            $comment2->title .= $titlecheck;
+            $commentids[] = oublog_add_comment($course, $cm, $oublog, $comment2);
+        }
+
+        // Test All individuals.
+        $curgroup = 0;
+        $curindividual = 0;
+        $oublog->individual = OUBLOG_SEPARATE_INDIVIDUAL_BLOGS;
+        $getposts = true;
+        $getcomments = true;
+        $participation = oublog_get_participation_details($oublog, $curgroup, $curindividual,
+                $start, $end, $page, $getposts, $getcomments, $limitfrom, $limitnum);
+        // Test count of posts by both students.
+        $this->assertEquals($postcountsi * 2, $participation->postscount);
+        // The number of student posts should be 'returned' that were added.
+        $this->assertCount($postcountsi * 2, $participation->posts);
+        // Test count of all students comments.
+        $this->assertEquals($postcountsi * 4, $participation->commentscount);
+        // The number of comments which should be 'returned'.
+        $this->assertCount($postcountsi * 2, $participation->comments);
+
+        // Test an individual.
+        $curgroup = 0;
+        $curindividual = $student2->id;
+        $studentnamed = fullname($student2);
+        $getposts = true;
+        $getcomments = true;
+        $participation = oublog_get_participation_details($oublog, $curgroup, $curindividual,
+                $start, $end, $page, $getposts, $getcomments, $limitfrom, $limitnum);
+        // Test count of posts by both students.
+        $this->assertEquals($postcountsi, $participation->postscount);
+        // The number of student posts should be 'returned' that were added.
+        $this->assertCount($postcountsi, $participation->posts);
+        // Test count of all students comments.
+        $this->assertEquals($postcountsi * 2, $participation->commentscount);
+        // The number of comments which should be 'returned'.
+        $this->assertCount($postcountsi * 2, $participation->comments);
+
+        // The posts returned should match the ones added.
+        foreach ($participation->posts as $post) {
+            // Do some basic checks - does it match our test post created above.
+            $this->assertInstanceOf('stdClass', $post);
+            $this->assertEquals($titlecheck, $post->title);
+            $this->assertEquals($student2->id, $post->userid);
+            $this->assertEquals(0, $post->groupid);
+            $postername = fullname($post);
+            $this->assertEquals($studentnamed, $postername);
+        }
+
+        // Global blog = Personal blog.
+        if (!$oublog = $DB->get_record('oublog', array(
+                'course' => $SITE->id, 'global' => 1))) {
+            $oublog = $this->get_new_oublog($SITE->id, array(
+                    'global' => 1,
+                    'individual' => OUBLOG_NO_INDIVIDUAL_BLOGS,
+                    'allowcomments' => OUBLOG_COMMENTS_ALLOWPUBLIC,
+                    'maxvisibility' => OUBLOG_VISIBILITY_PUBLIC));
+        }
+        $cm = get_coursemodule_from_instance('oublog', $oublog->id);
+        // Number of posts and comments to create for Global course tests.
+        $postcountpb = 2;
+        $titlecheck = 'PERSBLOG_parts';
+        // Prepare to make some posts to use for test 1.
+        $posthashes1 = array();
+        for ($ai = 1; $ai <= $postcountpb; $ai++) {
+            $posthashes1[$ai] = $this->get_post_stub($oublog->id);
+            $posthashes1[$ai]->title = "TP " . $titlecheck;
+            $posthashes1[$ai]->userid = $student1->id;
+            $posthashes1[$ai]->visibility = OUBLOG_VISIBILITY_COURSEUSER;
+        }
+        // Create the posts - assumes oublog_add_post is working,
+        // also add student comments to those posts.
+        $postids = $commentids = array();
+        foreach ($posthashes1 as $posthasha) {
+            $postids[] = oublog_add_post($posthasha, $cm, $oublog, $SITE);
+            $comment1 = $this->get_comment_stub($posthasha->id, $student1->id);
+            $comment1->title = "TC " .$titlecheck;
+            $commentids[] = oublog_add_comment($SITE, $cm, $oublog, $comment1);
+            $comment2 = $this->get_comment_stub($posthasha->id, $student2->id);
+            $comment2->title = "TC " .$titlecheck;
+            $commentids[] = oublog_add_comment($course, $cm, $oublog, $comment2);
+        }
+
+        // Get the participation object with counts of posts and comments.
+        $curgroup = 0;
+        $curindividual = 0;
+        $limitnum = 8;
+        $start = $end = $page = 0;
+        $limitfrom = 0;
+        $getposts = false;// Dont need posts on global blog.
+        $getcomments = true;
+        $participation = oublog_get_participation_details($oublog, $curgroup, $curindividual,
+                $start, $end, $page, $getposts, $getcomments, $limitfrom, $limitnum);
+        // Test postscount && commentscount;
+        // When visibility is private course user only return none.
+        $this->assertEquals(0, $participation->postscount);
+        $this->assertEquals(0, $participation->commentscount);
+
+        // Prepare to make some posts to use for test two.
+        $posthashes1 = array();
+        for ($ai = 1; $ai <= $postcountpb; $ai++) {
+            $posthashes1[$ai] = $this->get_post_stub($oublog->id);
+            $posthashes1[$ai]->title = "TP " . $titlecheck;
+            $posthashes1[$ai]->userid = $student1->id;
+            $posthashes1[$ai]->visibility = OUBLOG_VISIBILITY_LOGGEDINUSER;
+        }
+        // Create the posts - assumes oublog_add_post is working,
+        // also add student comments to those posts.
+        $postids = $commentids = array();
+        foreach ($posthashes1 as $posthasha) {
+            $postids[] = oublog_add_post($posthasha, $cm, $oublog, $SITE);
+            $comment1 = $this->get_comment_stub($posthasha->id, $student1->id);
+            $comment1->title = "TC " .$titlecheck;
+            $commentids[] = oublog_add_comment($SITE, $cm, $oublog, $comment1);
+            $comment2 = $this->get_comment_stub($posthasha->id, $student2->id);
+            $comment2->title = "TC " .$titlecheck;
+            $commentids[] = oublog_add_comment($course, $cm, $oublog, $comment2);
+        }
+
+        // Get the participation object with counts of posts and comments.
+        $curgroup = 0;
+        $curindividual = 0;
+        $limitnum = 8;
+        $start = $end = $page = $limitfrom = 0;
+        $getposts = false;// Dont need posts on global blog.
+        $getcomments = true;
+        $participation = oublog_get_participation_details($oublog, $curgroup, $curindividual,
+                $start, $end, $page, $getposts, $getcomments, $limitfrom, $limitnum);
+        // For this test each post commented on twice.
+        $this->assertEquals($postcountpb, $participation->postscount);
+        $this->assertEquals($postcountpb * 2, $participation->commentscount);
+        // Test comments object.
+        foreach ($participation->comments as $comment) {
+            // Same basic checks - does it match our test comment created above.
+            $this->assertInstanceOf('stdClass', $comment);
+            $this->assertEquals("TC " . $titlecheck, $comment->title);
+            $this->assertEquals(OUBLOG_VISIBILITY_LOGGEDINUSER, $comment->visibility);
+        }
+        // Prepare to make some posts to use for test 3.
+        $posthashes1 = array();
+        for ($ai = 1; $ai <= $postcountpb; $ai++) {
+            $posthashes1[$ai] = $this->get_post_stub($oublog->id);
+            $posthashes1[$ai]->title = "TP " . $titlecheck;
+            $posthashes1[$ai]->userid = $student1->id;
+            $posthashes1[$ai]->visibility = OUBLOG_VISIBILITY_PUBLIC;
+        }
+        // Create the posts - assumes oublog_add_post is working,
+        // also add student comments to those posts.
+        $postids = $commentids = array();
+        foreach ($posthashes1 as $posthasha) {
+            $postids[] = oublog_add_post($posthasha, $cm, $oublog, $SITE);
+            $comment1 = $this->get_comment_stub($posthasha->id, $student1->id);
+            $comment1->title = "TC " .$titlecheck;
+            $commentids[] = oublog_add_comment($SITE, $cm, $oublog, $comment1);
+            $comment2 = $this->get_comment_stub($posthasha->id, $student2->id);
+            $comment2->title = "TC " .$titlecheck;
+            $commentids[] = oublog_add_comment($course, $cm, $oublog, $comment2);
+        }
+
+        // Get the participation object with counts of posts and comments.
+        $curgroup = 0;
+        $curindividual = 0;
+        $limitnum = 8;
+        $start = $end = $page = $limitfrom = 0;
+        $getposts = false;// Dont need posts on global blog.
+        $getcomments = true;
+        $participation = oublog_get_participation_details($oublog, $curgroup, $curindividual,
+                $start, $end, $page, $getposts, $getcomments, $limitfrom, $limitnum);
+        // Test postscount && commentscount; the same number of records
+        // or multiples of $postcountpb, should be discovered.
+        $this->assertEquals($postcountpb * 2, $participation->postscount);
+        $this->assertEquals($postcountpb * 4, $participation->commentscount);
+        // But we should only return the limited amount of 8 comments.
+        $this->assertCount(0, $participation->posts);
+        $this->assertCount($limitnum, $participation->comments);
+        // Test comments object.
+        foreach ($participation->comments as $comment) {
+            // Same basic checks - does it match our test comment created above.
+            $this->assertInstanceOf('stdClass', $comment);
+            $this->assertEquals("TC " . $titlecheck, $comment->title);
+        }
+
+        // Set as guest user not logged in.
+        // Get the participation object with counts of posts and comments.
+        $curgroup = 0;
+        $this->setUser(0);
+        $curindividual = 0;
+        $limitnum = 8;
+        $start = $end = $page = $limitfrom = 0;
+        $getposts = false;// Dont need posts on global blog.
+        $getcomments = true;
+        $participation = oublog_get_participation_details($oublog, $curgroup, $curindividual,
+                $start, $end, $page, $getposts, $getcomments, $limitfrom, $limitnum);
+        // Test postscount && commentscount; the same number of records
+        // or multiples of $postcountpb, should be returned that were added.
+        $this->assertEquals($postcountpb, $participation->postscount);
+        $this->assertEquals($postcountpb * 2, $participation->commentscount);
+        // Test that we only return the limited amount of 8 commentss.
+        $this->assertCount(0, $participation->posts);
+        $this->assertLessThan($limitnum, count($participation->comments));
+        // Test comments object.
+        foreach ($participation->comments as $comment) {
+            // Same basic checks - does it match our test comment created above.
+            $this->assertInstanceOf('stdClass', $comment);
+            $this->assertEquals("TC " . $titlecheck, $comment->title);
+        }
+
+        // Separate individuals time checking.
+        // Reset the User previously set as guest user not logged in.
+        $this->setAdminUser();
+        $yesterday = time() - (24*60*60) - 60;
+        $beforeyesterday = time() - (2*24*60*60);
+        $sometimetoday = time();
+        $oublog = $this->get_new_oublog($course->id, array(
+                'individual' => OUBLOG_SEPARATE_INDIVIDUAL_BLOGS));
+        // Number of posts/comments for these tests.
+        $postcountsit = 4;
+        $titlecheck = ' oublog_sit_test_times';
+        // Creating some post stubs for student 1 to use
+        $posthashes = array();
+        for ($i = 1; $i <= $postcountsit; $i++) {
+            $posthashes[$i] = $this->get_post_stub($oublog->id);
+            $posthashes[$i]->title .= $titlecheck;
+            $posthashes[$i]->userid = $student1->id;
+            $posthashes[$i]->timeposted = $sometimetoday;
+        }
+        // Create student 1s posts with comments by S1 and S2.
+        $postids = array();
+        foreach ($posthashes as $posthash) {
+            $postids[] = oublog_add_post($posthash, $cm, $oublog, $course);
+            $comment1 = $this->get_comment_stub($posthash->id, $student1->id);
+            $comment1->title .=  $titlecheck;
+            $comment1->timeposted = $sometimetoday;
+            $commentids[] = oublog_add_comment($course, $cm, $oublog, $comment1);
+            $comment2 = $this->get_comment_stub($posthash->id, $student2->id);
+            $comment2->title .= $titlecheck;
+            $comment2->timeposted = $sometimetoday;
+            $commentids[] = oublog_add_comment($course, $cm, $oublog, $comment2);
+        }
+        // Create student 2s yesterday posts and comments.
+        for ($i = 1; $i <= $postcountsit; $i++) {
+            $posthashes[$i] = $this->get_post_stub($oublog->id);
+            $posthashes[$i]->title .= $titlecheck;
+            $posthashes[$i]->userid = $student2->id;
+            $posthashes[$i]->timeposted = $yesterday;
+        }
+        foreach ($posthashes as $posthash) {
+            $postids[] = oublog_add_post($posthash, $cm, $oublog, $course);
+            $comment1 = $this->get_comment_stub($posthash->id, $student2->id);
+            $comment1->title .= $titlecheck;
+            $comment1->timeposted = $yesterday;
+            $commentids[] = oublog_add_comment($course, $cm, $oublog, $comment1);
+            $comment2 = $this->get_comment_stub($posthash->id, $student1->id);
+            $comment2->title .= $titlecheck;
+            $comment2->timeposted = $yesterday;
+            $commentids[] = oublog_add_comment($course, $cm, $oublog, $comment2);
+        }
+        // Create more student 2 posts before yesterdays posts and comments.
+        // A limited set of these will be returned in a later test.
+        for ($i = 1; $i <= $postcountsit; $i++) {
+            $posthashes[$i] = $this->get_post_stub($oublog->id);
+            $posthashes[$i]->title = $titlecheck. $student2->id . $beforeyesterday . $i;
+            $posthashes[$i]->userid = $student2->id;
+            $posthashes[$i]->timeposted = $beforeyesterday;
+        }
+        foreach ($posthashes as $posthash) {
+            $postids[] = oublog_add_post($posthash, $cm, $oublog, $course);
+            $comment1 = $this->get_comment_stub($posthash->id, $student1->id);
+            $comment1->title = $titlecheck . $student1->id . $beforeyesterday . $posthash->id;
+            $comment1->timeposted = $beforeyesterday;
+            $commentids[] = oublog_add_comment($course, $cm, $oublog, $comment1);
+            $comment2 = $this->get_comment_stub($posthash->id, $student2->id);
+            $comment2->title = $titlecheck . $student2->id . $beforeyesterday . $posthash->id;
+            $comment2->timeposted = $beforeyesterday;
+            $commentids[] = oublog_add_comment($course, $cm, $oublog, $comment2);
+            // Saving last entries for limited beforeyesterday assertions later.
+            $posttitlebeforeyesterday = $posthash->title;
+            $comment1titlebeforeyesterday = $comment1->title;
+            $comment2titlebeforeyesterday = $comment2->title;
+        }
+        // Test All time entries.
+        $curgroup = 0;
+        $curindividual = 0;
+        $oublog->individual = OUBLOG_SEPARATE_INDIVIDUAL_BLOGS;
+        $limitnum = 8;
+        $start = 0;
+        $end = 0;
+        $page = 0;
+        $limitfrom = 0;
+        $getposts = true;
+        $getcomments = true;
+        $participation = oublog_get_participation_details($oublog, $curgroup, $curindividual,
+                $start, $end, $page, $getposts, $getcomments, $limitfrom, $limitnum);
+        // Test count of posts.
+        $this->assertEquals($postcountsit * 3, $participation->postscount);
+        // The number of student posts should be 'returned' that were added.
+        $this->assertCount($postcountsit * 2, $participation->posts);
+        // Test count of all students comments.
+        $this->assertEquals($postcountsit * 6, $participation->commentscount);
+        // The number of comments should be 'returned'.
+        $this->assertCount($postcountsit * 2, $participation->comments);
+
+        // Test that the posts returned match the ones added.
+        foreach ($participation->posts as $post) {
+            // Do some basic checks - does it match our test post created above.
+            $this->assertInstanceOf('stdClass', $post);
+            $this->assertEquals("testpost" . $titlecheck, $post->title);
+            $postername = fullname($post);
+            $this->assertEquals($postername, $post->firstname ." ". $post->lastname);
+        }
+        // Test comments object.
+        foreach ($participation->comments as $comment) {
+            // Same basic checks - does it match our test comment created above.
+            $this->assertInstanceOf('stdClass', $comment);
+        }
+
+        // Test previous day timed entries.
+        $limitnum = 8;
+        $start = $yesterday - 60;
+        $end = $sometimetoday;
+        $page = $limitfrom = 0;
+        $getposts = true;
+        $getcomments = true;
+        $participation = oublog_get_participation_details($oublog, $curgroup, $curindividual,
+                $start, $end, $page, $getposts, $getcomments, $limitfrom, $limitnum);
+        // Test count of posts for period.
+        $this->assertEquals($postcountsit, $participation->postscount);
+        // The number of student posts for period which should be 'returned'
+        $this->assertCount($postcountsit, $participation->posts);
+        // Test count of all students comments for test period.
+        $this->assertEquals($postcountsit * 2, $participation->commentscount);
+        // The number of comments should be 'returned'.
+        $this->assertCount($postcountsit * 2, $participation->comments);
+
+        // Test a limited time period during previous day.
+        $curgroup = 0;
+        $curindividual = 0;
+        $limitnum = 8;
+        $start = $yesterday - (60*60);
+        $end = $yesterday + (60*60);
+        $page = $limitfrom = 0;
+        $getposts = true;
+        $getcomments = true;
+        $participation = oublog_get_participation_details($oublog, $curgroup, $curindividual,
+                $start, $end, $page, $getposts, $getcomments, $limitfrom, $limitnum);
+        // Test count of posts for period.
+        $this->assertEquals($postcountsit, $participation->postscount);
+        // The number of student posts for period which should be 'returned'
+        $this->assertCount($postcountsit, $participation->posts);
+        // Test count of all students comments for test period.
+        $this->assertEquals($postcountsit * 2, $participation->commentscount);
+        // The number of comments should be 'returned'.
+        $this->assertCount($postcountsit * 2, $participation->comments);
+
+        // Test extended daily time period
+        $curgroup = 0;
+        $curindividual = 0;
+        $limitnum = 8;
+        $start = $beforeyesterday - 60;
+        $end = $sometimetoday + 60;
+        $page = $limitfrom = 0;
+        $getposts = true;
+        $getcomments = true;
+        $participation = oublog_get_participation_details($oublog, $curgroup, $curindividual,
+                $start, $end, $page, $getposts, $getcomments, $limitfrom, $limitnum);
+        // Test count of posts to be 'discovered' for period.
+        $this->assertEquals($postcountsit * 3, $participation->postscount);
+        // The number of student posts for period which should be 'returned'
+        $this->assertCount($postcountsit * 2, $participation->posts);
+        // Test count of all students comments 'discovered' for test period.
+        $this->assertEquals($postcountsit * 6, $participation->commentscount);
+        // The number of comments which should be 'returned'.
+        $this->assertCount($postcountsit * 2, $participation->comments);
+        foreach ($participation->posts as $post) {
+            // Do some basic checks - does it match our test post created above.
+            $this->assertInstanceOf('stdClass', $post);
+            $this->assertEquals("testpost" . $titlecheck, $post->title);
+            $this->assertEquals(fullname($post), $post->firstname ." ". $post->lastname);
+        }
+        // Test comments object.
+        foreach ($participation->comments as $comment) {
+            // Same basic checks - does it match our test comment created above.
+            $this->assertInstanceOf('stdClass', $comment);
+            $this->assertEquals(OUBLOG_VISIBILITY_COURSEUSER, $comment->visibility);
+        }
+        // Test using extended daily time period with limited return of posts and comments,
+        // using saved last entries for beforeyesterday assertions.
+        $curgroup = 0;
+        $curindividual = 0;
+        $limitnum = $postcountsit * 2;// Any Number, above the $postcountsit
+        $start = $beforeyesterday - 1;
+        $end = $beforeyesterday + 1;
+        $page = 0;
+        $limitfrom = $postcountsit -2;// Any Number, less that $postcountsit.
+        $getposts = true;
+        $getcomments = true;
+        $participation = oublog_get_participation_details($oublog, $curgroup, $curindividual,
+                $start, $end, $page, $getposts, $getcomments, $limitfrom, $limitnum);
+        // Test count of posts to be 'discovered' for period.
+        $this->assertEquals($postcountsit, $participation->postscount);
+        // The number of student posts for period which should be 'returned'
+        $this->assertCount($postcountsit - 2, $participation->posts);
+        // Test count of all students comments for test period.
+        $this->assertEquals($limitnum, $participation->commentscount);
+        // The number of comments should be 'returned'.
+        $this->assertCount($limitnum - $limitfrom, $participation->comments);
+        // Test posts object.
+        foreach ($participation->posts as $post) {
+            // Do some basic checks - does it match our test post created above.
+            $this->assertInstanceOf('stdClass', $post);
+            $this->assertEquals($student2->id, $post->userid);
+            $postername = fullname($post);
+            $this->assertEquals($postername, $post->firstname ." ". $post->lastname);
+            // Recognise last returned post correctly, but without id in title.
+            if ($post->title == $posttitlebeforeyesterday) {
+                $this->assertTrue(true);
+            }
+        }
+
+        foreach ($participation->comments as $comment) {
+            // Same basic checks - does it match our test comment created above.
+            $this->assertInstanceOf('stdClass', $comment);
+            $this->assertLessThanOrEqual(OUBLOG_VISIBILITY_COURSEUSER, $comment->visibility);
+            // Recognise last returned comments correctly, but with out ids in titles.
+            if ($comment->title == $comment1titlebeforeyesterday ||
+                    $comment->title == $comment2titlebeforeyesterday) {
+                $this->assertTrue(true);
+            }
+        }
+    }
+
+
+    /* test_oublog_get_posts_pagination */
+    public function test_oublog_get_posts_pagination() {
+        global $SITE, $USER, $DB;
+        $this->resetAfterTest(true);
+        $this->setAdminUser();
+
+        $course = $this->get_new_course();
+        // Test posts using standard course blog.
+        $oublog = $this->get_new_oublog($course->id);
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+        // Number of posts for test, more than posts per page
+        $postcount = OUBLOG_POSTS_PER_PAGE + (OUBLOG_POSTS_PER_PAGE / 2);
+        $titlecheck = 'test_oublog_get_posts_pagination';
+
+        // First make sure we have some posts to use.
+        $posthashes = array();
+        for ($i = 1; $i <= $postcount; $i++) {
+            $posthashes[$i] = $this->get_post_stub($oublog->id);
+            $posthashes[$i]->title = $titlecheck . '_' . $i;
+        }
+
+        // Create the posts - assumes oublog_add_post is working.
+        $postids = array();
+        foreach ($posthashes as $posthash) {
+            $postids[] = oublog_add_post($posthash, $cm, $oublog, $course);
+        }
+
+        $context = context_module::instance($cm->id);
+        // Build paging parameters for the first page .
+        $page = 0;
+        $offset = $page * OUBLOG_POSTS_PER_PAGE;
+        // Get a list of the pages posts.
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, $offset, $cm, 0);
+        // Same number of records discovered that were created?
+        $this->assertEquals($postcount, $recordcount);
+        // Is the number of posts returned that were expected?.
+        $this->assertEquals(OUBLOG_POSTS_PER_PAGE, count($posts));
+
+        // Build paging parameters for the second page.
+        $page = 1;
+        $offset = $page * OUBLOG_POSTS_PER_PAGE;
+        // Get the list of the second pages posts.
+        list($posts, $recordcount) = oublog_get_posts($oublog, $context, $offset, $cm, 0);
+        // Number of posts returned that were expected?.
+        $this->assertEquals($postcount - $offset, count($posts));
+    }
+
+    public function test_oublog_tags() {
+        global $USER, $DB, $SITE;
+        $this->resetAfterTest(true);
+        $this->setAdminUser();
+
+        $course = $this->get_new_course();
+        $stud1 = $this->get_new_user('student', $course->id);
+        $group1 = $this->get_new_group($course->id);
+        $group2 = $this->get_new_group($course->id);
+        $this->get_new_group_member($group1->id, $stud1->id);
+
+        // Whole course blog.
+        $oublog = $this->get_new_oublog($course->id);
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+
+        $post = $this->get_post_stub($oublog->id);
+        $post->tags = array('1', 'new', 'new', 'new2', 'a space');
+        $postid = oublog_add_post($post, $cm, $oublog, $course);
+
+        $this->assertEquals(21, strlen(oublog_get_tags_csv($postid)));
+
+        $tags = oublog_get_tags($oublog, 0, $cm, null, -1);
+        $this->assertCount(4, $tags);
+
+        foreach ($tags as $tag) {
+            $this->assertEquals(1, $tag->count);
+            $this->assertContains($tag->tag, $post->tags);
+        }
+
+        // Individual blog.
+        $oublog = $this->get_new_oublog($course->id, array('individual' => OUBLOG_VISIBLE_INDIVIDUAL_BLOGS));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+
+        $post = $this->get_post_stub($oublog->id);
+        $post->tags = array('1', 'new', 'new', 'new2', 'a space');
+        $postid = oublog_add_post($post, $cm, $oublog, $course);
+
+        $tags = oublog_get_tags($oublog, 0, $cm, null, $USER->id);
+        $this->assertCount(4, $tags);
+
+        $tags = oublog_get_tags($oublog, 0, $cm, null, $stud1->id);
+        $this->assertEmpty($tags);
+
+        // Group blog.
+        $oublog = $this->get_new_oublog($course->id, array('groupmode' => VISIBLEGROUPS));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+
+        $post = $this->get_post_stub($oublog->id);
+        $post->groupid = $group1->id;
+        $post->tags = array('1', 'new', 'new', 'new2', 'a space');
+        $postid = oublog_add_post($post, $cm, $oublog, $course);
+
+        $tags = oublog_get_tags($oublog, $group1->id, $cm);
+        $this->assertCount(4, $tags);
+
+        $tags = oublog_get_tags($oublog, $group2->id, $cm);
+        $this->assertEmpty($tags);
+
+        // Personal blog.
+        if (!$oublog = $DB->get_record('oublog', array('global' => 1))) {
+            $oublog = $this->get_new_oublog($SITE->id, array('global' => 1, 'maxvisibility' => OUBLOG_VISIBILITY_PUBLIC));
+        }
+        $cm = get_coursemodule_from_instance('oublog', $oublog->id);
+
+        list($oublog, $bloginstance) = oublog_get_personal_blog($stud1->id);
+
+        $post1stub = $this->get_post_stub($oublog->id);
+        $post1stub->userid = $stud1->id;
+        $post1stub->visibility = OUBLOG_VISIBILITY_COURSEUSER;// Private.
+        $post1stub->tags = array('private');
+        oublog_add_post($post1stub, $cm, $oublog, $SITE);
+        $post2stub = $this->get_post_stub($oublog->id);
+        $post2stub->userid = $stud1->id;
+        $post2stub->visibility = OUBLOG_VISIBILITY_LOGGEDINUSER;// User must be logged in.
+        $post2stub->tags = array('loggedin');
+        oublog_add_post($post2stub, $cm, $oublog, $SITE);
+        $post3stub = $this->get_post_stub($oublog->id);
+        $post3stub->userid = $stud1->id;
+        $post3stub->visibility = OUBLOG_VISIBILITY_PUBLIC;// Any user.
+        $post3stub->tags = array('public');
+        oublog_add_post($post3stub, $cm, $oublog, $SITE);
+
+        $tags = oublog_get_tags($oublog, 0, $cm, $bloginstance->id);
+        $this->assertCount(2, $tags);
+
+        $this->setUser($stud1);
+        $tags = oublog_get_tags($oublog, 0, $cm, $bloginstance->id);
+        $this->assertCount(3, $tags);
+
+        $this->setGuestUser();
+        $tags = oublog_get_tags($oublog, 0, $cm, $bloginstance->id);
+        $this->assertCount(1, $tags);
+
+        $this->setUser($stud1);
+        $post4stub = $this->get_post_stub($oublog->id);
+        $post4stub->userid = $stud1->id;
+        $post4stub->visibility = OUBLOG_VISIBILITY_PUBLIC;// Any user.
+        // Add unordered alphabetic tags.
+        $post4stub->tags = array('toad', 'newt', 'private', 'crock', 'loggedin', 'frog', 'public', 'dino');
+        $postid = oublog_add_post($post4stub, $cm, $oublog, $course);
+        $this->assertEquals(56, strlen(oublog_get_tags_csv($postid)));
+
+        $post5stub = $this->get_post_stub($oublog->id);
+        $post5stub->userid = $stud1->id;
+        $post5stub->visibility = OUBLOG_VISIBILITY_PUBLIC;// Any user.
+        // Add unordered alphabetic tags.
+        $post5stub->tags = array('toad', 'private', 'crock', 'loggedin', 'frog', 'public', 'dino');
+        $postid = oublog_add_post($post5stub, $cm, $oublog, $course);
+        $this->assertEquals(50, strlen(oublog_get_tags_csv($postid)));
+
+        // Recover tags with default ordering ie Alphabetic.
+        $tags = oublog_get_tags($oublog, 0, $cm, null, -1);
+        $this->assertCount(8, $tags);
+        foreach ($tags as $tag) {
+            $this->assertContains($tag->tag, $post4stub->tags);
+        }
+        $this->assertEquals('toad', $tag->tag);// Last in default, Alphabetical order.
+
+        // Recover tags in Use order.
+        $tags = oublog_get_tags($oublog, 0, $cm, null, -1, 'use');
+        $this->assertCount(8, $tags);
+        $lasttag = end($tags);
+        $this->assertEquals('newt', $lasttag->tag);// Last when Use order specified.
+
+        // Recover tags in Alphabetical order.
+        $tags = oublog_get_tags($oublog, 0, $cm, null, -1, 'alpha');
+        $this->assertCount(8, $tags);
+        $lasttag = end($tags);
+        $this->assertEquals('toad', $lasttag->tag);// Last when Alphabetic order specified.
+
+        // Testing the create update of a blog instance with predefined tags.
+        // set and also testing oublog_get_tag_list().
+        // Whole course blog created with predefined tag set.
+        $oublog = $this->get_new_oublog($course->id, array('tagslist' => 'blogtag01'));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+        // Check that the predefined tag is inserted to the oublog_tags table.
+        $blogtags = oublog_clarify_tags($oublog->tagslist);
+        foreach ($blogtags as $tag) {
+            $predefinedtags[] = $DB->get_record('oublog_tags', array('tag' => $tag));
+        }
+        // Confirm finding one predefined tag in the oublog_tags table.
+        $this->assertCount(1, $predefinedtags);
+        // Change the predefined tags on the blog.
+        $oublog->tagslist = 'blogtag01, blogtag02';
+        $oublog->instance = $oublog->id;
+        oublog_update_instance($oublog);
+        // Check that the changed tags are inserted to the oublog_tags table.
+        $blogtags = oublog_clarify_tags($oublog->tagslist);
+        foreach ($blogtags as $tag) {
+            $changedtags[] = $DB->get_record('oublog_tags', array('tag' => $tag));
+        }
+        // Confirm finding predefined tags in the oublog_tags table.
+        $this->assertCount(2, $changedtags);
+        // Create post with 1 pre-defined and 1 user tag.
+        $post = $this->get_post_stub($oublog->id);
+        $post->tags = array('antelope', 'blogtag01');
+        $postid = oublog_add_post($post, $cm, $oublog, $course);
+        $this->assertEquals(19, strlen(oublog_get_tags_csv($postid)));
+        // Recover post tags in default order.
+        $tags = oublog_get_tags($oublog, 0, $cm, null, -1);
+        foreach ($tags as $tag) {
+            $this->assertEquals(1, $tag->count);
+            $this->assertContains($tag->tag, $post->tags);
+        }
+        $this->assertNotEquals('antelope', $tag->tag);
+        $this->assertEquals('blogtag01', $tag->tag);// Last in Alphabetical order.
+
+        // Testing 'Set' tag only restrictions.
+        // No restriction, recover full list of blog 'Set' and post tags.
+        $oublog->restricttags = 0;
+        $taglist = oublog_get_tag_list($oublog, 0, $cm, null, -1);
+        $this->assertCount(3, $taglist);
+        foreach ($taglist as $tag) {
+            $fulltaglist[] = $tag->tag;
+            if (isset($tag->label)) {
+                // It should be an 'Official' ie. 'Set' predefined blog tag.
+                $this->assertContains($tag->tag, $oublog->tagslist);
+                $this->assertNotEmpty($tag->label);
+                $this->assertGreaterThanOrEqual(0, $tag->count);
+            }
+            if (!isset($tag->label)) {
+                // It should be the user post tag.
+                $this->assertContains($tag->tag, $post->tags);
+                $this->assertEquals('antelope', $tag->tag);
+                $this->assertEquals(1, $tag->count);
+            }
+        }
+        $this->assertContains('antelope', $fulltaglist);
+        $this->assertContains('blogtag01', $fulltaglist);
+        $this->assertContains('blogtag02', end($fulltaglist));// Last in full list.
+
+        // Restriction applied, get restricted list of blog 'Set' tags.
+        $oublog->restricttags = 1;
+        $taglist = oublog_get_tag_list($oublog, 0, $cm, null, -1);
+        $this->assertCount(2, $taglist);
+        foreach ($taglist as $tag) {
+            $restrictedtaglist[] = $tag->tag;
+            if (isset($tag->label)) {
+                // It should be an 'Official' ie. 'Set' predefined blog tag.
+                $this->assertContains($tag->tag, $oublog->tagslist);
+                $this->assertNotEmpty($tag->label);
+                $this->assertGreaterThanOrEqual(0, $tag->count);
+            }
+            if (!isset($tag->label)) {
+                $this->assertEmpty($tag->id);
+                $this->assertEmpty($tag->weight);
+                $this->assertEquals(0, $tag->count);
+            }
+        }
+        $this->assertNotContains('antelope', $restrictedtaglist);
+        $this->assertContains('blogtag01', $restrictedtaglist);
+        $this->assertContains('blogtag02', end($restrictedtaglist));// Last in restricted list.
+    }
+
+    public function test_oublog_time_limits() {
+        $this->resetAfterTest();
+        $course = $this->get_new_course();
+        $stud1 = $this->get_new_user('student', $course->id);
+
+        // Future posts + comments start blog.
+        $oublog = $this->get_new_oublog($course->id, array('postfrom' => 2524611600, 'commentfrom' => 2524611600));
+        // Past posts + comments start blog.
+        $oublog1 = $this->get_new_oublog($course->id, array('postfrom' => 1262307600, 'commentfrom' => 1262307600));
+        // Future posts + comments end blog.
+        $oublog2 = $this->get_new_oublog($course->id, array('postuntil' => 2524611600, 'commentuntil' => 2524611600));
+        // Past posts + comments end blog.
+        $oublog3 = $this->get_new_oublog($course->id, array('postuntil' => 1262307600, 'commentuntil' => 1262307600));
+
+        $this->setAdminUser();
+        $this->assertTrue(oublog_can_post_now($oublog, context_module::instance($oublog->cm->id)));
+        $this->assertTrue(oublog_can_post_now($oublog1, context_module::instance($oublog1->cm->id)));
+        $this->assertTrue(oublog_can_post_now($oublog2, context_module::instance($oublog2->cm->id)));
+        $this->assertTrue(oublog_can_post_now($oublog3, context_module::instance($oublog3->cm->id)));
+        $post = (object) array('allowcomments' => true, 'visibility' => OUBLOG_VISIBILITY_COURSEUSER);
+        $this->assertTrue(oublog_can_comment($oublog->cm, $oublog, $post));
+        $this->assertTrue(oublog_can_comment($oublog1->cm, $oublog1, $post));
+        $this->assertTrue(oublog_can_comment($oublog2->cm, $oublog2, $post));
+        $this->assertTrue(oublog_can_comment($oublog3->cm, $oublog3, $post));
+
+        $this->setUser($stud1);
+        $this->assertFalse(oublog_can_post_now($oublog, context_module::instance($oublog->cm->id)));
+        $this->assertTrue(oublog_can_post_now($oublog1, context_module::instance($oublog1->cm->id)));
+        $this->assertTrue(oublog_can_post_now($oublog2, context_module::instance($oublog2->cm->id)));
+        $this->assertFalse(oublog_can_post_now($oublog3, context_module::instance($oublog3->cm->id)));
+        $post = (object) array('allowcomments' => true, 'visibility' => OUBLOG_VISIBILITY_COURSEUSER);
+        $this->assertFalse(oublog_can_comment($oublog->cm, $oublog, $post));
+        $this->assertTrue(oublog_can_comment($oublog1->cm, $oublog1, $post));
+        $this->assertTrue(oublog_can_comment($oublog2->cm, $oublog2, $post));
+        $this->assertFalse(oublog_can_comment($oublog3->cm, $oublog3, $post));
+    }
+}
diff --git a/mod/oublog/tests/oublog_import_getallposts_test.php b/mod/oublog/tests/oublog_import_getallposts_test.php
new file mode 100644
index 0000000..afbf5e1
--- /dev/null
+++ b/mod/oublog/tests/oublog_import_getallposts_test.php
@@ -0,0 +1,190 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Unit tests testing locallib functions inc access etc.
+ * To test all unit tests in this folder use cmd:
+ * find mod/oublog/tests/*_test.php -type f -print | xargs -n1 vendor/bin/phpunit --debug
+ *
+ * @package    mod_oublog
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+
+if (!defined('MOODLE_INTERNAL')) {
+    die('Direct access to this script is forbidden.');// It must be included from a Moodle page.
+}
+global $CFG;
+require_once($CFG->dirroot . '/mod/oublog/tests/oublog_test_lib.php');
+require_once($CFG->dirroot . '/mod/oublog/locallib.php');
+
+class oublog_import_getallposts_test extends oublog_test_lib {
+
+    protected $course1;
+    protected $course2;
+    protected $course3;
+
+    protected function setUp() {
+
+        $this->resetAfterTest(true);
+
+        $this->course1 = $this->getDataGenerator()->create_course(array(
+            'fullname' => 'Course1',
+            'shortname' => 'C1'
+        ));
+        $this->course2 = $this->getDataGenerator()->create_course(array(
+            'fullname' => 'Course2',
+            'shortname' => 'C2'
+        ));
+        $this->course3 = $this->getDataGenerator()->create_course(array(
+            'fullname' => 'Course3',
+            'shortname' => 'C3'
+        ));
+
+        $user = $this->get_new_user();
+        $this->setUser($user);
+    }
+
+    /**
+     * Test the case get all post in blog.
+     */
+    public function test_oublog_import_getallposts() {
+        // Create blog and post for course1.
+        $blog = $this->get_new_oublog($this->course1);
+        $this->get_new_post($blog);
+        $this->get_new_post($blog);
+        $this->get_new_post($blog);
+
+        $result = oublog_import_getallposts($blog->id, 'timeposted ASC');
+
+        $this->assertNotNull($result);
+
+        // Expect 3 data return.
+        $this->assertEquals(count($result[0]), 3);
+
+        // Expect 3 data return.
+        $this->assertEquals($result[1], 3);
+    }
+
+    /**
+     * Test the case get all post in 1 blog but create 2 blog.
+     */
+    public function test_oublog_import_getallposts_in1blog() {
+        // Create blog and post for course1.
+        $blog1 = $this->get_new_oublog($this->course1);
+        $this->get_new_post($blog1);
+        $this->get_new_post($blog1);
+        $this->get_new_post($blog1);
+
+        $blog2 = $this->get_new_oublog($this->course1);
+        $this->get_new_post($blog2);
+        $this->get_new_post($blog2);
+        $this->get_new_post($blog2);
+        $this->get_new_post($blog2);
+
+        $result = oublog_import_getallposts($blog1->id, 'timeposted ASC');
+
+        $this->assertNotNull($result);
+
+        // Expect 3 data return.
+        $this->assertEquals(count($result[0]), 3);
+
+        // Expect 3 total data return.
+        $this->assertEquals($result[1], 3);
+    }
+
+    /**
+     * Test the case get all post in blog with the number of post not enough for limit from.
+     */
+    public function test_oublog_import_getallposts_not_enough_post() {
+
+        global $USER;
+        // Create blog and post for course1.
+        $blog = $this->get_new_oublog($this->course2);
+
+        // Create 100 post in blog.
+        for ($x = 0; $x < 100; $x++) {
+             $this->get_new_post($blog);
+        }
+
+        // Set limit from 100 (limit from = page * perpage).
+        $page = 1;
+        $result = oublog_import_getallposts($blog->id, 'timeposted DESC', $USER->id, $page);
+
+        $this->assertNotNull($result);
+
+        // Expect 0 data return.
+        $this->assertEquals(count($result[0]), 0);
+
+        // Expect 0 total data return.
+        $this->assertEquals($result[1], 0);
+    }
+
+    /**
+     * Test the case get all post in blog with the number of post enough for limit from.
+     */
+    public function test_oublog_import_getallposts_enough_post() {
+
+        global $USER;
+        // Create blog and post for course1.
+        $blog = $this->get_new_oublog($this->course1);
+
+        // Create 150 post in blog.
+        for ($x = 0; $x < 150; $x++) {
+             $this->get_new_post($blog);
+        }
+        // Set limit from 100 (limit from = page * perpage).
+        $page = 1;
+        $result = oublog_import_getallposts($blog->id, 'timeposted DESC', $USER->id, 1);
+
+        $this->assertNotNull($result);
+
+        // Expect 50 data return.
+        $this->assertEquals(count($result[0]), 50);
+
+        // Expect 150 total data return.
+        $this->assertEquals($result[1], 150);
+    }
+
+    /**
+     * Test the case get all post in blog with 1 post is deleted.
+     */
+    public function test_oublog_import_getallposts_with1post_delete() {
+        global $USER;
+        // Create blog and post for course1.
+        $blog = $this->get_new_oublog($this->course1);
+        $post1 = $this->get_post_stub($blog->id);
+        $post2 = $this->get_post_stub($blog->id);
+
+        // Delete post 1.
+        $post1->deletedby = $USER->id;
+
+        // Set post 1 & 2 to blog.
+        $post1id = $this->get_new_post($blog, $post1);
+        $post2id = $this->get_new_post($blog, $post2);
+
+        $result = oublog_import_getallposts($blog->id, 'timeposted DESC', $USER->id);
+        $this->assertNotNull($result);
+
+        // Expect 1 data return.
+        $this->assertEquals(count($result[0]), 1);
+
+        // Expect 1 total data return.
+        $this->assertEquals($result[1], 1);
+    }
+
+}
diff --git a/mod/oublog/tests/oublog_import_getbloginfo_test.php b/mod/oublog/tests/oublog_import_getbloginfo_test.php
new file mode 100644
index 0000000..e36dfba
--- /dev/null
+++ b/mod/oublog/tests/oublog_import_getbloginfo_test.php
@@ -0,0 +1,169 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+global $CFG;
+require_once($CFG->dirroot . '/mod/oublog/tests/oublog_test_lib.php');
+require_once($CFG->dirroot . '/mod/oublog/locallib.php');
+
+class oublog_import_getbloginfo_test extends oublog_test_lib
+{
+    protected $course1;
+    protected $course2;
+    protected $course3;
+
+    protected function setUp() {
+        $this->resetAfterTest(true);
+
+        $this->course1 = $this->getDataGenerator()->create_course(array(
+            'fullname' => 'Course1',
+            'shortname' => 'C1'
+        ));
+        $this->course2 = $this->getDataGenerator()->create_course(array(
+            'fullname' => 'Course2',
+            'shortname' => 'C2'
+        ));
+        $this->course3 = $this->getDataGenerator()->create_course(array(
+            'fullname' => 'Course3',
+            'shortname' => 'C3'
+        ));
+
+        $user = $this->get_new_user();
+        $this->setUser($user);
+    }
+
+
+    /**
+     * Pass the not existing blog.
+     */
+    public function test_oublog_import_getbloginfo_noblog() {
+        // Expect exception because the blog and course not existed.
+        $this->setExpectedException('dml_missing_record_exception');
+
+        oublog_import_getbloginfo(-1);
+    }
+
+    /**
+     * Have course and blog, but user haven't enrolled.
+     */
+    public function test_oublog_import_getbloginfo_have_course_blog_unenrolled() {
+        $blog = $this->get_new_oublog($this->course1, array('global' => 0, 'individual' => OUBLOG_VISIBLE_INDIVIDUAL_BLOGS));
+
+        // Expect exception because the user haven't enroll into this course yet.
+        $this->setExpectedException('moodle_exception');
+
+        oublog_import_getbloginfo($blog->cm->id);
+    }
+
+    /**
+     * Have course and blog, but user haven't enrolled to this course (but another course).
+     */
+    public function test_oublog_import_getbloginfo_have_2course_blog_enrolldifferent() {
+        global $USER;
+
+        // Enroll this user into course2.
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course2->id);
+
+        // Create 1 blog for course1 and course2.
+        $blog = $this->get_new_oublog($this->course1, array('global' => 0, 'individual' => OUBLOG_VISIBLE_INDIVIDUAL_BLOGS));
+        $this->get_new_oublog($this->course2, array('global' => 0, 'individual' => OUBLOG_VISIBLE_INDIVIDUAL_BLOGS));
+
+        // Expect exception because the user haven't enroll into correct course.
+        $this->setExpectedException('moodle_exception');
+
+        oublog_import_getbloginfo($blog->cm->id);
+    }
+
+    /**
+     * Have course and blog (OUBLOG_NO_INDIVIDUAL_BLOGS), global = false, and user enrolled.
+     */
+    public function test_oublog_import_getbloginfo_have_2course_blog_no_individual() {
+        global $USER;
+
+        // Enroll this user into course1.
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        // Create 1 blog for course1.
+        $blog = $this->get_new_oublog($this->course1, array('global' => 0, 'individual' => OUBLOG_NO_INDIVIDUAL_BLOGS));
+
+        // Expect exception because the individual is set to OUBLOG_NO_INDIVIDUAL_BLOGS.
+        $this->setExpectedException('moodle_exception');
+
+        oublog_import_getbloginfo($blog->cm->id);
+    }
+
+    /**
+     * Have course and blog (OUBLOG_SEPARATE_INDIVIDUAL_BLOGS), global = false, and user enrolled.
+     */
+    public function test_oublog_import_getbloginfo_have_2course_blog_separate_individual() {
+        global $USER;
+
+        // Enroll this user into course1.
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        // Create 1 blog for course1.
+        $blog = $this->get_new_oublog($this->course1, array('global' => 0, 'individual' => OUBLOG_SEPARATE_INDIVIDUAL_BLOGS));
+        $result = oublog_import_getbloginfo($blog->cm->id);
+
+        // Expect return blog info.
+        $this->assertNotNull($result);
+        $this->assertEquals($result[0], $blog->cm->id);
+        $this->assertEquals($result[1], $blog->id);
+        $this->assertEquals($result[3], $this->course1->shortname . ' ' . $this->course1->fullname . ' : ' . $blog->name);
+        $this->assertEquals($result[4], $this->course1->shortname);
+    }
+
+    /**
+     * Have course and blog (OUBLOG_VISIBLE_INDIVIDUAL_BLOGS), global = false, and user enrolled.
+     */
+    public function test_oublog_import_getbloginfo_have_2course_blog_visible_individual() {
+        global $USER;
+
+        // Enroll this user into course1.
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        // Create 1 blog for course1.
+        $blog = $this->get_new_oublog($this->course1, array('global' => 0, 'individual' => OUBLOG_VISIBLE_INDIVIDUAL_BLOGS));
+        $result = oublog_import_getbloginfo($blog->cm->id);
+
+        // Expect return blog info.
+        $this->assertNotNull($result);
+        $this->assertEquals($result[0], $blog->cm->id);
+        $this->assertEquals($result[1], $blog->id);
+        $this->assertEquals($result[3], $this->course1->shortname . ' ' . $this->course1->fullname . ' : ' . $blog->name);
+        $this->assertEquals($result[4], $this->course1->shortname);
+    }
+
+    /**
+     * Have course and blog (OUBLOG_NO_INDIVIDUAL_BLOGS), global = true, and user enrolled.
+     */
+    public function test_oublog_import_getbloginfo_have_2course_blog_no_individual_global() {
+        global $USER;
+
+        // Enroll this user into course1.
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        // Create 1 blog for course1.
+        $blog = $this->get_new_oublog($this->course1, array('global' => 1, 'individual' => OUBLOG_NO_INDIVIDUAL_BLOGS));
+        $result = oublog_import_getbloginfo($blog->cm->id);
+
+        // Expect return blog info with course shortname is empty.
+        $this->assertNotNull($result);
+        $this->assertEquals($result[0], $blog->cm->id);
+        $this->assertEquals($result[1], $blog->id);
+        $this->assertEquals($result[3], '');
+        $this->assertEquals($result[4], '');
+    }
+}
\ No newline at end of file
diff --git a/mod/oublog/tests/oublog_import_getblogs_test.php b/mod/oublog/tests/oublog_import_getblogs_test.php
new file mode 100644
index 0000000..99f4b3a
--- /dev/null
+++ b/mod/oublog/tests/oublog_import_getblogs_test.php
@@ -0,0 +1,289 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+global $CFG;
+require_once($CFG->dirroot . '/mod/oublog/tests/oublog_test_lib.php');
+require_once($CFG->dirroot . '/mod/oublog/locallib.php');
+
+class oublog_import_getblogs_test extends oublog_test_lib
+{
+    protected $course1;
+    protected $course2;
+    protected $course3;
+
+    protected function setUp() {
+        $this->resetAfterTest(true);
+
+        $this->course1 = $this->getDataGenerator()->create_course(array(
+            'fullname' => 'Course1',
+            'shortname' => 'C1'
+        ));
+        $this->course2 = $this->getDataGenerator()->create_course(array(
+            'fullname' => 'Course2',
+            'shortname' => 'C2'
+        ));
+        $this->course3 = $this->getDataGenerator()->create_course(array(
+            'fullname' => 'Course3',
+            'shortname' => 'C3'
+        ));
+
+        $user = $this->get_new_user();
+        $this->setUser($user);
+    }
+
+
+    /**
+     * Test the case user have not enrolled into the course (but the course have blog and post).
+     */
+    public function test_oublog_import_getblogs_noenroll() {
+        // Create blog and post for course1.
+        $blog = $this->get_new_oublog($this->course1);
+        $this->get_new_post($blog);
+
+        $result = oublog_import_getblogs();
+
+        // Expect no data return.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 0);
+    }
+
+    /**
+     * Test the case user enrolled into the course, but the course don't have any blog and post.
+     */
+    public function test_oublog_import_getblogs_enrollnoblog() {
+        global $USER;
+
+        // Enroll current user into course 1.
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        $result = oublog_import_getblogs();
+
+        // Expect no data return.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 0);
+    }
+
+    /**
+     * Test the case user enrolled into the course, but the course don't have any post.
+     */
+    public function test_oublog_import_getblogs_enrollnopost() {
+        global $USER;
+
+        // Enroll current user into course 1.
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+        $this->get_new_oublog($this->course1);
+
+        $result = oublog_import_getblogs();
+
+        // Expect no data return.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 0);
+    }
+
+    /**
+     * Test the case user enrolled into the course, the course have 1 blog(visible) and 2 posts.
+     */
+    public function test_oublog_import_getblogs_enroll_1blog_2posts() {
+        global $USER;
+
+        // Enroll current user into course 1.
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+        $blog = $this->get_new_oublog($this->course1, array('individual' => OUBLOG_VISIBLE_INDIVIDUAL_BLOGS));
+        $this->get_new_post($blog);
+        $this->get_new_post($blog);
+
+        $result = oublog_import_getblogs();
+
+        // Expect return one blog and the number of post equal to 2.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 1);
+        $this->assertEquals($result[0]->numposts, 2);
+    }
+
+    /**
+     * Test the case user enrolled into the course, the course have 2 blog(visible) and posts.
+     */
+    public function test_oublog_import_getblogs_enroll_2blog_posts() {
+        global $USER;
+
+        // Enroll current user into course 1.
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+        $blog1 = $this->get_new_oublog($this->course1, array('individual' => OUBLOG_VISIBLE_INDIVIDUAL_BLOGS));
+        $this->get_new_post($blog1);
+        $this->get_new_post($blog1);
+        $this->get_new_post($blog1);
+
+        $blog2 = $this->get_new_oublog($this->course1, array('individual' => OUBLOG_VISIBLE_INDIVIDUAL_BLOGS));
+        $this->get_new_post($blog2);
+        $this->get_new_post($blog2);
+
+        $result = oublog_import_getblogs();
+
+        // Expect return one blog and the number of post equal to 2.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 2);
+        $this->assertEquals($result[0]->numposts, 3);
+        $this->assertEquals($result[1]->numposts, 2);
+    }
+
+    /**
+     * Test the case user enrolled into the course, has two course with blog and post but user only enroll in course1.
+     */
+    public function test_oublog_import_getblogs_enroll_2blog_posts_differentcourse() {
+        global $USER;
+
+        // Enroll current user into course 1.
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+        $blog1 = $this->get_new_oublog($this->course1, array('individual' => OUBLOG_VISIBLE_INDIVIDUAL_BLOGS));
+        $this->get_new_post($blog1);
+        $this->get_new_post($blog1);
+        $this->get_new_post($blog1);
+
+        $blog2 = $this->get_new_oublog($this->course2, array('individual' => OUBLOG_VISIBLE_INDIVIDUAL_BLOGS));
+        $this->get_new_post($blog2);
+        $this->get_new_post($blog2);
+
+        $result = oublog_import_getblogs();
+
+        // Expect return one blog and the number of post equal to 3.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 1);
+        $this->assertEquals($result[0]->numposts, 3);
+    }
+
+    /**
+     * Test the case user enrolled into the course, don't display the blog that has individual = OUBLOG_NO_INDIVIDUAL_BLOGS.
+     */
+    public function test_oublog_import_getblogs_enroll_3blog_differentindividual() {
+        global $USER;
+
+        // Enroll current user into course 1.
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        $blog1 = $this->get_new_oublog($this->course1,
+            array('name' => 'Blog1', 'individual' => OUBLOG_NO_INDIVIDUAL_BLOGS));
+        $this->get_new_post($blog1);
+        $blog2 = $this->get_new_oublog($this->course1,
+            array('name' => 'Blog2', 'individual' => OUBLOG_SEPARATE_INDIVIDUAL_BLOGS));
+        $this->get_new_post($blog2);
+        $this->get_new_post($blog2);
+        $blog3 = $this->get_new_oublog($this->course1,
+            array('name' => 'Blog3', 'individual' => OUBLOG_VISIBLE_INDIVIDUAL_BLOGS));
+        $this->get_new_post($blog3);
+        $this->get_new_post($blog3);
+        $this->get_new_post($blog3);
+
+        $result = oublog_import_getblogs();
+
+        // Expect return blog2 and blog 3. because of the individual.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 2);
+        $this->assertEquals($result[0]->name, $blog2->name);
+        $this->assertEquals($result[0]->numposts, 2);
+        $this->assertEquals($result[1]->name, $blog3->name);
+        $this->assertEquals($result[1]->numposts, 3);
+    }
+
+    /**
+     * Test the case user enrolled into the course, exclude the current blog.
+     */
+    public function test_oublog_import_getblogs_enroll_3blog_exclude_current_post() {
+        global $USER;
+
+        // Enroll current user into course 1.
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        $blog1 = $this->get_new_oublog($this->course1,
+            array('name' => 'Blog1', 'individual' => OUBLOG_VISIBLE_INDIVIDUAL_BLOGS));
+        $this->get_new_post($blog1);
+        $blog2 = $this->get_new_oublog($this->course1,
+            array('name' => 'Blog2', 'individual' => OUBLOG_VISIBLE_INDIVIDUAL_BLOGS));
+        $this->get_new_post($blog2);
+        $this->get_new_post($blog2);
+        $blog3 = $this->get_new_oublog($this->course1,
+            array('name' => 'Blog3', 'individual' => OUBLOG_VISIBLE_INDIVIDUAL_BLOGS));
+        $this->get_new_post($blog3);
+        $this->get_new_post($blog3);
+        $this->get_new_post($blog3);
+
+        $result = oublog_import_getblogs(0, $blog2->cm->id);
+
+        // Expect return only blog2 and blog 3. because of the individual.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 2);
+        $this->assertEquals($result[0]->name, $blog1->name);
+        $this->assertEquals($result[0]->numposts, 1);
+        $this->assertEquals($result[1]->name, $blog3->name);
+        $this->assertEquals($result[1]->numposts, 3);
+    }
+
+    /**
+     * Test the case user is guest.
+     */
+    public function test_oublog_import_getblogs_guest_account() {
+        global $USER;
+        $this->setGuestUser();
+
+        $blog = $this->get_new_oublog($this->course1, array('individual' => OUBLOG_VISIBLE_INDIVIDUAL_BLOGS));
+        $this->get_new_post($blog);
+        $this->get_new_post($blog);
+
+        $result = oublog_import_getblogs();
+
+        // Expect return nothing because the account is guest.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 0);
+    }
+
+    /**
+     * Test the case user is admin but not enroll into course.
+     */
+    public function test_oublog_import_getblogs_admin_unenrolled() {
+        $this->setAdminUser();
+
+        $blog = $this->get_new_oublog($this->course1, array('individual' => OUBLOG_VISIBLE_INDIVIDUAL_BLOGS));
+        $this->get_new_post($blog);
+        $this->get_new_post($blog);
+
+        $result = oublog_import_getblogs();
+
+        // Expect return nothing because the account is admin but not enroll into course.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 0);
+    }
+
+    /**
+     * Test the case user is admin and enroll into course.
+     */
+    public function test_oublog_import_getblogs_admin_enrolled() {
+        global $USER;
+        $this->setAdminUser();
+
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+
+        $blog = $this->get_new_oublog($this->course1, array('individual' => OUBLOG_VISIBLE_INDIVIDUAL_BLOGS));
+        $this->get_new_post($blog);
+        $this->get_new_post($blog);
+
+        $result = oublog_import_getblogs();
+
+        // Expect return nothing 1 blog and 2 posts.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 1);
+        $this->assertEquals($result[0]->name, $blog->name);
+        $this->assertEquals($result[0]->numposts, 2);
+    }
+}
\ No newline at end of file
diff --git a/mod/oublog/tests/oublog_import_getposts_test.php b/mod/oublog/tests/oublog_import_getposts_test.php
new file mode 100644
index 0000000..f5c0f04
--- /dev/null
+++ b/mod/oublog/tests/oublog_import_getposts_test.php
@@ -0,0 +1,273 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+global $CFG;
+require_once($CFG->dirroot . '/mod/oublog/tests/oublog_test_lib.php');
+require_once($CFG->dirroot . '/mod/oublog/locallib.php');
+
+class oublog_import_getposts_test extends oublog_test_lib
+{
+    protected $course1;
+    protected $course2;
+    protected $course3;
+
+    private function create_content($instance, $record = array()) {
+        global $USER, $DB, $CFG;
+        require_once($CFG->dirroot . '/mod/oublog/locallib.php');
+
+        $cm = get_coursemodule_from_instance('oublog', $instance->id);
+        $context = context_module::instance($cm->id);
+        $course = get_course($instance->course);
+
+        if (isset($record['comment'])) {
+            if (empty($record['comment']->postid)) {
+                throw new coding_exception('Must pass postid when creating comment');
+            }
+            if (empty($record['comment']->userid)) {
+                $record['comment']->userid = $USER->id;
+            }
+            if (empty($record['comment']->messagecomment)) {
+                if (empty($record['comment']->message)) {
+                    $record['comment']->messagecomment = array('text' => 'Test comment');
+                } else {
+                    // Support message being string to insert in db not form style.
+                    $record['comment']->messagecomment = array('text' => $record['comment']->message);
+                }
+            } else {
+                if (is_string($record['comment']->messagecomment)) {
+                    // Support message being string to insert in db not form style.
+                    $record['comment']->messagecomment = array('text' => $record['comment']->messagecomment);
+                }
+            }
+            return oublog_add_comment($course, $cm, $instance, $record['comment']);
+        }
+        return null;
+    }
+
+    protected function setUp() {
+        $this->resetAfterTest(true);
+
+        $this->course1 = $this->getDataGenerator()->create_course(array(
+            'fullname' => 'Course1',
+            'shortname' => 'C1'
+        ));
+        $this->course2 = $this->getDataGenerator()->create_course(array(
+            'fullname' => 'Course2',
+            'shortname' => 'C2'
+        ));
+        $this->course3 = $this->getDataGenerator()->create_course(array(
+            'fullname' => 'Course3',
+            'shortname' => 'C3'
+        ));
+
+        $user = $this->get_new_user();
+        $this->setUser($user);
+    }
+
+
+    /**
+     * Blog don't have any post, select wrong post id.
+     */
+    public function test_oublog_import_getposts_test_nopost_selectwrongpost() {
+        global $USER;
+
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+        $blog = $this->get_new_oublog($this->course1, array('global' => 1, 'individual' => OUBLOG_NO_INDIVIDUAL_BLOGS));
+
+        $result = oublog_import_getposts($blog->id, $blog->cm->id, array(100000, 200000));
+
+        // Expect return nothing.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 0);
+    }
+
+    /**
+     * Blog have 1 post, select wrong post id.
+     */
+    public function test_oublog_import_getposts_test_1post_selectwrong() {
+        global $USER;
+
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+        $blog = $this->get_new_oublog($this->course1, array('global' => 1, 'individual' => OUBLOG_NO_INDIVIDUAL_BLOGS));
+        $this->get_new_post($blog);
+        $result = oublog_import_getposts($blog->id, $blog->cm->id, array(123));
+
+        // Expect return nothing.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 0);
+    }
+
+    /**
+     * Blog have 1 post, select correct id.
+     */
+    public function test_oublog_import_getposts_test_1post_selectcorrect() {
+        global $USER;
+
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+        $blog = $this->get_new_oublog($this->course1, array('global' => 1, 'individual' => OUBLOG_NO_INDIVIDUAL_BLOGS));
+        $post1id = $this->get_new_post($blog);
+        $result = oublog_import_getposts($blog->id, $blog->cm->id, array($post1id));
+
+        // Expect return one post.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 1);
+        $this->assertEquals($result[$post1id]->id, $post1id);
+        $this->assertEquals($result[$post1id]->title, 'testpost');
+        $this->assertEquals($result[$post1id]->message, '<p>newpost</p>');
+    }
+
+    /**
+     * Blog have 2 posts, select correct id.
+     */
+    public function test_oublog_import_getposts_test_2post_selectcorrect() {
+        global $USER;
+
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+        $blog = $this->get_new_oublog($this->course1, array('global' => 1, 'individual' => OUBLOG_NO_INDIVIDUAL_BLOGS));
+        $post1id = $this->get_new_post($blog);
+        $post2id = $this->get_new_post($blog);
+
+        $result = oublog_import_getposts($blog->id, $blog->cm->id, array($post1id, $post2id));
+
+        // Expect return 2 posts.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 2);
+        $this->assertEquals($result[$post1id]->id, $post1id);
+        $this->assertEquals($result[$post2id]->id, $post2id);
+    }
+
+    /**
+     * Blog have 1 posts and have 2 comments, select correct id, include comment = false.
+     */
+    public function test_oublog_import_getposts_test_1post_2comment_notinclude() {
+        global $USER;
+
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+        $blog = $this->get_new_oublog($this->course1, array('global' => 1, 'individual' => OUBLOG_NO_INDIVIDUAL_BLOGS));
+        $post1 = $this->get_post_stub($blog->id);
+
+        $post1id = $this->get_new_post($blog, $post1);
+
+        $comment1 = $this->get_comment_stub($post1id, $USER->id);
+        $comment2 = $this->get_comment_stub($post1id, $USER->id);
+        $this->create_content($blog, array('comment' => (object)clone $comment1));
+        $this->create_content($blog, array('comment' => (object)clone $comment2));
+
+        $result = oublog_import_getposts($blog->id, $blog->cm->id, array($post1id), false);
+
+        // Expect return 1 post with no comment.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 1);
+        $this->assertEquals($result[$post1id]->id, $post1id);
+        $this->assertEquals(count($result[$post1id]->comments), 0);
+    }
+
+    /**
+     * Blog have 1 posts and have 2 comments, select correct id, include comment = true.
+     */
+    public function test_oublog_import_getposts_test_1post_2comment_included() {
+        global $USER;
+
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+        $blog = $this->get_new_oublog($this->course1, array('global' => 1, 'individual' => OUBLOG_NO_INDIVIDUAL_BLOGS));
+
+        $post1 = $this->get_post_stub($blog->id);
+        $post1id = $this->get_new_post($blog, $post1);
+
+        $comment1 = $this->get_comment_stub($post1id, $USER->id);
+        $comment1->title = 'Comment1';
+        $comment1->messagecomment = 'Comment 1 message';
+        $comment2 = $this->get_comment_stub($post1id, $USER->id);
+        $comment2->title = 'Comment2';
+        $comment2->messagecomment = 'Comment 2 message';
+
+        $comment1id = $this->create_content($blog, array('comment' => (object)clone $comment1));
+        $comment2id = $this->create_content($blog, array('comment' => (object)clone $comment2));
+
+        $result = oublog_import_getposts($blog->id, $blog->cm->id, array($post1id), true);
+
+        // Expect return 1 post with 2 comments.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 1);
+        $this->assertEquals($result[$post1id]->id, $post1id);
+        $this->assertEquals(count($result[$post1id]->comments), 2);
+        $this->assertEquals($result[$post1id]->comments[$comment1id]->id, $comment1id);
+        $this->assertEquals($result[$post1id]->comments[$comment1id]->title, $comment1->title);
+        $this->assertEquals($result[$post1id]->comments[$comment1id]->message, $comment1->messagecomment);
+        $this->assertEquals($result[$post1id]->comments[$comment2id]->id, $comment2id);
+        $this->assertEquals($result[$post1id]->comments[$comment2id]->title, $comment2->title);
+        $this->assertEquals($result[$post1id]->comments[$comment2id]->message, $comment2->messagecomment);
+    }
+
+    /**
+     * Blog have 2 posts, 1 post deleted, select correct id.
+     */
+    public function test_oublog_import_getposts_test_1post_2comment_1deleted() {
+        global $USER;
+
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+        $blog = $this->get_new_oublog($this->course1, array('global' => 1, 'individual' => OUBLOG_NO_INDIVIDUAL_BLOGS));
+
+        $post1 = $this->get_post_stub($blog->id);
+        $post1id = $this->get_new_post($blog, $post1);
+
+        $comment1 = $this->get_comment_stub($post1id, $USER->id);
+        $comment1->deletedby = $USER->id;
+        $comment2 = $this->get_comment_stub($post1id, $USER->id);
+
+        $this->create_content($blog, array('comment' => (object)clone $comment1));
+        $comment2id = $this->create_content($blog, array('comment' => (object)clone $comment2));
+
+        $result = oublog_import_getposts($blog->id, $blog->cm->id, array($post1id), true);
+
+        // Expect return 1 post with only comment2 because the comment1 has been deleted.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 1);
+        $this->assertEquals($result[$post1id]->id, $post1id);
+        $this->assertEquals(count($result[$post1id]->comments), 1);
+        $this->assertEquals($result[$post1id]->comments[$comment2id]->id, $comment2id);
+    }
+
+    /**
+     * Blog have 2 posts, 1 post not belong to current user, select correct id.
+     */
+    public function test_oublog_import_getposts_test_1post_2comment_1notbelongtouser() {
+        global $USER;
+
+        $anotheruser = $this->get_new_user();
+
+        $this->getDataGenerator()->enrol_user($USER->id, $this->course1->id);
+        $blog = $this->get_new_oublog($this->course1, array('global' => 1, 'individual' => OUBLOG_NO_INDIVIDUAL_BLOGS));
+
+        $post1 = $this->get_post_stub($blog->id);
+        $post1id = $this->get_new_post($blog, $post1);
+
+        $comment1 = $this->get_comment_stub($post1id, $anotheruser->id);
+        $comment2 = $this->get_comment_stub($post1id, $USER->id);
+
+        $this->create_content($blog, array('comment' => (object)clone $comment1));
+        $comment2id = $this->create_content($blog, array('comment' => (object)clone $comment2));
+
+        $result = oublog_import_getposts($blog->id, $blog->cm->id, array($post1id), true);
+
+        // Expect return 1 post with only with comment2 only because comment1 belong to other user.
+        $this->assertNotNull($result);
+        $this->assertEquals(count($result), 1);
+        $this->assertEquals($result[$post1id]->id, $post1id);
+        $this->assertEquals(count($result[$post1id]->comments), 1);
+        $this->assertEquals($result[$post1id]->comments[$comment2id]->id, $comment2id);
+    }
+}
\ No newline at end of file
diff --git a/mod/oublog/tests/oublog_test_lib.php b/mod/oublog/tests/oublog_test_lib.php
new file mode 100644
index 0000000..fa18673
--- /dev/null
+++ b/mod/oublog/tests/oublog_test_lib.php
@@ -0,0 +1,162 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * This is a lib/helper class for oublog tests, containing useful setup functions
+ * Include + Extend this class in your test rather than advance_testcase
+ *
+ * @package    mod_oublog
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+abstract class oublog_test_lib extends advanced_testcase {
+    /*
+     These functions require us to create database entries and/or grab objects to make it possible to test the
+    many permuations required for OU Blogs.
+
+    */
+
+    /**
+     * Creates a new user and enrols them on course with role specified (optional)
+     * @param string $rolename role shortname if enrolment required
+     * @param int $courseid course id to enrol on
+     * @return stdClass user
+     */
+    public function get_new_user($rolename = null, $courseid = null) {
+        global $DB;
+        $user = $this->getDataGenerator()->create_user();
+
+        // Assign role if required.
+        if ($rolename && $courseid) {
+            $role = $DB->get_record('role', array('shortname' => $rolename));
+            $this->getDataGenerator()->enrol_user($user->id, $courseid, $role->id);
+        }
+
+        return $user;
+    }
+
+    public function get_new_course() {
+        $course = new stdClass();
+        $course->fullname = 'Anonymous test course';
+        $course->shortname = 'ANON';
+        return $this->getDataGenerator()->create_course($course);
+    }
+
+    public function get_new_group($courseid) {
+        $group = new stdClass();
+        $group->courseid = $courseid;
+        $group->name = 'test group';
+        return $this->getDataGenerator()->create_group($group);
+    }
+
+    public function get_new_group_member($groupid, $userid) {
+        $member = new stdClass();
+        $member->groupid = $groupid;
+        $member->userid = $userid;
+        return $this->getDataGenerator()->create_group_member($member);
+    }
+
+    /**
+     * Create new oublog instance using generator, returns instance record + cm
+     * @param int $courseid
+     * @param array $options
+     */
+    public function get_new_oublog($courseid, $options = null) {
+        if (is_null($options)) {
+            $options = array();
+        } else {
+            $options = (array) $options;
+        }
+        $options['course'] = $courseid;
+
+        $generator = $this->getDataGenerator()->get_plugin_generator('mod_oublog');
+        $oublog = $generator->create_instance((object) $options);
+        $this->assertNotEmpty($oublog);
+        $cm = get_coursemodule_from_instance('oublog', $oublog->id);
+        $this->assertNotEmpty($cm);
+        $oublog->cm = $cm;
+        return $oublog;
+    }
+
+    /**
+     * Wrapper for generator create_content() to add a post
+     * Supports creating post attachments ($post->attachments)
+     * @param object $oublog
+     * @param object $post
+     */
+    public function get_new_post($oublog, $post = null) {
+        if (empty($post)) {
+            $post = $this->get_post_stub($oublog->id);
+        }
+        $generator = $this->getDataGenerator()->get_plugin_generator('mod_oublog');
+        $postid = $generator->create_content($oublog, array('post' => (object) clone $post));
+        if (!empty($post->attachments)) {
+            // Adds attachments - send key = file name, value = contents e.g. 'a.txt' => 'test'.
+            $fs = get_file_storage();
+            $context = context_module::instance($oublog->cmid);
+            $filerec = array(
+                    'filepath' => '/',
+                    'contextid' => $context->id,
+                    'component' => 'mod_oublog',
+                    'filearea' => 'attachments',
+                    'itemid' => $postid
+                    );
+            foreach ($post->attachments as $filename => $content) {
+                $filerec['filename'] = $filename;
+                $fs->create_file_from_string($filerec, $content);
+            }
+        }
+        return $postid;
+    }
+
+    /**
+     * Returns a basic post record as if from a form.
+     * @param int $oublogid
+     * @return stdClass
+     */
+    public function get_post_stub($oublogid) {
+        global $USER;
+        $post = new stdClass();
+        $post->oublogid = $oublogid;
+        $post->userid = $USER->id;
+        $post->groupid = 0;
+        $post->title = 'testpost';
+        $post->message = array();
+        $post->message['itemid'] = 1;
+        $post->message['text'] = '<p>newpost</p>';
+        $post->allowcomments = 1;
+        $post->visibility = 100;
+        $post->attachments = '';
+        return $post;
+    }
+
+    /**
+     * Returns a basic comment record as if from a form.
+     * @param int $postid
+     * @param int $userid
+     * @return stdClass
+     */
+    public function get_comment_stub($postid, $userid) {
+        $comment = new stdClass();
+        $comment->title = 'Test Comment';
+        $comment->messagecomment = array();
+        $comment->messagecomment['text'] = 'Message for test comment';
+        $comment->postid = $postid;
+        $comment->userid = $userid;
+        return $comment;
+    }
+}
diff --git a/mod/oublog/tests/participation_test.php b/mod/oublog/tests/participation_test.php
new file mode 100644
index 0000000..13b4376
--- /dev/null
+++ b/mod/oublog/tests/participation_test.php
@@ -0,0 +1,383 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Tests user participation functions.
+ *
+ * @package    mod_oublog
+ * @copyright  2014 The Open University
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+if (!defined('MOODLE_INTERNAL')) {
+    die('Direct access to this script is forbidden.');// It must be included from a Moodle page.
+}
+global $CFG;
+require_once($CFG->dirroot . '/mod/oublog/tests/oublog_test_lib.php');
+require_once($CFG->dirroot . '/mod/oublog/locallib.php');
+
+class oublog_participation_test extends oublog_test_lib {
+    // Test access to My Participation buttons.
+    public function test_myparticipation_access() {
+        global $SITE, $USER;
+        $this->resetAfterTest(true);
+
+        // Whole course.
+        $course = $this->get_new_course();
+
+        $student = $this->get_new_user('student', $course->id);
+        $student2 = $this->get_new_user('student', $course->id);
+        $grp1 = $this->get_new_group($course->id);
+        $grp2 = $this->get_new_group($course->id);
+        $this->get_new_group_member($grp1->id, $student->id);
+        $this->get_new_group_member($grp2->id, $student2->id);
+
+        $oublog = $this->get_new_oublog($course->id);
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+        $this->setUser($student);
+
+        $this->assertEquals(OUBLOG_MY_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+
+        $this->setGuestUser();
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+
+        // Separate groups.
+        $oublog = $this->get_new_oublog($course->id, array('groupmode' => SEPARATEGROUPS));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp1->id));
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp2->id));
+
+        $this->setUser($student);
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        $this->assertEquals(OUBLOG_MY_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp1->id));
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp2->id));
+
+        $this->setUser($student2);
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp1->id));
+        $this->assertEquals(OUBLOG_MY_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp2->id));
+
+        // Visible groups (user seems to get my participation on all groups).
+        $oublog = $this->get_new_oublog($course->id, array('groupmode' => VISIBLEGROUPS));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+        $this->setGuestUser();
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp1->id));
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp2->id));
+
+        $this->setUser($student);
+        $this->assertEquals(OUBLOG_MY_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        $this->assertEquals(OUBLOG_MY_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp1->id));
+        $this->assertEquals(OUBLOG_MY_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp2->id));
+
+        $this->setUser($student2);
+        $this->assertEquals(OUBLOG_MY_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        $this->assertEquals(OUBLOG_MY_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp1->id));
+        $this->assertEquals(OUBLOG_MY_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp2->id));
+
+        // Separate groups, separate individuals.
+        $oublog = $this->get_new_oublog($course->id, array('groupmode' => SEPARATEGROUPS,
+                'individual' => OUBLOG_SEPARATE_INDIVIDUAL_BLOGS));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+        $this->setGuestUser();
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp1->id));
+        $this->setUser($student);
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        $this->assertEquals(OUBLOG_MY_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp1->id));
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp2->id));
+        $this->setUser($student2);
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp1->id));
+        $this->assertEquals(OUBLOG_MY_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp2->id));
+        // Separate groups, visible individuals.
+        $oublog = $this->get_new_oublog($course->id, array('groupmode' => SEPARATEGROUPS,
+                'individual' => OUBLOG_VISIBLE_INDIVIDUAL_BLOGS));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+        $this->setGuestUser();
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp2->id));
+        $this->setUser($student);
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        $this->assertEquals(OUBLOG_MY_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp1->id));
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp2->id));
+        $this->setUser($student2);
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp1->id));
+        $this->assertEquals(OUBLOG_MY_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp2->id));
+        // Visble groups, visible individuals.
+        $oublog = $this->get_new_oublog($course->id, array('groupmode' => VISIBLEGROUPS,
+                'individual' => OUBLOG_VISIBLE_INDIVIDUAL_BLOGS));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+        $this->setGuestUser();
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp2->id));
+        $this->setUser($student);
+        $this->assertEquals(OUBLOG_MY_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        $this->assertEquals(OUBLOG_MY_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp1->id));
+        $this->assertEquals(OUBLOG_MY_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp2->id));
+        $this->setUser($student2);
+        $this->assertEquals(OUBLOG_MY_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        $this->assertEquals(OUBLOG_MY_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp1->id));
+        $this->assertEquals(OUBLOG_MY_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp2->id));
+
+        // Visble individuals.
+        $oublog = $this->get_new_oublog($course->id, array('individual' => OUBLOG_VISIBLE_INDIVIDUAL_BLOGS));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+        $this->setGuestUser();
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        $this->setUser($student);
+        $this->assertEquals(OUBLOG_MY_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        $this->setUser($student2);
+        $this->assertEquals(OUBLOG_MY_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        // Separate individuals.
+        $oublog = $this->get_new_oublog($course->id, array('individual' => OUBLOG_SEPARATE_INDIVIDUAL_BLOGS));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+        $this->setGuestUser();
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        $this->setUser($student);
+        $this->assertEquals(OUBLOG_MY_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        $this->setUser($student2);
+        $this->assertEquals(OUBLOG_MY_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+
+        // Global blog (oublog_can_view_participation() always returns OUBLOG_NO_PARTICIPATION).
+        $oublog = $this->get_new_oublog($SITE->id, array('global' => 1));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+        $this->setGuestUser();
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        $this->setUser($student);
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+    }
+
+    // Test access to User Participation buttons.
+    public function test_userparticipation_access() {
+        global $SITE, $USER;
+        $this->resetAfterTest(true);
+        $this->setAdminUser();
+        // Whole course.
+        $course = $this->get_new_course();
+
+        $grp1 = $this->get_new_group($course->id);
+
+        $oublog = $this->get_new_oublog($course->id);
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+
+        $this->assertEquals(OUBLOG_USER_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+
+        // Separate groups.
+        $oublog = $this->get_new_oublog($course->id, array('groupmode' => SEPARATEGROUPS));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+        $this->assertEquals(OUBLOG_USER_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        $this->assertEquals(OUBLOG_USER_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp1->id));
+
+        // Visible groups.
+        $oublog = $this->get_new_oublog($course->id, array('groupmode' => VISIBLEGROUPS));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+        $this->assertEquals(OUBLOG_USER_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        $this->assertEquals(OUBLOG_USER_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp1->id));
+
+        // Separate groups, separate individuals.
+        $oublog = $this->get_new_oublog($course->id, array('groupmode' => SEPARATEGROUPS,
+                'individual' => OUBLOG_SEPARATE_INDIVIDUAL_BLOGS));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+        $this->assertEquals(OUBLOG_USER_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        $this->assertEquals(OUBLOG_USER_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp1->id));
+
+        // Separate groups, visible individuals.
+        $oublog = $this->get_new_oublog($course->id, array('groupmode' => SEPARATEGROUPS,
+                'individual' => OUBLOG_VISIBLE_INDIVIDUAL_BLOGS));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+        $this->assertEquals(OUBLOG_USER_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        $this->assertEquals(OUBLOG_USER_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp1->id));
+
+        // Visble groups, visible individuals.
+        $oublog = $this->get_new_oublog($course->id, array('groupmode' => VISIBLEGROUPS,
+                'individual' => OUBLOG_VISIBLE_INDIVIDUAL_BLOGS));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+        $this->assertEquals(OUBLOG_USER_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+        $this->assertEquals(OUBLOG_USER_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm, $grp1->id));
+
+        // Visble individuals.
+        $oublog = $this->get_new_oublog($course->id, array('individual' => OUBLOG_VISIBLE_INDIVIDUAL_BLOGS));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+        $this->assertEquals(OUBLOG_USER_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+
+        // Separate individuals.
+        $oublog = $this->get_new_oublog($course->id, array('individual' => OUBLOG_SEPARATE_INDIVIDUAL_BLOGS));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+        $this->assertEquals(OUBLOG_USER_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+
+        // Global blog (oublog_can_view_participation() always returns OUBLOG_NO_PARTICIPATION).
+        $oublog = $this->get_new_oublog($SITE->id, array('global' => 1));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+        $this->assertEquals(OUBLOG_NO_PARTICIPATION, oublog_can_view_participation($course, $oublog, $cm));
+    }
+
+    public function test_participation() {
+        global $USER, $DB;
+        $this->resetAfterTest(true);
+        $this->setAdminUser();
+        // Whole course.
+        $course = $this->get_new_course();
+        $student1 = $this->get_new_user('student', $course->id);
+        $student2 = $this->get_new_user('student', $course->id);
+
+        $oublog = $this->get_new_oublog($course->id);
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+        $context = context_module::instance($oublog->cmid);
+
+        // Check empty participation array/object.
+        $participation = oublog_get_participation($oublog, $context, 0, $cm, $course);
+        $this->assertTrue(is_array($participation));
+        $this->assertEquals(2, count($participation));
+        $this->assertArrayHasKey($student1->id, $participation);
+        $userparticipation = oublog_get_user_participation($oublog, $context, $student1->id, 0, $cm, $course);
+        $this->assertInstanceOf('stdClass', $userparticipation);
+        $this->assertEmpty($userparticipation->posts);
+        $this->assertEmpty($userparticipation->comments);
+        $this->assertEquals(fullname($student1), fullname($userparticipation->user));
+
+        // 2 posts by user 1, 2 comments by user 1, 1 comment by user 2.
+        $poststub = $this->get_post_stub($oublog->id);
+        $poststub->userid = $student1->id;
+        $post1 = $this->get_new_post($oublog, $poststub);
+        $post2 = $this->get_new_post($oublog, $poststub);
+        $generator = $this->getDataGenerator()->get_plugin_generator('mod_oublog');
+        $generator->create_content($oublog, array('comment' => (object) array('postid' => $post1, 'userid' => $student1->id)));
+        $generator->create_content($oublog, array('comment' => (object) array('postid' => $post2, 'userid' => $student1->id)));
+        $comment = $generator->create_content($oublog,
+                array('comment' => (object) array('postid' => $post2, 'userid' => $student2->id)));
+
+        $participation = oublog_get_participation($oublog, $context, 0, $cm, $course);
+        $this->assertEquals(2, $participation[$student1->id]->posts);
+        $this->assertTrue(empty($participation[$student2->id]->posts));
+        $this->assertEquals(2, $participation[$student1->id]->comments);
+        $this->assertEquals(1, $participation[$student2->id]->comments);
+        $userparticipation = oublog_get_user_participation($oublog, $context, $student1->id, 0, $cm, $course);
+        $this->assertCount(2, $userparticipation->posts);
+        $this->assertCount(2, $userparticipation->comments);
+        $userparticipation = oublog_get_user_participation($oublog, $context, $student2->id, 0, $cm, $course);
+        $this->assertCount(0, $userparticipation->posts);
+        $this->assertCount(1, $userparticipation->comments);
+        // Test time filtering.
+        $userparticipation = oublog_get_user_participation($oublog, $context, $student1->id, 0, $cm, $course, time());
+        $this->assertCount(0, $userparticipation->posts);
+        $this->assertCount(0, $userparticipation->comments);
+        $userparticipation = oublog_get_user_participation($oublog, $context, $student1->id, 0, $cm, $course,
+                (time() - 3600), (time() + 3600));
+        $this->assertCount(2, $userparticipation->posts);
+        $this->assertCount(2, $userparticipation->comments);
+        $userparticipation = oublog_get_user_participation($oublog, $context, $student1->id, 0, $cm, $course,
+                null, (time() + 3600));
+        $this->assertCount(2, $userparticipation->posts);
+        $this->assertCount(2, $userparticipation->comments);
+        // Test oublog_get_user_participation() filtering.
+        $userparticipation = oublog_get_user_participation($oublog, $context, $student1->id, 0, $cm, $course,
+                null, null, true, false, null, 1);
+        $this->assertCount(1, $userparticipation->posts);
+        $this->assertCount(0, $userparticipation->comments);
+        $userparticipation = oublog_get_user_participation($oublog, $context, $student1->id, 0, $cm, $course,
+                null, null, false, true);
+        $this->assertCount(0, $userparticipation->posts);
+        $this->assertCount(2, $userparticipation->comments);
+
+        // Test deleted posts/comments don't show.
+        $DB->update_record('oublog_posts', (object) array('id' => $post1, 'timedeleted' => time(), 'deletedby' => $USER->id));
+        $DB->update_record('oublog_comments', (object) array('id' => $comment, 'timedeleted' => time(), 'deletedby' => $USER->id));
+        $participation = oublog_get_participation($oublog, $context, 0, $cm, $course);
+        $this->assertEquals(1, $participation[$student1->id]->posts);
+        $this->assertEquals(1, $participation[$student1->id]->comments);
+        $this->assertTrue(empty($participation[$student2->id]->comments));
+        $userparticipation = oublog_get_user_participation($oublog, $context, $student1->id, 0, $cm, $course);
+        $this->assertCount(1, $userparticipation->posts);
+        $this->assertCount(1, $userparticipation->comments);
+        $userparticipation = oublog_get_user_participation($oublog, $context, $student2->id, 0, $cm, $course);
+        $this->assertCount(0, $userparticipation->comments);
+
+        // Group blog.
+        $grp1 = $this->get_new_group($course->id);
+        $grp2 = $this->get_new_group($course->id);
+        $this->get_new_group_member($grp1->id, $student1->id);
+        $this->get_new_group_member($grp2->id, $student1->id);
+
+        $oublog = $this->get_new_oublog($course->id, array('groupmode' => SEPARATEGROUPS));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+        $context = context_module::instance($oublog->cmid);
+
+        // 2 posts by user 1 (1 in each group), 2 comments by user 1 (1 in each group).
+        $poststub = $this->get_post_stub($oublog->id);
+        $poststub->userid = $student1->id;
+        $poststub->groupid = $grp1->id;
+        $post1 = $this->get_new_post($oublog, $poststub);
+        $poststub->groupid = $grp2->id;
+        $post2 = $this->get_new_post($oublog, $poststub);
+        $generator = $this->getDataGenerator()->get_plugin_generator('mod_oublog');
+        $generator->create_content($oublog, array('comment' => (object) array('postid' => $post1, 'userid' => $student1->id)));
+        $generator->create_content($oublog, array('comment' => (object) array('postid' => $post2, 'userid' => $student1->id)));
+        $participation = oublog_get_participation($oublog, $context, 0, $cm, $course);
+        $this->assertEquals(2, $participation[$student1->id]->posts);
+        $this->assertTrue(empty($participation[$student2->id]->posts));
+        $this->assertEquals(2, $participation[$student1->id]->comments);
+        $this->assertTrue(empty($participation[$student2->id]->comments));
+        $participation = oublog_get_participation($oublog, $context, $grp1->id, $cm, $course);
+        $this->assertEquals(1, $participation[$student1->id]->posts);
+        $this->assertEquals(1, $participation[$student1->id]->comments);
+        $participation = oublog_get_participation($oublog, $context, $grp2->id, $cm, $course);
+        $this->assertEquals(1, $participation[$student1->id]->posts);
+        $this->assertEquals(1, $participation[$student1->id]->comments);
+        $userparticipation = oublog_get_user_participation($oublog, $context, $student1->id, 0, $cm, $course);
+        $this->assertCount(2, $userparticipation->posts);
+        $this->assertCount(2, $userparticipation->comments);
+        $userparticipation = oublog_get_user_participation($oublog, $context, $student1->id, $grp1->id, $cm, $course);
+        $this->assertCount(1, $userparticipation->posts);
+        $this->assertCount(1, $userparticipation->comments);
+        $userparticipation = oublog_get_user_participation($oublog, $context, $student1->id, $grp2->id, $cm, $course);
+        $this->assertCount(1, $userparticipation->posts);
+        $this->assertCount(1, $userparticipation->comments);
+    }
+
+    public function test_participation_grades() {
+        global $USER, $DB;
+        $this->resetAfterTest(true);
+        $this->setAdminUser();
+        // Whole course.
+        $course = $this->get_new_course();
+        $student1 = $this->get_new_user('student', $course->id);
+        $student2 = $this->get_new_user('student', $course->id);
+
+        $oublog = $this->get_new_oublog($course->id, array('grading' => 1, 'grade' => 100));
+        $cm = get_coursemodule_from_id('oublog', $oublog->cmid);
+        $context = context_module::instance($oublog->cmid);
+
+        $participation = oublog_get_participation($oublog, $context, 0, $cm, $course);
+        $this->assertArrayHasKey($student1->id, $participation);
+        $this->assertTrue(isset($participation[$student1->id]->gradeobj));
+        $this->assertNotEmpty($participation[$student1->id]->gradeobj);
+        $this->assertEmpty($participation[$student1->id]->gradeobj->grade);
+        oublog_update_manual_grades(array($student1->id => 55), $participation, $cm, $oublog, $course);
+        $participation = oublog_get_participation($oublog, $context, 0, $cm, $course);
+        $this->assertTrue(isset($participation[$student1->id]->gradeobj));
+        $this->assertNotEmpty($participation[$student1->id]->gradeobj);
+        $this->assertEquals(55, $participation[$student1->id]->gradeobj->grade);
+
+        $userparticipation = oublog_get_user_participation($oublog, $context, $student1->id, 0, $cm, $course,
+                null, null, true, true, null, null, true);
+        $this->assertTrue(isset($userparticipation->gradeobj));
+        $this->assertNotEmpty($userparticipation->gradeobj);
+        $this->assertEquals(55, $userparticipation->gradeobj->grade);
+    }
+}
diff --git a/mod/oublog/userparticipation.php b/mod/oublog/userparticipation.php
new file mode 100644
index 0000000..4b8a2cc
--- /dev/null
+++ b/mod/oublog/userparticipation.php
@@ -0,0 +1,241 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Page for viewing all user participation
+ *
+ * @package mod
+ * @subpackage oublog
+ * @copyright 2011 The Open University
+ * @author Stacey Walker <stacey@catalyst-eu.net>
+ * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+require_once(dirname(__FILE__) . '/../../config.php');
+require_once($CFG->dirroot.'/mod/oublog/locallib.php');
+require_once($CFG->libdir.'/gradelib.php');
+
+$id = required_param('id', PARAM_INT);// Course Module ID.
+$userid = required_param('user', PARAM_INT);
+$groupid = optional_param('group', 0, PARAM_INT);
+$download = optional_param('download', '', PARAM_TEXT);
+$page = optional_param('page', 0, PARAM_INT);// Page.
+$tab = optional_param('tab', 0, PARAM_INT);// Current tab, 0:Posts,1:Comments,2:Grade.
+
+$params = array(
+        'id' => $id,
+        'user' => $userid,
+        'group' => $groupid,
+        'download' => $download,
+        'page' => $page,
+        'tab' => $tab
+);
+$url = new moodle_url('/mod/oublog/userparticipation.php', $params);
+$PAGE->set_url($url);
+
+$cm = get_coursemodule_from_id('oublog', $id, 0, false, MUST_EXIST);
+$course = $DB->get_record('course', array('id' => $cm->course), '*', MUST_EXIST);
+$oublog = $DB->get_record('oublog', array('id' => $cm->instance), '*', MUST_EXIST);
+
+$PAGE->set_cm($cm);
+$context = context_module::instance($cm->id);
+$PAGE->set_pagelayout('incourse');
+require_course_login($course, true, $cm);
+
+// participation capability check
+$canview = oublog_can_view_participation($course, $oublog, $cm, $groupid);
+$viewonlyown = ($canview == OUBLOG_MY_PARTICIPATION && $USER->id != $userid);
+if ($oublog->global && $USER->id == $userid) {
+    $viewonlyown = false;
+    $canview = OUBLOG_MY_PARTICIPATION;
+}
+if ($canview == OUBLOG_NO_PARTICIPATION || $viewonlyown) {
+    print_error('nopermissiontoshow');
+}
+$viewfullnames = has_capability('moodle/site:viewfullnames', $context);
+
+// all enrolled users for table pagination
+$coursecontext = context_course::instance($course->id);
+
+// Create time filter options form.
+$customdata = array(
+        'options' => array(),
+        'cmid' => $cm->id,
+        'user' => $userid,
+        'group' => $groupid,
+        'download' => $download,
+        'startyear' => $course->startdate,
+        'params' => array('tab' => $tab)
+);
+$timefilter = new oublog_participation_timefilter_form(null, $customdata);
+
+$start = $end = 0;
+// If data has been received from this form.
+if ($submitted = $timefilter->get_data()) {
+    if ($submitted->start) {
+        $start = strtotime('00:00:00', $submitted->start);
+    }
+    if ($submitted->end) {
+        $end = strtotime('23:59:59', $submitted->end);
+    }
+} else if (!$timefilter->is_submitted()) {
+    // Recieved via post back.
+    if ($start = optional_param('start', null, PARAM_INT)) {
+        $timefilter->set_data(array('start' => $start));
+        $start = strtotime('00:00:00', $start);
+    }
+    if ($end = optional_param('end', null, PARAM_INT)) {
+        $timefilter->set_data(array('end' => $end));
+        $end = strtotime('23:59:59', $end);
+    }
+}
+$url->params(array('start' => $start, 'end' => $end));
+$PAGE->set_url($url);
+$getposts = true;
+$getcomments = false;
+$getgrades = false;
+$limitnum = OUBLOG_POSTS_PER_PAGE;
+$limitfrom = empty($page) ? null : $page * $limitnum;
+if (!empty($download)) {
+    $limitnum = null;
+    $limitfrom = null;
+}
+// Customise data sought based on current tab.
+switch($tab) {
+    case 1:
+        $getposts = false;
+        $getcomments = true;
+    break;
+    case 2:
+        $getposts = false;
+        $getgrades = true;
+    break;
+}
+$participation = oublog_get_user_participation($oublog, $context,
+        $userid, $groupid, $cm, $course, $start, $end, $getposts, $getcomments, $limitfrom,
+        $limitnum, $getgrades);
+// Add extra navigation link for users who can see all participation.
+$canviewall = oublog_can_view_participation($course, $oublog, $cm, $groupid);
+if ($canviewall == OUBLOG_USER_PARTICIPATION) {
+    $allusersurl = new moodle_url('/mod/oublog/participation.php',
+        array('id' => $cm->id, 'group' => $groupid));
+    $PAGE->navbar->add(get_string('userparticipation', 'oublog'), $allusersurl);
+}
+$PAGE->navbar->add(fullname($participation->user, $viewfullnames));
+$PAGE->set_title(format_string($oublog->name));
+$PAGE->set_heading(format_string($oublog->name));
+
+$groupname = '';
+if ($groupid) {
+    $groupname = groups_get_group_name($groupid);
+}
+
+$oublogoutput = $PAGE->get_renderer('mod_oublog');
+
+if (empty($download)) {
+    echo $OUTPUT->header();
+}
+
+if (!$start && !$end) {
+    $title = get_string('contribution_all', 'oublog');
+    $info = get_string('contribution_all', 'oublog');
+}
+$startdate = userdate($start, get_string('strftimedaydate'));
+$enddate = userdate($end, get_string('strftimedaydate'));
+if ($start && !$end) {
+    $title = get_string('contribution', 'oublog');
+    $info = get_string('contribution_from', 'oublog', $startdate);
+}
+if (!$start && $end) {
+    $title = get_string('contribution', 'oublog');
+    $info = get_string('contribution_to', 'oublog', $enddate);
+}
+if ($start && $end) {
+    $a = new stdClass();
+    $a->start = $startdate;
+    $a->end  = $enddate;
+    $title = get_string('contribution', 'oublog');
+    $info = get_string('contribution_fromto', 'oublog', $a);
+}
+if (empty($download)) {
+    if ($oublog->individual == OUBLOG_NO_INDIVIDUAL_BLOGS) {
+        $groupurl = clone $url;
+        $groupurl->remove_params(array('page', 'tab', 'download'));
+        groups_print_activity_menu($cm, $groupurl);
+    }
+    echo html_writer::tag('h2', $info, array('class' => 'oublog-post-title'));
+    $timefilter->display();
+    $taburl = clone $url;
+    $taburl->remove_params(array('page', 'tab'));
+    $tabs = array(
+            new tabobject('tab0', $taburl, $participation->numposts . ' ' . get_string('posts', 'oublog')),
+            new tabobject('tab1', $taburl->out() . '&amp;tab=1', $participation->numcomments . ' ' .
+                    get_string('comments', 'oublog')),
+    );
+    if (oublog_can_grade($course, $oublog, $cm, $groupid)) {
+        $tabs[] = new tabobject('tab2', $taburl->out() . '&amp;tab=2', get_string('usergrade', 'oublog'));
+    }
+    echo $OUTPUT->tabtree($tabs, "tab$tab");
+
+    // Output message when no content for tab.
+    $warning = '';
+    if ($tab == 0 & !$participation->numposts) {
+        $warning = get_string('nouserpostsfound', 'oublog');
+    } else if ($tab == 1 && !$participation->numcomments) {
+        $warning = get_string('nousercommentsfound', 'oublog');
+    } else if ($tab == 2 && !isset($participation->gradeobj)) {
+        $warning = get_string('nousergrade', 'oublog');
+    }
+
+    if (!empty($warning)) {
+        $output = $OUTPUT->box_start('generalbox', 'notice');
+        $output .= html_writer::tag('p', $warning);
+        $output .= $OUTPUT->box_end();
+        echo $output;
+    }
+    // Pagination.
+    $pag = '';
+    if (!empty($participation->posts) && $participation->numposts > $limitnum) {
+        $pag = $OUTPUT->paging_bar($participation->numposts, $page, $limitnum, $url);
+    } else if (!empty($participation->comments) && $participation->numcomments > $limitnum) {
+        $pag = $OUTPUT->paging_bar($participation->numcomments, $page, $limitnum, $url);
+    }
+    echo $pag;
+}
+
+$oublogoutput->render_user_participation_list($cm, $course, $oublog, $participation,
+        $groupid, $download, $page, $coursecontext, $viewfullnames, $groupname, $start, $end);
+
+echo $oublogoutput->get_link_back_to_oublog($cm->name, $cm->id);
+
+if (empty($download)) {
+    echo $pag;
+    echo $OUTPUT->footer();
+}
+
+// Log visit list event.
+$params = array(
+    'context' => $context,
+    'objectid' => $oublog->id,
+    'other' => array(
+        'info' => 'user participation',
+        'relateduserid' => $userid,
+        'logurl' => 'userparticipation.php?id=' . $cm->id
+    )
+);
+$event = \mod_oublog\event\participation_viewed::create($params);
+$event->add_record_snapshot('course', $course);
+$event->trigger();
diff --git a/mod/oublog/version.php b/mod/oublog/version.php
new file mode 100644
index 0000000..26cfda8
--- /dev/null
+++ b/mod/oublog/version.php
@@ -0,0 +1,30 @@
+<?php
+// This file is part of Moodle - http://moodle.org//
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Code fragment to define the version of oublog
+ * This fragment is called by moodle_needs_upgrading() and /admin/index.php
+ *
+ * @author Matt Clarkson <mattc@catalyst.net.nz>
+ * @author Sam Marshall <s.marshall@open.ac.uk>
+ * @package oublog
+ **/
+
+$plugin->version = 2016081600;
+$plugin->requires = 2016052300;
+$plugin->component = 'mod_oublog';// Full name of the plugin (used for diagnostics)
+$plugin->maturity = MATURITY_STABLE;
+$plugin->release = '3.1 r1';
diff --git a/mod/oublog/view.php b/mod/oublog/view.php
new file mode 100644
index 0000000..b630007
--- /dev/null
+++ b/mod/oublog/view.php
@@ -0,0 +1,581 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * This page prints a particular instance of oublog
+ *
+ * @author Matt Clarkson <mattc@catalyst.net.nz>
+ * @author Sam Marshall <s.marshall@open.ac.uk>
+ * @package oublog
+ */
+
+require_once('../../config.php');
+require_once('locallib.php');
+
+$id     = optional_param('id', 0, PARAM_INT);       // Course Module ID.
+$user   = optional_param('user', 0, PARAM_INT);     // User ID.
+$username = optional_param('u', '', PARAM_USERNAME);// User login name.
+$tag    = optional_param('tag', null, PARAM_TAG);   // Tag to display.
+$page = optional_param('page', 0, PARAM_INT);
+$tagorder = optional_param('tagorder', '', PARAM_ALPHA);// Tag display order.
+
+// Set user value if u (username) set.
+if ($username != '') {
+    if (!$oubloguser = $DB->get_record('user', array('username' => $username))) {
+        print_error('invaliduser');
+    }
+    $user = $oubloguser->id;
+}
+
+if (isloggedin()) {
+    // Determine tag order to use.
+    if ($tagorder != '') {
+        set_user_preference('oublog_tagorder', $tagorder);
+    } else {
+        $tagorder = get_user_preferences('oublog_tagorder', 'alpha');
+    }
+} else {
+    // Use 'alpha'.
+    $tagorder = 'alpha';
+}
+
+$offset = $page * OUBLOG_POSTS_PER_PAGE;
+$url = new moodle_url('/mod/oublog/view.php', array('id' => $id, 'user' => $user,
+        'page' => $page, 'tag' => $tag, 'tagorder' => $tagorder));
+
+$PAGE->set_url($url);
+
+if ($id) {
+    // Load efficiently (and with full $cm data) using get_fast_modinfo.
+    $course = $DB->get_record_select('course',
+            'id = (SELECT course FROM {course_modules} WHERE id = ?)', array($id),
+            '*', MUST_EXIST);
+    $modinfo = get_fast_modinfo($course);
+    $cm = $modinfo->get_cm($id);
+    if ($cm->modname !== 'oublog') {
+        print_error('invalidcoursemodule');
+    }
+
+    if (!$oublog = $DB->get_record('oublog', array('id' => $cm->instance))) {
+        print_error('invalidcoursemodule');
+    }
+    $oubloguser = (object) array('id' => null);
+    $oubloginstance = null;
+    $oubloginstanceid = null;
+
+} else if ($user) {
+    if (!isset($oubloguser)) {
+        if (!$oubloguser = $DB->get_record('user', array('id' => $user))) {
+            print_error('invaliduserid');
+        }
+    }
+    if (!list($oublog, $oubloginstance) = oublog_get_personal_blog($oubloguser->id)) {
+        print_error('invalidcoursemodule');
+    }
+    if (!$cm = get_coursemodule_from_instance('oublog', $oublog->id)) {
+        print_error('invalidcoursemodule');
+    }
+    if (!$course = $DB->get_record('course', array('id' => $oublog->course))) {
+        print_error('coursemisconf');
+    }
+    $oubloginstanceid = $oubloginstance->id;
+} else if (isloggedin()) {
+    redirect('view.php?user='.$USER->id);
+} else {
+    redirect('bloglogin.php');
+}
+
+// The mod_edit page gets it wrong when redirecting to a personal blog.
+// Since there's no way to know what personal blog was being updated
+// this redirects to the users own blog.
+if ($oublog->global && empty($user)) {
+    redirect('view.php?user='.$USER->id);
+    exit;
+}
+
+// If viewing a course blog that requires login, but you're not logged in,
+// this causes odd behaviour in OU systems, so redirect to bloglogin.php.
+if ($oublog->maxvisibility != OUBLOG_VISIBILITY_PUBLIC && !isloggedin()) {
+    redirect('bloglogin.php?returnurl=' .
+            substr($FULLME, strpos($FULLME, 'view.php')));
+}
+
+$context = context_module::instance($cm->id);
+oublog_check_view_permissions($oublog, $context, $cm);
+$oublogoutput = $PAGE->get_renderer('mod_oublog');
+
+// Hook for pre-page-display output (if any).
+$oublogoutput->pre_display($cm, $oublog, 'view');
+
+// Check security.
+$canpost        = oublog_can_post($oublog, $user, $cm);
+$canmanageposts = has_capability('mod/oublog:manageposts', $context);
+$canaudit       = has_capability('mod/oublog:audit', $context);
+
+// Get strings.
+$stroublogs     = get_string('modulenameplural', 'oublog');
+$stroublog      = get_string('modulename', 'oublog');
+$straddpost = get_string('newpost', 'oublog', oublog_get_displayname($oublog));
+$strexportposts = get_string('oublog:exportposts', 'oublog');
+$strtags        = get_string('tags', 'oublog');
+$stredit        = get_string('edit', 'oublog');
+$strdelete      = get_string('delete', 'oublog');
+$strnewposts    = get_string('newerposts', 'oublog');
+$strolderposts  = get_string('olderposts', 'oublog');
+$strcomment     = get_string('comment', 'oublog');
+$strviews = get_string('views', 'oublog', oublog_get_displayname($oublog));
+$strlinks       = get_string('links', 'oublog');
+$strfeeds       = get_string('feeds', 'oublog');
+$strblogsearch = get_string('searchthisblog', 'oublog', oublog_get_displayname($oublog));
+
+// Set-up groups.
+$groupmode = oublog_get_activity_groupmode($cm, $course);
+$currentgroup = oublog_get_activity_group($cm, true);
+
+if (!oublog_is_writable_group($cm)) {
+    $canpost = false;
+    $canmanageposts = false;
+    $cancomment = false;
+    $canaudit = false;
+}
+
+if (isset($cm)) {
+    $completion = new completion_info($course);
+    $completion->set_module_viewed($cm);
+}
+
+// Print the header.
+$hideunusedblog = false;
+
+if ($oublog->global) {
+    $blogtype = 'personal';
+    $returnurl = $CFG->wwwroot . '/mod/oublog/view.php?user='.$user;
+
+    $name = $oubloginstance->name;
+
+    $buttontext = oublog_get_search_form('user', $oubloguser->id, $strblogsearch);
+} else {
+    $blogtype = 'course';
+    $returnurl = $CFG->wwwroot . '/mod/oublog/view.php?id='.$id;
+
+    $name = $oublog->name;
+
+    $buttontext = oublog_get_search_form('id', $cm->id, $strblogsearch);
+}
+
+if ($tag) {
+    $returnurl .= '&amp;tag='.urlencode($tag);
+}
+
+// Set-up individual.
+$currentindividual = -1;
+$individualdetails = 0;
+
+// Set up whether the group selector should display.
+$showgroupselector = true;
+if ($oublog->individual) {
+    // If separate individual and visible group, do not show groupselector
+    // unless the current user has permission.
+    if ($oublog->individual == OUBLOG_SEPARATE_INDIVIDUAL_BLOGS
+        && !has_capability('mod/oublog:viewindividual', $context)) {
+        $showgroupselector = false;
+    }
+
+    $canpost = true;
+    $individualdetails = oublog_individual_get_activity_details($cm, $returnurl, $oublog,
+            $currentgroup, $context);
+    if ($individualdetails) {
+        $currentindividual = $individualdetails->activeindividual;
+        if (!$individualdetails->newblogpost) {
+            $canpost = false;
+        }
+    }
+}
+
+// Get Posts.
+list($posts, $recordcount) = oublog_get_posts($oublog, $context, $offset, $cm, $currentgroup,
+        $currentindividual, $oubloguser->id, $tag, $canaudit);
+
+
+$hideunusedblog = !$posts && !$canpost && !$canaudit;
+
+if ($oublog->global && !$hideunusedblog) {
+    // Bit about hidden with if global then $posts
+    // In order to prevent people from looping through numbers to get the
+    // name of every user in the site (in case these names are considered
+    // private), don't display the header when not displaying posts, except
+    // to users who can post.
+    oublog_build_navigation($oublog, $oubloginstance, $oubloguser);
+} else {
+    oublog_build_navigation($oublog, $oubloginstance, null);
+
+}
+if (!$hideunusedblog) {
+    // Generate extra navigation.
+    $CFG->additionalhtmlhead .= oublog_get_meta_tags($oublog, $oubloginstance, $currentgroup, $cm);
+    $PAGE->set_button($buttontext);
+    if ($offset > 0) {
+        $a = new stdClass();
+        $a->from = ($offset + 1);
+        $a->to = (($recordcount - $offset) > OUBLOG_POSTS_PER_PAGE) ? $offset + OUBLOG_POSTS_PER_PAGE : $recordcount;
+        $PAGE->navbar->add(get_string('extranavolderposts', 'oublog', $a));
+    }
+    if ($tag) {
+        $PAGE->navbar->add(get_string('extranavtag', 'oublog', $tag));
+    }
+}
+$blogname = format_string($oublog->name);
+$PAGE->set_title($blogname);
+$PAGE->set_heading($blogname);
+
+// Initialize $PAGE, compute blocks.
+$editing = $PAGE->user_is_editing();
+
+// The left column ...
+$hasleft = !empty($CFG->showblocksonmodpages);
+// The right column, BEFORE the middle-column.
+if (!$hideunusedblog) {
+    global $USER, $CFG;
+    $links = '';
+    if ($oublog->global) {
+        $title = $oubloginstance->name;
+        $summary = $oubloginstance->summary;
+        if (($oubloginstance->userid == $USER->id) || $canmanageposts ) {
+            $params = array('instance' => $oubloginstance->id);
+            $editinstanceurl = new moodle_url('/mod/oublog/editinstance.php', $params);
+            $streditinstance = get_string('blogoptions', 'oublog');
+            $links .= html_writer::start_tag('div', array('class' => 'oublog-links'));
+            $links .= html_writer::link($editinstanceurl, $streditinstance);
+            $links .= html_writer::end_tag('div');
+        }
+        if (empty($CFG->oublogallpostslogin) || isloggedin()) {
+            $allpostsurl = new moodle_url('/mod/oublog/allposts.php');
+            $strallposts = get_string('siteentries', 'oublog');
+            $links .= html_writer::start_tag('div', array('class' => 'oublog-links'));
+            $links .= html_writer::link($allpostsurl, $strallposts);
+            $links .= html_writer::end_tag('div');
+        }
+        $format = FORMAT_HTML;
+    } else {
+        $summary = $oublog->intro;
+        $title = $oublog->name;
+        $format = $oublog->introformat;
+    }
+
+    // Name, summary, related links.
+    $bc = new block_contents();
+    $bc->attributes['class'] = 'oublog-sideblock block';
+    $bc->attributes['id'] = 'oublog_info_block';
+    $bc->title = format_string($title);
+    if ($oublog->global) {
+        $bc->content = file_rewrite_pluginfile_urls($summary, 'mod/oublog/pluginfile.php',
+                $context->id, 'mod_oublog', 'summary', $oubloginstance->id);
+        $bc->content = format_text($bc->content, $format);
+        $bc->content = $oublogoutput->render_summary($bc->content, $oubloguser);
+    } else {
+        $bc->content = file_rewrite_pluginfile_urls($summary, 'pluginfile.php',
+                $context->id, 'mod_oublog', 'intro', null);
+        $bc->content = format_text($bc->content, $format);
+    }
+    $bc->content = $bc->content . $links;
+    if (!empty($bc->content)) {
+        $PAGE->blocks->add_fake_block($bc, BLOCK_POS_RIGHT);
+    }
+
+    // Tag Cloud.
+    if ($tags = oublog_get_tag_cloud($returnurl, $oublog, $currentgroup, $cm,
+            $oubloginstanceid, $currentindividual, $tagorder)) {
+        $bc = new block_contents();
+        $bc->attributes['id'] = 'oublog-tags';
+        $bc->attributes['class'] = 'oublog-sideblock block';
+        $bc->attributes['data-osepid'] = $id . '_oublog_blocktags';
+        $bc->title = $strtags;
+        $bc->content = $oublogoutput->render_tag_order($tagorder);
+        $bc->content .= $tags;
+        $PAGE->blocks->add_fake_block($bc, BLOCK_POS_RIGHT);
+    }
+
+    // Links.
+    $links = oublog_get_links($oublog, $oubloginstance, $context);
+    if ($links) {
+        $bc = new block_contents();
+        $bc->attributes['id'] = 'oublog-links';
+        $bc->attributes['class'] = 'oublog-sideblock block';
+        $bc->attributes['data-osepid'] = $id . '_oublog_blocklinks';
+        $bc->title = $strlinks;
+        $bc->content = $links;
+        $PAGE->blocks->add_fake_block($bc, BLOCK_POS_RIGHT);
+    }
+
+    // Discovery block.
+    $stats = array();
+    $stats[] = oublog_stats_output_myparticipation($oublog, $cm, $oublogoutput, $course, $currentindividual, $oubloguser->id);
+    $stats[] = oublog_stats_output_participation($oublog, $cm, $oublogoutput, $course, false, $currentindividual, $oubloguser->id);
+    $stats[] = oublog_stats_output_commentpoststats($oublog, $cm, $oublogoutput, false, false, $currentindividual, $oubloguser->id);
+    if ($oublog->statblockon) {
+        // Add to 'Discovery' block when enabled only.
+        $stats[] = oublog_stats_output_visitstats($oublog, $cm, $oublogoutput);
+        $stats[] = oublog_stats_output_poststats($oublog, $cm, $oublogoutput);
+        $stats[] = oublog_stats_output_commentstats($oublog, $cm, $oublogoutput);
+    }
+    $stats = array_filter($stats);
+    if (!empty($stats)) {
+        $stats = $oublogoutput->render_stats_container('view', $stats, count($stats));
+        $bc = new block_contents();
+        $bc->attributes['id'] = 'oublog-discover';
+        $bc->attributes['class'] = 'oublog-sideblock block';
+        $bc->attributes['data-osepid'] = $id . '_oublog_blockdiscovery';
+        $bc->title = get_string('discovery', 'oublog', oublog_get_displayname($oublog, true));
+        $bc->content = $stats;
+        $PAGE->blocks->add_fake_block($bc, BLOCK_POS_RIGHT);
+    }
+
+    // Feeds.
+    if ($feeds = oublog_get_feedblock($oublog, $oubloginstance, $currentgroup, false, $cm, $currentindividual)) {
+        $feedicon = ' <img src="'.$OUTPUT->pix_url('i/rss').'" alt="'.get_string('blogfeed', 'oublog').'"  class="feedicon" />';
+        $bc = new block_contents();
+        $bc->attributes['id'] = 'oublog-feeds';
+        $bc->attributes['class'] = 'oublog-sideblock block';
+        $bc->attributes['data-osepid'] = $id . '_oublog_blockfeeds';
+        $bc->title = $strfeeds;
+        $bc->content = $feeds;
+        $PAGE->blocks->add_fake_block($bc, BLOCK_POS_RIGHT);
+    }
+}
+
+// Show portfolio export link.
+// Will need to be passed enough details on the blog so it can accurately work out what
+// posts are displayed (as oublog_get_posts above).
+if (!empty($CFG->enableportfolios) && (has_capability('mod/oublog:exportpost', $context))) {
+    require_once($CFG->libdir . '/portfoliolib.php');
+
+    if ($canaudit) {
+        $canaudit = 1;
+    } else {
+        $canaudit = 0;
+    }
+    if (empty($oubloguser->id)) {
+        $oubloguserid = 0;
+    } else {
+        $oubloguserid = $oubloguser->id;
+    }
+    $tagid = null;
+    if (!is_null($tag)) {
+        // Make tag work with portfolio param cleaning by looking up id.
+        if ($tagrec = $DB->get_record('oublog_tags', array('tag' => $tag), 'id')) {
+            $tagid = $tagrec->id;
+        }
+    }
+
+    // Note: render_export_button_top and render_export_button_bottom are added to
+    // support the OSEP design which includes the export button differently from the old OU theme.
+    if ($posts) {
+        // Do this to get $post variable.
+        foreach ($posts as $post) {
+            // Do nothing, but codechecker would complain if literally nothing.
+            $donothing = true;
+        }
+
+        if (isset($posts)) {
+            $oublogoutput->render_export_button_top($context, $oublog, $post, $oubloguserid,
+                    $canaudit, $offset, $currentgroup, $currentindividual, $tagid, $cm, $course->id);
+        }
+    }
+}
+
+// Must be called after add_fake_blocks.
+echo $OUTPUT->header();
+
+// Start main column.
+print '<div id="middle-column" class="has-right-column">';
+
+echo $OUTPUT->skip_link_target();
+
+echo $oublogoutput->render_header($cm, $oublog, 'view');
+
+// Print Groups and individual drop-down menu.
+echo '<div class="oublog-groups-individual-selectors">';
+
+// Print Groups.
+if ($showgroupselector) {
+    groups_print_activity_menu($cm, $returnurl);
+}
+// Print Individual.
+if ($oublog->individual) {
+    if ($individualdetails) {
+        echo $individualdetails->display;
+        $individualmode = $individualdetails->mode;
+        $currentindividual = $individualdetails->activeindividual;
+    }
+}
+echo '</div>';
+
+if (!$hideunusedblog) {
+    // Renderer hook so extra info can be added to global blog pages in theme.
+    echo $oublogoutput->render_viewpage_prepost();
+}
+// Print the main part of the page.
+
+// New post button - in group blog, you can only post if a group is selected.
+if ($oublog->individual && $individualdetails) {
+    $showpostbutton = $canpost;
+} else {
+    $showpostbutton = $canpost && ($currentgroup || !$groupmode );
+}
+
+// If timed blog posts show info.
+$capable = has_capability('mod/oublog:ignorepostperiod',
+        $oublog->global ? context_system::instance() : $context);
+
+if (($showpostbutton || $capable) && $oublog->postfrom != 0 && $oublog->postfrom > time()) {
+    echo $oublogoutput->render_time_limit_msg('beforestartpost', $oublog->postfrom, $capable);
+}
+if (($showpostbutton || $capable) && $oublog->postuntil != 0) {
+    if ($oublog->postuntil > time()) {
+        echo $oublogoutput->render_time_limit_msg('beforeendpost', $oublog->postuntil, $capable);
+    } else {
+        echo $oublogoutput->render_time_limit_msg('afterendpost', $oublog->postuntil, $capable);
+    }
+}
+// If timed comments show info.
+if ($posts) {
+    $maxpost = (object) array('allowcomments' => false, 'visibility' => OUBLOG_VISIBILITY_COURSEUSER);
+    foreach ($posts as $apost) {
+        // Work out if any posts on page allow commenting + max visibility.
+        if ($apost->allowcomments) {
+            $maxpost->allowcomments = true;
+        }
+        if ($apost->visibility > $maxpost->visibility) {
+            $maxpost->visibility = $apost->visibility;
+        }
+    }
+    if (oublog_can_comment($cm, $oublog, $maxpost, true)) {
+        $ccapable = has_capability('mod/oublog:ignorecommentperiod',
+                $oublog->global ? context_system::instance() : $context);
+        if ($oublog->commentfrom != 0 && $oublog->commentfrom > time()) {
+            echo $oublogoutput->render_time_limit_msg('beforestartcomment', $oublog->commentfrom, $capable, 'comment');
+        }
+        if ($oublog->commentuntil != 0) {
+            if ($oublog->commentuntil > time()) {
+                echo $oublogoutput->render_time_limit_msg('beforeendcomment', $oublog->commentuntil, $capable, 'comment');
+            } else {
+                echo $oublogoutput->render_time_limit_msg('afterendcomment', $oublog->commentuntil, $capable, 'comment');
+            }
+        }
+    }
+}
+
+echo '<div id="oublogbuttons">';
+
+if ($showpostbutton && oublog_can_post_now($oublog, $context)) {
+    echo '<div id="addpostbutton">';
+    echo $OUTPUT->single_button(new moodle_url('/mod/oublog/editpost.php',
+            array('blog' => $cm->instance)), $straddpost, 'get');
+    echo '</div>';
+    if ($oublog->allowimport && ($oublog->global ||
+            $oublog->individual != OUBLOG_NO_INDIVIDUAL_BLOGS)) {
+        echo '<div class="oublog_importpostbutton">';
+        echo $OUTPUT->single_button(new moodle_url('/mod/oublog/import.php',
+                array('id' => $cm->id)), get_string('import', 'oublog'), 'get');
+        echo '</div>';
+    }
+}
+
+// View participation button.
+$canview = oublog_can_view_participation($course, $oublog, $cm, $currentgroup);
+if ($canview) {
+    if ($canview == OUBLOG_USER_PARTICIPATION) {
+        $strparticipation = get_string('participationbyuser', 'oublog');
+        $participationurl = new moodle_url('participation.php', array('id' => $cm->id,
+                'group' => $currentgroup));
+        echo '<div class="participationbutton">';
+        echo $OUTPUT->single_button($participationurl, $strparticipation, 'get');
+        echo '</div>';
+    }
+}
+
+echo '</div>';
+
+// Print blog posts.
+if ($posts) {
+    if ($recordcount > OUBLOG_POSTS_PER_PAGE) {
+        echo "<div class='oublog-paging'>";
+        echo $OUTPUT->paging_bar($recordcount, $page, OUBLOG_POSTS_PER_PAGE, $returnurl);
+        echo '</div>';
+    }
+    echo '<div id="oublog-posts">';
+    $rowcounter = 1;
+    // Only add page onto returnurl within call to render post.
+    $retnurl = $returnurl . '&page=' . $page;
+    foreach ($posts as $post) {
+        $post->row = $rowcounter;
+        echo $oublogoutput->render_post($cm, $oublog, $post, $retnurl, $blogtype,
+                $canmanageposts, $canaudit, true, false);
+        $rowcounter++;
+    }
+    if ($recordcount > OUBLOG_POSTS_PER_PAGE) {
+        echo "<div class='oublog-paging'>";
+        echo $OUTPUT->paging_bar($recordcount, $page, OUBLOG_POSTS_PER_PAGE, $returnurl);
+        echo '</div>';
+    }
+    echo '</div>';
+
+    // Show portfolio export link.
+    // Will need to be passed enough details on the blog so it can accurately work out what
+    // posts are displayed (as oublog_get_posts above).
+    if (!empty($CFG->enableportfolios) && (has_capability('mod/oublog:exportpost', $context))) {
+        echo $oublogoutput->render_export_button_bottom($context, $oublog, $post, $oubloguserid,
+                $canaudit, $offset, $currentgroup, $currentindividual, $tagid, $cm);
+    }
+}
+// Print information allowing the user to log in if necessary, or letting
+// them know if there are no posts in the blog.
+if (isguestuser() && $USER->id == $user) {
+    print '<p class="oublog_loginnote">'.
+            get_string('guestblog', 'oublog',
+                    'bloglogin.php?returnurl='.urlencode($returnurl)).'</p>';
+} else if (!isloggedin() || isguestuser()) {
+    print '<p class="oublog_loginnote">'.
+            get_string('maybehiddenposts', 'oublog',
+                    (object) array('link' => 'bloglogin.php?returnurl='.urlencode($returnurl),
+                            'name' => oublog_get_displayname($oublog))).'</p>';
+} else if (!$posts) {
+    if (!$tag) {
+        $errormessage = get_string('noposts', 'oublog', oublog_get_displayname($oublog));
+    } else {
+        $a = array('blog' => oublog_get_displayname($oublog), 'tag' => $tag);
+        $errormessage = get_string('nopostsnotags', 'oublog', $a);
+    }
+    print '<p class="oublog_noposts">' . $errormessage . ' </p>';
+}
+
+// Log oublog page view.
+$params = array(
+    'context' => $context,
+    'objectid' => $oublog->id,
+);
+$event = \mod_oublog\event\course_module_viewed::create($params);
+$event->add_record_snapshot('course_modules', $cm);
+$event->add_record_snapshot('course', $course);
+$event->trigger();
+
+$views = oublog_update_views($oublog, $oubloginstance);
+
+// Finish the page.
+echo "<div class=\"clearer\"></div><div class=\"oublog-views\">$strviews $views</div></div>";
+
+
+echo $OUTPUT->footer();
diff --git a/mod/oublog/viewedit.php b/mod/oublog/viewedit.php
new file mode 100644
index 0000000..0d323be
--- /dev/null
+++ b/mod/oublog/viewedit.php
@@ -0,0 +1,145 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * This page prints information about edits to a blog post.
+ *
+ * @author Matt Clarkson <mattc@catalyst.net.nz>
+ * @author Sam Marshall <s.marshall@open.ac.uk>
+ * @package oublog
+ */
+
+require_once("../../config.php");
+require_once("locallib.php");
+
+$editid = required_param('edit', PARAM_INT); // Blog post edit ID.
+
+if (!$edit = $DB->get_record('oublog_edits', array('id' => $editid))) {
+    print_error('invalidedit', 'oublog');
+}
+
+if (!$post = oublog_get_post($edit->postid)) {
+    print_error('invalidpost', 'oublog');
+}
+
+if (!$cm = get_coursemodule_from_instance('oublog', $post->oublogid)) {
+    print_error('invalidcoursemodule');
+}
+
+if (!$course = $DB->get_record("course", array('id' => $cm->course))) {
+    print_error('coursemisconf');
+}
+
+if (!$oublog = $DB->get_record("oublog", array('id' => $cm->instance))) {
+    print_error('invalidcoursemodule');
+}
+
+$context = context_module::instance($cm->id);
+oublog_check_view_permissions($oublog, $context, $cm);
+
+$url = new moodle_url('/mod/oublog/viewedit.php', array('edit' => $editid));
+$PAGE->set_url($url);
+
+// Check security.
+$canpost            = oublog_can_post($oublog, $post->userid, $cm);
+$canmanageposts     = has_capability('mod/oublog:manageposts', $context);
+$canmanagecomments  = has_capability('mod/oublog:managecomments', $context);
+$canaudit           = has_capability('mod/oublog:audit', $context);
+
+// Get strings.
+$stroublogs     = get_string('modulenameplural', 'oublog');
+$stroublog      = get_string('modulename', 'oublog');
+$strtags        = get_string('tags', 'oublog');
+$strviewedit    = get_string('viewedit', 'oublog');
+
+// Set-up groups.
+$currentgroup = oublog_get_activity_group($cm, true);
+$groupmode = oublog_get_activity_groupmode($cm, $course);
+
+
+// Print the header.
+if ($oublog->global) {
+    if (!$oubloginstance = $DB->get_record('oublog_instances', array('id' => $post->oubloginstancesid))) {
+        print_error('invalidblog', 'oublog');
+    }
+    if (!$oubloguser = $DB->get_record('user', array('id' => $oubloginstance->userid))) {
+        print_error('invaliduserid');
+    }
+
+    $PAGE->navbar->add(fullname($oubloguser), new moodle_url('/user/view.php', array('id' => $oubloguser->id)));
+    $PAGE->navbar->add(format_string($oublog->name), new moodle_url('/mod/oublog/view.php', array('user' => $oubloguser->id)));
+}
+
+if (!empty($post->title)) {
+    $PAGE->navbar->add(format_string($post->title), new moodle_url('/mod/oublog/viewpost.php', array('post' => $post->id)));
+} else {
+    $PAGE->navbar->add(shorten_text(format_string($post->message, 30)),
+            new moodle_url('/mod/oublog/viewpost.php', array('post' => $post->id)));
+}
+
+$PAGE->navbar->add($strviewedit);
+$PAGE->set_title(format_string($oublog->name));
+$PAGE->set_heading(format_string($course->fullname));
+
+$renderer = $PAGE->get_renderer('mod_oublog');
+$renderer->pre_display($cm, $oublog, 'viewedit');
+
+echo $OUTPUT->header();
+
+// Print the main part of the page.
+echo '<div class="oublog-topofpage"></div>';
+
+echo $renderer->render_header($cm, $oublog, 'viewedit');
+
+// Print blog posts.
+?>
+<div id="middle-column">
+    <div class="oublog-post">
+        <h3><?php print format_string($edit->oldtitle) ?></h3>
+        <?php
+        $fs = get_file_storage();
+        if ($files = $fs->get_area_files($context->id, 'mod_oublog', 'edit', $edit->id, "timemodified", false)) {
+            echo '<div class="oublog-post-attachments">';
+            foreach ($files as $file) {
+                $filename = $file->get_filename();
+                $mimetype = $file->get_mimetype();
+                $iconimage = '<img src="'.$OUTPUT->pix_url(file_mimetype_icon($mimetype)).'" class="icon" alt="'.
+                        $mimetype.'" />';
+                $path = file_encode_url($CFG->wwwroot.'/pluginfile.php', '/'.$context->id.'/mod_oublog/edit/'.
+                        $edit->id.'/'.$filename);
+                echo "<a href=\"$path\">$iconimage</a> ";
+                echo "<a href=\"$path\">".s($filename)."</a><br />";
+            }
+            echo '</div>';
+        }
+        ?>
+        <div class="oublog-post-date">
+            <?php print oublog_date($edit->timeupdated) ?>
+        </div>
+        <p>
+<?php
+$text = file_rewrite_pluginfile_urls($edit->oldmessage, 'pluginfile.php', $context->id, 'mod_oublog',
+        'message', $edit->postid);
+print format_text($text, FORMAT_HTML);
+?>
+        </p>
+    </div>
+</div>
+<?php
+
+// Finish the page.
+echo '<div class="clearfix"></div>';
+echo $OUTPUT->footer();
diff --git a/mod/oublog/viewpost.php b/mod/oublog/viewpost.php
new file mode 100644
index 0000000..19dd3b3
--- /dev/null
+++ b/mod/oublog/viewpost.php
@@ -0,0 +1,301 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * This page prints a particular post from an oublog, including any comments.
+ *
+ * @author Matt Clarkson <mattc@catalyst.net.nz>
+ * @author Sam Marshall <s.marshall@open.ac.uk>
+ * @package oublog
+ */
+
+require_once("../../config.php");
+require_once("locallib.php");
+require_once($CFG->dirroot . '/rating/lib.php');
+
+$postid = required_param('post', PARAM_INT);       // Post id.
+// Support redirects across systems - find post by username and time created.
+$username = optional_param('u', '', PARAM_USERNAME);
+$time = optional_param('time', 0, PARAM_INT);
+if ($postid == 0 && !empty($username) && $time != 0) {
+    // Search DB for an existing post (Personal blog only).
+    $redirectto = new moodle_url('/mod/oublog/view.php', array('u' => $username));
+    if (!$user = $DB->get_record('user', array('username' => $username), 'id')) {
+        print_error('invaliduser');
+    }
+    if (!list($oublog, $oubloginstance) = oublog_get_personal_blog($user->id)) {
+        // We redirect on error as system can create blog on access.
+        redirect($redirectto);
+    }
+    // Get any posts matching user and time (If more than one just get first record).
+    if (!$post = $DB->get_record('oublog_posts', array('oubloginstancesid' => $oubloginstance->id,
+            'timeposted' => $time), 'id', IGNORE_MULTIPLE)) {
+        // Go to their blog home page if no post found.
+        redirect($redirectto);
+    }
+    $postid = $post->id;
+}
+
+// This query based on the post id is so that we can get the blog etc to
+// check permissions before calling oublog_get_post.
+if (!$oublog = oublog_get_blog_from_postid($postid)) {
+    print_error('invalidpost', 'oublog');
+}
+
+if (!$cm = get_coursemodule_from_instance('oublog', $oublog->id)) {
+    print_error('invalidcoursemodule');
+}
+
+if (!$course = $DB->get_record("course", array("id" => $cm->course))) {
+    print_error('coursemisconf');
+}
+
+$url = new moodle_url('/mod/oublog/viewpost.php', array('post' => $postid));
+$PAGE->set_url($url);
+
+$context = context_module::instance($cm->id);
+oublog_check_view_permissions($oublog, $context, $cm);
+
+$oublogoutput = $PAGE->get_renderer('mod_oublog');
+
+// Check security.
+$canmanageposts    = has_capability('mod/oublog:manageposts', $context);
+$canmanagecomments = has_capability('mod/oublog:managecomments', $context);
+$canaudit          = has_capability('mod/oublog:audit', $context);
+
+if (!$post = oublog_get_post($postid, $canaudit)) {
+    print_error('invalidpost', 'oublog');
+}
+
+if (!$oubloginstance = $DB->get_record('oublog_instances',
+        array('id' => $post->oubloginstancesid))) {
+    print_error('invalidblog', 'oublog');
+}
+
+if (!isloggedin() && $post->visibility != OUBLOG_VISIBILITY_PUBLIC) {
+    // User should be logged-in, so log them in automatically.
+    redirect('/mod/oublog/bloglogin.php?returnurl=' . urlencode($url->out()));
+}
+
+if (!oublog_can_view_post($post, $USER, $context, $oublog->global)) {
+    print_error('accessdenied', 'oublog');
+}
+
+// Get strings.
+$stroublogs     = get_string('modulenameplural', 'oublog');
+$stroublog      = get_string('modulename', 'oublog');
+$strdelete      = get_string('delete', 'oublog');
+$strtags        = get_string('tags', 'oublog');
+$strcomments    = get_string('comments', 'oublog');
+$strlinks       = get_string('links', 'oublog');
+$strfeeds       = get_string('feeds', 'oublog');
+
+// Set-up groups.
+$groupmode = oublog_get_activity_groupmode($cm, $course);
+$currentgroup = oublog_get_activity_group($cm, true);
+
+// Check permissions for group (of post).
+if ($groupmode == VISIBLEGROUPS && !groups_is_member($post->groupid) &&
+        !has_capability('moodle/site:accessallgroups', $context)) {
+    $canpost = false;
+    $canmanageposts = false;
+    $canaudit = false;
+}
+
+// Print the header.
+$strblogsearch = get_string('searchthisblog', 'oublog', oublog_get_displayname($oublog));
+if ($oublog->global) {
+    $blogtype = 'personal';
+    $returnurl = 'view.php?user=' . $oubloginstance->userid;
+    $blogname = format_string($oubloginstance->name);
+
+    if (!$oubloguser = $DB->get_record('user', array('id' => $oubloginstance->userid))) {
+        print_error('invaliduserid');
+    }
+
+    $PAGE->navbar->add(fullname($oubloguser), new moodle_url("/user/view.php",
+            array('id' => $oubloguser->id)));
+    $PAGE->navbar->add($blogname, new moodle_url("/mod/oublog/view.php",
+            array('user' => $oubloginstance->userid)));
+
+    $url = new moodle_url("$CFG->wwwroot/course/mod.php", array('update' => $cm->id, 'return' => true, 'sesskey' => sesskey()));
+    $buttontext = oublog_get_search_form('user', $oubloguser->id, $strblogsearch);
+} else {
+    $blogtype = 'course';
+    $returnurl = 'view.php?id='.$cm->id;
+    $blogname = $oublog->name;
+    $url = new moodle_url("$CFG->wwwroot/course/mod.php", array('update' => $cm->id, 'return' => true, 'sesskey' => sesskey()));
+    $buttontext = oublog_get_search_form('id', $cm->id, $strblogsearch);
+}
+
+// Log view post event.
+$params = array(
+        'context' => $context,
+        'objectid' => $post->id,
+        'other' => array(
+            'oublogid' => $oublog->id
+   )
+);
+$event = \mod_oublog\event\post_viewed::create($params);
+$event->add_record_snapshot('oublog_posts', $post);
+$event->trigger();
+
+$CFG->additionalhtmlhead .= oublog_get_meta_tags($oublog, $oubloginstance, $currentgroup, $cm, $post);
+$PAGE->set_title(format_string($post->title));
+$PAGE->set_heading(format_string($course->fullname));
+$PAGE->set_button($buttontext);
+oublog_get_post_extranav($post, false);
+
+$oublogoutput->pre_display($cm, $oublog, 'viewpost');
+
+echo $OUTPUT->header();
+// Print the main part of the page.
+echo '<div class="oublog-topofpage"></div>';
+
+// Print blog posts.
+echo '<div id="middle-column" >';
+
+echo $oublogoutput->render_header($cm, $oublog, 'viewpost');
+
+echo '<div class="oublog-post-commented">';
+
+// Load ratings.
+if ($oublog->assessed != RATING_AGGREGATE_NONE) {
+    $ratingoptions = new stdClass();
+    $ratingoptions->context = $context;
+    $ratingoptions->component = 'mod_oublog';
+    $ratingoptions->ratingarea = 'post';
+    $ratingoptions->items = array('post' => $post);
+    $ratingoptions->aggregate = $oublog->assessed;// The aggregation method.
+    $ratingoptions->scaleid = $oublog->scale;
+    $ratingoptions->userid = $USER->id;
+    $ratingoptions->assesstimestart = $oublog->assesstimestart;
+    $ratingoptions->assesstimefinish = $oublog->assesstimefinish;
+
+    $rm = new rating_manager();
+    $postswithratings = $rm->get_ratings($ratingoptions);
+    $post = $postswithratings['post'];
+}
+
+echo $oublogoutput->render_post($cm, $oublog, $post, $returnurl, $blogtype, $canmanageposts,
+        $canaudit, false, false);
+
+if (!empty($post->comments)) {
+    // Code extracted to new renderer function.
+    echo $oublogoutput->render_comments($post, $oublog, $canaudit, $canmanagecomments, false, $cm);
+}
+echo '</div>';
+// If it is your own post, then see if there are any moderated comments -
+// for security reasons, you must also be allowed to comment on the post in
+// order to moderate it (because 'approving' a comment is basically equivalent
+// to commenting).
+// Logic should be if public comments are allowed and,
+// either post user and can comment, or can manage comments.
+$includeset = $canaudit;
+if ($post->allowcomments >= OUBLOG_COMMENTS_ALLOWPUBLIC &&
+        (($post->userid == $USER->id && oublog_can_comment($cm, $oublog, $post)) || $canmanagecomments)) {
+    // Also, if this is a personal global blog include accepted/rejected comments.
+    if ($oublog->global) {
+        $includeset = true;
+    }
+    $moderated = oublog_get_moderated_comments($oublog, $post, $includeset);
+    $display = array();
+    foreach ($moderated as $comment) {
+        if ($comment->approval != OUBLOG_MODERATED_APPROVED) {
+            $display[] = $comment;
+        }
+    }
+    if (count($display)) {
+        print '<h2 id="awaiting">' . get_string('moderated_awaiting', 'oublog') . '</h2>';
+        print '<p>' . get_string('moderated_awaitingnote', 'oublog') . '</p>';
+        print '<div class="oublog-awaiting">';
+        foreach ($display as $comment) {
+            if ($comment->approval == OUBLOG_MODERATED_APPROVED) {
+                continue; // Don't bother showing approved comments as they
+                          // appear above.
+            }
+
+            $extraclasses = '';
+            $extramessage = '';
+            if ($comment->approval == OUBLOG_MODERATED_REJECTED) {
+                $extraclasses = 'oublog-rejected';
+                $extramessage = '<div class="oublog-rejected-info">' .
+                        get_string('moderated_rejectedon', 'oublog',
+                            oublog_date($comment->timeset)) . ' </div>';
+            }
+            $extraclasses .= ' oublog-hasuserpic';
+
+            // Start of comment.
+            print '<div class="oublog-comment ' . $extraclasses . '">' .
+                    $extramessage;
+
+            // Title.
+            if (trim(format_string($comment->title)) !== '') {
+                print '<h3 class="oublog-comment-title">' .
+                        format_string($comment->title) . '</h3>';
+            }
+
+            // Date and author.
+            print '<div class="oublog-comment-date">' .
+                    oublog_date($comment->timeposted) . ' </div>';
+            print '<div class="oublog-postedby">' .
+                    get_string('moderated_postername', 'oublog',
+                        s($comment->authorname)) .
+                    ($canaudit ? ' (' . s($comment->authorip) . ')' : '') . '</div>';
+
+            print '<div class="oublog-comment-content">' .
+                    format_text($comment->message, FORMAT_MOODLE) . '</div>';
+
+            // You can only approve/reject it once; and we don't let admins
+            // approve/reject (because there's no way of tracking who did it
+            // and it displays the post owner as having approved it)...
+            if ($comment->approval == OUBLOG_MODERATED_UNSET &&
+                    $post->userid == $USER->id) {
+                print '<form action="approve.php" method="post"><div>' .
+                        '<input type="hidden" name="sesskey" value="' . sesskey() . '" />' .
+                        '<input type="hidden" name="mcomment" value="' . $comment->id . '" />';
+                if (count($moderated) == 1) {
+                    // Track if this is the last comment so we can jump to the
+                    // top of the page instead of the moderating bit.
+                    print '<input type="hidden" name="last" value="1" />';
+                }
+                print '<input type="submit" name="bapprove" value="' .
+                    get_string('moderated_approve', 'oublog') . '" /> ';
+                print '<input type="submit" name="breject" value="' .
+                    get_string('moderated_reject', 'oublog') . '" />';
+                print '</div></form>';
+            }
+
+            // End of comment.
+            print '</div>';
+        }
+        // End of comments awaiting approval.
+        print '</div>';
+    }
+}
+
+
+echo '</div>';
+
+if ($oublog->global) {
+    echo $oublogoutput->get_link_back_to_oublog($blogname, $oubloginstance->userid, true);
+} else {
+    echo $oublogoutput->get_link_back_to_oublog($blogname, $cm->id);
+}
+
+// Finish the page.
+echo '<div class="clearfix"></div>';
+echo $OUTPUT->footer();
diff --git a/mod/oublog/yui/accordion/accordion.js b/mod/oublog/yui/accordion/accordion.js
new file mode 100644
index 0000000..bdb5703
--- /dev/null
+++ b/mod/oublog/yui/accordion/accordion.js
@@ -0,0 +1,90 @@
+YUI.add('moodle-mod_oublog-accordion', function(Y) {
+    M.mod_oublog = M.mod_oublog || {};
+    M.mod_oublog.accordion = M.mod_oublog.accordion || {
+            closetab : function(tab) {
+                tab.title.set('tabindex', -1);
+                tab.removeClass('oublog-accordion-open');
+                tab.addClass('oublog-accordion-closed');
+                tab.content.removeClass('oublog-accordion-open');
+                tab.content.addClass('oublog-accordion-closed');
+                tab.state = 0;
+            },
+            opentab : function(tab) {
+                // Shut all other tabs.
+                var tabs = tab.get('parentNode').all('li.oublog-accordion-open');
+                tabs.each(function(tabref){M.mod_oublog.accordion.closetab(tabref);});
+
+                // Now open this one.
+                tab.title.set('tabindex', 0);
+                tab.removeClass('oublog-accordion-closed');
+                tab.addClass('oublog-accordion-open');
+                tab.content.removeClass('oublog-accordion-closed');
+                tab.content.addClass('oublog-accordion-open');
+                tab.state = 1;
+                if (!Y.one('body').hasClass('notloggedin')) {
+                    M.util.set_user_preference('oublog_accordion_' + tab.container_class + '_open', tab.number);
+                }
+            },
+            // Init an 'accordion' style widget - ul with two divs in each li (title,content).
+            init: function(container_class, default_open) {
+                var container = Y.one('ul.oublog-accordion-' + container_class);
+                if (!container) {
+                    return;
+                }
+                container.set('tabindex', 0);
+                var counter = 1;
+                // Setup UI.
+                var tabs = container.all('li');
+                if (!default_open || tabs.size() < default_open) {
+                    default_open = 1;
+                }
+                tabs.each(
+                        function(tab) {
+                            tab.container_class = container_class;
+                            tab.title = tab.one('.oublog_statsview_title h2');
+                            tab.content = tab.one('.oublog_statsview_content');
+                            tab.number = counter;
+                            tab.title.setAttribute('aria-controls', tab.content.generateID());
+                            tab.title.setAttribute('role', 'tab');
+
+                            tab.content.setAttribute('aria-labeledby', tab.title.generateID());
+                            tab.content.setAttribute('role', 'tabpanel');
+                            tab.state = 1;
+                            if (default_open != counter) {
+                                M.mod_oublog.accordion.closetab(tab);
+                            } else {
+                                // Manual open to stop others being closed.
+                                tab.content.addClass('oublog-accordion-open');
+                                tab.addClass('oublog-accordion-open');
+                                tab.title.set('tabindex', 0);
+                            }
+                            tab.title.on(['click', 'keypress'], function(e) {
+                                if (!e.keyCode || (e.keyCode && e.keyCode == 13)) {
+                                    if (tab.state == 1) {
+                                        M.mod_oublog.accordion.closetab(tab);
+                                    } else {
+                                        M.mod_oublog.accordion.opentab(tab);
+                                    }
+                                }
+                                e.preventDefault();
+                                e.stopPropagation();
+                            });
+                            counter ++;
+                        }
+                    );
+                // Setup keyboard focus.
+                container.plug(Y.Plugin.NodeFocusManager, {
+                    descendants: 'li .oublog_statsview_title h2',
+                    keys: { next: 'down:40', previous: 'down:38' },
+                    focusClass: {
+                        className: 'focus', // The class name to use.
+                        fn: function (node) {
+                            // The Node instance to which the class should be applied.
+                            return node.get('parentNode');
+                        }
+                    }
+                });
+            }
+        };
+    }, '@VERSION@', {requires: ['node', 'node-focusmanager']}
+);
diff --git a/mod/oublog/yui/build/moodle-mod_oublog-savecheck/moodle-mod_oublog-savecheck-debug.js b/mod/oublog/yui/build/moodle-mod_oublog-savecheck/moodle-mod_oublog-savecheck-debug.js
new file mode 100644
index 0000000000000000000000000000000000000000..2974c5af1ce1da2831fb12b87628047debe39f1d
GIT binary patch
literal 3102
zcma)8U31z-6n*Dc+&VKAPO(VZK9Ra(n%D_be+}Sfm`=vCNGq{pX;)pXpp4`H-g8$H
zhCq_)1*E;-_uO-Lb~g$|9Cw4<m^hOsxry&hHP1|XQi`RF7BYGWdX!W;a>{7x&U$n`
zygEOo$4;l;r|CkKl&DM+ehXn8nS`#qEjpovbH$+FuWg6MrhVwJS|h=_R!S;O;#R`S
z0j*6%k<esitV(CqymBz@Na(n4EFnCVtl0v-RXUcI+(MF*HZR#Tzr4S`qxVuvD>Ax8
zDk`E&6-ix65{Qw%lnWWt+}mM|3yxvZ#6TAYh6QKaBdKt1X(?^V+5gh|XbkqqSPrHu
z97k@+6s&iQaMzRxgw?8sdx<~i7n9OH@`Wjo%L2xb-AZK{%_UW(OscHMZcq&RIGTRA
zxtr4PdPX0I<MHr%I(q|Qw=g)BOIe#zd66k3iK<$m-5P<jg{$-N+Ye9~{xP~7O=k$7
zE=JSq^T~uRZpJjE+u?XRdV6;{9MkRH`1WRU9uiGZ9@K#ie51ID?~j!fOD9xTwkglh
z(h|{SF)aWov^J7ziP!{1rr^lF(>C@iGNV(UW`iAsHA+Yu*P{~Q{nkKjwOWO#t~}Pz
zdG31I|2^ygtS?`7=q0^nM0;#+KrJ$b0&)0pWfk1i13-l-0X*kqUN~e!UjM8R(St}O
z5reUr6*hdv$yk*x9R2+2^{<!=NjC-Bai@_j@Z;8AtceQx2SR2WnM_<iEwXUo@~kfS
z?IkUNJzHZ6X8N7ZRru_mPHE@$^JjW|db2ANZsr-%j~)02?0~burVic6Xea-5D(2~C
z0e(>YsTBobARWO57YNgcnL~9vSb2m>X^|uvs<o_{0<$faz=4=&62)ttrLZ)2x<m}K
zP-Iy*c%kC^vYO}00p8B&;P}l(nk7S{yFrAiZSzo9ZimRWHw?vTCh*(+Qi7$B%!Dz>
z0y6FaRuYt@rCS;Mzy$_e{G_Y0thT~tU4DE(rF7i@<I9=FAV+5_xfOIRNyMoZLdy)f
zYPmv(B4Z_zhRg1AeOqz<b;^NB2N12C%EDB-dnQ4hc7rx8F9N4Q4btGax2e{)r5t%M
zO228V$@}}(tn^en@TnelSY%bI(ANR|jn3ZsxA2`6DSbMu0Q7>OYm<8^JRPW~uVn}(
zS#=Mb%CNA^e(oK*UuEu)ObcZ!m<VlQ6zAfh-Y@k2e2R@#8e%AvHPv7ZD*X)Jw!qxk
z#s<UKXj#L!{<aO^R--=opHOa<*bP`I_p{=igjS~5FDHIbwWAj~pT9ojk&Unc9%vX~
zxhBv=fzj?Ubqz+or49BI(c&xm^<j>hmtV8N-Vt<emhw<TILO+{cZ7WSe(rLKO~+Fg
zU^))D{SrD)JK);TgumJFP<0&^WGOspDNuryWnr*3zCs^<e{6*4=Ffe2sD!$$735W$
zn{pq1I6cMSJ_Ltsb1j&jFltP*Ek|J|Vfh;JQ0%w#B&{`e-!t22iQ-VbcWbfx=0TmL
z==DA~)kVj!2DlMSgZ+WVeM#^!$M+!Drvd%Me3ztQ^9Aq0kDLAC&o^)T=5W;-90<dw
zS49z=;C$1;eSH>Wimz}R8Eh)D0|XX%+Se@CI)VyQdJo<BD6sSZK5jTj#nXfI7u06{
z>&>;_38!+&7qS7peuZbpH8wMQZ=YGH3^tt6iLyD`oMO}JuvioTIV!ltbuF}?I=tLF
zPZ)x;zs|>#(arT4gddNr{HIa~^$09{G#8~j>d}!lvHw+u-#m-*pXS2PJLv@1D3z$l
OUwTjcf;#%d&i(^#@^0(^

literal 0
HcmV?d00001

diff --git a/mod/oublog/yui/build/moodle-mod_oublog-savecheck/moodle-mod_oublog-savecheck-min.js b/mod/oublog/yui/build/moodle-mod_oublog-savecheck/moodle-mod_oublog-savecheck-min.js
new file mode 100644
index 0000000000000000000000000000000000000000..0155074a20f90af8c6770f575eed041dd965121c
GIT binary patch
literal 891
zcmaKrQBT`25Xay5DT<L$B3uikJ*A4o1AE}10}VE5La1_`OM0r~>+DMbg?#s2TA)mu
z_L9Uo-`{ut-}&eFD`TrFQ!P>DVcJr)pl<1@nI^jhw*t3Ty6%Ewq>zE;yq}xHuJYsJ
z<)t6=#~<chqwFyt7w<wMv$b&&N-);@OdVsjNZqnUUUtkBR6Ywv4ph$L9~H#Be-oKt
zmiNIV;7nDR?9xM}^wC*98>P7n@Hm+pM{zs@B4<4#dno3nWAvs0UL=kfnoNy#))xJ4
zgVJhmfy#9YDcR<~IRW^QqPTR(iV!M@#nGAG_^!c_ihD3OyH9f&ZS$bTLF;A1kk8np
z6+LFTj%E{K3xO}Cmd<mwZv@373b6Oc+2Fv7JNQp`KG?cTF%cT!HgyzOgeS*sO|d<f
z#$q}8JF3>m&@ROP*Ip%ve+MnIb*olHlAInzxTP&f)p+=PWzhn!NJuDgSmi@LyaP-7
z0b)r>8wv^T;E9jQQqfwSoCwZgBu8bxmnhWD_3fR~m1SF~Bq-MKT&h!nS~tRdw?0)T
zyY8MCD~YkDQ1q#DPQpdfBh@ZKfrC!Z!HrB9TcD1MbND>Wz#z$#QK&JtGWHEr7|dq1
zQJTiuhe4~0A78%RUR{5^P`Z!st3xTjxK~S?K)MW6jV~m5Y-|uZ`t3H2vo{UISfjJ!
O1)A;#Q9TIuPrm^#S~u<h

literal 0
HcmV?d00001

diff --git a/mod/oublog/yui/build/moodle-mod_oublog-savecheck/moodle-mod_oublog-savecheck.js b/mod/oublog/yui/build/moodle-mod_oublog-savecheck/moodle-mod_oublog-savecheck.js
new file mode 100644
index 0000000000000000000000000000000000000000..2974c5af1ce1da2831fb12b87628047debe39f1d
GIT binary patch
literal 3102
zcma)8U31z-6n*Dc+&VKAPO(VZK9Ra(n%D_be+}Sfm`=vCNGq{pX;)pXpp4`H-g8$H
zhCq_)1*E;-_uO-Lb~g$|9Cw4<m^hOsxry&hHP1|XQi`RF7BYGWdX!W;a>{7x&U$n`
zygEOo$4;l;r|CkKl&DM+ehXn8nS`#qEjpovbH$+FuWg6MrhVwJS|h=_R!S;O;#R`S
z0j*6%k<esitV(CqymBz@Na(n4EFnCVtl0v-RXUcI+(MF*HZR#Tzr4S`qxVuvD>Ax8
zDk`E&6-ix65{Qw%lnWWt+}mM|3yxvZ#6TAYh6QKaBdKt1X(?^V+5gh|XbkqqSPrHu
z97k@+6s&iQaMzRxgw?8sdx<~i7n9OH@`Wjo%L2xb-AZK{%_UW(OscHMZcq&RIGTRA
zxtr4PdPX0I<MHr%I(q|Qw=g)BOIe#zd66k3iK<$m-5P<jg{$-N+Ye9~{xP~7O=k$7
zE=JSq^T~uRZpJjE+u?XRdV6;{9MkRH`1WRU9uiGZ9@K#ie51ID?~j!fOD9xTwkglh
z(h|{SF)aWov^J7ziP!{1rr^lF(>C@iGNV(UW`iAsHA+Yu*P{~Q{nkKjwOWO#t~}Pz
zdG31I|2^ygtS?`7=q0^nM0;#+KrJ$b0&)0pWfk1i13-l-0X*kqUN~e!UjM8R(St}O
z5reUr6*hdv$yk*x9R2+2^{<!=NjC-Bai@_j@Z;8AtceQx2SR2WnM_<iEwXUo@~kfS
z?IkUNJzHZ6X8N7ZRru_mPHE@$^JjW|db2ANZsr-%j~)02?0~burVic6Xea-5D(2~C
z0e(>YsTBobARWO57YNgcnL~9vSb2m>X^|uvs<o_{0<$faz=4=&62)ttrLZ)2x<m}K
zP-Iy*c%kC^vYO}00p8B&;P}l(nk7S{yFrAiZSzo9ZimRWHw?vTCh*(+Qi7$B%!Dz>
z0y6FaRuYt@rCS;Mzy$_e{G_Y0thT~tU4DE(rF7i@<I9=FAV+5_xfOIRNyMoZLdy)f
zYPmv(B4Z_zhRg1AeOqz<b;^NB2N12C%EDB-dnQ4hc7rx8F9N4Q4btGax2e{)r5t%M
zO228V$@}}(tn^en@TnelSY%bI(ANR|jn3ZsxA2`6DSbMu0Q7>OYm<8^JRPW~uVn}(
zS#=Mb%CNA^e(oK*UuEu)ObcZ!m<VlQ6zAfh-Y@k2e2R@#8e%AvHPv7ZD*X)Jw!qxk
z#s<UKXj#L!{<aO^R--=opHOa<*bP`I_p{=igjS~5FDHIbwWAj~pT9ojk&Unc9%vX~
zxhBv=fzj?Ubqz+or49BI(c&xm^<j>hmtV8N-Vt<emhw<TILO+{cZ7WSe(rLKO~+Fg
zU^))D{SrD)JK);TgumJFP<0&^WGOspDNuryWnr*3zCs^<e{6*4=Ffe2sD!$$735W$
zn{pq1I6cMSJ_Ltsb1j&jFltP*Ek|J|Vfh;JQ0%w#B&{`e-!t22iQ-VbcWbfx=0TmL
z==DA~)kVj!2DlMSgZ+WVeM#^!$M+!Drvd%Me3ztQ^9Aq0kDLAC&o^)T=5W;-90<dw
zS49z=;C$1;eSH>Wimz}R8Eh)D0|XX%+Se@CI)VyQdJo<BD6sSZK5jTj#nXfI7u06{
z>&>;_38!+&7qS7peuZbpH8wMQZ=YGH3^tt6iLyD`oMO}JuvioTIV!ltbuF}?I=tLF
zPZ)x;zs|>#(arT4gddNr{HIa~^$09{G#8~j>d}!lvHw+u-#m-*pXS2PJLv@1D3z$l
OUwTjcf;#%d&i(^#@^0(^

literal 0
HcmV?d00001

diff --git a/mod/oublog/yui/build/moodle-mod_oublog-tagselector/moodle-mod_oublog-tagselector-debug.js b/mod/oublog/yui/build/moodle-mod_oublog-tagselector/moodle-mod_oublog-tagselector-debug.js
new file mode 100644
index 0000000000000000000000000000000000000000..26f56d4d3f629f6e3a9bad32f61df8f6a82a7e37
GIT binary patch
literal 4962
zcmbVQ{cqbg8vZ?h1?K}MrE}zT!+^W237YG5Sb(+NHQk1wR|K>~TU;nnM^f>O%>VnI
zm!vFz$Z0kKhHUBmexLV)zWMno<3*7smDYt4CzUR4bvsphe&YDt3MF!<O)_S)w$7c@
zHA`>C?Cs^7*T?MP=;%$>Gq7{E_4AKE*u(0(Es|_QCdeO-7_P~)Xa3Hfv8!4-$(6K%
zxe^~fXPpUIr0GasR>GCKU=l3rXAL*JVh`8O$a=nFGbvPY1)75C8FS)y7amQx5u7>A
zDt;#zZ=KF{)hOY_uB1z2_;N*tSmwWbK`={Ce?w#}OYv%)>$Y}d#iv5C#^^>ECxtzZ
z!Y2MscAl-Hm`2maUNnW0B0<+ZH}I)x-CJD<#ONl|wMdhhHWm9v!oKR9I{t3WB4^$V
z%f9@Qxn(2BS2Fng{G27h&}35ushLdJD_!5i(&!45A|RanjiDwoTx1Z5`x?f4{M2iu
zcd&}3L~tjT5U}SA(a`1jv!=Br#mjyK`KJvBh-9^Pr(=LV&)2K$X~^Yuly-evzsMTZ
z&eNOhC){M6T_Vx1Vxq?zAt!}&RkHqXE6nmoQO{j@#!kmuHWA7H>HU9%;>$Dk{PYn5
zSxG0%8B4~=z7(#MUVJcID!>%dI$~#9u}^JvYjSbsgR%d1Aq%oKArud&vboVpT_Lx>
zNU?yBK^3_)d8;_=opEIcY%s#M%6&iu{it(}jsT5F&Va%|`GcI73ZD=I>$q|DSLsSH
z?8TIzSaL#-o};FPVVw0Gz`KGJK#hVX3N~HhecoE9t07TAf8-h>a3u%kYqeyBv<)(8
zePq#a@Vw;rqD~y+3LT<YvZ)YtY(b*ft_y-gQ1-pI(4Mi6NpJT?%S=6L#*y0Y!j%Nk
zg*aR{N;=>A^41tpyU+?ygQ^v=LhDeZY|1U7q3b;#qb#(vinF3am)*CX2&s5Oi-j<>
zi=?kMdfi<_rnq$|9|%1UW>JUAkg_!K_9e#|kzCb<`2F211@d=Fyc0&n+Y7s3r-vd!
z42a6ryw)a6gBTVhZz@nbzTFMvrPH+GS>F`4EVk{``e~7#j(ZP}Gay5{bn-v@Y>dz3
zfG4YcG)J4e=1ODCH`SOuAk3D&Z_W@a;96;Y*ER>Tvtj>D=I2jF{Au?bW*tg@0438c
zz+5jo>;;r#{H+n*iNYi*#X&F`;aY<VE#rjj0vzv1Qg9NZC)6v@6pG`3X9TEPEZ+OR
zf>DJz7yJwCX=LvAj`-v;s6->b=v<;$y<5~jg^9e35;EEY4(0Q}bNF|u7St-N#>7Mm
zLh}m?1%{@mZHtKJ8YP>%;W}HdPqb+u{?YN2kJ<DwpQu)NX83|uC-#C(yYG)NQC4Cw
zPM!}JG?Db<lzweq+gdOFvev()G+KN*Z1AwLk*7yeMhQx{gFKMb)u;VQiX^}CV<jS&
zs<h&ciWEt<rC#`~%X+5wa~$yceaEq}={=?SM>o0}sCe@?3V=$A${k(&MIrB5jvi~z
zN3=u5HU2hOIl6dZ8(tqKxOLJgF}lFIIoMu$s04voxgPfgHq_+Bgydfwm?ex6ydozd
z+b_<K<C*;W3XZYQSx(vU^L*RoTY7%$75xRb*2X=>sbPRJpOPn={uJZhWUZ5m2JdYg
zT}j<mjkeBW=}5xq4c|5*><=i%pUvhvalv1J=ui$LV3C%gYF!Og+!m6EV(S5l?^nzp
zzx()6&1yRTprHzRFDz;iE8iHaN?l-{F;O*c8Mbj0=dPr<*m+^IRw;%PC3Zf4EMm5u
z&xNI<?9OQFHw0bNfeQ*Zm$)H-_AETl$hP+a<!-SN?e0E94qwiwx8NX(&Mq-pJY+?2
z$V=8X1$W_Oyy4J6FJKZU4QUc2Z#pA}yg?4$b=$6w-PGuXg^6ii8eM^htn>#8jCb_J
zjYL_^mbzs*r|sDa;X}UPCZXaQFH7eddp4QOaU^J`8QS$^*-H9+Gm+LJgp+@L`_HYk
zQqLifXmfYM4G!GJS+s=}dQsC%PD^fzlN`7yjzh{zL1z%4*`NLWsXsj0w~TtyP4@F;
z*7^Fdr=Cn$$QtUh5QTp)X=}tdw*n`u{y<8#dF_@8=k}m3IY#lZuTM`uTNu&JYr;A0
zj(&Pz%lAKO`Uk_w{EmVjw+?@7A<8}(iDgsOnmzjwzLMAYm&YJv!cwM6i6SHJ&@4jK
zj1QW}4qJ#Y`Q*S}V}<)5D}g4EcI!<#ge&st>6Jp%bZv8B`lds{8?)y-kGCo<H09M1
z{)aj`TA@3>{N?rg>#KKfU!ocwMh4|7;ra+?w-FtvMq@Uj#zXhb|AlscpM*8l?mh1(
Kp|PV+WXqq=Upue>

literal 0
HcmV?d00001

diff --git a/mod/oublog/yui/build/moodle-mod_oublog-tagselector/moodle-mod_oublog-tagselector-min.js b/mod/oublog/yui/build/moodle-mod_oublog-tagselector/moodle-mod_oublog-tagselector-min.js
new file mode 100644
index 0000000000000000000000000000000000000000..e0f9d0dd8bf024aac10ea515c1d9f5d0be9476e6
GIT binary patch
literal 1481
zcma)6ZExE)5dOYjp>Tjh&NO51qa1n7UWx{2m#$4a3|U~%5^ZsyNR>RsHC+Ao9WB2t
z!_a*YC?4;4chB?i{`hb!WK~hpI9C}pYFssUabetQ1acLWQ6)G}_%hlOw6j!kVB0t1
z<X4<;zI@qs{M;bUZYj3fYRHdQ0k>@XBz@)!C7e~1ES+z%Z^;nYR4=I=3}DkLx6Eu&
z5V!aXYaxAvE*>7I=uK02$h6HY)1r-`ruHE`vZ*a}=LZAoMQh@UD)AN<ZN*Il_mgW{
zqd@U(qwQ}|`ORx(S5W6;{weK#Rz_~}$@sL@jRxg&!U>ngxb?l4+Gx8%&;8NGm<Jbq
zsdCHLy28td#8iZb(mP{rEx3<bt#kA%wJ)QQKEIf7uR=6%uRg<TS4u=WCkPnX+h6Hb
zZSdRW4j?^*-!;^S<CogtNys0_`Po0=J?ygBGv^gVZ!;ylTqka>;qdpvXp$ezvy*v}
zkGq7jE(ms0c(GDI$&)lu5hjcbaBC~|`EE%O9ySfLF~Y8&`-Qj&;1M#4Krs<oqk&%i
z8NTEAT`|TrYT(9uxe>KQ7B!our0!^4?wY0cOo?pUcXOdr%-!0)^{!POHb^%hq^x7p
zeZNiw=YdAnJ?^o6iBgl0kUc;|cX~Vm)ECpp_F2wU78IA)m43=fY(Er<vcpT6_l%O+
zb!esiZ-+T(FpA7Bhf35(nyVqXzDj{Ja;Utg#K?s*h${?>%j|1cYrAyWziXN&`+Rp(
zpEpThw>@QL{C{Uicf1i1v`LDX@7X0bHmwT~Pz?PXA-r#)bkPDkrAmK@;f!$TSl2P`
zaR#IjP(}<sl7b`)S&E=+^-kgQ3@AQ=%%VG*<q{dBq(}cO3TKoOA8tfhd)KJJV6AQC
z)}numKW<Qjt@J_Rv&0F3<-doG!TD3G^x6nx!|%sq#)E=;-6$7<ex;tinozqnWgVYj
zeb`dR$%~J_ynBCp_v;J7QLLY$MtR_SUC5viAnU5Mq(M>cXVSCnsF!_0^W1B6l8g`J
I5q18}-#*m~HUIzs

literal 0
HcmV?d00001

diff --git a/mod/oublog/yui/build/moodle-mod_oublog-tagselector/moodle-mod_oublog-tagselector.js b/mod/oublog/yui/build/moodle-mod_oublog-tagselector/moodle-mod_oublog-tagselector.js
new file mode 100644
index 0000000000000000000000000000000000000000..26f56d4d3f629f6e3a9bad32f61df8f6a82a7e37
GIT binary patch
literal 4962
zcmbVQ{cqbg8vZ?h1?K}MrE}zT!+^W237YG5Sb(+NHQk1wR|K>~TU;nnM^f>O%>VnI
zm!vFz$Z0kKhHUBmexLV)zWMno<3*7smDYt4CzUR4bvsphe&YDt3MF!<O)_S)w$7c@
zHA`>C?Cs^7*T?MP=;%$>Gq7{E_4AKE*u(0(Es|_QCdeO-7_P~)Xa3Hfv8!4-$(6K%
zxe^~fXPpUIr0GasR>GCKU=l3rXAL*JVh`8O$a=nFGbvPY1)75C8FS)y7amQx5u7>A
zDt;#zZ=KF{)hOY_uB1z2_;N*tSmwWbK`={Ce?w#}OYv%)>$Y}d#iv5C#^^>ECxtzZ
z!Y2MscAl-Hm`2maUNnW0B0<+ZH}I)x-CJD<#ONl|wMdhhHWm9v!oKR9I{t3WB4^$V
z%f9@Qxn(2BS2Fng{G27h&}35ushLdJD_!5i(&!45A|RanjiDwoTx1Z5`x?f4{M2iu
zcd&}3L~tjT5U}SA(a`1jv!=Br#mjyK`KJvBh-9^Pr(=LV&)2K$X~^Yuly-evzsMTZ
z&eNOhC){M6T_Vx1Vxq?zAt!}&RkHqXE6nmoQO{j@#!kmuHWA7H>HU9%;>$Dk{PYn5
zSxG0%8B4~=z7(#MUVJcID!>%dI$~#9u}^JvYjSbsgR%d1Aq%oKArud&vboVpT_Lx>
zNU?yBK^3_)d8;_=opEIcY%s#M%6&iu{it(}jsT5F&Va%|`GcI73ZD=I>$q|DSLsSH
z?8TIzSaL#-o};FPVVw0Gz`KGJK#hVX3N~HhecoE9t07TAf8-h>a3u%kYqeyBv<)(8
zePq#a@Vw;rqD~y+3LT<YvZ)YtY(b*ft_y-gQ1-pI(4Mi6NpJT?%S=6L#*y0Y!j%Nk
zg*aR{N;=>A^41tpyU+?ygQ^v=LhDeZY|1U7q3b;#qb#(vinF3am)*CX2&s5Oi-j<>
zi=?kMdfi<_rnq$|9|%1UW>JUAkg_!K_9e#|kzCb<`2F211@d=Fyc0&n+Y7s3r-vd!
z42a6ryw)a6gBTVhZz@nbzTFMvrPH+GS>F`4EVk{``e~7#j(ZP}Gay5{bn-v@Y>dz3
zfG4YcG)J4e=1ODCH`SOuAk3D&Z_W@a;96;Y*ER>Tvtj>D=I2jF{Au?bW*tg@0438c
zz+5jo>;;r#{H+n*iNYi*#X&F`;aY<VE#rjj0vzv1Qg9NZC)6v@6pG`3X9TEPEZ+OR
zf>DJz7yJwCX=LvAj`-v;s6->b=v<;$y<5~jg^9e35;EEY4(0Q}bNF|u7St-N#>7Mm
zLh}m?1%{@mZHtKJ8YP>%;W}HdPqb+u{?YN2kJ<DwpQu)NX83|uC-#C(yYG)NQC4Cw
zPM!}JG?Db<lzweq+gdOFvev()G+KN*Z1AwLk*7yeMhQx{gFKMb)u;VQiX^}CV<jS&
zs<h&ciWEt<rC#`~%X+5wa~$yceaEq}={=?SM>o0}sCe@?3V=$A${k(&MIrB5jvi~z
zN3=u5HU2hOIl6dZ8(tqKxOLJgF}lFIIoMu$s04voxgPfgHq_+Bgydfwm?ex6ydozd
z+b_<K<C*;W3XZYQSx(vU^L*RoTY7%$75xRb*2X=>sbPRJpOPn={uJZhWUZ5m2JdYg
zT}j<mjkeBW=}5xq4c|5*><=i%pUvhvalv1J=ui$LV3C%gYF!Og+!m6EV(S5l?^nzp
zzx()6&1yRTprHzRFDz;iE8iHaN?l-{F;O*c8Mbj0=dPr<*m+^IRw;%PC3Zf4EMm5u
z&xNI<?9OQFHw0bNfeQ*Zm$)H-_AETl$hP+a<!-SN?e0E94qwiwx8NX(&Mq-pJY+?2
z$V=8X1$W_Oyy4J6FJKZU4QUc2Z#pA}yg?4$b=$6w-PGuXg^6ii8eM^htn>#8jCb_J
zjYL_^mbzs*r|sDa;X}UPCZXaQFH7eddp4QOaU^J`8QS$^*-H9+Gm+LJgp+@L`_HYk
zQqLifXmfYM4G!GJS+s=}dQsC%PD^fzlN`7yjzh{zL1z%4*`NLWsXsj0w~TtyP4@F;
z*7^Fdr=Cn$$QtUh5QTp)X=}tdw*n`u{y<8#dF_@8=k}m3IY#lZuTM`uTNu&JYr;A0
zj(&Pz%lAKO`Uk_w{EmVjw+?@7A<8}(iDgsOnmzjwzLMAYm&YJv!cwM6i6SHJ&@4jK
zj1QW}4qJ#Y`Q*S}V}<)5D}g4EcI!<#ge&st>6Jp%bZv8B`lds{8?)y-kGCo<H09M1
z{)aj`TA@3>{N?rg>#KKfU!ocwMh4|7;ra+?w-FtvMq@Uj#zXhb|AlscpM*8l?mh1(
Kp|PV+WXqq=Upue>

literal 0
HcmV?d00001

diff --git a/mod/oublog/yui/src/savecheck/build.json b/mod/oublog/yui/src/savecheck/build.json
new file mode 100644
index 0000000..ac94a5a
--- /dev/null
+++ b/mod/oublog/yui/src/savecheck/build.json
@@ -0,0 +1,10 @@
+{
+    "name": "moodle-mod_oublog-savecheck",
+    "builds": {
+        "moodle-mod_oublog-savecheck": {
+            "jsfiles": [
+                "savecheck.js"
+            ]
+        }
+    }
+}
diff --git a/mod/oublog/yui/src/savecheck/js/savecheck.js b/mod/oublog/yui/src/savecheck/js/savecheck.js
new file mode 100644
index 0000000..e9be7b5
--- /dev/null
+++ b/mod/oublog/yui/src/savecheck/js/savecheck.js
@@ -0,0 +1,75 @@
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+
+/**
+ * Check-save functionality for during oublog post attempts.
+ *
+ * @package   mod_oublog
+ * @copyright 2014 The Open University
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+M.mod_oublog = M.mod_oublog || {};
+
+M.mod_oublog.savecheck = {
+    init : function(contextid) {
+        // Trap edit saving and test that the server connection is available.
+        var btns = Y.all('#id_submitbutton');
+        btns.on('click', function(e) {
+            function savefail() {
+                // Save failed, alert network or session issue.
+                btns.set('disabled', true);
+                var panel = new M.core.alert({
+                    title : M.util.get_string('savefailtitle', 'oublog'),
+                    message : M.util.get_string('savefailnetwork', 'oublog'),
+                    render : true,
+                    plugins : [ Y.Plugin.Drag ],
+                    modal : true
+                });
+                panel.show();
+                e.preventDefault();
+                // Trap cancel and make it a GET - so works with login.
+                var cancel = Y.one('#id_cancel');
+                cancel.on('click', function(e) {
+                    var form = Y.one('.region-content #mform1');
+                    var text = form.one('#fitem_id_message');
+                    var attach = form.one('#fitem_id_attachments');
+                    text.remove();
+                    attach.remove();
+                    form.set('method', 'get');
+                });
+            }
+            function checksave(transactionid, response) {
+                // Check response OK.
+                if (response.responseText !== 'ok') {
+                    // Send save failed due to login/session error.
+                    savefail();
+                }
+            }
+            var cfg = {
+                method : 'POST',
+                data : 'sesskey=' + M.cfg.sesskey + '&contextid=' + contextid,
+                on : {
+                    success : checksave,
+                    failure : savefail
+                },
+                sync : true,// Wait for result so we can cancel submit.
+                timeout : 10000
+            };
+            Y.io('confirmloggedin.php', cfg);
+        });
+    }
+};
diff --git a/mod/oublog/yui/src/savecheck/meta/savecheck.json b/mod/oublog/yui/src/savecheck/meta/savecheck.json
new file mode 100644
index 0000000..7c23a56
--- /dev/null
+++ b/mod/oublog/yui/src/savecheck/meta/savecheck.json
@@ -0,0 +1,11 @@
+{
+    "moodle-mod_oublog-savecheck": {
+        "requires": [
+            "base",
+            "node",
+            "io",
+            "panel",
+            "moodle-core-notification-alert"
+        ]
+    }
+}
diff --git a/mod/oublog/yui/src/tagselector/build.json b/mod/oublog/yui/src/tagselector/build.json
new file mode 100644
index 0000000..38a8dca
--- /dev/null
+++ b/mod/oublog/yui/src/tagselector/build.json
@@ -0,0 +1,10 @@
+{
+    "name": "moodle-mod_oublog-tagselector",
+    "builds": {
+        "moodle-mod_oublog-tagselector": {
+            "jsfiles": [
+                "tagselector.js"
+            ]
+        }
+    }
+}
diff --git a/mod/oublog/yui/src/tagselector/js/tagselector.js b/mod/oublog/yui/src/tagselector/js/tagselector.js
new file mode 100644
index 0000000..4f89790
--- /dev/null
+++ b/mod/oublog/yui/src/tagselector/js/tagselector.js
@@ -0,0 +1,108 @@
+M.mod_oublog = M.mod_oublog || {};
+M.mod_oublog.tagselector = {
+    /**
+     * Initialise the tag selector.
+     *
+     * @method init
+     * @param {String} fieldId id of text field/area to make autocomplete
+     * @param {Array} tags Array of tag objects (tag,count,label properties)
+     */
+    init: function(fieldId, tags) {
+        var inputNode = Y.one('form #' + fieldId);
+        if (tags && typeof tags === 'object') {
+            // Convert object into array.
+            var tags2 = [];
+            for (var key in tags) {
+                tags2.push(tags[key]);
+            }
+            tags = tags2;
+        }
+        if (inputNode) {
+            inputNode.plug(Y.Plugin.AutoComplete, {
+                minQueryLength: 0,
+                queryDelay: 100,
+                queryDelimiter: ',',
+                allowTrailingDelimiter: true,
+                source: tags,
+                width: 'auto',
+                scrollIntoView: true,
+                circular: false,
+                resultTextLocator: 'tag',
+                resultHighlighter: 'startsWith',
+
+                // Chain together a startsWith filter followed by a custom
+                // result filter
+                // that only displays tags that haven't already been selected.
+                resultFilters: ['startsWith', function(query, results) {
+                    // Split the current input value into an array based on
+                    // comma delimiters.
+                    var selected = '';
+                    var lastComma = inputNode.get('value').lastIndexOf(',');
+                    if (lastComma > 0) {
+                        // Ignore tag currently being typed.
+                        selected = inputNode.get('value').substring(0, lastComma).split(/\s*,\s*/);
+                    }
+
+                    // Convert the array into a hash for faster lookups.
+                    selected = Y.Array.hash(selected);
+
+                    // Filter out any results that are already selected, then
+                    // return the
+                    // array of filtered results.
+                    var newResults = Y.Array.filter(results, function(result) {
+                        return !selected.hasOwnProperty(result.text);
+                    });
+                    // Always sort by tag text to ensure correct.
+                    function compareResults(a, b) {
+                        if (a.raw.tag < b.raw.tag) {
+                            return -1;
+                        }
+                        if (a.raw.tag > b.raw.tag) {
+                            return 1;
+                        }
+                        return 0;
+                    }
+                    return newResults.sort(compareResults);
+                }],
+                // Custom result formatter to show tag info.
+                resultFormatter: function(query, results) {
+                  return Y.Array.map(results, function(result) {
+                      var out = '<div class="tagselector_result"><span class="tagselector_result_title">' +
+                              result.highlighted + '</span>';
+                      if (result.raw.label) {
+                          out += ' <span class="tagselector_result_info tagselector_result_info_label">' +
+                              result.raw.label + '</span>';
+                      }
+                      out += ' <span class="tagselector_result_info">' +
+                              M.util.get_string('numposts', 'oublog', result.raw.count) +
+                              '</span>' + '</div>';
+                    return out;
+                  });
+                }
+            });
+
+            // When the input node receives focus, send an empty query to
+            // display the full list of tag suggestions.
+            inputNode.on('focus', function() {
+                inputNode.ac.sendRequest('');
+            });
+
+            // After a tag is selected, send an empty query to update the list of tags.
+            inputNode.ac.after('select', function(e) {
+                // On select the browser (chrome) is scrolled to input node so you can't see list.
+                // See https://github.com/yui/yui3/issues/958
+                // Work-around: scroll down by (hard-coded) list height + text area height.
+                if (Y.UA.chrome) {
+                    window.scrollBy(0, parseInt(inputNode.getStyle('height')) + 200);
+                }
+                // Send the query on the next tick to ensure that the input node's blur
+                // handler doesn't hide the result list right after we show it.
+                setTimeout(function() {
+                    inputNode.ac.sendRequest('');
+                    inputNode.ac.show();
+                }, 1);
+            });
+
+        }
+    }
+};
diff --git a/mod/oublog/yui/src/tagselector/meta/tagselector.json b/mod/oublog/yui/src/tagselector/meta/tagselector.json
new file mode 100644
index 0000000..552f040
--- /dev/null
+++ b/mod/oublog/yui/src/tagselector/meta/tagselector.json
@@ -0,0 +1,11 @@
+{
+    "moodle-mod_oublog-tagselector": {
+        "requires": [
+            "base",
+            "node",
+            "autocomplete",
+            "autocomplete-filters",
+            "autocomplete-highlighters"
+        ]
+    }
+}
diff --git a/mod/oublog/yui/statsbar/statsbar.js b/mod/oublog/yui/statsbar/statsbar.js
new file mode 100644
index 0000000..2e49cc9
--- /dev/null
+++ b/mod/oublog/yui/statsbar/statsbar.js
@@ -0,0 +1,29 @@
+YUI.add('moodle-mod_oublog-statsbar', function(Y) {
+    M.mod_oublog = M.mod_oublog || {};
+    M.mod_oublog.statsbar = {
+            init: function(container_class) {
+                var bars = Y.all('.' + container_class + ' .oublog_statsinfo_bar span');
+                if (bars) {
+                    bars.each(
+                            function(bar) {
+                                var classes = bar.get('className');
+                                if (classes.indexOf('percent') === 0) {
+                                    var percent = parseInt(classes.substring(8), 10);
+                                    var curwidth = parseInt(bar.get('offsetWidth'), 10);
+                                    bar.addClass('oublogbar');
+                                    var maxwidth = parseInt(bar.get('parentNode').getStyle('width'), 10);
+                                    var padding = parseInt(bar.getStyle('padding-left'), 10);
+                                    if (!padding) {
+                                        padding = 5;
+                                    }
+                                    maxwidth = maxwidth - padding;
+                                    var newwidth = (maxwidth - curwidth) / 100 * percent;
+                                    bar.setStyle('width', (curwidth + newwidth) + 'px');
+                                }
+                            }
+                    );
+                }
+            }
+        };
+    }, '@VERSION@', {requires: ['node']}
+);
diff --git a/mod/oublog/yui/statsupdate/statsupdate.js b/mod/oublog/yui/statsupdate/statsupdate.js
new file mode 100644
index 0000000..fb86626
--- /dev/null
+++ b/mod/oublog/yui/statsupdate/statsupdate.js
@@ -0,0 +1,94 @@
+YUI.add('moodle-mod_oublog-statsupdate', function(Y) {
+    M.mod_oublog = M.mod_oublog || {};
+    M.mod_oublog.statsupdate = {
+            // Override option forms and make them submit via ajax to dynamically update container.
+            init: function(container_class) {
+                var content = Y.one('.oublog_statsview_content_' + container_class);
+                if (content) {
+                    var form = content.one('form.mform');
+                    form.on('submit', function(e){
+                        e.preventDefault();
+                        var cfg = {
+                                method: 'POST',
+                                on: {
+                                    start: function() {
+                                        // Add an ajax 'spinner'.
+                                        var submit = form.one('.felement.fsubmit');
+                                        submit.append('<div class="ajaxworking" />');
+                                    },
+                                    success: function(transactionid, o) {
+                                        statsupdate_killspinner(false);
+                                        if (o.responseText) {
+                                            // Process the JSON data returned from the server.
+                                            try {
+                                                var response = Y.JSON.parse(o.responseText);
+                                                if (response.error) {
+                                                    statsupdate_killspinner(true);
+                                                    return;
+                                                }
+                                                if (response.containerclass &&
+                                                        !content.hasClass(response.containerclass)) {
+                                                    // Mismatch between data and caller.
+                                                    content = Y.one('.' + response.containerclass);
+                                                }
+                                                if (response.subtitle && response.subtitleclass) {
+                                                    var subtitle = content.one('.' + response.subtitleclass);
+                                                    if (subtitle) {
+                                                        subtitle.set('innerHTML', response.subtitle);
+                                                    }
+                                                }
+                                                if (response.info && response.infoclass) {
+                                                    var info = content.one('.' + response.infoclass);
+                                                    if (info) {
+                                                        info.set('innerHTML', response.info);
+                                                    }
+                                                }
+                                                if ((response.content || response.content == '')
+                                                        && response.contentclass) {
+                                                    var innercontent = content.one('.' + response.contentclass);
+                                                    if (innercontent) {
+                                                        innercontent.set('innerHTML', response.content);
+                                                        // We need to call dependant js.
+                                                        if (response.containerclass &&
+                                                                response.content.indexOf('oublog_statsinfo_bar') &&
+                                                                M.mod_oublog.statsbar) {
+                                                            M.mod_oublog.statsbar.init(response.containerclass);
+                                                        }
+                                                    }
+                                                }
+                                            } catch (e) {
+                                                statsupdate_killspinner(true);
+                                                return;
+                                            }
+                                        } else {
+                                            statsupdate_killspinner(true);
+                                            return;
+                                        }
+                                    },
+                                    failure: function() {
+                                        statsupdate_killspinner(true);
+                                    }
+                                },
+                                form: {
+                                    id: form
+                                }
+                        };
+                        var uri = M.cfg.wwwroot + '/mod/oublog/stats_update.php';
+                        Y.io(uri, cfg);
+                        var statsupdate_killspinner = function(submit) {
+                            var spinner = form.one('.ajaxworking');
+                            if (spinner) {
+                                spinner.remove(true);
+                            }
+                            if (submit) {
+                                // Manual form submission fallback.
+                                form.submit();
+                            }
+                        };
+                        return;
+                        });
+                }
+            }
+        };
+    }, '@VERSION@', {requires: ['node', 'io', 'io-form', 'json-parse']}
+);
-- 
1.8.3.1

