From 7bfe2fd30ae67401d844f31aea68fc7be8910ccc Mon Sep 17 00:00:00 2001
From: Nadav Kavalerchik <nadavkav@gmail.com>
Date: Wed, 11 Oct 2017 21:24:48 +0300
Subject: [PATCH 40/95] lib/editor/atto/plugins/wiris (new)

---
 lib/editor/atto/plugins/wiris/.travis.yml          |   73 +
 lib/editor/atto/plugins/wiris/LICENSE              |  674 +++
 lib/editor/atto/plugins/wiris/README.md            |   25 +
 lib/editor/atto/plugins/wiris/VERSION              |    1 +
 .../atto/plugins/wiris/configuration.ini.dist      |  202 +
 lib/editor/atto/plugins/wiris/core/cas.js          |  253 ++
 lib/editor/atto/plugins/wiris/core/cas.png         |  Bin 0 -> 12579 bytes
 lib/editor/atto/plugins/wiris/core/core.js         | 4760 ++++++++++++++++++++
 lib/editor/atto/plugins/wiris/core/editor.css      |  134 +
 lib/editor/atto/plugins/wiris/core/editor.html     |   63 +
 lib/editor/atto/plugins/wiris/core/editor.js       |  455 ++
 lib/editor/atto/plugins/wiris/core/help.gif        |  Bin 0 -> 193 bytes
 lib/editor/atto/plugins/wiris/core/icons/cas.gif   |  Bin 0 -> 1037 bytes
 lib/editor/atto/plugins/wiris/core/icons/chem.gif  |  Bin 0 -> 1058 bytes
 .../atto/plugins/wiris/core/icons/formula.gif      |  Bin 0 -> 1049 bytes
 .../wiris/core/icons/general/close_icon.png        |  Bin 0 -> 524 bytes
 .../wiris/core/icons/general/fulls_icon.png        |  Bin 0 -> 442 bytes
 .../plugins/wiris/core/icons/general/max_icon.png  |  Bin 0 -> 266 bytes
 .../plugins/wiris/core/icons/general/min_icon.png  |  Bin 0 -> 235 bytes
 .../plugins/wiris/core/icons/general/mins_icon.png |  Bin 0 -> 464 bytes
 .../wiris/core/icons/hover/close_icon_h.png        |  Bin 0 -> 550 bytes
 .../wiris/core/icons/hover/fulls_icon_h.png        |  Bin 0 -> 423 bytes
 .../plugins/wiris/core/icons/hover/max_icon_h.png  |  Bin 0 -> 267 bytes
 .../plugins/wiris/core/icons/hover/min_icon_h.png  |  Bin 0 -> 244 bytes
 .../plugins/wiris/core/icons/hover/mins_icon_h.png |  Bin 0 -> 462 bytes
 .../atto/plugins/wiris/core/icons/tiny_mce/cas.gif |  Bin 0 -> 1037 bytes
 .../plugins/wiris/core/icons/tiny_mce/chem.gif     |  Bin 0 -> 1082 bytes
 .../plugins/wiris/core/icons/tiny_mce/formula.gif  |  Bin 0 -> 1049 bytes
 .../atto/plugins/wiris/core/icons/xinha/cas.gif    |  Bin 0 -> 1037 bytes
 .../plugins/wiris/core/icons/xinha/formula.gif     |  Bin 0 -> 1049 bytes
 lib/editor/atto/plugins/wiris/core/iframe.html     |   61 +
 lib/editor/atto/plugins/wiris/core/modal.css       |  297 ++
 .../atto/plugins/wiris/core/poweredbywiris.png     |  Bin 0 -> 5223 bytes
 lib/editor/atto/plugins/wiris/db/install.php       |   58 +
 lib/editor/atto/plugins/wiris/db/uninstall.php     |   55 +
 .../plugins/wiris/generic_wiris/generic_demo.js    |  255 ++
 lib/editor/atto/plugins/wiris/icons/cas.png        |  Bin 0 -> 208 bytes
 lib/editor/atto/plugins/wiris/icons/chem.png       |  Bin 0 -> 530 bytes
 lib/editor/atto/plugins/wiris/icons/formula.png    |  Bin 0 -> 407 bytes
 lib/editor/atto/plugins/wiris/lang/ar/strings.js   |    8 +
 lib/editor/atto/plugins/wiris/lang/ca/strings.js   |    8 +
 lib/editor/atto/plugins/wiris/lang/cs/strings.js   |    8 +
 lib/editor/atto/plugins/wiris/lang/da/strings.js   |    8 +
 lib/editor/atto/plugins/wiris/lang/de/strings.js   |    8 +
 lib/editor/atto/plugins/wiris/lang/el/strings.js   |    8 +
 .../atto/plugins/wiris/lang/en/atto_wiris.php      |   20 +
 lib/editor/atto/plugins/wiris/lang/en/strings.js   |    8 +
 lib/editor/atto/plugins/wiris/lang/es/strings.js   |    8 +
 lib/editor/atto/plugins/wiris/lang/et/strings.js   |    8 +
 lib/editor/atto/plugins/wiris/lang/eu/strings.js   |    8 +
 lib/editor/atto/plugins/wiris/lang/fi/strings.js   |    8 +
 lib/editor/atto/plugins/wiris/lang/fr/strings.js   |    8 +
 lib/editor/atto/plugins/wiris/lang/gl/strings.js   |    8 +
 lib/editor/atto/plugins/wiris/lang/he/strings.js   |    8 +
 lib/editor/atto/plugins/wiris/lang/hr/strings.js   |    8 +
 lib/editor/atto/plugins/wiris/lang/hu/strings.js   |    8 +
 lib/editor/atto/plugins/wiris/lang/it/strings.js   |    8 +
 lib/editor/atto/plugins/wiris/lang/ja/strings.js   |    8 +
 lib/editor/atto/plugins/wiris/lang/ko/strings.js   |    8 +
 lib/editor/atto/plugins/wiris/lang/nl/strings.js   |    8 +
 lib/editor/atto/plugins/wiris/lang/no/strings.js   |    8 +
 lib/editor/atto/plugins/wiris/lang/pl/strings.js   |    8 +
 lib/editor/atto/plugins/wiris/lang/pt/strings.js   |    8 +
 .../atto/plugins/wiris/lang/pt_br/strings.js       |    8 +
 lib/editor/atto/plugins/wiris/lang/ru/strings.js   |    8 +
 lib/editor/atto/plugins/wiris/lang/sv/strings.js   |    8 +
 lib/editor/atto/plugins/wiris/lang/tr/strings.js   |    8 +
 lib/editor/atto/plugins/wiris/lang/zh/strings.js   |    8 +
 lib/editor/atto/plugins/wiris/lib.php              |   71 +
 lib/editor/atto/plugins/wiris/pix/cas.png          |  Bin 0 -> 207 bytes
 lib/editor/atto/plugins/wiris/pix/chem.png         |  Bin 0 -> 529 bytes
 lib/editor/atto/plugins/wiris/pix/formula.png      |  Bin 0 -> 406 bytes
 lib/editor/atto/plugins/wiris/pix/icon.png         |  Bin 0 -> 406 bytes
 lib/editor/atto/plugins/wiris/settings.php         |   40 +
 lib/editor/atto/plugins/wiris/tech.txt             |    1 +
 lib/editor/atto/plugins/wiris/test.html            |  163 +
 .../plugins/wiris/tests/behat/edit_formula.feature |   28 +
 .../atto/plugins/wiris/tests/generic_demo.html     |   10 +
 lib/editor/atto/plugins/wiris/version.php          |   33 +
 .../atto/plugins/wiris/wirisplugin-generic.js      |  264 ++
 .../moodle-atto_wiris-button-debug.js              |  Bin 0 -> 10739 bytes
 .../moodle-atto_wiris-button-min.js                |  Bin 0 -> 5091 bytes
 .../moodle-atto_wiris-button.js                    |  Bin 0 -> 10686 bytes
 .../atto/plugins/wiris/yui/src/button/build.json   |   10 +
 .../atto/plugins/wiris/yui/src/button/js/button.js |  296 ++
 .../plugins/wiris/yui/src/button/meta/button.json  |    8 +
 86 files changed, 8534 insertions(+)
 create mode 100644 lib/editor/atto/plugins/wiris/.travis.yml
 create mode 100644 lib/editor/atto/plugins/wiris/LICENSE
 create mode 100644 lib/editor/atto/plugins/wiris/README.md
 create mode 100644 lib/editor/atto/plugins/wiris/VERSION
 create mode 100644 lib/editor/atto/plugins/wiris/configuration.ini.dist
 create mode 100644 lib/editor/atto/plugins/wiris/core/cas.js
 create mode 100644 lib/editor/atto/plugins/wiris/core/cas.png
 create mode 100644 lib/editor/atto/plugins/wiris/core/core.js
 create mode 100644 lib/editor/atto/plugins/wiris/core/editor.css
 create mode 100644 lib/editor/atto/plugins/wiris/core/editor.html
 create mode 100644 lib/editor/atto/plugins/wiris/core/editor.js
 create mode 100644 lib/editor/atto/plugins/wiris/core/help.gif
 create mode 100644 lib/editor/atto/plugins/wiris/core/icons/cas.gif
 create mode 100644 lib/editor/atto/plugins/wiris/core/icons/chem.gif
 create mode 100644 lib/editor/atto/plugins/wiris/core/icons/formula.gif
 create mode 100644 lib/editor/atto/plugins/wiris/core/icons/general/close_icon.png
 create mode 100644 lib/editor/atto/plugins/wiris/core/icons/general/fulls_icon.png
 create mode 100644 lib/editor/atto/plugins/wiris/core/icons/general/max_icon.png
 create mode 100644 lib/editor/atto/plugins/wiris/core/icons/general/min_icon.png
 create mode 100644 lib/editor/atto/plugins/wiris/core/icons/general/mins_icon.png
 create mode 100644 lib/editor/atto/plugins/wiris/core/icons/hover/close_icon_h.png
 create mode 100644 lib/editor/atto/plugins/wiris/core/icons/hover/fulls_icon_h.png
 create mode 100644 lib/editor/atto/plugins/wiris/core/icons/hover/max_icon_h.png
 create mode 100644 lib/editor/atto/plugins/wiris/core/icons/hover/min_icon_h.png
 create mode 100644 lib/editor/atto/plugins/wiris/core/icons/hover/mins_icon_h.png
 create mode 100644 lib/editor/atto/plugins/wiris/core/icons/tiny_mce/cas.gif
 create mode 100644 lib/editor/atto/plugins/wiris/core/icons/tiny_mce/chem.gif
 create mode 100644 lib/editor/atto/plugins/wiris/core/icons/tiny_mce/formula.gif
 create mode 100644 lib/editor/atto/plugins/wiris/core/icons/xinha/cas.gif
 create mode 100644 lib/editor/atto/plugins/wiris/core/icons/xinha/formula.gif
 create mode 100644 lib/editor/atto/plugins/wiris/core/iframe.html
 create mode 100644 lib/editor/atto/plugins/wiris/core/modal.css
 create mode 100644 lib/editor/atto/plugins/wiris/core/poweredbywiris.png
 create mode 100644 lib/editor/atto/plugins/wiris/db/install.php
 create mode 100644 lib/editor/atto/plugins/wiris/db/uninstall.php
 create mode 100644 lib/editor/atto/plugins/wiris/generic_wiris/generic_demo.js
 create mode 100644 lib/editor/atto/plugins/wiris/icons/cas.png
 create mode 100644 lib/editor/atto/plugins/wiris/icons/chem.png
 create mode 100644 lib/editor/atto/plugins/wiris/icons/formula.png
 create mode 100644 lib/editor/atto/plugins/wiris/lang/ar/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/ca/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/cs/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/da/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/de/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/el/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/en/atto_wiris.php
 create mode 100644 lib/editor/atto/plugins/wiris/lang/en/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/es/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/et/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/eu/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/fi/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/fr/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/gl/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/he/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/hr/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/hu/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/it/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/ja/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/ko/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/nl/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/no/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/pl/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/pt/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/pt_br/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/ru/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/sv/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/tr/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lang/zh/strings.js
 create mode 100644 lib/editor/atto/plugins/wiris/lib.php
 create mode 100644 lib/editor/atto/plugins/wiris/pix/cas.png
 create mode 100644 lib/editor/atto/plugins/wiris/pix/chem.png
 create mode 100644 lib/editor/atto/plugins/wiris/pix/formula.png
 create mode 100644 lib/editor/atto/plugins/wiris/pix/icon.png
 create mode 100644 lib/editor/atto/plugins/wiris/settings.php
 create mode 100644 lib/editor/atto/plugins/wiris/tech.txt
 create mode 100644 lib/editor/atto/plugins/wiris/test.html
 create mode 100644 lib/editor/atto/plugins/wiris/tests/behat/edit_formula.feature
 create mode 100644 lib/editor/atto/plugins/wiris/tests/generic_demo.html
 create mode 100644 lib/editor/atto/plugins/wiris/version.php
 create mode 100644 lib/editor/atto/plugins/wiris/wirisplugin-generic.js
 create mode 100644 lib/editor/atto/plugins/wiris/yui/build/moodle-atto_wiris-button/moodle-atto_wiris-button-debug.js
 create mode 100644 lib/editor/atto/plugins/wiris/yui/build/moodle-atto_wiris-button/moodle-atto_wiris-button-min.js
 create mode 100644 lib/editor/atto/plugins/wiris/yui/build/moodle-atto_wiris-button/moodle-atto_wiris-button.js
 create mode 100644 lib/editor/atto/plugins/wiris/yui/src/button/build.json
 create mode 100644 lib/editor/atto/plugins/wiris/yui/src/button/js/button.js
 create mode 100644 lib/editor/atto/plugins/wiris/yui/src/button/meta/button.json

diff --git a/lib/editor/atto/plugins/wiris/.travis.yml b/lib/editor/atto/plugins/wiris/.travis.yml
new file mode 100644
index 0000000..19fc7e9
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/.travis.yml
@@ -0,0 +1,73 @@
+language: php
+
+sudo: false
+
+cache:
+  directories:
+    - $HOME/.composer/cache
+
+php:
+ - 5.6
+ - 7.0
+
+env:
+  - MOODLE_BRANCH=MOODLE_33_STABLE DB=mysqli
+  - MOODLE_BRANCH=MOODLE_32_STABLE DB=mysqli
+  - MOODLE_BRANCH=MOODLE_31_STABLE DB=mysqli
+  - MOODLE_BRANCH=MOODLE_30_STABLE DB=pgsql
+  - MOODLE_BRANCH=MOODLE_29_STABLE DB=mysqli
+  - MOODLE_BRANCH=MOODLE_28_STABLE DB=pgsql
+  - MOODLE_BRANCH=MOODLE_27_STABLE DB=mysqli
+
+matrix:
+  exclude:
+    - php: 7.0
+      env: MOODLE_BRANCH=MOODLE_29_STABLE DB=mysqli
+    - php: 7.0
+      env: MOODLE_BRANCH=MOODLE_28_STABLE DB=pgsql
+    - php: 7.0
+      env: MOODLE_BRANCH=MOODLE_27_STABLE DB=mysqli
+    - php: 5.6
+      env: MOODLE_BRANCH=MOODLE_31_STABLE DB=mysqli
+    - php: 5.6
+      env: MOODLE_BRANCH=MOODLE_30_STABLE DB=pgsql
+    - php: 5.6
+      env: MOODLE_BRANCH=MOODLE_29_STABLE DB=mysqli
+    - php: 5.6
+      env: MOODLE_BRANCH=MOODLE_28_STABLE DB=pgsql
+    - php: 5.6
+      env: MOODLE_BRANCH=MOODLE_27_STABLE DB=mysqli
+    - php: 5.4
+      env: MOODLE_BRANCH=MOODLE_33_STABLE DB=mysqli
+    - php: 5.4
+      env: MOODLE_BRANCH=MOODLE_32_STABLE DB=mysqli
+  include:
+    - php: 5.4
+      env: MOODLE_BRANCH=MOODLE_31_STABLE DB=mysqli
+    - php: 5.4
+      env: MOODLE_BRANCH=MOODLE_30_STABLE DB=pgsql
+    - php: 5.4
+      env: MOODLE_BRANCH=MOODLE_29_STABLE DB=mysqli
+    - php: 5.4
+      env: MOODLE_BRANCH=MOODLE_28_STABLE DB=pgsql
+    - php: 5.4
+      env: MOODLE_BRANCH=MOODLE_27_STABLE DB=mysqli
+
+before_install:
+  - phpenv config-rm xdebug.ini
+  - cd ../..
+  - composer selfupdate
+  - composer create-project -n --no-dev --prefer-dist moodlerooms/moodle-plugin-ci ci ^1
+  - export PATH="$(cd ci/bin; pwd):$(cd ci/vendor/bin; pwd):$PATH"
+
+install:
+  - moodle-plugin-ci add-plugin wiris/moodle-filter_wiris
+  - moodle-plugin-ci install
+script:
+  - moodle-plugin-ci phplint
+  - moodle-plugin-ci phpcpd
+  - moodle-plugin-ci phpmd
+  - moodle-plugin-ci codechecker
+  - moodle-plugin-ci shifter
+  - moodle-plugin-ci validate
+  - moodle-plugin-ci phpunit
diff --git a/lib/editor/atto/plugins/wiris/LICENSE b/lib/editor/atto/plugins/wiris/LICENSE
new file mode 100644
index 0000000..9cecc1d
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/LICENSE
@@ -0,0 +1,674 @@
+                    GNU GENERAL PUBLIC LICENSE
+                       Version 3, 29 June 2007
+
+ Copyright (C) 2007 Free Software Foundation, Inc. <http://fsf.org/>
+ Everyone is permitted to copy and distribute verbatim copies
+ of this license document, but changing it is not allowed.
+
+                            Preamble
+
+  The GNU General Public License is a free, copyleft license for
+software and other kinds of works.
+
+  The licenses for most software and other practical works are designed
+to take away your freedom to share and change the works.  By contrast,
+the GNU General Public License is intended to guarantee your freedom to
+share and change all versions of a program--to make sure it remains free
+software for all its users.  We, the Free Software Foundation, use the
+GNU General Public License for most of our software; it applies also to
+any other work released this way by its authors.  You can apply it to
+your programs, too.
+
+  When we speak of free software, we are referring to freedom, not
+price.  Our General Public Licenses are designed to make sure that you
+have the freedom to distribute copies of free software (and charge for
+them if you wish), that you receive source code or can get it if you
+want it, that you can change the software or use pieces of it in new
+free programs, and that you know you can do these things.
+
+  To protect your rights, we need to prevent others from denying you
+these rights or asking you to surrender the rights.  Therefore, you have
+certain responsibilities if you distribute copies of the software, or if
+you modify it: responsibilities to respect the freedom of others.
+
+  For example, if you distribute copies of such a program, whether
+gratis or for a fee, you must pass on to the recipients the same
+freedoms that you received.  You must make sure that they, too, receive
+or can get the source code.  And you must show them these terms so they
+know their rights.
+
+  Developers that use the GNU GPL protect your rights with two steps:
+(1) assert copyright on the software, and (2) offer you this License
+giving you legal permission to copy, distribute and/or modify it.
+
+  For the developers' and authors' protection, the GPL clearly explains
+that there is no warranty for this free software.  For both users' and
+authors' sake, the GPL requires that modified versions be marked as
+changed, so that their problems will not be attributed erroneously to
+authors of previous versions.
+
+  Some devices are designed to deny users access to install or run
+modified versions of the software inside them, although the manufacturer
+can do so.  This is fundamentally incompatible with the aim of
+protecting users' freedom to change the software.  The systematic
+pattern of such abuse occurs in the area of products for individuals to
+use, which is precisely where it is most unacceptable.  Therefore, we
+have designed this version of the GPL to prohibit the practice for those
+products.  If such problems arise substantially in other domains, we
+stand ready to extend this provision to those domains in future versions
+of the GPL, as needed to protect the freedom of users.
+
+  Finally, every program is threatened constantly by software patents.
+States should not allow patents to restrict development and use of
+software on general-purpose computers, but in those that do, we wish to
+avoid the special danger that patents applied to a free program could
+make it effectively proprietary.  To prevent this, the GPL assures that
+patents cannot be used to render the program non-free.
+
+  The precise terms and conditions for copying, distribution and
+modification follow.
+
+                       TERMS AND CONDITIONS
+
+  0. Definitions.
+
+  "This License" refers to version 3 of the GNU General Public License.
+
+  "Copyright" also means copyright-like laws that apply to other kinds of
+works, such as semiconductor masks.
+
+  "The Program" refers to any copyrightable work licensed under this
+License.  Each licensee is addressed as "you".  "Licensees" and
+"recipients" may be individuals or organizations.
+
+  To "modify" a work means to copy from or adapt all or part of the work
+in a fashion requiring copyright permission, other than the making of an
+exact copy.  The resulting work is called a "modified version" of the
+earlier work or a work "based on" the earlier work.
+
+  A "covered work" means either the unmodified Program or a work based
+on the Program.
+
+  To "propagate" a work means to do anything with it that, without
+permission, would make you directly or secondarily liable for
+infringement under applicable copyright law, except executing it on a
+computer or modifying a private copy.  Propagation includes copying,
+distribution (with or without modification), making available to the
+public, and in some countries other activities as well.
+
+  To "convey" a work means any kind of propagation that enables other
+parties to make or receive copies.  Mere interaction with a user through
+a computer network, with no transfer of a copy, is not conveying.
+
+  An interactive user interface displays "Appropriate Legal Notices"
+to the extent that it includes a convenient and prominently visible
+feature that (1) displays an appropriate copyright notice, and (2)
+tells the user that there is no warranty for the work (except to the
+extent that warranties are provided), that licensees may convey the
+work under this License, and how to view a copy of this License.  If
+the interface presents a list of user commands or options, such as a
+menu, a prominent item in the list meets this criterion.
+
+  1. Source Code.
+
+  The "source code" for a work means the preferred form of the work
+for making modifications to it.  "Object code" means any non-source
+form of a work.
+
+  A "Standard Interface" means an interface that either is an official
+standard defined by a recognized standards body, or, in the case of
+interfaces specified for a particular programming language, one that
+is widely used among developers working in that language.
+
+  The "System Libraries" of an executable work include anything, other
+than the work as a whole, that (a) is included in the normal form of
+packaging a Major Component, but which is not part of that Major
+Component, and (b) serves only to enable use of the work with that
+Major Component, or to implement a Standard Interface for which an
+implementation is available to the public in source code form.  A
+"Major Component", in this context, means a major essential component
+(kernel, window system, and so on) of the specific operating system
+(if any) on which the executable work runs, or a compiler used to
+produce the work, or an object code interpreter used to run it.
+
+  The "Corresponding Source" for a work in object code form means all
+the source code needed to generate, install, and (for an executable
+work) run the object code and to modify the work, including scripts to
+control those activities.  However, it does not include the work's
+System Libraries, or general-purpose tools or generally available free
+programs which are used unmodified in performing those activities but
+which are not part of the work.  For example, Corresponding Source
+includes interface definition files associated with source files for
+the work, and the source code for shared libraries and dynamically
+linked subprograms that the work is specifically designed to require,
+such as by intimate data communication or control flow between those
+subprograms and other parts of the work.
+
+  The Corresponding Source need not include anything that users
+can regenerate automatically from other parts of the Corresponding
+Source.
+
+  The Corresponding Source for a work in source code form is that
+same work.
+
+  2. Basic Permissions.
+
+  All rights granted under this License are granted for the term of
+copyright on the Program, and are irrevocable provided the stated
+conditions are met.  This License explicitly affirms your unlimited
+permission to run the unmodified Program.  The output from running a
+covered work is covered by this License only if the output, given its
+content, constitutes a covered work.  This License acknowledges your
+rights of fair use or other equivalent, as provided by copyright law.
+
+  You may make, run and propagate covered works that you do not
+convey, without conditions so long as your license otherwise remains
+in force.  You may convey covered works to others for the sole purpose
+of having them make modifications exclusively for you, or provide you
+with facilities for running those works, provided that you comply with
+the terms of this License in conveying all material for which you do
+not control copyright.  Those thus making or running the covered works
+for you must do so exclusively on your behalf, under your direction
+and control, on terms that prohibit them from making any copies of
+your copyrighted material outside their relationship with you.
+
+  Conveying under any other circumstances is permitted solely under
+the conditions stated below.  Sublicensing is not allowed; section 10
+makes it unnecessary.
+
+  3. Protecting Users' Legal Rights From Anti-Circumvention Law.
+
+  No covered work shall be deemed part of an effective technological
+measure under any applicable law fulfilling obligations under article
+11 of the WIPO copyright treaty adopted on 20 December 1996, or
+similar laws prohibiting or restricting circumvention of such
+measures.
+
+  When you convey a covered work, you waive any legal power to forbid
+circumvention of technological measures to the extent such circumvention
+is effected by exercising rights under this License with respect to
+the covered work, and you disclaim any intention to limit operation or
+modification of the work as a means of enforcing, against the work's
+users, your or third parties' legal rights to forbid circumvention of
+technological measures.
+
+  4. Conveying Verbatim Copies.
+
+  You may convey verbatim copies of the Program's source code as you
+receive it, in any medium, provided that you conspicuously and
+appropriately publish on each copy an appropriate copyright notice;
+keep intact all notices stating that this License and any
+non-permissive terms added in accord with section 7 apply to the code;
+keep intact all notices of the absence of any warranty; and give all
+recipients a copy of this License along with the Program.
+
+  You may charge any price or no price for each copy that you convey,
+and you may offer support or warranty protection for a fee.
+
+  5. Conveying Modified Source Versions.
+
+  You may convey a work based on the Program, or the modifications to
+produce it from the Program, in the form of source code under the
+terms of section 4, provided that you also meet all of these conditions:
+
+    a) The work must carry prominent notices stating that you modified
+    it, and giving a relevant date.
+
+    b) The work must carry prominent notices stating that it is
+    released under this License and any conditions added under section
+    7.  This requirement modifies the requirement in section 4 to
+    "keep intact all notices".
+
+    c) You must license the entire work, as a whole, under this
+    License to anyone who comes into possession of a copy.  This
+    License will therefore apply, along with any applicable section 7
+    additional terms, to the whole of the work, and all its parts,
+    regardless of how they are packaged.  This License gives no
+    permission to license the work in any other way, but it does not
+    invalidate such permission if you have separately received it.
+
+    d) If the work has interactive user interfaces, each must display
+    Appropriate Legal Notices; however, if the Program has interactive
+    interfaces that do not display Appropriate Legal Notices, your
+    work need not make them do so.
+
+  A compilation of a covered work with other separate and independent
+works, which are not by their nature extensions of the covered work,
+and which are not combined with it such as to form a larger program,
+in or on a volume of a storage or distribution medium, is called an
+"aggregate" if the compilation and its resulting copyright are not
+used to limit the access or legal rights of the compilation's users
+beyond what the individual works permit.  Inclusion of a covered work
+in an aggregate does not cause this License to apply to the other
+parts of the aggregate.
+
+  6. Conveying Non-Source Forms.
+
+  You may convey a covered work in object code form under the terms
+of sections 4 and 5, provided that you also convey the
+machine-readable Corresponding Source under the terms of this License,
+in one of these ways:
+
+    a) Convey the object code in, or embodied in, a physical product
+    (including a physical distribution medium), accompanied by the
+    Corresponding Source fixed on a durable physical medium
+    customarily used for software interchange.
+
+    b) Convey the object code in, or embodied in, a physical product
+    (including a physical distribution medium), accompanied by a
+    written offer, valid for at least three years and valid for as
+    long as you offer spare parts or customer support for that product
+    model, to give anyone who possesses the object code either (1) a
+    copy of the Corresponding Source for all the software in the
+    product that is covered by this License, on a durable physical
+    medium customarily used for software interchange, for a price no
+    more than your reasonable cost of physically performing this
+    conveying of source, or (2) access to copy the
+    Corresponding Source from a network server at no charge.
+
+    c) Convey individual copies of the object code with a copy of the
+    written offer to provide the Corresponding Source.  This
+    alternative is allowed only occasionally and noncommercially, and
+    only if you received the object code with such an offer, in accord
+    with subsection 6b.
+
+    d) Convey the object code by offering access from a designated
+    place (gratis or for a charge), and offer equivalent access to the
+    Corresponding Source in the same way through the same place at no
+    further charge.  You need not require recipients to copy the
+    Corresponding Source along with the object code.  If the place to
+    copy the object code is a network server, the Corresponding Source
+    may be on a different server (operated by you or a third party)
+    that supports equivalent copying facilities, provided you maintain
+    clear directions next to the object code saying where to find the
+    Corresponding Source.  Regardless of what server hosts the
+    Corresponding Source, you remain obligated to ensure that it is
+    available for as long as needed to satisfy these requirements.
+
+    e) Convey the object code using peer-to-peer transmission, provided
+    you inform other peers where the object code and Corresponding
+    Source of the work are being offered to the general public at no
+    charge under subsection 6d.
+
+  A separable portion of the object code, whose source code is excluded
+from the Corresponding Source as a System Library, need not be
+included in conveying the object code work.
+
+  A "User Product" is either (1) a "consumer product", which means any
+tangible personal property which is normally used for personal, family,
+or household purposes, or (2) anything designed or sold for incorporation
+into a dwelling.  In determining whether a product is a consumer product,
+doubtful cases shall be resolved in favor of coverage.  For a particular
+product received by a particular user, "normally used" refers to a
+typical or common use of that class of product, regardless of the status
+of the particular user or of the way in which the particular user
+actually uses, or expects or is expected to use, the product.  A product
+is a consumer product regardless of whether the product has substantial
+commercial, industrial or non-consumer uses, unless such uses represent
+the only significant mode of use of the product.
+
+  "Installation Information" for a User Product means any methods,
+procedures, authorization keys, or other information required to install
+and execute modified versions of a covered work in that User Product from
+a modified version of its Corresponding Source.  The information must
+suffice to ensure that the continued functioning of the modified object
+code is in no case prevented or interfered with solely because
+modification has been made.
+
+  If you convey an object code work under this section in, or with, or
+specifically for use in, a User Product, and the conveying occurs as
+part of a transaction in which the right of possession and use of the
+User Product is transferred to the recipient in perpetuity or for a
+fixed term (regardless of how the transaction is characterized), the
+Corresponding Source conveyed under this section must be accompanied
+by the Installation Information.  But this requirement does not apply
+if neither you nor any third party retains the ability to install
+modified object code on the User Product (for example, the work has
+been installed in ROM).
+
+  The requirement to provide Installation Information does not include a
+requirement to continue to provide support service, warranty, or updates
+for a work that has been modified or installed by the recipient, or for
+the User Product in which it has been modified or installed.  Access to a
+network may be denied when the modification itself materially and
+adversely affects the operation of the network or violates the rules and
+protocols for communication across the network.
+
+  Corresponding Source conveyed, and Installation Information provided,
+in accord with this section must be in a format that is publicly
+documented (and with an implementation available to the public in
+source code form), and must require no special password or key for
+unpacking, reading or copying.
+
+  7. Additional Terms.
+
+  "Additional permissions" are terms that supplement the terms of this
+License by making exceptions from one or more of its conditions.
+Additional permissions that are applicable to the entire Program shall
+be treated as though they were included in this License, to the extent
+that they are valid under applicable law.  If additional permissions
+apply only to part of the Program, that part may be used separately
+under those permissions, but the entire Program remains governed by
+this License without regard to the additional permissions.
+
+  When you convey a copy of a covered work, you may at your option
+remove any additional permissions from that copy, or from any part of
+it.  (Additional permissions may be written to require their own
+removal in certain cases when you modify the work.)  You may place
+additional permissions on material, added by you to a covered work,
+for which you have or can give appropriate copyright permission.
+
+  Notwithstanding any other provision of this License, for material you
+add to a covered work, you may (if authorized by the copyright holders of
+that material) supplement the terms of this License with terms:
+
+    a) Disclaiming warranty or limiting liability differently from the
+    terms of sections 15 and 16 of this License; or
+
+    b) Requiring preservation of specified reasonable legal notices or
+    author attributions in that material or in the Appropriate Legal
+    Notices displayed by works containing it; or
+
+    c) Prohibiting misrepresentation of the origin of that material, or
+    requiring that modified versions of such material be marked in
+    reasonable ways as different from the original version; or
+
+    d) Limiting the use for publicity purposes of names of licensors or
+    authors of the material; or
+
+    e) Declining to grant rights under trademark law for use of some
+    trade names, trademarks, or service marks; or
+
+    f) Requiring indemnification of licensors and authors of that
+    material by anyone who conveys the material (or modified versions of
+    it) with contractual assumptions of liability to the recipient, for
+    any liability that these contractual assumptions directly impose on
+    those licensors and authors.
+
+  All other non-permissive additional terms are considered "further
+restrictions" within the meaning of section 10.  If the Program as you
+received it, or any part of it, contains a notice stating that it is
+governed by this License along with a term that is a further
+restriction, you may remove that term.  If a license document contains
+a further restriction but permits relicensing or conveying under this
+License, you may add to a covered work material governed by the terms
+of that license document, provided that the further restriction does
+not survive such relicensing or conveying.
+
+  If you add terms to a covered work in accord with this section, you
+must place, in the relevant source files, a statement of the
+additional terms that apply to those files, or a notice indicating
+where to find the applicable terms.
+
+  Additional terms, permissive or non-permissive, may be stated in the
+form of a separately written license, or stated as exceptions;
+the above requirements apply either way.
+
+  8. Termination.
+
+  You may not propagate or modify a covered work except as expressly
+provided under this License.  Any attempt otherwise to propagate or
+modify it is void, and will automatically terminate your rights under
+this License (including any patent licenses granted under the third
+paragraph of section 11).
+
+  However, if you cease all violation of this License, then your
+license from a particular copyright holder is reinstated (a)
+provisionally, unless and until the copyright holder explicitly and
+finally terminates your license, and (b) permanently, if the copyright
+holder fails to notify you of the violation by some reasonable means
+prior to 60 days after the cessation.
+
+  Moreover, your license from a particular copyright holder is
+reinstated permanently if the copyright holder notifies you of the
+violation by some reasonable means, this is the first time you have
+received notice of violation of this License (for any work) from that
+copyright holder, and you cure the violation prior to 30 days after
+your receipt of the notice.
+
+  Termination of your rights under this section does not terminate the
+licenses of parties who have received copies or rights from you under
+this License.  If your rights have been terminated and not permanently
+reinstated, you do not qualify to receive new licenses for the same
+material under section 10.
+
+  9. Acceptance Not Required for Having Copies.
+
+  You are not required to accept this License in order to receive or
+run a copy of the Program.  Ancillary propagation of a covered work
+occurring solely as a consequence of using peer-to-peer transmission
+to receive a copy likewise does not require acceptance.  However,
+nothing other than this License grants you permission to propagate or
+modify any covered work.  These actions infringe copyright if you do
+not accept this License.  Therefore, by modifying or propagating a
+covered work, you indicate your acceptance of this License to do so.
+
+  10. Automatic Licensing of Downstream Recipients.
+
+  Each time you convey a covered work, the recipient automatically
+receives a license from the original licensors, to run, modify and
+propagate that work, subject to this License.  You are not responsible
+for enforcing compliance by third parties with this License.
+
+  An "entity transaction" is a transaction transferring control of an
+organization, or substantially all assets of one, or subdividing an
+organization, or merging organizations.  If propagation of a covered
+work results from an entity transaction, each party to that
+transaction who receives a copy of the work also receives whatever
+licenses to the work the party's predecessor in interest had or could
+give under the previous paragraph, plus a right to possession of the
+Corresponding Source of the work from the predecessor in interest, if
+the predecessor has it or can get it with reasonable efforts.
+
+  You may not impose any further restrictions on the exercise of the
+rights granted or affirmed under this License.  For example, you may
+not impose a license fee, royalty, or other charge for exercise of
+rights granted under this License, and you may not initiate litigation
+(including a cross-claim or counterclaim in a lawsuit) alleging that
+any patent claim is infringed by making, using, selling, offering for
+sale, or importing the Program or any portion of it.
+
+  11. Patents.
+
+  A "contributor" is a copyright holder who authorizes use under this
+License of the Program or a work on which the Program is based.  The
+work thus licensed is called the contributor's "contributor version".
+
+  A contributor's "essential patent claims" are all patent claims
+owned or controlled by the contributor, whether already acquired or
+hereafter acquired, that would be infringed by some manner, permitted
+by this License, of making, using, or selling its contributor version,
+but do not include claims that would be infringed only as a
+consequence of further modification of the contributor version.  For
+purposes of this definition, "control" includes the right to grant
+patent sublicenses in a manner consistent with the requirements of
+this License.
+
+  Each contributor grants you a non-exclusive, worldwide, royalty-free
+patent license under the contributor's essential patent claims, to
+make, use, sell, offer for sale, import and otherwise run, modify and
+propagate the contents of its contributor version.
+
+  In the following three paragraphs, a "patent license" is any express
+agreement or commitment, however denominated, not to enforce a patent
+(such as an express permission to practice a patent or covenant not to
+sue for patent infringement).  To "grant" such a patent license to a
+party means to make such an agreement or commitment not to enforce a
+patent against the party.
+
+  If you convey a covered work, knowingly relying on a patent license,
+and the Corresponding Source of the work is not available for anyone
+to copy, free of charge and under the terms of this License, through a
+publicly available network server or other readily accessible means,
+then you must either (1) cause the Corresponding Source to be so
+available, or (2) arrange to deprive yourself of the benefit of the
+patent license for this particular work, or (3) arrange, in a manner
+consistent with the requirements of this License, to extend the patent
+license to downstream recipients.  "Knowingly relying" means you have
+actual knowledge that, but for the patent license, your conveying the
+covered work in a country, or your recipient's use of the covered work
+in a country, would infringe one or more identifiable patents in that
+country that you have reason to believe are valid.
+
+  If, pursuant to or in connection with a single transaction or
+arrangement, you convey, or propagate by procuring conveyance of, a
+covered work, and grant a patent license to some of the parties
+receiving the covered work authorizing them to use, propagate, modify
+or convey a specific copy of the covered work, then the patent license
+you grant is automatically extended to all recipients of the covered
+work and works based on it.
+
+  A patent license is "discriminatory" if it does not include within
+the scope of its coverage, prohibits the exercise of, or is
+conditioned on the non-exercise of one or more of the rights that are
+specifically granted under this License.  You may not convey a covered
+work if you are a party to an arrangement with a third party that is
+in the business of distributing software, under which you make payment
+to the third party based on the extent of your activity of conveying
+the work, and under which the third party grants, to any of the
+parties who would receive the covered work from you, a discriminatory
+patent license (a) in connection with copies of the covered work
+conveyed by you (or copies made from those copies), or (b) primarily
+for and in connection with specific products or compilations that
+contain the covered work, unless you entered into that arrangement,
+or that patent license was granted, prior to 28 March 2007.
+
+  Nothing in this License shall be construed as excluding or limiting
+any implied license or other defenses to infringement that may
+otherwise be available to you under applicable patent law.
+
+  12. No Surrender of Others' Freedom.
+
+  If conditions are imposed on you (whether by court order, agreement or
+otherwise) that contradict the conditions of this License, they do not
+excuse you from the conditions of this License.  If you cannot convey a
+covered work so as to satisfy simultaneously your obligations under this
+License and any other pertinent obligations, then as a consequence you may
+not convey it at all.  For example, if you agree to terms that obligate you
+to collect a royalty for further conveying from those to whom you convey
+the Program, the only way you could satisfy both those terms and this
+License would be to refrain entirely from conveying the Program.
+
+  13. Use with the GNU Affero General Public License.
+
+  Notwithstanding any other provision of this License, you have
+permission to link or combine any covered work with a work licensed
+under version 3 of the GNU Affero General Public License into a single
+combined work, and to convey the resulting work.  The terms of this
+License will continue to apply to the part which is the covered work,
+but the special requirements of the GNU Affero General Public License,
+section 13, concerning interaction through a network will apply to the
+combination as such.
+
+  14. Revised Versions of this License.
+
+  The Free Software Foundation may publish revised and/or new versions of
+the GNU General Public License from time to time.  Such new versions will
+be similar in spirit to the present version, but may differ in detail to
+address new problems or concerns.
+
+  Each version is given a distinguishing version number.  If the
+Program specifies that a certain numbered version of the GNU General
+Public License "or any later version" applies to it, you have the
+option of following the terms and conditions either of that numbered
+version or of any later version published by the Free Software
+Foundation.  If the Program does not specify a version number of the
+GNU General Public License, you may choose any version ever published
+by the Free Software Foundation.
+
+  If the Program specifies that a proxy can decide which future
+versions of the GNU General Public License can be used, that proxy's
+public statement of acceptance of a version permanently authorizes you
+to choose that version for the Program.
+
+  Later license versions may give you additional or different
+permissions.  However, no additional obligations are imposed on any
+author or copyright holder as a result of your choosing to follow a
+later version.
+
+  15. Disclaimer of Warranty.
+
+  THERE IS NO WARRANTY FOR THE PROGRAM, TO THE EXTENT PERMITTED BY
+APPLICABLE LAW.  EXCEPT WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT
+HOLDERS AND/OR OTHER PARTIES PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY
+OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING, BUT NOT LIMITED TO,
+THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
+PURPOSE.  THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE PROGRAM
+IS WITH YOU.  SHOULD THE PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF
+ALL NECESSARY SERVICING, REPAIR OR CORRECTION.
+
+  16. Limitation of Liability.
+
+  IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
+WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MODIFIES AND/OR CONVEYS
+THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES, INCLUDING ANY
+GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING OUT OF THE
+USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED TO LOSS OF
+DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY YOU OR THIRD
+PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER PROGRAMS),
+EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE POSSIBILITY OF
+SUCH DAMAGES.
+
+  17. Interpretation of Sections 15 and 16.
+
+  If the disclaimer of warranty and limitation of liability provided
+above cannot be given local legal effect according to their terms,
+reviewing courts shall apply local law that most closely approximates
+an absolute waiver of all civil liability in connection with the
+Program, unless a warranty or assumption of liability accompanies a
+copy of the Program in return for a fee.
+
+                     END OF TERMS AND CONDITIONS
+
+            How to Apply These Terms to Your New Programs
+
+  If you develop a new program, and you want it to be of the greatest
+possible use to the public, the best way to achieve this is to make it
+free software which everyone can redistribute and change under these terms.
+
+  To do so, attach the following notices to the program.  It is safest
+to attach them to the start of each source file to most effectively
+state the exclusion of warranty; and each file should have at least
+the "copyright" line and a pointer to where the full notice is found.
+
+    {one line to give the program's name and a brief idea of what it does.}
+    Copyright (C) {year}  {name of author}
+
+    This program is free software: you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation, either version 3 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program.  If not, see <http://www.gnu.org/licenses/>.
+
+Also add information on how to contact you by electronic and paper mail.
+
+  If the program does terminal interaction, make it output a short
+notice like this when it starts in an interactive mode:
+
+    {project}  Copyright (C) {year}  {fullname}
+    This program comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
+    This is free software, and you are welcome to redistribute it
+    under certain conditions; type `show c' for details.
+
+The hypothetical commands `show w' and `show c' should show the appropriate
+parts of the General Public License.  Of course, your program's commands
+might be different; for a GUI interface, you would use an "about box".
+
+  You should also get your employer (if you work as a programmer) or school,
+if any, to sign a "copyright disclaimer" for the program, if necessary.
+For more information on this, and how to apply and follow the GNU GPL, see
+<http://www.gnu.org/licenses/>.
+
+  The GNU General Public License does not permit incorporating your program
+into proprietary programs.  If your program is a subroutine library, you
+may consider it more useful to permit linking proprietary applications with
+the library.  If this is what you want to do, use the GNU Lesser General
+Public License instead of this License.  But first, please read
+<http://www.gnu.org/philosophy/why-not-lgpl.html>.
diff --git a/lib/editor/atto/plugins/wiris/README.md b/lib/editor/atto/plugins/wiris/README.md
new file mode 100644
index 0000000..78c428e
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/README.md
@@ -0,0 +1,25 @@
+WIRIS plugin for Moodle
+==========
+### Master Build Status
+[![Build Status](https://travis-ci.org/wiris/moodle-atto_wiris.svg?branch=master)](https://travis-ci.org/wiris/moodle-atto_wiris)
+### Development Build Status
+[![Build Status](https://travis-ci.org/wiris/moodle-atto_wiris.svg?branch=development)](https://travis-ci.org/wiris/moodle-atto_wiris)
+
+Add a fully WYSIWYG editor for scientific expressions ([WIRIS EDITOR](http://www.wiris.com/editor)) and, optionally, an advanced calculator tool ([WIRIS CAS](http://www.wiris.com/cas)). Enabled editing to STEM related topics (Science, Technology, Engineering and Mathematics).
+
+[WIRIS EDITOR](http://www.wiris.com/editor) is a mathematical **visual (WYSIWYG) editor**. You can use a large collection of icons nicely organized in thematic tabs in order to create formulas or equations for any web content. You can create and edit your formulas in a visual environment, just click on the WIRIS editor icon for creation or double-click on the formula for edition. It is based on JavaScript and compatible with HTML 5.
+
+WIRIS EDITOR offers a **chemistry** toolbar. The maths and the chemistry palette are available from different icons in the rich text editor.
+
+[WIRIS CAS](http://www.wiris.com/cas) is an online platform for **mathematical calculations** designed for education. You can access a powerful calculation toolbar through an HTML page that includes integrals and limits calculation, function graphing in 2D or 3D and symbolic matrices manipulation, among others. WIRIS cas covers **all mathematical topics** from primary school to university level (Calculus, Algebra, Geometry, Differential Equations...).
+
+WIRIS tools can be used for **free** up to a certain level of use per natural year. Please read **license** conditions and prices at [WIRIS store](http://www.wiris.com/store).
+
+In order to use WIRIS tools for editing you need to combine **[WIRIS filter](https://github.com/wiris/moodle-filter_wiris)** with **[WIRIS plugin for Atto](https://github.com/wiris/mooodle-atto_wiris)** and/or **[WIRIS plugin for TinyMCE](https://github.com/wiris/moodle-tinymce_tiny_mce_wiris)**.
+
+###### More than editing, better quizzes
+Interested in mathematical quizzes with random parameters and automated evaluation?
+Must check our new STEM question types at WIRIS quizzes plugin.
+
+###### Previous version of Moodle?
+Running a **previous version** of Moodle? You can download the components from [wiris.com](http://www.wiris.com/plugins/moodle/download) 
diff --git a/lib/editor/atto/plugins/wiris/VERSION b/lib/editor/atto/plugins/wiris/VERSION
new file mode 100644
index 0000000..662fc87
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/VERSION
@@ -0,0 +1 @@
+4.7.0.1374
diff --git a/lib/editor/atto/plugins/wiris/configuration.ini.dist b/lib/editor/atto/plugins/wiris/configuration.ini.dist
new file mode 100644
index 0000000..9a1fd75
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/configuration.ini.dist
@@ -0,0 +1,202 @@
+#################################################################################################
+# This is a sample configuration file                                                           #
+# You can uncomment any line and rename this file to configuration.ini                          #
+# For further information go to http://www.wiris.com/plugins/docs/resources/configuration-table #
+#################################################################################################
+
+#########################
+# Connection properties #
+#########################
+
+## Specifies formula image server host.
+
+#wirisimageservicehost = www.wiris.net
+
+## Specifies formula image server path.
+
+#wirisimageservicepath = /demo/editor/render
+
+## Specifies formula image server port. If left blank, it is computed automatically.
+
+#wirisimageserviceport = 80
+
+## Specifies formula image server protocol. If left blank, it is computed automatically.
+
+#wirisimageserviceprotocol = http
+
+#######################
+# Proxy configuration #
+#######################
+
+## Specifies if your server is using a proxy connection or not. false by default.
+
+#wirisproxy = false
+
+## If wirisproxy is true, this value specifies the proxy host..
+
+#wirisproxy_host =
+
+## If wirisproxy is true, this value specifies the proxy port.
+
+#wirisproxy_port =
+
+############################################
+# Basic authentication proxy configuration #
+############################################
+
+#wirisproxy_user =
+#wirisproxy_password =
+
+#####################
+# Folder properties #
+#####################
+
+## Place to store the cached images.
+
+#wiriscachedirectory = /var/cache
+
+## Place to store the formulas.
+
+#wirisformuladirectory = /var/formulas
+
+######################
+# Class overridables #
+######################
+
+## Name of the class that manages the storage of formulas.
+
+#wirisstorageclass = com.wiris.plugin.storage.FileStorageAndCache
+
+## Name of the class that updates the loaded configuration.
+
+#wirisconfigurationclass =
+
+
+####################
+# Editor behaviour #
+####################
+
+## Specifies if WIRIS Editor is enabled.
+
+#wiriseditorenabled = true
+
+## Specifies the image attribute to store mathml content.
+
+#wiriseditormathmlattribute = data-mathml
+
+## Specifies how formulas are stored in the database. MathML by default. http://www.wiris.com/en/plugins/docs/full-mathml-mode
+
+#wiriseditorsavemode = xml
+
+## Specifies if in base64 save mode, images should be stored as a base64 string  or as an image.
+
+#wiriseditoreditmode = default
+
+## Specifies if LaTeX content generated with WIRIS Editor should be shown as an image outside editing areas.
+
+#wiriseditorparselatex = true
+
+## Specifies if mathml should be parsed on non-mathml modes (image or base64).
+
+#wiriseditorparsexml = false
+
+## Specifies WIRIS Editor size attributes.
+
+#wiriseditorwindowattributes = width=570, height=450, scroll=no, resizable=yes
+
+## On image mode specifies if the vertical align of the image should be calculated instead of add extra space to vertically center the image.
+
+#wiriseditorsetsize = false
+
+## Specifies if WIRIS Editor should be opened on a modal window or in a pop-up window. true by default.
+
+#wiriseditormodalwindow = true
+
+## Specifies if the modal window should be opened in full-screen mode. false by default.
+
+#wiriseditormodalwindowfullscreen = false
+
+## Specifies if chemistry editor is enabled. true by default.
+
+#wirischemeditorenabled = true
+
+## Specifies image format (svg or png). svg by default.
+
+#wirisimageformat = svg
+
+###############################################################################################
+# Editor inherit parameters                                                                   #
+# The format is a JSON containing WIRIS Editor parameters defined on the following page:      #
+# http://www.wiris.com/editor/docs/reference/parameters                                       #
+# Editor parameter key should be the JSON key and the corresponnding value is the JSON value. #
+###############################################################################################
+
+#wiriseditorparameters = {}
+
+#################
+# Accessibility #
+#################
+
+## Specifies if the accesibility should be included in generated images as "alt" attribute. true by default.
+
+#wirisaccessibilityenabled = true
+
+#########################
+# Cross-Domain policies #
+#########################
+
+## Enables CORS domains policies. false by default.
+wiriscorsenabled = false
+
+###################
+# External plugin #
+###################
+
+## Specifies if the plugin is an external plugin. false by default.
+
+#wirisexternalplugin = false
+
+########################
+# Performance settings #
+########################
+
+## Specifies if the response should be a JSON instead of a binary which allows requests be cached. true by default.
+
+#wirispluginperformance = true
+
+##############################################################################################################################
+# Clean cache  service parameters. For further information go to http://www.wiris.com/en/plugins/docs/resources/clean-backup #
+##############################################################################################################################
+
+## Specifies if the delete cache gui is enabled. false by default.
+
+# wiriscleancachegui = false
+
+## Token needed to delete cache.
+
+# wiriscleancachetoken = token
+
+##############################################################################################
+# Deprecated. Editor parameters should be parsed as a Json on wiriseditorparameters variale. #
+##############################################################################################
+
+#wiristransparency = true
+#wirisfontfamily = Arial
+#wirisimagecolor = #000000
+#wirisimagebackgroundcolor = #ffffff
+#wirisimagefontsize = 16px
+#wirisimagedpi = 96
+#wiriseditortoolbar = quizzes
+#wirisrtllanguages = ar
+#wirisltrlanguages = ar_ma
+#wirisarabicindiclanguages = ar_eg, ar_sd, ar_sa
+#wiriseasternarabicindiclanguages = fa, ps, ur
+#wiriseuropeanlanguages =
+
+###############################################################################################
+# Debug mode to show extra information on test page. Don't enable in production environments. #
+###############################################################################################
+
+#wirisdebug = false
+
+## End of file
diff --git a/lib/editor/atto/plugins/wiris/core/cas.js b/lib/editor/atto/plugins/wiris/core/cas.js
new file mode 100644
index 0000000..03831ca
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/core/cas.js
@@ -0,0 +1,253 @@
+var wrs_int_opener;
+var appletObject;
+var initialXML = '';
+var closeFunction;
+
+if (window.opener) {                            // For popup mode.
+    wrs_int_opener = window.opener;
+    closeFunction = window.close;
+}
+// FCKeditor integration begin
+else {                                          // For iframe mode.
+    wrs_int_opener = window.parent;
+
+    while (wrs_int_opener.InnerDialogLoaded) {
+        wrs_int_opener = wrs_int_opener.parent;
+    }
+}
+
+if (window.parent.InnerDialogLoaded) {          // Iframe mode.
+    window.parent.InnerDialogLoaded();
+    closeFunction = window.parent.Cancel;
+}
+else if (window.opener.parent.FCKeditorAPI) {   // Popup mode.
+    wrs_int_opener = window.opener.parent;
+}
+// FCKeditor integration end.
+
+function getMathmlFromAppletCode(appletCode) {
+    var optionForm = document.getElementById('optionForm');
+    appletObject = wrs_int_opener.wrs_createObject(appletCode, document);
+
+    optionForm.width.value = parseInt(appletObject.width);
+    optionForm.height.value = parseInt(appletObject.height);
+
+    var params = appletObject.childNodes;
+    var mathml = '';
+
+    for (var i = 0; i < params.length; ++i) {
+        if (params[i].name == 'xmlinitialtext') {
+            mathml = params[i].value;
+        }
+        else if (params[i].name == 'requestfirstevaluation') {
+            optionForm.executeonload.checked = (params[i].value == 'true') ? true : false;
+        }
+        else if (params[i].name == 'toolbar') {
+            optionForm.toolbar.checked = (params[i].value == 'floating') ? false : true;
+        }
+        else if (params[i].name == 'requestfocus') {
+            optionForm.focusonload.checked = (params[i].value == 'true') ? true : false;
+        }
+        else if (params[i].name == 'level') {
+            optionForm.level.checked = (params[i].value == 'primary') ? true : false;
+        }
+    }
+
+    return mathml;
+}
+
+function createIframePath(params) {
+    var iframePath = wrs_int_opener._wrs_conf_CASPath;
+    iframePath += ((iframePath.indexOf('?') == -1) ? '?' : '&') + 'mode=applet&';
+
+    for (var i in params) {
+        iframePath += wrs_int_opener.wrs_urlencode(i) + '=' + wrs_int_opener.wrs_urlencode(params[i]);
+    }
+
+    return iframePath;
+}
+
+function createIframe(params) {
+    var iframe = document.createElement('iframe');
+    iframe.id = 'appletContainerIframe';
+    iframe.src = createIframePath(params);
+    iframe.width = '100%';
+    iframe.height = '100%';
+    iframe.frameBorder = 0;
+
+    wrs_int_opener.wrs_addEvent(iframe, 'load', function () {
+        if (initialXML.length > 0) {
+            var applet = iframe.contentWindow.document.getElementById('applet');
+
+            function setAppletMathml() {
+                // Internet explorer fails on "applet.isActive". It only supports "applet.isActive()".
+
+                try {
+                    if (applet.isActive()) {
+                        applet.setXML(initialXML);
+                    }
+                    else {
+                        setTimeout(setAppletMathml, 50);
+                    }
+                }
+                catch (e) {
+                    setTimeout(setAppletMathml, 50);
+                }
+            }
+
+            setAppletMathml();
+        }
+    });
+
+    document.getElementById('appletContainer').appendChild(iframe);
+}
+
+function reloadIframe(params) {
+    var iframe = document.getElementById('appletContainerIframe');
+    var applet = iframe.contentWindow.document.getElementById('applet');
+    initialXML = applet.getXML();
+    iframe.src = createIframePath(params);
+}
+
+wrs_int_opener.wrs_addEvent(window, 'load', function () {
+    // Getting language list <select> object.
+    var languageList = document.getElementById('languageList');
+
+    // When the language list <select> object changes its value, the iframe should be refreshed.
+
+    wrs_int_opener.wrs_addEvent(languageList, 'change', function () {
+        reloadIframe({
+            'lang': languageList.value
+        });
+    });
+
+    // Setting iframe language.
+    var language;
+
+    if (wrs_int_opener._wrs_isNewElement) {
+        var queryParams = wrs_int_opener.wrs_getQueryParams(window);
+
+        var availableLangs = new Array();
+        for (var i = 0; i < languageList.options.length; i++){
+            availableLangs[i] = languageList.options[i].value;
+        }
+
+        if (typeof queryParams['lang'] != 'undefined' && wrs_int_opener.wrs_arrayContains(availableLangs, queryParams['lang']) != -1){
+            language = queryParams['lang'];
+        }else if (typeof queryParams['lang'] != 'undefined' && wrs_int_opener.wrs_arrayContains(availableLangs, queryParams['lang'].substr(0,2)) != -1){
+            language = queryParams['lang'].substr(0,2);
+        }else{
+            language = wrs_int_opener._wrs_int_language
+        }
+    }
+    else {
+        var appletCode = wrs_int_opener._wrs_temporalImage.getAttribute(wrs_int_opener._wrs_conf_CASMathmlAttribute);
+        initialXML = getMathmlFromAppletCode(wrs_int_opener.wrs_mathmlDecode(appletCode));
+
+        var language = '';
+
+        // We can convert initialXML to an object and get its "lang" value. However, IE does not support this functionability, so we use string parsing.
+        var languageStart = initialXML.indexOf('lang="');
+
+        if (languageStart != -1) {
+            var languageEnd = initialXML.indexOf('"', languageStart + 6);       // 6+ because 'lang="'.length is 6.
+
+            if (languageEnd != -1) {
+                language = initialXML.substring(languageStart + 6, languageEnd);
+            }
+        }
+    }
+
+    // Creating the iframe.
+
+    createIframe({
+        'lang': language
+    });
+
+    // Selecting the language on the <select> object.
+
+    for (var i = languageList.options.length - 1; i >= 0; --i) {
+        if (languageList.options[i].value == language) {
+            languageList.selectedIndex = i;
+            i = 0;
+        }
+    }
+
+    // More events.
+
+    wrs_int_opener.wrs_addEvent(document.getElementById('submit'), 'click', function () {
+        var applet = document.getElementById('appletContainerIframe').contentWindow.document.getElementById('applet');
+
+        // Creating new applet code.
+        var optionForm = document.getElementById('optionForm');
+        var newWidth = parseInt(optionForm.width.value);
+        var newHeight = parseInt(optionForm.height.value);
+
+        var appletCode = '<applet alt="WIRIS cas" class="Wiriscas" align="middle" ';
+        appletCode += 'codebase="' + applet.getAttribute('codebase') + '" ';
+        appletCode += 'archive="' + applet.getAttribute('archive') + '" ';
+        appletCode += 'code="' + applet.getAttribute('code') + '" ';
+        appletCode += 'width="' + newWidth + '" height="' + newHeight + '">';
+
+        appletCode += '<param name="requestfirstevaluation" value="' + (optionForm.executeonload.checked ? 'true' : 'false') + '"></param>';
+        appletCode += '<param name="toolbar" value="' + (optionForm.toolbar.checked ? 'true' : 'floating') + '"></param>';
+        appletCode += '<param name="requestfocus" value="' + (optionForm.focusonload.checked ? 'true' : 'false') + '"></param>';
+        appletCode += '<param name="level" value="' + (optionForm.level.checked ? 'primary' : 'false') + '"></param>';
+        appletCode += '<param name="xmlinitialtext" value="' + wrs_int_opener.wrs_htmlentities(applet.getXML()) + '"></param>';
+        appletCode += '<param name="interface" value="false"></param><param name="commands" value="false"></param><param name="command" value="false"></param>';
+
+        appletCode += '</applet>';
+
+        // Getting the image.
+        // First, resize applet.
+        applet.style.width = newWidth + 'px';
+        applet.style.height = newHeight + 'px';
+
+        // Waiting for applet resizing.
+        function finish() {
+            if (applet.getSize().width != newWidth || applet.getSize().height != newHeight) {
+                setTimeout(finish, 100);
+            }
+            else {
+                // Getting the image.
+                var image = applet.getImageBase64('png');
+
+                // FCKeditor integration begin
+                if (window.parent.InnerDialogLoaded && window.parent.FCKBrowserInfo.IsIE) {         // On IE, we must close the dialog for push the caret on the correct position.
+                    closeFunction();
+                    wrs_int_opener.wrs_int_updateCAS(appletCode, image, newWidth, newHeight);
+                }
+                // FCKeditor integration end.
+                else {
+                    wrs_int_opener.wrs_int_updateCAS(appletCode, image, newWidth, newHeight);
+                    closeFunction();
+                }
+            }
+        }
+
+        finish();
+    });
+
+    wrs_int_opener.wrs_addEvent(document.getElementById('cancel'), 'click', function () {
+        closeFunction();
+    });
+
+    var acceptButton = document.getElementById('submit');
+    if (strings['accept'] != null){
+        acceptButton.value = strings['accept'];
+    }
+
+    var cancelButton = document.getElementById('cancel');
+    if (strings['cancel'] != null){
+        cancelButton.value = strings['cancel'];
+    }
+
+    // Auto resizing.
+    setInterval(function () {
+        document.getElementById('appletContainer').style.height = (document.getElementById('optionForm').offsetHeight - document.getElementById('controls').offsetHeight - 5) + 'px';
+    }, 100);
+});
+
+wrs_int_opener.wrs_addEvent(window, 'unload', function () {
+    wrs_int_opener.wrs_int_notifyWindowClosed();
+});
diff --git a/lib/editor/atto/plugins/wiris/core/cas.png b/lib/editor/atto/plugins/wiris/core/cas.png
new file mode 100644
index 0000000000000000000000000000000000000000..a6fd5df02bd510474c7f5ecf8643ba0104ec8403
GIT binary patch
literal 12579
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
MoQqAP)#bnc6ZtIyCIA2c

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/core/core.js b/lib/editor/atto/plugins/wiris/core/core.js
new file mode 100644
index 0000000..d4a4bbf
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/core/core.js
@@ -0,0 +1,4760 @@
+var _wrs_popupWindow;
+
+wrs_addEvent(window, 'message', function (e) {
+    if (e.source = _wrs_popupWindow && typeof e.wrs_processed == 'undefined') {
+        e.wrs_processed = true;
+        var postVariable = {};
+        postVariable.id = e.data.id;
+        if (e.data.hasOwnProperty('methodName')) {
+            var object = (e.data.objectName == null) ? this : window[e.data.objectName];
+            postVariable.value = object[e.data.methodName].apply(object, e.data.arguments);
+        } else {
+            var postVariables = {};
+            e.data.varNames.forEach(function(varName){
+                postVariables[varName] = window[varName];
+            });
+            postVariable.value = postVariables;
+        }
+        if (typeof(e.source) != 'undefined') { // Avoid sent message when popupWindows has been closed.
+            e.source.postMessage(postVariable, _wrs_conf_path);
+        }
+    }
+});
+
+/**
+ * Fires an element event.
+ * @param {object} element element where event should be fired.
+ * @param {string} event event to fire.
+ * @ignore
+ */
+function wrs_fireEvent(element, event) {
+    if (document.createEvent){
+        var eventObject = document.createEvent('HTMLEvents');
+        eventObject.initEvent(event, true, true);
+        return !element.dispatchEvent(eventObject);
+    }
+
+    var eventObject = document.createEventObject();
+    return element.fireEvent('on' + event, eventObject)
+}
+
+wrs_addEvent(window, 'mouseup', function (e) {
+
+    if (typeof(_wrs_modalWindow) !== 'undefined' && _wrs_modalWindow != null) {
+        if (_wrs_modalWindow.properties.state != "maximized") {
+            _wrs_modalWindow.overlayDiv.style.display = 'none';
+        }
+        _wrs_modalWindow.fireEditorEvent('mouseup');
+    }
+});
+
+// Vars.
+var _wrs_currentPath = window.location.toString().substr(0, window.location.toString().lastIndexOf('/') + 1);
+var _wrs_editMode = typeof _wrs_editMode != 'undefined' ? _wrs_editMode : undefined;
+var _wrs_isNewElement = typeof _wrs_isNewElement != 'undefined' ? _wrs_isNewElement : true;
+var _wrs_temporalImage;
+var _wrs_temporalFocusElement;
+var _wrs_range;
+
+// LaTex client cache.
+var _wrs_int_LatexCache = {};
+
+// Accessible client cache.
+var _wrs_int_AccessibleCache = {};
+
+var _wrs_xmlCharacters = {
+    'tagOpener': '<',       // Hex: \x3C.
+    'tagCloser': '>',       // Hex: \x3E.
+    'doubleQuote': '"',     // Hex: \x22.
+    'ampersand': '&',       // Hex: \x26.
+    'quote': '\''           // Hex: \x27.
+};
+
+var _wrs_safeXmlCharacters = {
+    'tagOpener': '',       // Hex: \xAB.
+    'tagCloser': '',       // Hex: \xBB.
+    'doubleQuote': '',     // Hex: \xA8.
+    'ampersand': '',       // Hex: \xA7.
+    'quote': '`',           // Hex: \x60.
+    'realDoubleQuote': ''
+};
+
+var _wrs_safeXmlCharactersEntities = {
+    'tagOpener': '&laquo;',
+    'tagCloser': '&raquo;',
+    'doubleQuote': '&uml;',
+    'realDoubleQuote': '&quot;'
+}
+
+var _wrs_safeBadBlackboardCharacters = {
+    'ltElement': 'mo</mo',
+    'gtElement': 'mo>/mo',
+    'ampElement': 'mo&/mo'
+}
+
+var _wrs_safeGoodBlackboardCharacters = {
+    'ltElement': 'molt;/mo',
+    'gtElement': 'mogt;/mo',
+    'ampElement': 'moamp;/mo'
+}
+
+var _wrs_staticNodeLengths = {
+    'IMG': 1,
+    'BR': 1
+}
+
+// Translated languages.
+var _wrs_languages = 'ar,ca,cs,da,de,en,es,et,eu,fi,fr,gl,he,hr,hu,it,ja,ko,nl,no,pl,pt,pt_br,ru,sv,tr,zh,el';
+
+// Backwards compatibily.
+
+if (!(window._wrs_conf_imageClassName)) {
+    _wrs_conf_imageClassName = 'Wirisformula';
+}
+
+if (!(window._wrs_conf_CASClassName)) {
+    _wrs_conf_CASClassName = 'Wiriscas';
+}
+
+// Mutation observers to avoid wiris image formulas class be removed.
+if (typeof MutationObserver != 'undefined') {
+    var wrs_observer = new MutationObserver(function(mutations) {
+        mutations.forEach(function(mutation) {
+            if (mutation.oldValue == _wrs_conf_imageClassName && mutation.attributeName == 'class' && mutation.target.className.indexOf(_wrs_conf_imageClassName) == -1 ) {
+                mutation.target.className = _wrs_conf_imageClassName;
+            }
+        });
+    });
+
+    var wrs_observer_config = { attributes: true, attributeOldValue:true };
+}
+
+// Plugin listeners for custom callbacks. This variable
+// can be setted by the user using wrs_addPluginListener.
+var wrs_pluginListeners = [];
+
+var _wrs_css_loaded = false;
+
+var _wrs_modalWindowProperties = typeof _wrs_modalWindowProperties != 'undefined' ? _wrs_modalWindowProperties : {};
+var _wrs_editor = typeof _wrs_editor != 'undefined' ? _wrs_editor : null;
+var _wrs_modalWindow = typeof _wrs_modalWindow != 'undefined' ? _wrs_modalWindow : null;
+
+/**
+ * Adds element events.
+ * @param {object} target Target
+ * @param {function} doubleClickHandler Function to run when user double clicks the element
+ * @param {function} mousedownHandler Function to run when user mousedowns the element
+ * @param {function} mouseupHandler Function to run when user mouseups the element
+ * @ignore
+ */
+function wrs_addElementEvents(target, doubleClickHandler, mousedownHandler, mouseupHandler) {
+    if (doubleClickHandler) {
+        wrs_addEvent(target, 'dblclick', function (event) {
+            var realEvent = (event) ? event : window.event;
+            var element = realEvent.srcElement ? realEvent.srcElement : realEvent.target;
+            doubleClickHandler(target, element, realEvent);
+        });
+    }
+
+    if (mousedownHandler) {
+        wrs_addEvent(target, 'mousedown', function (event) {
+            var realEvent = (event) ? event : window.event;
+            var element = realEvent.srcElement ? realEvent.srcElement : realEvent.target;
+            _wrs_temporalFocusElement = element;
+            mousedownHandler(target, element, realEvent);
+        });
+    }
+
+    if (mouseupHandler) {
+        wrs_addEvent(target, 'mouseup', function (event) {
+            var realEvent = (event) ? event : window.event;
+            var element = realEvent.srcElement ? realEvent.srcElement : realEvent.target;
+            mouseupHandler(target, element, realEvent);
+        });
+    }
+}
+
+/**
+ * Cross-browser addEventListener/attachEvent function.
+ * @param {object} element Element target
+ * @param {event} event Event
+ * @param {function} func Function to run
+ * @ignore
+ */
+function wrs_addEvent(element, event, func) {
+    if (element.addEventListener) {
+        element.addEventListener(event, func, true);
+    }
+    else if (element.attachEvent) {
+        element.attachEvent('on' + event, func);
+    }
+}
+
+/**
+ * Adds iframe events.
+ * @param {object} iframe Target
+ * @param {function} doubleClickHandler Function to run when user double clicks the iframe
+ * @param {function} mousedownHandler Function to run when user mousedowns the iframe
+ * @param {function} mouseupHandler Function to run when user mouseups the iframe
+ * @ignore
+ */
+function wrs_addIframeEvents(iframe, doubleClickHandler, mousedownHandler, mouseupHandler) {
+    wrs_initSetSize();
+    wrs_addElementEvents(iframe.contentWindow.document,
+        function (target, element, event) {
+            doubleClickHandler(iframe, element, event);
+        },
+        function (target, element, event) {
+            mousedownHandler(iframe, element, event);
+        },
+        function (target, element, event) {
+            mouseupHandler(iframe, element, event);
+        }
+    );
+}
+
+/**
+ * Adds textarea events.
+ * @param {object} textarea Target
+ * @param {function} clickHandler Function to run when user clicks the textarea.
+ * @ignore
+ */
+function wrs_addTextareaEvents(textarea, clickHandler) {
+    if (clickHandler) {
+        wrs_addEvent(textarea, 'click', function (event) {
+            var realEvent = (event) ? event : window.event;
+            clickHandler(textarea, realEvent);
+        });
+    }
+}
+
+/**
+ * Converts applet code to img object.
+ * @param {object} creator Object with "createElement" method
+ * @param {string} appletCode Applet code
+ * @param {string} image Base 64 image stream
+ * @param {int} imageWidth Image width
+ * @param {int} imageHeight Image height
+ * @return object img object.
+ * @ignore
+ */
+function wrs_appletCodeToImgObject(creator, appletCode, image, imageWidth, imageHeight) {
+    var imageSrc = wrs_createImageCASSrc(image);
+    var imgObject = creator.createElement('img');
+
+    imgObject.src = imageSrc;
+    imgObject.align = 'middle';
+    imgObject.width = imageWidth;
+    imgObject.height = imageHeight;
+    imgObject.setAttribute(_wrs_conf_CASMathmlAttribute, wrs_mathmlEncode(appletCode));
+    imgObject.className = _wrs_conf_CASClassName;
+
+    return imgObject;
+}
+
+/**
+ * Checks if a determined array contains a determined element.
+ * @param {array} stack
+ * @param {object} element
+ * @return bool
+ * @ignore
+ */
+function wrs_arrayContains(stack, element) {
+    for (var i = stack.length - 1; i >= 0; --i) {
+        if (stack[i] === element) {
+            return i;
+        }
+    }
+
+    return -1;
+}
+
+/**
+ * Adds a specific className to given element
+ * @param  {object} element
+ * @param  {string} className
+ * @ignore
+ */
+function wrs_addClass(element, className) {
+    if (!wrs_containsClass(element, className)) {
+        element.className += " " + className;
+    }
+}
+
+/**
+ * Checks if an element contains a class.
+ * @param {object} element
+ * @param {string} className
+ * @return bool
+ * @ignore
+ */
+function wrs_containsClass(element, className) {
+    if (element == null || !('className' in element)) {
+        return false;
+    }
+
+    var currentClasses = element.className.split(' ');
+
+    for (var i = currentClasses.length - 1; i >= 0; --i) {
+        if (currentClasses[i] == className) {
+            return true;
+        }
+    }
+
+    return false;
+}
+
+/**
+ * Remove a specific class
+ * @param {object} element
+ * @param {string} className
+ * @ignore
+ */
+function wrs_removeClass(element, className) {
+    var newClassName = '';
+    var classes = element.className.split(" ");
+
+    for (var i = 0; i < classes.length; i++) {
+        if(classes[i] != className) {
+            newClassName += classes[i] + " ";
+        }
+    }
+    element.className = newClassName.trim();
+}
+
+/**
+ * Converts old xmlinitialtext attribute (with ) to the correct one(with lt;gt;)
+ * @param {string} text String containtg safeXml characters
+ * @return {string} String with the safeXml charaters parsed.
+ * @ignore
+ */
+function wrs_convertOldXmlinitialtextAttribute(text){
+    // Used to fix a bug with Cas imported from Moodle 1.9 to Moodle 2.x.
+    // This could be removed in future.
+    var val = 'value=';
+
+    var xitpos = text.indexOf('xmlinitialtext');
+    var valpos = text.indexOf(val, xitpos);
+    var quote = text.charAt(valpos + val.length);
+    var startquote = valpos + val.length + 1;
+    var endquote = text.indexOf(quote, startquote);
+
+    var value = text.substring(startquote, endquote);
+
+    var newvalue = value.split('').join('lt;');
+    newvalue = newvalue.split('').join('gt;');
+    newvalue = newvalue.split('&').join('');
+    newvalue = newvalue.split('').join('quot;');
+
+    text = text.split(value).join(newvalue);
+    return text;
+}
+
+/**
+ * Cross-browser solution for creating new elements.
+ *
+ * It fixes some browser bugs.
+ *
+ * @param {string} elementName The tag name of the wished element.
+ * @param {object} attributes An object where each key is a wished attribute name and each value is its value.
+ * @param {object} creator Optional param. If supplied, this function will use the "createElement" method from this param. Else, "document" will be used.
+ * @return {object} The DOM element with the specified attributes assignated.
+ * @ignore
+ */
+function wrs_createElement(elementName, attributes, creator) {
+    if (attributes === undefined) {
+        attributes = {};
+    }
+
+    if (creator === undefined) {
+        creator = document;
+    }
+
+    var element;
+
+    /*
+     * Internet Explorer fix:
+     * If you create a new object dynamically, you can't set a non-standard attribute.
+     * For example, you can't set the "src" attribute on an "applet" object.
+     * Other browsers will throw an exception and will run the standard code.
+     */
+
+    try {
+        var html = '<' + elementName;
+
+        for (var attributeName in attributes) {
+            html += ' ' + attributeName + '="' + wrs_htmlentities(attributes[attributeName]) + '"';
+        }
+
+        html += '>';
+        element = creator.createElement(html);
+    }
+    catch (e) {
+        element = creator.createElement(elementName);
+
+        for (var attributeName in attributes) {
+            element.setAttribute(attributeName, attributes[attributeName]);
+        }
+    }
+
+    return element;
+}
+
+/**
+ * Cross-browser httpRequest creation.
+ * @return {object} httpRequest request object.
+ * @ignore
+ */
+function wrs_createHttpRequest() {
+    if (_wrs_currentPath.substr(0, 7) == 'file://') {
+        throw 'Cross site scripting is only allowed for HTTP.';
+    }
+
+    if (typeof XMLHttpRequest != 'undefined') {
+        return new XMLHttpRequest();
+    }
+
+    try {
+        return new ActiveXObject('Msxml2.XMLHTTP');
+    }
+    catch (e) {
+        try {
+            return new ActiveXObject('Microsoft.XMLHTTP');
+        }
+        catch (oc) {
+        }
+    }
+
+    return false;
+}
+
+/**
+ * Gets CAS image src with AJAX.
+ * @param {string} image Base 64 image stream
+ * @return {string} CAS image src.
+ * @ignore
+ */
+function wrs_createImageCASSrc(image, appletCode) {
+    var data = {
+        'image': image,
+        'mml': appletCode
+    };
+
+    return wrs_getContent(_wrs_conf_createcasimagePath, data);
+}
+
+/**
+ * Gets formula image src with AJAX.
+ * @param {mathml} Mathml code.
+ * @param {object} data wiris properties object.
+ * @return string Image src.
+ * @ignore
+ */
+function wrs_createImageSrc(mathml, data) {
+    // Full base64 method (edit & save).
+    if (_wrs_conf_saveMode == 'base64' && _wrs_conf_editMode == 'default') {
+        data['base64'] = true;
+    }
+
+    var result = wrs_getContent(_wrs_conf_createimagePath, data);
+
+    if (result.indexOf('@BASE@') != -1) {
+        // Replacing '@BASE@' with the base URL of createimage.
+        var baseParts = _wrs_conf_createimagePath.split('/');
+        baseParts.pop();
+        result = result.split('@BASE@').join(baseParts.join('/'));
+    }
+
+    return result;
+}
+
+function wrs_createShowImageSrc(mathml, data, language) {
+    var dataMd5 = []
+    var renderParams = 'mml,color,centerbaseline,zoom,dpi,fontSize,fontFamily,defaultStretchy,backgroundColor,format';
+    var renderParamsArray = renderParams.split(',');
+    for (var key in renderParamsArray) {
+        var param = renderParamsArray[key];
+        if (typeof data[param] != 'undefined') {
+            dataMd5[param] = data[param];
+        }
+    }
+    // Data variables to get.
+    var dataObject = {};
+    for (var key in data) {
+        // We don't need mathml in this request we try to get cached so we only need the formula md5 calculated before.
+        if (key != 'mml') {
+            dataObject[key] = data[key];
+        }
+    }
+    dataObject.formula = com.wiris.js.JsPluginTools.md5encode(wrs_propertiesToString(dataMd5));
+    dataObject.lang = (typeof language == 'undefined') ? 'en' : language;
+    dataObject.version = _wrs_conf_version;
+
+    var result = wrs_getContent(_wrs_conf_showimagePath + '?' + wrs_httpBuildQuery(dataObject));
+    return result;
+}
+
+/**
+ * Creates new object using its html code.
+ * @param {string} objectCode html code
+ * @return {object} html object.
+ * @ignore
+ */
+function wrs_createObject(objectCode, creator) {
+    if (creator === undefined) {
+        creator = document;
+    }
+
+    // Internet Explorer can't include "param" tag when is setting an innerHTML property.
+    objectCode = objectCode.split('<applet ').join('<span wirisObject="WirisApplet" ').split('<APPLET ').join('<span wirisObject="WirisApplet" ');  // It is a 'span' because 'span' objects can contain 'br' nodes.
+    objectCode = objectCode.split('</applet>').join('</span>').split('</APPLET>').join('</span>');
+
+    objectCode = objectCode.split('<param ').join('<br wirisObject="WirisParam" ').split('<PARAM ').join('<br wirisObject="WirisParam" ');          // It is a 'br' because 'br' can't contain nodes.
+    objectCode = objectCode.split('</param>').join('</br>').split('</PARAM>').join('</br>');
+
+    var container = wrs_createElement('div', {}, creator);
+    container.innerHTML = objectCode;
+
+    function recursiveParamsFix(object) {
+        if (object.getAttribute && object.getAttribute('wirisObject') == 'WirisParam') {
+            var attributesParsed = {};
+
+            for (var i = 0; i < object.attributes.length; ++i) {
+                if (object.attributes[i].nodeValue !== null) {
+                    attributesParsed[object.attributes[i].nodeName] = object.attributes[i].nodeValue;
+                }
+            }
+
+            var param = wrs_createElement('param', attributesParsed, creator);
+
+            // IE fix.
+            if (param.NAME) {
+                param.name = param.NAME;
+                param.value = param.VALUE;
+            }
+
+            param.removeAttribute('wirisObject');
+            object.parentNode.replaceChild(param, object);
+        }
+        else if (object.getAttribute && object.getAttribute('wirisObject') == 'WirisApplet') {
+            var attributesParsed = {};
+
+            for (var i = 0; i < object.attributes.length; ++i) {
+                if (object.attributes[i].nodeValue !== null) {
+                    attributesParsed[object.attributes[i].nodeName] = object.attributes[i].nodeValue;
+                }
+            }
+
+            var applet = wrs_createElement('applet', attributesParsed, creator);
+            applet.removeAttribute('wirisObject');
+
+            for (var i = 0; i < object.childNodes.length; ++i) {
+                recursiveParamsFix(object.childNodes[i]);
+
+                if (object.childNodes[i].nodeName.toLowerCase() == 'param') {
+                    applet.appendChild(object.childNodes[i]);
+                    --i;    // When we insert the object child into the applet, object loses one child.
+                }
+            }
+
+            object.parentNode.replaceChild(applet, object);
+        }
+        else {
+            for (var i = 0; i < object.childNodes.length; ++i) {
+                recursiveParamsFix(object.childNodes[i]);
+            }
+        }
+    }
+
+    recursiveParamsFix(container);
+    return container.firstChild;
+}
+
+/**
+ * Converts an object to its HTML code.
+ * @param {object} object DOM object..
+ * @return {string} HTML code.
+ * @ignore
+ */
+function wrs_createObjectCode(object) {
+
+    // In case that the image was not created, the object can be null or undefined.
+    if (typeof object == 'undefined' || object == null) {
+        return;
+    }
+
+    if (object.nodeType == 1) { // ELEMENT_NODE.
+        var output = '<' + object.tagName;
+
+        for (var i = 0; i < object.attributes.length; ++i) {
+            if (object.attributes[i].specified) {
+                output += ' ' + object.attributes[i].name + '="' + wrs_htmlentities(object.attributes[i].value) + '"';
+            }
+        }
+
+        if (object.childNodes.length > 0) {
+            output += '>';
+
+            for (var i = 0; i < object.childNodes.length; ++i) {
+                output += wrs_createObjectCode(object.childNodes[i]);
+            }
+
+            output += '</' + object.tagName + '>';
+        }
+        else if (object.nodeName == 'DIV' || object.nodeName == 'SCRIPT') {
+            output += '></' + object.tagName + '>';
+        }
+        else {
+            output += '/>';
+        }
+
+        return output;
+    }
+
+    if (object.nodeType == 3) { // TEXT_NODE.
+        return wrs_htmlentities(object.nodeValue);
+    }
+
+    return '';
+}
+
+/**
+ * Parses end HTML code. The end HTML code is HTML code with embedded images or LaTeX formulas created with the WIRIS editor. <br>
+ * By default this method converts the formula images and LaTeX strings in MathML. <br>
+ * If image mode is enabled the images will not be converted into MathML. For further information see {@link http://www.wiris.com/plugins/docs/full-mathml-mode}.
+ * @param {string} code String to be parsed.
+ * @param {object} wirisProperties Extra attributes for the formula.
+ * @param {string} language Language for the formula.
+ * @return {string}
+ */
+function wrs_endParse(code, wirisProperties, language) {
+    code = wrs_endParseEditMode(code, wirisProperties, language);
+    return wrs_endParseSaveMode(code);
+}
+
+function wrs_regexpIndexOf(input, regexp, start) {
+    var index = input.substring(start || 0).search(regexp);
+    return (index >= 0) ? (index + (start || 0)) : index;
+}
+
+/**
+ * Parses end HTML code depending on the edit mode.
+ * @param {string} code HTML code to be parsed.
+ * @param {object} wirisProperties Extra formula attributes.
+ * @param {string} language Language for the formula.
+ * @return {string}
+ * @ignore
+ */
+function wrs_endParseEditMode(code, wirisProperties, language) {
+    // Converting LaTeX to images.
+
+    if (window._wrs_conf_parseModes !== undefined && wrs_arrayContains(_wrs_conf_parseModes, 'latex') != -1) {
+        var output = '';
+        var endPosition = 0;
+        var startPosition = code.indexOf('$$');
+
+        while (startPosition != -1) {
+            output += code.substring(endPosition, startPosition);
+            endPosition = code.indexOf('$$', startPosition + 2);
+
+            if (endPosition != -1) {
+                var latex = code.substring(startPosition + 2, endPosition);
+
+                if (latex.indexOf('<') == -1) {
+                    latex = wrs_htmlentitiesDecode(latex);
+                    var mathml = wrs_getMathMLFromLatex(latex, true);
+                    output += mathml;
+                    endPosition += 2;
+                }
+                else {
+                    output += '$$';
+                    endPosition = startPosition + 2;
+                }
+            }
+            else {
+                output += '$$';
+                endPosition = startPosition + 2;
+            }
+
+            startPosition = code.indexOf('$$', endPosition);
+        }
+
+        output += code.substring(endPosition, code.length);
+        code = output;
+    }
+
+    if (window._wrs_conf_defaultEditMode && _wrs_conf_defaultEditMode == 'iframes') {
+        // Converting iframes to images.
+        var output = '';
+        var pattern = ' class="' + _wrs_conf_imageClassName + '"';
+        var formulaPosition = code.indexOf(pattern);
+        var endPosition = 0;
+
+        while (formulaPosition != -1) {
+            // Looking for the actual startPosition.
+            startPosition = formulaPosition;
+            var i = formulaPosition;
+            var startTagFound = false;
+
+            while (i >= 0 && !startTagFound) {      // Going backwards until the start tag '<' is found.
+                var character = code.charAt(i);
+
+                if (character == '"' || character == '\'') {
+                    var characterNextPosition = code.lastIndexOf(character, i);
+                    i = (characterNextPosition == -1) ? -1 : characterNextPosition;
+                }
+                else if (character == '<') {
+                    startPosition = i;
+                    startTagFound = true;
+                }
+                else if (character == '>') {
+                    i = -1;                 // Break: we are inside a text node.
+                }
+
+                --i;
+            }
+
+            // Appending the previous code.
+            output += code.substring(endPosition, startPosition);
+
+            // Looking for the endPosition.
+
+            if (startTagFound) {
+                i = formulaPosition;
+                var counter = 1;
+
+                while (i < code.length && counter > 0) {
+                    var character = code.charAt(i);
+
+                    if (character == '"' || character == '\'') {
+                        var characterNextPosition = code.indexOf(character, i);
+                        i = (characterNextPosition == -1) ? code.length : characterNextPosition;
+                    }
+                    else if (character == '<') {
+                        if (i + 1 < code.length && code.charAt(i + 1) == '/') {
+                            --counter;
+
+                            if (counter == 0) {
+                                endPosition = code.indexOf('>', i) + 1;
+
+                                if (endPosition == -1) {
+                                    // End tag stripped.
+                                    counter = -1;       // to be != 0 and to break the loop.
+                                }
+                            }
+                        }
+                        else {
+                            ++counter;
+                        }
+                    }
+                    else if (character == '>' && code.charAt(i - 1) == '/') {
+                        --counter;
+
+                        if (counter == 0) {
+                            endPosition = i + 1;
+                        }
+                    }
+
+                    ++i;
+                }
+
+                if (counter == 0) {
+                    var formulaTagCode = code.substring(startPosition, endPosition);
+                    var formulaTagObject = wrs_createObject(formulaTagCode);
+                    var mathml = formulaTagObject.getAttribute(_wrs_conf_imageMathmlAttribute);
+
+                    if (mathml == null) {
+                        mathml = formulaTagObject.getAttribute('alt');
+                    }
+
+                    var imgObject = wrs_mathmlToImgObject(document, mathml, wirisProperties, language);
+                    output += wrs_createObjectCode(imgObject);
+                }
+                else {
+                    // Start tag found but no end tag found. No process is done. A character is appended to avoid infinite loop in the next search.
+                    output += code.charAt(formulaPosition);
+                    endPosition = formulaPosition + 1;
+                }
+            }
+            else {
+                // No start tag is found. No process is done. A character is appended to avoid infinite loop in the next search.
+                output += code.charAt(formulaPosition);
+                endPosition = formulaPosition + 1;
+            }
+
+            formulaPosition = code.indexOf(pattern, endPosition);
+        }
+
+        output += code.substring(endPosition, code.length);
+        code = output;
+    }
+
+    return code;
+}
+
+/**
+ * Parses end HTML code depending on the save mode.
+ * @param {string} code HTML code
+ * @return {string}
+ * @ignore
+ */
+function wrs_endParseSaveMode(code) {
+    var output = '';
+    var convertToXml = false;
+    var convertToSafeXml = false;
+
+    if (window._wrs_conf_saveMode) {
+        if (_wrs_conf_saveMode == 'safeXml') {
+            convertToXml = true;
+            convertToSafeXml = true;
+        }
+        else if (_wrs_conf_saveMode == 'xml') {
+            convertToXml = true;
+        }
+    }
+
+    if (_wrs_conf_saveMode == 'base64' && _wrs_conf_editMode == 'image') {
+        code = wrs_codeImgTransform(code, 'img264');
+    } else if (convertToXml || convertToSafeXml) {
+        code = wrs_codeImgTransform(code, 'img2mathml');
+    }
+
+    return code;
+}
+
+/**
+ * Gets the formula mathml or CAS appletCode using its image hash code.
+ * @param {string} variableName Variable to send on POST query to the server.
+ * @param {string} imageHashCode image hash code.
+ * @return {string} Corresponding mathml code.
+ * @ignore
+ */
+function wrs_getCode(variableName, imageHashCode) {
+    var data = {};
+    data[variableName] = imageHashCode;
+    return wrs_getContent(_wrs_conf_getmathmlPath, data);
+}
+
+/**
+ * Gets the content from an URL.
+ * @param {string} url target URL.
+ * @param {object} postVariables post variables. Null if a GET query should be done.
+ * @return {string} content of the target URL.
+ * @ignore
+ */
+function wrs_getContent(url, postVariables) {
+    try {
+        var httpRequest = wrs_createHttpRequest();
+
+        if (httpRequest) {
+            if (typeof postVariables === undefined || typeof postVariables == 'undefined') {
+                httpRequest.open('GET', url, false);
+            }
+            else if (url.substr(0, 1) == '/' || url.substr(0, 7) == 'http://' || url.substr(0, 8) == 'https://') {
+                httpRequest.open('POST', url, false);
+            }
+            else {
+                httpRequest.open('POST', _wrs_currentPath + url, false);
+            }
+
+            if (postVariables !== undefined) {
+                httpRequest.setRequestHeader('Content-type', 'application/x-www-form-urlencoded; charset=UTF-8');
+                httpRequest.send(wrs_httpBuildQuery(postVariables));
+            }
+            else {
+                httpRequest.send(null);
+            }
+
+            return httpRequest.responseText;
+        }
+
+        alert('Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.');
+    }
+    catch (e) {
+    }
+
+    return '';
+}
+
+/**
+ * Generates the innerHTML of an element.
+ * @param {object} element target element.
+ * @return {string} innertHTML of the target element.
+ * @ignore
+ */
+function wrs_getInnerHTML(element) {
+    var innerHTML = '';
+
+    for (var i = 0; i < element.childNodes.length; ++i) {
+        innerHTML += wrs_createObjectCode(element.childNodes[i]);
+    }
+
+    return innerHTML;
+}
+
+/**
+ * Converts MathML to LaTeX.
+ * @param {string} mathml MathML String
+ * @return {string} MathML corresponding LaTeX.
+ * @ignore
+ */
+function wrs_getLatexFromMathML(mathml) {
+    var data = {
+        'service': 'mathml2latex',
+        'mml': mathml
+    };
+
+    var jsonResponse = JSON.parse(wrs_getContent(_wrs_conf_servicePath, data));
+
+    var latex;
+
+    if (jsonResponse.status == "ok") {
+        latex = jsonResponse.result.text;
+    }
+
+    return latex;
+}
+
+/**
+ * Extracts the latex of a determined position in a text.
+ * @param {string} textNode test to extract LaTeX
+ * @param {int} caretPosition starting position to find LaTeX.
+ * @return {object} An object with 3 keys: 'latex', 'start' and 'end'. Null if latex is not found.
+ * @ignore
+ */
+function wrs_getLatexFromTextNode(textNode, caretPosition) {
+    // Looking for the first textNode.
+    var startNode = textNode;
+
+    while (startNode.previousSibling && startNode.previousSibling.nodeType == 3) { // TEXT_NODE.
+        startNode = startNode.previousSibling;
+    }
+
+    // Finding latex.
+
+    function getNextLatexPosition(currentNode, currentPosition) {
+        var position = currentNode.nodeValue.indexOf('$$', currentPosition);
+
+        while (position == -1) {
+            currentNode = currentNode.nextSibling;
+
+            if (!currentNode || currentNode.nodeType != 3) { // TEXT_NODE.
+                return null; // Not found.
+            }
+
+            position = currentNode.nodeValue.indexOf('$$');
+        }
+
+        return {
+            'node': currentNode,
+            'position': position
+        };
+    }
+
+    function isPrevious(node, position, endNode, endPosition) {
+        if (node == endNode) {
+            return (position <= endPosition);
+        }
+
+        while (node && node != endNode) {
+            node = node.nextSibling;
+        }
+
+        return (node == endNode);
+    }
+
+    var start;
+
+    var end = {
+        'node': startNode,
+        'position': 0
+    };
+
+    do {
+        var start = getNextLatexPosition(end.node, end.position);
+
+        if (start == null || isPrevious(textNode, caretPosition, start.node, start.position)) {
+            return null;
+        }
+
+        var end = getNextLatexPosition(start.node, start.position + 2);
+
+        if (end == null) {
+            return null;
+        }
+
+        end.position += 2;
+    } while (isPrevious(end.node, end.position, textNode, caretPosition));
+
+    // Isolating latex.
+    var latex;
+
+    if (start.node == end.node) {
+        latex = start.node.nodeValue.substring(start.position + 2, end.position - 2);
+    }
+    else {
+        latex = start.node.nodeValue.substring(start.position + 2, start.node.nodeValue.length);
+        var currentNode = start.node;
+
+        do {
+            currentNode = currentNode.nextSibling;
+
+            if (currentNode == end.node) {
+                latex += end.node.nodeValue.substring(0, end.position - 2);
+            }
+            else {
+                latex += currentNode.nodeValue;
+            }
+        } while (currentNode != end.node);
+    }
+
+    return {
+        'latex': latex,
+        'startNode': start.node,
+        'startPosition': start.position,
+        'endNode': end.node,
+        'endPosition': end.position
+    };
+}
+
+/**
+ * Converts LaTeX to MathML.
+ * @param {string} latex String
+ * @param {bool} includeLatexOnSemantics If true LaTeX would me included into MathML semantics.
+ * @return {string} converted mathML
+ * @ignore
+ */
+function wrs_getMathMLFromLatex(latex, includeLatexOnSemantics) {
+    if (_wrs_int_LatexCache.hasOwnProperty(latex)) {
+        return _wrs_int_LatexCache[latex];
+    }
+    var data = {
+        'service': 'latex2mathml',
+        'latex': latex
+    };
+
+    if (includeLatexOnSemantics) {
+        data['saveLatex'] = '';
+    }
+
+    var jsonResponse = JSON.parse(wrs_getContent(_wrs_conf_servicePath, data));
+
+    var output;
+    if (jsonResponse.status == "ok") {
+        var output = jsonResponse.result.text;
+        output = output.split("\r").join('').split("\n").join(' ');
+        // Populate LatexCache.
+        wrs_populateLatexCache(latex, output);
+    } else {
+        output = "$$" + latex + "$$";
+    }
+
+    return output;
+}
+
+/**
+ * Gets the node length in characters.
+ * @param {object} node HTML node.
+ * @return {int} node length
+ * @ignore
+ */
+function wrs_getNodeLength(node) {
+    if (node.nodeType == 3) { // TEXT_NODE.
+        return node.nodeValue.length;
+    }
+
+    if (node.nodeType == 1) { // ELEMENT_NODE.
+        var length = _wrs_staticNodeLengths[node.nodeName.toUpperCase()];
+
+        if (length === undefined) {
+            length = 0;
+        }
+
+        for (var i = 0; i < node.childNodes.length; ++i) {
+            length += wrs_getNodeLength(node.childNodes[i]);
+        }
+
+        return length;
+    }
+
+    return 0;
+}
+
+/**
+ * Parses the query string and returns it as a Hash table.
+ * @param {object} windowObject a window object with a query string.
+ * @return {object} a hash table containing the query string.
+ * @ignore
+ */
+function wrs_getQueryParams(windowObject) {
+    var data = {};
+    var start = windowObject.location.search.indexOf('?');
+    start = (start == -1) ? 0 : start + 1;
+    var queryStringParts = windowObject.location.search.substr(start).split('&');
+
+    for (var i = 0; i < queryStringParts.length; ++i) {
+        var paramParts = queryStringParts[i].split('=', 2);
+        data[paramParts[0]] = wrs_urldecode(paramParts[1]);
+    }
+
+    return data;
+}
+
+/**
+ * Gets the selected node or text.
+ * If the caret is on a text node, concatenates it with all the previous and next text nodes.
+ * @param {object} target The editable element
+ * @param {boolean} isIframe Specifies if the target is an iframe or not
+ * @param {forceGetSelection} If true, ignores IE system to get the current selection and uses window.getSelection()
+ * @return {object} An object with the 'node' key setted if the item is an element or the keys 'node' and 'caretPosition' if the element is text
+ * @ignore
+ */
+function wrs_getSelectedItem(target, isIframe, forceGetSelection) {
+    var windowTarget;
+
+    if (isIframe) {
+        windowTarget = target.contentWindow;
+        windowTarget.focus();
+    }
+    else {
+        windowTarget = window;
+        target.focus();
+    }
+
+    if (document.selection && !forceGetSelection) {
+        var range = windowTarget.document.selection.createRange();
+
+        if (range.parentElement) {
+            if (range.htmlText.length > 0) {
+                if (range.text.length == 0) {
+                    return wrs_getSelectedItem(target, isIframe, true);
+                }
+
+                return null;
+            }
+
+            windowTarget.document.execCommand('InsertImage', false, '#');
+            var temporalObject = range.parentElement();
+
+            if (temporalObject.nodeName.toUpperCase() != 'IMG') {
+                // IE9 fix: parentElement() does not return the IMG node, returns the parent DIV node. In IE < 9, pasteHTML does not work well.
+                range.pasteHTML('<span id="wrs_openEditorWindow_temporalObject"></span>');
+                temporalObject = windowTarget.document.getElementById('wrs_openEditorWindow_temporalObject');
+            }
+
+            var node;
+            var caretPosition;
+
+            if (temporalObject.nextSibling && temporalObject.nextSibling.nodeType == 3) { // TEXT_NODE.
+                node = temporalObject.nextSibling;
+                caretPosition = 0;
+            }
+            else if (temporalObject.previousSibling && temporalObject.previousSibling.nodeType == 3) { // TEXT_NODE.
+                node = temporalObject.previousSibling;
+                caretPosition = node.nodeValue.length;
+            }
+            else {
+                node = windowTarget.document.createTextNode('');
+                temporalObject.parentNode.insertBefore(node, temporalObject);
+                caretPosition = 0;
+            }
+
+            temporalObject.parentNode.removeChild(temporalObject);
+
+            return {
+                'node': node,
+                'caretPosition': caretPosition
+            };
+        }
+
+        if (range.length > 1) {
+            return null;
+        }
+
+        return {
+            'node': range.item(0)
+        };
+    }
+
+    if (windowTarget.getSelection) {
+        var selection = windowTarget.getSelection();
+
+        try {
+            var range = selection.getRangeAt(0);
+        }
+        catch (e) {
+            var range = windowTarget.document.createRange();
+        }
+
+        var node = range.startContainer;
+
+        if (node.nodeType == 3) { // TEXT_NODE.
+            if (range.startOffset != range.endOffset) {
+                return null;
+            }
+
+            return {
+                'node': node,
+                'caretPosition': range.startOffset
+            };
+        }
+
+        if (node != range.endContainer) {
+            return null;
+        }
+
+        if (node.nodeType == 1) { // ELEMENT_NODE.
+            var position = range.startOffset;
+
+            if (node.childNodes[position]) {
+                return {
+                    'node': node.childNodes[position]
+                };
+            }
+        }
+    }
+
+    return null;
+}
+
+/**
+ * Converts the HTML of a image into the output code that WIRIS must return.
+ * By default returns the mathml stored on data-mahml attribute (if imgCode is a formula)
+ * or the Wiriscas attribute of a WIRIS applet.
+ * @param {string} imgCode the html code from a formula or a CAS image.
+ * @param {bool} convertToXml True if the image should be converted to xml.
+ * @param {bool} convertToSafeXml True if the image should be conerte to safeXmll
+ * @return {string} the Xml or safeXml of a WIRIS image.
+ * @ignore
+ */
+function wrs_getWIRISImageOutput(imgCode, convertToXml, convertToSafeXml) {
+    var imgObject = wrs_createObject(imgCode);
+
+    if (imgObject) {
+        if (imgObject.className == _wrs_conf_imageClassName || imgObject.getAttribute(_wrs_conf_imageMathmlAttribute)) {
+            if (!convertToXml) {
+                return imgCode;
+            }
+
+            var xmlCode = imgObject.getAttribute(_wrs_conf_imageMathmlAttribute);
+
+            if (xmlCode == null) {
+                xmlCode = imgObject.getAttribute('alt');
+            }
+
+            if (!convertToSafeXml) {
+                xmlCode = wrs_mathmlDecode(xmlCode);
+            }
+
+            return xmlCode;
+        }
+        else if (imgObject.className == _wrs_conf_CASClassName) {
+            var appletCode = imgObject.getAttribute(_wrs_conf_CASMathmlAttribute);
+            appletCode = wrs_mathmlDecode(appletCode);
+            var appletObject = wrs_createObject(appletCode);
+            appletObject.setAttribute('src', imgObject.src);
+            var object = appletObject;
+            var appletCodeToBeInserted = wrs_createObjectCode(appletObject);
+
+            if (convertToSafeXml) {
+                appletCodeToBeInserted = wrs_mathmlEncode(appletCodeToBeInserted);
+            }
+
+            return appletCodeToBeInserted;
+        }
+    }
+
+    return imgCode;
+}
+
+/**
+ * Parses a text and replaces all HTML special characters by their entities.
+ * @param {string} input Text to be paresed.
+ * @return {string} the input text with all their special characters replaced by their entities.
+ * @ignore
+ */
+function wrs_htmlentities(input) {
+    return input.split('&').join('&amp;').split('<').join('&lt;').split('>').join('&gt;').split('"').join('&quot;');
+}
+
+/**
+ * Parses a text and replaces all the HTML entities by their characters.
+ * @param {string} input Text to be parsed
+ * @return {string} The input text with all their entities replaced by characters.
+ * @ignore
+ */
+function wrs_htmlentitiesDecode(input) {
+    return input.split('&quot;').join('"').split('&gt;').join('>').split('&lt;').join('<').split('&amp;').join('&');
+}
+
+/**
+ * Converts a hash to a HTTP query.
+ * @param {hash} properties A key-value Hash
+ * @return {string} A HTTP query containing all the key value pairs with all the shpecial characters replaced by their entities.
+ * @ignore
+ */
+function wrs_httpBuildQuery(properties) {
+    var result = '';
+
+    for (i in properties) {
+        if (properties[i] != null) {
+            result += wrs_urlencode(i) + '=' + wrs_urlencode(properties[i]) + '&';
+        }
+    }
+
+    // Deleting last '&' empty character.
+    if (result.substring(result.length - 1) == '&') {
+        result = result.substring(0, result.length - 1);
+    }
+
+    return result;
+}
+
+/**
+ * Parses initial HTML code. If the HTML contains data generated by WIRIS, this data would be converted as following:
+ * <pre>
+ * MathML code: Image containing the corresponding MathML formulas.
+ * MathML code with LaTeX annotation : LaTeX.
+ * </pre>
+ * @param {string} code HTML code with data generated by WIRIS plugin.
+ * @param {string} language Language for the formula.
+ * @return {string} HTML code with the WIRIS data converted into LaTeX and images.
+ */
+ /* Note: The code inside this function has been inverted.
+    If you invert again the code then you cannot use correctly LaTeX
+    in Moodle.
+ */
+function wrs_initParse(code, language) {
+    wrs_initSetSize();
+    if (window._wrs_conf_saveMode) {
+        _wrs_parseXml = _wrs_conf_saveMode == 'safeXml'|| _wrs_conf_saveMode == 'xml';
+        if (window._wrs_conf_parseModes !== undefined) {
+            _wrs_parseXml = _wrs_parseXml || wrs_arrayContains(_wrs_conf_parseModes, 'xml') != -1;
+        }
+    }
+    code = wrs_initParseSaveMode(code, language);
+    return wrs_initParseEditMode(code);
+}
+
+/**
+ * Parses initial HTML code into iframes.
+ * @param  {object} windowTarget Target object window.
+ * @ignore
+ */
+function wrs_initParseImgToIframes(windowTarget) {
+    if (window._wrs_conf_defaultEditMode && _wrs_conf_defaultEditMode == 'iframes') {
+        var imgList = windowTarget.document.getElementsByTagName('img');
+        var i = 0;
+
+        while (i < imgList.length) {
+            if (imgList[i].className == _wrs_conf_imageClassName) {
+                var mathml = imgList[i].getAttribute(_wrs_conf_imageMathmlAttribute);
+
+                if (mathml == null) {
+                    mathml = imgList[i].getAttribute('alt');
+                }
+
+                var iframe = wrs_mathmlToIframeObject(windowTarget, wrs_mathmlDecode(mathml));
+                imgList[i].parentNode.replaceChild(iframe, imgList[i]);
+            }
+            else {
+                ++i;
+            }
+        }
+    }
+}
+
+/**
+ * Parses initial HTML code depending on the edit mode.
+ * @param {string} code HTML code.
+ * @return {string} parsed HTML code.
+ * @ignore
+ */
+function wrs_initParseEditMode(code) {
+    if (window._wrs_conf_parseModes !== undefined && wrs_arrayContains(_wrs_conf_parseModes, 'latex') != -1) {
+        var imgList = wrs_getElementsByNameFromString(code, 'img', true);
+        var token = 'encoding="LaTeX">';
+        var carry = 0;          // While replacing images with latex, the indexes of the found images changes respecting the original code, so this carry is needed.
+
+        for (var i = 0; i < imgList.length; ++i) {
+            var imgCode = code.substring(imgList[i].start + carry, imgList[i].end + carry);
+
+            if (imgCode.indexOf(' class="' + _wrs_conf_imageClassName + '"') != -1) {
+                var mathmlStartToken = ' ' + _wrs_conf_imageMathmlAttribute + '="';
+                var mathmlStart = imgCode.indexOf(mathmlStartToken);
+
+                if (mathmlStart == -1) {
+                    mathmlStartToken = ' alt="';
+                    mathmlStart = imgCode.indexOf(mathmlStartToken);
+                }
+
+                if (mathmlStart != -1) {
+                    mathmlStart += mathmlStartToken.length;
+                    var mathmlEnd = imgCode.indexOf('"', mathmlStart);
+                    var mathml = wrs_mathmlDecode(imgCode.substring(mathmlStart, mathmlEnd));
+                    var latexStartPosition = mathml.indexOf(token);
+
+                    if (latexStartPosition != -1) {
+                        latexStartPosition += token.length;
+                        var latexEndPosition = mathml.indexOf('</annotation>', latexStartPosition);
+                        var latex = mathml.substring(latexStartPosition, latexEndPosition);
+
+                        var replaceText = '$$' + wrs_htmlentitiesDecode(latex) + '$$';
+                        code = code.substring(0, imgList[i].start + carry) + replaceText + code.substring(imgList[i].end + carry);
+                        carry += replaceText.length - (imgList[i].end - imgList[i].start);
+                    }
+                }
+            }
+        }
+    }
+
+    return code;
+}
+
+/**
+ * Parses initial HTML code depending on the save mode.
+ * @param {string} code HTML code to be parsed
+ * @param {string} language Language for the formula.
+ * @return {string} HTML code parsed.
+ * @ignore
+ */
+function wrs_initParseSaveMode(code, language) {
+    if (window._wrs_conf_saveMode) {
+
+        if (_wrs_parseXml) {
+            // Converting XML to tags.
+            code = wrs_parseMathmlToLatex(code, _wrs_safeXmlCharacters);
+            code = wrs_parseMathmlToLatex(code, _wrs_xmlCharacters);
+            // Safe XML and XML must be parsed regardeless of save mode.
+            // Order is important here, safeXml must be parsed first in order to avoid conflicts with data-mathml img attribute.
+            code = wrs_parseSafeAppletsToObjects(code);
+            code = wrs_parseMathmlToImg(code, _wrs_safeXmlCharacters, language);
+            code = wrs_parseMathmlToImg(code, _wrs_xmlCharacters, language);
+        }
+
+        if (_wrs_conf_saveMode == 'base64' && _wrs_conf_editMode == 'image') {
+            code = wrs_codeImgTransform(code, 'base642showimage');
+        }
+    }
+
+    var appletList = wrs_getElementsByNameFromString(code, 'applet', false);
+    var carry = 0;          // While replacing applets with images, the indexes of the found applets changes respecting the original code, so this carry is needed.
+
+    for (var i = 0; i < appletList.length; ++i) {
+        var appletCode = code.substring(appletList[i].start + carry, appletList[i].end + carry);
+
+        // The second control in the if is used to find WIRIS applet which don't have Wiriscas class (as it was in old CAS applets).
+        if (appletCode.indexOf(' class="' + _wrs_conf_CASClassName + '"') != -1 || appletCode.toUpperCase().indexOf('WIRIS') != -1) {
+            if (appletCode.indexOf(' src="') != -1){
+                var srcStart = appletCode.indexOf(' src="') + ' src="'.length;
+                var srcEnd = appletCode.indexOf('"', srcStart);
+                var src = appletCode.substring(srcStart, srcEnd);
+            } else{
+                // This should happen only with old CAS imported from Moodle 1 to Moodle 2.
+                if (typeof(_wrs_conf_pluginBasePath) != 'undefined'){
+                    var src = _wrs_conf_pluginBasePath + '/integration/showcasimage.php?formula=noimage';
+                } else {
+                    var src = '';
+                }
+                if (appletCode.indexOf(' class="' + _wrs_conf_CASClassName + '"') == -1){
+                    var closeSymbol = appletCode.indexOf('>');
+                    var appletTag = appletCode.substring(0, closeSymbol);
+                    var newAppletTag = appletTag.split(' width=').join(' class="Wiriscas" width=');
+                    appletCode = appletCode.split(appletTag).join(newAppletTag);
+                    appletCode = appletCode.split('\'').join('"');
+                }
+            }
+
+            // Double click to edit has been removed here.
+            var imgCode = '<img align="middle" class="' + _wrs_conf_CASClassName + '" ' + _wrs_conf_CASMathmlAttribute + '="' + wrs_mathmlEncode(appletCode) + '" src="' + src + '" />';
+
+            code = code.substring(0, appletList[i].start + carry) + imgCode + code.substring(appletList[i].end + carry);
+            carry += imgCode.length - (appletList[i].end - appletList[i].start);
+        }
+    }
+
+    return code;
+}
+
+/**
+ * Looks for elements that match the given name in a HTML code string.
+ * Important: this function is very concrete for WIRIS code. It takes as preconditions lots of behaviors that are not the general case.
+ *
+ * @param {string} code HTML code
+ * @param {string} name Element names
+ * @param {boolean} autoClosed True if the elements are autoClosed.
+ * @return {array} An array containing all HTML elements of code matching the name argument.
+ * @ignore
+ */
+function wrs_getElementsByNameFromString(code, name, autoClosed) {
+    var elements = [];
+    var code = code.toLowerCase();
+    name = name.toLowerCase();
+    var start = code.indexOf('<' + name + ' ');
+
+    while (start != -1) {                       // Look for nodes.
+        var endString;
+
+        if (autoClosed) {
+            endString = '>';
+        }
+        else {
+            endString = '</' + name + '>';
+        }
+
+        var end = code.indexOf(endString, start);
+
+        if (end != -1) {
+            end += endString.length;
+
+            elements.push({
+                'start': start,
+                'end': end
+            });
+        }
+        else {
+            end = start + 1;
+        }
+
+        start = code.indexOf('<' + name + ' ', end);
+    }
+
+    return elements;
+}
+
+/**
+ * Replaces a selection with an element.
+ * @param {object} element Element
+ * @param {object} focusElement Element to be focused
+ * @param {object} windowTarget Target
+ * @ignore
+ */
+function wrs_insertElementOnSelection(element, focusElement, windowTarget) {
+    try {
+        // Integration function
+        // If wrs_int_insertElementOnSelection function exists on
+        // integration script can call focus method from the editor instance.
+        // For example, on CKEditor calls CKEditorInstance.focus() method.
+        // With this method we can call proper focus methods which in some scenarios
+        // help's WIRIS plugin to focus properly on the current editor window.
+        if (typeof wrs_int_insertElementOnSelection != 'undefined') {
+            wrs_int_insertElementOnSelection();
+        }
+        else {
+            focusElement.focus();
+        }
+
+        if (_wrs_isNewElement) {
+            if (document.selection && document.getSelection == 0) {
+                var range = windowTarget.document.selection.createRange();
+                windowTarget.document.execCommand('InsertImage', false, element.src);
+
+                if (!('parentElement' in range)) {
+                    windowTarget.document.execCommand('delete', false);
+                    range = windowTarget.document.selection.createRange();
+                    windowTarget.document.execCommand('InsertImage', false, element.src);
+                }
+
+                if ('parentElement' in range) {
+                    var temporalObject = range.parentElement();
+
+                    if (temporalObject.nodeName.toUpperCase() == 'IMG') {
+                        temporalObject.parentNode.replaceChild(element, temporalObject);
+                    }
+                    else {
+                        // IE9 fix: parentNode() does not return the IMG node, returns the parent DIV node. In IE < 9, pasteHTML does not work well.
+                        range.pasteHTML(wrs_createObjectCode(element));
+                    }
+                }
+            }
+            else {
+                var ua = navigator.userAgent.toLowerCase();
+                var isAndroid = ua.indexOf("android") > -1;
+                var isIOS = ((ua.indexOf("ipad") > -1) || (ua.indexOf("iphone") > -1));
+                var selection = windowTarget.getSelection();
+                if (_wrs_range) {
+                    var range = _wrs_range;
+                    _wrs_range = null;
+                }
+                else {
+
+                    try {
+                        var range = selection.getRangeAt(0);
+                    }
+                    catch (e) {
+                        var range = windowTarget.document.createRange();
+                    }
+                }
+                selection.removeAllRanges();
+
+                range.deleteContents();
+
+                var node = range.startContainer;
+                var position = range.startOffset;
+
+                if (node.nodeType == 3) { // TEXT_NODE.
+                    node = node.splitText(position);
+                    node.parentNode.insertBefore(element, node);
+                    node = node.parentNode;
+                }
+                else if (node.nodeType == 1) { // ELEMENT_NODE.
+                    node.insertBefore(element, node.childNodes[position]);
+                }
+
+                if (!isAndroid && !isIOS){
+                    // Fix to set the caret after the inserted image.
+                    range.selectNode(element);
+                    position = range.endOffset;
+                    selection.collapse(node, position);
+                }
+            }
+        }
+        else if (_wrs_temporalRange) {
+            if (document.selection && document.getSelection == 0) {
+                _wrs_isNewElement = true;
+                _wrs_temporalRange.select();
+                wrs_insertElementOnSelection(element, focusElement, windowTarget);
+            }
+            else {
+                var parentNode = _wrs_temporalRange.startContainer;
+                _wrs_temporalRange.deleteContents();
+                _wrs_temporalRange.insertNode(element);
+            }
+        }
+        else {
+            if (!element) { // Editor empty, formula has been erased on edit.
+                _wrs_temporalImage.parentNode.removeChild(_wrs_temporalImage);
+            }
+            _wrs_temporalImage.parentNode.replaceChild(element, _wrs_temporalImage);
+        }
+    }
+    catch (e) {
+    }
+}
+
+/**
+ * Checks if the mathml at position i is inside an HTML attribute or not.
+ * @param {string} content A string containing MathML code.
+ * @param {string} i Search index.
+ * @return {bool} True if is inside an HTML attribute. In other case, false.
+ * @ignore
+ */
+function wrs_isMathmlInAttribute(content, i) {
+    // Regex = '^[\'"][\\s]*=[\\s]*[\\w-]+([\\s]*("[^"]*"|\'[^\']*\')[\\s]*=[\\s]*[\\w-]+[\\s]*)*[\\s]+gmi<';
+    var math_att = '[\'"][\\s]*=[\\s]*[\\w-]+';                         // "=att OR '=att
+    var att_content = '"[^"]*"|\'[^\']*\'';                             // "blabla" OR 'blabla'
+    var att = '[\\s]*(' + att_content + ')[\\s]*=[\\s]*[\\w-]+[\\s]*';  // "blabla"=att OR 'blabla'=att
+    var atts = '(' + att + ')*';                                        // "blabla"=att1 "blabla"=att2
+    var regex = '^' + math_att + atts + '[\\s]+gmi<';                   // "=att "blabla"=att1 "blabla"=att2 gmi< .
+    var expression = new RegExp(regex);
+
+    var actual_content = content.substring(0, i);
+    var reversed = actual_content.split('').reverse().join('');
+    var exists = expression.test(reversed);
+
+    return exists;
+}
+
+/**
+ * WIRIS special encoding.
+ * We use these entities because IE doesn't support html entities on its attributes sometimes. Yes, sometimes.
+ * @param {string} input String to be decoded.
+ * @return {string} Decoded string.
+ * @ignore
+ */
+function wrs_mathmlDecode(input) {
+    // Decoding entities.
+    input = input.split(_wrs_safeXmlCharactersEntities.tagOpener).join(_wrs_safeXmlCharacters.tagOpener);
+    input = input.split(_wrs_safeXmlCharactersEntities.tagCloser).join(_wrs_safeXmlCharacters.tagCloser);
+    input = input.split(_wrs_safeXmlCharactersEntities.doubleQuote).join(_wrs_safeXmlCharacters.doubleQuote);
+    // Added to fix problem due to import from 1.9.x.
+    input = input.split(_wrs_safeXmlCharactersEntities.realDoubleQuote).join(_wrs_safeXmlCharacters.realDoubleQuote);
+
+    // Blackboard.
+    if ('_wrs_blackboard' in window && window._wrs_blackboard){
+        input = input.split(_wrs_safeBadBlackboardCharacters.ltElement).join(_wrs_safeGoodBlackboardCharacters.ltElement);
+        input = input.split(_wrs_safeBadBlackboardCharacters.gtElement).join(_wrs_safeGoodBlackboardCharacters.gtElement);
+        input = input.split(_wrs_safeBadBlackboardCharacters.ampElement).join(_wrs_safeGoodBlackboardCharacters.ampElement);
+
+        /*var regex = /mtext.*[<>&].*\/mtext/;
+
+        var result = regex.exec(input);
+        while(result){
+            var changedResult = result[0].split(_wrs_xmlCharacters.tagOpener).join('lt;');
+            changedResult = changedResult.split(_wrs_xmlCharacters.tagCloser).join('gt;');
+            changedResult = changedResult.split(_wrs_xmlCharacters.ampersand).join('amp;');
+            input = input.replace(result, changedResult);
+            result = regex.exec(input);
+        }*/
+    }
+
+    // Decoding characters.
+    input = input.split(_wrs_safeXmlCharacters.tagOpener).join(_wrs_xmlCharacters.tagOpener);
+    input = input.split(_wrs_safeXmlCharacters.tagCloser).join(_wrs_xmlCharacters.tagCloser);
+    input = input.split(_wrs_safeXmlCharacters.doubleQuote).join(_wrs_xmlCharacters.doubleQuote);
+    input = input.split(_wrs_safeXmlCharacters.ampersand).join(_wrs_xmlCharacters.ampersand);
+    input = input.split(_wrs_safeXmlCharacters.quote).join(_wrs_xmlCharacters.quote);
+
+    // We are replacing $ by & when its part of an entity for retrocompatibility. Now, the standard is replace  by &.
+    var returnValue = '';
+    var currentEntity = null;
+
+    for (var i = 0; i < input.length; ++i) {
+        var character = input.charAt(i);
+
+        if (currentEntity == null) {
+            if (character == '$') {
+                currentEntity = '';
+            }
+            else {
+                returnValue += character;
+            }
+        }
+        else {
+            if (character == ';') {
+                returnValue += '&' + currentEntity + ';';
+                currentEntity = null;
+            }
+            else if (character.match(/([a-zA-Z0-9#._-] | '-')/)) {  // Character is part of an entity.
+                currentEntity += character;
+            }
+            else {
+                returnValue += '$' + currentEntity; // Is not an entity.
+                currentEntity = null;
+                --i; // Parse again the current character.
+            }
+        }
+    }
+
+    return returnValue;
+}
+
+/**
+ * WIRIS special encoding.
+ * We use these entities because IE doesn't support html entities on its attributes sometimes. Yes, sometimes.
+ * @param {string} input to be encoded
+ * @return {string} Encoded string.
+ * @ignore
+ */
+function wrs_mathmlEncode(input) {
+    input = input.split(_wrs_xmlCharacters.tagOpener).join(_wrs_safeXmlCharacters.tagOpener);
+    input = input.split(_wrs_xmlCharacters.tagCloser).join(_wrs_safeXmlCharacters.tagCloser);
+    input = input.split(_wrs_xmlCharacters.doubleQuote).join(_wrs_safeXmlCharacters.doubleQuote);
+    input = input.split(_wrs_xmlCharacters.ampersand).join(_wrs_safeXmlCharacters.ampersand);
+    input = input.split(_wrs_xmlCharacters.quote).join(_wrs_safeXmlCharacters.quote);
+
+    return input;
+}
+
+/**
+ * Converts special symbols (> 128) to entities and replaces all textual entities by its number entities.
+ * @param {string} mathml MathML string containing - or not - special symbols
+ * @return {string} MathML with all textual entities replaced.
+ * @ignore
+ */
+function wrs_mathmlEntities(mathml) {
+    var toReturn = '';
+
+    for (var i = 0; i < mathml.length; ++i) {
+        var character = mathml.charAt(i);
+
+        // Parsing > 128 characters.
+        if (mathml.charCodeAt(i) > 128) {
+            toReturn += '&#' + mathml.charCodeAt(i) + ';';
+        }
+        else if (character == '&') {
+            var end = mathml.indexOf(';', i + 1);
+
+            if (end >= 0) {
+                var container = document.createElement('span');
+                container.innerHTML = mathml.substring(i, end + 1);
+                toReturn += '&#' + wrs_fixedCharCodeAt((container.innerText || container.textContent),0) + ';';
+                i = end;
+            }
+            else {
+                toReturn += character;
+            }
+        }
+        else {
+            toReturn += character;
+        }
+    }
+
+    return toReturn;
+}
+
+/**
+ * Add wrs::type attribute to mathml if the mathml has been created with a custom editor
+ * for example, chemistry.
+ * @param {string} mathml a MathML string created with a custom editor, like chemistry.
+ * @return {string} The MathML string with his class containgin the editor toolbar string.
+ * @ignore
+ */
+function wrs_mathmlAddEditorAttribute(mathml) {
+    var toReturn = '';
+
+    var start = mathml.indexOf('<math');
+    if (start == 0 ) {
+        end = mathml.indexOf('>');
+        if (mathml.indexOf("class") == -1 ) {
+            // Adding custom editor type.
+            toReturn = mathml.substr(start, end) + ' class="wrs_' + wrs_int_getCustomEditorEnabled().toolbar + '">';
+            toReturn += mathml.substr(end + 1, mathml.length);
+            return toReturn;
+        }
+    }
+    return mathml;
+
+}
+
+/**
+ * Fix charCodeAt() javascript function to handle non-Basic-Multilingual-Plane characters.
+ * @param {string} str String
+ * @param {int} idx An integer greater than or equal to 0 and less than the length of the string
+ * @return {int} An integer representing the UTF-16 code of the string at the given index.
+ * @ignore
+ */
+
+function wrs_fixedCharCodeAt(str, idx) {
+    idx = idx || 0;
+    var code = str.charCodeAt(idx);
+    var hi, low;
+
+    /* High surrogate (could change last hex to 0xDB7F to treat high
+    private surrogates as single characters) */
+
+    if (0xD800 <= code && code <= 0xDBFF) {
+        hi = code;
+        low = str.charCodeAt(idx + 1);
+        if (isNaN(low)) {
+            throw 'High surrogate not followed by low surrogate in fixedCharCodeAt()';
+        }
+        return ((hi - 0xD800) * 0x400) + (low - 0xDC00) + 0x10000;
+    }
+
+    if (0xDC00 <= code && code <= 0xDFFF) { // Low surrogate.
+        /* We return false to allow loops to skip this iteration since should have
+           already handled high surrogate above in the previous iteration. */
+        return false;
+    }
+    return code;
+}
+
+/**
+ * Gets the accessible text of a given MathML calling mathml2accesible service.
+ * @param {string} mathml MathML to get the accesibility.
+ * @param {string} language Language of the accesibility.
+ * @return {string} Accessibility from mathml string on language string.
+ * @ignore
+ */
+function wrs_mathmlToAccessible(mathml, language, data) {
+    var accessibleText;
+
+    if (_wrs_int_AccessibleCache.hasOwnProperty(mathml)) {
+        accessibleText = _wrs_int_AccessibleCache[mathml];
+    }
+    else {
+        data['service'] = 'mathml2accessible';
+        data['lang'] = _wrs_int_langCode;
+        var accesibleJsonResponse = JSON.parse(wrs_getContent(_wrs_conf_servicePath, data));
+        if (accesibleJsonResponse.status != 'error') {
+            accessibleText = accesibleJsonResponse.result.text;
+        }
+    }
+
+    return accessibleText;
+
+}
+
+/**
+ * Converts mathml to an iframe object.
+ * @param {object} windowTarget Window object.
+ * @param {string} mathml MathML to be converted.
+ * @return {object} iframe object containging parsed mathml.
+ * @ignore
+ */
+function wrs_mathmlToIframeObject(windowTarget, mathml) {
+    if (window.navigator.userAgent.toLowerCase().indexOf('webkit') != -1) {
+        // In WebKit, the formula is represented by a div instead of an iframe.
+        var container = windowTarget.document.createElement('span');
+        container.className = _wrs_conf_imageClassName;
+        container.setAttribute(_wrs_conf_imageMathmlAttribute, mathml);
+        container.setAttribute('height', '1');
+        container.setAttribute('width', '1');
+        container.style.display = 'inline-block';
+        container.style.cursor = 'pointer';
+        container.style.webkitUserModify = 'read-only';
+        container.style.webkitUserSelect = 'all';
+
+        var formulaContainer = windowTarget.document.createElement('span');
+        formulaContainer.style.display = 'inline';
+        container.appendChild(formulaContainer);
+
+        function waitForViewer() {
+            if (windowTarget.com && windowTarget.com.wiris) {
+                if (!('_wrs_viewer' in windowTarget)) {
+                    windowTarget._wrs_viewer = new windowTarget.com.wiris.jsEditor.JsViewerMain(_wrs_conf_pluginBasePath + '/integration/editor');
+                    windowTarget._wrs_viewer.insertCSS(null, windowTarget.document);
+                }
+
+                windowTarget._wrs_viewer.paintFormulaOnContainer(mathml, formulaContainer, null);
+
+                function prepareDiv() {
+                    if (windowTarget._wrs_viewer.isReady()) {
+                        container.style.height = formulaContainer.style.height;
+                        container.style.width = formulaContainer.style.width;
+                        container.style.verticalAlign = formulaContainer.style.verticalAlign;
+                    }
+                    else {
+                        setTimeout(prepareDiv, 100);
+                    }
+                };
+
+                prepareDiv();
+            }
+            else {
+                setTimeout(waitForViewer, 100);
+            }
+        }
+
+        if (!('_wrs_viewerAppended' in windowTarget)) {
+            var viewerScript = windowTarget.document.createElement('script');
+            viewerScript.src = _wrs_conf_pluginBasePath + '/integration/editor/viewer.js';
+            windowTarget.document.getElementsByTagName('head')[0].appendChild(viewerScript);
+            windowTarget._wrs_viewerAppended = true;
+        }
+
+        waitForViewer();
+
+        return container;
+    }
+
+    windowTarget.document.wrs_assignIframeEvents = function (myIframe) {
+        wrs_addEvent(myIframe.contentWindow.document, 'click', function () {
+            wrs_fireEvent(myIframe, 'dblclick');
+        });
+    };
+
+    var iframe = windowTarget.document.createElement('iframe');
+    iframe.className = _wrs_conf_imageClassName;
+    iframe.setAttribute(_wrs_conf_imageMathmlAttribute, mathml);
+    iframe.style.display = 'inline';
+    iframe.style.border = 'none';
+    iframe.setAttribute('height', '1');
+    iframe.setAttribute('width', '1');
+    iframe.setAttribute('scrolling', 'no');
+    iframe.setAttribute('frameBorder', '0');
+    iframe.src = _wrs_conf_pluginBasePath + '/core/iframe.html#' + _wrs_conf_imageMathmlAttribute;
+    return iframe;
+}
+
+/**
+ * Converts mathml to img object.
+ * @param {object} creator Object with the "createElement" method
+ * @param {string} mathml MathML code
+ * @param {object} wirisProperties object containing WIRIS custom properties
+ * @param {language} language Custom language for accesibility.
+ * @return {object} And image containing the formula image corresponding to mathml string.
+ * @ignore
+ */
+function wrs_mathmlToImgObject(creator, mathml, wirisProperties, language) {
+    var width;
+    var height;
+    var baseline;
+    var imgObject = creator.createElement('img');
+    imgObject.align = 'middle';
+
+    var data = (wirisProperties) ? wirisProperties : {};
+
+    if (window._wrs_conf_useDigestInsteadOfMathml && _wrs_conf_useDigestInsteadOfMathml) {
+        data['returnDigest'] = 'true';
+    }
+
+    data['mml'] = mathml;
+    data['lang'] = language;
+
+    if (_wrs_conf_setSize) {
+        // Request metrics of the generated image.
+        data['metrics'] = 'true';
+        data['centerbaseline'] = 'false';
+    }
+
+    // Full base64 method (edit & save).
+    if (_wrs_conf_saveMode == 'base64' && _wrs_conf_editMode == 'default') {
+        data['base64'] = true;
+    }
+
+    // Render js params: _wrs_int_wirisProperties contains some js render params. Since mathml can support render params, js params should be send only to editor, not to render.
+
+    imgObject.className = _wrs_conf_imageClassName;
+
+    // TODO Custom Editors: class="wrs_toolbar" should be given by the editor
+    // so the first condition shouldn't be longer necessary.
+    if (customEditor = wrs_int_getCustomEditorEnabled()) {
+        imgObject.setAttribute('data-custom-editor', customEditor.toolbar);
+    } else if (mathml.indexOf('class="') != -1) { // We check here if the mathmnl has been created from a customEditor (such chemistry)
+        // to add data-custom-editor attribute to img object (if necessary).
+        mathmlSubstring = mathml.substring(mathml.indexOf('class="') + 'class="'.length, mathml.length);
+        mathmlSubstring = mathmlSubstring.substring(0, mathmlSubstring.indexOf('"'));
+        mathmlSubstring = mathmlSubstring.substring(4,mathmlSubstring.length);
+        imgObject.setAttribute('data-custom-editor', mathmlSubstring);
+    }
+
+    // Performance enabled.
+    if (_wrs_conf_wirisPluginPerformance && (_wrs_conf_saveMode == 'xml' || _wrs_conf_saveMode == 'safeXml')) {
+
+        var result = JSON.parse(wrs_createShowImageSrc(mathml, data, language));
+        if (result["status"] == 'warning') {
+            // POST call.
+            // if the mathml is malformed, this function will throw an exception
+            try {
+                result = JSON.parse(wrs_getContent(_wrs_conf_showimagePath, data));
+            }
+            catch (e) {
+                return;
+            }
+        }
+        result = result.result;
+        if (result['format'] == 'png') {
+            imgObject.src = 'data:image/png;base64,' + result['content'];
+        } else {
+            imgObject.src = 'data:image/svg+xml;charset=utf8,' + wrs_urlencode(result['content']);
+        }
+        imgObject.setAttribute(_wrs_conf_imageMathmlAttribute, wrs_mathmlEncode(mathml));
+        if (_wrs_conf_setSize) {
+            wrs_setImgSize(imgObject, result['content'], true);
+        }
+
+        if (window._wrs_conf_enableAccessibility && _wrs_conf_enableAccessibility) {
+            if (typeof result.alt == 'undefined') {
+                imgObject.alt = wrs_mathmlToAccessible(mathml, language, data);
+                wrs_populateAccessibleCache(mathml, imgObject.alt);
+            }
+            else {
+                imgObject.alt = result.alt;
+            }
+        }
+    }
+    else {
+        var result = wrs_createImageSrc(mathml, data);
+        if (window._wrs_conf_useDigestInsteadOfMathml && _wrs_conf_useDigestInsteadOfMathml) {
+            var parts = result.split(':', 2);
+            imgObject.setAttribute(_wrs_conf_imageMathmlAttribute, parts[0]);
+            imgObject.src = parts[1];
+        }
+        else {
+            imgObject.setAttribute(_wrs_conf_imageMathmlAttribute, wrs_mathmlEncode(mathml));
+            imgObject.src = result;
+            if (_wrs_conf_setSize) {
+                wrs_setImgSize(imgObject,result, (_wrs_conf_saveMode == 'base64' && _wrs_conf_editMode == 'default') ? true : false);
+            }
+        }
+        if (window._wrs_conf_enableAccessibility && _wrs_conf_enableAccessibility) {
+            imgObject.alt = wrs_mathmlToAccessible(mathml, language, data);
+            wrs_populateAccessibleCache(mathml, imgObject.alt);
+        }
+    }
+    /* if (_wrs_conf_setSize) {
+        var ar = wrs_urlToAssArray(result);
+        width = ar['cw'];
+        height = ar['ch'];
+        baseline = ar['cb'];
+        dpi = ar['dpi'];
+        if (dpi) {
+            width = width * 96/dpi;
+            height = height * 96/dpi;
+            baseline = baseline * 96/dpi;
+        }
+        // result = wrs_assArrayToUrl(ar);
+    }*/
+
+    if (typeof wrs_observer != 'undefined') {
+        wrs_observer.observe(imgObject, wrs_observer_config);
+    }
+
+    // Role math https://www.w3.org/TR/wai-aria/roles#math.
+    imgObject.setAttribute('role', 'math');
+    return imgObject;
+}
+
+/**
+ * Opens a new CAS window.
+ * @param {object} target The editable element
+ * @param {boolean} isIframe Specifies if target is an iframe or not
+ * @param {string} language CAS language.
+ * @return {object} The opened window
+ * @ignore
+ */
+function wrs_openCASWindow(target, isIframe, language) {
+    if (isIframe === undefined) {
+        isIframe = true;
+    }
+
+    _wrs_temporalRange = null;
+
+    if (target) {
+        var selectedItem = wrs_getSelectedItem(target, isIframe);
+
+        if (selectedItem != null && selectedItem.caretPosition === undefined && selectedItem.node.nodeName.toUpperCase() == 'IMG' && selectedItem.node.className == _wrs_conf_CASClassName) {
+            _wrs_temporalImage = selectedItem.node;
+            _wrs_isNewElement = false;
+        }
+    }
+
+    var path = _wrs_conf_CASPath;
+
+    if (language) {
+        path += '?lang=' + language;
+    }
+
+    return window.open(path, 'WIRISCAS', _wrs_conf_CASAttributes);
+}
+
+/**
+ * Opens a new editor window.
+ * @param {string} language Language code for the editor
+ * @param {object} target The editable element
+ * @param {boolean} isIframe Specifies if the target is an iframe or not
+ * @param {boolean} isModal Specifies if the target is a modal window or not
+ * @return {object} The opened window
+ * @ignore
+ */
+function wrs_openEditorWindow(language, target, isIframe) {
+    var ua = navigator.userAgent.toLowerCase();
+    var isAndroid = ua.indexOf("android") > -1;
+    var isIOS = ((ua.indexOf("ipad") > -1) || (ua.indexOf("iphone") > -1));
+
+    if(isAndroid || isIOS) {
+        _wrs_conf_modalWindow = true; // Conf property must be overrided on tablet/phone devices.
+    }
+
+    try {
+        if (isIframe) {
+            var selection = target.contentWindow.getSelection();
+            _wrs_range = selection.getRangeAt(0);
+        }
+        else {
+            var selection = getSelection();
+            _wrs_range = selection.getRangeAt(0);
+        }
+    }
+    catch (e) {
+        _wrs_range = null;
+    }
+
+    if (isIframe === undefined) {
+        isIframe = true;
+    }
+
+    // Avoid double slashes.
+    var path = _wrs_conf_path.lastIndexOf('/') == _wrs_conf_path.length - 1 ? _wrs_conf_path + "core/editor.html" : _wrs_conf_path + "/core/editor.html";
+
+    if (language) {
+        path = wrs_addArgument(path, "lang", language);
+    }
+
+    if (location.protocol == 'https:') {
+        path = wrs_addArgument(path, "secure", "true");
+    }
+
+    var availableDirs = new Array('rtl', 'ltr');
+    if (typeof _wrs_int_directionality != 'undefined' && wrs_arrayContains(availableDirs, _wrs_int_directionality) != -1){
+        path = wrs_addArgument(path,"dir",_wrs_int_directionality);
+    }
+
+    // Cross Domain Policy.
+    wrs_addArgument(path, 'host', 'localhost');
+
+    _wrs_editMode = (window._wrs_conf_defaultEditMode) ? _wrs_conf_defaultEditMode : 'images';
+    _wrs_temporalRange = null;
+
+    if (target) {
+        var selectedItem;
+        if (typeof wrs_int_getSelectedItem != 'undefined') {
+            selectedItem = wrs_int_getSelectedItem(target, isIframe);
+        } else {
+            selectedItem = wrs_getSelectedItem(target, isIframe);
+        }
+
+        if (selectedItem != null) {
+            if (selectedItem.caretPosition === undefined) {
+                if (wrs_containsClass(selectedItem.node, _wrs_conf_imageClassName)) {
+                    if (selectedItem.node.nodeName.toUpperCase() == 'IMG') {
+                        _wrs_editMode = 'images';
+                    }
+                    else if (selectedItem.node.nodeName.toUpperCase() == 'IFRAME') {
+                        _wrs_editMode = 'iframes';
+                    }
+
+                    _wrs_temporalImage = selectedItem.node;
+                    _wrs_isNewElement = false;
+                }
+            }
+            else {
+                var latexResult = wrs_getLatexFromTextNode(selectedItem.node, selectedItem.caretPosition);
+
+                if (latexResult != null) {
+                    _wrs_editMode = 'latex';
+
+                    var mathml = wrs_getMathMLFromLatex(latexResult.latex);
+                    _wrs_isNewElement = false;
+
+                    _wrs_temporalImage = document.createElement('img');
+                    _wrs_temporalImage.setAttribute(_wrs_conf_imageMathmlAttribute, wrs_mathmlEncode(mathml));
+                    var windowTarget = (isIframe) ? target.contentWindow : window;
+
+                    if (document.selection) {
+                        var leftOffset = 0;
+                        var previousNode = latexResult.startNode.previousSibling;
+
+                        while (previousNode) {
+                            leftOffset += wrs_getNodeLength(previousNode);
+                            previousNode = previousNode.previousSibling;
+                        }
+
+                        _wrs_temporalRange = windowTarget.document.selection.createRange();
+                        _wrs_temporalRange.moveToElementText(latexResult.startNode.parentNode);
+                        _wrs_temporalRange.move('character', leftOffset + latexResult.startPosition);
+                        _wrs_temporalRange.moveEnd('character', latexResult.latex.length + 4); // Plus 4 for the '$$' characters.
+                    }
+                    else {
+                        _wrs_temporalRange = windowTarget.document.createRange();
+                        _wrs_temporalRange.setStart(latexResult.startNode, latexResult.startPosition);
+                        _wrs_temporalRange.setEnd(latexResult.endNode, latexResult.endPosition);
+                    }
+                }
+            }
+        }
+    }
+
+    var title = wrs_int_getCustomEditorEnabled() != null ? wrs_int_getCustomEditorEnabled().title : 'WIRIS EDITOR math';
+    if (typeof _wrs_conf_modalWindow != 'undefined' && _wrs_conf_modalWindow === false) {
+        _wrs_popupWindow = window.open(path, title, _wrs_conf_editorAttributes);
+        return _wrs_popupWindow;
+    }
+    else {
+        if (_wrs_modalWindow == null) {
+            _wrs_modalWindow = new ModalWindow(path, _wrs_conf_editorAttributes);
+        }
+        if (!_wrs_css_loaded) {
+            var fileref = document.createElement("link");
+            fileref.setAttribute("rel", "stylesheet");
+            fileref.setAttribute("type", "text/css");
+            fileref.setAttribute("href", wrs_concatenateUrl(_wrs_conf_path, '/core/modal.css'));
+            document.getElementsByTagName("head")[0].appendChild(fileref);
+            _wrs_css_loaded = true;
+        }
+        _wrs_modalWindow.open();
+    }
+}
+
+
+
+/**
+ * Converts all occurrences of mathml code to LATEX. The MathML code should containg <annotation encoding="LaTeX"/> to be converted.
+ * @param {string} content A string containing MathML valid code.
+ * @return {string} String with all MathML annotated occurrences replaced by the corresponding LaTeX code.
+ * @ignore
+ */
+function wrs_parseMathmlToLatex(content, characters){
+    var output = '';
+    var mathTagBegin = characters.tagOpener + 'math';
+    var mathTagEnd = characters.tagOpener + '/math' + characters.tagCloser;
+    var openTarget = characters.tagOpener + 'annotation encoding=' + characters.doubleQuote + 'LaTeX' + characters.doubleQuote + characters.tagCloser;
+    var closeTarget = characters.tagOpener + '/annotation' + characters.tagCloser;
+    var start = content.indexOf(mathTagBegin);
+    var end = 0;
+    var mathml, startAnnotation, closeAnnotation;
+
+    while (start != -1) {
+        output += content.substring(end, start);
+        end = content.indexOf(mathTagEnd, start);
+
+        if (end == -1) {
+            end = content.length - 1;
+        }
+        else {
+            end += mathTagEnd.length;
+        }
+
+        mathml = content.substring(start, end);
+
+        startAnnotation = mathml.indexOf(openTarget);
+        if (startAnnotation != -1){
+            startAnnotation += openTarget.length;
+            closeAnnotation = mathml.indexOf(closeTarget);
+            var latex = mathml.substring(startAnnotation, closeAnnotation);
+            if (characters == _wrs_safeXmlCharacters) {
+                latex = wrs_mathmlDecode(latex);
+            }
+            output += '$$' + latex + '$$';
+            // Populate latex into cache.
+            wrs_populateLatexCache(latex, mathml);
+        }else{
+            output += mathml;
+        }
+
+        start = content.indexOf(mathTagBegin, end);
+    }
+
+    output += content.substring(end, content.length);
+    return output;
+}
+
+/**
+ * Converts all occurrences of mathml code to the corresponding image.
+ * @param {string} content An string with valid MathML code.
+ * @param {object} characters An object containing xmlCharacters or safeXmlCharacters relation.
+ * @param {string} language String containging a valid language code in order to generate formula accesibilty.
+ * @return {string} The input string with all the MathML ocurrences replaced by the corresponding image.
+ * @ignore
+ */
+function wrs_parseMathmlToImg(content, characters, language) {
+    var output = '';
+    var mathTagBegin = characters.tagOpener + 'math';
+    var mathTagEnd = characters.tagOpener + '/math' + characters.tagCloser;
+    var start = content.indexOf(mathTagBegin);
+    var end = 0;
+
+    while (start != -1) {
+        output += content.substring(end, start);
+        // Avoid WIRIS images to be parsed.
+        imageMathmlAtrribute = content.indexOf(_wrs_conf_imageMathmlAttribute);
+        end = content.indexOf(mathTagEnd, start);
+
+        if (end == -1) {
+            end = content.length - 1;
+        } else if (imageMathmlAtrribute != -1) {
+            // First close tag of img attribute
+            // If a mathmlAttribute exists should be inside a img tag.
+            end += content.indexOf("/>", start);
+        }
+        else {
+            end += mathTagEnd.length;
+        }
+
+        if (!wrs_isMathmlInAttribute(content, start) && imageMathmlAtrribute == -1){
+            var mathml = content.substring(start, end);
+            mathml = (characters == _wrs_safeXmlCharacters) ? wrs_mathmlDecode(mathml) : wrs_mathmlEntities(mathml);
+            output += wrs_createObjectCode(wrs_mathmlToImgObject(document, mathml, null, language));
+        }
+        else {
+            output += content.substring(start, end);
+        }
+
+        start = content.indexOf(mathTagBegin, end);
+    }
+
+    output += content.substring(end, content.length);
+    return output;
+}
+
+/**
+ * Converts all occurrences of safe applet code to the corresponding code.
+ * @param {string} content String containging valid applet code <APPLET>...</APPLET>
+ * @return {string} String with all the applet code conerted to safe tags.
+ * @ignore
+ */
+function wrs_parseSafeAppletsToObjects(content) {
+    var output = '';
+    var appletTagBegin = _wrs_safeXmlCharacters.tagOpener + 'APPLET';
+    var appletTagEnd = _wrs_safeXmlCharacters.tagOpener + '/APPLET' + _wrs_safeXmlCharacters.tagCloser;
+    var upperCaseContent = content.toUpperCase();
+    var start = upperCaseContent.indexOf(appletTagBegin);
+    var end = 0;
+    var applet;
+
+    while (start != -1) {
+        output += content.substring(end, start);
+        end = upperCaseContent.indexOf(appletTagEnd, start);
+
+        if (end == -1) {
+            end = content.length - 1;
+        }
+        else {
+            end += appletTagEnd.length;
+        }
+
+        applet = wrs_convertOldXmlinitialtextAttribute(content.substring(start, end));
+
+        output += wrs_mathmlDecode(applet);
+        start = upperCaseContent.indexOf(appletTagBegin, end);
+    }
+
+    output += content.substring(end, content.length);
+    return output;
+}
+
+/**
+ * Cross-browser removeEventListener/detachEvent function.
+ * @param {object} element Element target
+ * @param {event} event Event
+ * @param {function} func Function to run
+ * @ignore
+ */
+function wrs_removeEvent(element, event, func) {
+    if (element.removeEventListener) {
+        element.removeEventListener(event, func, true);
+    }
+    else if (element.detachEvent) {
+        element.detachEvent('on' + event, func);
+    }
+}
+
+/**
+ * Splits an HTML content in three parts: the code before <body>, the code between <body> and </body> and the code after </body>.
+ * @param {string} code HTML code to be splited.
+ * @return {objet} An object with the structure {'prefix': xxx, 'code': yyy, 'sufix': zzz}
+ * @ignore
+ */
+function wrs_splitBody(code) {
+    var prefix = '';
+    var sufix = '';
+    var bodyPosition = code.indexOf('<body');
+
+    if (bodyPosition != -1) {
+        bodyPosition = code.indexOf('>', bodyPosition);
+
+        if (bodyPosition != -1) {
+            ++bodyPosition;
+            var endBodyPosition = code.indexOf('</body>', bodyPosition);
+
+            if (endBodyPosition == -1) {
+                endBodyPosition = code.length;
+            }
+
+            prefix = code.substring(0, bodyPosition);
+            sufix = code.substring(endBodyPosition, code.length);
+            code = code.substring(bodyPosition, endBodyPosition);
+        }
+    }
+
+    return {
+        'prefix': prefix,
+        'code': code,
+        'sufix': sufix
+    };
+}
+
+/**
+ * Inserts or modifies CAS.
+ * @param {object} focusElement Element to be focused
+ * @param {object} windowTarget Window where the editable content is
+ * @param {string} appletCode Applet code
+ * @param {string} image Base 64 image stream
+ * @param {int} imageWidth Image width
+ * @param {int} imageHeight Image height
+ * @ignore
+ */
+function wrs_updateCAS(focusElement, windowTarget, appletCode, image, imageWidth, imageHeight) {
+    var imgObject = wrs_appletCodeToImgObject(windowTarget.document, appletCode, image, imageWidth, imageHeight);
+    wrs_insertElementOnSelection(imgObject, focusElement, windowTarget);
+}
+
+var wrs_PluginEvent = function () {
+    this.cancelled = false;
+    this.defaultPrevented = false;
+}
+
+wrs_PluginEvent.prototype.cancel = function () {
+    this.cancelled = true;
+}
+
+wrs_PluginEvent.prototype.preventDefault = function () {
+    this.defaultPrevented = true;
+}
+
+/**
+ * Fires WIRIS plugin event listeners
+ * @param  {String} eventName event name
+ * @param  {Object} e         event properties
+ * @return {bool}             false if event has been prevented.
+ * @ignore
+ */
+function wrs_fireEventListeners(eventName, e) {
+    for (var i = 0; i < wrs_pluginListeners.length && !e.cancelled; ++i) {
+        if (wrs_pluginListeners[i][eventName]) {
+            // Calling listener.
+            wrs_pluginListeners[i][eventName](e);
+        }
+    }
+
+    return e.defaultPrevented;
+}
+
+/**
+ * Inserts or modifies formulas.
+ * @param {object} focusElement Element to be focused
+ * @param {object} windowTarget Window where the editable content is
+ * @param {string} mathml Mathml code
+ * @param {object} wirisProperties Extra attributes for the formula (like background color or font size).
+ * @param {string} editMode Current edit mode.
+ * @param {string} language Language for the formula.
+ * @ignore
+ */
+function wrs_updateFormula(focusElement, windowTarget, mathml, wirisProperties, editMode, language) {
+    // Before update listener.
+
+    // Params on beforeUpdate listener
+    // - mathml
+    // - editMode (read only)
+    // - wirisProperties
+    // - language (read only).
+
+    editMode = editMode !== null ? editMode : _wrs_editMode;
+    var e = new wrs_PluginEvent();
+
+    e.mathml = mathml;
+
+    // Cloning wirisProperties object
+    // We don't want wirisProperties object modified.
+    e.wirisProperties = {};
+
+    for (var attr in wirisProperties) {
+        e.wirisProperties[attr] = wirisProperties[attr];
+    }
+
+    // Read only.
+    e.language = language;
+    e.editMode = editMode;
+
+    if (wrs_fireEventListeners('onBeforeFormulaInsertion', e)) {
+        return;
+    }
+
+    mathml = e.mathml;
+    wirisProperties = e.wirisProperties;
+
+    // Setting empty params for after.
+    e = new wrs_PluginEvent();
+    e.editMode = editMode;
+    e.windowTarget = windowTarget;
+    e.focusElement = focusElement;
+
+    if (mathml.length == 0) {
+        wrs_insertElementOnSelection(null, focusElement, windowTarget);
+    }
+    else if (editMode == 'latex') {
+        e.latex = wrs_getLatexFromMathML(mathml);
+        e.node = windowTarget.document.createTextNode('$$' + e.latex + '$$');
+        wrs_populateLatexCache(e.latex, mathml);
+        wrs_insertElementOnSelection(e.node, focusElement, windowTarget);
+    }
+    else if (editMode == 'iframes') {
+        var iframe = wrs_mathmlToIframeObject(windowTarget, mathml);
+        wrs_insertElementOnSelection(iframe, focusElement, windowTarget);
+    }
+    else {
+        e.node = wrs_mathmlToImgObject(windowTarget.document, mathml, wirisProperties, language);
+        wrs_insertElementOnSelection(e.node, focusElement, windowTarget);
+    }
+
+    if (wrs_fireEventListeners('onAfterFormulaInsertion', e)) {
+        return;
+    }
+}
+
+/**
+ * Inserts or modifies formulas or CAS on a textarea.
+ * @param {object} textarea Target
+ * @param {string} text Text to add in the textarea. For example, if you want to add the link to the image, you can call this function as wrs_updateTextarea(textarea, wrs_createImageSrc(mathml));
+ * @ignore
+ */
+function wrs_updateTextarea(textarea, text) {
+    if (textarea && text) {
+        textarea.focus();
+
+        if (textarea.selectionStart != null) {
+            textarea.value = textarea.value.substring(0, textarea.selectionStart) + text + textarea.value.substring(textarea.selectionEnd, textarea.value.length);
+        }
+        else {
+            var selection = document.selection.createRange();
+            selection.text = text;
+        }
+    }
+}
+
+/**
+ * URL decode function.
+ * @param {string} input String to be decoded
+ * @return {string} decode string.
+ * @ignore
+ */
+function wrs_urldecode(input) {
+    return decodeURIComponent(input);
+}
+
+/**
+ * URL encode function.
+ * @param {string} clearString Input string to be encoded
+ * @return {string} encoded string.
+ * @ignore
+ */
+function wrs_urlencode(clearString) {
+    var output = '';
+    // Method encodeURIComponent doesn't encode !'()*~ .
+    output = encodeURIComponent(clearString);
+    return output;
+}
+
+function wrs_addArgument(path,key,value) {
+    if (path.indexOf("?") > 0) {
+        sep = "&";
+    } else {
+        sep = "?";
+    }
+    return path + sep + key + "=" + value;
+}
+
+function wrs_urlToAssArray(url) {
+    var i;
+    i = url.indexOf("?");
+    if (i > 0) {
+        var query = url.substring(i + 1);
+        var ss  = query.split("&");
+        var h = new Object();
+        for (i = 0; i < ss.length; i++) {
+            var s = ss[i];
+            var kv = s.split("=");
+            if (kv.length > 1) {
+                h[kv[0]] = decodeURIComponent(kv[1].replace(/\+/g, ' '));
+            }
+        }
+        return h;
+    } else {
+        return new Object();
+    }
+}
+
+function wrs_setImgSize(img, url, json) {
+
+    if (json) {
+        // Cleaning data:image/png;base64.
+        if (_wrs_conf_imageFormat == 'svg') {
+            var ar = getMetricsFromSvgString(url);
+        } else {
+            var base64String = img.src.substr( img.src.indexOf('base64,') + 7, img.src.length);
+            bytes = wrs_b64ToByteArray(base64String, 88);
+            var ar = wrs_getMetricsFromBytes(bytes);
+        }
+    } else {
+        var ar = wrs_urlToAssArray(url);
+    }
+    var width = ar['cw'];
+    if (!width) {
+        return;
+    }
+    var height = ar['ch'];
+    var baseline = ar['cb'];
+    var dpi = ar['dpi'];
+    if (dpi) {
+        width = width * 96 / dpi;
+        height = height * 96 / dpi;
+        baseline = baseline * 96 / dpi;
+    }
+    img.width = width;
+    img.height = height;
+    img.style.verticalAlign = "-" + (height - baseline) + "px";
+}
+
+function wrs_fixAfterResize(img) {
+    img.removeAttribute('style');
+    img.removeAttribute('width');
+    img.removeAttribute('height');
+    if (_wrs_conf_setSize) {
+        if (img.src.indexOf("data:image") != -1) {
+            if (_wrs_conf_imageFormat == 'svg') {
+                // ...data:image/svg+xml;charset=utf8, = 32.
+                var svg = wrs_urldecode(img.src.substring(32, img.src.length))
+                wrs_setImgSize(img, svg, true);
+            } else {
+                // ...data:image/png;base64, == 22.
+                var base64 = img.src.substring(22,img.src.length);
+                wrs_setImgSize(img, base64, true);
+            }
+        } else {
+            wrs_setImgSize(img,img.src);
+        }
+    }
+}
+
+function wrs_initSetSize() {
+    // Override _wrs_conf_setSize to align formulas when xml or safeXml mode are enabled.
+    _wrs_conf_setSize = _wrs_conf_setSize || _wrs_conf_saveMode == 'xml' || _wrs_conf_saveMode == 'safeXml' || (_wrs_conf_saveMode == 'base64' && _wrs_conf_editMode == 'default');
+}
+
+/**
+ * Loads a set of global variables containing server configuration.
+ * This method calls to configurationjs service, converting the response
+ * JSON into javascript variables
+ * @ignore
+ */
+function wrs_loadConfiguration() {
+    if (typeof _wrs_conf_path == 'undefined') {
+        _wrs_conf_path = wrs_getCorePath();
+    }
+
+    var httpRequest = typeof XMLHttpRequest != 'undefined' ? new XMLHttpRequest() : new ActiveXObject('Microsoft.XMLHTTP');
+    var configUrl = _wrs_int_conf_file.indexOf("/") == 0 || _wrs_int_conf_file.indexOf("http") == 0 ? _wrs_int_conf_file : wrs_concatenateUrl(_wrs_conf_path, _wrs_int_conf_file);
+    httpRequest.open('GET', configUrl, false);
+    httpRequest.send(null);
+
+    var jsonConfiguration = JSON.parse(httpRequest.responseText);
+
+    // JSON structure: {{jsVariableName, jsVariableValue}}.
+
+    var variables = Object.keys(jsonConfiguration);
+
+    for (var variable in variables) {
+        window[variables[variable]] = jsonConfiguration[variables[variable]];
+    }
+
+    // Services path (tech dependant).
+    wrs_loadServicePaths(configUrl);
+
+    // End configuration.
+    _wrs_conf_configuration_loaded = true;
+    if (typeof _wrs_conf_core_loaded != 'undefined') {
+        _wrs_conf_plugin_loaded = true;
+    }
+}
+
+function wrs_loadServicePaths(url) {
+    // Services path (tech dependant).
+    _wrs_conf_createimagePath = url.replace('configurationjs', 'createimage');
+    _wrs_conf_showimagePath = url.replace('configurationjs', 'showimage');
+    _wrs_conf_editorPath = url.replace('configurationjs', 'editor');
+    _wrs_conf_CASPath = url.replace('configurationjs', 'cas');
+    _wrs_conf_createcasimagePath = url.replace('configurationjs', 'createcasimage');
+    _wrs_conf_getmathmlPath = url.replace('configurationjs', 'getmathml');
+    _wrs_conf_servicePath = url.replace('configurationjs', 'service');
+}
+
+_wrs_conf_plugin_loaded = true;
+
+function wrs_getCorePath() {
+    var scriptName = "core/core.js";
+    var col = document.getElementsByTagName("script");
+    for (var i = 0; i < col.length; i++) {
+        var d;
+        var src;
+        d = col[i];
+        src = d.src;
+        var j = src.lastIndexOf(scriptName);
+        if (j >= 0) {
+            // That's my script!
+            return src.substr(0, j - 1);
+        }
+    }
+}
+
+function wrs_loadLangFile() {
+    // When a language is not defined, put english (en) as default.
+    if (typeof _wrs_int_langCode == 'undefined' || _wrs_int_langCode == null) {
+        _wrs_int_langCode = 'en';
+    }
+
+    langArray = _wrs_languages.split(',');
+
+    if (langArray.indexOf(_wrs_int_langCode) == -1) {
+        _wrs_int_langCode = _wrs_int_langCode.substr(0,2);
+    }
+
+    if (langArray.indexOf(_wrs_int_langCode) == -1) {
+        _wrs_int_langCode = 'en';
+    }
+
+    var script = document.createElement('script');
+    script.type = 'text/javascript';
+    script.src = wrs_getCorePath() + "/lang/" + _wrs_int_langCode + "/strings.js";
+    document.getElementsByTagName('head')[0].appendChild(script);
+}
+
+function wrs_concatenateUrl(path1, path2) {
+    var separator = "";
+    if ((path1.indexOf("/") != path1.length) && (path2.indexOf("/") != 0)) {
+        separator = "/";
+    }
+    return (path1 + separator + path2).replace(/([^:]\/)\/+/g, "$1");
+}
+
+// Loading javascript configuration.
+if (typeof _wrs_conf_configuration_loaded == 'undefined') {
+    wrs_loadConfiguration();
+} else {
+    var configUrl = _wrs_int_conf_file.indexOf("/") == 0 || _wrs_int_conf_file.indexOf("http") == 0 ? _wrs_int_conf_file : wrs_concatenateUrl(_wrs_conf_path, _wrs_int_conf_file);
+    // If javascript configuration is loaded we need to load service paths manually.
+    wrs_loadServicePaths(configUrl);
+    _wrs_conf_plugin_loaded = true;
+}
+
+wrs_loadLangFile()
+
+/**
+ * Create modal window with embebbed iframe
+ *
+ * @param {string} title Modal window title
+ * @param {object} iframeParams iframe attributes
+ * @param {object} deviceProperties device properties like orientation, OS..
+ * @param {object} modalProperites modal properties (like draggable).
+ * @ignore
+ */
+
+function wrs_createModalWindow() {
+    // Adding css stylesheet.
+    if (!_wrs_css_loaded) {
+        var fileref = document.createElement("link");
+        fileref.setAttribute("rel", "stylesheet");
+        fileref.setAttribute("type", "text/css");
+        fileref.setAttribute("href", wrs_concatenateUrl(_wrs_conf_path, '/core/modal.css'));
+        document.getElementsByTagName("head")[0].appendChild(fileref);
+        _wrs_css_loaded = true;
+    }
+
+    _wrs_modalWindow.open();
+}
+
+/**
+ * Closes modal window
+ */
+function wrs_closeModalWindow() {
+    wrs_int_disableCustomEditors();
+    wrs_int_notifyWindowClosed();
+    _wrs_editMode = (window._wrs_conf_defaultEditMode) ? _wrs_conf_defaultEditMode : 'images';
+    _wrs_modalWindow.close();
+}
+
+/**
+ * Create modal dialog for non mobile android devices.
+ * @param  {modalDiv} modal overlay div.
+ * @param  {containerDiv} modal window div.
+ * @param  {iframe} embedded iframe.
+ * @param  {iframeParams}  embedded iframe params (height, width).
+ * @ignore
+ */
+
+function wrs_createModalWindowAndroid() {
+    _wrs_modalWindowProperties.device = 'android';
+    wrs_addClass(_wrs_modalWindow.iframeContainer, 'wrs_modal_android');
+    _wrs_modalWindow.overlayDiv.className = _wrs_modalWindow.overlayDiv.className + " wrs_modal_android";
+    _wrs_modalWindow.containerDiv.className = _wrs_modalWindow.containerDiv.className + " wrs_modal_android";
+    _wrs_modalWindow.iframe.className = _wrs_modalWindow.iframe.className + " wrs_modal_android";
+}
+
+/**
+ * Create modal dialog for non mobile iOS devices.
+ * @param  {modalDiv} modal overlay div.
+ * @param  {containerDiv} modal window div.
+ * @param  {iframe} embedded iframe.
+ * @param  {iframeParams}  embedded iframe params (height, width).
+ * @ignore
+ */
+function wrs_createModalWindowIos() {
+    wrs_addClass(iframeContainer, 'wrs_modal_ios');
+    _wrs_modalWindow.overlayDiv.className = _wrs_modalWindow.overlayDiv.className + " wrs_modal_ios";
+    if (typeof _wrs_isMoodle24 != 'undefined') {
+        _wrs_modalWindow.overlayDiv.className = _wrs_modalWindow.overlayDiv.className + " moodle";
+    }
+
+    _wrs_modalWindow.containerDiv.className = _wrs_modalWindow.containerDiv.className + " wrs_modal_ios";
+    _wrs_modalWindow.iframe.className = _wrs_modalWindow.iframe.className + " wrs_modal_ios";
+}
+
+/**
+ * Create modal dialog for mobile devices.
+ *
+ * @param  {modalDiv} modal overlay div.
+ * @param  {containerDiv} modal window div.
+ * @param  {iframe} embedded iframe.
+ * @param  {iframeParams}  embedded iframe params (height, width).
+ * @ignore
+ */
+
+function wrs_createModalWindowMobile(modalDiv, containerDiv, iframe, iframeParams, iframeContainer) {
+
+    wrs_addClass(_wrs_modalWindow.iframeContainer, 'wrs_modal_mobile');
+    _wrs_modalWindow.overlayDiv.className = _wrs_modalWindow.overlayDiv.className + " wrs_modal_mobile";
+    _wrs_modalWindow.containerDiv.className = _wrs_modalWindow.containerDiv.className + " wrs_modal_mobile";
+    _wrs_modalWindow.iframe.className = _wrs_modalWindow.iframe.className + " wrs_modal_mobile";
+
+    wrs_addMetaViewport("device-width", 1.0, 1.0, 1.0);
+
+    var modalTitleBar = document.getElementsByClassName('wrs_modal_title')[0]
+
+    if (modalTitleBar) {
+        document.removeChild(modalTitleBar);
+    }
+}
+
+/**
+ * Create modal dialog for Androir mobile devices with an old stock browser (<=4.3).
+ *
+ * @param  {modalDiv} modal overlay div.
+ * @param  {containerDiv} modal window div.
+ * @param  {iframe} embedded iframe.
+ * @param  {iframeParams}  embedded iframe params (height, width).
+ * @ignore
+ */
+function wrs_createModalWindowBadStockAndroid(modalDiv, containerDiv, iframe, iframeParams) {
+    _wrs_modalWindow.overlayDiv.className = _wrs_modalWindow.overlayDiv.className + " wrs_modal_badStock";
+    _wrs_modalWindow.containerDiv.className = _wrs_modalWindow.containerDiv.className + " wrs_modal_badStock";
+    _wrs_modalWindow.iframe.className = _wrs_modalWindow.iframe.className + " wrs_modal_badStock";
+
+    if (window.outerWidth < parseInt(_wrs_modalWindowProperties.iframeAttributes['width'])) {
+        var modalWidth = parseInt(_wrs_modalWindowProperties.iframeAttributes['width']) + 10;
+        _wrs_modalWindow.containerDiv.style.width = _wrs_modalWindowProperties.iframeAttributes['width'] + 'px';
+        _wrs_modalWindow.iframe.style.width = _wrs_modalWindowProperties.iframeAttributes['width'] + 'px';
+    }
+
+    window.addEventListener('orientationchange', function() {
+        if (window.outerWidth > parseInt(_wrs_modalWindowProperties.iframeAttributes['width']) + 10) {
+            var modalWidth = parseInt(_wrs_modalWindowProperties.iframeAttributes['width']) + 10;
+            _wrs_modalWindow.containerDiv.style.width = modalWidth + 'px';
+            _wrs_modalWindow.iframe.style.width = _wrs_modalWindowProperties.iframeAttributes['width'] + 'px';
+        } else {
+            _wrs_modalWindow.containerDiv.style.width = null;
+            _wrs_modalWindow.iframe.style.width = null;
+        }
+    });
+
+    wrs_addMetaViewport("device-width", 1.0, 1.0, 1.0);
+}
+
+/**
+ * Add viewport header for scale control.
+ *
+ * @param {int} width  width of the layout viewport.
+ * @param {int} initialScale Sets the initial zoom of the page and the width of the layout viewport.
+ * @param {int} minimumScale Sets the minimum zoom level (i.e. how much the user can zoom out).
+ * @param {int} maximumScale Sets the maximum zoom level (i.e. how much the user can zoom in).
+ * @ignore
+ */
+function wrs_addMetaViewport(width, initialScale, minimumScale, maximumScale) {
+    _wrs_originalMetaViewport = document.querySelector('meta[name=viewport]') ? document.querySelector('meta[name=viewport]').content : null;
+    if (_wrs_originalMetaViewport) {
+        document.querySelector('meta[name=viewport]').content = "width=" + width + ", initial-scale=" + initialScale + ", minimum-scale=" + minimumScale + ", maximum-scale=" + maximumScale;
+    } else {
+        var attributes = {};
+        attributes['name'] = 'viewport';
+        attributes['content'] = "width=" + width + ", initial-scale=" + initialScale + ", minimum-scale=" + minimumScale + ", maximum-scale=" + maximumScale;
+        var meta = wrs_createElement('meta', attributes);
+        document.getElementsByTagName("head")[0].appendChild(meta);
+    }
+}
+
+
+/**
+ * Android stock browser test
+ * http://stackoverflow.com/questions/24926221/distinguish-android-chrome-from-stock-browser-stock-browsers-user-agent-contai
+ *
+ * @return {Boolean} true if user agent is from an Android stock browser (<= 4.3)
+ * @ignore
+ */
+function wrs_isBadStockAndroid () {
+    var userAgent = window.navigator.userAgent;
+    // Android stock browser test derived from
+    // http://stackoverflow.com/questions/24926221/distinguish-android-chrome-from-stock-browser-stock-browsers-user-agent-contai.
+    var isAndroid = userAgent.indexOf(' Android ') > -1;
+    if (!isAndroid) {
+        return false;
+    }
+
+    var isStockAndroid = userAgent.indexOf('Version/') > -1;
+    if (!isStockAndroid) {
+        return false;
+    }
+
+    var versionNumber = parseFloat((userAgent.match('Android ([0-9.]+)') || [])[1]);
+    // Anything below 4.4 uses WebKit without *any* viewport support.
+    return versionNumber <= 4.3;
+}
+
+/**
+ * Populates LaTeX cache into _wrs_int_LatexCache global variable.
+ *
+ * @param {string}latex LaTeX code (with $$ separators)
+ * @param {string} mathml matml LaTeX translation.
+ * @ignore
+ */
+function wrs_populateLatexCache(latex, mathml) {
+    if (mathml.indexOf('semantics') == -1 && mathml.indexOf('annotation') == -1 ) {
+        mathml = wrs_insertSemanticsMathml(mathml, latex);
+    }
+    if (!_wrs_int_LatexCache.hasOwnProperty(latex)) {
+        _wrs_int_LatexCache[latex] = mathml;
+    }
+}
+
+/**
+ * Puts into _wrs_int_AccessibleCache global variable dictionary the pair mathml=>accessibleText.
+ *
+ * @param {string} mathml MatML text.
+ * @param {string} accessibleText Image accessible text
+ * @ignore
+ */
+function wrs_populateAccessibleCache(mathml, accessibleText) {
+    if (!_wrs_int_AccessibleCache.hasOwnProperty(mathml)) {
+        _wrs_int_AccessibleCache[mathml] = accessibleText;
+    }
+}
+
+/**
+ * Add annotation tag to mathml without it (mathml comes from LaTeX string)
+ * @param  {string} mathml MathML code generated by a LaTeX string.
+ * @param  {string} latex Original LaTeX string
+ * @return {string} new mathml containing LaTeX code on annotation tag.
+ * @ignore
+ */
+function wrs_insertSemanticsMathml(mathml, latex) {
+
+    var firstEndTag = '>';
+    var mathTagEnd = '<' + '/math' + '>';
+    var openSemantics = '<' + 'semantics' + '>';
+    var closeSemantics = '<' + '/semantics' + '>';
+    var openTarget = '<annotation encoding="LaTeX">';
+    var closeTarget = '<' + '/annotation' + '>';
+    var mrowOpen = '<mrow>';
+    var mrowClose = '</mrow>';
+
+    var indexMathBegin = mathml.indexOf(firstEndTag);
+    var indexMathEnd = mathml.indexOf(mathTagEnd);
+    var mathBeginExists = mathml.substring(mathml.indexOf('<'), mathml.indexOf('>')).indexOf('math');
+
+    if (indexMathBegin != -1 && indexMathEnd != -1 && mathBeginExists)  {
+        var mathmlContent = mathml.substring(indexMathBegin + 1, indexMathEnd);
+        if (mathmlContent.indexOf(mrowOpen) != 0) {
+            var mathmlContentSemantics = openSemantics + mrowOpen + mathmlContent + mrowClose + openTarget + latex + closeTarget + closeSemantics;
+        } else {
+            var mathmlContentSemantics = openSemantics + mathmlContent + openTarget + latex + closeTarget + closeSemantics;
+        }
+        return mathml.replace(mathmlContent, mathmlContentSemantics);
+    } else {
+        return mathml;
+    }
+
+}
+
+/**
+ * Transform html img tags inside a html code to mathml, base64 img tags (i.e with base64 on src) or showimage img tags (i.e with showimage.php on src)
+ *
+ * @param  {String} code html code
+ * @param  {String} mode base642showimage or img2mathml or img264 transform.
+ * @return {String} html code transformed.
+ * @ignore
+ */
+function wrs_codeImgTransform(code, mode) {
+    output = '';
+
+    var endPosition = 0;
+    var pattern = /<img/gi;
+    var patternLength = pattern.source.length;
+
+    while (pattern.test(code)) {
+        var startPosition = pattern.lastIndex - patternLength;
+        output += code.substring(endPosition, startPosition);
+
+        var i = startPosition + 1;
+
+        while (i < code.length && endPosition <= startPosition) {
+            var character = code.charAt(i);
+
+            if (character == '"' || character == '\'') {
+                var characterNextPosition = code.indexOf(character, i + 1);
+
+                if (characterNextPosition == -1) {
+                    i = code.length;        // End while.
+                }
+                else {
+                    i = characterNextPosition;
+                }
+            }
+            else if (character == '>') {
+                endPosition = i + 1;
+            }
+
+            ++i;
+        }
+
+        if (endPosition < startPosition) {      // The img tag is stripped.
+            output += code.substring(startPosition, code.length);
+            return output;
+        }
+        var imgCode = code.substring(startPosition, endPosition);
+        var imgObject = wrs_createObject(imgCode);
+        var xmlCode = imgObject.getAttribute(_wrs_conf_imageMathmlAttribute);
+
+        if (mode == 'base642showimage') {
+            if (xmlCode == null) {
+                xmlCode = imgObject.getAttribute('alt');
+            }
+            xmlCode = wrs_mathmlDecode(xmlCode);
+            imgCode = wrs_mathmlToImgObject(document, xmlCode, null, null);
+            output += wrs_createObjectCode(imgCode);
+        } else if (mode == 'img2mathml') {
+            if (window._wrs_conf_saveMode) {
+                if (_wrs_conf_saveMode == 'safeXml') {
+                    convertToXml = true;
+                    convertToSafeXml = true;
+                }
+                else if (_wrs_conf_saveMode == 'xml') {
+                    convertToXml = true;
+                    convertToSafeXml = false;
+                }
+            }
+            output += wrs_getWIRISImageOutput(imgCode, convertToXml, convertToSafeXml);
+        } else if (mode == 'img264') {
+
+            if (xmlCode == null) {
+                xmlCode = imgObject.getAttribute('alt');
+            }
+            xmlCode = wrs_mathmlDecode(xmlCode);
+
+            var properties = {};
+            properties['base64'] = 'true';
+            imgCode = wrs_mathmlToImgObject(document, xmlCode, properties, null)
+            // Metrics.
+            wrs_setImgSize(imgCode, imgCode.src, true);
+
+            output += wrs_createObjectCode(imgCode);
+        }
+    }
+    output += code.substring(endPosition, code.length);
+    return output;
+}
+
+/**
+ * Decode a base64 to its numeric value
+ *
+ * @param  {String} el base64 character.
+ * @return {int} base64 char numeric value.
+ * @ignore
+ */
+function wrs_decode64(el) {
+
+    var PLUS = '+'.charCodeAt(0);
+    var SLASH = '/'.charCodeAt(0);
+    var NUMBER = '0'.charCodeAt(0);
+    var LOWER = 'a'.charCodeAt(0);
+    var UPPER = 'A'.charCodeAt(0);
+    var PLUS_URL_SAFE = '-'.charCodeAt(0);
+    var SLASH_URL_SAFE = '_'.charCodeAt(0);
+    var code = el.charCodeAt(0);
+
+    if (code === PLUS || code === PLUS_URL_SAFE) {
+        return 62; // Char '+'.
+    }
+    if (code === SLASH || code === SLASH_URL_SAFE){
+        return 63 // Char '/'.
+    }
+    if (code < NUMBER){
+        return -1 // No match.
+    }
+    if (code < NUMBER + 10){
+        return code - NUMBER + 26 + 26
+    }
+    if (code < UPPER + 26){
+        return code - UPPER
+    }
+    if (code < LOWER + 26){
+        return code - LOWER + 26
+    }
+}
+
+/**
+ * Converts a base64 string to a array of bytes.
+ * @param  {String} b64String base64 string.
+ * @param  {int} len dimension of byte array (by default whole string).
+ * @return {Array} Byte array.
+ * @ignore
+ */
+function wrs_b64ToByteArray(b64String, len) {
+
+    var tmp;
+
+    if (b64String.length % 4 > 0) {
+        throw new Error('Invalid string. Length must be a multiple of 4'); // Tipped base64. Length is fixed.
+    }
+
+    var arr = new Array()
+
+    if (!len) { // All b64String string.
+        var placeHolders = b64String.charAt(b64String.length - 2) === '=' ? 2 : b64String.charAt(b64String.length - 1) === '=' ? 1 : 0
+        var l = placeHolders > 0 ? b64String.length - 4 : b64String.length;
+    } else {
+        var l = len;
+    }
+
+    for (var i = 0; i < l; i += 4) {
+        // Ignoring code checker standards (bitewise operators).
+        // See https://tracker.moodle.org/browse/CONTRIB-5862 for further information.
+        // @codingStandardsIgnoreStart
+        tmp = (wrs_decode64(b64String.charAt(i)) << 18) | (wrs_decode64(b64String.charAt(i + 1)) << 12) | (wrs_decode64(b64String.charAt(i + 2)) << 6) | wrs_decode64(b64String.charAt(i + 3));
+
+        arr.push((tmp  >> 16) & 0xFF);
+        arr.push((tmp >> 8) & 0xFF);
+        arr.push(tmp & 0xFF);
+        // @codingStandardsIgnoreEnd
+    }
+
+    if (placeHolders) {
+        if (placeHolders === 2) {
+            // Ignoring code checker standards (bitewise operators).
+            // @codingStandardsIgnoreStart
+            tmp = (wrs_decode64(b64String.charAt(i)) << 2) | (wrs_decode64(b64String.charAt(i + 1)) >> 4);
+            arr.push(tmp & 0xFF)
+        } else if (placeHolders === 1) {
+            tmp = (wrs_decode64(b64String.charAt(i)) << 10) | (wrs_decode64(b64String.charAt(i + 1)) << 4) | (wrs_decode64(b64String.charAt(i + 2)) >> 2)
+            arr.push((tmp >> 8) & 0xFF);
+            arr.push(tmp & 0xFF);
+            // @codingStandardsIgnoreEnd
+        }
+    }
+
+    return arr
+}
+
+/**
+ * Returns the first 32-bit signed integer from a byte array.
+ * @param  {Array} bytes array of bytes.
+ * @return {int} 32-bit signed integer.
+ * @ignore
+ */
+function wrs_readInt32(bytes) {
+    if (bytes.length < 4) {
+        return false;
+    }
+    var int32 = bytes.splice(0,4);
+    // @codingStandardsIgnoreStart
+    return (int32[0] << 24 | int32[1] << 16 | int32[2] <<  8 | int32[3] << 0);
+    // @codingStandardsIgnoreEnd
+}
+
+/**
+ * Read the first byte from a byte array.
+ * @param  {array} bytes byte array.
+ * @return {int} first byte of the byte array.
+ * @ignore
+ */
+function wrs_readByte(bytes) {
+    // @codingStandardsIgnoreStart
+    return bytes.shift() << 0;
+    // @codingStandardsIgnoreEnd
+
+}
+
+/**
+ * Read an arbitrary number of bytes, from a fixed position on a byte array.
+ * @param  {array} bytes byte array.
+ * @param  {int} post start position.
+ * @param  {int} len number of bytes to read.
+ * @return {array} byte array.
+ * @ignore
+ */
+function wrs_readBytes(bytes, pos, len) {
+    return bytes.splice(pos, len);
+}
+
+/**
+ * Get metrics (width, height, baseline and dpi) from a png's byte array.
+ * @param  {array} bytes png byte array.
+ * @return {array} An array containging the png's metrics.
+ * @ignore
+ */
+function wrs_getMetricsFromBytes(bytes) {
+    wrs_readBytes(bytes, 0, 8);
+    alloc = 10;
+    i = 0;
+    while (bytes.length >= 4) {
+        len = wrs_readInt32(bytes);
+        typ = wrs_readInt32(bytes);
+        if (typ == 0x49484452) {
+            width = wrs_readInt32(bytes);
+            height = wrs_readInt32(bytes);
+            // Read 5 bytes.
+            wrs_readInt32(bytes);
+            wrs_readByte(bytes);
+        } else if (typ == 0x62615345) { // Baseline: 'baSE'.
+            baseline = wrs_readInt32(bytes);
+        } else if (typ == 0x70485973) { // Dpis: 'pHYs'.
+            dpi = wrs_readInt32(bytes);
+            dpi = (Math.round(dpi / 39.37));
+            wrs_readInt32(bytes);
+            wrs_readByte(bytes);
+        }
+        wrs_readInt32(bytes);
+    }
+
+    if (typeof width != 'undefined') {
+        var arr = new Array();
+        arr['cw'] = width;
+        arr['ch'] = height;
+        arr['dpi'] = dpi;
+        if (baseline) {
+            arr['cb'] = baseline;
+        }
+
+        return arr;
+    }
+}
+
+function getMetricsFromSvgString(svgString) {
+    var first = svgString.indexOf('height="');
+    var last = svgString.indexOf('"',first + 8, svgString.length);
+    var height = svgString.substring(first + 8, last);
+
+    first = svgString.indexOf('width="');
+    last = svgString.indexOf('"',first + 7, svgString.length);
+    var width = svgString.substring(first + 7, last);
+
+    first = svgString.indexOf('wrs:baseline="');
+    last = svgString.indexOf('"',first + 14, svgString.length);
+    var baseline = svgString.substring(first + 14, last);
+
+    if (typeof(width != 'undefined')) {
+        var arr = new Array();
+        arr['cw'] = width;
+        arr['ch'] = height;
+        if (typeof baseline != 'undefined') {
+            arr['cb'] = baseline
+        }
+
+        return arr;
+    }
+
+}
+
+/**
+ * Get custom active editor
+ * @ignore
+ */
+function wrs_int_getCustomEditorEnabled() {
+    var customEditorEnabled = null;
+    for (var key in _wrs_int_customEditors) {
+        if (_wrs_int_customEditors[key].enabled) {
+            customEditorEnabled = _wrs_int_customEditors[key];
+            break;
+        }
+    }
+
+    return customEditorEnabled;
+}
+
+
+/**
+ * Disable all custom editors
+ * @ignore
+ */
+function wrs_int_disableCustomEditors(){
+    Object.keys(_wrs_int_customEditors).forEach(function(key) {
+            _wrs_int_customEditors[key].enabled = false;
+    });
+}
+
+/**
+ * Enable a custom editor
+ * @param {string} editor a custom editor to be enabled
+ * @ignore
+ */
+function wrs_int_enableCustomEditor(editor) {
+    // Only one custom editor enabled at the same time.
+    wrs_int_disableCustomEditors();
+    if (_wrs_int_customEditors[editor]) {
+        _wrs_int_customEditors[editor].enabled = true;
+    }
+}
+
+/**
+ * Convert a hash to string  sorting keys to get a deterministic output
+ * @param {hash} h a key-value hash
+ * @return{string} A string with the form key1=value1...keyn=valuen
+ * @ignore
+ */
+function wrs_propertiesToString(h) {
+    // 1. Sort keys. We sort the keys because we want a deterministic output.
+    var keys = []
+    for (var key in h) {
+        if (h.hasOwnProperty(key)) {
+            keys.push(key);
+        }
+    }
+
+    var n = keys.length;
+    for (var i = 0; i < n; i++) {
+        for (var j = i + 1; j < n; j++) {
+            var s1 = keys[i];
+            var s2 = keys[j];
+            if (wrs_compareStrings(s1,s2) > 0) {
+                // Swap.
+                keys[i] = s2;
+                keys[j] = s1;
+            }
+        }
+    }
+
+    // 2. Generate output.
+    var output = '';
+    for (var i = 0; i < n; i++) {
+        var key = keys[i];
+        output += key;
+        output += "=";
+        var value = h[key];
+        value = value.replace("\\", "\\\\");
+        value = value.replace("\n", "\\n");
+        value = value.replace("\r", "\\r");
+        value = value.replace("\t", "\\t");
+
+        output += value;
+        output += "\n";
+    }
+    return output;
+}
+
+/**
+ * Compare two strings using charCodeAt method
+ * @param {string} a first string to compare.
+ * @param {string} b second string to compare
+ * @return {int} the int difference between a and b
+ * @ignore
+ */
+function wrs_compareStrings(a, b){
+    var i;
+    var an = a.length;
+    var bn = b.length;
+    var n = (an > bn) ? bn : an;
+    for(i = 0; i < n; i++){
+        var c = wrs_fixedCharCodeAt(a,i) - wrs_fixedCharCodeAt(b,i);
+        if(c != 0) {
+            return c;
+        }
+    }
+        return a.length - b.length;
+}
+
+// Polyfills.
+
+if (!Object.keys) {
+    Object.keys = (function () {
+        'use strict';
+        var hasOwnProperty = Object.prototype.hasOwnProperty,
+        hasDontEnumBug = !({toString: null}).propertyIsEnumerable('toString'),
+        dontEnums = [
+          'toString',
+          'toLocaleString',
+          'valueOf',
+          'hasOwnProperty',
+          'isPrototypeOf',
+          'propertyIsEnumerable',
+          'constructor'
+        ],
+        dontEnumsLength = dontEnums.length;
+
+        return function (obj) {
+            if (typeof obj !== 'object' && (typeof obj !== 'function' || obj === null)) {
+                throw new TypeError('Object.keys called on non-object');
+            }
+
+            var result = [], prop, i;
+
+            for (prop in obj) {
+                if (hasOwnProperty.call(obj, prop)) {
+                    result.push(prop);
+                }
+            }
+
+            if (hasDontEnumBug) {
+                for (i = 0; i < dontEnumsLength; i++) {
+                    if (hasOwnProperty.call(obj, dontEnums[i])) {
+                        result.push(dontEnums[i]);
+                    }
+                }
+            }
+            return result;
+        };
+    }());
+}
+
+/**
+ * Add a new callback to a WIRIS plugins listener.
+ * @param {object} listener an Object containing listener name and a callback.
+ * @ignore
+ */
+function wrs_addPluginListener(listener) {
+    wrs_pluginListeners.push(listener);
+}
+
+/**
+ * For now its not possible comunicate directly between editor.js and ModalWindow object.
+ * We need to use this method to call ModalWindow prototype from editor.js
+ * @param  {object} editor WIRIS Editor
+ * @ignore
+ */
+function wrs_setModalWindowEditor(editor) {
+    if (_wrs_conf_modalWindow) {
+        _wrs_modalWindow.setEditor(editor);
+    }
+}
+
+/**
+ * Get the base URL (i.e the URL on core.js lives).
+ */
+function wrs_getServerPath() {
+    url = wrs_getCorePath();
+    var hostNameIndex = url.indexOf("/", url.indexOf("/") + 2);
+    return url.substr(0, hostNameIndex);
+}
+
+/**
+ * This method updates all services paths if there are relative with the absolute
+ * URL path.
+ * @ignore
+ */
+function wrs_updateContextPath() {
+    if (typeof _wrs_conf_plugin_loaded == 'undefined') {
+            setTimeout(wrs_updateContextPath, 100);
+    } else {
+        if (_wrs_conf_showimagePath.indexOf("/") == 0) {
+            serverPath = wrs_getServerPath()
+            _wrs_conf_showimagePath = serverPath + _wrs_conf_showimagePath;
+            _wrs_conf_editorPath = serverPath + _wrs_conf_editorPath;
+            _wrs_conf_CASPath = serverPath + _wrs_conf_CASPath;
+            _wrs_conf_createimagePath = serverPath + _wrs_conf_createimagePath;
+            _wrs_conf_createcasimagePath = serverPath + _wrs_conf_createcasimagePath;
+            _wrs_conf_getmathmlPath = serverPath + _wrs_conf_getmathmlPath;
+            _wrs_conf_servicePath = serverPath + _wrs_conf_servicePath;
+        }
+    }
+}
+
+wrs_updateContextPath();
+
+// Production steps of ECMA-262, Edition 5, 15.4.4.18
+// Reference: http://es5.github.io/#x15.4.4.18.
+if (!Array.prototype.forEach) {
+
+    Array.prototype.forEach = function(callback, thisArg) {
+
+        var T, k;
+
+        if (this == null) {
+            throw new TypeError(' this is null or not defined');
+        }
+
+        // 1. Let O be the result of calling ToObject passing the |this| value as the argument.
+        var O = Object(this);
+
+        // 2. Let lenValue be the result of calling the Get internal method of O with the argument "length".
+        // 3. Let len be ToUint32(lenValue).
+
+        // @codingStandardsIgnoreStart
+        var len = O.length >>> 0;
+        // @codingStandardsIgnoreEnd
+
+        // 4. If IsCallable(callback) is false, throw a TypeError exception.
+        // See: http://es5.github.com/#x9.11 .
+        if (typeof callback !== "function") {
+            throw new TypeError(callback + ' is not a function');
+        }
+
+        // 5. If thisArg was supplied, let T be thisArg; else let T be undefined.
+        if (arguments.length > 1) {
+            T = thisArg;
+        }
+
+        // 6. Let k be 0.
+        k = 0;
+
+        // 7. Repeat, while k < len.
+        while (k < len) {
+
+            var kValue;
+
+            // A. Let Pk be ToString(k).
+                // This is implicit for LHS operands of the in operator
+            // B. Let kPresent be the result of calling the HasProperty internal method of O with argument Pk
+                // This step can be combined with c
+            // C. If kPresent is true.
+            if (k in O) {
+
+                // I. Let kValue be the result of calling the Get internal method of O with argument Pk.
+                kValue = O[k];
+
+                // II. Call the Call internal method of callback with T as the this value and
+                // argument list containing kValue, k, and O.
+                callback.call(T, kValue, k, O);
+            }
+            // D. Increase k by 1.
+            k++;
+        }
+        // 8. return undefined.
+    };
+}
+// @codingStandardsIgnoreStart
+(function(){
+var HxOverrides = function() { }
+HxOverrides.__name__ = true;
+HxOverrides.dateStr = function(date) {
+	var m = date.getMonth() + 1;
+	var d = date.getDate();
+	var h = date.getHours();
+	var mi = date.getMinutes();
+	var s = date.getSeconds();
+	return date.getFullYear() + "-" + (m < 10?"0" + m:"" + m) + "-" + (d < 10?"0" + d:"" + d) + " " + (h < 10?"0" + h:"" + h) + ":" + (mi < 10?"0" + mi:"" + mi) + ":" + (s < 10?"0" + s:"" + s);
+}
+HxOverrides.strDate = function(s) {
+	switch(s.length) {
+	case 8:
+		var k = s.split(":");
+		var d = new Date();
+		d.setTime(0);
+		d.setUTCHours(k[0]);
+		d.setUTCMinutes(k[1]);
+		d.setUTCSeconds(k[2]);
+		return d;
+	case 10:
+		var k = s.split("-");
+		return new Date(k[0],k[1] - 1,k[2],0,0,0);
+	case 19:
+		var k = s.split(" ");
+		var y = k[0].split("-");
+		var t = k[1].split(":");
+		return new Date(y[0],y[1] - 1,y[2],t[0],t[1],t[2]);
+	default:
+		throw "Invalid date format : " + s;
+	}
+}
+HxOverrides.cca = function(s,index) {
+	var x = s.charCodeAt(index);
+	if(x != x) return undefined;
+	return x;
+}
+HxOverrides.substr = function(s,pos,len) {
+	if(pos != null && pos != 0 && len != null && len < 0) return "";
+	if(len == null) len = s.length;
+	if(pos < 0) {
+		pos = s.length + pos;
+		if(pos < 0) pos = 0;
+	} else if(len < 0) len = s.length + len - pos;
+	return s.substr(pos,len);
+}
+HxOverrides.remove = function(a,obj) {
+	var i = 0;
+	var l = a.length;
+	while(i < l) {
+		if(a[i] == obj) {
+			a.splice(i,1);
+			return true;
+		}
+		i++;
+	}
+	return false;
+}
+HxOverrides.iter = function(a) {
+	return { cur : 0, arr : a, hasNext : function() {
+		return this.cur < this.arr.length;
+	}, next : function() {
+		return this.arr[this.cur++];
+	}};
+}
+var IntIter = function(min,max) {
+	this.min = min;
+	this.max = max;
+};
+IntIter.__name__ = true;
+IntIter.prototype = {
+	next: function() {
+		return this.min++;
+	}
+	,hasNext: function() {
+		return this.min < this.max;
+	}
+	,__class__: IntIter
+}
+var Std = function() { }
+Std.__name__ = true;
+Std["is"] = function(v,t) {
+	return js.Boot.__instanceof(v,t);
+}
+Std.string = function(s) {
+	return js.Boot.__string_rec(s,"");
+}
+Std["int"] = function(x) {
+	return x | 0;
+}
+Std.parseInt = function(x) {
+	var v = parseInt(x,10);
+	if(v == 0 && (HxOverrides.cca(x,1) == 120 || HxOverrides.cca(x,1) == 88)) v = parseInt(x);
+	if(isNaN(v)) return null;
+	return v;
+}
+Std.parseFloat = function(x) {
+	return parseFloat(x);
+}
+Std.random = function(x) {
+	return Math.floor(Math.random() * x);
+}
+var com = com || {}
+if(!com.wiris) com.wiris = {}
+if(!com.wiris.js) com.wiris.js = {}
+com.wiris.js.JsPluginTools = function() {
+	this.tryReady();
+};
+com.wiris.js.JsPluginTools.__name__ = true;
+com.wiris.js.JsPluginTools.main = function() {
+	var ev;
+	ev = com.wiris.js.JsPluginTools.getInstance();
+	haxe.Timer.delay($bind(ev,ev.tryReady),100);
+}
+com.wiris.js.JsPluginTools.getInstance = function() {
+	if(com.wiris.js.JsPluginTools.instance == null) com.wiris.js.JsPluginTools.instance = new com.wiris.js.JsPluginTools();
+	return com.wiris.js.JsPluginTools.instance;
+}
+com.wiris.js.JsPluginTools.bypassEncapsulation = function() {
+	if(window.com == null) window.com = { };
+	if(window.com.wiris == null) window.com.wiris = { };
+	if(window.com.wiris.js == null) window.com.wiris.js = { };
+	if(window.com.wiris.js.JsPluginTools == null) window.com.wiris.js.JsPluginTools = com.wiris.js.JsPluginTools.getInstance();
+}
+com.wiris.js.JsPluginTools.prototype = {
+	md5encode: function(content) {
+		return haxe.Md5.encode(content);
+	}
+	,doLoad: function() {
+		this.ready = true;
+		com.wiris.js.JsPluginTools.instance = this;
+		com.wiris.js.JsPluginTools.bypassEncapsulation();
+	}
+	,tryReady: function() {
+		this.ready = false;
+		if(js.Lib.document.readyState) {
+			this.doLoad();
+			this.ready = true;
+		}
+		if(!this.ready) haxe.Timer.delay($bind(this,this.tryReady),100);
+	}
+	,__class__: com.wiris.js.JsPluginTools
+}
+var haxe = haxe || {}
+haxe.Log = function() { }
+haxe.Log.__name__ = true;
+haxe.Log.trace = function(v,infos) {
+	js.Boot.__trace(v,infos);
+}
+haxe.Log.clear = function() {
+	js.Boot.__clear_trace();
+}
+haxe.Md5 = function() {
+};
+haxe.Md5.__name__ = true;
+haxe.Md5.encode = function(s) {
+	return new haxe.Md5().doEncode(s);
+}
+haxe.Md5.prototype = {
+	doEncode: function(str) {
+		var x = this.str2blks(str);
+		var a = 1732584193;
+		var b = -271733879;
+		var c = -1732584194;
+		var d = 271733878;
+		var step;
+		var i = 0;
+		while(i < x.length) {
+			var olda = a;
+			var oldb = b;
+			var oldc = c;
+			var oldd = d;
+			step = 0;
+			a = this.ff(a,b,c,d,x[i],7,-680876936);
+			d = this.ff(d,a,b,c,x[i + 1],12,-389564586);
+			c = this.ff(c,d,a,b,x[i + 2],17,606105819);
+			b = this.ff(b,c,d,a,x[i + 3],22,-1044525330);
+			a = this.ff(a,b,c,d,x[i + 4],7,-176418897);
+			d = this.ff(d,a,b,c,x[i + 5],12,1200080426);
+			c = this.ff(c,d,a,b,x[i + 6],17,-1473231341);
+			b = this.ff(b,c,d,a,x[i + 7],22,-45705983);
+			a = this.ff(a,b,c,d,x[i + 8],7,1770035416);
+			d = this.ff(d,a,b,c,x[i + 9],12,-1958414417);
+			c = this.ff(c,d,a,b,x[i + 10],17,-42063);
+			b = this.ff(b,c,d,a,x[i + 11],22,-1990404162);
+			a = this.ff(a,b,c,d,x[i + 12],7,1804603682);
+			d = this.ff(d,a,b,c,x[i + 13],12,-40341101);
+			c = this.ff(c,d,a,b,x[i + 14],17,-1502002290);
+			b = this.ff(b,c,d,a,x[i + 15],22,1236535329);
+			a = this.gg(a,b,c,d,x[i + 1],5,-165796510);
+			d = this.gg(d,a,b,c,x[i + 6],9,-1069501632);
+			c = this.gg(c,d,a,b,x[i + 11],14,643717713);
+			b = this.gg(b,c,d,a,x[i],20,-373897302);
+			a = this.gg(a,b,c,d,x[i + 5],5,-701558691);
+			d = this.gg(d,a,b,c,x[i + 10],9,38016083);
+			c = this.gg(c,d,a,b,x[i + 15],14,-660478335);
+			b = this.gg(b,c,d,a,x[i + 4],20,-405537848);
+			a = this.gg(a,b,c,d,x[i + 9],5,568446438);
+			d = this.gg(d,a,b,c,x[i + 14],9,-1019803690);
+			c = this.gg(c,d,a,b,x[i + 3],14,-187363961);
+			b = this.gg(b,c,d,a,x[i + 8],20,1163531501);
+			a = this.gg(a,b,c,d,x[i + 13],5,-1444681467);
+			d = this.gg(d,a,b,c,x[i + 2],9,-51403784);
+			c = this.gg(c,d,a,b,x[i + 7],14,1735328473);
+			b = this.gg(b,c,d,a,x[i + 12],20,-1926607734);
+			a = this.hh(a,b,c,d,x[i + 5],4,-378558);
+			d = this.hh(d,a,b,c,x[i + 8],11,-2022574463);
+			c = this.hh(c,d,a,b,x[i + 11],16,1839030562);
+			b = this.hh(b,c,d,a,x[i + 14],23,-35309556);
+			a = this.hh(a,b,c,d,x[i + 1],4,-1530992060);
+			d = this.hh(d,a,b,c,x[i + 4],11,1272893353);
+			c = this.hh(c,d,a,b,x[i + 7],16,-155497632);
+			b = this.hh(b,c,d,a,x[i + 10],23,-1094730640);
+			a = this.hh(a,b,c,d,x[i + 13],4,681279174);
+			d = this.hh(d,a,b,c,x[i],11,-358537222);
+			c = this.hh(c,d,a,b,x[i + 3],16,-722521979);
+			b = this.hh(b,c,d,a,x[i + 6],23,76029189);
+			a = this.hh(a,b,c,d,x[i + 9],4,-640364487);
+			d = this.hh(d,a,b,c,x[i + 12],11,-421815835);
+			c = this.hh(c,d,a,b,x[i + 15],16,530742520);
+			b = this.hh(b,c,d,a,x[i + 2],23,-995338651);
+			a = this.ii(a,b,c,d,x[i],6,-198630844);
+			d = this.ii(d,a,b,c,x[i + 7],10,1126891415);
+			c = this.ii(c,d,a,b,x[i + 14],15,-1416354905);
+			b = this.ii(b,c,d,a,x[i + 5],21,-57434055);
+			a = this.ii(a,b,c,d,x[i + 12],6,1700485571);
+			d = this.ii(d,a,b,c,x[i + 3],10,-1894986606);
+			c = this.ii(c,d,a,b,x[i + 10],15,-1051523);
+			b = this.ii(b,c,d,a,x[i + 1],21,-2054922799);
+			a = this.ii(a,b,c,d,x[i + 8],6,1873313359);
+			d = this.ii(d,a,b,c,x[i + 15],10,-30611744);
+			c = this.ii(c,d,a,b,x[i + 6],15,-1560198380);
+			b = this.ii(b,c,d,a,x[i + 13],21,1309151649);
+			a = this.ii(a,b,c,d,x[i + 4],6,-145523070);
+			d = this.ii(d,a,b,c,x[i + 11],10,-1120210379);
+			c = this.ii(c,d,a,b,x[i + 2],15,718787259);
+			b = this.ii(b,c,d,a,x[i + 9],21,-343485551);
+			a = this.addme(a,olda);
+			b = this.addme(b,oldb);
+			c = this.addme(c,oldc);
+			d = this.addme(d,oldd);
+			i += 16;
+		}
+		return this.rhex(a) + this.rhex(b) + this.rhex(c) + this.rhex(d);
+	}
+	,ii: function(a,b,c,d,x,s,t) {
+		return this.cmn(this.bitXOR(c,this.bitOR(b,~d)),a,b,x,s,t);
+	}
+	,hh: function(a,b,c,d,x,s,t) {
+		return this.cmn(this.bitXOR(this.bitXOR(b,c),d),a,b,x,s,t);
+	}
+	,gg: function(a,b,c,d,x,s,t) {
+		return this.cmn(this.bitOR(this.bitAND(b,d),this.bitAND(c,~d)),a,b,x,s,t);
+	}
+	,ff: function(a,b,c,d,x,s,t) {
+		return this.cmn(this.bitOR(this.bitAND(b,c),this.bitAND(~b,d)),a,b,x,s,t);
+	}
+	,cmn: function(q,a,b,x,s,t) {
+		return this.addme(this.rol(this.addme(this.addme(a,q),this.addme(x,t)),s),b);
+	}
+	,rol: function(num,cnt) {
+		return num << cnt | num >>> 32 - cnt;
+	}
+	,str2blks: function(str) {
+		var nblk = (str.length + 8 >> 6) + 1;
+		var blks = new Array();
+		var _g1 = 0, _g = nblk * 16;
+		while(_g1 < _g) {
+			var i = _g1++;
+			blks[i] = 0;
+		}
+		var i = 0;
+		while(i < str.length) {
+			blks[i >> 2] |= HxOverrides.cca(str,i) << (str.length * 8 + i) % 4 * 8;
+			i++;
+		}
+		blks[i >> 2] |= 128 << (str.length * 8 + i) % 4 * 8;
+		var l = str.length * 8;
+		var k = nblk * 16 - 2;
+		blks[k] = l & 255;
+		blks[k] |= (l >>> 8 & 255) << 8;
+		blks[k] |= (l >>> 16 & 255) << 16;
+		blks[k] |= (l >>> 24 & 255) << 24;
+		return blks;
+	}
+	,rhex: function(num) {
+		var str = "";
+		var hex_chr = "0123456789abcdef";
+		var _g = 0;
+		while(_g < 4) {
+			var j = _g++;
+			str += hex_chr.charAt(num >> j * 8 + 4 & 15) + hex_chr.charAt(num >> j * 8 & 15);
+		}
+		return str;
+	}
+	,addme: function(x,y) {
+		var lsw = (x & 65535) + (y & 65535);
+		var msw = (x >> 16) + (y >> 16) + (lsw >> 16);
+		return msw << 16 | lsw & 65535;
+	}
+	,bitAND: function(a,b) {
+		var lsb = a & 1 & (b & 1);
+		var msb31 = a >>> 1 & b >>> 1;
+		return msb31 << 1 | lsb;
+	}
+	,bitXOR: function(a,b) {
+		var lsb = a & 1 ^ b & 1;
+		var msb31 = a >>> 1 ^ b >>> 1;
+		return msb31 << 1 | lsb;
+	}
+	,bitOR: function(a,b) {
+		var lsb = a & 1 | b & 1;
+		var msb31 = a >>> 1 | b >>> 1;
+		return msb31 << 1 | lsb;
+	}
+	,__class__: haxe.Md5
+}
+haxe.Timer = function(time_ms) {
+	var me = this;
+	this.id = window.setInterval(function() {
+		me.run();
+	},time_ms);
+};
+haxe.Timer.__name__ = true;
+haxe.Timer.delay = function(f,time_ms) {
+	var t = new haxe.Timer(time_ms);
+	t.run = function() {
+		t.stop();
+		f();
+	};
+	return t;
+}
+haxe.Timer.measure = function(f,pos) {
+	var t0 = haxe.Timer.stamp();
+	var r = f();
+	haxe.Log.trace(haxe.Timer.stamp() - t0 + "s",pos);
+	return r;
+}
+haxe.Timer.stamp = function() {
+	return new Date().getTime() / 1000;
+}
+haxe.Timer.prototype = {
+	run: function() {
+	}
+	,stop: function() {
+		if(this.id == null) return;
+		window.clearInterval(this.id);
+		this.id = null;
+	}
+	,__class__: haxe.Timer
+}
+var js = js || {}
+js.Boot = function() { }
+js.Boot.__name__ = true;
+js.Boot.__unhtml = function(s) {
+	return s.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;");
+}
+js.Boot.__trace = function(v,i) {
+	var msg = i != null?i.fileName + ":" + i.lineNumber + ": ":"";
+	msg += js.Boot.__string_rec(v,"");
+	var d;
+	if(typeof(document) != "undefined" && (d = document.getElementById("haxe:trace")) != null) d.innerHTML += js.Boot.__unhtml(msg) + "<br/>"; else if(typeof(console) != "undefined" && console.log != null) console.log(msg);
+}
+js.Boot.__clear_trace = function() {
+	var d = document.getElementById("haxe:trace");
+	if(d != null) d.innerHTML = "";
+}
+js.Boot.isClass = function(o) {
+	return o.__name__;
+}
+js.Boot.isEnum = function(e) {
+	return e.__ename__;
+}
+js.Boot.getClass = function(o) {
+	return o.__class__;
+}
+js.Boot.__string_rec = function(o,s) {
+	if(o == null) return "null";
+	if(s.length >= 5) return "<...>";
+	var t = typeof(o);
+	if(t == "function" && (o.__name__ || o.__ename__)) t = "object";
+	switch(t) {
+	case "object":
+		if(o instanceof Array) {
+			if(o.__enum__) {
+				if(o.length == 2) return o[0];
+				var str = o[0] + "(";
+				s += "\t";
+				var _g1 = 2, _g = o.length;
+				while(_g1 < _g) {
+					var i = _g1++;
+					if(i != 2) str += "," + js.Boot.__string_rec(o[i],s); else str += js.Boot.__string_rec(o[i],s);
+				}
+				return str + ")";
+			}
+			var l = o.length;
+			var i;
+			var str = "[";
+			s += "\t";
+			var _g = 0;
+			while(_g < l) {
+				var i1 = _g++;
+				str += (i1 > 0?",":"") + js.Boot.__string_rec(o[i1],s);
+			}
+			str += "]";
+			return str;
+		}
+		var tostr;
+		try {
+			tostr = o.toString;
+		} catch( e ) {
+			return "???";
+		}
+		if(tostr != null && tostr != Object.toString) {
+			var s2 = o.toString();
+			if(s2 != "[object Object]") return s2;
+		}
+		var k = null;
+		var str = "{\n";
+		s += "\t";
+		var hasp = o.hasOwnProperty != null;
+		for( var k in o ) { ;
+		if(hasp && !o.hasOwnProperty(k)) {
+			continue;
+		}
+		if(k == "prototype" || k == "__class__" || k == "__super__" || k == "__interfaces__" || k == "__properties__") {
+			continue;
+		}
+		if(str.length != 2) str += ", \n";
+		str += s + k + " : " + js.Boot.__string_rec(o[k],s);
+		}
+		s = s.substring(1);
+		str += "\n" + s + "}";
+		return str;
+	case "function":
+		return "<function>";
+	case "string":
+		return o;
+	default:
+		return String(o);
+	}
+}
+js.Boot.__interfLoop = function(cc,cl) {
+	if(cc == null) return false;
+	if(cc == cl) return true;
+	var intf = cc.__interfaces__;
+	if(intf != null) {
+		var _g1 = 0, _g = intf.length;
+		while(_g1 < _g) {
+			var i = _g1++;
+			var i1 = intf[i];
+			if(i1 == cl || js.Boot.__interfLoop(i1,cl)) return true;
+		}
+	}
+	return js.Boot.__interfLoop(cc.__super__,cl);
+}
+js.Boot.__instanceof = function(o,cl) {
+	try {
+		if(o instanceof cl) {
+			if(cl == Array) return o.__enum__ == null;
+			return true;
+		}
+		if(js.Boot.__interfLoop(o.__class__,cl)) return true;
+	} catch( e ) {
+		if(cl == null) return false;
+	}
+	switch(cl) {
+	case Int:
+		return Math.ceil(o%2147483648.0) === o;
+	case Float:
+		return typeof(o) == "number";
+	case Bool:
+		return o === true || o === false;
+	case String:
+		return typeof(o) == "string";
+	case Dynamic:
+		return true;
+	default:
+		if(o == null) return false;
+		if(cl == Class && o.__name__ != null) return true; else null;
+		if(cl == Enum && o.__ename__ != null) return true; else null;
+		return o.__enum__ == cl;
+	}
+}
+js.Boot.__cast = function(o,t) {
+	if(js.Boot.__instanceof(o,t)) return o; else throw "Cannot cast " + Std.string(o) + " to " + Std.string(t);
+}
+js.Lib = function() { }
+js.Lib.__name__ = true;
+js.Lib.debug = function() {
+	debugger;
+}
+js.Lib.alert = function(v) {
+	alert(js.Boot.__string_rec(v,""));
+}
+js.Lib.eval = function(code) {
+	return eval(code);
+}
+js.Lib.setErrorHandler = function(f) {
+	js.Lib.onerror = f;
+}
+var $_;
+function $bind(o,m) { var f = function(){ return f.method.apply(f.scope, arguments); }; f.scope = o; f.method = m; return f; };
+if(Array.prototype.indexOf) HxOverrides.remove = function(a,o) {
+	var i = a.indexOf(o);
+	if(i == -1) return false;
+	a.splice(i,1);
+	return true;
+}; else null;
+Math.__name__ = ["Math"];
+Math.NaN = Number.NaN;
+Math.NEGATIVE_INFINITY = Number.NEGATIVE_INFINITY;
+Math.POSITIVE_INFINITY = Number.POSITIVE_INFINITY;
+Math.isFinite = function(i) {
+	return isFinite(i);
+};
+Math.isNaN = function(i) {
+	return isNaN(i);
+};
+String.prototype.__class__ = String;
+String.__name__ = true;
+Array.prototype.__class__ = Array;
+Array.__name__ = true;
+Date.prototype.__class__ = Date;
+Date.__name__ = ["Date"];
+var Int = { __name__ : ["Int"]};
+var Dynamic = { __name__ : ["Dynamic"]};
+var Float = Number;
+Float.__name__ = ["Float"];
+var Bool = Boolean;
+Bool.__ename__ = ["Bool"];
+var Class = { __name__ : ["Class"]};
+var Enum = { };
+var Void = { __ename__ : ["Void"]};
+if(typeof document != "undefined") js.Lib.document = document;
+if(typeof window != "undefined") {
+	js.Lib.window = window;
+	js.Lib.window.onerror = function(msg,url,line) {
+		var f = js.Lib.onerror;
+		if(f == null) return false;
+		return f(msg,[url + ":" + line]);
+	};
+}
+com.wiris.js.JsPluginTools.main();
+delete Array.prototype.__class__; }());
+// @codingStandardsIgnoreEnd
+/**
+ * Modal window constructor
+ * @param {string} path             Iframe src
+ * @param {string} title            Modal window title
+ * @param {Object} editorAttributes Editor attributes (width, height)...
+ * @ignore
+ */
+function ModalWindow(path, editorAttributes) {
+
+    var ua = navigator.userAgent.toLowerCase();
+    var isAndroid = ua.indexOf("android") > -1;
+    var isIOS = ((ua.indexOf("ipad") > -1) || (ua.indexOf("iphone") > -1));
+
+    var deviceWidth = window.outerWidth;
+    var deviceHeight = window.outerHeight;
+
+    var landscape = deviceWidth > deviceHeight;
+    var portrait = deviceWidth < deviceHeight;
+
+    var iframeAttributes  = {};
+    iframeAttributes['width'] = editorAttributes.split(' ').join('').split(',')[0].split("=")[1];
+    iframeAttributes['height'] = editorAttributes.split(' ').join('').split(',')[1].split("=")[1];
+    iframeAttributes['src'] = path;
+
+    var isMobile = (landscape && iframeAttributes['height'] > deviceHeight) || (portrait && iframeAttributes['width'] > deviceWidth) ? true : false;
+
+    // Device object properties.
+
+    var deviceProperties = {};
+    deviceProperties['orientation'] = landscape ? 'landscape' : 'portait';
+    deviceProperties['isAndroid'] = isAndroid ? true : false;
+    deviceProperties['isIOS'] = isIOS ? true : false;
+    deviceProperties['isMobile'] = isMobile;
+
+    this.deviceProperties = deviceProperties;
+    this.properties = {
+        created : false,
+        state : '',
+        previousState : '',
+        deviceProperties: deviceProperties
+    }
+
+    this.properties.iframeAttributes = iframeAttributes;
+
+    this.title = '';
+
+    var attributes = {};
+
+    attributes['class'] = 'wrs_modal_overlay';
+    var modalOverlayDiv = wrs_createElement('div', attributes);
+    this.overlayDiv = modalOverlayDiv;
+
+    attributes['class'] = 'wrs_modal_title_bar';
+    var barModalDiv = wrs_createElement('div', attributes);
+    this.titleBardDiv = barModalDiv;
+
+    attributes = {};
+    attributes['class'] = 'wrs_modal_title';
+    var titleModalDiv = wrs_createElement('div', attributes);
+    titleModalDiv.innerHTML = this.title;
+    this.titleDiv = titleModalDiv;
+
+    attributes = {};
+    attributes['class'] = 'wrs_modal_close_button';
+    attributes['title'] = strings['close'];
+    var closeModalDiv = wrs_createElement('div', attributes);
+    this.closeDiv = closeModalDiv;
+
+    attributes = {};
+    attributes['class'] = 'wrs_modal_stack_button';
+    attributes['title'] = strings['fullscreen'];
+    var stackModalDiv = wrs_createElement('div', attributes);
+    this.stackDiv = stackModalDiv;
+
+    attributes = {};
+    attributes['class'] = 'wrs_modal_minimize_button';
+    attributes['title'] = strings['minimise'];
+    var minimizeModalDiv = wrs_createElement('div', attributes);
+    this.minimizeDiv = minimizeModalDiv;
+
+    attributes = {};
+    attributes['class'] = 'wrs_modal_dialogContainer';
+    var containerDiv = wrs_createElement('div', attributes);
+    containerDiv.style.overflow = 'hidden';
+    this.containerDiv = containerDiv;
+
+    attributes = {};
+    attributes['class'] = 'wrs_modal_iframe';
+    attributes['src'] = iframeAttributes['src'];
+    attributes['frameBorder'] = "0";
+    var iframeModal = wrs_createElement('iframe', attributes);
+    this.iframe = iframeModal;
+
+    attributes = {};
+    attributes['class'] = 'wrs_modal_iframeContainer';
+    var iframeModalContainer = wrs_createElement('div', attributes);
+    this.iframeContainer = iframeModalContainer;
+
+    // We create iframe inside _wrs_conf_path origin.
+    this.iframeOrigin = this.getOriginFromUrl(_wrs_conf_path);
+
+    this.lastImageWasNew = true;
+
+    this.toolbar = null;
+}
+
+ModalWindow.prototype.create = function() {
+    this.titleBardDiv.appendChild(this.closeDiv);
+    this.titleBardDiv.appendChild(this.stackDiv);
+    this.titleBardDiv.appendChild(this.minimizeDiv);
+    this.titleBardDiv.appendChild(this.titleDiv);
+    this.iframeContainer.appendChild(this.iframe);
+
+    wrs_addEvent(this.overlayDiv, 'mouseup', function (e) {
+        if (typeof(_wrs_modalWindow) !== 'undefined' && _wrs_modalWindow != null) {
+            _wrs_modalWindow.fireEditorEvent('mouseup');
+        }
+    });
+
+    if (!this.deviceProperties['isMobile'] && !this.deviceProperties['isAndroid'] && !this.deviceProperties['isIOS']) {
+        this.containerDiv.appendChild(this.titleBardDiv);
+    }
+    this.containerDiv.appendChild(this.iframeContainer);
+
+    document.body.appendChild(this.containerDiv);
+    document.body.appendChild(this.overlayDiv);
+
+    wrs_addEvent(this.closeDiv, 'click', this.close.bind(this));
+
+    if (!this.deviceProperties['isMobile'] && !this.deviceProperties['isIOS'] && !this.deviceProperties['isAndroid']) { // Desktop.
+        this.stackDiv.addEventListener('click', this.stackModalWindow.bind(this), true);
+        this.minimizeDiv.addEventListener('click', this.minimizeModalWindow.bind(this), true);
+        this.createModalWindowDesktop();
+    }
+    else if (this.deviceProperties['isAndroid']) {
+        this.createModalWindowAndroid();
+    }
+    else if (this.deviceProperties['isIOS'] && !this.deviceProperties['isMobile']) {
+        this.createModalWindowIos();
+    }
+    this.addListeners();
+    _wrs_popupWindow = this.iframe.contentWindow;
+    this.properties.open = true;
+    this.properties.created = true;
+
+    if (typeof _wrs_conf_modalWindow != "undefined" && _wrs_conf_modalWindow && _wrs_conf_modalWindowFullScreen) {
+        this.maximizeModalWindow();
+    }
+
+}
+
+ModalWindow.prototype.open = function() {
+
+    // Due to editor configurations we need to wait a few time.
+    setTimeout(function() {_wrs_modalWindow.hideKeyboard(), 300});
+
+    if (this.properties.open == true || this.properties.created) {
+
+        var editor = this.editor;
+
+        // TODO: Rewrite this method.
+        var updateToolbar = function(object) {
+            if (customEditor = wrs_int_getCustomEditorEnabled()) {
+                var toolbar = customEditor.toolbar ? customEditor.toolbar : _wrs_int_wirisProperties['toolbar'];
+                _wrs_modalWindow.setTitle(customEditor.title);
+                if (object.toolbar == null || object.toolbar != toolbar) {
+                    object.setToolbar(toolbar);
+                }
+            } else {
+                var toolbar = (typeof _wrs_int_wirisProperties == 'undefined' || typeof _wrs_int_wirisProperties['toolbar'] == 'undefined') ? 'general' : _wrs_int_wirisProperties['toolbar'];
+                _wrs_modalWindow.setTitle('WIRIS EDITOR math');
+                if (object.toolbar == null || object.toolbar != toolbar) {
+                    object.setToolbar(toolbar);
+                    wrs_int_disableCustomEditors();
+                }
+            }
+        };
+
+        var self = this;
+
+        // It controls cases where is needed to set an empty mathml or copy the current mathml value.
+        var updateMathMLContent = function () {
+            if (self.properties.deviceProperties.isAndroid || self.properties.deviceProperties.isIOS) {
+                self.setMathML('<math><semantics><annotation encoding="application/json">[]</annotation></semantics></math>"');
+            } else {
+                self.setMathML('<math/>');
+            }
+        };
+
+        if (this.properties.open == true) {
+            updateToolbar(self);
+            if (_wrs_isNewElement) {
+                updateMathMLContent();
+                self.lastImageWasNew = true;
+            }
+            else {
+                this.setMathML(wrs_mathmlDecode(_wrs_temporalImage.getAttribute(_wrs_conf_imageMathmlAttribute)));
+                this.lastImageWasNew = false;
+            }
+        }
+        else {
+            this.containerDiv.style.visibility = '';
+            this.overlayDiv.style.visibility = '';
+            this.containerDiv.style.opacity = '';
+            this.overlayDiv.style.display = '';
+
+            this.properties.open = true;
+
+            updateToolbar(self);
+
+            if (_wrs_isNewElement) {
+                updateMathMLContent();
+                self.lastImageWasNew = true;
+            } else {
+                this.setMathML(wrs_mathmlDecode(_wrs_temporalImage.getAttribute(_wrs_conf_imageMathmlAttribute)));
+                this.lastImageWasNew = false;
+            }
+            this.focus();
+
+            if (!this.properties.deviceProperties.isAndroid && !this.properties.deviceProperties.isIOS) {
+                this.stackModalWindow();
+            }
+        }
+
+        if (typeof _wrs_conf_modalWindow != "undefined" && _wrs_conf_modalWindow && _wrs_conf_modalWindowFullScreen) {
+            this.maximizeModalWindow();
+        }
+    } else {
+        var title = wrs_int_getCustomEditorEnabled() != null ? wrs_int_getCustomEditorEnabled().title : 'WIRIS EDITOR math';
+        _wrs_modalWindow.setTitle(title);
+        this.create();
+    }
+
+}
+
+/**
+ * Closes modal window and restores viewport header.
+ * @ignore
+ */
+ModalWindow.prototype.close = function() {
+    this.setMathML('<math/>');
+    this.overlayDiv.style.visibility = 'hidden';
+    this.containerDiv.style.visibility = 'hidden';
+    this.containerDiv.style.opacity = '0';
+    this.overlayDiv.style.display = 'none';
+    this.properties.open = false;
+    wrs_int_disableCustomEditors();
+    // Properties to initial state.
+    this.properties.state = '';
+    this.properties.previousState = '';
+}
+
+ModalWindow.prototype.addClass = function(cls) {
+    wrs_addClass(this.overlayDiv, cls);
+    wrs_addClass(this.titleBardDiv, cls);
+    wrs_addClass(this.overlayDiv, cls);
+    wrs_addClass(this.containerDiv, cls);
+    wrs_addClass(this.iframeContainer, cls);
+    wrs_addClass(this.iframe, cls);
+    wrs_addClass(this.stackDiv, cls);
+    wrs_addClass(this.minimizeDiv, cls);
+}
+
+ModalWindow.prototype.removeClass = function(cls) {
+    wrs_removeClass(this.overlayDiv, cls);
+    wrs_removeClass(this.titleBardDiv, cls);
+    wrs_removeClass(this.overlayDiv, cls);
+    wrs_removeClass(this.containerDiv, cls);
+    wrs_removeClass(this.iframeContainer, cls);
+    wrs_removeClass(this.iframe, cls);
+    wrs_removeClass(this.stackDiv, cls);
+    wrs_removeClass(this.minimizeDiv, cls);
+}
+
+ModalWindow.prototype.setTitle = function(title) {
+    this.titleDiv.innerHTML = title;
+    this.title = title;
+
+}
+/**
+ * Create modal dialog for desktop OS.
+ * @param  {modalDiv} modal overlay div.
+ * @param  {containerDiv} modal window div.
+ * @param  {iframe} embedded iframe.
+ * @param  {iframeParams}  embedded iframe params (height, width).
+ * @ignore
+ */
+ModalWindow.prototype.createModalWindowDesktop = function() {
+    this.addClass('wrs_modal_desktop');
+    this.stackModalWindow();
+}
+
+/**
+ * Create modal dialog for non mobile android devices.
+ * @param  {modalDiv} modal overlay div.
+ * @param  {containerDiv} modal window div.
+ * @param  {iframe} embedded iframe.
+ * @param  {iframeParams}  embedded iframe params (height, width).
+ * @ignore
+ */
+
+ModalWindow.prototype.createModalWindowAndroid = function() {
+    this.addClass('wrs_modal_android');
+}
+
+/**
+ * Create modal dialog for iOS devices.
+ * @ignore
+ */
+
+ModalWindow.prototype.createModalWindowIos = function() {
+
+    this.addClass('wrs_modal_ios');
+}
+
+ModalWindow.prototype.stackModalWindow = function () {
+    if (this.properties.state == 'stack' || (this.properties.state == 'minimized') && !this.properties.previousState == 'stack') {
+        this.maximizeModalWindow();
+    } else {
+        this.properties.previousState = this.properties.state;
+        this.properties.state = 'stack';
+
+        this.containerDiv.style.top = null;
+        this.containerDiv.style.rifgh = null;
+        this.containerDiv.style.left = null;
+        this.containerDiv.style.position = null;
+
+        this.overlayDiv.style.background = "rgba(0,0,0,0)";
+
+        this.stackDiv.title = "Full-screen";
+
+        var modalWidth = parseInt(this.properties.iframeAttributes['width']);
+        this.iframeContainer.style.width = modalWidth + 'px';
+        this.iframeContainer.style.height = 300 + 'px';
+        this.containerDiv.style.width = (modalWidth + 12) + 'px';
+        this.iframe.style.width = this.properties.iframeAttributes['width'] + 'px';
+        this.iframe.style.height = (parseInt(300) + 3) + 'px';
+        this.iframe.style.margin = '6px';
+        this.removeClass('wrs_maximized');
+        this.minimizeDiv.title = "Minimise";
+        this.removeClass('wrs_minimized');
+        this.addClass('wrs_stack');
+    }
+}
+
+ModalWindow.prototype.minimizeModalWindow = function() {
+    if (this.properties.state == 'minimized' && this.properties.previousState == 'stack') {
+        this.stackModalWindow();
+    }
+    else if (this.properties.state == 'minimized' && this.properties.previousState == 'maximized') {
+        this.maximizeModalWindow();
+    }
+    else {
+        this.removeListeners();
+        this.properties.previousState = this.properties.state;
+        this.properties.state = "minimized";
+        this.containerDiv.style.width = null;
+        this.containerDiv.style.left = null;
+        this.containerDiv.style.top = null;
+        this.containerDiv.style.position = null;
+        this.overlayDiv.style.background = "rgba(0,0,0,0)";
+        this.minimizeDiv.title = "Maximise";
+
+        if (wrs_containsClass(this.overlayDiv, 'wrs_stack')) {
+            this.removeClass('wrs_stack');
+        }
+        else {
+            this.removeClass('wrs_maximized');
+        }
+
+        this.addClass('wrs_minimized');
+    }
+}
+
+/**
+ * Minimizes modal window.
+ * @ignore
+ */
+ModalWindow.prototype.maximizeModalWindow = function() {
+    this.properties.previousState = this.properties.state;
+    this.properties.state = 'maximized';
+
+    var modalHeight = parseInt(this.properties.iframeAttributes['height']);
+    var modalWidth = parseInt(this.properties.iframeAttributes['width']);
+    this.iframeContainer.style.width = modalWidth + 'px';
+    this.iframeContainer.style.height = modalHeight + 'px';
+    this.containerDiv.style.width = (modalWidth + 12) + 'px';
+    this.iframe.style.width = this.properties.iframeAttributes['width'] + 'px';
+    this.iframe.style.height = (parseInt(this.properties.iframeAttributes['height']) + 3) + 'px';
+    this.iframe.style.margin = '6px';
+    this.removeClass('wrs_drag');
+    if (wrs_containsClass(this.overlayDiv, 'wrs_minimized')) {
+        this.minimizeDiv.title = "Minimise";
+        this.removeClass('wrs_minimized');
+    } else if (wrs_containsClass(this.overlayDiv, 'wrs_stack')) {
+        this.containerDiv.style.left = null;
+        this.containerDiv.style.top = null;
+        this.removeClass('wrs_stack');
+    }
+    this.stackDiv.title = "Exit full-screen";
+    this.overlayDiv.style.background = "rgba(0,0,0,0.8)";
+    this.overlayDiv.style.display = '';
+    this.addClass('wrs_maximized');
+}
+
+/**
+ * Makes an object draggable adding mouse and touch events.
+ *
+ * @param  {object} draggable object (for example modal dialog).
+ * @param  {target} target to add the events (for example de titlebar of a modal dialog)
+ * @ignore
+ */
+ModalWindow.prototype.addListeners = function() {
+    // Mouse events.
+    wrs_addEvent(document.body, 'mousedown', this.startDrag.bind(this));
+    wrs_addEvent(window, 'mouseup', this.stopDrag.bind(this));
+    wrs_addEvent(document, 'mouseup', this.stopDrag.bind(this));
+    wrs_addEvent(document.body, 'mousemove', this.drag.bind(this));
+}
+
+/**
+ * Removes draggable events from an object.
+ *
+ * @param  {object} draggable object (for example modal dialog).
+ * @param  {target} target to add the events (for example de titlebar of a modal dialog)
+ * @ignore
+ */
+ModalWindow.prototype.removeListeners = function() {
+    // Mouse events.
+    wrs_removeEvent(document.body, 'mousedown', this.startDrag);
+    wrs_removeEvent(window, 'mouseup', this.stopDrag);
+    wrs_removeEvent(document, 'mouseup', this.stopDrag);
+    wrs_removeEvent(document.getElementsByClassName("wrs_modal_iframe")[0], 'mouseup', this.stopDrag);
+    wrs_removeEvent(document.body, 'mousemove', this.drag);
+}
+
+
+/**
+ * Returns mouse or touch coordinates (on touch events ev.ClientX doesn't exists)
+ * @param {event} ev mnouse or touch event
+ * @return {object} with the X and Y coordinates.
+ * @ignore
+ */
+ModalWindow.prototype.eventClient = function(ev) {
+    if (typeof(ev.clientX) == 'undefined' && ev.changedTouches) {
+        var client = {
+            X : ev.changedTouches[0].clientX,
+            Y : ev.changedTouches[0].clientY
+        };
+        return client;
+    } else {
+        client = {
+            X : ev.clientX,
+            Y : ev.clientY
+        };
+        return client;
+    }
+}
+
+
+/**
+ * Set the overlay div display
+ *
+ * @param {event} ev touchstart or mousedown event.
+ * @ignore
+ */
+ModalWindow.prototype.setOverlayDiv = function(ev) {
+    this.overlayDiv.style.display = '';
+}
+
+/**
+ * Start drag function: set the object _wrs_dragDataObject with the draggable object offsets coordinates.
+ * when drag starts (on touchstart or mousedown events).
+ *
+ * @param {event} ev touchstart or mousedown event.
+ * @ignore
+ */
+ModalWindow.prototype.startDrag = function(ev) {
+    if (this.properties.state == 'minimized') {
+        return;
+    }
+    if (ev.target.className == 'wrs_modal_title') {
+        if(!this.dragDataobject) {
+            ev = ev || event;
+            this.dragDataObject = {
+                x: this.eventClient(ev).X - (isNaN(parseInt(window.getComputedStyle(this.containerDiv)).left && parseInt(window.getComputedStyle(this.containerDiv).left > 0 )) ? this.containerDiv.offsetLeft : parseInt(window.getComputedStyle(this.containerDiv).left)),
+                y: this.eventClient(ev).Y - (isNaN(parseInt(window.getComputedStyle(this.containerDiv).top)) ? this.containerDiv.offsetTop : parseInt(window.getComputedStyle(this.containerDiv).top))
+            };
+        };
+    }
+
+}
+
+/**
+ * Updates_wrs_dragDataObject with the draggable object coordinates when the draggable object is being moved.
+ *
+ * @param {event} ev touchmouve or mousemove events.
+ * @ignore
+ */
+ModalWindow.prototype.drag = function(ev) {
+    if(this.dragDataObject) {
+        ev.preventDefault();
+        ev = ev || event;
+        this.containerDiv.style.left = this.eventClient(ev).X - this.dragDataObject.x + window.pageXOffset + "px";
+        this.containerDiv.style.top = this.eventClient(ev).Y - this.dragDataObject.y + window.pageYOffset + "px";
+        this.containerDiv.style.position = 'absolute';
+        this.containerDiv.style.bottom = null;
+        wrs_removeClass(this.containerDiv, 'wrs_stack');
+    }
+}
+
+/**
+ * Set the _wrs_dragDataObject to null when the drag finish (touchend or mouseup events).
+ *
+ * @param {event} ev touchend or mouseup event.
+ * @ignore
+ */
+ModalWindow.prototype.stopDrag = function(ev) {
+    this.containerDiv.style.position = 'fixed';
+    // Due to we have multiple events that call this function, we need only to execute the next modifiers one time,
+    // when the user stops to drag and dragDataObject is not null (the object to drag is attached).
+    if (this.dragDataObject) {
+        // Fixed position makes the coords relative to the main window. So that, we need to transform
+        // the absolute coords to relative removing the scroll.
+        this.containerDiv.style.left = parseInt(this.containerDiv.style.left) - window.pageXOffset + "px";
+        this.containerDiv.style.top = parseInt(this.containerDiv.style.top) - window.pageYOffset + "px";
+    }
+    this.containerDiv.style.bottom = null;
+    this.dragDataObject = null;
+}
+
+/**
+ * Hide soft keyboards.
+ *
+ * @ignore
+ */
+ModalWindow.prototype.hideKeyboard = function() {
+    // ...creating temp field.
+    var field = document.createElement('input');
+    field.setAttribute('type', 'text');
+    // ...hiding temp field from peoples eyes.
+    // ...-webkit-user-modify is nessesary for Android 4.x.
+    field.setAttribute('style', 'position:absolute; top: 0px; opacity: 0; -webkit-user-modify: read-write-plaintext-only; left:0px;');
+    document.body.appendChild(field);
+
+    // ...adding onfocus event handler for out temp field.
+    field.onfocus = function(){
+          // ...this timeout of 200ms is nessasary for Android 2.3.x.
+          setTimeout(function() {
+
+                field.setAttribute('style', 'display:none;');
+                setTimeout(function() {
+                    document.body.removeChild(field);
+                    document.body.focus();
+                }, 14);
+
+          }, 200);
+    };
+    var keepScroll = window.pageYOffset;
+    field.focus();
+    window.scrollTo(0, keepScroll);
+}
+
+
+/**
+ * Returns the origin (i.e protocol + hostname + port) from an url string.
+ * This method is used to get the iframe window origin to allow postMessages.
+ * @param  {string} url url string
+ * @return {string}     origin string
+ * @ignore
+ */
+ModalWindow.prototype.getOriginFromUrl = function(url) {
+    var hostNameIndex = url.indexOf("/", url.indexOf("/") + 2);
+    return url.substr(0, hostNameIndex);
+}
+
+/**
+ * Enable safe cross-origin comunication betweenWIRIS Plugin and WIRIS Editor. We can't call directly
+ * WIRIS Editor methods because the content iframe could be in a different domain.
+ * We use postMessage method to create a wrapper between modal window and editor.
+ *
+ */
+
+/**
+ * Set a MathML into editor.
+ * @param {string} mathml MathML string.
+ * @ignore
+ */
+ModalWindow.prototype.setMathML = function(mathml) {
+    _wrs_popupWindow.postMessage({'objectName' : 'editor', 'methodName' : 'setMathML', 'arguments': [mathml]}, this.iframeOrigin);
+    this.focus();
+}
+
+/**
+ * Set a toolbar into editor.
+ * @param {string} toolbar toolbar name.
+ * @ignore
+ */
+ModalWindow.prototype.setToolbar = function(toolbar) {
+    this.toolbar = toolbar;
+    _wrs_popupWindow.postMessage({'objectName' : 'editor', 'methodName' : 'setParams', 'arguments': [{'toolbar' : toolbar}]}, this.iframeOrigin);
+}
+
+/**
+ * Set focus on editor.
+ * @ignore
+ */
+ModalWindow.prototype.focus = function() {
+    _wrs_popupWindow.postMessage({'objectName' : 'editor', 'methodName' : 'focus', 'arguments': null}, this.iframeOrigin);
+}
+
+
+/**
+ * Fires editor event
+ * @param  {string} eventName event name
+ * @ignore
+ */
+ModalWindow.prototype.fireEditorEvent = function(eventName) {
+    _wrs_popupWindow.postMessage({'objectName' : 'editorEvent', 'eventName' : eventName, 'arguments': null}, this.iframeOrigin);
+}
+
+var _wrs_conf_core_loaded = true;
diff --git a/lib/editor/atto/plugins/wiris/core/editor.css b/lib/editor/atto/plugins/wiris/core/editor.css
new file mode 100644
index 0000000..1d3bd04
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/core/editor.css
@@ -0,0 +1,134 @@
+.wrs_links {
+    margin: 10px auto;
+    margin-bottom :0px;
+    font-family : arial, sans-serif;
+    padding: 6px;
+
+}
+
+.wrs_links > a {
+    text-decoration: none;
+    color: #778e9a;
+}
+
+
+.wrs_button_cancel {
+    min-width: 80px;
+    font-size: 14px;
+    border-radius: 3px;
+    border: 1px solid #778e9a;
+    padding: 6px 8px;
+    margin: 10px auto;
+    margin-left: 5px;
+    margin-bottom :0px;
+    cursor: pointer;
+    font-family : arial, sans-serif;
+}
+
+.wrs_button_accept {
+    min-width: 80px;
+    font-size: 14px;
+    border-radius: 3px;
+    border: 1px solid #778e9a;
+    padding: 6px 8px;
+    margin: 10px auto;
+    margin-right: 5px;
+    margin-bottom :0px;
+    color : #ffffff;
+    background : #778e9a;
+    cursor: pointer;
+    font-family : arial, sans-serif;
+}
+
+.wrs_editor_vertical_bar {
+    height: 20px;
+    float: right;
+    background: none;
+    width: 20px;
+    cursor: pointer;
+}
+.wrs_buttonContainer {
+    display: inline;
+}
+
+.wrs_buttonContainer.wrs_modalAndroid {
+    padding-left: 6px;
+}
+
+.wrs_buttonContainer.wrs_modalDesktop {
+    padding-left: 0px;
+}
+
+@media only screen and (max-device-width: 480px) and (orientation: portrait) {
+    #container {
+        width : 140%;
+    }
+}
+
+
+/*iPad and iPad Mini*/
+@media only screen
+and (min-device-width : 768px)
+and (max-device-width : 1024px)
+and (orientation : portrait) {
+
+    .wrs_container.wrs_modalIos {
+        width: 100vw    !important;
+        height: 100vh   !important;
+    }
+
+    .wrs_editorContainer.wrs_modalIos {
+        width: 100vw    !important;
+        height: 89vh   !important;
+    }
+
+    .wrs_controls.wrs_modalIos {
+        width: 100vw    !important;
+        height: 11vh   !important;
+    }
+
+}
+
+@media only screen
+and (min-device-width : 768px)
+and (max-device-width : 1024px)
+and (orientation : landscape) {
+    .wrs_container.wrs_modalIos {
+        width: 100vw    !important;
+        height: 100vh   !important;
+    }
+
+    .wrs_editorContainer.wrs_modalIos {
+        width: 100vw    !important;
+        height: 87vh   !important;
+    }
+
+    .wrs_controls.wrs_modalIos {
+        width: 100vw    !important;
+        height: 13vh   !important;
+    }
+}
+
+/*iPhone5*/
+@media only screen
+and (min-device-width : 320px)
+and (max-device-width : 568px)
+and (orientation : portrait) {
+
+    .wrs_container.wrs_modalIos {
+        display: inline;
+        width: 320px    !important;
+        height: 100vh    !important;
+    }
+
+    .wrs_editorContainer.wrs_modalIos {
+        width: 320px    !important;
+        height: 79vh    !important;
+    }
+
+    .wrs_controls.wrs_modalIos {
+        width: 320px    !important;
+        height: 21vh    !important;
+        vertical-align: middle;
+    }
+}
diff --git a/lib/editor/atto/plugins/wiris/core/editor.html b/lib/editor/atto/plugins/wiris/core/editor.html
new file mode 100644
index 0000000..bca9f7f
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/core/editor.html
@@ -0,0 +1,63 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
+<html>
+    <head>
+        <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
+        <!-- script type="text/javascript" src="http://www.wiris.net/demo/editor/editor?lang=en"></script -->
+        <script type="text/javascript" src="editor.js"></script>
+        <link rel="stylesheet" type="text/css" href="editor.css">
+        <!-- script type="text/javascript" src="../lang/en/strings.js"></script -->
+        <title>WIRIS editor</title>
+        <style type="text/css">/*<!--*/
+
+        html, body, #container {
+            height: 100%;
+        }
+
+        body {
+            margin: 0;
+        }
+
+        #links {
+            display: inline;
+            float: right;
+            text-align: right;
+            /*margin-right: 20px;*/
+        }
+
+        #links_rtl {
+            text-align: left;
+            margin-left: 20px;
+        }
+
+        #controls {
+            text-align: left;
+        }
+
+        #controls_rtl {
+            float: right;
+
+        }
+
+        /*-->*/</style>
+
+        <meta content='width=device-width,
+         initial-scale=1.0,
+         minimum-scale=1.0,
+         maximum-scale=1.0,
+         target-densityDpi=device-dpi'
+         name='viewport' />
+    </head>
+    <body topmargin="0" leftmargin="0" marginwidth="0" marginheight="0">
+        <div id="container">
+            <div id="editorContainer">
+            </div>
+            <div id="controls">
+                <div id="buttonContainer" class="wrs_buttonContainer"></div>
+                <div id="links" class="wrs_links">
+                    <a href="http://www.wiris.com/editor3/docs/manual/latex-support" id="a_latex" target="_blank">LaTeX</a> |
+                    <a href="http://www.wiris.com/editor3/docs/manual" target="_blank" id="a_manual">Manual</a>
+                </div>
+            </div>
+        </div>
+    </body>
+</html>
diff --git a/lib/editor/atto/plugins/wiris/core/editor.js b/lib/editor/atto/plugins/wiris/core/editor.js
new file mode 100644
index 0000000..d3795cb
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/core/editor.js
@@ -0,0 +1,455 @@
+var _wrs_isNewElement; // Unfortunately we need this variabels as global variable for old I.E compatibility.
+
+(function(){
+
+    var editor;
+    // Set wrs_int_opener variable and close method.
+    // For popup window opener is window.opener. For modal window window.parent.
+    var wrs_int_opener = window.opener ? window.opener : window.parent;
+    var _wrs_closeFunction = window.opener ? window.close : function() {getMethod(null, 'wrs_closeModalWindow', [], null)};
+    var _wrs_callbacks = [];
+    var _wrs_callId = 0;
+    var _wrs_int_loaded = false;
+    var _wrs_temporalImageAttribute = null;
+    // Variables needed for core.js (or not core.js depending). This variables are loaded first of all.
+    var _wrs_int_vars = ['_wrs_editMode',
+                         '_wrs_isNewElement',
+                         '_wrs_conf_editor',
+                         '_wrs_conf_imageMathmlAttribute',
+                         '_wrs_int_conf_file',
+                         '_wrs_int_path' ,
+                         '_wrs_int_wirisProperties',
+                         '_wrs_int_customEditors',
+                         '_wrs_modalWindowProperties',
+                         '_wrs_int_langCode'
+                        ];
+
+    // Sometimes (yes, sometimes) internet explorer security policies hides popups
+    // popup window focus should be called from child window.
+    if (window.opener) {
+        window.focus();
+    }
+
+    // Loading core.js dependent variables (defined on _wrs_int_vars).
+    // Using getVars method for safely cross-origin communication.
+    getVars(_wrs_int_vars, function(object) { // Callback method to set variables.
+        for (var varName in object) {
+            window[varName] = object[varName]; // Variables set as global variables on window (core.js is on window can't change the scope).
+        }
+        if (!_wrs_isNewElement) {
+            // If is not a new image we need to load mathml image attribute using a postMessage method
+            // to avoid CORS policies.
+            getMethod('_wrs_temporalImage', 'getAttribute', [_wrs_conf_imageMathmlAttribute], function(imageAttribute){
+                if (imageAttribute == null) {
+                    getMethod('_wrs_temporalImage', 'getAttribute', ['alt'], function(imageAttributeAlt){
+                        _wrs_temporalImageAttribute = imageAttributeAlt;
+                        _wrs_int_loaded = true;
+                    });
+                } else {
+                    _wrs_temporalImageAttribute = imageAttribute;
+                    _wrs_int_loaded = true;
+                }
+            });
+        }
+        _wrs_int_loaded = true;
+    });
+
+    // Asyn methods
+    // waitForIntVariables loads core.js. Don't start until _wrs_int_vars has been loaded from _wrs_int_opener.
+    wrs_waitForIntVariables();
+    // Method waitForCore() loads WIRIS editor. Don't start until core.js has been loaded.
+    wrs_waitForCore();
+
+    /**
+     * Pass a wrs_int_opener variable to a callback function using postMessage method in order to avoid
+     * javascript CORS issues when wrs_int_opener and html editor page are on differents domains (like tinyMCE external plugin).
+     * For old I.E versions (7,8 & 9) wrs_int_opener is directly called so CORS don't work for them.
+     *
+     * @param  {String}   varName  wrs_int_opener variable name.
+     * @param  {Function} callback callback function.
+     */
+    function getVars(varNames, callback) {
+        _wrs_callbacks.push({
+            'id': _wrs_callId,
+            'callback': callback
+        });
+
+        try {
+            wrs_int_opener.postMessage({'id': _wrs_callId++, 'varNames' : varNames}, '*');
+        }
+        catch (err) { // Method postMessage not defined (I.E 7 & 8 ) or not competible with window object (I.E 9).
+            _wrs_callbacks.splice(_wrs_callId, 1);
+            var varObject = {};
+            for (var i = 0; i < varNames.length; i++) {
+                varObject[varNames[i]] = wrs_int_opener[varNames[i]];
+            }
+            callback(varObject);
+        }
+    }
+
+    /**
+     * Call a wrs_int_opener method and pass the result to a callback function using postMessage method in order to avoid
+     * javascript CORS issues when wrs_int_opener and html editor page are on differents domains (like tinyMCE external plugin).
+     * For old I.E versions (7,8 & 9) wrs_int_opener is directly called so CORS don't work for them. It is possible to call an object
+     * method using objectName variable.
+     *
+     * @param  {String}   objectName object name (null to call a wrs_int_opener method).
+     * @param  {String}   methodName method name.
+     * @param  {Array}    argumentss  method arguments ([arg1,..,argn])
+     * @param  {Function} callback   callback function.
+     */
+    function getMethod(objectName, methodName, argumentss, callback) {
+        _wrs_callbacks.push({
+            'id': _wrs_callId,
+            'callback': callback
+        });
+        try {
+            wrs_int_opener.postMessage({'id': _wrs_callId++, 'objectName': objectName, 'methodName' : methodName, 'arguments': argumentss}, '*');
+        }
+        catch (err) { // Method postMessage not defined (I.E 7 & 8 ) or not competible with window object (I.E 9).
+            var object = (objectName == null) ? wrs_int_opener : wrs_int_opener[objectName];
+            if (objectName == null) {
+                callback(object[methodName].apply(object, argumentss));
+            } else { // Can't call apply method from some objects on old I.E.
+                var argumentsStrings = argumentss.join(',');
+                var result = object[methodName](argumentsStrings);
+                callback(result);
+            }
+            _wrs_callbacks.splice(_wrs_callId, 1);
+        }
+    }
+
+    /**
+     * Load core.js library.
+     *
+     */
+    function wrs_loadCore() {
+        var script = document.createElement('script');
+        script.type = 'text/javascript';
+        script.src = "core.js";
+        document.getElementsByTagName('head')[0].appendChild(script);
+    }
+
+    /**
+     * Load core.js when int variables has been loaded.
+     *
+     */
+    function wrs_waitForIntVariables() {
+        if (_wrs_int_loaded) {
+            wrs_loadCore();
+        } else {
+            setTimeout(wrs_waitForIntVariables, 100);
+        }
+    }
+
+    /**
+     * Cross-browser addEventListener/attachEvent function.
+     * @param object element Element target
+     * @param event event Event
+     * @param function func Function to run
+     */
+    function wrs_addEvent(element, event, func) {
+        if (element.addEventListener) {
+            element.addEventListener(event, func, true);
+        }
+        else if (element.attachEvent) {
+            element.attachEvent('on' + event, func);
+        }
+    }
+
+    /**
+     * Load editor from _wrs_conf_editorUrl when core.js has been loaded.
+     * @return {[type]} [description]
+     */
+    function wrs_waitForCore() {
+        if (typeof _wrs_conf_core_loaded != 'undefined' && typeof _wrs_conf_configuration_loaded != 'undefined' && _wrs_conf_configuration_loaded == true) {
+            // Insert editor.
+            var script = document.createElement('script');
+            script.type = 'text/javascript';
+            var editorUrl = _wrs_conf_editorUrl;
+            // Change to https if necessary.
+            if (window.location.href.indexOf("https://") == 0) {
+                if (editorUrl.indexOf("http://") == 0) {
+                    editorUrl = "https" + editorUrl.substring(4);
+                }
+            }
+
+            // Editor stats.
+            statEditor = _wrs_conf_editor;
+            statSaveMode = _wrs_conf_saveMode;
+            statVersion = _wrs_conf_version;
+
+            script.src = editorUrl + "?lang=" + _wrs_int_langCode + '&stats-editor=' + statEditor + '&stats-mode=' + statSaveMode + '&stats-version=' + statVersion;
+            document.getElementsByTagName('head')[0].appendChild(script);
+
+            var script = document.createElement('script');
+            script.type = 'text/javascript';
+            script.src = "../";
+            // Get lang path
+            var webScripts = document.getElementsByTagName("script");
+            var scriptName = "strings.js";
+            var found = false;
+            var i = 0;
+            while (!found && i < webScripts.length) {
+                if (webScripts[i].src.indexOf(scriptName) != -1) {
+                    var pathArray = webScripts[i].src.split("/");
+                    // We need to get the lang folder name of "../[lang_folder]/[lang_code]/strings.js"
+                    script.src += pathArray[pathArray.length - 3 ] + "/" + _wrs_int_langCode + "/strings.js";
+                    found = true;
+                }
+                i++
+            }
+            document.getElementsByTagName('head')[0].appendChild(script);
+        } else {
+            setTimeout(wrs_waitForCore, 200);
+        }
+    }
+
+    // Adding events:
+    // 1.- onMessage event: for enable cross-origin communication between editor window and _wrs_int_opener.
+    // 2.- onLoad event: inserts WIRIS editor into editor.html DOM.
+    // 3.- onUnload: communicates _wrs_int_opener that editor has been closed.
+
+    wrs_addEvent(window, 'message', function (e) { // Safely enable cross-origin communication.
+        for (var i = 0; i < _wrs_callbacks.length; ++i) {
+            if (_wrs_callbacks[i].id == e.data.id && _wrs_callbacks[i].callback != null) {
+                _wrs_callbacks[i].callback(e.data.value);
+                _wrs_callbacks.splice(i, 1);
+                break;
+            }
+        }
+    });
+    wrs_addEvent(window, 'load', function () {
+        function wrs_waitForEditor() {
+            if ((typeof _wrs_conf_core_loaded != 'undefined') && ('com' in window && 'wiris' in window.com && 'jsEditor' in window.com.wiris)) {
+
+                var queryParams = wrs_getQueryParams(window);
+                var customEditor;
+
+                wrs_attributes = _wrs_conf_editorParameters;
+                wrs_attributes.language = queryParams['lang'];
+
+                if (typeof wrs_attributes['toolbar'] == 'undefined' &&  _wrs_conf_editorToolbar.length > 0) {
+                    wrs_attributes['toolbar'] = _wrs_conf_editorToolbar;
+                }
+
+                if (typeof(_wrs_int_wirisProperties) != 'undefined') {
+                    for (var key in _wrs_int_wirisProperties) {
+                        if (_wrs_int_wirisProperties.hasOwnProperty(key) && typeof(_wrs_int_wirisProperties[key]) != 'undefined') {
+                            wrs_attributes[key] = _wrs_int_wirisProperties[key];
+                        }
+                    }
+                }
+
+                if (customEditor = wrs_int_getCustomEditorEnabled()) {
+                    wrs_attributes['toolbar'] = customEditor.toolbar ? customEditor.toolbar : wrs_attributes['toolbar'];
+                }
+
+                if (com.wiris.jsEditor.defaultBasePath) {
+                    editor = com.wiris.jsEditor.JsEditor.newInstance(wrs_attributes);
+                }
+                else {
+                    editor = new com.wiris.jsEditor.JsEditor('editor', null);
+                }
+
+                // Set ModalWindow editor attribute.
+
+                var ua = navigator.userAgent.toLowerCase();
+                var isAndroid = ua.indexOf("android") > -1;
+                var isIOS = ((ua.indexOf("ipad") > -1) || (ua.indexOf("iphone") > -1));
+
+                var editorElement = editor.getElement();
+                var editorContainer = document.getElementById('editorContainer');
+                if (isIOS) {
+                    editorContainer.className += ' wrs_editorContainer wrs_modalIos';
+                }
+                editor.insertInto(editorContainer);
+
+                // Mathml content.
+                if (!_wrs_isNewElement) {
+                    var mathml;
+
+                    if (typeof _wrs_conf_useDigestInsteadOfMathml != 'undefined' && _wrs_conf_useDigestInsteadOfMathml) {
+                        mathml = wrs_getCode(_wrs_conf_digestPostVariable, _wrs_temporalImageAttribute);
+                    }
+                    else {
+                        mathml = wrs_mathmlDecode(_wrs_temporalImageAttribute);
+                    }
+                    if (wrs_int_getCustomEditorEnabled() == null && mathml.indexOf('class="wrs_') != -1) {
+                        var classIndexStart = mathml.indexOf('class="wrs_');
+                        classIndexEnd = mathml.indexOf(" ", classIndexStart);
+                        mathml = mathml.substring(0, classIndexStart) + mathml.substring(classIndexEnd, mathml.lenght);
+                    }
+
+                    editor.setMathML(mathml);
+                }
+
+                if (typeof strings == 'undefined') {
+                    strings = new Object();
+                }
+
+                if (isIOS) {
+                    // Editor and controls container.
+                    var editorAndControlsContainer = document.getElementById('container');
+                    editorAndControlsContainer.className += ' wrs_container wrs_modalIos';
+                }
+
+                // Submit button.
+                var controls = document.getElementById('controls');
+                if (isIOS) {
+                    controls.className += ' wrs_controls wrs_modalIos';
+                }
+                var submitButton = document.createElement('input');
+                submitButton.type = 'button';
+                submitButton.className = 'wrs_button_accept';
+                submitButton.background = '#778e9a';
+                submitButton.color = '#ffffff'
+
+                if (strings['accept'] != null){
+                    submitButton.value = strings['accept'];
+                }else{
+                    submitButton.value = 'Accept';
+                }
+
+                wrs_addEvent(window, 'beforeunload', function() {
+                    getMethod(null, 'wrs_int_disableCustomEditors', [], function(){
+                    });
+                });
+
+                wrs_addEvent(submitButton, 'click', function () {
+
+                    // In order to avoid n-formulas on n-clicks
+                    // submit button is disabled 1 second.
+                    submitButton.disabled = true;
+
+                    setTimeout(function() {
+                        submitButton.disabled = false;
+                    }, 1000);
+
+                    // There are vars that are updated during the execution in core.js, we need to sync.
+                    var varsToUpdate = ['_wrs_int_customEditors'];
+                    getVars(varsToUpdate, function(object) { // Callback method to set variables.
+                        for (var varName in object) {
+                            window[varName] = object[varName]; // Variables set as global variables on window (core.js is on window can't change the scope).
+                        }
+
+                        var mathml = '';
+
+                        if (!editor.isFormulaEmpty()) {
+                            mathml += editor.getMathML(); // If isn't empty, get mathml code to mathml variable.
+                            if (wrs_int_getCustomEditorEnabled() != null) {
+                                mathml = wrs_mathmlAddEditorAttribute(mathml);
+                            }
+                            else {
+                                var startIndex = mathml.indexOf(' class="');
+                                if (startIndex != -1) {
+                                    var lastIndex = mathml.indexOf('"', startIndex + 8);
+                                    mathml = mathml.substring(0, startIndex) + mathml.substring(lastIndex + 1);
+                                }
+                            }
+                            mathml = wrs_mathmlEntities(mathml);    // Apply a parse.
+                        }
+
+                        getMethod(null, 'wrs_int_updateFormula', [mathml, null, queryParams['lang']], function(){
+                                _wrs_closeFunction();
+                        });
+                    });
+
+                });
+
+                var buttonContainer = document.getElementById('buttonContainer');
+                buttonContainer.appendChild(submitButton);
+
+                // Cancel button.
+                var cancelButton = document.createElement('input');
+                cancelButton.type = 'button';
+                cancelButton.className = 'wrs_button_cancel';
+
+                if (strings['cancel'] != null) {
+                    cancelButton.value = strings['cancel'];
+                } else {
+                    cancelButton.value = 'Cancel';
+                }
+
+                wrs_addEvent(cancelButton, 'click', function () {
+                    _wrs_closeFunction();
+                });
+
+                buttonContainer.appendChild(cancelButton);
+
+                // Class for modal dialog.
+                if (_wrs_conf_modalWindow) {
+                    if (_wrs_modalWindowProperties.device == 'android') {
+                        buttonContainer.className = buttonContainer.className + ' wrs_modalAndroid';
+                    } else {
+                        buttonContainer.className = buttonContainer.className + ' wrs_modalDesktop';
+                    }
+                }
+
+                /*var manualLink = document.getElementById('a_manual');
+                if (typeof manualLink != 'undefined' && strings['manual'] != null){
+                    manualLink.innerHTML = strings['manual'];
+                }
+
+                var latexLink = document.getElementById('a_latex');
+                if (typeof latexLink != 'undefined' && strings['latex'] != null){
+                    latexLink.innerHTML = strings['latex'];
+                }*/
+
+                var queryLang = '';
+                if ('lang' in queryParams){
+                    queryLang = queryParams['lang'].substr(0, 2);
+                }
+
+                if ((queryParams['dir'] == 'rtl') || ((queryLang == 'he' || queryLang == 'ar') && queryParams['dir'] != 'ltr')){
+                    var body = document.getElementsByTagName('BODY');
+                    body[0].setAttribute("dir","rtl");
+                    var links = document.getElementById('links');
+                    links.id = 'links_rtl';
+                    var controls = document.getElementById('buttonContainer');
+                    controls.id = 'controls_rtl';
+                }
+
+                // At this point we listen to execute editor methods or fire editor events.
+                wrs_addEvent(window, 'message', function (e) {
+                    if (e.data.objectName != 'undefined' && e.data.objectName == 'editor') {
+                        editor[e.data.methodName].apply(editor, e.data.arguments);
+                    }
+
+                    if (e.data.objectName != 'undefined' && e.data.objectName == 'editorEvent') {
+                        wrs_fireEvent(window.document, e.data.eventName);
+                    }
+                });
+
+                wrs_addEvent(window, 'mouseup', function(e) {
+                    if (_wrs_conf_modalWindow) {
+                        getMethod('_wrs_modalWindow', 'stopDrag', [], null);
+                    }
+                });
+
+                wrs_addEvent(window, 'mousedown', function(e) {
+                    if (_wrs_conf_modalWindow) {
+                        getMethod('_wrs_modalWindow', 'setOverlayDiv', [], null);
+                    }
+                });
+
+                // Auto resizing.
+                setInterval(function () {
+                    editorElement.style.height = (document.getElementById('container').offsetHeight - controls.offsetHeight - 10) + 'px';
+                }, 100);
+
+                setTimeout(function () {
+                    editor.focus();
+                }, 100);
+            } else {
+                setTimeout(wrs_waitForEditor, 100);
+            }
+
+        }
+        wrs_waitForEditor();
+    });
+    wrs_addEvent(window, 'unload', function () {
+        getMethod(null, 'wrs_int_notifyWindowClosed', [], function(wrs_int_notifyWindowClosed){
+        });
+    });
+})();
diff --git a/lib/editor/atto/plugins/wiris/core/help.gif b/lib/editor/atto/plugins/wiris/core/help.gif
new file mode 100644
index 0000000000000000000000000000000000000000..284297d8864e2136610eb3f9225841290bf9eca5
GIT binary patch
literal 193
zcmZ?wbhEHb6l4%&_$<Ki|NqSY|I_}Tnfd<=kTm{3)A-C8<1;{VCd15`#xv85(?EzJ
z&6vU1m;neBf3mPLFbFW{fH)vC99VM|RQggZ?U)w|9sjJ6oqg`JGSA^hc4vOs+lwkb
zj1b^qKeGOb5W^g1@y}{17IK{PH6qr^r5s>?WIgSYf_3p*NsosGr-c=sCYZ#qhyJ-J
nCL~{}<E`PO%ct#8?Zm_1u9cu3&&I0b$yunDIYUX2!I}#ItCmA-

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/core/icons/cas.gif b/lib/editor/atto/plugins/wiris/core/icons/cas.gif
new file mode 100644
index 0000000000000000000000000000000000000000..988ea4a118e74ec63e5e589cad1a139fa3a39b17
GIT binary patch
literal 1037
zcmeH`+e?!H7{<SqnXM5EqVv&G!lFnLI@u1fYN@402k&%h+QCytvn*L77hYKjWfA4d
zk`l_pbh1jTNk=NZs3`Y+Zquf#v^5Q{e$D=Z{(xS7JQokV@5S@*ZqjdDwK`2HD23m`
z=m6v9MDU}W!E5*}_^a{XCGdbiJ%L7sS{Sl3+{W+|hM)1<f!ly5gPtI{c#rV4kp3e2
zPt#|_SH|}WepE0}#ejvuJN&H0|A1ds0xkTq6R_h-MKaKBz-2&6r+W|G*|@TC@5h~k
zrvOjz<|%s5;5Fl`;9Dhw_4sXwdyw`b?L*p+l!KIult*_SVm@L4(qW_{xQ_9y2JsNi
zqlkrw#}SJVi*XrotN3~euZ4aKzT5cj;;ZFj9$$*+D#BTevjnFK@eEEAq6tZbyPTd%
zdau%%Mu&lpbUq#B!!bUerprWEDedvRNaFP_Uhd{i3U4!bpG8MD9l5mWam3+B=6TT1
zqw@qUvDnnuHMD4XsKu`1v5rT2S`%nbr)fRSDy$l88mwBHwOBV`+d$Js?1?n$u<B^s
zOoJZl7Oe3!CD9N^eLVHsXb7@{#+|_`|5o~6{xyLGBOx+Ds1%ltE{y(!5Y{Ke?2Rta
z>L$&JHO|)5g_KQIRYq<$tHwCwCarl<+WE|~NX4|M#QgV0$E0~PDpFrOiIA7dW=8KW
z`Dq-#B|IvndPQPMYp6WhAdHkBjF`4=f^xQZ{`H#9>LmjihWl!n`S!NjusTzXW^8D<
zy70~l%X4LT{`4Jn7yD$U(1qHQ_cfNV%WBp9+MJ1PnhE!|4%J1d+-Ik>CXCCfGK9#d
zFVFIPl-*pM<b1fj$~0nZe|=@mDMiXoMbEhl%Q9UJm!FotyYcEkOpGl#Q!#5zv0oA8
d@lL)Kr*t%@SbE>ijWtizonNU>RSRq7e*o97!;t_0

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/core/icons/chem.gif b/lib/editor/atto/plugins/wiris/core/icons/chem.gif
new file mode 100644
index 0000000000000000000000000000000000000000..aaebeafff7cbec37423071841d2f755572514e39
GIT binary patch
literal 1058
zcmd^;{WH@60LH(YVNF*HS5zl2(S=G*9eMd0MwpCV=<P0>&>N~H)J```FS_pLQZAj6
z+MU*$*i^UPyp=A>D!p9xo$thqO7m8~^hEzg&wcLs{ki)*F|pBsL1|oqOH2~e0l;K3
z@LhqCDp+b@QNp6aSRKadF{bwSTa59C7}xsyd1B%jCYmtOg2`4GMd(Y%*D11H7I5r1
z)-WByKt9ZcFc)D^hN05PFi(6h*LTWf1?#FWWJZ!c)fKxjss+6R1`&EiphYl<(VGD}
zYqVPo<DPq$6YaU|8EjTh+fD)B3;o3~oy1@%hRQK~u|%5Uzrr0O^{_kul>x&pX?6e%
z`*v?%4k{Paei$U6B}KVwU^qlS&&t@c0`y_@9YsGG5$c2C+TqS!{p}f`4uCoceIBTM
zPzAp~=Z$wuKozDYc!QFHmSLa*<{AvCFmwwabE1M>@ud(wh0sf(KL$Mssu+4XC^?KI
zjEc`Ka`az<sm5*w3vbh)6G10lIL{6ra`7qe-ud<Dk)!8C*lKsQ3DBN|S1BWp*P~-|
zZ(}ODGNH>#j`IAWjzViZT7-C=gSSWUFcc5Mq2=LGM0)IeX!&@;&)e*drwM2iqcO~Q
zEf5+WG!eKTQMA=<@4AI1W$0Y44H~1N6++F2hX3ns<iwrG4I%URD;=O-i-uTe;-C?r
zF$oRvs26Z-tx%tchAB2ey~%3I1mK?+|3$g|W-$n&j_{pcJN*fQ{f7{@t|3Lo$wj;p
zL3P>nSI%Uex3J=hyS1G>irnx?WRu`KYk_}iepiz<*DZ-mT`KlUaN$~oNZt@eCP6rz
z-Ig|}3uiFh!oHlFV^q$qI%)437*2bU&cbtSZnNc$%4VkHFyTtuICvzN?Qr%uRj#s~
zJ>Qq`W5$r4e3E6pcKW@FZSQh(nWDL^EJzVje&a|AlVwXt0&2xC6iQ+7w~MA{&Fvk$
zW9*%>Ro)gKzeIgQ*FlF)W#!e7qMvjLrz%*IeY=VEa<p>!o_8PT^w}nR#GPk3oNYZW
ma0-%gR>lR?>XszeZsDC7J@L9Krqppeoo;sYCK(JOnDZAZBf?z(

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/core/icons/formula.gif b/lib/editor/atto/plugins/wiris/core/icons/formula.gif
new file mode 100644
index 0000000000000000000000000000000000000000..7063e8e0aab5368aa6d80284581f1d423c775786
GIT binary patch
literal 1049
zcmeH`-A_{o7{(7y8LNa~3>jXy)NPVN7Bk{505eWcrAQG`sGB;?24zFkh#((9L?jjF
zXO@5xu^I&{PNyzufKo^|O8_GYY+Ak0O?wV4%9o=A0Y5JMt$6L9;FDjTn<sfM-Y3r*
zLvmbvcDN8Oyb$IDELgfcB045QqcLV>B&CZ<=?O&@JB?el#!ZPudy|csD{GHu*sfP9
z53T+Y2NShSo@dI+)Mciw`G+nsZDYE{_FE-0oy<6y?P9iv7rppQ4E@NH0QroRFkHr1
zIb#PIH8Xyk@n86_o{0cwn6Ti#h~J98naL|WcjC=LF)?VuYeLCkFqgqRym|O`;oHqn
zAwwm1oY@Rlx_<wG;VMQ02kUueVX}p(4&+>v9Vk0dcA@M>$ww|gE<`CtDdDNev#aKU
z1mq$-rO0K-`;g0#58yT96B%w`#LAeJ@oS9V;K3dqmGih9&jCDDctqqwc&d@BmEJOZ
zwLG!#^c?rHahq`G@UWD}hq;wTUk3e~7}&zy?YQ&kGSIvBPLrO$_i%4NonO<T#VOIL
z;}0E9Jva6IX~4CPTRF5R;t;V*bV%5BICR)o)3KWNWSkpl(_`1umO`rmdn)!c+B0Zf
zOG_Fp>uC+}4Q<~B%6(h%dwcf>mc5!EBnXYd7jyC4CWMd~K@u&JFSzdWv~wG6b<O=t
z#714!%PebfSoQjg+wPizRhq@ilaD-T`s{FB)DqjN*ps<`9ShN<iz8h*N2|`pZOv>@
zOAA!$#7d=q^uz8N)r#*fg}b#bvnFO>`c<pc{lUU7H-{S3>X7@fN8<K*U4xfvK2FNl
z9W}3UN2Om#DATGNwI@EE7uFO1RiFD`$0zDX#cI6}ks`i+Q(xGV^7C2M{7LD0WPU^R
z_y0sX46g8>ZWeS^6n5th2tlDCv8kc2Po7?}?f&h)m0D4)7h?|2YpXdC8CN<R2=W#+
cr&<!EilSe`M4c$aA1nUI7$pV;39D590}M>WX#fBK

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/core/icons/general/close_icon.png b/lib/editor/atto/plugins/wiris/core/icons/general/close_icon.png
new file mode 100644
index 0000000000000000000000000000000000000000..ff52273a058a7780866264c52c2bf8e05f6384d6
GIT binary patch
literal 524
zcmV+n0`vWeP)<h;3K|Lk000e1NJLTq001ih001ip1^@s6;azdS00009a7bBm001r{
z001r{0eGc9b^rhYzDYzuR9M5!+1qi0Fc1aM3k`%4D8VIAf;)&xa0w|P9c0siOQ3@|
z6(p%3xPr}($Y?-94|cKc4C4<QamE(f6>gXrk#qoh05|BR2Qb+qm^OkW0KWh}0DJ>D
z3nNeVOZc+a87<r&X7(K&GvC-B6F4XLI5G3&8Go|xt<K4XN`XVrO>hZxFE|Dbf=i*L
z;8ds=ya$>K&V{<*&c(j)z8EFw9CEQE?~hS}&e>dNbMpqkc-GMoz|+pL?`}~b1+Wwp
z0ItiTKrEMw&`;0y#_yOJ&7wCT0MDo=p8$rrXIRcz1K_<zXsD5?0lb24H8Rq3xM+^1
zG%}9_2caq0Bf*={RO}JpC^QGF2~L9MVl}|Y(30NZRd|V_*d{S`>C)<+iW~SxL$km&
zK$F3>K$E~VL8IW>pqt<}@JL6h!<XD5t*|vfgWy&PdRGD4`OquunIuc|;ND=QRO=<j
z6@ADNYD%QQ|8sUy*)z%Q>3-ZfI~>sF(cX2}9n5I=qlI7!RWPFnEdf)k+!{q_4wzDV
z1EUB{0aI?*WfY-XU<!S{iTr8T1Gw1NtKg&2<<fSx%O2U1?@bI_RsH~&Ewk-u(!P=a
O0000<MNUMnLSTZY-se34

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/core/icons/general/fulls_icon.png b/lib/editor/atto/plugins/wiris/core/icons/general/fulls_icon.png
new file mode 100644
index 0000000000000000000000000000000000000000..27f3a30bed5c5613186d4396b310cb5065143fe3
GIT binary patch
literal 442
zcmV;r0Y(0aP)<h;3K|Lk000e1NJLTq001ih001ip1^@s6;azdS00009a7bBm001r{
z001r{0eGc9b^rhYY)M2xR9M5++2M_XKoAAsC$WI-1Ufi6IIKWQumrCIOTZ2+;Yy$c
z?Eoqm{|w26!wBqqt4^|iG_Id7?9OK0m>Ik(00p>p1<<f2+c>rbkb_@6fWVq815gT~
zC3C_Ini`<(yJIC#1y%-SW2I0gRt{xhlR#P6It7%4t&pe~*u5tkJ^>5wfWK-mbL*0W
z*-b$TR<v6gcn-D)umf;@IoQlfdt9BF6=nt>jV-J8&u61Ywy-nRD-teg2|q}7oalJ0
zNjOBLdNQ+W3i}M28a#Z@F^f2q)Cm?{;~nzfZm{O`qyh(b?8jSI2jCWQ%wvOtzn@Pn
zFxEH_p5frHPt}px!A>g@zRXHg)NYqP5?{WEg8$fj&W#Man(^Ww)Q{?tV`;)Ky^)cC
zl~_7hjirK9U}@k~*kOnG7;GIo!8QT%X=i$uWNA<}mI_s3=};9`0##sTP{pb10^nQV
k>;V*Ptm0qF&O^A~0fNn>ne-&ojsO4v07*qoM6N<$f^b8(rvLx|

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/core/icons/general/max_icon.png b/lib/editor/atto/plugins/wiris/core/icons/general/max_icon.png
new file mode 100644
index 0000000000000000000000000000000000000000..d7a30495848abbbd6cd8c81f79c1ee55071ccd19
GIT binary patch
literal 266
zcmeAS@N?(olHy`uVBq!ia0vp^T0pGL!3HGx=1ctpQk(@Ik;M!QddeWoSh3W;3@EtA
z)5S3);_%y>-n>kPBCQYi3x88!W$$60U?5h|&@$1$LV~@4xqyN1)q@S1(oEb!Mmt-J
z&3wz_Z{7PcRVC0_O3TyqLS&}61A7kBO(O#)W`{{zSo#jwyhw;^F!PjZEd4O^zS`Bm
zZ|dQD7q&@dy(s_oEBq$&^-f#e4ZlRJrWhZXa&vEURj*Xm3Xn92kowwE|Dofb)t9hF
zWAmp%;<mPvCS1`@+qA?_=;ce<?Y$;<5B$97`7ixf_zT$`$tM<iaOrLU`h&sK)z4*}
HQ$iB}t!iWM

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/core/icons/general/min_icon.png b/lib/editor/atto/plugins/wiris/core/icons/general/min_icon.png
new file mode 100644
index 0000000000000000000000000000000000000000..3c79dca3c5ff5607659a7634667a5103d7930367
GIT binary patch
literal 235
zcmeAS@N?(olHy`uVBq!ia0vp^+91rq1|%QG79IdnoCO|{#S9F3${@^GvDCf{C^*;C
z#W5t}@Y|agIS(0#v_7;y%4pRj9bsP3(s$vaRhRM$4!?xC4}M(g@ZZPD`G=k9`$uIN
zrw7wizD#QDQwm!Xu`%grm#8*^@upv9-!sXGhK+`gcgcG=O;XKG_jU3#Vmi+kRUp@}
za`LHj``D6>{*&BYnsoQnzNlS{%i9*}KZwXKV0_o>B)|K8@n+ND=KAJrSucO-W9El5
W4#%#4k;VvgD1)b~pUXO@geCx=U0L@4

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/core/icons/general/mins_icon.png b/lib/editor/atto/plugins/wiris/core/icons/general/mins_icon.png
new file mode 100644
index 0000000000000000000000000000000000000000..cb18cc9a56f02ce1585e602e3c0a4e01a9856eca
GIT binary patch
literal 464
zcmV;>0WbcEP)<h;3K|Lk000e1NJLTq001ih001ip1^@s6;azdS00009a7bBm001r{
z001r{0eGc9b^rhYf=NU{R9M5+*x_}9AQT1QD+|;S9KjLXpxK~|k`cN=bc1$-c7t?+
zwi_f9-2Ndg$M94X@b#X<j~pa^Aqn8CNFopmpa$@ab!h;6A$3TOo8@2nK>u88NnS`E
zSB#x(CNQHX@AVUaKH{^t0NwyRAVbUqG!~o{>SHD7QgC*tk3B88Rst7+`q+<!*N?%)
zpgy((@EQp|l!S(suAb>qWa%29G)CCHhW~<93pNvd>cD2E-$pEJyJK5-f>Mtyy5MiY
zs)I^cmCz7YEp&`k4F!P8J%i<dzPtBKmE#Tj0^kvPa|O^=!qe@RGypymLpuOxlVKK`
z9MB~@*xq0LFH|%34yqL!glfc!P>onCK{a9zTh6nkGg<l3_y-fgT9>XMSo5ZE2i^mF
z#md^6*#X+QBk2$gPF;^8*$K6;i!0%;t*v#XX7*dynPLhlml893CRxvnnVVrtGW*Y9
z33Lu@Z`b6+#y};o_4{*R8+X%s<@i1XC5ar*U@6juPG3I)_Zm2n!c0{F0000<MNUMn
GLSTXbQpAt|

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/core/icons/hover/close_icon_h.png b/lib/editor/atto/plugins/wiris/core/icons/hover/close_icon_h.png
new file mode 100644
index 0000000000000000000000000000000000000000..859dd52959de0ffb8901e811762e6d088e389daa
GIT binary patch
literal 550
zcmV+>0@?kEP)<h;3K|Lk000e1NJLTq001ih001ip1^@s6;azdS00009a7bBm001r{
z001r{0eGc9b^rhY*hxe|R9M5+*`ag7Fcin}FS#l3^FwcX)1Zgn^rk^Gz3HKc9)HEq
zc&3NPgJmY=LP^pjeTC3FL_-fg*K6{A>1*wFJ1*t8s`&m6=mXcl0{8(o!iK*7Z1nFh
zTo<-HceW1<OJgfwEC?O}z0%km__STDBA@^_zz5K22#OvXg<@S$Nw5p*1*=G?1h@+7
z1givS9dIbr3RcFfA12(T7;r4q1P@H?pvLnT0#1cu`U-5_+3f?@g`(H_J$5ay6xqNM
z&|-bxW50o|Aov=16M_Ov%N4Av|EQf=B$((je6V!==~BAQ5o#+6Ie`zLu5z0L_z3C?
zGUo(ap+4-nz)olt_S9f6Gz5Dpa3wSp+cY=`8iOss@50b&C^QyZH=Vh*Pn{;PBj8>b
z8x`PH1hm)C<O&9>Gee`mDg$URSY-kY0;`Omm0*<_)C*P_LY-jM5OgNIr|X#5Cqd{$
zW5<Hv*YX<~=};mWejZY?L2P=G0=G@<vcZ@q0iK)KS@G7Rp*&g#yaK+;kHI(r92}ez
z!3S*t6T687$3RoSNBxWP1PcYHKx4qxMvHAVr~=o4hJc+NAzy2$13Uwd`h2aSOXQ9&
o@B-ZG^IyHsv$n2Um(*eW2k>Q|%bHUqlmGw#07*qoM6N<$f==G;`v3p{

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/core/icons/hover/fulls_icon_h.png b/lib/editor/atto/plugins/wiris/core/icons/hover/fulls_icon_h.png
new file mode 100644
index 0000000000000000000000000000000000000000..033283e644d2e979f942d15072083b277a456120
GIT binary patch
literal 423
zcmV;Y0a*TtP)<h;3K|Lk000e1NJLTq001ih001ip1^@s6;azdS00009a7bBm001r{
z001r{0eGc9b^rhYSxH1eR9M5+*{xQ?KoExEw{z-x6;y*q7Y!ONpuV~nP~8i_$KyeB
z0qEkZNo_F8IpsgyeBb8mn5ayiv)N>3cPCxfkzx+a&_)aFRLQ34x&jvH;{e>Ml0_O(
z7j&&m7=~AW4Be@*RX`nB8&r+8LX}uMRD~@9RbjU!pepPog+hT{qzYICwisCX>#~E@
zMZpSolv^9P5B30TfY-6X(F3{$p3`+yaGX$?+D!1=js2~J=76_?5ncipkx}d0!c$@e
zTm$Ek*_4z5e_9*HfbPi+{<esX^w8Wk&jtQ*wLLl7Hy9E#;0Cxm;hv}T@%4fNjjDpR
zKqDC8Kld-x<#x!F_;;g4H4VN_i4AZj&f7Q|nVgSqw64nrc3~}GCsq!2W2N8{*bnf1
zEm(l7TCkFx^{53}0xLbMh+3ddtmX74YJobiOBWP)oQe~^0Wad5d*A`szXM4+a8f|b
RUO4~&002ovPDHLkV1n?1w!{Dc

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/core/icons/hover/max_icon_h.png b/lib/editor/atto/plugins/wiris/core/icons/hover/max_icon_h.png
new file mode 100644
index 0000000000000000000000000000000000000000..1327a7efa96f84df59948861d25608b8179d74fa
GIT binary patch
literal 267
zcmeAS@N?(olHy`uVBq!ia0vp^T0pGL!3HGx=1ctpQk(@Ik;M!QddeWoSh3W;3@EtQ
z)5S3);_%y>8+i{I2(&)DFDCj@vO#K^f+=$f!?FYsv4qYqOVSvs*gUF5`~(FrDu~=|
zEuVVY-|nQHy}GfoQ)*L)#EYyg>l)S?-~TIH#ni`VzKLDWVfL9dj8f0%0+sA$%6@)9
zkKKVO#A+UkXh?u#z4;WMb!$Hc7zEeuId`?nkrgBeCie23Gu<%z=H~xwRROQ3^Sx!V
z$e%gs#kanR{B1`hz3SqFjsElsKPawPx1GWBzt4ZJT1Mq!g=G@wGaP^(VeoYIb6Mw<
G&;$T)!CoT(

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/core/icons/hover/min_icon_h.png b/lib/editor/atto/plugins/wiris/core/icons/hover/min_icon_h.png
new file mode 100644
index 0000000000000000000000000000000000000000..88f79f90bbf9182d71a8f56b3db1d9c0d8c6aa77
GIT binary patch
literal 244
zcmeAS@N?(olHy`uVBq!ia0vp^+91rq1|%QG79IdnoCO|{#S9F3${@^GvDCf{D7ehi
z#W5t}@Y|cZd`yM{Z4b9gi@d(xd_VY2;11U12M&ii=*!)W*4Z|ri>*<4rrP`GujYM8
zS9`f6h-+`kg2f%8+F@%VHYOeILNI<S?_U3vN2bBB<2`FiLiR@Y2RuHE=3jVY8ceV1
zpN|g6;I`xa`eONm>!tiUwzeBCUQ!KvGk@dGYa3rw@@<_O+w3gw;CJ>y9^148-X!L*
g2YeH%W*O8moQaX$l^<HA19UNir>mdKI;Vst05v&XV*mgE

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/core/icons/hover/mins_icon_h.png b/lib/editor/atto/plugins/wiris/core/icons/hover/mins_icon_h.png
new file mode 100644
index 0000000000000000000000000000000000000000..af6e78843a9aeb3fe2b91cd08ebf9b59f5c0640a
GIT binary patch
literal 462
zcmV;<0WtoGP)<h;3K|Lk000e1NJLTq001ih001ip1^@s6;azdS00009a7bBm001r{
z001r{0eGc9b^rhYfJsC_R9M5+*&$QIFciS?e{)mCGrelipz(YFJ^;R&`D#Gp@$;MJ
zQxpw;v&E!bSd*sdmgMp7a<^Ny-tW5P<@K%Tx(-WR=<$u9P!4DVyaLtC>plXvv9UdL
z1(f=AD7Xgh^);elO=usX;2OA#y$o#7P;gYJiETVTn-3fvYGRiYKI;M}ftuJS;4lN6
z3<^*fdA8D!a>Dlxz?Wy~yz3Dq8?=FUctzqk&a)w45hs{fuyVXF60An%#DSG(zSX<_
zUtsGTyM7KfX~I7RD-H^<u++0_;7VeiU3ltQk$F};)GTDyzzwpa?w7$<=hSn>!<nHw
zpzX0AdYmJ!BS4?0916MP7b+e52PzpmfJ(($p|%q&cZ@!_NxQS3r<91v6F(!JA8FXp
z&X2?m<^)SkT~@H<Lty~Ufql~(DY&<m8v6ol2yaz2z@<tI-OlVwl)zGDf`)>3K&vuB
zr-J)hVXrbnec<Tz>^>0c0uQRM!toDd&Zu<XVskw41G+S2f(In*eE<Le07*qoM6N<$
Ef(1R#0ssI2

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/core/icons/tiny_mce/cas.gif b/lib/editor/atto/plugins/wiris/core/icons/tiny_mce/cas.gif
new file mode 100644
index 0000000000000000000000000000000000000000..77b1511c595d2075cc1615226b9858fa6fbf99ac
GIT binary patch
literal 1037
zcmeH`Nl#M&0EAx=5o=>GA?_=RF=#Yyi5tGQrfLNgG%nnrfZ)RBiYQ8IBQ>5-N!((T
zDngJ%SqddpK`n8O3I{bx-=i&1s0!AC;b1=d7rZ+&r#Z}FCbLPuan<V7NFh?_RR}=<
zqi00(qm;p$_$~M=@K+OfNT7~D14GRW*%@wS_$kBB`R%}Mz>`jQP&s&y(px}(A^m6Q
zGvd3z_cDHzF;LEcg~3XG*5H50FDrp&e%T4wait&|=rZ6kAg9r_m#!>aS-212&c>6E
zCzyGfp0jw(_{#WpjlnwnHl)4C`;hk|A3)AV&Oy$lD;FsbDIfU=@=;vJ`BsH=80Rsh
z0;Cg2g-AuXjJQR5ui&-NZ^3sDUp2lOKIQVYkj_G!ML3Ibib!X1nvhJ$BJNVUuhDaZ
zj#SzWw5Rd;7$1-G<qVxBI!kDa=VcOacJpcvZ<BeK&WB9evuMwuRgWVM$97%>{aiXu
z(j1FTja@^tmPcCbI-clwtfwV`wlo^o(<EZmVAEjL(xk<@0ow)|H)2nuL5EdG!)EIB
zShrw}r!k58IO^i5+eUp*J89Szobo^Zsew5op}`X%ED8}qgoq%8@IHY*%k#Cm@iStL
z(>1lB7bc3#-)t5`97>bcJTLWP#%obEDJC)RgV8a5)|9f8mrtXWC5oxb_7wj#j@c3w
zlU%VhvA88nxy&Gplpcznv~Fy~bnon2RUH)z2ht4>)C%*xZ8hPwrYg;-uqbsw<x<Ow
zh^V~DJ8LiZDNJE=wWl6vEa6wx;_RC2ajlxM_qPt!MvLxqku3?MGs_L3%E?PIJ)abJ
z79=?z?I<^m7~9@lUvpZOyi3)6{?g(MSN+vzCGT&)KFCVj_6*guHAQ|^jK@3SZd`<;
WDcREVZf2}`qVD1feTrIGtNaT-?DV<-

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/core/icons/tiny_mce/chem.gif b/lib/editor/atto/plugins/wiris/core/icons/tiny_mce/chem.gif
new file mode 100644
index 0000000000000000000000000000000000000000..f4225525f4494226071b32f467536ddffc969c2a
GIT binary patch
literal 1082
zcmd^;|5K6&0Eb_c7NEDpIPKDFXh^fX$!u4CnY;>OP!y=C)z;3il&mF|I%7FG<jA|c
z?z*h7>oiZZb~UFdxIEU>%wlV;taF<ey!g_P)N4j+xgYi!{T+Mm`4gUJiy}KYWgm~=
z5mO8z0Dzz%240@QTnqf|@OQ$09rHby@5Q_|NhH9+02b^?qBtxLVR0CXBY1Nc9u1!F
z$6o=Dtcl`;aF)SWg{c}$>oHx27e>sSl8WQ-@|^3T(Rh4E+l5joxuMNchSzq`MR02{
zsR6BlyBL!tptY~Zi{UwRvsD!y#$vOW&d~!(nGoK3_!{uy6lTt0_M*AAFexz>bG`82
z0#yR{!P+CA!2M;}-j6`(Kvlq93A(aQmkM_keNS7mClT~lczyz2Qj)#_v)|4>Jm__l
zfI1557+lq$YCs)dny6kFuLPyvwS7IPTF^#JSuov>nd_MO4u6zqrSb7h52qfkTDS~w
zk)Z0~GJ!I|L&9@rV#EaRCHUGy*i1axhcOMtilZY#@VgFwR^L3I2d4?nlj2RW7*)cN
zg9n9kxAXAp?#cdLcwCAxZEjZF-_|VL-G&i0ek;e5uQ8C0TN$ut;z!AT#cJ4P_(@j1
zI~If6F<Oj%v8N*$woKS0_(4+lS<K-b(Z0^~h_Lt2pAEYjRvB!vx82gk@1;9Gjg)=7
z5>`3-6tHcDO^N;-^ld}0lCwM*y(;tt%!jogI8eg>iI^oOgF}Ewcz43PCkWQR1lZB?
z?#n~<EN)9i&+t8xFYQ!2a=j0RI6UDs`4An$73AA2nR(<Lb7;gDeL6;#oF^#w*`hdm
zlHb5sld3gT1kMWG(sjQ>@hF246eE7y#JzL%d|Lxcn4vS6RI4{${*cSh_O=x=qeSZN
zU_(QcvQe%u9%vL4bg{%WkBS%uZgN>dyiuTDmw#jM{YL&I=?qUfoY1_|krzK`To!J2
z6Nb~ms?d}%-gHHgQK+BO(Z|C0lI9}PAHDQ}WnKA%?-jfBtSaXQ`<qv^nbVS1d7^8W
zx&F=I=Dp+Bde+`w(UIMhkYfIv3~3e}{fDP%(&k=Kb>v1`Q&&x`XiX<0;s-_?Pvdv8
NJ-@Ujiugnt=RdV@xQPG&

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/core/icons/tiny_mce/formula.gif b/lib/editor/atto/plugins/wiris/core/icons/tiny_mce/formula.gif
new file mode 100644
index 0000000000000000000000000000000000000000..ed2b920fded6697f349c9c9f8b6c7983d829d0fd
GIT binary patch
literal 1049
zcmeH`+fS1R7>7TYB11wjlMF93^+b>?M&d4jWqfU=ND*;ZH=G&=Wn)Yuf*gW~NGf=a
z2`CZ4%tHl_GiiWQNYxU+j085VUg)O%K3cRKloA9~5`Fys0{;S^_qqEezl-<HyH=kV
z6Pr0-m@jz!1O;IB!sTHrqQW904H;<(sbWHETtV3m!&bE+J-%R1qG99e>f>pao8|Ho
zvv0`8ST*B+GGS(-iHRG&!OKiqm~6IOFK4QQDLd1hOn3992al1#UwN*W%TN*C5=KfH
zIl!=q(c_Gs<W((Wif0+C$9D;z8DAsgS9xv6oq=p*z=+$3oW(#k139>J@a)91i@|&b
zi|*Sq@s>Mo{eriGVWqH^m-UP{GtrKejr<4l4&<H4yO48{@{sb83z3U>A@cH?DK8GG
z09P?m3DRDqQl$O3O?X7SbqtvqF*ACD(Z6`So2R8bE5)@RR|PH+=^(C3q)NG`1Wz^3
z>v?gGhnYByIJ0<C%(KJXOQAQ7zI6J3=E3hcbLiC5v+n*y9slm;;XXRPr(KO*Lx+~z
zTI@RR>bRrFv7UQbw8di+v1(}7VAW#NVqHV~8rl-E|3Iq_tB%$rTJ%_xv8K?LM$0;y
zQ)u2mi{g*8{-hlDGoRSN;&-!@CqVedU+@<~l@S7`1l~7jJOMS!QqFC%)HL=j5Ybk=
z%`gXqRBpJm?SV0%U;Ju$;*rM}mmaQ(SYSCFeJcB(V}X&W;!tPS(TawctsCo9n%P0B
z_;R^#curSU(8?{BL!D}eDKe^m@?DFj>x;RoHV5lfs=!ClM`HH69Rp2OUnk^hkDAsx
zBT~=Dm8ex0)F+nshjhn&+w1(_wn+7~P^A;XlEj%0wfWsihZ=%rjcaa(=hm&*{$IFF
z?+E?vZeC|uephzC;1?Viog6%K>deY*kN)mmtrk@}G3vlfTh)p1nBr+A$eGueTpy<?
XE4UIOYDFRTSmBq32+_|^_%7%p)zRc<

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/core/icons/xinha/cas.gif b/lib/editor/atto/plugins/wiris/core/icons/xinha/cas.gif
new file mode 100644
index 0000000000000000000000000000000000000000..9f1e1354623547bb4f62c35070734dc388f909e8
GIT binary patch
literal 1037
zcmeH`+f$4I0L8y0$=We7hTMsaiD85pw|u*67OPN<OK-K6a_Q!ph-U3*ji=Cz+ZbA+
zp&7btZL=tB<2tDxFtp#-?p9livbIbQ=4bx}@6I_-=ixk@GiRfI!^%}D6NCvuk3t9n
z7&Rk`A0-Uj#Baf0j{gCH#{{Yg)H2w>pq-&6hMqI@lHU&820UqW1(l8WC_VY~70`Ev
zUL(E>d@tokDg9;iTNt>{&r1A{`DG>0z%M%iJFaA81Dyt32IN#a_tKe(D--tt+*x??
z@B}kY(|s1N8DA;it}#%J--fgoc^~qA<O9fA$l1s_bmk!CBIO|;K|YG>INvIe4&ywA
zl#g@*sQ{@Eml3x}&lS8D`YibF;d_9ul218&Euf<SXCclaoFdX$oF*g_vWUBcu4{DP
zpgn~)18u2%KE}u6d^tmhiH>5L<9VIPyWPCm!}}y!(rC?~Et9rvn)Ep0aBSyQ(9fa$
zBn`3H)YvsNXnCT=uH%`Gr+ON<(40!$I_gEN8f+S@TI#h}*JE2x-3IIl)atP6sNF=3
z9_wbT@zf<!6GwGC)!V2EYA3b3f>Zv-KQ%CCI3#!ighdKLA%q7hg!KyiS(c~Ojhhi`
zoUW+~xiCp&{wA|H!l5*2&GS+&roR<clcN)ITaAu!v!;|LzkVL2ELKd7*;Dk>IC^tr
zbW-`!grde!WsE@>E;$r6dF`0+>E7A5D%#5z_NN&hsTJmX+bYAVOck1up^@tR`%5ja
z!XtAdc2-^PRhUBOYEM1VSi-KV#o3ivW1BQ%9&R11iW1%DCN^#vl~HC0QARAu@O)C-
zS&-;_vZKs2Y;1maef4Qo(k@lk`Adt_T{Tx<6o0t=_8=>4+tXFkRu}qJ(H`&kyK&);
W`Xozt%gk8wB;Cd3`ee1RM)?;k==8Jz

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/core/icons/xinha/formula.gif b/lib/editor/atto/plugins/wiris/core/icons/xinha/formula.gif
new file mode 100644
index 0000000000000000000000000000000000000000..1e9ff9ee4fc9b7b8cf2faa00bf7c9b3e9b825e0a
GIT binary patch
literal 1049
zcmeH`+fS1R7>B<)MMOeSLxvYK-Bf~PF%owHnDMohB1J^89yT=_l!>SjK@LGgBprB;
z2`CYPc&g}}&ZGfKA>Awij3nTpdZC;4`)JW}P)ZO`N%YzG7wj+C^FDXK<ahDDdDj>c
zV`4Mr3-bk^N>Bi1eYG@fSyWhLq%l1$AyrIBjmt0HW8AJWZjH}BkZ9bvvg%Zt^>&&3
z+~Oa!Gg`&iMaC_RUuXQ5f8ZJuRwkOPzn3xD&ZL8>4yL+z-;LMAz%RT~%wez)Uopca
z3?E_0%*ZK5&hWN|QN;_4*5SX3--5r9vEO*-z>|(_qThtagq%r#7X8_HvhnW4yN`i9
z1_~cJGVql-@BECfoFS#KhBtMLH8I|Xl!d$-c@Oel<bB9FNV!OP$OXuSycT(L)0`WJ
zl#jazsTk=XQVG&wJZ8KizFGz?3|knv#mFB#+s}&<UY6iKjJq7Si1aJ&3Zx3TyBKd3
zuj+W+z>^GICR~|3FXH7f?xoO^M(<Yoe&q2kT-kIO=wAEiik^r2d2)#M?`hNE(9*8s
zPaO_DclG>bz`2flnY6}Z7qMw+(_+(M*I`>t+iF@9acrPPk4;ZY63qr|$=Fh8O`~}&
zO(`_3r&)0`EnAf1{?C7G;Ombwl_x;>Rwbx}P-TR`Nr6xGT5mx0l9Yx`*6POIg(AB0
z59yYGkc#zJcRV%)^oa|WCLVuwW%04<h=ta3(Py(BoD7Ui6$d*qPn6fkY~NU`*3Jr2
z$Ct^yL$f<8gO+c*7V6SC&5==k6CazkonOpd@k6jdtqyz|eLUu%$Ju|q^2>xA-3jv=
zS48TixMGd^vgY(RGeWvzzw2@RV_&3xQJ~ffVM*fj=bF5(q@(pgGsm>I!*gnv{q%RZ
z-QWz}c{jJCG_NzOPf!I1MkfbPpFO{P$J6^gD>b58FGd}iZmm2W9#b@>1ljW%lk4KN
XrTI5PM4c$ao-CMSj1W~SVO7w-!-eEw

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/core/iframe.html b/lib/editor/atto/plugins/wiris/core/iframe.html
new file mode 100644
index 0000000..0ee841c
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/core/iframe.html
@@ -0,0 +1,61 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
+<html>
+    <head>
+        <style type="text/css">
+            body {
+                cursor: pointer;
+                margin: 0;
+                margin: 0;
+                overflow: hidden;
+            }
+        </style>
+
+        <script type="text/javascript" src="../integration/editor/viewer.js"></script>
+
+        <script type="text/javascript">
+            window.onload = function () {
+                var myIframe = null;
+                var iframes = parent.document.getElementsByTagName('iframe');
+
+                for (var i = 0; i < iframes.length && myIframe == null; ++i) {
+                    if (iframes[i].contentWindow == this) {
+                        myIframe = iframes[i];
+                    }
+                }
+
+                if (myIframe != null) {
+                    var viewer = new com.wiris.jsEditor.JsViewerMain('../integration/editor');
+                    viewer.insertCSS();
+
+                    var formulaContainer = document.createElement('div');
+                    document.body.appendChild(formulaContainer);
+
+                    var mathml = myIframe.getAttribute(document.location.hash.substring(1));
+
+                    if (mathml == null) {
+                        alert('Error: MathML attribute on iframe not found.');
+                    }
+                    else {
+                        viewer.paintFormulaOnContainer(mathml, formulaContainer, null);
+
+                        function prepareIframe() {
+                            if (viewer.isReady()) {
+                                parent.document.wrs_assignIframeEvents(myIframe);
+                                myIframe.style.height = formulaContainer.style.height;
+                                myIframe.style.width = formulaContainer.style.width;
+                                myIframe.style.verticalAlign = formulaContainer.style.verticalAlign;
+                            }
+                            else {
+                                setTimeout(prepareIframe, 100);
+                            }
+                        };
+
+                        prepareIframe();
+                    }
+                }
+            };
+        </script>
+    </head>
+    <body>
+    </body>
+</html>
diff --git a/lib/editor/atto/plugins/wiris/core/modal.css b/lib/editor/atto/plugins/wiris/core/modal.css
new file mode 100644
index 0000000..5928e81
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/core/modal.css
@@ -0,0 +1,297 @@
+.wrs_modal_overlay {
+    position: fixed;
+    font-family: arial, sans-serif;
+    top: 0;
+    right: 0;
+    left: 0;
+    bottom: 0;
+    background: rgba(0,0,0,0.8);
+    z-index: 99998;
+    opacity:0.65;
+    pointer-events: auto;
+}
+
+.wrs_modal_overlay.wrs_maximized{
+}
+
+.wrs_modal_overlay.wrs_minimized {
+}
+
+.wrs_modal_overlay.wrs_stack {
+}
+
+.wrs_modal_overlay.wrs_modal_ios {
+}
+
+.wrs_modal_overlay.wrs_modal_ios.moodle {
+    position: fixed;
+}
+
+.wrs_modal_title {
+    color : #FFFFFF;
+    padding : 5px 0px 5px 10px;
+}
+
+.wrs_modal_close_button {
+    float : right;
+    cursor : pointer;
+    color : #FFFFFF;
+    padding : 5px 10px 5px 0px;
+    background: url('icons/general/close_icon.png');
+    background-size: 10px;
+    margin: 10px 7px 0 0;
+}
+
+.wrs_modal_close_button:hover {
+    float : right;
+    cursor : pointer;
+    color : #FFFFFF;
+    padding : 5px 10px 5px 0px;
+    background: url('icons/hover/close_icon_h.png');
+    background-size: 10px;
+    margin: 10px 7px 0 0;
+}
+
+.wrs_modal_minimize_button {
+    float : right;
+    cursor : pointer;
+    color : #FFFFFF;
+    padding : 5px 10px 5px 0px;
+    top: inherit;
+    margin: 10px 7px 0 0;
+}
+
+.wrs_modal_minimize_button.wrs_maximized {
+    background: url('icons/general/min_icon.png');
+    background-size: 10px;
+}
+
+.wrs_modal_minimize_button.wrs_maximized_hover {
+    background: url('icons/hover/min_icon_h.png');
+    background-size: 10px;
+}
+
+.wrs_modal_minimize_button.wrs_stack {
+    background: url('icons/general/min_icon.png');
+    background-size: 10px;
+}
+
+.wrs_modal_minimize_button.wrs_stack:hover {
+    background: url('icons/hover/min_icon_h.png');
+    background-size: 10px;
+}
+
+.wrs_modal_minimize_button.wrs_minimized {
+    background: url('icons/general/max_icon.png');
+    background-size: 10px;
+}
+
+.wrs_modal_minimize_button.wrs_minimized:hover {
+    background: url('icons/hover/max_icon_h.png');
+    background-size: 10px;
+}
+
+.wrs_modal_minimize_button:hover {
+    background: url('icons/hover/min_icon_h.png');
+    background-size: 10px;
+}
+
+.wrs_modal_stack_button {
+    color: black;
+    float : right;
+    cursor : pointer;
+    color : #FFFFFF;
+    margin: 10px 7px 0 0;
+    padding : 5px 10px 5px 0px;
+    top: inherit;
+}
+
+.wrs_modal_stack_button.wrs_stack {
+    background: url('icons/general/fulls_icon.png');
+    background-size: 10px;
+}
+
+.wrs_modal_stack_button.wrs_minimized {
+    background: url('icons/general/fulls_icon.png');
+    background-size: 10px;
+}
+
+.wrs_modal_stack_button.wrs_maximized {
+    background: url('icons/general/mins_icon.png');
+    background-size: 10px;
+}
+
+.wrs_modal_stack_button.wrs_stack:hover {
+    background: url('icons/hover/fulls_icon_h.png');
+    background-size: 10px;
+}
+
+.wrs_modal_stack_button.wrs_minimized:hover {
+    background: url('icons/hover/fulls_icon_h.png');
+    background-size: 10px;
+}
+
+.wrs_modal_stack_button.wrs_maximized:hover {
+    background: url('icons/hover/mins_icon_h.png');
+    background-size: 10px;
+}
+
+.wrs_modal_stack_button:hover {
+    background: url('icons/hover/fulls_icon_h.png');
+}
+
+.wrs_modal_iframe {
+    display : block;
+}
+
+.wrs_modal_title_bar {
+    display : block;
+    background-color: #778e9a;
+}
+
+.wrs_modal_dialogContainer {
+    overflow: hidden;
+    border: none;
+    background: #fafafa;
+    z-index: 99999;
+}
+
+.wrs_modal_dialogContainer.wrs_modal_desktop {
+    font-size: 14px;
+}
+
+.wrs_modal_dialogContainer.wrs_modal_desktop.wrs_maximized {
+    position: fixed;
+    top: 50%;
+    left: 50%;
+    transform: translate(-50%, -50%);
+}
+
+.wrs_modal_dialogContainer.wrs_modal_desktop.wrs_minimized {
+    bottom: 0;
+    right: 0;
+    position:fixed;
+    top: inherit;
+    margin: 0px;
+    width: 250px;
+    margin-right: 10px;
+}
+
+.wrs_modal_dialogContainer.wrs_modal_desktop.wrs_minimized.wrs_drag {
+}
+
+.wrs_modal_dialogContainer.wrs_modal_desktop.wrs_stack {
+    position: fixed;
+    bottom: 0;
+    right: 0;
+    margin-right: 10px;
+    box-shadow: rgba(0,0,0,0.5) 0px 2px 8px
+}
+
+.wrs_modal_dialogContainer.wrs_drag {
+    box-shadow: rgba(0,0,0,0.5) 0px 2px 8px;
+}
+
+.wrs_modal_dialogContainer.wrs_modal_desktop.wrs_drag {
+    box-shadow: rgba(0,0,0,0.5) 0px 2px 8px
+}
+
+.wrs_modal_dialogContainer.wrs_modal_android {
+    margin: auto;
+    position: fixed;
+    width: 99%;
+    height: 99%;
+    overflow: hidden;
+    transform: translate(-50%, -50%);
+    top: 50%;
+    left: 50%;
+}
+
+.wrs_modal_dialogContainer.wrs_modal_ios {
+    margin: auto;
+    position: fixed;
+    width: 100%;
+    height: 100%;
+    overflow: hidden;
+    transform: translate(-50%, -50%);
+    top: 50%;
+    left: 50%;
+}
+
+.wrs_modal_iframeContainer.wrs_maximized {
+}
+
+.wrs_modal_iframeContainer.wrs_minimized {
+    display : none;
+}
+
+.wrs_modal_iframeContainer.wrs_modal_android {
+    width: 100%;
+    height: 100%;
+}
+
+.wrs_modal_iframe.wrs_modal_android {
+    margin : auto;
+}
+
+.wrs_modal_iframeContainer.wrs_modal_ios {
+    width: 100%    !important;
+    height: 100%   !important;
+}
+
+.wrs_modal_iframe.wrs_modal_ios {
+    width: 100vw    !important;
+    height: 100vh   !important;
+}
+
+.wrs_modal_iframe.wrs_modal_android {
+    height: 100%;
+    width: 100%;
+    margin : auto;
+}
+
+@media all and (orientation : portrait) {
+
+    .wrs_modal_dialogContainer.wrs_modal_mobile {
+        width: 100vmin;
+        height: 100vmin;
+        margin: auto;
+        border-width: 0px;
+    }
+
+    .wrs_modal_iframe.wrs_modal_mobile {
+        width : 100vmin;
+        height : 100vmin;
+        margin : auto;
+    }
+}
+
+@media all and (orientation : landscape) {
+
+    .wrs_modal_dialogContainer.wrs_modal_mobile {
+        width: 100vmin;
+        height: 100vmin;
+        margin: auto;
+        border-width: 0px;
+    }
+
+    .wrs_modal_iframe.wrs_modal_mobile {
+        width : 100vmin;
+        height : 100vmin;
+        margin : auto;
+    }
+}
+
+.wrs_modal_dialogContainer.wrs_modal_badStock {
+    width: 100%;
+    height: 280px;
+    margin: 0px auto;
+    border-width: 0px;
+}
+
+.wrs_modal_iframe.wrs_modal_badStock {
+    width : 100%;
+    height : 280px;
+    margin: 0px auto;
+    border-width: 0px;
+}
diff --git a/lib/editor/atto/plugins/wiris/core/poweredbywiris.png b/lib/editor/atto/plugins/wiris/core/poweredbywiris.png
new file mode 100644
index 0000000000000000000000000000000000000000..006d0d3fc0b3a69440f8df374148f4bf9300d7dc
GIT binary patch
literal 5223
zcmV-t6qxIYP)<h;3K|Lk000e1NJLTq005H!0018d1^@s6<Cp)o00006VoOIv0RI60
z0RN!9r;`8x010qNS#tmY4c7nw4c7reD4Tcy000McNliru+yw^<1}v1w<+%U=6ZA<$
zK~#9!?VNd#99MnEKfmstnZ30uX?L}UP77J54`N#m$aV}A0fTWUaFI}k#10`QK!R4r
zI29mDr78hq$*O>Xa)=9Jz?hT-Hij}3r%h~pO4cn|w^qBehxXpto$2oP%OBm-({rpW
z8#|UMzpc^EzJ7hZ_kF+L_xF9jC*d_-dj4(oMzQsuv9wSr5_||hQsK7<f&@(vG}d0C
zYgl2G6&@ozKi^8w@cjIJrR4cE_AjczC;B^f3{yCsZ=;|Tz6Wi>bE0<PdHL%{?X^(<
ziWfy)3+FWnpf3Iv;aK}7ekw@=wn1%!L;#6_Lo5U>fFlA*{%am&ph)Z*RsobE2o@@!
z`Qs6Itmu59aIFZ}sv#f%HHCo=>qPUQkr<c^s-_4GR=iCKFhv#B0*ExMBVPZCLMiA+
z>$L`?fm^8;_?iXliUtiS>NAOcVwOV--{X^3m4Zczw~t>tU#}9ojunB=5(^0}n1&w^
zM6BRg_&u_gDn-U4es`q+()^FcpGqM#iP7)!_bh&cSMrm8uGbuxe2-OtVAxaEWl|Un
zE%r09q0pjE)-uNwAMe7zM^_eNE;J5gi7+M-Shzgy^1xCpxXFCG!edFng-RKoDVZx}
z$5o^l`Wmym|4+pMNO$pWRX(f2S1h<$g<a(MeA|~9IJ%LlsxiI<yhDTulrPNN%>C&u
zK49Rl+c)#}^exn?;b9fFwQu6ip7ned;mWoKu1Qbur(*a=g-+o9d7HUSK+|1pGw=+s
z7?|5O!S(4nHmULs5yma}Wb0-g1L)nrt!ns)z(Ivy17NdzX1lA1okS8<;S2{g9_qU#
zW1+<;v=dl%6<C1<5%s`$F{5S`4W@`7b`tDVXoUpw_pux-I}y1z^|FY`6|A701j`BC
zRGjY=xRV%-aVCQp594J)-3mxEU?q|8o@#vXrcpmv(lrJVtMJ^GUHo48w~d{zs%HgC
zCp`5EgtZoQD*O=TV<b2Re6ebjdlB9b`~sMx@ZD2g93;5@+w^+uwBdSSou%x1{*$Cc
z=mNgiGsYSVwi)=12){(RHNBp#M`y89$9Rvx<zZKRwy%ya12>4p*MWB%<xXI2x{D8}
z@<kE01M`4?2i(>%4pesDiru(~+Kc{*)S@dRKjKfM$?U$5?6F^$y8$&=^_|qL{&T7p
ztc$?q4jy1?-&VZ--5^%6t3hz)uAut->qyK!KQQtlc*94?c0YzQYZ0l=KaK{<?b|_S
z-!{CFqd0R{P_z8cNX%LO0!$=sNEP*_@iT*DPd-le(8Kr>J&4$-@p0xZr{=;BlWcoq
z*xYCO@XyFR_ig;~-e6KB>!@0I6;(^$j?=UVD>Vz8YOw6k1s4E^H-(uTB-i^aQ~S2z
z_U}O~yMoCq0Tap^gelu_Y4a9(d%9RBu&#eSTYceu0^e@k%!j+z)9wh}qP)vkJR*t=
zETS2on*d{=w$9-?ph+ygY8yVIFqLiKJ&QJyO?Ppv2yab{ki)`8IUzQ01!~psHQ+zm
zHu3572A)y4cjz<B%H~*)a8M^$M?E#7^aFe4Zrqs%!XU{S?7FrBfvuZIa`ZTE{~r9w
zfyfmB7~_#zu#TGZuSJ~d=p4JQ4S(bqZvXD`KC~Q?^DZLQaXI3o3T}9^AG^Mj#N6|-
z>*f{Ow_SqMzXyN#2+pkeICGX4A3s}H(zJwB$7Q(7-o@lIcauBv3sij)trw75ctrq^
zuq505i0p~S@Wy&bcCMvv?I!|&pH*qZu4^OFx`vun?`QJ4dzsvR4>~<MBcQBslC4JA
z(Y%G;&{AYknmvmP05QT31T<ks16b=AdH_71Hv?CoY_p&S;YQ%md3Uf|;W8juHO`Lo
z2KE8<Ds);lt3vPc-FbH~X?!jMlE4RhH?UuoF93GVXFkFu2)}H<o6K-MV}Og4^QE}S
z_lA$+_U}WzY>ZD?IE{<3XDvX~FA9k4niibK1w}xL25<IK5>4loF?OqZ4t9M<5s(19
zfxURA4}jPeEKL|)>6zyD*_FiXrPQzeBvnh_Q6e#v*fv#??H5yb*~bGQy#%>H61CL6
z@o%Vq)2&$b9W!3T8Tt&fvM%$19RT`K5^1<lg{_vMN&`-KGMK?!Apr!BdgJs+9SGcp
z@VLOE3LgcQi*iGF{VL!|G29v148uVzJ_KNd2LLRgD(sIfq8y9{#$v=a*eHhqW{+|a
zLK3aam-22%#KP@+j$C>Nsm`^90hqgj#GGa1x_=jNl29XZW}k=Cw6t;uHLt*)dp_>)
zAp|?bl24*}1&Nl`#lgWuFW%TmFzyUsiRnOPhkVrc0vA&jSO{1SVihYncEfxUi>@M@
z-X6*hmG76F|0YuN-&7K%n1Bx%uN)j9r^@rMpvtCd$y@P;o+q>OI}w*G>Z_?Nt1Sye
zxgvcFYtx1eKuRpWYm_HM@lkH>y@gr~Uj)X?G+R6GCX?=BMBx&Y8x;(&3g|mMi*4bn
zY!_JN!qbj$8*m90*9xpgIo7_3<KcVl#KIudqa0D;8^BLGZ|8yDE=~gP?%BXY1QrXO
z0ZavsXyJ_<#XEg~RL3Qel@KR|Gy6R3h7SCR{wQ>}>pP2FVv*@iHelDcBgs0{&xSL#
zhD75M?Aq31t2BB7fAj=aYF0&MM~lMr;*#xohRp8!@P>~R2z6-5#7SZ|bW*eIT2c$I
zMC^h!tXi-R_tX<b!A0DH+OrnmG%hNx_NK|~{~?(j-^3p~6_D+CVBu8bG_Roc;+v>i
z{FcI@R6SO03zDctv*YD`CBmBU`;%(;9dJGH&9*!Ear-6)1-=K|gyB~}hYB}#-o@##
zb9#VLo#6WdBjNM^*Q$-=LMyaUV6G#a1U{kgtM*L{qO5`fAlkNY4A=sEPKD=y6+YY-
zUhiJuDp8&T8UY+<rbtc-!A))wf4m1XJzDG@=3PjlWldow+exh2W~{2l%2%`;?3!k*
zs-{Q;bQ%|8H!dupX$F717jGgRL|_$Mf#j9$N>DQ{njJ-_hJw%Z5GFH(W`;21y|~>^
zFuDC6vL_xbI$shs!2l;~E5g^RZY+B@Gd+qoupfWq1nT92zQ})!L35M1-A|C&@!#Zn
zw--+b)fqKVM}*bD)aeGUZ5rh*SY+Ba@kqWw>t;UGcMJDmX!hZ;j!l8f3%lh8$HH&D
zo6Pascr@v8b=C{qB|zsEb`0FgD&OM@%jVgZFY$aRsodyT0Y8fXwV4e)8~A}`n1jvF
zJMUl;p#4t%spnH{MHy5ZwJgqSt_|E?`9#!EL<BW1-q2yZ(UT;rXBS*UO)F00A|z1_
zeio~`DX=^x+$V1C?D}@>+E)DWQ;22b)OX_4cN7m$ZWMp?I82WqROYAwN0S)_Bji+(
za$eAuB$P2VJC2ziqa>_EtVEGZD!OVegSwew_gLFZ)v{~wC;P}9e+11=fSo9g*2E^)
z^EBg+Zz9=wIg+f$pX|du@mtiLm@%4L1MCZ}$-`9A%I@Hol}_&1Oa$A7UtpNL1{5pJ
zx6=dMAFqppwWR*H73;U~Z0ygIXAt${`aW*|F5JGIB<EdNcpoQ)RojYH)rdddgEMCt
ziRKl>>r5qrpWV0!d)5Nzc^d2_QrC)AGq>pOxxSs``get-*92fF>q|xO&%C^$f#j-@
z1qhc%5bTBy?1s*=B^%961b`?vt9Zjlu&QR2)u%cxBh_&kerAB|iN}~e^i$m4?Pzwi
zuq@-d<hq|C*Zov6e>;OT&?(B#`9mssOl5{}2loZxdTmS8kxtX1fH#fz;>>;nPUGSj
z4|ee<`w=@Cons~Iup2s%R2`D6!>R8;oT`{i<>Cz;!XG_>g#1h^MOTsQD?esc&BkfH
z2&<+ge1XEcnw6-*nZ1<Mf^|jD8i05gx!&zKjSFS~r(yc|BP8ZsL~6mhG6B-AX{KiR
zb<`}s4vddK*^hhrAl|?pay`$GOYcCZh7l`K2I4X>wQc6SKPVuD112J<oxtteNv`)9
zs+YdA@X~XZ<21bif1)3!X>mzJmS+0Iqa<c6EC4W!1f8a(SXHw~mPB#h@KL;xqmkgJ
zFCqL+G_NGlyz<2@EoBDD9{dq*&r>+Fm(1v<-QMj?Jb4$0O=|ubbSBHju5ZJxZ-Yfw
zMfb?;`5!X7?!!#<y`W|KgEB{2vS?~1`te7OW4vjs(3)6@>ag=oS)}9k?_%n}L&&ms
zky@}WCKfIx(Xs|fRAU$MCB+{*fj`zABdO*LSpWT3@YS6pm)=2U*L{J^Vayplr-+4n
z>M2Hk^7o{cyoKuJ*O6#lgO#j*!F$;?bE&`dV^p8_HYT3Fo9ROjgP*HN3eOoZ^>%TM
zDht~0<m)d-QiO)Q2`_^gKZQ;YLoEDHc3g@xdkIq26!Qok-tbZU!Tq=`tMD^}*m-Vb
zB}jIz4M}R;i}?8Cz4()T1=l1qKbNRh<Wpx`rjGoaiKoAg89E$tFoVijsGydE=Ej-c
z{{YkbA4IB~NX~x~)yuCV*>*8jvhK_-Z1x+dfAgo2WF1p`zF#aSoO6~*`Md~8cp1PH
z3X+PTYRC=jCpmbaNK0}W=0izD<_#Uj8#w~DgEz1jw{I8r;;SQxATf7E8E^2%PT~$7
zMBS-y;g%T_(?oT~G50frcq2#A+(Z<i*$wjpt`-w3tCzeD%Skcu)YtF^_RO65@IsR<
zbDHUWKVW+I{g9}}X<9;}Wfe~IN)j!rNz6UJOj59GTS(5ki0tu4F=HpotdnzY;0Q?z
zs~`|NUoHZkcY6N7UcCOju;@?9qMD)s9XW<SdJ@DA)$HS_@uI;jwMqcF-e+-pp9>aB
zi!vT73}EQyDkZFWgZr6y=0EX<4u;RAh*M4N1vgN$=7WfxipX<n!4>#pr<fc&g_$0H
zX<3ybft(OZ3f}Nhyy2tB!5@QISaogGU3xP$E8kbtPtKfWIJ3_qH*%~nd5YHNUgeVh
z6bpeml$zcye$>03t^Mm+3edZrt-W1=@*TRvul9EFz!{y17Gp|{AIJm)`(_5TpTnQ*
zLo>s{d43Kv(T|xLo_RTWdKiD?SP)KYdD>Vx!WG4Y!sQG)lbRrX#2CnqGx6*<nB4I#
z)Xx@?-|FS>rE2B%AWkTQ>>=Cz1b*f;{?zF}6YATEH++n<SqY3Ue4_?4dYsJe`^lbs
zthk+16)Nz0j=DLARTx0H2Dk^|Mqfw(?*SSSt_0}$6f1z66+R~~kc+B$mm)!w;tlM@
z?cZ6VDHW4ifBY0CJAznFz@Nsu@h8*RwapdJ@rDlL4j%~;)1+W+w30B8&rv#~1&OE9
zg&CV(j_mPAaOR#*YQdG!fQyr&dgXiZCwrORyA3z}ETa$aM8t_wck$g|?d>I5cZ)>p
z1tgkR6;Gh-D4H9uXot=XFd0^d<Ng=(HuGS*i-f}a!@5JNyc58(Sg$aVHQaU9eWF1U
zqsflrkDbC~$FNcjW$oO7y)nxb45&YJ1aJ5-$(A)0<QpGvtQ#}lix>@VB&7?w%p`-)
zsDB5%N}?qh0la~I<WBrA$(Gef^_;@s)pyW%^}ph;{RhnS$jiqN#KNkX6D%Q>a=YOp
zcq7Nc1j2I=OaiMFjP3BNuwz}6x^U^`dEln*k26Q%LkM>*-on}STr9Fue;R-E1ZJ|Y
zBAC4Xy?6ur140{e6Eo3^KXM%P-SXuMlfxhD#!U8w3&|4OM4~eah|#8kO5|LL^1U@r
ztHWzf9e6O{F&E!hW<l)QmLg5;l`4K_fLz~hOt?s17BHS8647d4u=#fKOVO9-mrYbS
z1UPnzzXL2Umd<h(#J*_Qa(z3=_3bQf0Qh6wxFbhVlZ!xTOkmR7{@u9!JIjf8`Z?V6
z_JG?MAAB$PZTzCe&{89mC*bAAsdzVul%}hAS={5l33R2GNw0b_#Tz}r#N%56SwQ`B
zQ?%6UvD3<OpsHs*?-k)f;1b|p0L1WoI0-(1@SXXaIrXB=cHY&E_cFD2D|TI5kl!O<
z+zF-*|CHRx$Ai?|{9>_yiiO+1m#ITP!>Vh;sc#P>pTkTYd=PhVUs0r!C*I!BA>85T
zNwlntI8LtT>0kvuTrcy7kKoj|MOM=t+>bYUoFIQJ-2N2X$|OK8y&ZOZ6P)Uz^~P7s
z5={+}JM|RP2OlDL>Pd8Zj5ASHd9}gR-NiB+4j_CB<uAkP-#HF%Z@!)Jlk2H=B*-98
zVP*R!_7{nrcdXoqZT=bi1zu7F6|0aGrUt<Zw#C^=aH;~w677pC>>N=OY%I`tSnVW(
z1pbn4j5Yw|6VJjZPAnVjBwz*geikt%)U6bxB>7EE$eW0)l%PQZ9RyhqcA{`RPr6?Y
zh23}2>^SO8N6%fFm{(?1bIz-8nOsA^?QpfgQ^xQWOK6{J;Ae|BG7Vr`tVHnz9%?HA
z(u;9-1x3rkN>r2I#T)HhA^=zD-3lOy=`of_$u&*MJdMpwI~jnq<Ou{nuzX>PaNhdl
z9h$`cmMDTSh3!k09c;REry!RpsO~Sf>$4oJRQ-!O<y8k$NTz=s{`qwLSWg%46XmOb
zVDY)%kCuh5L-GVWpED#8dK802;ObNa)C$$~08}PYu%%#7VtGfE^&=_KP^F+JMZ0?Q
z?pR|{oQ5{dgefV-yefaG{5zcOcBEHU;W>wkz(;@vRW`QWafW?zXC2rDYgs|(7wm|M
zyFyGf{ECSQdGT$W8o96h|1TgaGqVPX{f`4NmAur>Y0RBTl*dH4K~qb1EXS;v@_Ko_
hyk1@}ua}DD{{Y~|aQN~WEfoL&002ovPDHLkV1g(l7#;us

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/db/install.php b/lib/editor/atto/plugins/wiris/db/install.php
new file mode 100644
index 0000000..5861031
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/db/install.php
@@ -0,0 +1,58 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Atto install script. Adds WIRIS Editor icon to Atto toolbar.
+ *
+ * @package    atto
+ * @subpackage wiris
+ * @copyright  Maths for More S.L. <info@wiris.com>
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * Enable WIRIS plugin buttons on installation.
+ */
+function xmldb_atto_wiris_install() {
+    $toolbar = get_config('editor_atto', 'toolbar');
+    if (strpos($toolbar, 'wiris') === false && $toolbar && $toolbar != '') {
+        $groups = explode("\n", $toolbar);
+        // Try to put wiris in math group.
+        $found = false;
+        foreach ($groups as $i => $group) {
+            $parts = explode('=', $group);
+            if (trim($parts[0]) == 'math') {
+                $groups[$i] = 'math = ' . trim($parts[1]) . ', wiris';
+                $found = true;
+            }
+        }
+        // Otherwise create a math group in the second position starting from
+        // the end.
+        if (!$found) {
+            do {
+                $last = array_pop($groups);
+            } while (empty($last) && !empty($groups));
+
+            $groups[] = 'math = wiris';
+            $groups[] = $last;
+        }
+        // Update config variable.
+        $toolbar = implode("\n", $groups);
+        set_config('toolbar', $toolbar, 'editor_atto');
+    }
+}
diff --git a/lib/editor/atto/plugins/wiris/db/uninstall.php b/lib/editor/atto/plugins/wiris/db/uninstall.php
new file mode 100644
index 0000000..cc95442
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/db/uninstall.php
@@ -0,0 +1,55 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Atto uninstall script. Removes WIRIS Editor icon to Atto toolbar.
+ *
+ * @package    atto
+ * @subpackage wiris
+ * @copyright  Maths for More S.L. <info@wiris.com>
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+function xmldb_atto_wiris_uninstall() {
+    // Remove 'wiris' from the toolbar editor_atto config variable.
+    $toolbar = get_config('editor_atto', 'toolbar');
+    if (strpos($toolbar, 'wiris') !== false) {
+        $groups = explode("\n", $toolbar);
+        $newgroups = array();
+        foreach ($groups as $group) {
+            if (strpos($group, 'wiris') !== false) {
+                $parts = explode('=', $group);
+                $items = explode(',', $parts[1]);
+                $newitems = array();
+                foreach ($items as $item) {
+                    if (trim($item) != 'wiris') {
+                        $newitems[] = $item;
+                    }
+                }
+                if (!empty($newitems)) {
+                    $parts[1] = implode(',', $newitems);
+                    $newgroups[] = implode('=', $parts);
+                }
+            } else {
+                $newgroups[] = $group;
+            }
+        }
+        $toolbar = implode("\n", $newgroups);
+        set_config('toolbar', $toolbar, 'editor_atto');
+    }
+}
diff --git a/lib/editor/atto/plugins/wiris/generic_wiris/generic_demo.js b/lib/editor/atto/plugins/wiris/generic_wiris/generic_demo.js
new file mode 100644
index 0000000..785cd12
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/generic_wiris/generic_demo.js
@@ -0,0 +1,255 @@
+// This file belongs to a standard javascript demo for testing porpuses 
+// so coding standars are ignored on this file.
+//@codingStandardsIgnoreFile
+// Configuration
+var _wrs_int_conf_file = "" + M.cfg.wwwroot + "/filter/wiris/integration/configurationjs.php";
+var _wrs_int_conf_async = true;
+
+// Get _wrs_conf_path (plugin URL)
+var col = document.getElementsByTagName("script");
+var scriptName = "generic_demo.js";
+for (i=0;i<col.length;i++) {
+	j = col[i].src.lastIndexOf(scriptName);
+	if (j >= 0) baseURL = col[i].src.substr(0, j - 1);
+}
+_wrs_conf_path = baseURL; //  + "/..";
+
+// Load configuration synchronously
+if (!_wrs_int_conf_async) {
+	var httpRequest = typeof XMLHttpRequest != 'undefined' ? new XMLHttpRequest():new ActiveXObject('Microsoft.XMLHTTP');
+	var configUrl = _wrs_int_conf_file.indexOf("/")==0 || _wrs_int_conf_file.indexOf("http")==0 ? _wrs_int_conf_file : _wrs_conf_path + "/" + _wrs_int_conf_file;
+	httpRequest.open('GET', configUrl, false);
+	httpRequest.send(null);
+	eval(httpRequest.responseText);
+}
+
+var _wrs_int_editorIcon = '/core/icons/formula.gif';
+var _wrs_int_CASIcon = '/core/icons/cas.gif';
+var _wrs_int_temporalIframe;
+var _wrs_int_window;
+var _wrs_int_window_opened = false;
+var _wrs_int_temporalImageResizing;
+var _wrs_int_language;
+var _wrs_int_directionality = '';
+
+
+if (navigator.userLanguage) {
+	_wrs_int_language = navigator.userLanguage;
+}
+else if (navigator.language) {
+	_wrs_int_language = navigator.language.substring(0, 2);
+}
+else {
+	_wrs_int_language = 'en';
+}
+
+// Including core.js
+var script = document.createElement('script');
+script.type = 'text/javascript';
+script.src = _wrs_conf_path + '/core/core.js';
+document.getElementsByTagName('head')[0].appendChild(script);
+
+// Load configuration synchronously
+if (!_wrs_int_conf_async) {
+	var httpRequest = typeof XMLHttpRequest != 'undefined' ? new XMLHttpRequest():new ActiveXObject('Msxml2.XMLHTTP');
+	var configUrl = _wrs_int_conf_file.indexOf("/")==0 || _wrs_int_conf_file.indexOf("http")==0 ? _wrs_int_conf_file : _wrs_conf_path + "/" + _wrs_int_conf_file;
+	httpRequest.open('GET', configUrl, false);
+	httpRequest.send(null);
+	eval(httpRequest.responseText);
+}
+
+// Plugin integration
+
+/**
+ * Inits the WIRIS plugin for this demo.
+ * @param string target Textarea target ID.
+ */
+function wrs_int_init(target) {
+	wrs_int_init0 = function() {
+		if (typeof _wrs_conf_core_loaded == 'undefined') {
+			setTimeout(wrs_int_init0,100);
+		} else {
+			wrs_int_init_handler(target);
+		}
+	}
+	wrs_int_init0();
+}
+
+function wrs_int_init_handler(target) {
+	/* Assigning events to the WYSIWYG editor */
+	var iframe = document.getElementById(target + '_iframe');
+	wrs_addIframeEvents(iframe, wrs_int_doubleClickHandler, wrs_int_mousedownHandler, wrs_int_mouseupHandler);
+	
+	/* Parsing input text */
+	var textarea = document.getElementById(target);
+	iframe.contentWindow.document.body.innerHTML = wrs_initParse(textarea.value);
+	
+	/* Creating an event for parse the output text */
+	var form = textarea.form;
+	
+	wrs_addEvent(form, 'submit', function (e) {
+		// In our case the plugin is who sets the textarea content. And it takes the opportunity to apply the final parser.
+		textarea.value = wrs_endParse(iframe.contentWindow.document.body.innerHTML);
+	});
+	
+	/* Creating toolbar buttons */
+	var toolbar = document.getElementById(target + '_toolbar');
+	
+	if (_wrs_conf_editorEnabled) {
+		var formulaButton = document.createElement('img');
+		formulaButton.id = "editorIcon";
+		formulaButton.src = _wrs_conf_path + _wrs_int_editorIcon;
+		formulaButton.style.cursor = 'pointer';
+		
+		wrs_addEvent(formulaButton, 'click', function () {
+			wrs_int_openNewFormulaEditor(iframe, _wrs_int_language);
+		});
+		
+		toolbar.appendChild(formulaButton);
+	}
+	
+	if (_wrs_conf_CASEnabled) {
+		var CASButton = document.createElement('img');
+		CASButton.src = _wrs_conf_path + _wrs_int_CASIcon;
+		CASButton.id = "casIcon";
+		CASButton.style.cursor = 'pointer';
+		
+		wrs_addEvent(CASButton, 'click', function () {
+			wrs_int_openNewCAS(iframe, _wrs_int_language);
+		});
+		
+		toolbar.appendChild(CASButton);
+	}
+}
+
+/**
+ * Opens formula editor.
+ * @param object iframe Target
+ */
+function wrs_int_openNewFormulaEditor(iframe, language) {
+	if (_wrs_int_window_opened) {
+		_wrs_int_window.focus();
+	}
+	else {
+		_wrs_int_window_opened = true;
+		_wrs_isNewElement = true;
+		_wrs_int_temporalIframe = iframe;
+		_wrs_int_window = wrs_openEditorWindow(language, iframe, true);
+	}
+}
+
+/**
+ * Opens CAS.
+ * @param object iframe Target
+ */
+function wrs_int_openNewCAS(iframe, language) {
+	if (_wrs_int_window_opened) {
+		_wrs_int_window.focus();
+	}
+	else {
+		_wrs_int_window_opened = true;
+		_wrs_isNewElement = true;
+		_wrs_int_temporalIframe = iframe;
+		_wrs_int_window = wrs_openCASWindow(iframe, true, language);
+	}
+}
+
+/**
+ * Handles a double click on the iframe.
+ * @param object iframe Target
+ * @param object element Element double clicked
+ */
+function wrs_int_doubleClickHandler(iframe, element) {
+	if (element.nodeName.toLowerCase() == 'img') {
+		if (wrs_containsClass(element, 'Wirisformula')) {
+			if (!_wrs_int_window_opened) {
+				_wrs_temporalImage = element;
+				wrs_int_openExistingFormulaEditor(iframe, _wrs_int_language);
+			}
+			else {
+				_wrs_int_window.focus();
+			}
+		}
+		else if (wrs_containsClass(element, 'Wiriscas')) {
+			if (!_wrs_int_window_opened) {
+				_wrs_temporalImage = element;
+				wrs_int_openExistingCAS(iframe, _wrs_int_language);
+			}
+			else {
+				_wrs_int_window.focus();
+			}
+		}
+	}
+}
+
+/**
+ * Opens formula editor to edit an existing formula.
+ * @param object iframe Target
+ */
+function wrs_int_openExistingFormulaEditor(iframe, language) {
+	_wrs_int_window_opened = true;
+	_wrs_isNewElement = false;
+	_wrs_int_temporalIframe = iframe;
+	_wrs_int_window = wrs_openEditorWindow(language, iframe, true);
+}
+
+/**
+ * Opens CAS to edit an existing formula.
+ * @param object iframe Target
+ */
+function wrs_int_openExistingCAS(iframe, language) {
+	_wrs_int_window_opened = true;
+	_wrs_isNewElement = false;
+	_wrs_int_temporalIframe = iframe;
+	_wrs_int_window = wrs_openCASWindow(iframe, true, language);
+}
+
+/**
+ * Handles a mouse down event on the iframe.
+ * @param object iframe Target
+ * @param object element Element mouse downed
+ */
+function wrs_int_mousedownHandler(iframe, element) {
+	if (element.nodeName.toLowerCase() == 'img') {
+		if (wrs_containsClass(element, 'Wirisformula') || wrs_containsClass(element, 'Wiriscas')) {
+			_wrs_int_temporalImageResizing = element;
+		}
+	}
+}
+
+/**
+ * Handles a mouse up event on the iframe.
+ */
+function wrs_int_mouseupHandler() {
+	if (_wrs_int_temporalImageResizing) {
+		setTimeout(function () {
+			wrs_fixAfterResize(_wrs_int_temporalImageResizing);
+		}, 10);
+	}
+}
+
+/**
+ * Calls wrs_updateFormula with well params.
+ * @param string mathml
+ */
+function wrs_int_updateFormula(mathml, editMode) {
+	wrs_updateFormula(_wrs_int_temporalIframe.contentWindow, _wrs_int_temporalIframe.contentWindow, mathml, null, editMode);
+}
+
+/**
+ * Calls wrs_updateCAS with well params.
+ * @param string appletCode
+ * @param string image
+ * @param int width
+ * @param int height
+ */
+function wrs_int_updateCAS(appletCode, image, width, height) {
+	wrs_updateCAS(_wrs_int_temporalIframe.contentWindow, _wrs_int_temporalIframe.contentWindow, appletCode, image, width, height);
+}
+
+/**
+ * Handles window closing.
+ */
+function wrs_int_notifyWindowClosed() {
+	_wrs_int_window_opened = false;
+}
diff --git a/lib/editor/atto/plugins/wiris/icons/cas.png b/lib/editor/atto/plugins/wiris/icons/cas.png
new file mode 100644
index 0000000000000000000000000000000000000000..dfb6a7aab874281ac3cd4d383229091aaa394208
GIT binary patch
literal 208
zcmeAS@N?(olHy`uVBq!ia0vp^0wB!61|;P_|4#%`(>+}rLo9mVPTI(O$Uwy9zPaKg
z)dELh&Kr$N?~EC$4cevK9FoM_6j?P=T{8RTX)SAPx^DmSUCD>sHMzHK3z*DW^YYW!
zyA8ih@=9fRwQHZXaq;{U4EKJwzTWjt!l`1)Dc{Qzf=+qd^0e}nQc3ky_m<Lnz!uZM
zb%SYhr=n4Tsb_Hl>zYPYgVM?B2D6qddiVZM{ReLQ3P!=Q<<CxJv#9``$l&Sf=d#Wz
Gp$Pzht4#X<

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/icons/chem.png b/lib/editor/atto/plugins/wiris/icons/chem.png
new file mode 100644
index 0000000000000000000000000000000000000000..8ceb4e7f1110ac86f416de9a23c64e053b610ba1
GIT binary patch
literal 530
zcmV+t0`2{YP)<h;3K|Lk000e1NJLTq000mG000mO1^@s6AM^iV00004b3#c}2nYxW
zd<bNS00009a7bBm000fw000fw0YWI7cmMzZ8FWQhbW?9;ba!ELWdL_~cP?peYja~^
zaAhuUa%Y?FJQ@H10gp*UK~y-6)snGmQ&AMgf9EDO2<8tcScHh$K^^XSNeG#AP(&OA
z2SJ=1g{n)T(4`1Mp^Jmy=%$j*se(dq$q>ks4x%U-bkRk@#Yf`1$HBaCc@1^;n-1SO
z=f~x{M>s&uW^={NZiNs&jz*)WKq$}1qQy?9b9geDtO1+Ak(vEAgm5QK(>DhKk|eoi
zW;?*K1#C03=aow3-f%el3Q#RNtyb$~p68Fv>|AN-Gq4OS0U{#TLkOpVGXSob%JcjM
z5HJ5Uv-K>?P5@^`WH;)q6uZ^PJQdYXoO2t+GlBQOB~`r)Ty@SpV;1N<168%6ZZsOz
zUayxg$Y7t`zeoN{z<4~qtEx+7UsaE*>ROT{^T1=kx2WC$_PqBO0lM98-Fv?cyaOJZ
z*(+urFb9MXZUA2*$f}6!s_M%u%RY$6I&f&#tLy`$Y5E#i1?~gCBG3i?USgp=GrL0h
z4q~<2?W5D_^nr-njO-u4R=r+-)bICy7v@4hA@BWp=iKcO!lzoTwmldOzL#hI0Q|*+
Uo=F6rBme*a07*qoM6N<$f?W^hy#N3J

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/icons/formula.png b/lib/editor/atto/plugins/wiris/icons/formula.png
new file mode 100644
index 0000000000000000000000000000000000000000..7cc09a5feb81537fdd353dc7af97de51a4e87da8
GIT binary patch
literal 407
zcmeAS@N?(olHy`uVBq!ia0vp^0wB!61|;P_|4#%`EX7WqAsj$Z!;#Vf<Z~8yL>2?p
zUk71ECym(^Ktah8*NBqf{Irtt#G+J&^73-M%)IR4<ivthz5Jr|+3#$m7#J8uJY5_^
zEP9XjZ}ehz6mdN-y{UyY_YdQKg|mKJ=PnU)+#vXeJNhk4pyy-xh-HRiUR=^^MYa`u
z7Rb%nx_P6C3it0dV$)Qu*>vV)wN<}=$n)p>#BB$v?=v4eQ01M<C9|91kAVSOM`Lp<
zTjs1|pMU-lj^JfrXp?>amu~}qkNV`3mIrdoZi`IJieacVo^5vQ{;FTs81))V6O=tC
zsfX4IOuV~FRq1=>Jo{~$77rGO*?C<yVcV8HH}D1jxijao-q!_+EI;72RNnPsDThMC
z=X>_dd($$~wy)YHYQo@UY@K<s`Ijg|s4Sy?@0u57yUo2B#Uf|ijGdMmf0`-as`i7e
x(_;UbvAwwRE;Vvm^|_sm9ebD$r!v&r*_Ygo@-6%pcmNoP44$rjF6*2UngEVCoZJ8a

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/lang/ar/strings.js b/lib/editor/atto/plugins/wiris/lang/ar/strings.js
new file mode 100644
index 0000000..3455ca6
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/ar/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = '';
+strings['accept'] = '?';
+strings['manual'] = '';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/ca/strings.js b/lib/editor/atto/plugins/wiris/lang/ca/strings.js
new file mode 100644
index 0000000..efb791a
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/ca/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = 'Cancellar';
+strings['accept'] = 'Acceptar';
+strings['manual'] = 'Manual';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/cs/strings.js b/lib/editor/atto/plugins/wiris/lang/cs/strings.js
new file mode 100644
index 0000000..04fc767
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/cs/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = 'Storno';
+strings['accept'] = 'OK';
+strings['manual'] = 'Pru?ka';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/da/strings.js b/lib/editor/atto/plugins/wiris/lang/da/strings.js
new file mode 100644
index 0000000..e048ef7
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/da/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = 'Annuller';
+strings['accept'] = 'OK';
+strings['manual'] = 'Brugervejledning';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/de/strings.js b/lib/editor/atto/plugins/wiris/lang/de/strings.js
new file mode 100644
index 0000000..d046de3
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/de/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = 'Abbrechen';
+strings['accept'] = 'OK';
+strings['manual'] = 'Handbuch';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/el/strings.js b/lib/editor/atto/plugins/wiris/lang/el/strings.js
new file mode 100644
index 0000000..c2426c1
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/el/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = '?';
+strings['accept'] = '';
+strings['manual'] = '?';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/en/atto_wiris.php b/lib/editor/atto/plugins/wiris/lang/en/atto_wiris.php
new file mode 100644
index 0000000..a821af8
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/en/atto_wiris.php
@@ -0,0 +1,20 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+$string['pluginname'] = 'WIRIS plugin for Atto';
+$string['wiris_editor_title'] = 'Math editor';
+$string['wiris_cas_title'] = 'Calculator';
+$string['wiris_chem_editor_title'] = 'Chemistry editor';
diff --git a/lib/editor/atto/plugins/wiris/lang/en/strings.js b/lib/editor/atto/plugins/wiris/lang/en/strings.js
new file mode 100644
index 0000000..3a910eb
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/en/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = 'Cancel';
+strings['accept'] = 'OK';
+strings['manual'] = 'Manual';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/es/strings.js b/lib/editor/atto/plugins/wiris/lang/es/strings.js
new file mode 100644
index 0000000..1faba7e
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/es/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = 'Cancelar';
+strings['accept'] = 'Aceptar';
+strings['manual'] = 'Manual';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/et/strings.js b/lib/editor/atto/plugins/wiris/lang/et/strings.js
new file mode 100644
index 0000000..22d8e3a
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/et/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = 'Loobu';
+strings['accept'] = 'OK';
+strings['manual'] = 'Ksiraamat';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/eu/strings.js b/lib/editor/atto/plugins/wiris/lang/eu/strings.js
new file mode 100644
index 0000000..76f21b0
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/eu/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = 'Ezeztatu';
+strings['accept'] = 'Onartu';
+strings['manual'] = 'Gida';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/fi/strings.js b/lib/editor/atto/plugins/wiris/lang/fi/strings.js
new file mode 100644
index 0000000..4c479ce
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/fi/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = 'Peruuta';
+strings['accept'] = 'OK';
+strings['manual'] = 'Manual';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/fr/strings.js b/lib/editor/atto/plugins/wiris/lang/fr/strings.js
new file mode 100644
index 0000000..84d07a9
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/fr/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = 'Annuler';
+strings['accept'] = 'OK';
+strings['manual'] = 'Manuel';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/gl/strings.js b/lib/editor/atto/plugins/wiris/lang/gl/strings.js
new file mode 100644
index 0000000..1faba7e
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/gl/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = 'Cancelar';
+strings['accept'] = 'Aceptar';
+strings['manual'] = 'Manual';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/he/strings.js b/lib/editor/atto/plugins/wiris/lang/he/strings.js
new file mode 100644
index 0000000..e00bd68
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/he/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = '';
+strings['accept'] = '?';
+strings['manual'] = '';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/hr/strings.js b/lib/editor/atto/plugins/wiris/lang/hr/strings.js
new file mode 100644
index 0000000..381ed3c
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/hr/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = 'Poniti';
+strings['accept'] = 'U redu';
+strings['manual'] = 'Priru?nik';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/hu/strings.js b/lib/editor/atto/plugins/wiris/lang/hu/strings.js
new file mode 100644
index 0000000..2ba267d
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/hu/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = 'Mgsem';
+strings['accept'] = 'OK';
+strings['manual'] = 'Kziknyv';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/it/strings.js b/lib/editor/atto/plugins/wiris/lang/it/strings.js
new file mode 100644
index 0000000..c2b539b
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/it/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = 'Annulla';
+strings['accept'] = 'Accetta';
+strings['manual'] = 'Manuale';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/ja/strings.js b/lib/editor/atto/plugins/wiris/lang/ja/strings.js
new file mode 100644
index 0000000..c017287
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/ja/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = '';
+strings['accept'] = 'OK';
+strings['manual'] = '';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/ko/strings.js b/lib/editor/atto/plugins/wiris/lang/ko/strings.js
new file mode 100644
index 0000000..c69cb22
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/ko/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = '';
+strings['accept'] = '?';
+strings['manual'] = '';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/nl/strings.js b/lib/editor/atto/plugins/wiris/lang/nl/strings.js
new file mode 100644
index 0000000..f05331c
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/nl/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = 'Annuleren';
+strings['accept'] = 'OK';
+strings['manual'] = 'Handleiding';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/no/strings.js b/lib/editor/atto/plugins/wiris/lang/no/strings.js
new file mode 100644
index 0000000..1acc9fb
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/no/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = 'Avbryt';
+strings['accept'] = 'OK';
+strings['manual'] = 'Hndbok';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/pl/strings.js b/lib/editor/atto/plugins/wiris/lang/pl/strings.js
new file mode 100644
index 0000000..c8a00f9
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/pl/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = 'Anuluj';
+strings['accept'] = 'OK';
+strings['manual'] = 'Instrukcja';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/pt/strings.js b/lib/editor/atto/plugins/wiris/lang/pt/strings.js
new file mode 100644
index 0000000..b35e4ed
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/pt/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = 'Cancelar';
+strings['accept'] = 'OK';
+strings['manual'] = 'Manual';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/pt_br/strings.js b/lib/editor/atto/plugins/wiris/lang/pt_br/strings.js
new file mode 100644
index 0000000..b35e4ed
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/pt_br/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = 'Cancelar';
+strings['accept'] = 'OK';
+strings['manual'] = 'Manual';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/ru/strings.js b/lib/editor/atto/plugins/wiris/lang/ru/strings.js
new file mode 100644
index 0000000..3b91d47
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/ru/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = '';
+strings['accept'] = 'OK';
+strings['manual'] = '';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/sv/strings.js b/lib/editor/atto/plugins/wiris/lang/sv/strings.js
new file mode 100644
index 0000000..9731721
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/sv/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = 'Avbryt';
+strings['accept'] = 'OK';
+strings['manual'] = 'Bruksanvisning';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/tr/strings.js b/lib/editor/atto/plugins/wiris/lang/tr/strings.js
new file mode 100644
index 0000000..b12fdd4
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/tr/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = 'Vazge';
+strings['accept'] = 'Tamam';
+strings['manual'] = 'Klavuz';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lang/zh/strings.js b/lib/editor/atto/plugins/wiris/lang/zh/strings.js
new file mode 100644
index 0000000..8dd366c
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lang/zh/strings.js
@@ -0,0 +1,8 @@
+var strings = new Array();
+strings['cancel'] = '?';
+strings['accept'] = '';
+strings['manual'] = '';
+strings['latex'] = 'LaTeX';
+strings['close'] = 'Close';
+strings['minimise'] = 'Minimise';
+strings['fullscreen'] = 'Full-screen';
diff --git a/lib/editor/atto/plugins/wiris/lib.php b/lib/editor/atto/plugins/wiris/lib.php
new file mode 100644
index 0000000..334fdbe
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/lib.php
@@ -0,0 +1,71 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Library functions for WIRIS plugin for Atto.
+ *
+ * @package    atto
+ * @subpackage wiris
+ * @copyright  Maths for More S.L. <info@wiris.com>
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * Initialise the js strings required for this module.
+ */
+function atto_wiris_strings_for_js() {
+    global $PAGE;
+    $PAGE->requires->strings_for_js(
+      array(
+        'wiris_editor_title',
+        'wiris_cas_title',
+        'wiris_chem_editor_title',
+      ),
+      'atto_wiris');
+}
+
+/**
+ * Set parameters to be passed to the js plugin constructor.
+ */
+function atto_wiris_params_for_js() {
+    global $COURSE, $PAGE;
+    // We need to know if  WIRIS filter are active in the context of the course.
+    // If not WIRIS plugin should be disabled.
+    $filterwirisactive = true;
+    // Filter disabled at course level.
+    if (!get_config('filter_wiris', 'allow_editorplugin_active_course')) {
+        $context = context_course::instance($COURSE->id);
+        $activefilters = filter_get_active_in_context($context);
+        $filterwirisactive = array_key_exists('wiris', $activefilters);
+
+        // Filter disabled at activity level.
+        if ($filterwirisactive) {
+            // Check if context is context module.
+            $pagecontext = $PAGE->context;
+            // We need to check only module context. Other contexts (like block context)
+            // shouldn't be checked.
+            if ($pagecontext instanceof context_module) {
+                $activefilters = filter_get_active_in_context($PAGE->context);
+                $filterwirisactive = array_key_exists('wiris', $activefilters);
+            }
+        }
+    }
+
+    // Atto js plugin checks if the filter is - or not - active.
+    return array('lang' => current_language(), 'filter_enabled' => $filterwirisactive);
+}
diff --git a/lib/editor/atto/plugins/wiris/pix/cas.png b/lib/editor/atto/plugins/wiris/pix/cas.png
new file mode 100644
index 0000000000000000000000000000000000000000..7840c7fc7b7edf405b18336e0dea4c1235bd724c
GIT binary patch
literal 207
zcmeAS@N?(olHy`uVBq!ia0vp^0wB!61|;P_|4#%`EX7WqAsj$Z!;#Vf<Z~8yL>2?p
zUk71ECym(^Ktah8*NBqf{Irtt#G+J&^73-M%)IR4<ivthz5Jr|+3#$mfQo!PT^vI!
zdf!gk$lG8baHM9x+l>y}I<>le8;)PR5TGWa&{FNK$K$_vRg|je1-84gCnjw1J;BiZ
uwu|$l6GP=Qp2Xd^&+TT6fAIeSue?k_sFM2ROecGwxeT7JelF{r5}E+PsY1K}

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/pix/chem.png b/lib/editor/atto/plugins/wiris/pix/chem.png
new file mode 100644
index 0000000000000000000000000000000000000000..66bde291eb9c748f96fcd00aa3fa1a66edbe64b9
GIT binary patch
literal 529
zcmV+s0`C2ZP)<h;3K|Lk000e1NJLTq000mG000mO1^@s6AM^iV00004b3#c}2nYxW
zd<bNS00009a7bBm000fw000fw0YWI7cmMzZ8FWQhbW?9;ba!ELWdL_~cP?peYja~^
zaAhuUa%Y?FJQ@H10gg#TK~y-6)lxA_TTvALzRSy?M0l%^&_Qe$>wjn+q;x8j;Nnsf
z2n1paQd;P6y9h!EI0(7-@uHi$b`o)NFO&?W&`u6lyEM@CHt%$(@A2|X;@mSGzI(p!
zob%m7%!q!!U-jN^k^JtQJJwn!#Trf`cDvoVa=F|F@Bu*i7XFeX$#%2ZyqqZzMbS$U
z=>T{zL0bTvdhg$~TCE!Z2+|j8?Lz=P5qVM|T>)4GP`Yin5d^^sfX4u!GHH=d0P^JD
zB;ST%xGW;8B+s(3$*R^`jZHxEQI34%y?>vM3E&%mXU3T4BwqkHNe#_Bu+~bNhhZ4h
zYPHb>5AKAzzvRCZ7!HT8jWMMnZj4zn#<b%&&J52B{7e&)9g+iU?K%L&alBxy-6Q#x
z<o;+hx)2cpxnJn@dTS&PNmdJu&++eQ7IWCObFQMbPR35z7&EVwdM6?~0OqEwJs|n2
z(P(@gn;;)i6jelI7r<r?9s>C2oIB83|H;;!(j^sonj}e!<PW9PUcFxbRjm07r@@QZ
TBQ#mQ00000NkvXXu0mjfSZd)!

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/pix/formula.png b/lib/editor/atto/plugins/wiris/pix/formula.png
new file mode 100644
index 0000000000000000000000000000000000000000..0457614714c81fb6bda350c5ce8b5d6b74fa0182
GIT binary patch
literal 406
zcmeAS@N?(olHy`uVBq!ia0vp^0wB!61|;P_|4#%`EX7WqAsj$Z!;#Vf<Z~8yL>2?p
zUk71ECym(^Ktah8*NBqf{Irtt#G+J&^73-M%)IR4<ivthz5Jr|+3#$m7#J9ZJzX3_
zEP9VlSm<}eL7;8_%>+H&Ht`3X6|6@zJro?9-d}5C+0NNmT-p)K-{kDj<?x__*&t)m
zwZ<n$RCjYk6`5S$>n+eT`{(ojpUxkspZ<mO+AUr|&Bm|urg9dnsyeBpE@*s!!D1e_
zMpqKU8<#V=Q?;+%vK6#sIc0O6yTQbFd&AYVOerS`t)*(RpVOzMu75PAn*G|W8?&Qc
zt3SUZT5#cv+?H#%YXwC<Tr*Q-xqRgQ+?l<}<{Akmm-#2FSh8O-+ZXi8jBCZ~Uu+eb
z>`Fx@i|x}QzX`HRB=6~%b5__@MM{33|AJMk3_sktxJ;>NyT}2F$BlVitsm<d81BY1
xT<<=!pW&Fq`@Q$s-#K%LE4G|YWvE}Lzwb|2^Q4nMPXfb`!PC{xWt~$(69Adapkx35

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/pix/icon.png b/lib/editor/atto/plugins/wiris/pix/icon.png
new file mode 100644
index 0000000000000000000000000000000000000000..0457614714c81fb6bda350c5ce8b5d6b74fa0182
GIT binary patch
literal 406
zcmeAS@N?(olHy`uVBq!ia0vp^0wB!61|;P_|4#%`EX7WqAsj$Z!;#Vf<Z~8yL>2?p
zUk71ECym(^Ktah8*NBqf{Irtt#G+J&^73-M%)IR4<ivthz5Jr|+3#$m7#J9ZJzX3_
zEP9VlSm<}eL7;8_%>+H&Ht`3X6|6@zJro?9-d}5C+0NNmT-p)K-{kDj<?x__*&t)m
zwZ<n$RCjYk6`5S$>n+eT`{(ojpUxkspZ<mO+AUr|&Bm|urg9dnsyeBpE@*s!!D1e_
zMpqKU8<#V=Q?;+%vK6#sIc0O6yTQbFd&AYVOerS`t)*(RpVOzMu75PAn*G|W8?&Qc
zt3SUZT5#cv+?H#%YXwC<Tr*Q-xqRgQ+?l<}<{Akmm-#2FSh8O-+ZXi8jBCZ~Uu+eb
z>`Fx@i|x}QzX`HRB=6~%b5__@MM{33|AJMk3_sktxJ;>NyT}2F$BlVitsm<d81BY1
xT<<=!pW&Fq`@Q$s-#K%LE4G|YWvE}Lzwb|2^Q4nMPXfb`!PC{xWt~$(69Adapkx35

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/settings.php b/lib/editor/atto/plugins/wiris/settings.php
new file mode 100644
index 0000000..dc201cf
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/settings.php
@@ -0,0 +1,40 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Settings page for WIRIS plugin for Atto.
+ *
+ * @package    atto
+ * @subpackage wiris
+ * @copyright  Maths for More S.L. <info@wiris.com>
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+$output = 'WIRIS plugin for Atto (Maths) is correctly installed.';
+
+// Checking that WIRIS plugin is installed.
+$filterwiris = $CFG->dirroot . '/filter/wiris/filter.php';
+if (!file_exists($filterwiris)) {
+    $title = '<span style="color:#aa0000; font-size:18px;">Attention! WIRIS filter is not installed</span>';
+    $info = '<a target="_blank" href="http://www.wiris.com/plugins/docs/moodle"><img style="vertical-align:-3px;"'.
+        ' alt="" src="https://www.wiris.com/system/files/attachments/1689/WIRIS_manual_icon_17_17.png" /></a>';
+    $output = $title . '<br />WIRIS plugin for Atto needs that WIRIS plugin for Moodle 2.x is installed on your Moodle. '.
+        $info;
+}
+
+$settings->add(new admin_setting_heading('atto_wiris', '', $output));
diff --git a/lib/editor/atto/plugins/wiris/tech.txt b/lib/editor/atto/plugins/wiris/tech.txt
new file mode 100644
index 0000000..2c0ea7b
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/tech.txt
@@ -0,0 +1 @@
+php
diff --git a/lib/editor/atto/plugins/wiris/test.html b/lib/editor/atto/plugins/wiris/test.html
new file mode 100644
index 0000000..af7fde3
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/test.html
@@ -0,0 +1,163 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
+<html>
+    <head>
+        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
+        <meta name="keywords" content="math,science" />
+        <script type="text/javascript">
+            String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g, '');};
+            function getParameter(name) {
+                var value = new RegExp(name+"=([^&]*)","i").exec(window.location);
+                if (value!=null && value.length>1) {
+                    value = decodeURIComponent(value[1].replace(/\+/g,' '));
+                } else {
+                    value = null;
+                }
+                return value;
+            }
+            function insertHtml(content) {
+                if (content!=null && content.length>0) {
+                    document.write(content);
+                }
+            }
+            function setValue(id, content) {
+                if (content!=null && content.length>0) {
+                    document.getElementById(id).value = content;
+                }
+            }
+
+            var con = new XMLHttpRequest();
+            con.open("GET", "tech.txt", false);
+            con.send(null);
+            var s = con.responseText;
+            WIRISplugins_js = "integration/WIRISplugins.js";
+            tech = s.split("#")[0].trim();
+            window._wrs_int_path = window._wrs_int_path == null ? "" : window._wrs_int_path;
+            if (tech=="php") {
+                _wrs_int_conf_file_override = _wrs_int_path > 0 ?
+                                              _wrs_int_path + "/configurationjs.php" :
+                                              "integration/configurationjs.php";
+            } else if (tech=="aspx") {
+                _wrs_int_conf_file_override = _wrs_int_path > 0 ?
+                                              _wrs_int_path + "/configurationjs.aspx" :
+                                              "integration/configurationjs.aspx";
+            } else if (tech=="local-java") {
+                _wrs_int_conf_file_override = "app/configurationjs";
+            } else if (tech=="java") {
+                _wrs_int_conf_file_override = "/pluginwiris_engineapp/configurationjs";
+            } else if (tech=="nodejs") {
+                _wrs_int_conf_file_override = "integration/configurationjs";
+                WIRISplugins_js = "/integration/WIRISplugins.js";
+            }
+            var script = document.createElement('script');
+            script.type = 'text/javascript';
+            script.src = WIRISplugins_js + "?viewer=image";
+            document.getElementsByTagName('head')[0].appendChild(script);
+
+            var content = getParameter("content");
+        </script>
+        <script type="text/javascript" src="core/display.js"></script>
+        <script type="text/javascript" src="wirisplugin-generic.js"></script>
+
+        <script type="text/javascript">
+            function wrs_addEvent(element, event, func) {
+                if (element.addEventListener) {
+                    element.addEventListener(event, func, false);
+                }
+                else if (element.attachEvent) {
+                    element.attachEvent('on' + event, func);
+                }
+            }
+
+            wrs_addEvent(window, 'load', function () {
+                // Hide the textarea
+                var textarea = document.getElementById('example');
+                textarea.style.display = 'none';
+
+                // Create the toolbar
+                var toolbar = document.createElement('div');
+                toolbar.id = textarea.id + '_toolbar';
+
+                // Create the WYSIWYG editor
+                var iframe = document.createElement('iframe');
+                iframe.id = textarea.id + '_iframe';
+
+                wrs_addEvent(iframe, 'load', function () {
+                    // Setting design mode ON
+                    iframe.contentWindow.document.designMode = 'on';
+
+                    // Setting the content
+                    if (iframe.contentWindow.document.body) {
+                        iframe.contentWindow.document.body.innerHTML = textarea.value;
+
+                        // WE INIT THE WIRIS PLUGIN HERE
+                        wrs_int_init(iframe,toolbar);
+                    }
+                });
+
+                // We set an empty document instead of about:blank for use relative paths for images
+                iframe.src = 'tests/generic_demo.html';
+                iframe.width = 500;
+                iframe.height = 200;
+
+                // Insert the WYSIWYG editor before the textarea
+                textarea.parentNode.insertBefore(iframe, textarea);
+
+                // Insert the toolbar before the WYSIWYG editor
+                iframe.parentNode.insertBefore(toolbar, iframe);
+
+                // When the user submits the form, set the textarea value with the WYSIWYG editor content
+                var form = document.getElementById('exampleForm');
+
+                wrs_addEvent(form, 'submit', function () {
+                    // Set the textarea content and call "wrs_endParse"
+                    textarea.value = wrs_endParse(iframe.contentWindow.document.body.innerHTML);
+                });
+            });
+
+            function changeDPI() {
+                ls = document.getElementsByClassName('Wirisformula');
+                for (i=0;i<ls.length;i++) {
+                    img = ls[i];
+                    img.width = img.clientWidth;
+                    img.src = img.src + "&dpi=600";
+                }
+            }
+        </script>
+
+        <title>WIRIS Plugin generic integration on PHP | Educational mathematics</title>
+    </head>
+    <body>
+        <h1><a href="http://www.wiris.com">
+                <img src="https://www.wiris.com/en/system/files/attachments/889/wiris_50.png" title="WIRIS" />
+            </a>
+            Test page for WIRIS plugins
+            "<script>
+            document.write(tech);
+            </script>"
+
+        </h1>
+
+        <form id="exampleForm" method="GET">
+            <textarea id="example" name="content" cols="50" rows="10"><!-- content value --></textarea>
+            <br />
+            <script>setValue("example",content);</script>
+
+            <input id="previewButton" type="submit" value="Preview"/>
+        </form>
+
+        <h2>Preview</h2>
+
+        <div id="previewBox">
+            <script>insertHtml(content);</script>
+        </div>
+
+        <script>
+            var value = document.getElementById("example").value;
+            if (value.length==0 || value=="<!-- content "+"value -->") {
+                document.getElementById("previewBox").innerHTML = '<span id="previewMessage">Press the "Preview" button.</span>';
+            }
+        </script>
+
+        </script>
+    </body>
+</html>
diff --git a/lib/editor/atto/plugins/wiris/tests/behat/edit_formula.feature b/lib/editor/atto/plugins/wiris/tests/behat/edit_formula.feature
new file mode 100644
index 0000000..288077b
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/tests/behat/edit_formula.feature
@@ -0,0 +1,28 @@
+@editor @editor_atto @atto @atto_wiris @_bug_phantomjs
+Feature: Atto WIRIS plugin
+  To teach maths to students, I need to write equations
+
+  @javascript
+  Scenario: Create a formula
+    Given the following config values are set as admin:
+    | config | value | plugin |
+    | toolbar | math = wiris | editor_atto |
+    And I log in as "admin"
+    And I expand "Site administration" node
+    And I expand "Plugins" node
+    And I expand "Filters" node
+    And I follow "Manage filters"
+    And I click on "On" "option" in the "Math & Science by WIRIS" "table_row"
+    And I follow "Profile" in the user menu
+    And I follow "Edit profile"
+    And I click on "Math editor" "button"
+    And I switch to "WIRISeditor" window
+    And I set the field with xpath "//input[@class='wrs_focusElement']" to "1+2"
+    And I click on "//input[@class='wrs_button_accept']" "xpath_element"
+    And I switch to the main window
+    And I click on "Update profile" "button"
+    # Checking formula image outside edit element.
+    Then "//img[@alt=\"1 plus 2\"]" "xpath_element" should exist
+    # Checking formula image inside edit element.
+    And I follow "Edit profile"
+    Then "//img[@alt=\"1 plus 2\"]" "xpath_element" should exist
diff --git a/lib/editor/atto/plugins/wiris/tests/generic_demo.html b/lib/editor/atto/plugins/wiris/tests/generic_demo.html
new file mode 100644
index 0000000..94b0ad6
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/tests/generic_demo.html
@@ -0,0 +1,10 @@
+<html>
+<head>
+    <style type="text/css">
+        body{font-size: 16px;background-color: #fff;font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;padding: 10px;}
+    </style>
+</head>
+<body>
+    &nbsp;
+</body>
+</html>
diff --git a/lib/editor/atto/plugins/wiris/version.php b/lib/editor/atto/plugins/wiris/version.php
new file mode 100644
index 0000000..17fb3f3
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/version.php
@@ -0,0 +1,33 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Version details.
+ *
+ * @package    atto
+ * @subpackage wiris
+ * @copyright  Maths for More S.L. <info@wiris.com>
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+$plugin->version = 2017090500;
+$plugin->release = '4.7.0.1374';
+$plugin->requires = 2014050800;
+$plugin->component = 'atto_wiris';
+$plugin->dependencies = array ('filter_wiris' => 2017090500);
+$plugin->maturity = MATURITY_STABLE;
diff --git a/lib/editor/atto/plugins/wiris/wirisplugin-generic.js b/lib/editor/atto/plugins/wiris/wirisplugin-generic.js
new file mode 100644
index 0000000..974135b
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/wirisplugin-generic.js
@@ -0,0 +1,264 @@
+// Configuration.
+var _wrs_int_conf_file = '../../../../../filter/wiris/integration/configurationjs.php';
+var _wrs_int_conf_async = true;
+
+// Stats editor (needed by core/editor.js).
+var _wrs_conf_editor = "GenericHTML";
+
+// Get _wrs_conf_path (plugin URL).
+var col = document.getElementsByTagName("script");
+var scriptName = "wirisplugin-generic.js";
+for (i = 0; i < col.length; i++) {
+    j = col[i].src.lastIndexOf(scriptName);
+    if (j >= 0) {
+        baseURL = col[i].src.substr(0, j - 1);
+    }
+}
+_wrs_conf_path = baseURL;
+
+if (_wrs_int_conf_file.indexOf("@") == 0 && typeof _wrs_int_conf_file_override != 'undefined') {
+    // Variable _wrs_int_conf_file_override is defined only for testing.
+    _wrs_int_conf_file = _wrs_int_conf_file_override;
+}
+
+var strings = [];
+
+var _wrs_int_path = _wrs_int_conf_file.split("/");
+_wrs_int_path.pop();
+_wrs_int_path = _wrs_int_path.join("/");
+_wrs_int_path = _wrs_int_path.indexOf("/") == 0 || _wrs_int_path.indexOf("http") == 0 ? _wrs_int_path : _wrs_conf_path + "/" + _wrs_int_path;
+
+// Load configuration synchronously.
+if (!_wrs_int_conf_async) {
+    var httpRequest = typeof XMLHttpRequest != 'undefined' ? new XMLHttpRequest() : new ActiveXObject('Microsoft.XMLHTTP');
+    var configUrl = _wrs_int_conf_file.indexOf("/") == 0 || _wrs_int_conf_file.indexOf("http") == 0 ? _wrs_int_conf_file : _wrs_conf_path + "/" + _wrs_int_conf_file;
+    httpRequest.open('GET', configUrl, false);
+    httpRequest.send(null);
+    eval(httpRequest.responseText);
+}
+
+var _wrs_int_editorIcon = '/pix/formula.png';
+var _wrs_int_temporalIframe;
+var _wrs_int_window;
+var _wrs_int_window_opened = false;
+var _wrs_int_temporalImageResizing;
+var _wrs_int_langCode;
+var _wrs_int_directionality = '';
+// Custom Editors.
+var _wrs_int_customEditors = {chemistry : {name: 'Chemistry', toolbar : 'chemistry', icon : 'chem.png', enabled : false, confVariable : '_wrs_conf_chemEnabled', title: 'WIRIS EDITOR chemistry'}}
+
+
+if (typeof _wrs_int_langCode == 'undefined') {
+    if (navigator.userLanguage) {
+        _wrs_int_langCode = navigator.userLanguage.substring(0, 2);
+    }
+    else if (navigator.language) {
+        _wrs_int_langCode = navigator.language.substring(0, 2);
+    }
+    else {
+        _wrs_int_langCode = 'en';
+    }
+}
+
+// Including core.js.
+var script = document.createElement('script');
+script.type = 'text/javascript';
+script.src = _wrs_conf_path + '/core/core.js';
+document.getElementsByTagName('head')[0].appendChild(script);
+
+// Load configuration synchronously.
+if (!_wrs_int_conf_async) {
+    var httpRequest = typeof XMLHttpRequest != 'undefined' ? new XMLHttpRequest() : new ActiveXObject('Msxml2.XMLHTTP');
+    var configUrl = _wrs_int_conf_file.indexOf("/") == 0 || _wrs_int_conf_file.indexOf("http") == 0 ? _wrs_int_conf_file : _wrs_conf_path + "/" + _wrs_int_conf_file;
+    httpRequest.open('GET', configUrl, false);
+    httpRequest.send(null);
+    eval(httpRequest.responseText);
+}
+
+// Plugin integration.
+
+/**
+ * Inits the WIRIS plugin for this demo.
+ * @param iframe editable iframe
+ * @param toolbar HTML element where icons will be inserted
+ */
+function wrs_int_init(target,toolbar) {
+    wrs_int_init0 = function() {
+        if (typeof _wrs_conf_plugin_loaded == 'undefined') {
+            setTimeout(wrs_int_init0,100);
+        } else {
+            wrs_int_init_handler(target,toolbar);
+        }
+    }
+    wrs_int_init0();
+}
+
+function wrs_int_init_handler(target,toolbar) {
+    /* Assigning events to the WYSIWYG editor */
+    wrs_addIframeEvents(target, wrs_int_doubleClickHandler, wrs_int_mousedownHandler, wrs_int_mouseupHandler);
+
+    /* Parsing input text */
+    target.contentWindow.document.body.innerHTML = wrs_initParse(target.contentWindow.document.body.innerHTML);
+
+    /* Creating toolbar buttons */
+    if (toolbar != null) {
+
+        if (_wrs_conf_editorEnabled) {
+            var formulaButton = document.createElement('img');
+            formulaButton.id = "editorIcon";
+            formulaButton.src = _wrs_conf_path + _wrs_int_editorIcon;
+            formulaButton.style.cursor = 'pointer';
+
+            wrs_addEvent(formulaButton, 'click', function () {
+                wrs_int_disableCustomEditors();
+                wrs_int_openNewFormulaEditor(target, _wrs_int_langCode);
+            });
+
+            toolbar.appendChild(formulaButton);
+        }
+
+        // Dynamic customEditors buttons.
+        for (var key in _wrs_int_customEditors) {
+            if (_wrs_int_customEditors.hasOwnProperty(key)) {
+                if (window[_wrs_int_customEditors[key].confVariable]) {
+                    var customEditorButton = document.createElement('img');
+                    customEditorButton.src = _wrs_conf_path + '/icons/' + _wrs_int_customEditors[key].icon;
+                    customEditorButton.id = key + "Icon";
+                    customEditorButton.style.cursor = 'pointer';
+
+                    wrs_addEvent(customEditorButton, 'click', function () {
+                        wrs_int_enableCustomEditor(key);
+                        wrs_int_openNewFormulaEditor(target, _wrs_int_langCode);
+                    });
+
+                    toolbar.appendChild(customEditorButton);
+                }
+            }
+        }
+    }
+}
+
+
+/**
+ * Opens formula editor.
+ * @param object iframe Target
+ */
+function wrs_int_openNewFormulaEditor(iframe, language) {
+    if (_wrs_int_window_opened && !_wrs_conf_modalWindow) {
+        _wrs_int_window.focus();
+    }
+    else {
+        _wrs_int_window_opened = true;
+        _wrs_isNewElement = true;
+        _wrs_int_temporalIframe = iframe;
+        _wrs_int_window = wrs_openEditorWindow(language, iframe, true);
+    }
+}
+
+/**
+ * Handles a double click on the iframe.
+ * @param object iframe Target
+ * @param object element Element double clicked
+ */
+function wrs_int_doubleClickHandler(iframe, element) {
+    if (element.nodeName.toLowerCase() == 'img') {
+        wrs_int_disableCustomEditors();
+        if (customEditor = element.getAttribute('data-custom-editor')) {
+            wrs_int_enableCustomEditor(customEditor);
+        }
+        if (wrs_containsClass(element, 'Wirisformula')) {
+            if (!_wrs_int_window_opened || _wrs_conf_modalWindow) {
+                _wrs_temporalImage = element;
+                wrs_int_openExistingFormulaEditor(iframe, _wrs_int_langCode);
+            }
+            else {
+                _wrs_int_window.focus();
+            }
+        }
+    }
+}
+
+/**
+ * Opens formula editor to edit an existing formula.
+ * @param object iframe Target
+ */
+function wrs_int_openExistingFormulaEditor(iframe, language) {
+    _wrs_int_window_opened = true;
+    _wrs_isNewElement = false;
+    _wrs_int_temporalIframe = iframe;
+    _wrs_int_window = wrs_openEditorWindow(language, iframe, true);
+}
+
+/**
+ * Handles a mouse down event on the iframe.
+ * @param object iframe Target
+ * @param object element Element mouse downed
+ */
+function wrs_int_mousedownHandler(iframe, element) {
+    if (element.nodeName.toLowerCase() == 'img') {
+        if (wrs_containsClass(element, 'Wirisformula')) {
+            _wrs_int_temporalImageResizing = element;
+        }
+    }
+}
+
+/**
+ * Handles a mouse up event on the iframe.
+ */
+function wrs_int_mouseupHandler() {
+    if (_wrs_int_temporalImageResizing) {
+        setTimeout(function () {
+            wrs_fixAfterResize(_wrs_int_temporalImageResizing);
+        }, 10);
+    }
+}
+
+/**
+ * Calls wrs_updateFormula with well params.
+ * @param string mathml
+ */
+function wrs_int_updateFormula(mathml, editMode) {
+    wrs_updateFormula(_wrs_int_temporalIframe.contentWindow, _wrs_int_temporalIframe.contentWindow, mathml, null, editMode);
+}
+
+/**
+ * Handles window closing.
+ */
+function wrs_int_notifyWindowClosed() {
+    _wrs_int_window_opened = false;
+}
+
+/**
+ * Get custom active editor
+ */
+function wrs_int_getCustomEditorEnabled() {
+    var customEditorEnabled = null;
+    Object.keys(_wrs_int_customEditors).forEach(function(key) {
+        if (_wrs_int_customEditors[key].enabled) {
+            customEditorEnabled = _wrs_int_customEditors[key]
+        }
+    });
+
+    return customEditorEnabled;
+}
+
+/**
+ * Disable all custom editors
+ */
+function wrs_int_disableCustomEditors(){
+    Object.keys(_wrs_int_customEditors).forEach(function(key) {
+            _wrs_int_customEditors[key].enabled = false;
+    });
+}
+
+/**
+ * Enable a custom editor
+ * @param string editor
+ */
+function wrs_int_enableCustomEditor(editor) {
+    // Only one custom editor enabled at the same time.
+    wrs_int_disableCustomEditors();
+    if (_wrs_int_customEditors[editor]) {
+        _wrs_int_customEditors[editor].enabled = true;
+    }
+}
diff --git a/lib/editor/atto/plugins/wiris/yui/build/moodle-atto_wiris-button/moodle-atto_wiris-button-debug.js b/lib/editor/atto/plugins/wiris/yui/build/moodle-atto_wiris-button/moodle-atto_wiris-button-debug.js
new file mode 100644
index 0000000000000000000000000000000000000000..ae619fd5a2c91ee59a0aec1a04a0b103d4949392
GIT binary patch
literal 10739
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
RYu~i|y#eb12fdHP=0E0tmDvCQ

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/yui/build/moodle-atto_wiris-button/moodle-atto_wiris-button-min.js b/lib/editor/atto/plugins/wiris/yui/build/moodle-atto_wiris-button/moodle-atto_wiris-button-min.js
new file mode 100644
index 0000000000000000000000000000000000000000..99d9ea91ddb4c8a57407bbc2bd5f7f14f706aafb
GIT binary patch
literal 5091
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
TtJ<+sCSK?P2HwqmF!}92-gtVt

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/yui/build/moodle-atto_wiris-button/moodle-atto_wiris-button.js b/lib/editor/atto/plugins/wiris/yui/build/moodle-atto_wiris-button/moodle-atto_wiris-button.js
new file mode 100644
index 0000000000000000000000000000000000000000..7dc381fbbcae013ed85892cb612fae211ec93316
GIT binary patch
literal 10686
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

literal 0
HcmV?d00001

diff --git a/lib/editor/atto/plugins/wiris/yui/src/button/build.json b/lib/editor/atto/plugins/wiris/yui/src/button/build.json
new file mode 100644
index 0000000..7793aa7
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/yui/src/button/build.json
@@ -0,0 +1,10 @@
+{
+  "name": "moodle-atto_wiris-button",
+  "builds": {
+    "moodle-atto_wiris-button": {
+      "jsfiles": [
+        "button.js"
+      ]
+    }
+  }
+}
diff --git a/lib/editor/atto/plugins/wiris/yui/src/button/js/button.js b/lib/editor/atto/plugins/wiris/yui/src/button/js/button.js
new file mode 100644
index 0000000..05ffba8
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/yui/src/button/js/button.js
@@ -0,0 +1,296 @@
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+//
+
+/*
+ * @package    atto_atto_wiris
+ * @copyright  2011, Maths for More S.L. http://www.wiris.com
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+/**
+ * @module moodle-atto_atto_wiris-button
+ */
+
+/**
+ * Atto text editor WIRIS plugin.
+ *
+ * @namespace M.atto_wiris
+ * @class button
+ * @extends M.editor_atto.EditorPlugin
+ */
+
+
+Y.namespace('M.atto_wiris').Button = Y.Base.create('button', Y.M.editor_atto.EditorPlugin, [], {
+    /**
+     * The current language en by default.
+     * **/
+    _lang: 'en',
+
+    /**
+     * Initialization function.
+     *
+     * @param string lang
+     *   The language ISO code.
+     **/
+    initializer: function(config) {
+
+        // Filter not enabled at course level so no continue.
+        if (!config.filter_enabled) {
+            return;
+        }
+        this._lang = config.lang;
+        window._wrs_int_langCode = config.lang;
+        // Add global-scope callback functions and properties.
+
+        // Popup closed callback.
+        window.wrs_int_notifyWindowClosed = function() {
+            window._wrs_int_popup = null;
+            window._wrs_temporalImage = null;
+            window._wrs_isNewElement = true;
+        };
+
+        // Editor popup OK callback.
+        window.wrs_int_updateFormula = function(mathml, editMode) {
+            var editable = window._wrs_int_currentPlugin.get('host').editor.getDOMNode();
+            wrs_updateFormula(editable, window, mathml, null, editMode,  _wrs_int_currentPlugin._lang);
+            window._wrs_int_currentPlugin.markUpdated();
+            window._wrs_int_currentPlugin._updateEditorImgHandlers();
+        };
+
+        // CAS popup OK callback.
+        window.wrs_int_updateCAS = function(appletCode, image, width, height) {
+            var editable = window._wrs_int_currentPlugin.get('host').editor.getDOMNode();
+            wrs_updateCAS(editable, window, appletCode, image, width, height);
+            window._wrs_int_currentPlugin.markUpdated();
+            window._wrs_int_currentPlugin._updateCasImgHandlers();
+        };
+
+        // Configuration location.
+        window._wrs_int_conf_file = M.cfg.wwwroot + '/filter/wiris/integration/configurationjs.php';
+        window._wrs_int_conf_path = M.cfg.wwwroot + '/lib/editor/atto/plugins/wiris';
+        window._wrs_int_conf_async = true;
+        window._wrs_int_popup = window._wrs_int_popup || null;
+        window._wrs_int_coreLoading = window._wrs_int_coreLoading || false;
+
+        // Custom integration folder.
+        window._wrs_int_path = window._wrs_int_conf_file.split("/");
+        window._wrs_int_path.pop();
+        window._wrs_int_path = window._wrs_int_path.join("/");
+        window._wrs_int_path = window._wrs_int_path.indexOf("/") === 0 || window._wrs_int_path.indexOf("http") === 0 ? window._wrs_int_path : window._wrs_int_conf_path + "/" + window._wrs_int_path;
+
+        // Moodle.
+        window._wrs_isMoodle24 = true;
+
+        // Custom editors.
+        window._wrs_int_customEditors = {
+            chemistry : {
+                name: 'Chemistry',
+                toolbar : 'chemistry',
+                icon : 'chem.gif',
+                enabled : false,
+                confVariable : '_wrs_conf_chemEnabled',
+                title: 'WIRIS EDITOR chemistry'}};
+
+        // Load WIRIS plugin core javascript file only once.
+        if (!window._wrs_int_coreLoading) {
+            window._wrs_int_coreLoading = true;
+            Y.Get.js(window._wrs_int_conf_path + '/core/core.js', function(err) {
+                if (err) {
+                    Y.log('Could not load core.js');
+                }
+            });
+        }
+
+        // Add parse/unparse events.
+        var host = this.get('host');
+        var wirisplugin = this;
+        window._wrs_int_currentPlugin = this;
+        window._wrs_int_editors_elements = typeof window._wrs_int_editors_elements == "undefined" ? {} : window._wrs_int_editors_elements;
+        // Update textarea value on change.
+        host.on('change', function() {
+            wirisplugin._unparseContent();
+        });
+        // Override updateFromTextArea to update the content editable element.
+        host._wirisUpdateFromTextArea = host.updateFromTextArea;
+        host.updateFromTextArea = function() {
+            host._wirisUpdateFromTextArea();
+            wirisplugin._parseContent();
+        };
+
+        // Parse the content for the first time.
+        this._parseContent();
+
+        // Add WIRIS buttons to the toolbar.
+        this._addButtons();
+    },
+    /**
+     * Add buttons depending on configuration.
+     */
+    _addButtons: function() {
+        if (window._wrs_conf_plugin_loaded) {
+            if (window._wrs_conf_editorEnabled) {
+                this.addButton({
+                    title: 'wiris_editor_title',
+                    buttonName: 'wiris_editor',
+                    icon: 'formula',
+                    iconComponent: 'atto_wiris',
+                    callback: this._editorButton
+                });
+            }
+            if (window[_wrs_int_customEditors.chemistry.confVariable]) {
+                this.addButton({
+                    title: 'wiris_chem_editor_title',
+                    buttonName: 'wiris_chem_editor',
+                    icon:'chem',
+                    iconComponent: 'atto_wiris',
+                    callback: this._chemEditorButton
+                });
+            }
+            if (window._wrs_conf_CASEnabled) {
+                this.addButton({
+                    title: 'wiris_cas_title',
+                    buttonName: 'wiris_cas',
+                    icon: 'cas',
+                    iconComponent: 'atto_wiris',
+                    callback: this._casButton
+                });
+            }
+            // We add the buton after the collapse plugin initially hide other
+            // buttons. So we recall it here.
+            var host = this.get('host');
+            if (host.plugins.collapse) {
+                host.plugins.collapse._setVisibility(host.plugins.collapse.buttons.collapse);
+            }
+
+        }
+        else {
+            Y.later(50, this, this._addButtons);
+        }
+    },
+    /**
+     * WIRIS editor button callback.
+     **/
+    _editorButton: function() {
+        if (_wrs_int_popup) {
+            _wrs_int_popup.focus();
+        }
+        else {
+            var host = this.get('host');
+            _wrs_int_currentPlugin = this;
+            _wrs_int_popup = wrs_openEditorWindow(this._lang, host.editor.getDOMNode(), false);
+        }
+    },
+
+    _chemEditorButton: function() {
+        if (_wrs_int_popup) {
+            _wrs_int_popup.focus();
+        }
+        else {
+            var host = this.get('host');
+            _wrs_int_currentPlugin = this;
+            wrs_int_enableCustomEditor('chemistry');
+            _wrs_int_popup = wrs_openEditorWindow(this._lang, host.editor.getDOMNode(), false);
+        }
+    },
+    /**
+     * WIRIS cas button callback.
+     **/
+    _casButton: function() {
+        if (_wrs_int_popup) {
+            _wrs_int_popup.focus();
+        }
+        else {
+            var host = this.get('host');
+            _wrs_int_currentPlugin = this;
+            _wrs_int_popup = wrs_openCASWindow(host.editor.getDOMNode(), false, this._lang);
+        }
+    },
+    /**
+     * Converts all MathML from the editor html to img elements.
+     * **/
+    _parseContent: function() {
+        if (window._wrs_conf_plugin_loaded) {
+            var host = this.get('host');
+            var html = host.editor.get('innerHTML');
+            html = wrs_initParse(html, this._lang);
+            host.editor.set('innerHTML', html);
+            this.markUpdated();
+            this._updateCasImgHandlers();
+            this._updateEditorImgHandlers();
+        }
+        else {
+            Y.later(50, this, this._parseContent);
+        }
+    },
+    /**
+     * Converts all img elements from the textarea I/O element to MathML.
+     * */
+    _unparseContent: function() {
+        if (window._wrs_conf_plugin_loaded) {
+            var host = this.get('host');
+            var html = host.textarea.get('value');
+            html = wrs_endParse(html, null, this._lang);
+            host.textarea.set('value', html);
+        }
+        else {
+            Y.later(50, this, this._unparseContent);
+        }
+    },
+    /**
+     * Doubleclick event for Wiris images on editable div.
+     */
+    _handleElementDoubleclick: function(target, element, event){
+        if (element.dataset.mathml) {
+            event.stopPropagation();
+            window._wrs_temporalImage = element;
+            window._wrs_isNewElement = false;
+            var customEditor = window._wrs_temporalImage.getAttribute('data-custom-editor');
+            if (typeof(customEditor) != 'undefined' && customEditor){
+                if (window[_wrs_int_customEditors[customEditor].confVariable]) {
+                    wrs_int_enableCustomEditor(customEditor);
+                }
+            }
+
+            window._wrs_int_editors_elements[target.id]._editorButton();
+        }
+    },
+    /**
+     * Doubleclick in img.Wiriscas handler
+     * */
+    _handleCasDoubleClick: function(e) {
+        window._wrs_temporalImage = e.currentTarget.getDOMNode();
+        window._wrs_isNewElement = false;
+        this._casButton();
+        e.stopPropagation();
+    },
+    /**
+     * Reset event handlers for formula images.
+     * **/
+    _updateEditorImgHandlers: function() {
+        // Add doubleclick event to editable div.
+        wrs_addElementEvents(this.get('host').editor.getDOMNode(),this._handleElementDoubleclick);
+        window._wrs_int_editors_elements[this.get("host").editor.getDOMNode().id] = this;
+    },
+    /**
+     * Reset event handlers for cas images.
+     * **/
+    _updateCasImgHandlers: function() {
+        this.editor.all('img.Wiriscas').each(function(img){
+            img.detachAll('dblclick');
+            img.on('dblclick', this._handleCasDoubleClick, this);
+        }, this);
+    }
+});
diff --git a/lib/editor/atto/plugins/wiris/yui/src/button/meta/button.json b/lib/editor/atto/plugins/wiris/yui/src/button/meta/button.json
new file mode 100644
index 0000000..2ee1b9b
--- /dev/null
+++ b/lib/editor/atto/plugins/wiris/yui/src/button/meta/button.json
@@ -0,0 +1,8 @@
+{
+    "moodle-atto_wiris-button": {
+        "requires": [
+            "moodle-editor_atto-plugin",
+            "get"
+        ]
+    }
+}
-- 
1.8.3.1

